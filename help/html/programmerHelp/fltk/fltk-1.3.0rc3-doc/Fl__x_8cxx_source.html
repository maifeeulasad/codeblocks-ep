<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<!-- Mirrored from dox.sfr-fresh.com/fltk-1.3.0rc3-source/Fl__x_8cxx_source.html by HTTrack Website Copier/3.x [XR&CO'2010], Wed, 16 Feb 2011 23:42:43 GMT -->
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>SfR Fresh Dox - fltk: fltk-1.3.0rc3/src/Fl_x.cxx Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">fltk&#160;<span id="projectnumber">1.3.0rc3</span></div>
   <div id="projectbrief">About: <A HREF= http://www.fltk.org/>FLTK</A> (Fast Light Tool Kit) is a cross-platform C++ GUI toolkit for UNIX/Linux (X11), Microsoft Windows, and MacOS X. Release candidate.<BR><IMG SRC="../warix/forest1.gif" ALT="">&nbsp;&nbsp;<A HREF="http://www.sfr-fresh.com/" TITLE="SfR Fresh Home">SfR Fresh</A> <A HREF="http://www.sfr-fresh.com/warix/features.html#doxygen" TITLE="SfR Fresh Doxygen Support Info">Dox</A>: <A HREF="../fresh/unix/misc/fltk-1.3.0rc3-source.tar.gz/index.html" TITLE="SfR Fresh: fltk-1.3.0rc3-source.tar.gz Contents &amp; Download Page">fltk-1.3.0rc3-source.tar.gz</A> ("inofficial" and yet experimental doxygen-generated source code documentation)&nbsp;&nbsp;<IMG SRC="../warix/forest2.gif" ALT=""><P></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index-2.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('Fl__x_8cxx.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<h1>Fl_x.cxx</h1>  </div>
</div>
<div class="contents">
<a href="Fl__x_8cxx.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//</span>
<a name="l00002"></a>00002 <span class="comment">// &quot;$Id: Fl_x.cxx 8198 2011-01-06 10:24:58Z manolo $&quot;</span>
<a name="l00003"></a>00003 <span class="comment">//</span>
<a name="l00004"></a>00004 <span class="comment">// X specific code for the Fast Light Tool Kit (FLTK).</span>
<a name="l00005"></a>00005 <span class="comment">//</span>
<a name="l00006"></a>00006 <span class="comment">// Copyright 1998-2010 by Bill Spitzak and others.</span>
<a name="l00007"></a>00007 <span class="comment">//</span>
<a name="l00008"></a>00008 <span class="comment">// This library is free software; you can redistribute it and/or</span>
<a name="l00009"></a>00009 <span class="comment">// modify it under the terms of the GNU Library General Public</span>
<a name="l00010"></a>00010 <span class="comment">// License as published by the Free Software Foundation; either</span>
<a name="l00011"></a>00011 <span class="comment">// version 2 of the License, or (at your option) any later version.</span>
<a name="l00012"></a>00012 <span class="comment">//</span>
<a name="l00013"></a>00013 <span class="comment">// This library is distributed in the hope that it will be useful,</span>
<a name="l00014"></a>00014 <span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00015"></a>00015 <span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<a name="l00016"></a>00016 <span class="comment">// Library General Public License for more details.</span>
<a name="l00017"></a>00017 <span class="comment">//</span>
<a name="l00018"></a>00018 <span class="comment">// You should have received a copy of the GNU Library General Public</span>
<a name="l00019"></a>00019 <span class="comment">// License along with this library; if not, write to the Free Software</span>
<a name="l00020"></a>00020 <span class="comment">// Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307</span>
<a name="l00021"></a>00021 <span class="comment">// USA.</span>
<a name="l00022"></a>00022 <span class="comment">//</span>
<a name="l00023"></a>00023 <span class="comment">// Please report all bugs and problems on the following page:</span>
<a name="l00024"></a>00024 <span class="comment">//</span>
<a name="l00025"></a>00025 <span class="comment">//     http://www.fltk.org/str.php</span>
<a name="l00026"></a>00026 <span class="comment">//</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="preprocessor">#ifdef WIN32</span>
<a name="l00029"></a>00029 <span class="preprocessor"></span><span class="comment">//#  include &quot;Fl_win32.cxx&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#elif defined(__APPLE__)</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span><span class="comment">//#  include &quot;Fl_mac.cxx&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#elif !defined(FL_DOXYGEN)</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span>
<a name="l00034"></a><a class="code" href="Fl__x_8cxx.html#a19f68d90e21d88dd84cec78155e10057">00034</a> <span class="preprocessor">#  define CONSOLIDATE_MOTION 1</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span><span class="comment">/**** Define this if your keyboard lacks a backspace key... ****/</span>
<a name="l00036"></a>00036 <span class="comment">/* #define BACKSPACE_HACK 1 */</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="preprocessor">#  include &lt;config.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#  include &lt;FL/Fl.H&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#  include &lt;FL/x.H&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#  include &lt;FL/Fl_Window.H&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#  include &lt;FL/fl_utf8.h&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#  include &lt;FL/Fl_Tooltip.H&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#  include &lt;FL/fl_draw.H&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#  include &lt;stdio.h&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#  include &lt;stdlib.h&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#  include &quot;<a class="code" href="flstring_8h.html">flstring.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#  include &lt;unistd.h&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#  include &lt;sys/time.h&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#  include &lt;X11/Xmd.h&gt;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#  include &lt;X11/Xlocale.h&gt;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#  include &lt;X11/Xlib.h&gt;</span>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="keyword">static</span> <a class="code" href="classFl__Xlib__Graphics__Driver.html" title="The Xlib-specific graphics class.">Fl_Xlib_Graphics_Driver</a> fl_xlib_driver;
<a name="l00055"></a>00055 <span class="keyword">static</span> <a class="code" href="classFl__Display__Device.html" title="A display to which the computer can draw.">Fl_Display_Device</a> fl_xlib_display(&amp;fl_xlib_driver);
<a name="l00056"></a><a class="code" href="Fl__x_8cxx.html#a3c86b413353211f1c893a056485440c3">00056</a> <a class="code" href="Fl__Export_8H.html#aa9ba29a18aee9d738370a06eeb4470fc">FL_EXPORT</a> <a class="code" href="classFl__Display__Device.html" title="A display to which the computer can draw.">Fl_Display_Device</a> *<a class="code" href="Fl__Device_8H.html#a3c86b413353211f1c893a056485440c3" title="Points to the platform&amp;#39;s display.">fl_display_device</a> = (<a class="code" href="classFl__Display__Device.html" title="A display to which the computer can draw.">Fl_Display_Device</a>*)&amp;fl_xlib_display; <span class="comment">// does not change</span>
<a name="l00057"></a><a class="code" href="Fl__x_8cxx.html#a70e4f05429b26bb420c70f64e972f2a5">00057</a> <a class="code" href="Fl__Export_8H.html#aa9ba29a18aee9d738370a06eeb4470fc">FL_EXPORT</a> <a class="code" href="classFl__Graphics__Driver.html" title="A virtual class subclassed for each graphics driver FLTK uses.">Fl_Graphics_Driver</a> *<a class="code" href="Fl__Device_8H.html#a70e4f05429b26bb420c70f64e972f2a5" title="Points to the driver that currently receives all graphics requests.">fl_graphics_driver</a> = (<a class="code" href="classFl__Graphics__Driver.html" title="A virtual class subclassed for each graphics driver FLTK uses.">Fl_Graphics_Driver</a>*)&amp;fl_xlib_driver; <span class="comment">// the current target device of graphics operations</span>
<a name="l00058"></a><a class="code" href="Fl__x_8cxx.html#af47882d62919f7ef0593724741fa5ac9">00058</a> <a class="code" href="Fl__Export_8H.html#aa9ba29a18aee9d738370a06eeb4470fc">FL_EXPORT</a> <a class="code" href="classFl__Surface__Device.html" title="A surface that&amp;#39;s susceptible to receive graphical output.">Fl_Surface_Device</a> *<a class="code" href="Fl__Device_8H.html#af47882d62919f7ef0593724741fa5ac9" title="Points to the surface that currently receives all graphics requests.">fl_surface</a> = (<a class="code" href="classFl__Surface__Device.html" title="A surface that&amp;#39;s susceptible to receive graphical output.">Fl_Surface_Device</a>*)<a class="code" href="Fl__Device_8H.html#a3c86b413353211f1c893a056485440c3" title="Points to the platform&amp;#39;s display.">fl_display_device</a>; <span class="comment">// the current target surface of graphics operations</span>
<a name="l00059"></a>00059 
<a name="l00061"></a>00061 <span class="comment">// interface to poll/select call:</span>
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 <span class="preprocessor">#  if USE_POLL</span>
<a name="l00064"></a>00064 <span class="preprocessor"></span>
<a name="l00065"></a>00065 <span class="preprocessor">#    include &lt;poll.h&gt;</span>
<a name="l00066"></a>00066 <span class="keyword">static</span> pollfd *pollfds = 0;
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="preprocessor">#  else</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span><span class="preprocessor">#    if HAVE_SYS_SELECT_H</span>
<a name="l00070"></a>00070 <span class="preprocessor"></span><span class="preprocessor">#      include &lt;sys/select.h&gt;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#    endif </span><span class="comment">/* HAVE_SYS_SELECT_H */</span>
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 <span class="comment">// The following #define is only needed for HP-UX 9.x and earlier:</span>
<a name="l00074"></a>00074 <span class="comment">//#define select(a,b,c,d,e) select((a),(int *)(b),(int *)(c),(int *)(d),(e))</span>
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="keyword">static</span> fd_set fdsets[3];
<a name="l00077"></a>00077 <span class="keyword">static</span> <span class="keywordtype">int</span> maxfd;
<a name="l00078"></a><a class="code" href="Fl__x_8cxx.html#a52ac479a805051f59643588b096024ff">00078</a> <span class="preprocessor">#    define POLLIN 1</span>
<a name="l00079"></a><a class="code" href="Fl__x_8cxx.html#a91b3c67129ac7675062f316b840a0d58">00079</a> <span class="preprocessor"></span><span class="preprocessor">#    define POLLOUT 4</span>
<a name="l00080"></a><a class="code" href="Fl__x_8cxx.html#ab1c532446408c98559d4aaaeeeb99820">00080</a> <span class="preprocessor"></span><span class="preprocessor">#    define POLLERR 8</span>
<a name="l00081"></a>00081 <span class="preprocessor"></span>
<a name="l00082"></a>00082 <span class="preprocessor">#  endif </span><span class="comment">/* USE_POLL */</span>
<a name="l00083"></a>00083 
<a name="l00084"></a>00084 <span class="keyword">static</span> <span class="keywordtype">int</span> nfds = 0;
<a name="l00085"></a>00085 <span class="keyword">static</span> <span class="keywordtype">int</span> fd_array_size = 0;
<a name="l00086"></a>00086 <span class="keyword">struct </span>FD {
<a name="l00087"></a>00087 <span class="preprocessor">#  if !USE_POLL</span>
<a name="l00088"></a>00088 <span class="preprocessor"></span>  <span class="keywordtype">int</span> fd;
<a name="l00089"></a>00089   <span class="keywordtype">short</span> events;
<a name="l00090"></a>00090 <span class="preprocessor">#  endif</span>
<a name="l00091"></a>00091 <span class="preprocessor"></span>  <a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a> (*cb)(<a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>, <span class="keywordtype">void</span>*);
<a name="l00092"></a>00092   <span class="keywordtype">void</span>* arg;
<a name="l00093"></a>00093 };
<a name="l00094"></a>00094 
<a name="l00095"></a>00095 <span class="keyword">static</span> FD *fd = 0;
<a name="l00096"></a>00096 
<a name="l00097"></a>00097 <span class="keywordtype">void</span> <a class="code" href="classFl.html#a799b8278326b3c2db15687c43c11aaf6">Fl::add_fd</a>(<span class="keywordtype">int</span> n, <span class="keywordtype">int</span> events, <span class="keywordtype">void</span> (*cb)(<span class="keywordtype">int</span>, <span class="keywordtype">void</span>*), <span class="keywordtype">void</span> *v) {
<a name="l00098"></a>00098   <a class="code" href="classFl.html#a71e75c1a559e3415c5304c37235af831">remove_fd</a>(n,events);
<a name="l00099"></a>00099   <span class="keywordtype">int</span> <a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a> = nfds++;
<a name="l00100"></a>00100   <span class="keywordflow">if</span> (i &gt;= fd_array_size) {
<a name="l00101"></a>00101     FD *temp;
<a name="l00102"></a>00102     fd_array_size = 2*fd_array_size+1;
<a name="l00103"></a>00103 
<a name="l00104"></a>00104     <span class="keywordflow">if</span> (!fd) temp = (FD*)malloc(fd_array_size*<span class="keyword">sizeof</span>(FD));
<a name="l00105"></a>00105     <span class="keywordflow">else</span> temp = (FD*)realloc(fd, fd_array_size*<span class="keyword">sizeof</span>(FD));
<a name="l00106"></a>00106 
<a name="l00107"></a>00107     <span class="keywordflow">if</span> (!temp) <span class="keywordflow">return</span>;
<a name="l00108"></a>00108     fd = temp;
<a name="l00109"></a>00109 
<a name="l00110"></a>00110 <span class="preprocessor">#  if USE_POLL</span>
<a name="l00111"></a>00111 <span class="preprocessor"></span>    pollfd *tpoll;
<a name="l00112"></a>00112 
<a name="l00113"></a>00113     <span class="keywordflow">if</span> (!pollfds) tpoll = (pollfd*)malloc(fd_array_size*<span class="keyword">sizeof</span>(pollfd));
<a name="l00114"></a>00114     <span class="keywordflow">else</span> tpoll = (pollfd*)realloc(pollfds, fd_array_size*<span class="keyword">sizeof</span>(pollfd));
<a name="l00115"></a>00115 
<a name="l00116"></a>00116     <span class="keywordflow">if</span> (!tpoll) <span class="keywordflow">return</span>;
<a name="l00117"></a>00117     pollfds = tpoll;
<a name="l00118"></a>00118 <span class="preprocessor">#  endif</span>
<a name="l00119"></a>00119 <span class="preprocessor"></span>  }
<a name="l00120"></a>00120   fd[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].cb = cb;
<a name="l00121"></a>00121   fd[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].arg = v;
<a name="l00122"></a>00122 <span class="preprocessor">#  if USE_POLL</span>
<a name="l00123"></a>00123 <span class="preprocessor"></span>  pollfds[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].fd = n;
<a name="l00124"></a>00124   pollfds[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].events = events;
<a name="l00125"></a>00125 <span class="preprocessor">#  else</span>
<a name="l00126"></a>00126 <span class="preprocessor"></span>  fd[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].fd = n;
<a name="l00127"></a>00127   fd[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].events = events;
<a name="l00128"></a>00128   <span class="keywordflow">if</span> (events &amp; <a class="code" href="Fl__x_8cxx.html#a52ac479a805051f59643588b096024ff">POLLIN</a>) FD_SET(n, &amp;fdsets[0]);
<a name="l00129"></a>00129   <span class="keywordflow">if</span> (events &amp; <a class="code" href="Fl__x_8cxx.html#a91b3c67129ac7675062f316b840a0d58">POLLOUT</a>) FD_SET(n, &amp;fdsets[1]);
<a name="l00130"></a>00130   <span class="keywordflow">if</span> (events &amp; <a class="code" href="Fl__x_8cxx.html#ab1c532446408c98559d4aaaeeeb99820">POLLERR</a>) FD_SET(n, &amp;fdsets[2]);
<a name="l00131"></a>00131   <span class="keywordflow">if</span> (n &gt; maxfd) maxfd = n;
<a name="l00132"></a>00132 <span class="preprocessor">#  endif</span>
<a name="l00133"></a>00133 <span class="preprocessor"></span>}
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 <span class="keywordtype">void</span> <a class="code" href="classFl.html#a799b8278326b3c2db15687c43c11aaf6">Fl::add_fd</a>(<span class="keywordtype">int</span> n, <span class="keywordtype">void</span> (*cb)(<span class="keywordtype">int</span>, <span class="keywordtype">void</span>*), <span class="keywordtype">void</span>* v) {
<a name="l00136"></a>00136   <a class="code" href="classFl.html#a799b8278326b3c2db15687c43c11aaf6">Fl::add_fd</a>(n, POLLIN, cb, v);
<a name="l00137"></a>00137 }
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 <span class="keywordtype">void</span> <a class="code" href="classFl.html#a71e75c1a559e3415c5304c37235af831">Fl::remove_fd</a>(<span class="keywordtype">int</span> n, <span class="keywordtype">int</span> events) {
<a name="l00140"></a>00140   <span class="keywordtype">int</span> <a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>,j;
<a name="l00141"></a>00141 <span class="preprocessor"># if !USE_POLL</span>
<a name="l00142"></a>00142 <span class="preprocessor"></span>  maxfd = -1; <span class="comment">// recalculate maxfd on the fly</span>
<a name="l00143"></a>00143 <span class="preprocessor"># endif</span>
<a name="l00144"></a>00144 <span class="preprocessor"></span>  <span class="keywordflow">for</span> (i=j=0; i&lt;nfds; i++) {
<a name="l00145"></a>00145 <span class="preprocessor">#  if USE_POLL</span>
<a name="l00146"></a>00146 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (pollfds[i].fd == n) {
<a name="l00147"></a>00147       <span class="keywordtype">int</span> e = pollfds[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].events &amp; ~events;
<a name="l00148"></a>00148       <span class="keywordflow">if</span> (!e) <span class="keywordflow">continue</span>; <span class="comment">// if no events left, delete this fd</span>
<a name="l00149"></a>00149       pollfds[j].events = e;
<a name="l00150"></a>00150     }
<a name="l00151"></a>00151 <span class="preprocessor">#  else</span>
<a name="l00152"></a>00152 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (fd[i].fd == n) {
<a name="l00153"></a>00153       <span class="keywordtype">int</span> e = fd[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].events &amp; ~events;
<a name="l00154"></a>00154       <span class="keywordflow">if</span> (!e) <span class="keywordflow">continue</span>; <span class="comment">// if no events left, delete this fd</span>
<a name="l00155"></a>00155       fd[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].events = e;
<a name="l00156"></a>00156     }
<a name="l00157"></a>00157     <span class="keywordflow">if</span> (fd[i].fd &gt; maxfd) maxfd = fd[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].fd;
<a name="l00158"></a>00158 <span class="preprocessor">#  endif</span>
<a name="l00159"></a>00159 <span class="preprocessor"></span>    <span class="comment">// move it down in the array if necessary:</span>
<a name="l00160"></a>00160     <span class="keywordflow">if</span> (j&lt;i) {
<a name="l00161"></a>00161       fd[j] = fd[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>];
<a name="l00162"></a>00162 <span class="preprocessor">#  if USE_POLL</span>
<a name="l00163"></a>00163 <span class="preprocessor"></span>      pollfds[j] = pollfds[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>];
<a name="l00164"></a>00164 <span class="preprocessor">#  endif</span>
<a name="l00165"></a>00165 <span class="preprocessor"></span>    }
<a name="l00166"></a>00166     j++;
<a name="l00167"></a>00167   }
<a name="l00168"></a>00168   nfds = j;
<a name="l00169"></a>00169 <span class="preprocessor">#  if !USE_POLL</span>
<a name="l00170"></a>00170 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (events &amp; POLLIN) FD_CLR(n, &amp;fdsets[0]);
<a name="l00171"></a>00171   <span class="keywordflow">if</span> (events &amp; POLLOUT) FD_CLR(n, &amp;fdsets[1]);
<a name="l00172"></a>00172   <span class="keywordflow">if</span> (events &amp; POLLERR) FD_CLR(n, &amp;fdsets[2]);
<a name="l00173"></a>00173 <span class="preprocessor">#  endif</span>
<a name="l00174"></a>00174 <span class="preprocessor"></span>}
<a name="l00175"></a>00175 
<a name="l00176"></a>00176 <span class="keywordtype">void</span> <a class="code" href="classFl.html#a71e75c1a559e3415c5304c37235af831">Fl::remove_fd</a>(<span class="keywordtype">int</span> n) {
<a name="l00177"></a>00177   <a class="code" href="classFl.html#a71e75c1a559e3415c5304c37235af831">remove_fd</a>(n, -1);
<a name="l00178"></a>00178 }
<a name="l00179"></a>00179 
<a name="l00180"></a>00180 <span class="preprocessor">#if CONSOLIDATE_MOTION</span>
<a name="l00181"></a>00181 <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="classFl__Window.html">Fl_Window</a>* send_motion;
<a name="l00182"></a>00182 <span class="keyword">extern</span> <a class="code" href="classFl__Window.html">Fl_Window</a>* <a class="code" href="Fl_8cxx.html#aa4a35d324647e7c092666054a4e58596">fl_xmousewin</a>;
<a name="l00183"></a>00183 <span class="preprocessor">#endif</span>
<a name="l00184"></a>00184 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">bool</span> in_a_window; <span class="comment">// true if in any of our windows, even destroyed ones</span>
<a name="l00185"></a>00185 <span class="keyword">static</span> <span class="keywordtype">void</span> do_queued_events() {
<a name="l00186"></a>00186   in_a_window = <span class="keyword">true</span>;
<a name="l00187"></a>00187   <span class="keywordflow">while</span> (XEventsQueued(<a class="code" href="win32_8H.html#a6c6726f30a7b613184e2b315e167ddb2" title="END TIMERS //////////////////////////////////////////////////////////////////////////.">fl_display</a>,QueuedAfterReading)) {
<a name="l00188"></a>00188     XEvent xevent;
<a name="l00189"></a>00189     XNextEvent(<a class="code" href="win32_8H.html#a6c6726f30a7b613184e2b315e167ddb2" title="END TIMERS //////////////////////////////////////////////////////////////////////////.">fl_display</a>, &amp;xevent);
<a name="l00190"></a>00190     <a class="code" href="x_8H.html#aaccfba15ffa706de7d40045c1ad1d823">fl_handle</a>(xevent);
<a name="l00191"></a>00191   }
<a name="l00192"></a>00192   <span class="comment">// we send FL_LEAVE only if the mouse did not enter some other window:</span>
<a name="l00193"></a>00193   <span class="keywordflow">if</span> (!in_a_window) <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>(<a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3aa776cf3129e97140c88a062881a2d29a">FL_LEAVE</a>, 0);
<a name="l00194"></a>00194 <span class="preprocessor">#if CONSOLIDATE_MOTION</span>
<a name="l00195"></a>00195 <span class="preprocessor"></span>  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (send_motion == fl_xmousewin) {
<a name="l00196"></a>00196     send_motion = 0;
<a name="l00197"></a>00197     <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>(<a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3acd57cae091eb27c9a52c446bdd0c164d">FL_MOVE</a>, fl_xmousewin);
<a name="l00198"></a>00198   }
<a name="l00199"></a>00199 <span class="preprocessor">#endif</span>
<a name="l00200"></a>00200 <span class="preprocessor"></span>}
<a name="l00201"></a>00201 
<a name="l00202"></a>00202 <span class="comment">// these pointers are set by the Fl::lock() function:</span>
<a name="l00203"></a>00203 <span class="keyword">static</span> <span class="keywordtype">void</span> nothing() {}
<a name="l00204"></a><a class="code" href="Fl__x_8cxx.html#a7c231659c1d4f9ad9126b83cfbcbfb53">00204</a> <a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a> (*<a class="code" href="Fl__mac_8cxx.html#a7c231659c1d4f9ad9126b83cfbcbfb53">fl_lock_function</a>)() = nothing;
<a name="l00205"></a><a class="code" href="Fl__x_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">00205</a> <a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a> (*<a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>)() = nothing;
<a name="l00206"></a>00206 
<a name="l00207"></a>00207 <span class="comment">// This is never called with time_to_wait &lt; 0.0:</span>
<a name="l00208"></a>00208 <span class="comment">// It should return negative on error, 0 if nothing happens before</span>
<a name="l00209"></a>00209 <span class="comment">// timeout, and &gt;0 if any callbacks were done.</span>
<a name="l00210"></a><a class="code" href="Fl__x_8cxx.html#ac8d178f1d91c9e8c5f62b49db8a3c0c3">00210</a> <span class="keywordtype">int</span> <a class="code" href="Fl_8cxx.html#a55e2ddfbe9d4603198ae690c8e54e565">fl_wait</a>(<span class="keywordtype">double</span> time_to_wait) {
<a name="l00211"></a>00211 
<a name="l00212"></a>00212   <span class="comment">// OpenGL and other broken libraries call XEventsQueued</span>
<a name="l00213"></a>00213   <span class="comment">// unnecessarily and thus cause the file descriptor to not be ready,</span>
<a name="l00214"></a>00214   <span class="comment">// so we must check for already-read events:</span>
<a name="l00215"></a>00215   <span class="keywordflow">if</span> (<a class="code" href="win32_8H.html#a6c6726f30a7b613184e2b315e167ddb2" title="END TIMERS //////////////////////////////////////////////////////////////////////////.">fl_display</a> &amp;&amp; XQLength(<a class="code" href="win32_8H.html#a6c6726f30a7b613184e2b315e167ddb2" title="END TIMERS //////////////////////////////////////////////////////////////////////////.">fl_display</a>)) {do_queued_events(); <span class="keywordflow">return</span> 1;}
<a name="l00216"></a>00216 
<a name="l00217"></a>00217 <span class="preprocessor">#  if !USE_POLL</span>
<a name="l00218"></a>00218 <span class="preprocessor"></span>  fd_set fdt[3];
<a name="l00219"></a>00219   fdt[0] = fdsets[0];
<a name="l00220"></a>00220   fdt[1] = fdsets[1];
<a name="l00221"></a>00221   fdt[2] = fdsets[2];
<a name="l00222"></a>00222 <span class="preprocessor">#  endif</span>
<a name="l00223"></a>00223 <span class="preprocessor"></span>  <span class="keywordtype">int</span> n;
<a name="l00224"></a>00224 
<a name="l00225"></a>00225   <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l00226"></a>00226 
<a name="l00227"></a>00227   <span class="keywordflow">if</span> (time_to_wait &lt; 2147483.648) {
<a name="l00228"></a>00228 <span class="preprocessor">#  if USE_POLL</span>
<a name="l00229"></a>00229 <span class="preprocessor"></span>    n = ::poll(pollfds, nfds, <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>(time_to_wait*1000 + .5));
<a name="l00230"></a>00230 <span class="preprocessor">#  else</span>
<a name="l00231"></a>00231 <span class="preprocessor"></span>    timeval t;
<a name="l00232"></a>00232     t.tv_sec = <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>(time_to_wait);
<a name="l00233"></a>00233     t.tv_usec = <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>(1000000 * (time_to_wait-t.tv_sec));
<a name="l00234"></a>00234     n =<a class="code" href="factory_8cxx.html#a55a2870f3bd5e6ef9331bb7040a212c8"> ::select</a>(maxfd+1,&amp;fdt[0],&amp;fdt[1],&amp;fdt[2],&amp;t);
<a name="l00235"></a>00235 <span class="preprocessor">#  endif</span>
<a name="l00236"></a>00236 <span class="preprocessor"></span>  } <span class="keywordflow">else</span> {
<a name="l00237"></a>00237 <span class="preprocessor">#  if USE_POLL</span>
<a name="l00238"></a>00238 <span class="preprocessor"></span>    n = ::poll(pollfds, nfds, -1);
<a name="l00239"></a>00239 <span class="preprocessor">#  else</span>
<a name="l00240"></a>00240 <span class="preprocessor"></span>    n =<a class="code" href="factory_8cxx.html#a55a2870f3bd5e6ef9331bb7040a212c8"> ::select</a>(maxfd+1,&amp;fdt[0],&amp;fdt[1],&amp;fdt[2],0);
<a name="l00241"></a>00241 <span class="preprocessor">#  endif</span>
<a name="l00242"></a>00242 <span class="preprocessor"></span>  }
<a name="l00243"></a>00243 
<a name="l00244"></a>00244   <a class="code" href="Fl__mac_8cxx.html#a7c231659c1d4f9ad9126b83cfbcbfb53">fl_lock_function</a>();
<a name="l00245"></a>00245 
<a name="l00246"></a>00246   <span class="keywordflow">if</span> (n &gt; 0) {
<a name="l00247"></a>00247     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;nfds; i++) {
<a name="l00248"></a>00248 <span class="preprocessor">#  if USE_POLL</span>
<a name="l00249"></a>00249 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (pollfds[i].revents) fd[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].cb(pollfds[i].fd, fd[i].arg);
<a name="l00250"></a>00250 <span class="preprocessor">#  else</span>
<a name="l00251"></a>00251 <span class="preprocessor"></span>      <span class="keywordtype">int</span> <a class="code" href="fl__boxtype_8cxx.html#ac406db58651c10e8f67ed432c66db0d6">f</a> = fd[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].fd;
<a name="l00252"></a>00252       <span class="keywordtype">short</span> revents = 0;
<a name="l00253"></a>00253       <span class="keywordflow">if</span> (FD_ISSET(f,&amp;fdt[0])) revents |= <a class="code" href="Fl__x_8cxx.html#a52ac479a805051f59643588b096024ff">POLLIN</a>;
<a name="l00254"></a>00254       <span class="keywordflow">if</span> (FD_ISSET(f,&amp;fdt[1])) revents |= <a class="code" href="Fl__x_8cxx.html#a91b3c67129ac7675062f316b840a0d58">POLLOUT</a>;
<a name="l00255"></a>00255       <span class="keywordflow">if</span> (FD_ISSET(f,&amp;fdt[2])) revents |= <a class="code" href="Fl__x_8cxx.html#ab1c532446408c98559d4aaaeeeb99820">POLLERR</a>;
<a name="l00256"></a>00256       <span class="keywordflow">if</span> (fd[i].events &amp; revents) fd[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].cb(f, fd[i].arg);
<a name="l00257"></a>00257 <span class="preprocessor">#  endif</span>
<a name="l00258"></a>00258 <span class="preprocessor"></span>    }
<a name="l00259"></a>00259   }
<a name="l00260"></a>00260   <span class="keywordflow">return</span> n;
<a name="l00261"></a>00261 }
<a name="l00262"></a>00262 
<a name="l00263"></a>00263 <span class="comment">// fl_ready() is just like fl_wait(0.0) except no callbacks are done:</span>
<a name="l00264"></a><a class="code" href="Fl__x_8cxx.html#af0705d69ac0f8c4c43d26d935c12044a">00264</a> <span class="keywordtype">int</span> <a class="code" href="Fl_8cxx.html#af0705d69ac0f8c4c43d26d935c12044a">fl_ready</a>() {
<a name="l00265"></a>00265   <span class="keywordflow">if</span> (XQLength(<a class="code" href="win32_8H.html#a6c6726f30a7b613184e2b315e167ddb2" title="END TIMERS //////////////////////////////////////////////////////////////////////////.">fl_display</a>)) <span class="keywordflow">return</span> 1;
<a name="l00266"></a>00266   <span class="keywordflow">if</span> (!nfds) <span class="keywordflow">return</span> 0; <span class="comment">// nothing to select or poll</span>
<a name="l00267"></a>00267 <span class="preprocessor">#  if USE_POLL</span>
<a name="l00268"></a>00268 <span class="preprocessor"></span>  return ::poll(pollfds, nfds, 0);
<a name="l00269"></a>00269 <span class="preprocessor">#  else</span>
<a name="l00270"></a>00270 <span class="preprocessor"></span>  timeval t;
<a name="l00271"></a>00271   t.tv_sec = 0;
<a name="l00272"></a>00272   t.tv_usec = 0;
<a name="l00273"></a>00273   fd_set fdt[3];
<a name="l00274"></a>00274   fdt[0] = fdsets[0];
<a name="l00275"></a>00275   fdt[1] = fdsets[1];
<a name="l00276"></a>00276   fdt[2] = fdsets[2];
<a name="l00277"></a>00277   <a class="code" href="factory_8cxx.html#a55a2870f3bd5e6ef9331bb7040a212c8">return ::select</a>(maxfd+1,&amp;fdt[0],&amp;fdt[1],&amp;fdt[2],&amp;t);
<a name="l00278"></a>00278 <span class="preprocessor">#  endif</span>
<a name="l00279"></a>00279 <span class="preprocessor"></span>}
<a name="l00280"></a>00280 
<a name="l00281"></a>00281 <span class="comment">// replace \r\n by \n</span>
<a name="l00282"></a>00282 <span class="keyword">static</span> <span class="keywordtype">void</span> convert_crlf(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<span class="keywordtype">string</span>, <span class="keywordtype">long</span>&amp; len) {
<a name="l00283"></a>00283   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *a, *<a class="code" href="jpegint_8h.html#af320905358fa78701e4cc60b6135601f">b</a>;
<a name="l00284"></a>00284   a = b = string;
<a name="l00285"></a>00285   <span class="keywordflow">while</span> (*a) { 
<a name="l00286"></a>00286     <span class="keywordflow">if</span> (*a == <span class="charliteral">&#39;\r&#39;</span> &amp;&amp; a[1] == <span class="charliteral">&#39;\n&#39;</span>) { a++; len--; }
<a name="l00287"></a>00287     <span class="keywordflow">else</span> *b++ = *a++;
<a name="l00288"></a>00288   }
<a name="l00289"></a>00289   *b = 0;
<a name="l00290"></a>00290 }
<a name="l00291"></a>00291 
<a name="l00293"></a>00293 
<a name="l00294"></a><a class="code" href="Fl__x_8cxx.html#a0b4c466d140fb026ad59bd63e93f3e7a">00294</a> Display *<a class="code" href="win32_8H.html#a6c6726f30a7b613184e2b315e167ddb2" title="END TIMERS //////////////////////////////////////////////////////////////////////////.">fl_display</a>;
<a name="l00295"></a><a class="code" href="Fl__x_8cxx.html#a309356fc3e4a289c34c8ddd71bc019bf">00295</a> <a class="code" href="mac_8H.html#aad9fe48cacd960402308a6a7f9f5e584">Window</a> <a class="code" href="x_8H.html#a8a5d02d001ae109b2f2dacd754f7d061">fl_message_window</a> = 0;
<a name="l00296"></a><a class="code" href="Fl__x_8cxx.html#acedaca348d9ac3c07191b8255ef979b7">00296</a> <span class="keywordtype">int</span> <a class="code" href="x_8H.html#a42a55d8c59138d9f0fa899491c25560c">fl_screen</a>;
<a name="l00297"></a><a class="code" href="Fl__x_8cxx.html#a4bb9e3c0ee64b0d4cd8c1deeef961ce9">00297</a> XVisualInfo *<a class="code" href="x_8H.html#abe861b6ba1d71b2f73e3883c10ac5c27">fl_visual</a>;
<a name="l00298"></a><a class="code" href="Fl__x_8cxx.html#a86fb30997315bdbae0f3dbde9df1d9ee">00298</a> Colormap <a class="code" href="x_8H.html#afcd48cb4e62b0bfee6102e98c7d0cb38">fl_colormap</a>;
<a name="l00299"></a><a class="code" href="Fl__x_8cxx.html#a5d289879ce9777208cf0eaa7927457bf">00299</a> XIM <a class="code" href="Fl__x_8cxx.html#a5d289879ce9777208cf0eaa7927457bf">fl_xim_im</a> = 0;
<a name="l00300"></a><a class="code" href="Fl__x_8cxx.html#a7942c1303b6c6023062b69f545e53475">00300</a> XIC <a class="code" href="Fl__x_8cxx.html#a7942c1303b6c6023062b69f545e53475">fl_xim_ic</a> = 0;
<a name="l00301"></a><a class="code" href="Fl__x_8cxx.html#a09e868ce4d7751a5ae0bed1d9b8d8eab">00301</a> <span class="keywordtype">char</span> <a class="code" href="Fl__x_8cxx.html#a09e868ce4d7751a5ae0bed1d9b8d8eab">fl_is_over_the_spot</a> = 0;
<a name="l00302"></a>00302 <span class="keyword">static</span> <a class="code" href="structXRectangle.html">XRectangle</a> status_area;
<a name="l00303"></a>00303 
<a name="l00304"></a>00304 <span class="keyword">static</span> Atom WM_DELETE_WINDOW;
<a name="l00305"></a>00305 <span class="keyword">static</span> Atom WM_PROTOCOLS;
<a name="l00306"></a>00306 <span class="keyword">static</span> Atom fl_MOTIF_WM_HINTS;
<a name="l00307"></a>00307 <span class="keyword">static</span> Atom TARGETS;
<a name="l00308"></a>00308 <span class="keyword">static</span> Atom CLIPBOARD;
<a name="l00309"></a><a class="code" href="Fl__x_8cxx.html#ad074faba40657e6395f50ddde4e78b24">00309</a> Atom <a class="code" href="fl__dnd__x_8cxx.html#ad074faba40657e6395f50ddde4e78b24">fl_XdndAware</a>;
<a name="l00310"></a><a class="code" href="Fl__x_8cxx.html#abd064a82ec8abc4fb47700232eedf637">00310</a> Atom <a class="code" href="fl__dnd__x_8cxx.html#abd064a82ec8abc4fb47700232eedf637">fl_XdndSelection</a>;
<a name="l00311"></a><a class="code" href="Fl__x_8cxx.html#a8ee3339b6065b48fad9c32ccb2304aa0">00311</a> Atom <a class="code" href="fl__dnd__x_8cxx.html#a8ee3339b6065b48fad9c32ccb2304aa0">fl_XdndEnter</a>;
<a name="l00312"></a><a class="code" href="Fl__x_8cxx.html#a4ff86bc919a30a36523d628373c27695">00312</a> Atom <a class="code" href="fl__dnd__x_8cxx.html#a4ff86bc919a30a36523d628373c27695">fl_XdndTypeList</a>;
<a name="l00313"></a><a class="code" href="Fl__x_8cxx.html#af44ca10c1eae9dd81cd7fbfea159546c">00313</a> Atom <a class="code" href="fl__dnd__x_8cxx.html#af44ca10c1eae9dd81cd7fbfea159546c">fl_XdndPosition</a>;
<a name="l00314"></a><a class="code" href="Fl__x_8cxx.html#a7c1cd6189d37fb2b41b0173075805e88">00314</a> Atom <a class="code" href="fl__dnd__x_8cxx.html#a7c1cd6189d37fb2b41b0173075805e88">fl_XdndLeave</a>;
<a name="l00315"></a><a class="code" href="Fl__x_8cxx.html#a2a409974fd57a6301a2d977fdcce98f0">00315</a> Atom <a class="code" href="fl__dnd__x_8cxx.html#a2a409974fd57a6301a2d977fdcce98f0">fl_XdndDrop</a>;
<a name="l00316"></a><a class="code" href="Fl__x_8cxx.html#a02cbaccbbcabc0595225eab194f04e7e">00316</a> Atom <a class="code" href="fl__dnd__x_8cxx.html#a02cbaccbbcabc0595225eab194f04e7e">fl_XdndStatus</a>;
<a name="l00317"></a><a class="code" href="Fl__x_8cxx.html#a6e922382e7697fb2f4b24d98c1cfc24e">00317</a> Atom <a class="code" href="fl__dnd__x_8cxx.html#a6e922382e7697fb2f4b24d98c1cfc24e">fl_XdndActionCopy</a>;
<a name="l00318"></a><a class="code" href="Fl__x_8cxx.html#ab2686fb749db740f9ff964252652067c">00318</a> Atom <a class="code" href="fl__dnd__x_8cxx.html#ab2686fb749db740f9ff964252652067c">fl_XdndFinished</a>;
<a name="l00319"></a>00319 <span class="comment">//Atom fl_XdndProxy;</span>
<a name="l00320"></a><a class="code" href="Fl__x_8cxx.html#a71dba5a81a5697191c2806ace1539c91">00320</a> Atom <a class="code" href="fl__dnd__x_8cxx.html#a71dba5a81a5697191c2806ace1539c91">fl_XdndURIList</a>;
<a name="l00321"></a><a class="code" href="Fl__x_8cxx.html#a65e7404320695cd0062c26fa29eac31c">00321</a> Atom <a class="code" href="Fl__x_8cxx.html#a65e7404320695cd0062c26fa29eac31c">fl_Xatextplainutf</a>;
<a name="l00322"></a><a class="code" href="Fl__x_8cxx.html#a3240c95bb7b0123540a9975d71003c63">00322</a> Atom <a class="code" href="Fl__x_8cxx.html#a3240c95bb7b0123540a9975d71003c63">fl_Xatextplain</a>;
<a name="l00323"></a>00323 <span class="keyword">static</span> Atom fl_XaText;
<a name="l00324"></a><a class="code" href="Fl__x_8cxx.html#a382dd27510afdfb4abd0a92fdbe71d0c">00324</a> Atom <a class="code" href="Fl__x_8cxx.html#a382dd27510afdfb4abd0a92fdbe71d0c">fl_XaCompoundText</a>;
<a name="l00325"></a><a class="code" href="Fl__x_8cxx.html#a381bb31bbe348bfd898b080862e16cac">00325</a> Atom <a class="code" href="fl__dnd__x_8cxx.html#a381bb31bbe348bfd898b080862e16cac">fl_XaUtf8String</a>;
<a name="l00326"></a><a class="code" href="Fl__x_8cxx.html#a45ab13bc70f3585858f73bd56c4c2d69">00326</a> Atom <a class="code" href="Fl__x_8cxx.html#a45ab13bc70f3585858f73bd56c4c2d69">fl_XaTextUriList</a>;
<a name="l00327"></a><a class="code" href="Fl__x_8cxx.html#ac48e9d61512d03eb06d0e885d5f3d8c9">00327</a> Atom <a class="code" href="Fl__x_8cxx.html#ac48e9d61512d03eb06d0e885d5f3d8c9">fl_NET_WM_NAME</a>;                    <span class="comment">// utf8 aware window label</span>
<a name="l00328"></a><a class="code" href="Fl__x_8cxx.html#ace1d58d251216e9c7695d6737bb085ab">00328</a> Atom <a class="code" href="Fl__x_8cxx.html#ace1d58d251216e9c7695d6737bb085ab">fl_NET_WM_ICON_NAME</a>;               <span class="comment">// utf8 aware window icon name</span>
<a name="l00329"></a>00329 
<a name="l00330"></a>00330 <span class="comment">/*</span>
<a name="l00331"></a>00331 <span class="comment">  X defines 32-bit-entities to have a format value of max. 32,</span>
<a name="l00332"></a>00332 <span class="comment">  although sizeof(atom) can be 8 (64 bits) on a 64-bit OS.</span>
<a name="l00333"></a>00333 <span class="comment">  See also fl_open_display() for sizeof(atom) &lt; 4.</span>
<a name="l00334"></a>00334 <span class="comment">  Used for XChangeProperty (see STR #2419).</span>
<a name="l00335"></a>00335 <span class="comment">*/</span>
<a name="l00336"></a>00336 <span class="keyword">static</span> <span class="keywordtype">int</span> atom_bits = 32;
<a name="l00337"></a>00337 
<a name="l00338"></a>00338 <span class="keyword">static</span> <span class="keywordtype">void</span> fd_callback(<span class="keywordtype">int</span>,<span class="keywordtype">void</span> *) {
<a name="l00339"></a>00339   do_queued_events();
<a name="l00340"></a>00340 }
<a name="l00341"></a>00341 
<a name="l00342"></a>00342 <span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> {
<a name="l00343"></a>00343   <span class="keyword">static</span> <span class="keywordtype">int</span> io_error_handler(Display*) {
<a name="l00344"></a>00344     <a class="code" href="group__group__comdlg.html#ga181c7012ef5dd3a551a4e861c9fc974a">Fl::fatal</a>(<span class="stringliteral">&quot;X I/O error&quot;</span>);
<a name="l00345"></a>00345     <span class="keywordflow">return</span> 0;
<a name="l00346"></a>00346   }
<a name="l00347"></a>00347 
<a name="l00348"></a>00348   <span class="keyword">static</span> <span class="keywordtype">int</span> xerror_handler(Display* d, XErrorEvent* e) {
<a name="l00349"></a>00349     <span class="keywordtype">char</span> buf1[128], buf2[128];
<a name="l00350"></a>00350     sprintf(buf1, <span class="stringliteral">&quot;XRequest.%d&quot;</span>, e-&gt;request_code);
<a name="l00351"></a>00351     XGetErrorDatabaseText(d,<span class="stringliteral">&quot;&quot;</span>,buf1,buf1,buf2,128);
<a name="l00352"></a>00352     XGetErrorText(d, e-&gt;error_code, buf1, 128);
<a name="l00353"></a>00353     <a class="code" href="group__group__comdlg.html#gadec4624fcfc09e75fdaf59c2553fe8a9">Fl::warning</a>(<span class="stringliteral">&quot;%s: %s 0x%lx&quot;</span>, buf2, buf1, e-&gt;resourceid);
<a name="l00354"></a>00354     <span class="keywordflow">return</span> 0;
<a name="l00355"></a>00355   }
<a name="l00356"></a>00356 }
<a name="l00357"></a>00357 
<a name="l00358"></a>00358 <span class="keyword">extern</span> <span class="keywordtype">char</span> *<a class="code" href="fl__font__x_8cxx.html#a9764090f6693a0e127c5486c0272c03c">fl_get_font_xfld</a>(<span class="keywordtype">int</span> fnum, <span class="keywordtype">int</span> <a class="code" href="png_8h.html#a43291b8493b637821dec145c4bb1503d">size</a>);
<a name="l00359"></a>00359 
<a name="l00360"></a><a class="code" href="Fl__x_8cxx.html#a327d25e1de2d7b0c28c6b71d2212a276">00360</a> <span class="keywordtype">void</span> <a class="code" href="Fl__x_8cxx.html#a327d25e1de2d7b0c28c6b71d2212a276">fl_new_ic</a>()
<a name="l00361"></a>00361 {
<a name="l00362"></a>00362   XVaNestedList preedit_attr = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00363"></a>00363   XVaNestedList status_attr = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00364"></a>00364   <span class="keyword">static</span> XFontSet fs = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00365"></a>00365   <span class="keywordtype">char</span> *fnt;
<a name="l00366"></a>00366   <span class="keywordtype">bool</span> must_free_fnt = <span class="keyword">true</span>;
<a name="l00367"></a>00367   <span class="keywordtype">char</span> **missing_list;
<a name="l00368"></a>00368   <span class="keywordtype">int</span> missing_count;
<a name="l00369"></a>00369   <span class="keywordtype">char</span> *def_string;
<a name="l00370"></a>00370   <span class="keyword">static</span> <a class="code" href="structXRectangle.html">XRectangle</a> spot;
<a name="l00371"></a>00371   <span class="keywordtype">int</span> predit = 0;
<a name="l00372"></a>00372   <span class="keywordtype">int</span> sarea = 0;
<a name="l00373"></a>00373   XIMStyles* xim_styles = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00374"></a>00374 
<a name="l00375"></a>00375 <span class="preprocessor">#if USE_XFT</span>
<a name="l00376"></a>00376 <span class="preprocessor"></span>
<a name="l00377"></a>00377 <span class="preprocessor">#if defined(__GNUC__)</span>
<a name="l00378"></a>00378 <span class="preprocessor"></span><span class="comment">// FIXME: warning XFT support here</span>
<a name="l00379"></a>00379 <span class="preprocessor">#endif </span><span class="comment">/*__GNUC__*/</span>
<a name="l00380"></a>00380 
<a name="l00381"></a>00381   <span class="keywordflow">if</span> (!fs) {
<a name="l00382"></a>00382     fnt = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;<span class="comment">//fl_get_font_xfld(0, 14);</span>
<a name="l00383"></a>00383     <span class="keywordflow">if</span> (!fnt) {fnt = (<span class="keywordtype">char</span>*)<span class="stringliteral">&quot;-misc-fixed-*&quot;</span>;must_free_fnt=<span class="keyword">false</span>;}
<a name="l00384"></a>00384     fs = XCreateFontSet(fl_display, fnt, &amp;missing_list,
<a name="l00385"></a>00385                         &amp;missing_count, &amp;def_string);
<a name="l00386"></a>00386   }
<a name="l00387"></a>00387 <span class="preprocessor">#else</span>
<a name="l00388"></a>00388 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (!fs) {
<a name="l00389"></a>00389     fnt = <a class="code" href="fl__font__x_8cxx.html#a9764090f6693a0e127c5486c0272c03c">fl_get_font_xfld</a>(0, 14);
<a name="l00390"></a>00390     <span class="keywordflow">if</span> (!fnt) {fnt = (<span class="keywordtype">char</span>*)<span class="stringliteral">&quot;-misc-fixed-*&quot;</span>;must_free_fnt=<span class="keyword">false</span>;}
<a name="l00391"></a>00391     fs = XCreateFontSet(fl_display, fnt, &amp;missing_list,
<a name="l00392"></a>00392                         &amp;missing_count, &amp;def_string);
<a name="l00393"></a>00393   }
<a name="l00394"></a>00394 <span class="preprocessor">#endif</span>
<a name="l00395"></a>00395 <span class="preprocessor"></span>  preedit_attr = XVaCreateNestedList(0,
<a name="l00396"></a>00396                                      XNSpotLocation, &amp;spot,
<a name="l00397"></a>00397                                      XNFontSet, fs, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00398"></a>00398   status_attr = XVaCreateNestedList(0,
<a name="l00399"></a>00399                                     XNAreaNeeded, &amp;status_area,
<a name="l00400"></a>00400                                     XNFontSet, fs, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00401"></a>00401 
<a name="l00402"></a>00402   <span class="keywordflow">if</span> (!XGetIMValues(fl_xim_im, XNQueryInputStyle,
<a name="l00403"></a>00403                     &amp;xim_styles, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l00404"></a>00404     <span class="keywordtype">int</span> <a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>;
<a name="l00405"></a>00405     XIMStyle *style;
<a name="l00406"></a>00406     <span class="keywordflow">for</span> (i = 0, style = xim_styles-&gt;supported_styles;
<a name="l00407"></a>00407          i &lt; xim_styles-&gt;count_styles; i++, style++) {
<a name="l00408"></a>00408       <span class="keywordflow">if</span> (*style == (XIMPreeditPosition | XIMStatusArea)) {
<a name="l00409"></a>00409         sarea = 1;
<a name="l00410"></a>00410         predit = 1;
<a name="l00411"></a>00411       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*style == (XIMPreeditPosition | XIMStatusNothing)) {
<a name="l00412"></a>00412         predit = 1;
<a name="l00413"></a>00413       }
<a name="l00414"></a>00414     }
<a name="l00415"></a>00415   }
<a name="l00416"></a>00416   XFree(xim_styles);
<a name="l00417"></a>00417 
<a name="l00418"></a>00418   <span class="keywordflow">if</span> (sarea) {
<a name="l00419"></a>00419     fl_xim_ic = XCreateIC(fl_xim_im,
<a name="l00420"></a>00420                           XNInputStyle, (XIMPreeditPosition | XIMStatusArea),
<a name="l00421"></a>00421                           XNPreeditAttributes, preedit_attr,
<a name="l00422"></a>00422                           XNStatusAttributes, status_attr,
<a name="l00423"></a>00423                           <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00424"></a>00424   }
<a name="l00425"></a>00425 
<a name="l00426"></a>00426   <span class="keywordflow">if</span> (!fl_xim_ic &amp;&amp; predit) {
<a name="l00427"></a>00427     fl_xim_ic = XCreateIC(fl_xim_im,
<a name="l00428"></a>00428                           XNInputStyle, (XIMPreeditPosition | XIMStatusNothing),
<a name="l00429"></a>00429                           XNPreeditAttributes, preedit_attr,
<a name="l00430"></a>00430                           <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00431"></a>00431   }
<a name="l00432"></a>00432   XFree(preedit_attr);
<a name="l00433"></a>00433   XFree(status_attr);
<a name="l00434"></a>00434   <span class="keywordflow">if</span> (!fl_xim_ic) {
<a name="l00435"></a>00435     fl_is_over_the_spot = 0;
<a name="l00436"></a>00436     fl_xim_ic = XCreateIC(fl_xim_im,
<a name="l00437"></a>00437                           XNInputStyle, (XIMPreeditNothing | XIMStatusNothing),
<a name="l00438"></a>00438                           <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00439"></a>00439   } <span class="keywordflow">else</span> {
<a name="l00440"></a>00440     fl_is_over_the_spot = 1;
<a name="l00441"></a>00441     XVaNestedList status_attr = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00442"></a>00442     status_attr = XVaCreateNestedList(0, XNAreaNeeded, &amp;status_area, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00443"></a>00443 
<a name="l00444"></a>00444     XGetICValues(fl_xim_ic, XNStatusAttributes, status_attr, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00445"></a>00445     XFree(status_attr);
<a name="l00446"></a>00446   }
<a name="l00447"></a>00447 }
<a name="l00448"></a>00448 
<a name="l00449"></a>00449 
<a name="l00450"></a>00450 <span class="keyword">static</span> <a class="code" href="structXRectangle.html">XRectangle</a>    spot;
<a name="l00451"></a>00451 <span class="keyword">static</span> <span class="keywordtype">int</span> spotf = -1;
<a name="l00452"></a>00452 <span class="keyword">static</span> <span class="keywordtype">int</span> spots = -1;
<a name="l00453"></a>00453 
<a name="l00454"></a><a class="code" href="group__fl__drawings.html#gaa6c8068dbc30f05765330e31f08350d7">00454</a> <span class="keywordtype">void</span> <a class="code" href="group__fl__drawings.html#gaa6c8068dbc30f05765330e31f08350d7">fl_reset_spot</a>(<span class="keywordtype">void</span>)
<a name="l00455"></a>00455 {
<a name="l00456"></a>00456   spot.<a class="code" href="structXRectangle.html#ad8e3fc4eef045bff66cfa7414bf9d961">x</a> = -1;
<a name="l00457"></a>00457   spot.<a class="code" href="structXRectangle.html#a868d20ae8a5b46cc03e1128b0467b1f3">y</a> = -1;
<a name="l00458"></a>00458   <span class="comment">//if (fl_xim_ic) XUnsetICFocus(fl_xim_ic);</span>
<a name="l00459"></a>00459 }
<a name="l00460"></a>00460 
<a name="l00461"></a><a class="code" href="group__fl__drawings.html#ga748fcead12c8cc67cb517cab02c273a2">00461</a> <span class="keywordtype">void</span> <a class="code" href="group__fl__drawings.html#ga748fcead12c8cc67cb517cab02c273a2">fl_set_spot</a>(<span class="keywordtype">int</span> font, <span class="keywordtype">int</span> <a class="code" href="png_8h.html#a43291b8493b637821dec145c4bb1503d">size</a>, <span class="keywordtype">int</span> X, <span class="keywordtype">int</span> Y, <span class="keywordtype">int</span> W, <span class="keywordtype">int</span> <a class="code" href="Fl__Tooltip_8cxx.html#affa487e8e3cc48473cfc05c0ce0165e9">H</a>, <a class="code" href="classFl__Window.html">Fl_Window</a> *win)
<a name="l00462"></a>00462 {
<a name="l00463"></a>00463   <span class="keywordtype">int</span> change = 0;
<a name="l00464"></a>00464   XVaNestedList preedit_attr;
<a name="l00465"></a>00465   <span class="keyword">static</span> XFontSet fs = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00466"></a>00466   <span class="keywordtype">char</span> **missing_list;
<a name="l00467"></a>00467   <span class="keywordtype">int</span> missing_count;
<a name="l00468"></a>00468   <span class="keywordtype">char</span> *def_string;
<a name="l00469"></a>00469   <span class="keywordtype">char</span> *fnt = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00470"></a>00470   <span class="keywordtype">bool</span> must_free_fnt =<span class="keyword">true</span>;
<a name="l00471"></a>00471 
<a name="l00472"></a>00472   <span class="keyword">static</span> XIC ic = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00473"></a>00473 
<a name="l00474"></a>00474   <span class="keywordflow">if</span> (!fl_xim_ic || !fl_is_over_the_spot) <span class="keywordflow">return</span>;
<a name="l00475"></a>00475   <span class="comment">//XSetICFocus(fl_xim_ic);</span>
<a name="l00476"></a>00476   <span class="keywordflow">if</span> (X != spot.<a class="code" href="structXRectangle.html#ad8e3fc4eef045bff66cfa7414bf9d961">x</a> || Y != spot.<a class="code" href="structXRectangle.html#a868d20ae8a5b46cc03e1128b0467b1f3">y</a>) {
<a name="l00477"></a>00477     spot.<a class="code" href="structXRectangle.html#ad8e3fc4eef045bff66cfa7414bf9d961">x</a> = X;
<a name="l00478"></a>00478     spot.<a class="code" href="structXRectangle.html#a868d20ae8a5b46cc03e1128b0467b1f3">y</a> = Y;
<a name="l00479"></a>00479     spot.<a class="code" href="structXRectangle.html#a3ad204f8adec7b624292499ca5cdadb5">height</a> = <a class="code" href="Fl__Tooltip_8cxx.html#affa487e8e3cc48473cfc05c0ce0165e9">H</a>;
<a name="l00480"></a>00480     spot.<a class="code" href="structXRectangle.html#a9221b0fe551ac4d4a3324b62f3f5e2e1">width</a> = W;
<a name="l00481"></a>00481     change = 1;
<a name="l00482"></a>00482   }
<a name="l00483"></a>00483   <span class="keywordflow">if</span> (font != spotf || size != spots) {
<a name="l00484"></a>00484     spotf = font;
<a name="l00485"></a>00485     spots = <a class="code" href="png_8h.html#a43291b8493b637821dec145c4bb1503d">size</a>;
<a name="l00486"></a>00486     change = 1;
<a name="l00487"></a>00487     <span class="keywordflow">if</span> (fs) {
<a name="l00488"></a>00488       XFreeFontSet(fl_display, fs);
<a name="l00489"></a>00489     }
<a name="l00490"></a>00490 <span class="preprocessor">#if USE_XFT</span>
<a name="l00491"></a>00491 <span class="preprocessor"></span>
<a name="l00492"></a>00492 <span class="preprocessor">#if defined(__GNUC__)</span>
<a name="l00493"></a>00493 <span class="preprocessor"></span><span class="comment">// FIXME: warning XFT support here</span>
<a name="l00494"></a>00494 <span class="preprocessor">#endif </span><span class="comment">/*__GNUC__*/</span>
<a name="l00495"></a>00495 
<a name="l00496"></a>00496     fnt = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>; <span class="comment">// fl_get_font_xfld(font, size);</span>
<a name="l00497"></a>00497     <span class="keywordflow">if</span> (!fnt) {fnt = (<span class="keywordtype">char</span>*)<span class="stringliteral">&quot;-misc-fixed-*&quot;</span>;must_free_fnt=<span class="keyword">false</span>;}
<a name="l00498"></a>00498     fs = XCreateFontSet(fl_display, fnt, &amp;missing_list,
<a name="l00499"></a>00499                         &amp;missing_count, &amp;def_string);
<a name="l00500"></a>00500 <span class="preprocessor">#else</span>
<a name="l00501"></a>00501 <span class="preprocessor"></span>    fnt = <a class="code" href="fl__font__x_8cxx.html#a9764090f6693a0e127c5486c0272c03c">fl_get_font_xfld</a>(font, size);
<a name="l00502"></a>00502     <span class="keywordflow">if</span> (!fnt) {fnt = (<span class="keywordtype">char</span>*)<span class="stringliteral">&quot;-misc-fixed-*&quot;</span>;must_free_fnt=<span class="keyword">false</span>;}
<a name="l00503"></a>00503     fs = XCreateFontSet(fl_display, fnt, &amp;missing_list,
<a name="l00504"></a>00504                         &amp;missing_count, &amp;def_string);
<a name="l00505"></a>00505 <span class="preprocessor">#endif</span>
<a name="l00506"></a>00506 <span class="preprocessor"></span>  }
<a name="l00507"></a>00507   <span class="keywordflow">if</span> (fl_xim_ic != ic) {
<a name="l00508"></a>00508     ic = <a class="code" href="Fl__x_8cxx.html#a7942c1303b6c6023062b69f545e53475">fl_xim_ic</a>;
<a name="l00509"></a>00509     change = 1;
<a name="l00510"></a>00510   }
<a name="l00511"></a>00511 
<a name="l00512"></a>00512   <span class="keywordflow">if</span> (fnt &amp;&amp; must_free_fnt) free(fnt);
<a name="l00513"></a>00513   <span class="keywordflow">if</span> (!change) <span class="keywordflow">return</span>;
<a name="l00514"></a>00514 
<a name="l00515"></a>00515 
<a name="l00516"></a>00516   preedit_attr = XVaCreateNestedList(0,
<a name="l00517"></a>00517                                      XNSpotLocation, &amp;spot,
<a name="l00518"></a>00518                                      XNFontSet, fs, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00519"></a>00519   XSetICValues(fl_xim_ic, XNPreeditAttributes, preedit_attr, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00520"></a>00520   XFree(preedit_attr);
<a name="l00521"></a>00521 }
<a name="l00522"></a>00522 
<a name="l00523"></a><a class="code" href="group__fl__drawings.html#ga496c7d22ad30fe84717bb765dd6d1fc8">00523</a> <span class="keywordtype">void</span> <a class="code" href="group__fl__drawings.html#ga496c7d22ad30fe84717bb765dd6d1fc8">fl_set_status</a>(<span class="keywordtype">int</span> <a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>, <span class="keywordtype">int</span> <a class="code" href="test_8c.html#a0a2f84ed7838f07779ae24c5a9086d33">y</a>, <span class="keywordtype">int</span> <a class="code" href="forms_8H-2.html#aac374e320caaadeca4874add33b62af2">w</a>, <span class="keywordtype">int</span> <a class="code" href="forms_8H-2.html#a7e427ba5b307f9068129699250690066">h</a>)
<a name="l00524"></a>00524 {
<a name="l00525"></a>00525   XVaNestedList status_attr;
<a name="l00526"></a>00526   status_area.<a class="code" href="structXRectangle.html#ad8e3fc4eef045bff66cfa7414bf9d961">x</a> = <a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>;
<a name="l00527"></a>00527   status_area.<a class="code" href="structXRectangle.html#a868d20ae8a5b46cc03e1128b0467b1f3">y</a> = <a class="code" href="test_8c.html#a0a2f84ed7838f07779ae24c5a9086d33">y</a>;
<a name="l00528"></a>00528   status_area.<a class="code" href="structXRectangle.html#a9221b0fe551ac4d4a3324b62f3f5e2e1">width</a> = <a class="code" href="forms_8H-2.html#aac374e320caaadeca4874add33b62af2">w</a>;
<a name="l00529"></a>00529   status_area.<a class="code" href="structXRectangle.html#a3ad204f8adec7b624292499ca5cdadb5">height</a> = <a class="code" href="forms_8H-2.html#a7e427ba5b307f9068129699250690066">h</a>;
<a name="l00530"></a>00530   <span class="keywordflow">if</span> (!fl_xim_ic) <span class="keywordflow">return</span>;
<a name="l00531"></a>00531   status_attr = XVaCreateNestedList(0, XNArea, &amp;status_area, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00532"></a>00532 
<a name="l00533"></a>00533   XSetICValues(fl_xim_ic, XNStatusAttributes, status_attr, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00534"></a>00534   XFree(status_attr);
<a name="l00535"></a>00535 }
<a name="l00536"></a>00536 
<a name="l00537"></a><a class="code" href="Fl__x_8cxx.html#ab73453ae87277dd8facd2a996055c529">00537</a> <span class="keywordtype">void</span> <a class="code" href="Fl__x_8cxx.html#ab73453ae87277dd8facd2a996055c529">fl_init_xim</a>()
<a name="l00538"></a>00538 {
<a name="l00539"></a>00539   <span class="comment">//XIMStyle *style;</span>
<a name="l00540"></a>00540   XIMStyles *xim_styles;
<a name="l00541"></a>00541   <span class="keywordflow">if</span> (!fl_display) <span class="keywordflow">return</span>;
<a name="l00542"></a>00542   <span class="keywordflow">if</span> (fl_xim_im) <span class="keywordflow">return</span>;
<a name="l00543"></a>00543 
<a name="l00544"></a>00544   fl_xim_im = XOpenIM(fl_display, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00545"></a>00545   xim_styles = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00546"></a>00546   fl_xim_ic = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00547"></a>00547 
<a name="l00548"></a>00548   <span class="keywordflow">if</span> (fl_xim_im) {
<a name="l00549"></a>00549     XGetIMValues (fl_xim_im, XNQueryInputStyle,
<a name="l00550"></a>00550                   &amp;xim_styles, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00551"></a>00551   } <span class="keywordflow">else</span> {
<a name="l00552"></a>00552     <a class="code" href="group__group__comdlg.html#gadec4624fcfc09e75fdaf59c2553fe8a9">Fl::warning</a>(<span class="stringliteral">&quot;XOpenIM() failed\n&quot;</span>);
<a name="l00553"></a>00553     <span class="keywordflow">return</span>;
<a name="l00554"></a>00554   }
<a name="l00555"></a>00555 
<a name="l00556"></a>00556   <span class="keywordflow">if</span> (xim_styles &amp;&amp; xim_styles-&gt;count_styles) {
<a name="l00557"></a>00557     <a class="code" href="Fl__x_8cxx.html#a327d25e1de2d7b0c28c6b71d2212a276">fl_new_ic</a>();
<a name="l00558"></a>00558    } <span class="keywordflow">else</span> {
<a name="l00559"></a>00559      <a class="code" href="group__group__comdlg.html#gadec4624fcfc09e75fdaf59c2553fe8a9">Fl::warning</a>(<span class="stringliteral">&quot;No XIM style found\n&quot;</span>);
<a name="l00560"></a>00560      XCloseIM(fl_xim_im);
<a name="l00561"></a>00561      fl_xim_im = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00562"></a>00562      <span class="keywordflow">return</span>;
<a name="l00563"></a>00563   }
<a name="l00564"></a>00564   <span class="keywordflow">if</span> (!fl_xim_ic) {
<a name="l00565"></a>00565     <a class="code" href="group__group__comdlg.html#gadec4624fcfc09e75fdaf59c2553fe8a9">Fl::warning</a>(<span class="stringliteral">&quot;XCreateIC() failed\n&quot;</span>);
<a name="l00566"></a>00566     XCloseIM(fl_xim_im);
<a name="l00567"></a>00567     XFree(xim_styles);
<a name="l00568"></a>00568     fl_xim_im = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00569"></a>00569   }
<a name="l00570"></a>00570 }
<a name="l00571"></a>00571 
<a name="l00572"></a><a class="code" href="Fl__x_8cxx.html#a94ee21d83137569a6730e3e2e7305cbc">00572</a> <span class="keywordtype">void</span> <a class="code" href="mac_8H.html#a94ee21d83137569a6730e3e2e7305cbc">fl_open_display</a>() {
<a name="l00573"></a>00573   <span class="keywordflow">if</span> (fl_display) <span class="keywordflow">return</span>;
<a name="l00574"></a>00574 
<a name="l00575"></a>00575   setlocale(LC_CTYPE, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00576"></a>00576   XSetLocaleModifiers(<span class="stringliteral">&quot;&quot;</span>);
<a name="l00577"></a>00577 
<a name="l00578"></a>00578   XSetIOErrorHandler(io_error_handler);
<a name="l00579"></a>00579   XSetErrorHandler(xerror_handler);
<a name="l00580"></a>00580 
<a name="l00581"></a>00581   Display *d = XOpenDisplay(0);
<a name="l00582"></a>00582   <span class="keywordflow">if</span> (!d) <a class="code" href="group__group__comdlg.html#ga181c7012ef5dd3a551a4e861c9fc974a">Fl::fatal</a>(<span class="stringliteral">&quot;Can&#39;t open display: %s&quot;</span>,XDisplayName(0));
<a name="l00583"></a>00583 
<a name="l00584"></a>00584   <a class="code" href="mac_8H.html#a94ee21d83137569a6730e3e2e7305cbc">fl_open_display</a>(d);
<a name="l00585"></a>00585 }
<a name="l00586"></a>00586 
<a name="l00587"></a><a class="code" href="Fl__x_8cxx.html#a5b5ac8c8163e3c4a4a1f30e171cef1ad">00587</a> <span class="keywordtype">void</span> <a class="code" href="mac_8H.html#a94ee21d83137569a6730e3e2e7305cbc">fl_open_display</a>(Display* d) {
<a name="l00588"></a>00588   fl_display = d;
<a name="l00589"></a>00589 
<a name="l00590"></a>00590   WM_DELETE_WINDOW      = XInternAtom(d, <span class="stringliteral">&quot;WM_DELETE_WINDOW&quot;</span>,    0);
<a name="l00591"></a>00591   WM_PROTOCOLS          = XInternAtom(d, <span class="stringliteral">&quot;WM_PROTOCOLS&quot;</span>,        0);
<a name="l00592"></a>00592   fl_MOTIF_WM_HINTS     = XInternAtom(d, <span class="stringliteral">&quot;_MOTIF_WM_HINTS&quot;</span>,     0);
<a name="l00593"></a>00593   TARGETS               = XInternAtom(d, <span class="stringliteral">&quot;TARGETS&quot;</span>,             0);
<a name="l00594"></a>00594   CLIPBOARD             = XInternAtom(d, <span class="stringliteral">&quot;CLIPBOARD&quot;</span>,           0);
<a name="l00595"></a>00595   fl_XdndAware          = XInternAtom(d, <span class="stringliteral">&quot;XdndAware&quot;</span>,           0);
<a name="l00596"></a>00596   fl_XdndSelection      = XInternAtom(d, <span class="stringliteral">&quot;XdndSelection&quot;</span>,       0);
<a name="l00597"></a>00597   fl_XdndEnter          = XInternAtom(d, <span class="stringliteral">&quot;XdndEnter&quot;</span>,           0);
<a name="l00598"></a>00598   fl_XdndTypeList       = XInternAtom(d, <span class="stringliteral">&quot;XdndTypeList&quot;</span>,        0);
<a name="l00599"></a>00599   fl_XdndPosition       = XInternAtom(d, <span class="stringliteral">&quot;XdndPosition&quot;</span>,        0);
<a name="l00600"></a>00600   fl_XdndLeave          = XInternAtom(d, <span class="stringliteral">&quot;XdndLeave&quot;</span>,           0);
<a name="l00601"></a>00601   fl_XdndDrop           = XInternAtom(d, <span class="stringliteral">&quot;XdndDrop&quot;</span>,            0);
<a name="l00602"></a>00602   fl_XdndStatus         = XInternAtom(d, <span class="stringliteral">&quot;XdndStatus&quot;</span>,          0);
<a name="l00603"></a>00603   fl_XdndActionCopy     = XInternAtom(d, <span class="stringliteral">&quot;XdndActionCopy&quot;</span>,      0);
<a name="l00604"></a>00604   fl_XdndFinished       = XInternAtom(d, <span class="stringliteral">&quot;XdndFinished&quot;</span>,        0);
<a name="l00605"></a>00605   <span class="comment">//fl_XdndProxy        = XInternAtom(d, &quot;XdndProxy&quot;,           0);</span>
<a name="l00606"></a>00606   fl_XdndEnter          = XInternAtom(d, <span class="stringliteral">&quot;XdndEnter&quot;</span>,           0);
<a name="l00607"></a>00607   fl_XdndURIList        = XInternAtom(d, <span class="stringliteral">&quot;text/uri-list&quot;</span>,       0);
<a name="l00608"></a>00608   fl_Xatextplainutf     = XInternAtom(d, <span class="stringliteral">&quot;text/plain;charset=UTF-8&quot;</span>,0);
<a name="l00609"></a>00609   fl_Xatextplain        = XInternAtom(d, <span class="stringliteral">&quot;text/plain&quot;</span>,          0);
<a name="l00610"></a>00610   fl_XaText             = XInternAtom(d, <span class="stringliteral">&quot;TEXT&quot;</span>,                0);     
<a name="l00611"></a>00611   fl_XaCompoundText     = XInternAtom(d, <span class="stringliteral">&quot;COMPOUND_TEXT&quot;</span>,       0);
<a name="l00612"></a>00612   fl_XaUtf8String       = XInternAtom(d, <span class="stringliteral">&quot;UTF8_STRING&quot;</span>,         0);
<a name="l00613"></a>00613   fl_XaTextUriList      = XInternAtom(d, <span class="stringliteral">&quot;text/uri-list&quot;</span>,       0);
<a name="l00614"></a>00614   fl_NET_WM_NAME        = XInternAtom(d, <span class="stringliteral">&quot;_NET_WM_NAME&quot;</span>,        0);
<a name="l00615"></a>00615   fl_NET_WM_ICON_NAME   = XInternAtom(d, <span class="stringliteral">&quot;_NET_WM_ICON_NAME&quot;</span>,   0);
<a name="l00616"></a>00616   
<a name="l00617"></a>00617   <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>(Atom) &lt; 4)
<a name="l00618"></a>00618     atom_bits = <span class="keyword">sizeof</span>(Atom) * 8;
<a name="l00619"></a>00619 
<a name="l00620"></a>00620   <a class="code" href="classFl.html#a799b8278326b3c2db15687c43c11aaf6">Fl::add_fd</a>(ConnectionNumber(d), POLLIN, fd_callback);
<a name="l00621"></a>00621 
<a name="l00622"></a>00622   fl_screen = DefaultScreen(d);
<a name="l00623"></a>00623 
<a name="l00624"></a>00624   fl_message_window =
<a name="l00625"></a>00625     XCreateSimpleWindow(d, RootWindow(d,fl_screen), 0,0,1,1,0, 0, 0);
<a name="l00626"></a>00626 
<a name="l00627"></a>00627 <span class="comment">// construct an XVisualInfo that matches the default Visual:</span>
<a name="l00628"></a>00628   XVisualInfo templt; <span class="keywordtype">int</span> <a class="code" href="png_8h.html#ac2d0018d5ab0817c8a1c83c69746a799">num</a>;
<a name="l00629"></a>00629   templt.visualid = XVisualIDFromVisual(DefaultVisual(d, fl_screen));
<a name="l00630"></a>00630   fl_visual = XGetVisualInfo(d, VisualIDMask, &amp;templt, &amp;num);
<a name="l00631"></a>00631   fl_colormap = DefaultColormap(d, fl_screen);
<a name="l00632"></a>00632   <a class="code" href="Fl__x_8cxx.html#ab73453ae87277dd8facd2a996055c529">fl_init_xim</a>();
<a name="l00633"></a>00633 
<a name="l00634"></a>00634 <span class="preprocessor">#if !USE_COLORMAP</span>
<a name="l00635"></a>00635 <span class="preprocessor"></span>  <a class="code" href="classFl.html#a6d6deb3d4f76b538d508b36700dfb6b0">Fl::visual</a>(<a class="code" href="Enumerations_8H.html#aae982ff3b1a082b1a512b216b98061e0a109b723978c5a645aeee20cf1b4c3667">FL_RGB</a>);
<a name="l00636"></a>00636 <span class="preprocessor">#endif</span>
<a name="l00637"></a>00637 <span class="preprocessor"></span>}
<a name="l00638"></a>00638 
<a name="l00639"></a><a class="code" href="Fl__x_8cxx.html#ab25e8f232319c7a694588986e6dc1a60">00639</a> <span class="keywordtype">void</span> <a class="code" href="x_8H.html#ade3ae56765e00bc95627ff95c63cd2d7">fl_close_display</a>() {
<a name="l00640"></a>00640   <a class="code" href="classFl.html#a71e75c1a559e3415c5304c37235af831">Fl::remove_fd</a>(ConnectionNumber(fl_display));
<a name="l00641"></a>00641   XCloseDisplay(fl_display);
<a name="l00642"></a>00642 }
<a name="l00643"></a>00643 
<a name="l00644"></a>00644 <span class="keyword">static</span> <span class="keywordtype">int</span> fl_workarea_xywh[4] = { -1, -1, -1, -1 };
<a name="l00645"></a>00645 
<a name="l00646"></a>00646 <span class="keyword">static</span> <span class="keywordtype">void</span> fl_init_workarea() {
<a name="l00647"></a>00647   <a class="code" href="mac_8H.html#a94ee21d83137569a6730e3e2e7305cbc">fl_open_display</a>();
<a name="l00648"></a>00648 
<a name="l00649"></a>00649   Atom _NET_WORKAREA = XInternAtom(fl_display, <span class="stringliteral">&quot;_NET_WORKAREA&quot;</span>, 0);
<a name="l00650"></a>00650   Atom actual;
<a name="l00651"></a>00651   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> count, remaining;
<a name="l00652"></a>00652   <span class="keywordtype">int</span> format;
<a name="l00653"></a>00653   <span class="keywordtype">unsigned</span> *xywh;
<a name="l00654"></a>00654 
<a name="l00655"></a>00655   <span class="keywordflow">if</span> (XGetWindowProperty(fl_display, RootWindow(fl_display, fl_screen),
<a name="l00656"></a>00656                          _NET_WORKAREA, 0, 4 * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span>), False,
<a name="l00657"></a>00657                          XA_CARDINAL, &amp;actual, &amp;format, &amp;count, &amp;remaining,
<a name="l00658"></a>00658                          (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **)&amp;xywh) || !xywh || !xywh[2] ||
<a name="l00659"></a>00659                          !xywh[3])
<a name="l00660"></a>00660   {
<a name="l00661"></a>00661     fl_workarea_xywh[0] = 0;
<a name="l00662"></a>00662     fl_workarea_xywh[1] = 0;
<a name="l00663"></a>00663     fl_workarea_xywh[2] = DisplayWidth(fl_display, fl_screen);
<a name="l00664"></a>00664     fl_workarea_xywh[3] = DisplayHeight(fl_display, fl_screen);
<a name="l00665"></a>00665   }
<a name="l00666"></a>00666   <span class="keywordflow">else</span>
<a name="l00667"></a>00667   {
<a name="l00668"></a>00668     fl_workarea_xywh[0] = (<a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>)xywh[0];
<a name="l00669"></a>00669     fl_workarea_xywh[1] = (<a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>)xywh[1];
<a name="l00670"></a>00670     fl_workarea_xywh[2] = (<a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>)xywh[2];
<a name="l00671"></a>00671     fl_workarea_xywh[3] = (<a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>)xywh[3];
<a name="l00672"></a>00672     XFree(xywh);
<a name="l00673"></a>00673   }
<a name="l00674"></a>00674 }
<a name="l00675"></a>00675 
<a name="l00676"></a>00676 <span class="keywordtype">int</span> <a class="code" href="group__fl__screen.html#gaed836eacded3467aa838d02a1c55e3ab">Fl::x</a>() {
<a name="l00677"></a>00677   <span class="keywordflow">if</span> (fl_workarea_xywh[0] &lt; 0) fl_init_workarea();
<a name="l00678"></a>00678   <span class="keywordflow">return</span> fl_workarea_xywh[0];
<a name="l00679"></a>00679 }
<a name="l00680"></a>00680 
<a name="l00681"></a>00681 <span class="keywordtype">int</span> <a class="code" href="group__fl__screen.html#gafa36572c1f755f8a9783efc351f19021">Fl::y</a>() {
<a name="l00682"></a>00682   <span class="keywordflow">if</span> (fl_workarea_xywh[0] &lt; 0) fl_init_workarea();
<a name="l00683"></a>00683   <span class="keywordflow">return</span> fl_workarea_xywh[1];
<a name="l00684"></a>00684 }
<a name="l00685"></a>00685 
<a name="l00686"></a>00686 <span class="keywordtype">int</span> <a class="code" href="group__fl__screen.html#ga7aba4252407f539aa6d821551aaba5ff">Fl::w</a>() {
<a name="l00687"></a>00687   <span class="keywordflow">if</span> (fl_workarea_xywh[0] &lt; 0) fl_init_workarea();
<a name="l00688"></a>00688   <span class="keywordflow">return</span> fl_workarea_xywh[2];
<a name="l00689"></a>00689 }
<a name="l00690"></a>00690 
<a name="l00691"></a>00691 <span class="keywordtype">int</span> <a class="code" href="group__fl__screen.html#ga7f42d75cf9b3e79bbe39e1041a657cdf">Fl::h</a>() {
<a name="l00692"></a>00692   <span class="keywordflow">if</span> (fl_workarea_xywh[0] &lt; 0) fl_init_workarea();
<a name="l00693"></a>00693   <span class="keywordflow">return</span> fl_workarea_xywh[3];
<a name="l00694"></a>00694 }
<a name="l00695"></a>00695 
<a name="l00696"></a>00696 <span class="keywordtype">void</span> <a class="code" href="group__fl__events.html#gace49495f2b947065bb140e5023d14954">Fl::get_mouse</a>(<span class="keywordtype">int</span> &amp;xx, <span class="keywordtype">int</span> &amp;yy) {
<a name="l00697"></a>00697   <a class="code" href="mac_8H.html#a94ee21d83137569a6730e3e2e7305cbc">fl_open_display</a>();
<a name="l00698"></a>00698   <a class="code" href="mac_8H.html#aad9fe48cacd960402308a6a7f9f5e584">Window</a> root = RootWindow(fl_display, fl_screen);
<a name="l00699"></a>00699   <a class="code" href="mac_8H.html#aad9fe48cacd960402308a6a7f9f5e584">Window</a> c; <span class="keywordtype">int</span> mx,my,cx,cy; <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="png_8h.html#aa61e47f2cb0ad7631948cd857c77164f">mask</a>;
<a name="l00700"></a>00700   XQueryPointer(fl_display,root,&amp;root,&amp;c,&amp;mx,&amp;my,&amp;cx,&amp;cy,&amp;mask);
<a name="l00701"></a>00701   xx = mx;
<a name="l00702"></a>00702   yy = my;
<a name="l00703"></a>00703 }
<a name="l00704"></a>00704 
<a name="l00706"></a>00706 <span class="comment">// Code used for paste and DnD into the program:</span>
<a name="l00707"></a>00707 
<a name="l00708"></a><a class="code" href="Fl__x_8cxx.html#ab0f3888aed9e28e4a7741a25f96d3b39">00708</a> <a class="code" href="classFl__Widget.html">Fl_Widget</a> *<a class="code" href="Fl_8cxx.html#ab0f3888aed9e28e4a7741a25f96d3b39">fl_selection_requestor</a>;
<a name="l00709"></a><a class="code" href="Fl__x_8cxx.html#ab850f01f9743ea1b220f00c8bda656be">00709</a> <span class="keywordtype">char</span> *<a class="code" href="fl__dnd__win32_8cxx.html#ab850f01f9743ea1b220f00c8bda656be">fl_selection_buffer</a>[2];
<a name="l00710"></a><a class="code" href="Fl__x_8cxx.html#ac27fcc9909cfd33bc0bbd5085312a301">00710</a> <span class="keywordtype">int</span> <a class="code" href="fl__dnd__win32_8cxx.html#ac27fcc9909cfd33bc0bbd5085312a301">fl_selection_length</a>[2];
<a name="l00711"></a><a class="code" href="Fl__x_8cxx.html#a074479f79d157734e2835b1885ade608">00711</a> <span class="keywordtype">int</span> <a class="code" href="fl__dnd__win32_8cxx.html#a074479f79d157734e2835b1885ade608">fl_selection_buffer_length</a>[2];
<a name="l00712"></a><a class="code" href="Fl__x_8cxx.html#aecfd0b12072135852c3acecaf9e95748">00712</a> <span class="keywordtype">char</span> <a class="code" href="fl__dnd__win32_8cxx.html#aecfd0b12072135852c3acecaf9e95748">fl_i_own_selection</a>[2] = {0,0};
<a name="l00713"></a>00713 
<a name="l00714"></a>00714 <span class="comment">// Call this when a &quot;paste&quot; operation happens:</span>
<a name="l00715"></a>00715 <span class="keywordtype">void</span> <a class="code" href="group__fl__clipboard.html#ga2d0fc8fedc6bfc23f378b3f100660d80">Fl::paste</a>(<a class="code" href="classFl__Widget.html">Fl_Widget</a> &amp;receiver, <span class="keywordtype">int</span> clipboard) {
<a name="l00716"></a>00716   <span class="keywordflow">if</span> (fl_i_own_selection[clipboard]) {
<a name="l00717"></a>00717     <span class="comment">// We already have it, do it quickly without window server.</span>
<a name="l00718"></a>00718     <span class="comment">// Notice that the text is clobbered if set_selection is</span>
<a name="l00719"></a>00719     <span class="comment">// called in response to FL_PASTE!</span>
<a name="l00720"></a>00720     <a class="code" href="classFl.html#addcd49b68feff0a807f6564f3fdb8016">Fl::e_text</a> = fl_selection_buffer[clipboard];
<a name="l00721"></a>00721     <a class="code" href="classFl.html#a336911cf63dade9bbb9707b942785133">Fl::e_length</a> = fl_selection_length[clipboard];
<a name="l00722"></a>00722     <span class="keywordflow">if</span> (!<a class="code" href="classFl.html#addcd49b68feff0a807f6564f3fdb8016">Fl::e_text</a>) <a class="code" href="classFl.html#addcd49b68feff0a807f6564f3fdb8016">Fl::e_text</a> = (<span class="keywordtype">char</span> *)<span class="stringliteral">&quot;&quot;</span>;
<a name="l00723"></a>00723     receiver.<a class="code" href="classFl__Widget.html#a9cb17cc092697dfd05a3fab55856d218">handle</a>(<a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a5e811b9d703e6f66cfdca256ecfbb0cf">FL_PASTE</a>);
<a name="l00724"></a>00724     <span class="keywordflow">return</span>;
<a name="l00725"></a>00725   }
<a name="l00726"></a>00726   <span class="comment">// otherwise get the window server to return it:</span>
<a name="l00727"></a>00727   fl_selection_requestor = &amp;receiver;
<a name="l00728"></a>00728   Atom <span class="keyword">property</span> = clipboard ? CLIPBOARD : XA_PRIMARY;
<a name="l00729"></a>00729   XConvertSelection(fl_display, property, TARGETS, property,
<a name="l00730"></a>00730                     <a class="code" href="mac_8H.html#a87152d2ed84f9d97c6bf3150c7688261">fl_xid</a>(<a class="code" href="group__fl__windows.html#ga3130407bc1c11f9b7f2a9c43a87a1599">Fl::first_window</a>()), <a class="code" href="x_8H.html#a5112b03f22e38209736b7d21a6d100ab">fl_event_time</a>);
<a name="l00731"></a>00731 }
<a name="l00732"></a>00732 
<a name="l00733"></a><a class="code" href="Fl__x_8cxx.html#a456caef674ade4c87fee95209e06732b">00733</a> <a class="code" href="mac_8H.html#aad9fe48cacd960402308a6a7f9f5e584">Window</a> <a class="code" href="Fl__x_8cxx.html#a456caef674ade4c87fee95209e06732b">fl_dnd_source_window</a>;
<a name="l00734"></a><a class="code" href="Fl__x_8cxx.html#a84797f4bca9441acb919d94f8565a17f">00734</a> Atom *<a class="code" href="Fl__x_8cxx.html#a84797f4bca9441acb919d94f8565a17f">fl_dnd_source_types</a>; <span class="comment">// null-terminated list of data types being supplied</span>
<a name="l00735"></a><a class="code" href="Fl__x_8cxx.html#ad280b2f535c14928791a9a08b2505b89">00735</a> Atom <a class="code" href="Fl__x_8cxx.html#ad280b2f535c14928791a9a08b2505b89">fl_dnd_type</a>;
<a name="l00736"></a><a class="code" href="Fl__x_8cxx.html#aaf7a0a03a00d04a8aeb90399b30f8c5c">00736</a> Atom <a class="code" href="Fl__x_8cxx.html#aaf7a0a03a00d04a8aeb90399b30f8c5c">fl_dnd_source_action</a>;
<a name="l00737"></a><a class="code" href="Fl__x_8cxx.html#a2d3aaa36bdcd388ee1bc837ce2cb3016">00737</a> Atom <a class="code" href="Fl__x_8cxx.html#a2d3aaa36bdcd388ee1bc837ce2cb3016">fl_dnd_action</a>;
<a name="l00738"></a>00738 
<a name="l00739"></a><a class="code" href="Fl__x_8cxx.html#a23b7974a3aae09de7b0ccc2d4dfaf0ac">00739</a> <span class="keywordtype">void</span> <a class="code" href="fl__dnd__x_8cxx.html#a23b7974a3aae09de7b0ccc2d4dfaf0ac">fl_sendClientMessage</a>(<a class="code" href="mac_8H.html#aad9fe48cacd960402308a6a7f9f5e584">Window</a> window, Atom message,
<a name="l00740"></a>00740                                  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> d0,
<a name="l00741"></a>00741                                  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> d1=0,
<a name="l00742"></a>00742                                  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> d2=0,
<a name="l00743"></a>00743                                  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> d3=0,
<a name="l00744"></a>00744                                  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> d4=0)
<a name="l00745"></a>00745 {
<a name="l00746"></a>00746   XEvent e;
<a name="l00747"></a>00747   e.xany.type = ClientMessage;
<a name="l00748"></a>00748   e.xany.window = window;
<a name="l00749"></a>00749   e.xclient.message_type = message;
<a name="l00750"></a>00750   e.xclient.format = 32;
<a name="l00751"></a>00751   e.xclient.data.l[0] = (long)d0;
<a name="l00752"></a>00752   e.xclient.data.l[1] = (long)d1;
<a name="l00753"></a>00753   e.xclient.data.l[2] = (long)d2;
<a name="l00754"></a>00754   e.xclient.data.l[3] = (long)d3;
<a name="l00755"></a>00755   e.xclient.data.l[4] = (long)d4;
<a name="l00756"></a>00756   XSendEvent(fl_display, window, 0, 0, &amp;e);
<a name="l00757"></a>00757 }
<a name="l00758"></a>00758 
<a name="l00760"></a>00760 <span class="comment">// Code for copying to clipboard and DnD out of the program:</span>
<a name="l00761"></a>00761 
<a name="l00762"></a>00762 <span class="keywordtype">void</span> <a class="code" href="group__fl__clipboard.html#gaa219ad0a09d4ff6f7d8feddcc7e96b90">Fl::copy</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *stuff, <span class="keywordtype">int</span> len, <span class="keywordtype">int</span> clipboard) {
<a name="l00763"></a>00763   <span class="keywordflow">if</span> (!stuff || len&lt;0) <span class="keywordflow">return</span>;
<a name="l00764"></a>00764   <span class="keywordflow">if</span> (len+1 &gt; fl_selection_buffer_length[clipboard]) {
<a name="l00765"></a>00765     <span class="keyword">delete</span>[] fl_selection_buffer[clipboard];
<a name="l00766"></a>00766     fl_selection_buffer[clipboard] = <span class="keyword">new</span> <span class="keywordtype">char</span>[len+100];
<a name="l00767"></a>00767     fl_selection_buffer_length[clipboard] = len+100;
<a name="l00768"></a>00768   }
<a name="l00769"></a>00769   memcpy(fl_selection_buffer[clipboard], stuff, len);
<a name="l00770"></a>00770   fl_selection_buffer[clipboard][len] = 0; <span class="comment">// needed for direct paste</span>
<a name="l00771"></a>00771   fl_selection_length[clipboard] = len;
<a name="l00772"></a>00772   fl_i_own_selection[clipboard] = 1;
<a name="l00773"></a>00773   Atom <span class="keyword">property</span> = clipboard ? CLIPBOARD : XA_PRIMARY;
<a name="l00774"></a>00774   XSetSelectionOwner(fl_display, property, fl_message_window, <a class="code" href="x_8H.html#a5112b03f22e38209736b7d21a6d100ab">fl_event_time</a>);
<a name="l00775"></a>00775 }
<a name="l00776"></a>00776 
<a name="l00778"></a>00778 
<a name="l00779"></a><a class="code" href="Fl__x_8cxx.html#a3d6dfb5698be7aea05ede637ba4ddacb">00779</a> <span class="keyword">const</span> XEvent* <a class="code" href="x_8H.html#a5c84596f8b5051b5c3125eb60bb51e0c">fl_xevent</a>; <span class="comment">// the current x event</span>
<a name="l00780"></a><a class="code" href="Fl__x_8cxx.html#a24b7ca526c7d917ebeaa2202cf1306c3">00780</a> <a class="code" href="fl__types_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a> <a class="code" href="x_8H.html#a5112b03f22e38209736b7d21a6d100ab">fl_event_time</a>; <span class="comment">// the last timestamp from an x event</span>
<a name="l00781"></a>00781 
<a name="l00782"></a><a class="code" href="Fl__x_8cxx.html#a0f446f8a60dc49a63934246501120231">00782</a> <span class="keywordtype">char</span> <a class="code" href="Fl__get__key_8cxx.html#a0f446f8a60dc49a63934246501120231">fl_key_vector</a>[32]; <span class="comment">// used by Fl::get_key()</span>
<a name="l00783"></a>00783 
<a name="l00784"></a>00784 <span class="comment">// Record event mouse position and state from an XEvent:</span>
<a name="l00785"></a>00785 
<a name="l00786"></a><a class="code" href="Fl__x_8cxx.html#aa9511a47fd6271333948489a220e3029">00786</a> <span class="keyword">static</span> <span class="keywordtype">int</span> px, <a class="code" href="fl__overlay_8cxx.html#aa9511a47fd6271333948489a220e3029">py</a>;
<a name="l00787"></a>00787 <span class="keyword">static</span> <a class="code" href="fl__types_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a> <a class="code" href="png_8h.html#aece2bf2fecb9ea60f4e6447c1804785a">ptime</a>;
<a name="l00788"></a>00788 
<a name="l00789"></a>00789 <span class="keyword">static</span> <span class="keywordtype">void</span> set_event_xy() {
<a name="l00790"></a>00790 <span class="preprocessor">#  if CONSOLIDATE_MOTION</span>
<a name="l00791"></a>00791 <span class="preprocessor"></span>  send_motion = 0;
<a name="l00792"></a>00792 <span class="preprocessor">#  endif</span>
<a name="l00793"></a>00793 <span class="preprocessor"></span>  <a class="code" href="classFl.html#ac905dc5f6e4b4c919e405932413fce30">Fl::e_x_root</a>  = fl_xevent-&gt;xbutton.x_root;
<a name="l00794"></a>00794   <a class="code" href="classFl.html#a7b57f90db4afa2b1b1e2e163e9bdc1d3">Fl::e_x</a>       = fl_xevent-&gt;xbutton.x;
<a name="l00795"></a>00795   <a class="code" href="classFl.html#af14bafd28cbd839ab2e4526eb4a5c73f">Fl::e_y_root</a>  = fl_xevent-&gt;xbutton.y_root;
<a name="l00796"></a>00796   <a class="code" href="classFl.html#a0c047ee4ea16066dc9e70bc6a4035c20">Fl::e_y</a>       = fl_xevent-&gt;xbutton.y;
<a name="l00797"></a>00797   <a class="code" href="classFl.html#a2d93787aec60cb62a759b36267dd9d06">Fl::e_state</a>   = fl_xevent-&gt;xbutton.state &lt;&lt; 16;
<a name="l00798"></a>00798   fl_event_time = fl_xevent-&gt;xbutton.time;
<a name="l00799"></a>00799 <span class="preprocessor">#  ifdef __sgi</span>
<a name="l00800"></a>00800 <span class="preprocessor"></span>  <span class="comment">// get the meta key off PC keyboards:</span>
<a name="l00801"></a>00801   <span class="keywordflow">if</span> (fl_key_vector[18]&amp;0x18) <a class="code" href="classFl.html#a2d93787aec60cb62a759b36267dd9d06">Fl::e_state</a> |= <a class="code" href="Enumerations_8H.html#a2c50b1b00111f992d5d49f07c9cee22a" title="One of the meta/Windows keys is down.">FL_META</a>;
<a name="l00802"></a>00802 <span class="preprocessor">#  endif</span>
<a name="l00803"></a>00803 <span class="preprocessor"></span>  <span class="comment">// turn off is_click if enough time or mouse movement has passed:</span>
<a name="l00804"></a>00804   <span class="keywordflow">if</span> (abs(<a class="code" href="classFl.html#ac905dc5f6e4b4c919e405932413fce30">Fl::e_x_root</a>-px)+abs(<a class="code" href="classFl.html#af14bafd28cbd839ab2e4526eb4a5c73f">Fl::e_y_root</a>-py) &gt; 3 ||
<a name="l00805"></a>00805       fl_event_time &gt;= ptime+1000)
<a name="l00806"></a>00806     <a class="code" href="classFl.html#ad08a92882f820adac97a6dd98313e9b9">Fl::e_is_click</a> = 0;
<a name="l00807"></a>00807 }
<a name="l00808"></a>00808 
<a name="l00809"></a>00809 <span class="comment">// if this is same event as last &amp;&amp; is_click, increment click count:</span>
<a name="l00810"></a>00810 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> checkdouble() {
<a name="l00811"></a>00811   <span class="keywordflow">if</span> (<a class="code" href="classFl.html#ad08a92882f820adac97a6dd98313e9b9">Fl::e_is_click</a> == <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a>)
<a name="l00812"></a>00812     <a class="code" href="classFl.html#a6f6c6f8bf78bb722178aa19e501ae60e">Fl::e_clicks</a>++;
<a name="l00813"></a>00813   <span class="keywordflow">else</span> {
<a name="l00814"></a>00814     <a class="code" href="classFl.html#a6f6c6f8bf78bb722178aa19e501ae60e">Fl::e_clicks</a> = 0;
<a name="l00815"></a>00815     <a class="code" href="classFl.html#ad08a92882f820adac97a6dd98313e9b9">Fl::e_is_click</a> = <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a>;
<a name="l00816"></a>00816   }
<a name="l00817"></a>00817   px = <a class="code" href="classFl.html#ac905dc5f6e4b4c919e405932413fce30">Fl::e_x_root</a>;
<a name="l00818"></a>00818   py = <a class="code" href="classFl.html#af14bafd28cbd839ab2e4526eb4a5c73f">Fl::e_y_root</a>;
<a name="l00819"></a>00819   ptime = <a class="code" href="x_8H.html#a5112b03f22e38209736b7d21a6d100ab">fl_event_time</a>;
<a name="l00820"></a>00820 }
<a name="l00821"></a>00821 
<a name="l00822"></a>00822 <span class="keyword">static</span> <a class="code" href="classFl__Window.html">Fl_Window</a>* resize_bug_fix;
<a name="l00823"></a>00823 
<a name="l00825"></a>00825 
<a name="l00826"></a>00826 <span class="keyword">static</span> <span class="keywordtype">char</span> unknown[] = <span class="stringliteral">&quot;&lt;unknown&gt;&quot;</span>;
<a name="l00827"></a><a class="code" href="Fl__x_8cxx.html#afa2ade557ce71a9eb622909c169ddd3a">00827</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="Fl__x_8cxx.html#afa2ade557ce71a9eb622909c169ddd3a">unknown_len</a> = 10;
<a name="l00828"></a>00828 
<a name="l00829"></a>00829 <span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> {
<a name="l00830"></a>00830 
<a name="l00831"></a>00831 <span class="keyword">static</span> <span class="keywordtype">int</span> xerror = 0;
<a name="l00832"></a>00832 
<a name="l00833"></a>00833 <span class="keyword">static</span> <span class="keywordtype">int</span> ignoreXEvents(Display *display, XErrorEvent *event) {
<a name="l00834"></a>00834   xerror = 1;
<a name="l00835"></a>00835   <span class="keywordflow">return</span> 0;
<a name="l00836"></a>00836 }
<a name="l00837"></a>00837 
<a name="l00838"></a>00838 <span class="keyword">static</span> XErrorHandler catchXExceptions() {
<a name="l00839"></a>00839   xerror = 0;
<a name="l00840"></a>00840   <span class="keywordflow">return</span> ignoreXEvents;
<a name="l00841"></a>00841 }
<a name="l00842"></a>00842 
<a name="l00843"></a>00843 <span class="keyword">static</span> <span class="keywordtype">int</span> wasXExceptionRaised() {
<a name="l00844"></a>00844   <span class="keywordflow">return</span> xerror;
<a name="l00845"></a>00845 }
<a name="l00846"></a>00846 
<a name="l00847"></a>00847 }
<a name="l00848"></a>00848 
<a name="l00849"></a>00849 
<a name="l00850"></a><a class="code" href="Fl__x_8cxx.html#a3c910c8ee7543f207166ce32b1bb8638">00850</a> <span class="keywordtype">int</span> <a class="code" href="x_8H.html#aaccfba15ffa706de7d40045c1ad1d823">fl_handle</a>(<span class="keyword">const</span> XEvent&amp; thisevent)
<a name="l00851"></a>00851 {
<a name="l00852"></a>00852   XEvent xevent = thisevent;
<a name="l00853"></a>00853   fl_xevent = &amp;thisevent;
<a name="l00854"></a>00854   <a class="code" href="mac_8H.html#aad9fe48cacd960402308a6a7f9f5e584">Window</a> xid = xevent.xany.window;
<a name="l00855"></a>00855   <span class="keyword">static</span> <a class="code" href="mac_8H.html#aad9fe48cacd960402308a6a7f9f5e584">Window</a> xim_win = 0;
<a name="l00856"></a>00856 
<a name="l00857"></a>00857   <span class="keywordflow">if</span> (fl_xim_ic &amp;&amp; xevent.type == DestroyNotify &amp;&amp;
<a name="l00858"></a>00858         xid != xim_win &amp;&amp; !<a class="code" href="win32_8H.html#a4f60f8f2a47f584ee83dd0118a058cfe">fl_find</a>(xid))
<a name="l00859"></a>00859   {
<a name="l00860"></a>00860     XIM <a class="code" href="test_8c.html#aadcc3204aba6003defa885f6497e79f3">xim_im</a>;
<a name="l00861"></a>00861     xim_im = XOpenIM(fl_display, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00862"></a>00862     <span class="keywordflow">if</span> (!xim_im) {
<a name="l00863"></a>00863       <span class="comment">/*  XIM server has crashed */</span>
<a name="l00864"></a>00864       XSetLocaleModifiers(<span class="stringliteral">&quot;@im=&quot;</span>);
<a name="l00865"></a>00865       fl_xim_im = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00866"></a>00866       <a class="code" href="Fl__x_8cxx.html#ab73453ae87277dd8facd2a996055c529">fl_init_xim</a>();
<a name="l00867"></a>00867     } <span class="keywordflow">else</span> {
<a name="l00868"></a>00868       XCloseIM(xim_im); <span class="comment">// see STR 2185 for comment</span>
<a name="l00869"></a>00869     }
<a name="l00870"></a>00870     <span class="keywordflow">return</span> 0;
<a name="l00871"></a>00871   }
<a name="l00872"></a>00872 
<a name="l00873"></a>00873   <span class="keywordflow">if</span> (fl_xim_ic &amp;&amp; (xevent.type == FocusIn))
<a name="l00874"></a>00874   {
<a name="l00875"></a>00875 <span class="preprocessor">#define POOR_XIM</span>
<a name="l00876"></a>00876 <span class="preprocessor"></span><span class="preprocessor">#ifdef POOR_XIM</span>
<a name="l00877"></a>00877 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (xim_win != xid)
<a name="l00878"></a>00878         {
<a name="l00879"></a>00879                 xim_win  = xid;
<a name="l00880"></a>00880                 XDestroyIC(fl_xim_ic);
<a name="l00881"></a>00881                 fl_xim_ic = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00882"></a>00882                 <a class="code" href="Fl__x_8cxx.html#a327d25e1de2d7b0c28c6b71d2212a276">fl_new_ic</a>();
<a name="l00883"></a>00883                 XSetICValues(fl_xim_ic,
<a name="l00884"></a>00884                                 XNFocusWindow, xevent.xclient.window,
<a name="l00885"></a>00885                                 XNClientWindow, xid,
<a name="l00886"></a>00886                                 <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00887"></a>00887         }
<a name="l00888"></a>00888         <a class="code" href="group__fl__drawings.html#ga748fcead12c8cc67cb517cab02c273a2">fl_set_spot</a>(spotf, spots, spot.<a class="code" href="structXRectangle.html#ad8e3fc4eef045bff66cfa7414bf9d961">x</a>, spot.<a class="code" href="structXRectangle.html#a868d20ae8a5b46cc03e1128b0467b1f3">y</a>, spot.<a class="code" href="structXRectangle.html#a9221b0fe551ac4d4a3324b62f3f5e2e1">width</a>, spot.<a class="code" href="structXRectangle.html#a3ad204f8adec7b624292499ca5cdadb5">height</a>);
<a name="l00889"></a>00889 <span class="preprocessor">#else</span>
<a name="l00890"></a>00890 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="group__fl__windows.html#ga3130407bc1c11f9b7f2a9c43a87a1599">Fl::first_window</a>() &amp;&amp; <a class="code" href="group__fl__windows.html#ga3130407bc1c11f9b7f2a9c43a87a1599">Fl::first_window</a>()-&gt;modal()) {
<a name="l00891"></a>00891       <a class="code" href="mac_8H.html#aad9fe48cacd960402308a6a7f9f5e584">Window</a> <a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>  = <a class="code" href="mac_8H.html#a87152d2ed84f9d97c6bf3150c7688261">fl_xid</a>(<a class="code" href="group__fl__windows.html#ga3130407bc1c11f9b7f2a9c43a87a1599">Fl::first_window</a>());
<a name="l00892"></a>00892       <span class="keywordflow">if</span> (x != xim_win) {
<a name="l00893"></a>00893         xim_win  = <a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>;
<a name="l00894"></a>00894         XSetICValues(fl_xim_ic,
<a name="l00895"></a>00895                         XNFocusWindow, xim_win,
<a name="l00896"></a>00896                         XNClientWindow, xim_win,
<a name="l00897"></a>00897                         <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00898"></a>00898         <a class="code" href="group__fl__drawings.html#ga748fcead12c8cc67cb517cab02c273a2">fl_set_spot</a>(spotf, spots, spot.<a class="code" href="structXRectangle.html#ad8e3fc4eef045bff66cfa7414bf9d961">x</a>, spot.<a class="code" href="structXRectangle.html#a868d20ae8a5b46cc03e1128b0467b1f3">y</a>, spot.<a class="code" href="structXRectangle.html#a9221b0fe551ac4d4a3324b62f3f5e2e1">width</a>, spot.<a class="code" href="structXRectangle.html#a3ad204f8adec7b624292499ca5cdadb5">height</a>);
<a name="l00899"></a>00899       }
<a name="l00900"></a>00900     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (xim_win != xid &amp;&amp; xid) {
<a name="l00901"></a>00901       xim_win = xid;
<a name="l00902"></a>00902       XSetICValues(fl_xim_ic,
<a name="l00903"></a>00903                         XNFocusWindow, xevent.xclient.window,
<a name="l00904"></a>00904                         XNClientWindow, xid,
<a name="l00905"></a>00905                         <span class="comment">//XNFocusWindow, xim_win,</span>
<a name="l00906"></a>00906                         <span class="comment">//XNClientWindow, xim_win,</span>
<a name="l00907"></a>00907                         <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00908"></a>00908       <a class="code" href="group__fl__drawings.html#ga748fcead12c8cc67cb517cab02c273a2">fl_set_spot</a>(spotf, spots, spot.<a class="code" href="structXRectangle.html#ad8e3fc4eef045bff66cfa7414bf9d961">x</a>, spot.<a class="code" href="structXRectangle.html#a868d20ae8a5b46cc03e1128b0467b1f3">y</a>, spot.<a class="code" href="structXRectangle.html#a9221b0fe551ac4d4a3324b62f3f5e2e1">width</a>, spot.<a class="code" href="structXRectangle.html#a3ad204f8adec7b624292499ca5cdadb5">height</a>);
<a name="l00909"></a>00909     }
<a name="l00910"></a>00910 <span class="preprocessor">#endif</span>
<a name="l00911"></a>00911 <span class="preprocessor"></span>  }
<a name="l00912"></a>00912 
<a name="l00913"></a>00913   <span class="keywordflow">if</span> ( XFilterEvent((XEvent *)&amp;xevent, 0) )
<a name="l00914"></a>00914       <span class="keywordflow">return</span>(1);
<a name="l00915"></a>00915 
<a name="l00916"></a>00916   <span class="keywordflow">switch</span> (xevent.type) {
<a name="l00917"></a>00917 
<a name="l00918"></a>00918   <span class="keywordflow">case</span> KeymapNotify:
<a name="l00919"></a>00919     memcpy(fl_key_vector, xevent.xkeymap.key_vector, 32);
<a name="l00920"></a>00920     <span class="keywordflow">return</span> 0;
<a name="l00921"></a>00921 
<a name="l00922"></a>00922   <span class="keywordflow">case</span> MappingNotify:
<a name="l00923"></a>00923     XRefreshKeyboardMapping((XMappingEvent*)&amp;xevent.xmapping);
<a name="l00924"></a>00924     <span class="keywordflow">return</span> 0;
<a name="l00925"></a>00925 
<a name="l00926"></a>00926   <span class="keywordflow">case</span> SelectionNotify: {
<a name="l00927"></a>00927     <span class="keywordflow">if</span> (!fl_selection_requestor) <span class="keywordflow">return</span> 0;
<a name="l00928"></a>00928     <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* <a class="code" href="png_8h.html#ae666dd7e2f504034709280abeac7616e">buffer</a> = 0;
<a name="l00929"></a>00929     <span class="keywordflow">if</span> (buffer) {XFree(buffer); buffer = 0;}
<a name="l00930"></a>00930     <span class="keywordtype">long</span> bytesread = 0;
<a name="l00931"></a>00931     <span class="keywordflow">if</span> (fl_xevent-&gt;xselection.property) <span class="keywordflow">for</span> (;;) {
<a name="l00932"></a>00932       <span class="comment">// The Xdnd code pastes 64K chunks together, possibly to avoid</span>
<a name="l00933"></a>00933       <span class="comment">// bugs in X servers, or maybe to avoid an extra round-trip to</span>
<a name="l00934"></a>00934       <span class="comment">// get the property length.  I copy this here:</span>
<a name="l00935"></a>00935       Atom actual; <span class="keywordtype">int</span> format; <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> count, remaining;
<a name="l00936"></a>00936       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* portion;
<a name="l00937"></a>00937       <span class="keywordflow">if</span> (XGetWindowProperty(fl_display,
<a name="l00938"></a>00938                              fl_xevent-&gt;xselection.requestor,
<a name="l00939"></a>00939                              fl_xevent-&gt;xselection.property,
<a name="l00940"></a>00940                              bytesread/4, 65536, 1, 0,
<a name="l00941"></a>00941                              &amp;actual, &amp;format, &amp;count, &amp;remaining,
<a name="l00942"></a>00942                              &amp;portion)) <span class="keywordflow">break</span>; <span class="comment">// quit on error</span>
<a name="l00943"></a>00943       <span class="keywordflow">if</span> (actual == TARGETS || actual == XA_ATOM) {
<a name="l00944"></a>00944         Atom <a class="code" href="png_8h.html#a31c258c425e1346a1cd21ffd48f58ace">type</a> = XA_STRING;
<a name="l00945"></a>00945         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i&lt;count; i++) {
<a name="l00946"></a>00946           Atom t = ((Atom*)portion)[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>];
<a name="l00947"></a>00947             <span class="keywordflow">if</span> (t == fl_Xatextplainutf ||
<a name="l00948"></a>00948                   t == fl_Xatextplain ||
<a name="l00949"></a>00949                   t == fl_XaUtf8String) {type = t; <span class="keywordflow">break</span>;}
<a name="l00950"></a>00950             <span class="comment">// rest are only used if no utf-8 available:</span>
<a name="l00951"></a>00951             <span class="keywordflow">if</span> (t == fl_XaText || 
<a name="l00952"></a>00952                   t == fl_XaTextUriList || 
<a name="l00953"></a>00953                   t == fl_XaCompoundText) type = t;
<a name="l00954"></a>00954         }       
<a name="l00955"></a>00955         XFree(portion);
<a name="l00956"></a>00956         Atom <span class="keyword">property</span> = xevent.xselection.property;
<a name="l00957"></a>00957         XConvertSelection(fl_display, property, type, property,
<a name="l00958"></a>00958               <a class="code" href="mac_8H.html#a87152d2ed84f9d97c6bf3150c7688261">fl_xid</a>(<a class="code" href="group__fl__windows.html#ga3130407bc1c11f9b7f2a9c43a87a1599">Fl::first_window</a>()),
<a name="l00959"></a>00959               fl_event_time);
<a name="l00960"></a>00960         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00961"></a>00961       }
<a name="l00962"></a>00962       XTextProperty text_prop; 
<a name="l00963"></a>00963       text_prop.value=portion;
<a name="l00964"></a>00964       text_prop.format=format;
<a name="l00965"></a>00965       text_prop.encoding=actual;
<a name="l00966"></a>00966       text_prop.nitems=count;
<a name="l00967"></a>00967       <span class="keywordtype">char</span> **text_list;
<a name="l00968"></a>00968       text_list = (<span class="keywordtype">char</span>**)&amp;portion;
<a name="l00969"></a>00969       <span class="keywordtype">int</span> bytesnew = strlen(*text_list)+1; 
<a name="l00970"></a>00970       buffer = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)realloc(buffer, bytesread+bytesnew+remaining);
<a name="l00971"></a>00971       memcpy(buffer+bytesread, *text_list, bytesnew);
<a name="l00972"></a>00972       XFree(portion); 
<a name="l00973"></a>00973       bytesread += bytesnew - 1;
<a name="l00974"></a>00974       <span class="keywordflow">if</span> (!remaining) <span class="keywordflow">break</span>;
<a name="l00975"></a>00975     }
<a name="l00976"></a>00976     <span class="keywordflow">if</span> (buffer) {
<a name="l00977"></a>00977       buffer[bytesread] = 0;
<a name="l00978"></a>00978       convert_crlf(buffer, bytesread);
<a name="l00979"></a>00979     }
<a name="l00980"></a>00980     <a class="code" href="classFl.html#addcd49b68feff0a807f6564f3fdb8016">Fl::e_text</a> = buffer ? (<span class="keywordtype">char</span>*)buffer : (<span class="keywordtype">char</span> *)<span class="stringliteral">&quot;&quot;</span>;
<a name="l00981"></a>00981     <a class="code" href="classFl.html#a336911cf63dade9bbb9707b942785133">Fl::e_length</a> = bytesread;
<a name="l00982"></a>00982     <span class="keywordtype">int</span> old_event = <a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a>;
<a name="l00983"></a>00983     fl_selection_requestor-&gt;<a class="code" href="classFl__Widget.html#a9cb17cc092697dfd05a3fab55856d218">handle</a>(<a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a> = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a5e811b9d703e6f66cfdca256ecfbb0cf">FL_PASTE</a>);
<a name="l00984"></a>00984     <a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a> = old_event;
<a name="l00985"></a>00985     <span class="comment">// Detect if this paste is due to Xdnd by the property name (I use</span>
<a name="l00986"></a>00986     <span class="comment">// XA_SECONDARY for that) and send an XdndFinished message. It is not</span>
<a name="l00987"></a>00987     <span class="comment">// clear if this has to be delayed until now or if it can be done</span>
<a name="l00988"></a>00988     <span class="comment">// immediatly after calling XConvertSelection.</span>
<a name="l00989"></a>00989     <span class="keywordflow">if</span> (fl_xevent-&gt;xselection.property == XA_SECONDARY &amp;&amp;
<a name="l00990"></a>00990         fl_dnd_source_window) {
<a name="l00991"></a>00991       <a class="code" href="fl__dnd__x_8cxx.html#a23b7974a3aae09de7b0ccc2d4dfaf0ac">fl_sendClientMessage</a>(fl_dnd_source_window, fl_XdndFinished,
<a name="l00992"></a>00992                            fl_xevent-&gt;xselection.requestor);
<a name="l00993"></a>00993       fl_dnd_source_window = 0; <span class="comment">// don&#39;t send a second time</span>
<a name="l00994"></a>00994     }
<a name="l00995"></a>00995     <span class="keywordflow">return</span> 1;}
<a name="l00996"></a>00996 
<a name="l00997"></a>00997   <span class="keywordflow">case</span> SelectionClear: {
<a name="l00998"></a>00998     <span class="keywordtype">int</span> clipboard = fl_xevent-&gt;xselectionclear.selection == CLIPBOARD;
<a name="l00999"></a>00999     fl_i_own_selection[clipboard] = 0;
<a name="l01000"></a>01000     <span class="keywordflow">return</span> 1;}
<a name="l01001"></a>01001 
<a name="l01002"></a>01002   <span class="keywordflow">case</span> SelectionRequest: {
<a name="l01003"></a>01003     XSelectionEvent e;
<a name="l01004"></a>01004     e.type = SelectionNotify;
<a name="l01005"></a>01005     e.requestor = fl_xevent-&gt;xselectionrequest.requestor;
<a name="l01006"></a>01006     e.selection = fl_xevent-&gt;xselectionrequest.selection;
<a name="l01007"></a>01007     <span class="keywordtype">int</span> clipboard = e.selection == CLIPBOARD;
<a name="l01008"></a>01008     e.target = fl_xevent-&gt;xselectionrequest.target;
<a name="l01009"></a>01009     e.time = fl_xevent-&gt;xselectionrequest.time;
<a name="l01010"></a>01010     e.property = fl_xevent-&gt;xselectionrequest.property;
<a name="l01011"></a>01011     <span class="keywordflow">if</span> (e.target == TARGETS) {
<a name="l01012"></a>01012       Atom a[3] = {<a class="code" href="fl__dnd__x_8cxx.html#a381bb31bbe348bfd898b080862e16cac">fl_XaUtf8String</a>, XA_STRING, fl_XaText};
<a name="l01013"></a>01013       XChangeProperty(fl_display, e.requestor, e.property,
<a name="l01014"></a>01014                       XA_ATOM, atom_bits, 0, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)a, 3);
<a name="l01015"></a>01015     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="comment">/*e.target == XA_STRING &amp;&amp;*/</span> fl_selection_length[clipboard]) {
<a name="l01016"></a>01016     <span class="keywordflow">if</span> (e.target == fl_XaUtf8String ||
<a name="l01017"></a>01017              e.target == XA_STRING ||
<a name="l01018"></a>01018              e.target == fl_XaCompoundText ||
<a name="l01019"></a>01019              e.target == fl_XaText ||
<a name="l01020"></a>01020              e.target == fl_Xatextplain ||
<a name="l01021"></a>01021              e.target == fl_Xatextplainutf) {
<a name="l01022"></a>01022         <span class="comment">// clobber the target type, this seems to make some applications</span>
<a name="l01023"></a>01023         <span class="comment">// behave that insist on asking for XA_TEXT instead of UTF8_STRING</span>
<a name="l01024"></a>01024         <span class="comment">// Does not change XA_STRING as that breaks xclipboard.</span>
<a name="l01025"></a>01025         <span class="keywordflow">if</span> (e.target != XA_STRING) e.target = <a class="code" href="fl__dnd__x_8cxx.html#a381bb31bbe348bfd898b080862e16cac">fl_XaUtf8String</a>;
<a name="l01026"></a>01026         XChangeProperty(fl_display, e.requestor, e.property,
<a name="l01027"></a>01027                          e.target, 8, 0,
<a name="l01028"></a>01028                          (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)fl_selection_buffer[clipboard],
<a name="l01029"></a>01029                          fl_selection_length[clipboard]);
<a name="l01030"></a>01030       }
<a name="l01031"></a>01031     } <span class="keywordflow">else</span> {
<a name="l01032"></a>01032 <span class="comment">//    char* x = XGetAtomName(fl_display,e.target);</span>
<a name="l01033"></a>01033 <span class="comment">//    fprintf(stderr,&quot;selection request of %s\n&quot;,x);</span>
<a name="l01034"></a>01034 <span class="comment">//    XFree(x);</span>
<a name="l01035"></a>01035       e.property = 0;
<a name="l01036"></a>01036     }
<a name="l01037"></a>01037     XSendEvent(fl_display, e.requestor, 0, 0, (XEvent *)&amp;e);}
<a name="l01038"></a>01038     <span class="keywordflow">return</span> 1;
<a name="l01039"></a>01039 
<a name="l01040"></a>01040   <span class="comment">// events where interesting window id is in a different place:</span>
<a name="l01041"></a>01041   <span class="keywordflow">case</span> CirculateNotify:
<a name="l01042"></a>01042   <span class="keywordflow">case</span> CirculateRequest:
<a name="l01043"></a>01043   <span class="keywordflow">case</span> ConfigureNotify:
<a name="l01044"></a>01044   <span class="keywordflow">case</span> ConfigureRequest:
<a name="l01045"></a>01045   <span class="keywordflow">case</span> CreateNotify:
<a name="l01046"></a>01046   <span class="keywordflow">case</span> DestroyNotify:
<a name="l01047"></a>01047   <span class="keywordflow">case</span> GravityNotify:
<a name="l01048"></a>01048   <span class="keywordflow">case</span> MapNotify:
<a name="l01049"></a>01049   <span class="keywordflow">case</span> MapRequest:
<a name="l01050"></a>01050   <span class="keywordflow">case</span> ReparentNotify:
<a name="l01051"></a>01051   <span class="keywordflow">case</span> UnmapNotify:
<a name="l01052"></a>01052     xid = xevent.xmaprequest.window;
<a name="l01053"></a>01053     <span class="keywordflow">break</span>;
<a name="l01054"></a>01054   }
<a name="l01055"></a>01055 
<a name="l01056"></a>01056   <span class="keywordtype">int</span> <span class="keyword">event</span> = 0;
<a name="l01057"></a>01057   <a class="code" href="classFl__Window.html">Fl_Window</a>* window = <a class="code" href="win32_8H.html#a4f60f8f2a47f584ee83dd0118a058cfe">fl_find</a>(xid);
<a name="l01058"></a>01058 
<a name="l01059"></a>01059   <span class="keywordflow">if</span> (window) <span class="keywordflow">switch</span> (xevent.type) {
<a name="l01060"></a>01060 
<a name="l01061"></a>01061   <span class="keywordflow">case</span> ClientMessage: {
<a name="l01062"></a>01062     Atom message = fl_xevent-&gt;xclient.message_type;
<a name="l01063"></a>01063     <span class="keyword">const</span> <span class="keywordtype">long</span>* <a class="code" href="jpeglib_8h.html#ae5784a8f4db42de0ffacd0cbd08dc6ad">data</a> = fl_xevent-&gt;xclient.data.l;
<a name="l01064"></a>01064     <span class="keywordflow">if</span> ((Atom)(data[0]) == WM_DELETE_WINDOW) {
<a name="l01065"></a>01065       <span class="keyword">event</span> = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a42828f08af2b2191bbc60e113ec08f01">FL_CLOSE</a>;
<a name="l01066"></a>01066     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (message == fl_XdndEnter) {
<a name="l01067"></a>01067       fl_xmousewin = window;
<a name="l01068"></a>01068       in_a_window = <span class="keyword">true</span>;
<a name="l01069"></a>01069       fl_dnd_source_window = data[0];
<a name="l01070"></a>01070       <span class="comment">// version number is data[1]&gt;&gt;24</span>
<a name="l01071"></a>01071 <span class="comment">//      printf(&quot;XdndEnter, version %ld\n&quot;, data[1] &gt;&gt; 24);</span>
<a name="l01072"></a>01072       <span class="keywordflow">if</span> (data[1]&amp;1) {
<a name="l01073"></a>01073         <span class="comment">// get list of data types:</span>
<a name="l01074"></a>01074         Atom actual; <span class="keywordtype">int</span> format; <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> count, remaining;
<a name="l01075"></a>01075         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="png_8h.html#ae666dd7e2f504034709280abeac7616e">buffer</a> = 0;
<a name="l01076"></a>01076         XGetWindowProperty(fl_display, fl_dnd_source_window, fl_XdndTypeList,
<a name="l01077"></a>01077                            0, 0x8000000L, False, XA_ATOM, &amp;actual, &amp;format,
<a name="l01078"></a>01078                            &amp;count, &amp;remaining, &amp;buffer);
<a name="l01079"></a>01079         <span class="keywordflow">if</span> (actual != XA_ATOM || format != 32 || count&lt;4 || !buffer)
<a name="l01080"></a>01080           <span class="keywordflow">goto</span> FAILED;
<a name="l01081"></a>01081         <span class="keyword">delete</span> [] <a class="code" href="Fl__x_8cxx.html#a84797f4bca9441acb919d94f8565a17f">fl_dnd_source_types</a>;
<a name="l01082"></a>01082         fl_dnd_source_types = <span class="keyword">new</span> Atom[count+1];
<a name="l01083"></a>01083         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; count; i++) {
<a name="l01084"></a>01084           fl_dnd_source_types[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>] = ((Atom*)buffer)[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>];
<a name="l01085"></a>01085         }
<a name="l01086"></a>01086         fl_dnd_source_types[count] = 0;
<a name="l01087"></a>01087       } <span class="keywordflow">else</span> {
<a name="l01088"></a>01088       FAILED:
<a name="l01089"></a>01089         <span class="comment">// less than four data types, or if the above messes up:</span>
<a name="l01090"></a>01090         <span class="keywordflow">if</span> (!fl_dnd_source_types) fl_dnd_source_types = <span class="keyword">new</span> Atom[4];
<a name="l01091"></a>01091         fl_dnd_source_types[0] = data[2];
<a name="l01092"></a>01092         fl_dnd_source_types[1] = data[3];
<a name="l01093"></a>01093         fl_dnd_source_types[2] = data[4];
<a name="l01094"></a>01094         fl_dnd_source_types[3] = 0;
<a name="l01095"></a>01095       }
<a name="l01096"></a>01096 
<a name="l01097"></a>01097       <span class="comment">// Loop through the source types and pick the first text type...</span>
<a name="l01098"></a>01098       <span class="keywordtype">int</span> <a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>;
<a name="l01099"></a>01099 
<a name="l01100"></a>01100       <span class="keywordflow">for</span> (i = 0; fl_dnd_source_types[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>]; i ++)
<a name="l01101"></a>01101       {
<a name="l01102"></a>01102 <span class="comment">//        printf(&quot;fl_dnd_source_types[%d] = %ld (%s)\n&quot;, i,</span>
<a name="l01103"></a>01103 <span class="comment">//             fl_dnd_source_types[i],</span>
<a name="l01104"></a>01104 <span class="comment">//             XGetAtomName(fl_display, fl_dnd_source_types[i]));</span>
<a name="l01105"></a>01105 
<a name="l01106"></a>01106         <span class="keywordflow">if</span> (!strncmp(XGetAtomName(fl_display, fl_dnd_source_types[i]),
<a name="l01107"></a>01107                      <span class="stringliteral">&quot;text/&quot;</span>, 5))
<a name="l01108"></a>01108           <span class="keywordflow">break</span>;
<a name="l01109"></a>01109       }
<a name="l01110"></a>01110 
<a name="l01111"></a>01111       <span class="keywordflow">if</span> (fl_dnd_source_types[i])
<a name="l01112"></a>01112         fl_dnd_type = fl_dnd_source_types[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>];
<a name="l01113"></a>01113       <span class="keywordflow">else</span>
<a name="l01114"></a>01114         fl_dnd_type = fl_dnd_source_types[0];
<a name="l01115"></a>01115 
<a name="l01116"></a>01116       <span class="keyword">event</span> = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3af4f28b5ef9ec051e4a4d9e19a16370b8">FL_DND_ENTER</a>;
<a name="l01117"></a>01117       <a class="code" href="classFl.html#addcd49b68feff0a807f6564f3fdb8016">Fl::e_text</a> = unknown;
<a name="l01118"></a>01118       <a class="code" href="classFl.html#a336911cf63dade9bbb9707b942785133">Fl::e_length</a> = <a class="code" href="Fl__x_8cxx.html#afa2ade557ce71a9eb622909c169ddd3a">unknown_len</a>;
<a name="l01119"></a>01119       <span class="keywordflow">break</span>;
<a name="l01120"></a>01120 
<a name="l01121"></a>01121     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (message == fl_XdndPosition) {
<a name="l01122"></a>01122       fl_xmousewin = window;
<a name="l01123"></a>01123       in_a_window = <span class="keyword">true</span>;
<a name="l01124"></a>01124       fl_dnd_source_window = data[0];
<a name="l01125"></a>01125       <a class="code" href="classFl.html#ac905dc5f6e4b4c919e405932413fce30">Fl::e_x_root</a> = data[2]&gt;&gt;16;
<a name="l01126"></a>01126       <a class="code" href="classFl.html#af14bafd28cbd839ab2e4526eb4a5c73f">Fl::e_y_root</a> = data[2]&amp;0xFFFF;
<a name="l01127"></a>01127       <span class="keywordflow">if</span> (window) {
<a name="l01128"></a>01128         <a class="code" href="classFl.html#a7b57f90db4afa2b1b1e2e163e9bdc1d3">Fl::e_x</a> = <a class="code" href="classFl.html#ac905dc5f6e4b4c919e405932413fce30">Fl::e_x_root</a>-window-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>();
<a name="l01129"></a>01129         <a class="code" href="classFl.html#a0c047ee4ea16066dc9e70bc6a4035c20">Fl::e_y</a> = <a class="code" href="classFl.html#af14bafd28cbd839ab2e4526eb4a5c73f">Fl::e_y_root</a>-window-&gt;<a class="code" href="classFl__Widget.html#aec1aded9efdf5f23dfac8cc725cefc4a">y</a>();
<a name="l01130"></a>01130       }
<a name="l01131"></a>01131       fl_event_time = data[3];
<a name="l01132"></a>01132       fl_dnd_source_action = data[4];
<a name="l01133"></a>01133       fl_dnd_action = <a class="code" href="fl__dnd__x_8cxx.html#a6e922382e7697fb2f4b24d98c1cfc24e">fl_XdndActionCopy</a>;
<a name="l01134"></a>01134       <a class="code" href="classFl.html#addcd49b68feff0a807f6564f3fdb8016">Fl::e_text</a> = unknown;
<a name="l01135"></a>01135       <a class="code" href="classFl.html#a336911cf63dade9bbb9707b942785133">Fl::e_length</a> = <a class="code" href="Fl__x_8cxx.html#afa2ade557ce71a9eb622909c169ddd3a">unknown_len</a>;
<a name="l01136"></a>01136       <span class="keywordtype">int</span> accept = <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>(<a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3aadfedcde7415286c752ba427f0e8626f">FL_DND_DRAG</a>, window);
<a name="l01137"></a>01137       <a class="code" href="fl__dnd__x_8cxx.html#a23b7974a3aae09de7b0ccc2d4dfaf0ac">fl_sendClientMessage</a>(data[0], fl_XdndStatus,
<a name="l01138"></a>01138                            fl_xevent-&gt;xclient.window,
<a name="l01139"></a>01139                            accept ? 1 : 0,
<a name="l01140"></a>01140                            0, <span class="comment">// used for xy rectangle to not send position inside</span>
<a name="l01141"></a>01141                            0, <span class="comment">// used for width+height of rectangle</span>
<a name="l01142"></a>01142                            accept ? fl_dnd_action : None);
<a name="l01143"></a>01143       <span class="keywordflow">return</span> 1;
<a name="l01144"></a>01144 
<a name="l01145"></a>01145     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (message == fl_XdndLeave) {
<a name="l01146"></a>01146       fl_dnd_source_window = 0; <span class="comment">// don&#39;t send a finished message to it</span>
<a name="l01147"></a>01147       <span class="keyword">event</span> = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a03bdb8df3578915e1d0829cc048d855e">FL_DND_LEAVE</a>;
<a name="l01148"></a>01148       <a class="code" href="classFl.html#addcd49b68feff0a807f6564f3fdb8016">Fl::e_text</a> = unknown;
<a name="l01149"></a>01149       <a class="code" href="classFl.html#a336911cf63dade9bbb9707b942785133">Fl::e_length</a> = <a class="code" href="Fl__x_8cxx.html#afa2ade557ce71a9eb622909c169ddd3a">unknown_len</a>;
<a name="l01150"></a>01150       <span class="keywordflow">break</span>;
<a name="l01151"></a>01151 
<a name="l01152"></a>01152     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (message == fl_XdndDrop) {
<a name="l01153"></a>01153       fl_xmousewin = window;
<a name="l01154"></a>01154       in_a_window = <span class="keyword">true</span>;
<a name="l01155"></a>01155       fl_dnd_source_window = data[0];
<a name="l01156"></a>01156       fl_event_time = data[2];
<a name="l01157"></a>01157       <a class="code" href="mac_8H.html#aad9fe48cacd960402308a6a7f9f5e584">Window</a> to_window = fl_xevent-&gt;xclient.<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>;
<a name="l01158"></a>01158       <a class="code" href="classFl.html#addcd49b68feff0a807f6564f3fdb8016">Fl::e_text</a> = unknown;
<a name="l01159"></a>01159       <a class="code" href="classFl.html#a336911cf63dade9bbb9707b942785133">Fl::e_length</a> = <a class="code" href="Fl__x_8cxx.html#afa2ade557ce71a9eb622909c169ddd3a">unknown_len</a>;
<a name="l01160"></a>01160       <span class="keywordflow">if</span> (<a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>(<a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a80deb55dbc048b83dc154c11c658b7d6">FL_DND_RELEASE</a>, window)) {
<a name="l01161"></a>01161         fl_selection_requestor = <a class="code" href="group__fl__events.html#ga5b55ce634002a2743c24c4c4db7cbdd4">Fl::belowmouse</a>();
<a name="l01162"></a>01162         XConvertSelection(fl_display, fl_XdndSelection,
<a name="l01163"></a>01163                           fl_dnd_type, XA_SECONDARY,
<a name="l01164"></a>01164                           to_window, fl_event_time);
<a name="l01165"></a>01165       } <span class="keywordflow">else</span> {
<a name="l01166"></a>01166         <span class="comment">// Send the finished message if I refuse the drop.</span>
<a name="l01167"></a>01167         <span class="comment">// It is not clear whether I can just send finished always,</span>
<a name="l01168"></a>01168         <span class="comment">// or if I have to wait for the SelectionNotify event as the</span>
<a name="l01169"></a>01169         <span class="comment">// code is currently doing.</span>
<a name="l01170"></a>01170         <a class="code" href="fl__dnd__x_8cxx.html#a23b7974a3aae09de7b0ccc2d4dfaf0ac">fl_sendClientMessage</a>(fl_dnd_source_window, fl_XdndFinished, to_window);
<a name="l01171"></a>01171         fl_dnd_source_window = 0;
<a name="l01172"></a>01172       }
<a name="l01173"></a>01173       <span class="keywordflow">return</span> 1;
<a name="l01174"></a>01174 
<a name="l01175"></a>01175     }
<a name="l01176"></a>01176     <span class="keywordflow">break</span>;}
<a name="l01177"></a>01177 
<a name="l01178"></a>01178   <span class="keywordflow">case</span> UnmapNotify:
<a name="l01179"></a>01179     <span class="keyword">event</span> = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3aed9d7c8fbb9dac1e16f762195f00d5d6">FL_HIDE</a>;
<a name="l01180"></a>01180     <span class="keywordflow">break</span>;
<a name="l01181"></a>01181 
<a name="l01182"></a>01182   <span class="keywordflow">case</span> Expose:
<a name="l01183"></a>01183     <a class="code" href="classFl__X.html#ae4c6997d92cf8ad3a75a962d7ae77c34">Fl_X::i</a>(window)-&gt;<a class="code" href="classFl__X.html#a5bff94b4bde0ceafbaaaaaa3b7d1426e">wait_for_expose</a> = 0;
<a name="l01184"></a>01184 <span class="preprocessor">#  if 0</span>
<a name="l01185"></a>01185 <span class="preprocessor"></span>    <span class="comment">// try to keep windows on top even if WM_TRANSIENT_FOR does not work:</span>
<a name="l01186"></a>01186     <span class="comment">// opaque move/resize window managers do not like this, so I disabled it.</span>
<a name="l01187"></a>01187     <span class="keywordflow">if</span> (<a class="code" href="group__fl__windows.html#ga3130407bc1c11f9b7f2a9c43a87a1599">Fl::first_window</a>()-&gt;non_modal() &amp;&amp; window != <a class="code" href="group__fl__windows.html#ga3130407bc1c11f9b7f2a9c43a87a1599">Fl::first_window</a>())
<a name="l01188"></a>01188       <a class="code" href="group__fl__windows.html#ga3130407bc1c11f9b7f2a9c43a87a1599">Fl::first_window</a>()-&gt;<a class="code" href="classFl__Window.html#afc4d3796226dfd4620b4d7cf29c287c9">show</a>();
<a name="l01189"></a>01189 <span class="preprocessor">#  endif</span>
<a name="l01190"></a>01190 <span class="preprocessor"></span>
<a name="l01191"></a>01191   <span class="keywordflow">case</span> GraphicsExpose:
<a name="l01192"></a>01192     window-&gt;<a class="code" href="classFl__Widget.html#a24aaceb4034489133926f53eb57aad23">damage</a>(<a class="code" href="Enumerations_8H.html#a9a20351f841109b3d861e0c1248d146da1d579fbc483892ba72a416d3ff14a942">FL_DAMAGE_EXPOSE</a>, xevent.xexpose.x, xevent.xexpose.y,
<a name="l01193"></a>01193                    xevent.xexpose.width, xevent.xexpose.height);
<a name="l01194"></a>01194     <span class="keywordflow">return</span> 1;
<a name="l01195"></a>01195 
<a name="l01196"></a>01196   <span class="keywordflow">case</span> FocusIn:
<a name="l01197"></a>01197     <span class="keywordflow">if</span> (fl_xim_ic) XSetICFocus(fl_xim_ic);
<a name="l01198"></a>01198     <span class="keyword">event</span> = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3adaac2a187beb309443d668a20a59986b">FL_FOCUS</a>;
<a name="l01199"></a>01199     <span class="keywordflow">break</span>;
<a name="l01200"></a>01200 
<a name="l01201"></a>01201   <span class="keywordflow">case</span> FocusOut:
<a name="l01202"></a>01202     <span class="keywordflow">if</span> (fl_xim_ic) XUnsetICFocus(fl_xim_ic);
<a name="l01203"></a>01203     <span class="keyword">event</span> = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a7d2e5eb9247b1927ba5cc26dc82acaf3">FL_UNFOCUS</a>;
<a name="l01204"></a>01204     <span class="keywordflow">break</span>;
<a name="l01205"></a>01205 
<a name="l01206"></a>01206   <span class="keywordflow">case</span> KeyPress:
<a name="l01207"></a>01207   <span class="keywordflow">case</span> KeyRelease: {
<a name="l01208"></a>01208   KEYPRESS:
<a name="l01209"></a>01209     <span class="keywordtype">int</span> keycode = xevent.xkey.keycode;
<a name="l01210"></a>01210     fl_key_vector[keycode/8] |= (1 &lt;&lt; (keycode%8));
<a name="l01211"></a>01211     <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="png_8h.html#ae666dd7e2f504034709280abeac7616e">buffer</a> = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01212"></a>01212     <span class="keyword">static</span> <span class="keywordtype">int</span> buffer_len = 0;
<a name="l01213"></a>01213     <span class="keywordtype">int</span> len;
<a name="l01214"></a>01214     KeySym keysym;
<a name="l01215"></a>01215     <span class="keywordflow">if</span> (buffer_len == 0) {
<a name="l01216"></a>01216       buffer_len = 4096;
<a name="l01217"></a>01217       buffer = (<span class="keywordtype">char</span>*) malloc(buffer_len);
<a name="l01218"></a>01218     }
<a name="l01219"></a>01219     <span class="keywordflow">if</span> (xevent.type == KeyPress) {
<a name="l01220"></a>01220       <span class="keyword">event</span> = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a1d132318f4c72305fd1babbbc4dbeb1a">FL_KEYDOWN</a>;
<a name="l01221"></a>01221       <span class="keywordtype">int</span> len = 0;
<a name="l01222"></a>01222 
<a name="l01223"></a>01223       <span class="keywordflow">if</span> (fl_xim_ic) {
<a name="l01224"></a>01224         Status status;
<a name="l01225"></a>01225         len = <a class="code" href="Xutf8_8h.html#ae9ee971dfa1a30fa6d01ce68ebb13e74">XUtf8LookupString</a>(fl_xim_ic, (XKeyPressedEvent *)&amp;xevent.xkey,
<a name="l01226"></a>01226                              buffer, buffer_len, &amp;keysym, &amp;status);
<a name="l01227"></a>01227 
<a name="l01228"></a>01228         <span class="keywordflow">while</span> (status == XBufferOverflow &amp;&amp; buffer_len &lt; 50000) {
<a name="l01229"></a>01229           buffer_len = buffer_len * 5 + 1;
<a name="l01230"></a>01230           buffer = (<span class="keywordtype">char</span>*)realloc(buffer, buffer_len);
<a name="l01231"></a>01231           len = <a class="code" href="Xutf8_8h.html#ae9ee971dfa1a30fa6d01ce68ebb13e74">XUtf8LookupString</a>(fl_xim_ic, (XKeyPressedEvent *)&amp;xevent.xkey,
<a name="l01232"></a>01232                              buffer, buffer_len, &amp;keysym, &amp;status);
<a name="l01233"></a>01233         }
<a name="l01234"></a>01234         keysym = XKeycodeToKeysym(fl_display, keycode, 0);
<a name="l01235"></a>01235       } <span class="keywordflow">else</span> {
<a name="l01236"></a>01236         <span class="comment">//static XComposeStatus compose;</span>
<a name="l01237"></a>01237         len = XLookupString((XKeyEvent*)&amp;(xevent.xkey),
<a name="l01238"></a>01238                              buffer, buffer_len, &amp;keysym, 0<span class="comment">/*&amp;compose*/</span>);
<a name="l01239"></a>01239         <span class="keywordflow">if</span> (keysym &amp;&amp; keysym &lt; 0x400) { <span class="comment">// a character in latin-1,2,3,4 sets</span>
<a name="l01240"></a>01240           <span class="comment">// force it to type a character (not sure if this ever is needed):</span>
<a name="l01241"></a>01241           <span class="comment">// if (!len) {buffer[0] = char(keysym); len = 1;}</span>
<a name="l01242"></a>01242           len = <a class="code" href="group__fl__unicode.html#gae608a28bc43f10014343483ed3d5e99c">fl_utf8encode</a>(<a class="code" href="Xutf8_8h.html#a5b57c25b962bc3e98e4c03f75bb34e36">XKeysymToUcs</a>(keysym), buffer);
<a name="l01243"></a>01243           <span class="keywordflow">if</span> (len &lt; 1) len = 1;
<a name="l01244"></a>01244           <span class="comment">// ignore all effects of shift on the keysyms, which makes it a lot</span>
<a name="l01245"></a>01245           <span class="comment">// easier to program shortcuts and is Windoze-compatable:</span>
<a name="l01246"></a>01246           keysym = XKeycodeToKeysym(fl_display, keycode, 0);
<a name="l01247"></a>01247         }
<a name="l01248"></a>01248       }
<a name="l01249"></a>01249       <span class="comment">// MRS: Can&#39;t use Fl::event_state(FL_CTRL) since the state is not</span>
<a name="l01250"></a>01250       <span class="comment">//      set until set_event_xy() is called later...</span>
<a name="l01251"></a>01251       <span class="keywordflow">if</span> ((xevent.xkey.state &amp; ControlMask) &amp;&amp; keysym == <span class="charliteral">&#39;-&#39;</span>) buffer[0] = 0x1f; <span class="comment">// ^_</span>
<a name="l01252"></a>01252       buffer[len] = 0;
<a name="l01253"></a>01253       <a class="code" href="classFl.html#addcd49b68feff0a807f6564f3fdb8016">Fl::e_text</a> = buffer;
<a name="l01254"></a>01254       <a class="code" href="classFl.html#a336911cf63dade9bbb9707b942785133">Fl::e_length</a> = len;
<a name="l01255"></a>01255     } <span class="keywordflow">else</span> {
<a name="l01256"></a>01256       <span class="comment">// Stupid X sends fake key-up events when a repeating key is held</span>
<a name="l01257"></a>01257       <span class="comment">// down, probably due to some back compatibility problem. Fortunately</span>
<a name="l01258"></a>01258       <span class="comment">// we can detect this because the repeating KeyPress event is in</span>
<a name="l01259"></a>01259       <span class="comment">// the queue, get it and execute it instead:</span>
<a name="l01260"></a>01260       
<a name="l01261"></a>01261       <span class="comment">// Bool XkbSetDetectableAutorepeat ( display, detectable, supported_rtrn )</span>
<a name="l01262"></a>01262       <span class="comment">// Display * display ;</span>
<a name="l01263"></a>01263       <span class="comment">// Bool detectable ;</span>
<a name="l01264"></a>01264       <span class="comment">// Bool * supported_rtrn ;</span>
<a name="l01265"></a>01265       <span class="comment">// ...would be the easy way to corrct this isuue. Unfortunatly, this call is also </span>
<a name="l01266"></a>01266       <span class="comment">// broken on many Unix distros including Ubuntu and Solaris (as of Dec 2009)</span>
<a name="l01267"></a>01267 
<a name="l01268"></a>01268       <span class="comment">// Bogus KeyUp events are generated by repeated KeyDown events. One </span>
<a name="l01269"></a>01269       <span class="comment">// neccessary condition is an identical key event pending right after</span>
<a name="l01270"></a>01270       <span class="comment">// the bogus KeyUp.</span>
<a name="l01271"></a>01271       <span class="comment">// The new code introduced Dec 2009 differs in that it only check the very</span>
<a name="l01272"></a>01272       <span class="comment">// next event in the queue, not the entire queue of events.</span>
<a name="l01273"></a>01273       <span class="comment">// This function wrongly detects a repeat key if a software keyboard</span>
<a name="l01274"></a>01274       <span class="comment">// sends a burst of events containing two consecutive equal keys. However, </span>
<a name="l01275"></a>01275       <span class="comment">// in every non-gaming situation, this is no problem because both KeyPress</span>
<a name="l01276"></a>01276       <span class="comment">// events will cause the expected behavior.</span>
<a name="l01277"></a>01277       XEvent peekevent;
<a name="l01278"></a>01278       <span class="keywordflow">if</span> (XPending(fl_display)) {
<a name="l01279"></a>01279         XPeekEvent(fl_display, &amp;peekevent);
<a name="l01280"></a>01280         <span class="keywordflow">if</span> (   (peekevent.type == KeyPress) <span class="comment">// must be a KeyPress event</span>
<a name="l01281"></a>01281             &amp;&amp; (peekevent.xkey.keycode == xevent.xkey.keycode) <span class="comment">// must be the same key</span>
<a name="l01282"></a>01282             &amp;&amp; (peekevent.xkey.time == xevent.xkey.time) <span class="comment">// must be sent at the exact same time</span>
<a name="l01283"></a>01283             ) {
<a name="l01284"></a>01284           XNextEvent(fl_display, &amp;xevent);
<a name="l01285"></a>01285           <span class="keywordflow">goto</span> KEYPRESS;
<a name="l01286"></a>01286         }
<a name="l01287"></a>01287       }
<a name="l01288"></a>01288       
<a name="l01289"></a>01289       <span class="keyword">event</span> = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3ab0e1a75a36767b878915e59e5f9e3be8">FL_KEYUP</a>;
<a name="l01290"></a>01290       fl_key_vector[keycode/8] &amp;= ~(1 &lt;&lt; (keycode%8));
<a name="l01291"></a>01291       <span class="comment">// keyup events just get the unshifted keysym:</span>
<a name="l01292"></a>01292       keysym = XKeycodeToKeysym(fl_display, keycode, 0);
<a name="l01293"></a>01293     }
<a name="l01294"></a>01294 <span class="preprocessor">#  ifdef __sgi</span>
<a name="l01295"></a>01295 <span class="preprocessor"></span>    <span class="comment">// You can plug a microsoft keyboard into an sgi but the extra shift</span>
<a name="l01296"></a>01296     <span class="comment">// keys are not translated.  Make them translate like XFree86 does:</span>
<a name="l01297"></a>01297     <span class="keywordflow">if</span> (!keysym) <span class="keywordflow">switch</span>(keycode) {
<a name="l01298"></a>01298     <span class="keywordflow">case</span> 147: keysym = <a class="code" href="Enumerations_8H.html#acbd392478a5e61f341fe44e24890e213" title="The left meta/Windows key.">FL_Meta_L</a>; <span class="keywordflow">break</span>;
<a name="l01299"></a>01299     <span class="keywordflow">case</span> 148: keysym = <a class="code" href="Enumerations_8H.html#aa21f26e0bc5b3737cf8c0a1b89a200be" title="The right meta/Windows key.">FL_Meta_R</a>; <span class="keywordflow">break</span>;
<a name="l01300"></a>01300     <span class="keywordflow">case</span> 149: keysym = <a class="code" href="Enumerations_8H.html#a3a59855ebd5a902cda138956b5ac80bb" title="The menu key.">FL_Menu</a>; <span class="keywordflow">break</span>;
<a name="l01301"></a>01301     }
<a name="l01302"></a>01302 <span class="preprocessor">#  endif</span>
<a name="l01303"></a>01303 <span class="preprocessor"></span><span class="preprocessor">#  if BACKSPACE_HACK</span>
<a name="l01304"></a>01304 <span class="preprocessor"></span>    <span class="comment">// Attempt to fix keyboards that send &quot;delete&quot; for the key in the</span>
<a name="l01305"></a>01305     <span class="comment">// upper-right corner of the main keyboard.  But it appears that</span>
<a name="l01306"></a>01306     <span class="comment">// very few of these remain?</span>
<a name="l01307"></a>01307     <span class="keyword">static</span> <span class="keywordtype">int</span> got_backspace = 0;
<a name="l01308"></a>01308     <span class="keywordflow">if</span> (!got_backspace) {
<a name="l01309"></a>01309       <span class="keywordflow">if</span> (keysym == <a class="code" href="Enumerations_8H.html#a323fcf5bab321ec05826a6510a0f1d5a" title="The delete key.">FL_Delete</a>) keysym = <a class="code" href="Enumerations_8H.html#a20dc86e7758a88b4d1f06323e2de9896" title="The backspace key.">FL_BackSpace</a>;
<a name="l01310"></a>01310       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (keysym == <a class="code" href="Enumerations_8H.html#a20dc86e7758a88b4d1f06323e2de9896" title="The backspace key.">FL_BackSpace</a>) got_backspace = 1;
<a name="l01311"></a>01311     }
<a name="l01312"></a>01312 <span class="preprocessor">#  endif</span>
<a name="l01313"></a>01313 <span class="preprocessor"></span>    <span class="comment">// We have to get rid of the XK_KP_function keys, because they are</span>
<a name="l01314"></a>01314     <span class="comment">// not produced on Windoze and thus case statements tend not to check</span>
<a name="l01315"></a>01315     <span class="comment">// for them.  There are 15 of these in the range 0xff91 ... 0xff9f</span>
<a name="l01316"></a>01316     <span class="keywordflow">if</span> (keysym &gt;= 0xff91 &amp;&amp; keysym &lt;= 0xff9f) {
<a name="l01317"></a>01317       <span class="comment">// Map keypad keysym to character or keysym depending on</span>
<a name="l01318"></a>01318       <span class="comment">// numlock state...</span>
<a name="l01319"></a>01319       <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> keysym1 = XKeycodeToKeysym(fl_display, keycode, 1);
<a name="l01320"></a>01320       <span class="keywordflow">if</span> (keysym1 &lt;= 0x7f || (keysym1 &gt; 0xff9f &amp;&amp; keysym1 &lt;= <a class="code" href="Enumerations_8H.html#a14fb705c31fdb8357ae4f3718e20a018" title="The last keypad key; use to range-check keypad.">FL_KP_Last</a>))
<a name="l01321"></a>01321         <a class="code" href="classFl.html#a2bf425ec2398cff4531b2b8c879fc14e">Fl::e_original_keysym</a> = (<a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>)(keysym1 | <a class="code" href="Enumerations_8H.html#a61cc4275772d96a740bef9261cca5760" title="One of the keypad numbers; use FL_KP + n for number n.">FL_KP</a>);
<a name="l01322"></a>01322       <span class="keywordflow">if</span> ((xevent.xkey.state &amp; Mod2Mask) &amp;&amp;
<a name="l01323"></a>01323           (keysym1 &lt;= 0x7f || (keysym1 &gt; 0xff9f &amp;&amp; keysym1 &lt;= <a class="code" href="Enumerations_8H.html#a14fb705c31fdb8357ae4f3718e20a018" title="The last keypad key; use to range-check keypad.">FL_KP_Last</a>))) {
<a name="l01324"></a>01324         <span class="comment">// Store ASCII numeric keypad value...</span>
<a name="l01325"></a>01325         keysym = keysym1 | <a class="code" href="Enumerations_8H.html#a61cc4275772d96a740bef9261cca5760" title="One of the keypad numbers; use FL_KP + n for number n.">FL_KP</a>;
<a name="l01326"></a>01326         buffer[0] = char(keysym1) &amp; 0x7F;
<a name="l01327"></a>01327         len = 1;
<a name="l01328"></a>01328       } <span class="keywordflow">else</span> {
<a name="l01329"></a>01329         <span class="comment">// Map keypad to special key...</span>
<a name="l01330"></a>01330         <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> table[15] = {
<a name="l01331"></a>01331           <a class="code" href="Enumerations_8H.html#ae793aa65307884c2ad99893508d844f2" title="One of the function keys; use FL_F + n for function key n.">FL_F</a>+1, <a class="code" href="Enumerations_8H.html#ae793aa65307884c2ad99893508d844f2" title="One of the function keys; use FL_F + n for function key n.">FL_F</a>+2, FL_F+3, FL_F+4,
<a name="l01332"></a>01332           <a class="code" href="Enumerations_8H.html#a6fecadc9ecc21f06822c79ced2e45932" title="The home key.">FL_Home</a>, <a class="code" href="Enumerations_8H.html#afe89caa1c5019809095a6129156f7c5a" title="The left arrow key.">FL_Left</a>, <a class="code" href="Enumerations_8H.html#a050700391ba0940ca16b0e5dbf4644f0" title="The up arrow key.">FL_Up</a>, <a class="code" href="Enumerations_8H.html#a45679ed656e6b248319719719e894f13" title="The right arrow key.">FL_Right</a>,
<a name="l01333"></a>01333           <a class="code" href="Enumerations_8H.html#a7b70dabd5fc84d90552442584a0e8b91" title="The down arrow key.">FL_Down</a>, <a class="code" href="Enumerations_8H.html#a35834a5c204afffb06374e25734b5c76" title="The page-up key.">FL_Page_Up</a>, <a class="code" href="Enumerations_8H.html#ada4d587d21ab710f44043dafba88e110" title="The page-down key.">FL_Page_Down</a>, <a class="code" href="Enumerations_8H.html#a3278d6209799b821e07369aa5dc140ac" title="The end key.">FL_End</a>,
<a name="l01334"></a>01334           0xff0b<span class="comment">/*XK_Clear*/</span>, <a class="code" href="Enumerations_8H.html#ae18bfb47b2b5d5579d227d522a3ce32c" title="The insert key.">FL_Insert</a>, <a class="code" href="Enumerations_8H.html#a323fcf5bab321ec05826a6510a0f1d5a" title="The delete key.">FL_Delete</a>};
<a name="l01335"></a>01335         keysym = table[keysym-0xff91];
<a name="l01336"></a>01336       }
<a name="l01337"></a>01337     } <span class="keywordflow">else</span> {
<a name="l01338"></a>01338       <span class="comment">// Store this so we can later know if the KP was used</span>
<a name="l01339"></a>01339       <a class="code" href="classFl.html#a2bf425ec2398cff4531b2b8c879fc14e">Fl::e_original_keysym</a> = (<a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>)keysym;
<a name="l01340"></a>01340     }
<a name="l01341"></a>01341     <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> = <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>(keysym);
<a name="l01342"></a>01342   
<a name="l01343"></a>01343     <span class="comment">// replace XK_ISO_Left_Tab (Shift-TAB) with FL_Tab (modifier flags are set correctly by X11)</span>
<a name="l01344"></a>01344     <span class="keywordflow">if</span> (<a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> == 0xfe20) <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> = <a class="code" href="Enumerations_8H.html#aa6e3e7f377cecb30c77f112ce54c3753" title="The tab key.">FL_Tab</a>;
<a name="l01345"></a>01345     
<a name="l01346"></a>01346     set_event_xy();
<a name="l01347"></a>01347     <a class="code" href="classFl.html#ad08a92882f820adac97a6dd98313e9b9">Fl::e_is_click</a> = 0;
<a name="l01348"></a>01348     <span class="keywordflow">break</span>;}
<a name="l01349"></a>01349 
<a name="l01350"></a>01350   <span class="keywordflow">case</span> ButtonPress:
<a name="l01351"></a>01351     <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> = <a class="code" href="Enumerations_8H.html#a1df1e46a5113628156ed7b7f995217d0" title="A mouse button; use Fl_Button + n for mouse button n.">FL_Button</a> + xevent.xbutton.button;
<a name="l01352"></a>01352     set_event_xy();
<a name="l01353"></a>01353     <span class="keywordflow">if</span> (xevent.xbutton.button == Button4) {
<a name="l01354"></a>01354       <a class="code" href="classFl.html#a1ed9dbb954ea9d4d5eaae06ad0778708">Fl::e_dy</a> = -1; <span class="comment">// Up</span>
<a name="l01355"></a>01355       <span class="keyword">event</span> = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3ad5f7dd40377c51d5795cd53ded3d4bef">FL_MOUSEWHEEL</a>;
<a name="l01356"></a>01356     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (xevent.xbutton.button == Button5) {
<a name="l01357"></a>01357       <a class="code" href="classFl.html#a1ed9dbb954ea9d4d5eaae06ad0778708">Fl::e_dy</a> = +1; <span class="comment">// Down</span>
<a name="l01358"></a>01358       <span class="keyword">event</span> = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3ad5f7dd40377c51d5795cd53ded3d4bef">FL_MOUSEWHEEL</a>;
<a name="l01359"></a>01359     } <span class="keywordflow">else</span> {
<a name="l01360"></a>01360       <a class="code" href="classFl.html#a2d93787aec60cb62a759b36267dd9d06">Fl::e_state</a> |= (<a class="code" href="Enumerations_8H.html#afe37a4db5e516754bb8963cd341bf415" title="Mouse button 1 is pushed.">FL_BUTTON1</a> &lt;&lt; (xevent.xbutton.button-1));
<a name="l01361"></a>01361       <span class="keyword">event</span> = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a44972d76423f3e380ae12c36827944e3">FL_PUSH</a>;
<a name="l01362"></a>01362       checkdouble();
<a name="l01363"></a>01363     }
<a name="l01364"></a>01364 
<a name="l01365"></a>01365     fl_xmousewin = window;
<a name="l01366"></a>01366     in_a_window = <span class="keyword">true</span>;
<a name="l01367"></a>01367     <span class="keywordflow">break</span>;
<a name="l01368"></a>01368 
<a name="l01369"></a>01369   <span class="keywordflow">case</span> MotionNotify:
<a name="l01370"></a>01370     set_event_xy();
<a name="l01371"></a>01371 <span class="preprocessor">#  if CONSOLIDATE_MOTION</span>
<a name="l01372"></a>01372 <span class="preprocessor"></span>    send_motion = fl_xmousewin = window;
<a name="l01373"></a>01373     in_a_window = <span class="keyword">true</span>;
<a name="l01374"></a>01374     <span class="keywordflow">return</span> 0;
<a name="l01375"></a>01375 <span class="preprocessor">#  else</span>
<a name="l01376"></a>01376 <span class="preprocessor"></span>    <span class="keyword">event</span> = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3acd57cae091eb27c9a52c446bdd0c164d">FL_MOVE</a>;
<a name="l01377"></a>01377     fl_xmousewin = window;
<a name="l01378"></a>01378     in_a_window = <span class="keyword">true</span>;
<a name="l01379"></a>01379     <span class="keywordflow">break</span>;
<a name="l01380"></a>01380 <span class="preprocessor">#  endif</span>
<a name="l01381"></a>01381 <span class="preprocessor"></span>
<a name="l01382"></a>01382   <span class="keywordflow">case</span> ButtonRelease:
<a name="l01383"></a>01383     <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> = <a class="code" href="Enumerations_8H.html#a1df1e46a5113628156ed7b7f995217d0" title="A mouse button; use Fl_Button + n for mouse button n.">FL_Button</a> + xevent.xbutton.button;
<a name="l01384"></a>01384     set_event_xy();
<a name="l01385"></a>01385     <a class="code" href="classFl.html#a2d93787aec60cb62a759b36267dd9d06">Fl::e_state</a> &amp;= ~(<a class="code" href="Enumerations_8H.html#afe37a4db5e516754bb8963cd341bf415" title="Mouse button 1 is pushed.">FL_BUTTON1</a> &lt;&lt; (xevent.xbutton.button-1));
<a name="l01386"></a>01386     <span class="keywordflow">if</span> (xevent.xbutton.button == Button4 ||
<a name="l01387"></a>01387         xevent.xbutton.button == Button5) <span class="keywordflow">return</span> 0;
<a name="l01388"></a>01388     <span class="keyword">event</span> = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a5949b5ff170a8236d2745eddb1e9fd9a">FL_RELEASE</a>;
<a name="l01389"></a>01389 
<a name="l01390"></a>01390     fl_xmousewin = window;
<a name="l01391"></a>01391     in_a_window = <span class="keyword">true</span>;
<a name="l01392"></a>01392     <span class="keywordflow">break</span>;
<a name="l01393"></a>01393 
<a name="l01394"></a>01394   <span class="keywordflow">case</span> EnterNotify:
<a name="l01395"></a>01395     <span class="keywordflow">if</span> (xevent.xcrossing.detail == NotifyInferior) <span class="keywordflow">break</span>;
<a name="l01396"></a>01396     <span class="comment">// XInstallColormap(fl_display, Fl_X::i(window)-&gt;colormap);</span>
<a name="l01397"></a>01397     set_event_xy();
<a name="l01398"></a>01398     <a class="code" href="classFl.html#a2d93787aec60cb62a759b36267dd9d06">Fl::e_state</a> = xevent.xcrossing.state &lt;&lt; 16;
<a name="l01399"></a>01399     <span class="keyword">event</span> = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a29b256ac93d443dd33a8c610c24e7af5">FL_ENTER</a>;
<a name="l01400"></a>01400 
<a name="l01401"></a>01401     fl_xmousewin = window;
<a name="l01402"></a>01402     in_a_window = <span class="keyword">true</span>;
<a name="l01403"></a>01403     { XIMStyles *xim_styles = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01404"></a>01404       <span class="keywordflow">if</span>(!fl_xim_im || XGetIMValues(fl_xim_im, XNQueryInputStyle, &amp;xim_styles, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l01405"></a>01405         <a class="code" href="Fl__x_8cxx.html#ab73453ae87277dd8facd2a996055c529">fl_init_xim</a>();
<a name="l01406"></a>01406       }
<a name="l01407"></a>01407       <span class="keywordflow">if</span> (xim_styles) XFree(xim_styles);
<a name="l01408"></a>01408     }
<a name="l01409"></a>01409     <span class="keywordflow">break</span>;
<a name="l01410"></a>01410 
<a name="l01411"></a>01411   <span class="keywordflow">case</span> LeaveNotify:
<a name="l01412"></a>01412     <span class="keywordflow">if</span> (xevent.xcrossing.detail == NotifyInferior) <span class="keywordflow">break</span>;
<a name="l01413"></a>01413     set_event_xy();
<a name="l01414"></a>01414     <a class="code" href="classFl.html#a2d93787aec60cb62a759b36267dd9d06">Fl::e_state</a> = xevent.xcrossing.state &lt;&lt; 16;
<a name="l01415"></a>01415     fl_xmousewin = 0;
<a name="l01416"></a>01416     in_a_window = <span class="keyword">false</span>; <span class="comment">// make do_queued_events produce FL_LEAVE event</span>
<a name="l01417"></a>01417     <span class="keywordflow">return</span> 0;
<a name="l01418"></a>01418 
<a name="l01419"></a>01419   <span class="comment">// We cannot rely on the x,y position in the configure notify event.</span>
<a name="l01420"></a>01420   <span class="comment">// I now think this is an unavoidable problem with X: it is impossible</span>
<a name="l01421"></a>01421   <span class="comment">// for a window manager to prevent the &quot;real&quot; notify event from being</span>
<a name="l01422"></a>01422   <span class="comment">// sent when it resizes the contents, even though it can send an</span>
<a name="l01423"></a>01423   <span class="comment">// artificial event with the correct position afterwards (and some</span>
<a name="l01424"></a>01424   <span class="comment">// window managers do not send this fake event anyway)</span>
<a name="l01425"></a>01425   <span class="comment">// So anyway, do a round trip to find the correct x,y:</span>
<a name="l01426"></a>01426   <span class="keywordflow">case</span> MapNotify:
<a name="l01427"></a>01427     <span class="keyword">event</span> = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a9edbfd236c9ea348dcaae935a76bd885">FL_SHOW</a>;
<a name="l01428"></a>01428 
<a name="l01429"></a>01429   <span class="keywordflow">case</span> ConfigureNotify: {
<a name="l01430"></a>01430     <span class="keywordflow">if</span> (window-&gt;<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>()) <span class="keywordflow">break</span>; <span class="comment">// ignore child windows</span>
<a name="l01431"></a>01431 
<a name="l01432"></a>01432     <span class="comment">// figure out where OS really put window</span>
<a name="l01433"></a>01433     XWindowAttributes actual;
<a name="l01434"></a>01434     XGetWindowAttributes(fl_display, <a class="code" href="mac_8H.html#a87152d2ed84f9d97c6bf3150c7688261">fl_xid</a>(window), &amp;actual);
<a name="l01435"></a>01435     <a class="code" href="mac_8H.html#aad9fe48cacd960402308a6a7f9f5e584">Window</a> cr; <span class="keywordtype">int</span> X, Y, W = actual.width, <a class="code" href="Fl__Tooltip_8cxx.html#affa487e8e3cc48473cfc05c0ce0165e9">H</a> = actual.height;
<a name="l01436"></a>01436     XTranslateCoordinates(fl_display, <a class="code" href="mac_8H.html#a87152d2ed84f9d97c6bf3150c7688261">fl_xid</a>(window), actual.root,
<a name="l01437"></a>01437                           0, 0, &amp;X, &amp;Y, &amp;cr);
<a name="l01438"></a>01438 
<a name="l01439"></a>01439     <span class="comment">// tell Fl_Window about it and set flag to prevent echoing:</span>
<a name="l01440"></a>01440     resize_bug_fix = window;
<a name="l01441"></a>01441     window-&gt;<a class="code" href="classFl__Window.html#a7b3f27fe1b0fbc2a06065a7f037a2fbb">resize</a>(X, Y, W, <a class="code" href="Fl__Tooltip_8cxx.html#affa487e8e3cc48473cfc05c0ce0165e9">H</a>);
<a name="l01442"></a>01442     <span class="keywordflow">break</span>; <span class="comment">// allow add_handler to do something too</span>
<a name="l01443"></a>01443     }
<a name="l01444"></a>01444 
<a name="l01445"></a>01445   <span class="keywordflow">case</span> ReparentNotify: {
<a name="l01446"></a>01446     <span class="keywordtype">int</span> xpos, ypos;
<a name="l01447"></a>01447     <a class="code" href="mac_8H.html#aad9fe48cacd960402308a6a7f9f5e584">Window</a> junk;
<a name="l01448"></a>01448     
<a name="l01449"></a>01449     <span class="comment">// on some systems, the ReparentNotify event is not handled as we would expect.</span>
<a name="l01450"></a>01450     XErrorHandler oldHandler = XSetErrorHandler(catchXExceptions());
<a name="l01451"></a>01451 
<a name="l01452"></a>01452     <span class="comment">//ReparentNotify gives the new position of the window relative to</span>
<a name="l01453"></a>01453     <span class="comment">//the new parent. FLTK cares about the position on the root window.</span>
<a name="l01454"></a>01454     XTranslateCoordinates(fl_display, xevent.xreparent.parent,
<a name="l01455"></a>01455                           XRootWindow(fl_display, fl_screen),
<a name="l01456"></a>01456                           xevent.xreparent.x, xevent.xreparent.y,
<a name="l01457"></a>01457                           &amp;xpos, &amp;ypos, &amp;junk);
<a name="l01458"></a>01458     XSetErrorHandler(oldHandler);
<a name="l01459"></a>01459 
<a name="l01460"></a>01460     <span class="comment">// tell Fl_Window about it and set flag to prevent echoing:</span>
<a name="l01461"></a>01461     <span class="keywordflow">if</span> ( !wasXExceptionRaised() ) {
<a name="l01462"></a>01462       resize_bug_fix = window;
<a name="l01463"></a>01463       window-&gt;<a class="code" href="classFl__Widget.html#ac45bdb80c3e66c571d0420ebefd4aaa5">position</a>(xpos, ypos);
<a name="l01464"></a>01464     }
<a name="l01465"></a>01465     <span class="keywordflow">break</span>;
<a name="l01466"></a>01466     }
<a name="l01467"></a>01467   }
<a name="l01468"></a>01468 
<a name="l01469"></a>01469   <span class="keywordflow">return</span> <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>(event, window);
<a name="l01470"></a>01470 }
<a name="l01471"></a>01471 
<a name="l01473"></a>01473 
<a name="l01474"></a>01474 <span class="keywordtype">void</span> <a class="code" href="classFl__Window.html#a7b3f27fe1b0fbc2a06065a7f037a2fbb">Fl_Window::resize</a>(<span class="keywordtype">int</span> X,<span class="keywordtype">int</span> Y,<span class="keywordtype">int</span> W,<span class="keywordtype">int</span> <a class="code" href="Fl__Tooltip_8cxx.html#affa487e8e3cc48473cfc05c0ce0165e9">H</a>) {
<a name="l01475"></a>01475   <span class="keywordtype">int</span> is_a_move = (X != <a class="code" href="classFl__Widget.html#ad09bc10de43482a671f834a653211e9f">x</a>() || Y != <a class="code" href="classFl__Widget.html#a54fbdc7be9ae81c6b34abc73a93908f1">y</a>());
<a name="l01476"></a>01476   <span class="keywordtype">int</span> is_a_resize = (W != <a class="code" href="classFl__Widget.html#aec9e0a6f77d93e6f8caffc1b0f6abbda">w</a>() || H != <a class="code" href="classFl__Widget.html#a994f71abd8b39c87cef909713d3347f0">h</a>());
<a name="l01477"></a>01477   <span class="keywordtype">int</span> is_a_enlarge = (W &gt; <a class="code" href="classFl__Widget.html#aec9e0a6f77d93e6f8caffc1b0f6abbda">w</a>() || H &gt; <a class="code" href="classFl__Widget.html#a994f71abd8b39c87cef909713d3347f0">h</a>());
<a name="l01478"></a>01478   <span class="keywordtype">int</span> resize_from_program = (<span class="keyword">this</span> != resize_bug_fix);
<a name="l01479"></a>01479   <span class="keywordflow">if</span> (!resize_from_program) resize_bug_fix = 0;
<a name="l01480"></a>01480   <span class="keywordflow">if</span> (is_a_move &amp;&amp; resize_from_program) <a class="code" href="classFl__Widget.html#a7244e112711741978f19ceadd8f196b5">set_flag</a>(<a class="code" href="classFl__Widget.html#acd8a95e8128fe1673479b8d0f4d0aa62a1d2b155a766bc59be7a3f60d306de852" title="don&amp;#39;t let the window manager position the window (Fl_Window)">FORCE_POSITION</a>);
<a name="l01481"></a>01481   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!is_a_resize &amp;&amp; !is_a_move) <span class="keywordflow">return</span>;
<a name="l01482"></a>01482   <span class="keywordflow">if</span> (is_a_resize) {
<a name="l01483"></a>01483     <a class="code" href="classFl__Window.html#a7b3f27fe1b0fbc2a06065a7f037a2fbb">Fl_Group::resize</a>(X,Y,W,H);
<a name="l01484"></a>01484     <span class="keywordflow">if</span> (<a class="code" href="classFl__Window.html#aa09300542b2d8b49fc69a037bdd3b742">shown</a>()) {<a class="code" href="classFl__Widget.html#aa63ce68cbf4620cf8750b868368ea02b">redraw</a>(); <span class="keywordflow">if</span>(is_a_enlarge) i-&gt;wait_for_expose = 1;}
<a name="l01485"></a>01485   } <span class="keywordflow">else</span> {
<a name="l01486"></a>01486     <a class="code" href="classFl__Widget.html#ad09bc10de43482a671f834a653211e9f">x</a>(X); <a class="code" href="classFl__Widget.html#a54fbdc7be9ae81c6b34abc73a93908f1">y</a>(Y);
<a name="l01487"></a>01487   }
<a name="l01488"></a>01488 
<a name="l01489"></a>01489   <span class="keywordflow">if</span> (resize_from_program &amp;&amp; is_a_resize &amp;&amp; !<a class="code" href="classFl__Group.html#aef229a2364bd97ac364a0ec29231ce90">resizable</a>()) {
<a name="l01490"></a>01490     <a class="code" href="classFl__Window.html#a9be71df81e121b984f33140720102d59">size_range</a>(<a class="code" href="classFl__Widget.html#aec9e0a6f77d93e6f8caffc1b0f6abbda">w</a>(), <a class="code" href="classFl__Widget.html#a994f71abd8b39c87cef909713d3347f0">h</a>(), <a class="code" href="classFl__Widget.html#aec9e0a6f77d93e6f8caffc1b0f6abbda">w</a>(), <a class="code" href="classFl__Widget.html#a994f71abd8b39c87cef909713d3347f0">h</a>());
<a name="l01491"></a>01491   }
<a name="l01492"></a>01492 
<a name="l01493"></a>01493   <span class="keywordflow">if</span> (resize_from_program &amp;&amp; <a class="code" href="classFl__Window.html#aa09300542b2d8b49fc69a037bdd3b742">shown</a>()) {
<a name="l01494"></a>01494     <span class="keywordflow">if</span> (is_a_resize) {
<a name="l01495"></a>01495       <span class="keywordflow">if</span> (!<a class="code" href="classFl__Group.html#aef229a2364bd97ac364a0ec29231ce90">resizable</a>()) <a class="code" href="classFl__Window.html#a9be71df81e121b984f33140720102d59">size_range</a>(<a class="code" href="classFl__Widget.html#aec9e0a6f77d93e6f8caffc1b0f6abbda">w</a>(),<a class="code" href="classFl__Widget.html#a994f71abd8b39c87cef909713d3347f0">h</a>(),<a class="code" href="classFl__Widget.html#aec9e0a6f77d93e6f8caffc1b0f6abbda">w</a>(),<a class="code" href="classFl__Widget.html#a994f71abd8b39c87cef909713d3347f0">h</a>());
<a name="l01496"></a>01496       <span class="keywordflow">if</span> (is_a_move) {
<a name="l01497"></a>01497         XMoveResizeWindow(fl_display, i-&gt;xid, X, Y, W&gt;0 ? W : 1, H&gt;0 ? H : 1);
<a name="l01498"></a>01498       } <span class="keywordflow">else</span> {
<a name="l01499"></a>01499         XResizeWindow(fl_display, i-&gt;xid, W&gt;0 ? W : 1, H&gt;0 ? H : 1);
<a name="l01500"></a>01500       }
<a name="l01501"></a>01501     } <span class="keywordflow">else</span>
<a name="l01502"></a>01502       XMoveWindow(fl_display, i-&gt;xid, X, Y);
<a name="l01503"></a>01503   }
<a name="l01504"></a>01504 }
<a name="l01505"></a>01505 
<a name="l01507"></a>01507 
<a name="l01508"></a>01508 <span class="comment">// A subclass of Fl_Window may call this to associate an X window it</span>
<a name="l01509"></a>01509 <span class="comment">// creates with the Fl_Window:</span>
<a name="l01510"></a>01510 
<a name="l01511"></a>01511 <span class="keywordtype">void</span> <a class="code" href="Fl_8cxx.html#afe3a0306383e206c9b1e04accc9a28e7">fl_fix_focus</a>(); <span class="comment">// in Fl.cxx</span>
<a name="l01512"></a>01512 
<a name="l01513"></a><a class="code" href="classFl__X.html#ad6183cbf420d42e005454e911758c1b9">01513</a> <a class="code" href="classFl__X.html">Fl_X</a>* <a class="code" href="classFl__X.html#ad6183cbf420d42e005454e911758c1b9">Fl_X::set_xid</a>(<a class="code" href="classFl__Window.html">Fl_Window</a>* win, <a class="code" href="mac_8H.html#aad9fe48cacd960402308a6a7f9f5e584">Window</a> winxid) {
<a name="l01514"></a>01514   <a class="code" href="classFl__X.html">Fl_X</a>* xp = <span class="keyword">new</span> <a class="code" href="classFl__X.html">Fl_X</a>;
<a name="l01515"></a>01515   xp-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a> = winxid;
<a name="l01516"></a>01516   xp-&gt;<a class="code" href="classFl__X.html#a54e86fad0e3c9fc1cdbb72153abacfdf">other_xid</a> = 0;
<a name="l01517"></a>01517   xp-&gt;<a class="code" href="classFl__X.html#a3deac87e0c68a2021a1515c003bd627d">setwindow</a>(win);
<a name="l01518"></a>01518   xp-&gt;<a class="code" href="classFl__X.html#a41f6a721a953ea62021bb1dd9c4f2187">next</a> = <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a>;
<a name="l01519"></a>01519   xp-&gt;<a class="code" href="classFl__X.html#a2d6b59b7362a486d48b6ae5df0bd0b41">region</a> = 0;
<a name="l01520"></a>01520   xp-&gt;<a class="code" href="classFl__X.html#a5bff94b4bde0ceafbaaaaaa3b7d1426e">wait_for_expose</a> = 1;
<a name="l01521"></a>01521   xp-&gt;<a class="code" href="classFl__X.html#ab26596fd89b63c8172d6d4355f292b5f">backbuffer_bad</a> = 1;
<a name="l01522"></a>01522   <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a> = xp;
<a name="l01523"></a>01523   <span class="keywordflow">if</span> (win-&gt;<a class="code" href="classFl__Window.html#a6cc843ffcc711300613e44c678ad682f">modal</a>()) {<a class="code" href="classFl.html#ab9927ecc1f8f3077079c5fabe8ec516e">Fl::modal_</a> = win; <a class="code" href="Fl_8cxx.html#afe3a0306383e206c9b1e04accc9a28e7">fl_fix_focus</a>();}
<a name="l01524"></a>01524   <span class="keywordflow">return</span> xp;
<a name="l01525"></a>01525 }
<a name="l01526"></a>01526 
<a name="l01527"></a>01527 <span class="comment">// More commonly a subclass calls this, because it hides the really</span>
<a name="l01528"></a>01528 <span class="comment">// ugly parts of X and sets all the stuff for a window that is set</span>
<a name="l01529"></a>01529 <span class="comment">// normally.  The global variables like fl_show_iconic are so that</span>
<a name="l01530"></a>01530 <span class="comment">// subclasses of *that* class may change the behavior...</span>
<a name="l01531"></a>01531 
<a name="l01532"></a><a class="code" href="Fl__x_8cxx.html#aeed6a7220f140808e50ef846ef0ad3c2">01532</a> <span class="keywordtype">char</span> <a class="code" href="Fl__arg_8cxx.html#aeed6a7220f140808e50ef846ef0ad3c2">fl_show_iconic</a>;    <span class="comment">// hack for iconize()</span>
<a name="l01533"></a><a class="code" href="Fl__x_8cxx.html#a91efd1009c64aca9629a8dd0985d0b97">01533</a> <span class="keywordtype">int</span> <a class="code" href="win32_8H.html#a886baa09ee9b72da265d089bf567314e">fl_background_pixel</a> = -1; <span class="comment">// hack to speed up bg box drawing</span>
<a name="l01534"></a><a class="code" href="Fl__x_8cxx.html#a3635433c445a0e91b41396116930abbd">01534</a> <span class="keywordtype">int</span> <a class="code" href="Fl__mac_8cxx.html#a3635433c445a0e91b41396116930abbd">fl_disable_transient_for</a>; <span class="comment">// secret method of removing TRANSIENT_FOR</span>
<a name="l01535"></a>01535 
<a name="l01536"></a>01536 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> childEventMask = ExposureMask;
<a name="l01537"></a>01537 
<a name="l01538"></a>01538 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> XEventMask =
<a name="l01539"></a>01539 ExposureMask|StructureNotifyMask
<a name="l01540"></a>01540 |KeyPressMask|KeyReleaseMask|KeymapStateMask|FocusChangeMask
<a name="l01541"></a>01541 |ButtonPressMask|ButtonReleaseMask
<a name="l01542"></a>01542 |EnterWindowMask|LeaveWindowMask
<a name="l01543"></a>01543 |PointerMotionMask;
<a name="l01544"></a>01544 
<a name="l01545"></a><a class="code" href="classFl__X.html#a83450726de77c27a143900563f16268d">01545</a> <span class="keywordtype">void</span> <a class="code" href="classFl__X.html#a83450726de77c27a143900563f16268d">Fl_X::make_xid</a>(<a class="code" href="classFl__Window.html">Fl_Window</a>* win, XVisualInfo *visual, Colormap colormap)
<a name="l01546"></a>01546 {
<a name="l01547"></a>01547   <a class="code" href="classFl__Group.html#af48163bbf0a8d18844b5d751946897c0">Fl_Group::current</a>(0); <span class="comment">// get rid of very common user bug: forgot end()</span>
<a name="l01548"></a>01548 
<a name="l01549"></a>01549   <span class="keywordtype">int</span> X = win-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>();
<a name="l01550"></a>01550   <span class="keywordtype">int</span> Y = win-&gt;<a class="code" href="classFl__Widget.html#aec1aded9efdf5f23dfac8cc725cefc4a">y</a>();
<a name="l01551"></a>01551   <span class="keywordtype">int</span> W = win-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>();
<a name="l01552"></a>01552   <span class="keywordflow">if</span> (W &lt;= 0) W = 1; <span class="comment">// X don&#39;t like zero...</span>
<a name="l01553"></a>01553   <span class="keywordtype">int</span> H = win-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>();
<a name="l01554"></a>01554   <span class="keywordflow">if</span> (H &lt;= 0) H = 1; <span class="comment">// X don&#39;t like zero...</span>
<a name="l01555"></a>01555   <span class="keywordflow">if</span> (!win-&gt;<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>() &amp;&amp; !<a class="code" href="group__fl__windows.html#ga100705a8107397cfde7318aa34019739">Fl::grab</a>()) {
<a name="l01556"></a>01556     <span class="comment">// center windows in case window manager does not do anything:</span>
<a name="l01557"></a>01557 <span class="preprocessor">#ifdef FL_CENTER_WINDOWS</span>
<a name="l01558"></a>01558 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!(win-&gt;<a class="code" href="classFl__Widget.html#a2bd83b947c7f75919afc280043c958db">flags</a>() &amp; <a class="code" href="classFl__Widget.html#acd8a95e8128fe1673479b8d0f4d0aa62a1d2b155a766bc59be7a3f60d306de852" title="don&amp;#39;t let the window manager position the window (Fl_Window)">Fl_Widget::FORCE_POSITION</a>)) {
<a name="l01559"></a>01559       win-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>(X = scr_x+(scr_w-W)/2);
<a name="l01560"></a>01560       win-&gt;<a class="code" href="classFl__Widget.html#aec1aded9efdf5f23dfac8cc725cefc4a">y</a>(Y = scr_y+(scr_h-H)/2);
<a name="l01561"></a>01561     }
<a name="l01562"></a>01562 <span class="preprocessor">#endif // FL_CENTER_WINDOWS</span>
<a name="l01563"></a>01563 <span class="preprocessor"></span>
<a name="l01564"></a>01564     <span class="comment">// force the window to be on-screen.  Usually the X window manager</span>
<a name="l01565"></a>01565     <span class="comment">// does this, but a few don&#39;t, so we do it here for consistency:</span>
<a name="l01566"></a>01566     <span class="keywordtype">int</span> scr_x, scr_y, scr_w, scr_h;
<a name="l01567"></a>01567     <a class="code" href="group__fl__screen.html#ga510d26cb2d6ec0688cf1eb8c5d9e5a1e">Fl::screen_xywh</a>(scr_x, scr_y, scr_w, scr_h, X, Y);
<a name="l01568"></a>01568 
<a name="l01569"></a>01569     <span class="keywordflow">if</span> (win-&gt;<a class="code" href="classFl__Window.html#a72f5733f13cb6d8b646f1e7ffcd92333">border</a>()) {
<a name="l01570"></a>01570       <span class="comment">// ensure border is on screen:</span>
<a name="l01571"></a>01571       <span class="comment">// (assume extremely minimal dimensions for this border)</span>
<a name="l01572"></a>01572       <span class="keyword">const</span> <span class="keywordtype">int</span> top = 20;
<a name="l01573"></a>01573       <span class="keyword">const</span> <span class="keywordtype">int</span> left = 1;
<a name="l01574"></a>01574       <span class="keyword">const</span> <span class="keywordtype">int</span> right = 1;
<a name="l01575"></a>01575       <span class="keyword">const</span> <span class="keywordtype">int</span> bottom = 1;
<a name="l01576"></a>01576       <span class="keywordflow">if</span> (X+W+right &gt; scr_x+scr_w) X = scr_x+scr_w-right-W;
<a name="l01577"></a>01577       <span class="keywordflow">if</span> (X-left &lt; scr_x) X = scr_x+left;
<a name="l01578"></a>01578       <span class="keywordflow">if</span> (Y+H+bottom &gt; scr_y+scr_h) Y = scr_y+scr_h-bottom-<a class="code" href="Fl__Tooltip_8cxx.html#affa487e8e3cc48473cfc05c0ce0165e9">H</a>;
<a name="l01579"></a>01579       <span class="keywordflow">if</span> (Y-top &lt; scr_y) Y = scr_y+top;
<a name="l01580"></a>01580     }
<a name="l01581"></a>01581     <span class="comment">// now insure contents are on-screen (more important than border):</span>
<a name="l01582"></a>01582     <span class="keywordflow">if</span> (X+W &gt; scr_x+scr_w) X = scr_x+scr_w-W;
<a name="l01583"></a>01583     <span class="keywordflow">if</span> (X &lt; scr_x) X = scr_x;
<a name="l01584"></a>01584     <span class="keywordflow">if</span> (Y+H &gt; scr_y+scr_h) Y = scr_y+scr_h-<a class="code" href="Fl__Tooltip_8cxx.html#affa487e8e3cc48473cfc05c0ce0165e9">H</a>;
<a name="l01585"></a>01585     <span class="keywordflow">if</span> (Y &lt; scr_y) Y = scr_y;
<a name="l01586"></a>01586   }
<a name="l01587"></a>01587 
<a name="l01588"></a>01588   <span class="comment">// if the window is a subwindow and our parent is not mapped yet, we</span>
<a name="l01589"></a>01589   <span class="comment">// mark this window visible, so that mapping the parent at a later</span>
<a name="l01590"></a>01590   <span class="comment">// point in time will call this function again to finally map the subwindow.</span>
<a name="l01591"></a>01591   <span class="keywordflow">if</span> (win-&gt;<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>() &amp;&amp; !<a class="code" href="classFl__X.html#ae4c6997d92cf8ad3a75a962d7ae77c34">Fl_X::i</a>(win-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>())) {
<a name="l01592"></a>01592     win-&gt;<a class="code" href="classFl__Widget.html#a85981546c4927bd5e6d43d6e3df3416a">set_visible</a>();
<a name="l01593"></a>01593     <span class="keywordflow">return</span>;
<a name="l01594"></a>01594   }
<a name="l01595"></a>01595 
<a name="l01596"></a>01596   <a class="code" href="fl__types_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a> root = win-&gt;<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>() ?
<a name="l01597"></a>01597     <a class="code" href="mac_8H.html#a87152d2ed84f9d97c6bf3150c7688261">fl_xid</a>(win-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>()) : RootWindow(fl_display, fl_screen);
<a name="l01598"></a>01598 
<a name="l01599"></a>01599   XSetWindowAttributes attr;
<a name="l01600"></a>01600   <span class="keywordtype">int</span> <a class="code" href="png_8h.html#aa61e47f2cb0ad7631948cd857c77164f">mask</a> = CWBorderPixel|CWColormap|CWEventMask|CWBitGravity;
<a name="l01601"></a>01601   attr.event_mask = win-&gt;<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>() ? childEventMask : XEventMask;
<a name="l01602"></a>01602   attr.colormap = colormap;
<a name="l01603"></a>01603   attr.border_pixel = 0;
<a name="l01604"></a>01604   attr.bit_gravity = 0; <span class="comment">// StaticGravity;</span>
<a name="l01605"></a>01605   <span class="keywordflow">if</span> (win-&gt;<a class="code" href="classFl__Window.html#aeed8d628ef854ea63a4e2badd9596eb7">override</a>()) {
<a name="l01606"></a>01606     attr.override_redirect = 1;
<a name="l01607"></a>01607     attr.save_under = 1;
<a name="l01608"></a>01608     mask |= CWOverrideRedirect | CWSaveUnder;
<a name="l01609"></a>01609   } <span class="keywordflow">else</span> attr.override_redirect = 0;
<a name="l01610"></a>01610   <span class="keywordflow">if</span> (<a class="code" href="group__fl__windows.html#ga100705a8107397cfde7318aa34019739">Fl::grab</a>()) {
<a name="l01611"></a>01611     attr.save_under = 1; mask |= CWSaveUnder;
<a name="l01612"></a>01612     <span class="keywordflow">if</span> (!win-&gt;<a class="code" href="classFl__Window.html#a72f5733f13cb6d8b646f1e7ffcd92333">border</a>()) {attr.override_redirect = 1; mask |= CWOverrideRedirect;}
<a name="l01613"></a>01613   }
<a name="l01614"></a>01614   <span class="keywordflow">if</span> (fl_background_pixel &gt;= 0) {
<a name="l01615"></a>01615     attr.background_pixel = <a class="code" href="win32_8H.html#a886baa09ee9b72da265d089bf567314e">fl_background_pixel</a>;
<a name="l01616"></a>01616     fl_background_pixel = -1;
<a name="l01617"></a>01617     mask |= CWBackPixel;
<a name="l01618"></a>01618   }
<a name="l01619"></a>01619 
<a name="l01620"></a>01620   <a class="code" href="classFl__X.html">Fl_X</a>* xp =
<a name="l01621"></a>01621     <a class="code" href="classFl__X.html#ad6183cbf420d42e005454e911758c1b9">set_xid</a>(win, XCreateWindow(fl_display,
<a name="l01622"></a>01622                                root,
<a name="l01623"></a>01623                                X, Y, W, H,
<a name="l01624"></a>01624                                0, <span class="comment">// borderwidth</span>
<a name="l01625"></a>01625                                visual-&gt;depth,
<a name="l01626"></a>01626                                InputOutput,
<a name="l01627"></a>01627                                visual-&gt;visual,
<a name="l01628"></a>01628                                mask, &amp;attr));
<a name="l01629"></a>01629   <span class="keywordtype">int</span> showit = 1;
<a name="l01630"></a>01630 
<a name="l01631"></a>01631   <span class="keywordflow">if</span> (!win-&gt;<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>() &amp;&amp; !attr.override_redirect) {
<a name="l01632"></a>01632     <span class="comment">// Communicate all kinds &#39;o junk to the X Window Manager:</span>
<a name="l01633"></a>01633 
<a name="l01634"></a>01634     win-&gt;<a class="code" href="classFl__Window.html#a51a6665c988138e426fc12b4bf138f7b">label</a>(win-&gt;<a class="code" href="classFl__Window.html#a51a6665c988138e426fc12b4bf138f7b">label</a>(), win-&gt;<a class="code" href="classFl__Window.html#a0fe12b79c907b9b4127ca69882896dd9">iconlabel</a>());
<a name="l01635"></a>01635 
<a name="l01636"></a>01636     XChangeProperty(fl_display, xp-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, WM_PROTOCOLS,
<a name="l01637"></a>01637                     XA_ATOM, 32, 0, (<a class="code" href="fl__types_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>*)&amp;WM_DELETE_WINDOW, 1);
<a name="l01638"></a>01638 
<a name="l01639"></a>01639     <span class="comment">// send size limits and border:</span>
<a name="l01640"></a>01640     xp-&gt;<a class="code" href="classFl__X.html#a10afa723a303bf50f7fec33adaf7ef20">sendxjunk</a>();
<a name="l01641"></a>01641 
<a name="l01642"></a>01642     <span class="comment">// set the class property, which controls the icon used:</span>
<a name="l01643"></a>01643     <span class="keywordflow">if</span> (win-&gt;<a class="code" href="classFl__Window.html#aa72d16b01745c1b396a654527012a6db">xclass</a>()) {
<a name="l01644"></a>01644       <span class="keywordtype">char</span> <a class="code" href="png_8h.html#ae666dd7e2f504034709280abeac7616e">buffer</a>[1024];
<a name="l01645"></a>01645       <span class="keywordtype">char</span> *p; <span class="keyword">const</span> <span class="keywordtype">char</span> *q;
<a name="l01646"></a>01646       <span class="comment">// truncate on any punctuation, because they break XResource lookup:</span>
<a name="l01647"></a>01647       <span class="keywordflow">for</span> (p = buffer, q = win-&gt;<a class="code" href="classFl__Window.html#aa72d16b01745c1b396a654527012a6db">xclass</a>(); isalnum(*q)||(*q&amp;128);) *p++ = *q++;
<a name="l01648"></a>01648       *p++ = 0;
<a name="l01649"></a>01649       <span class="comment">// create the capitalized version:</span>
<a name="l01650"></a>01650       q = buffer;
<a name="l01651"></a>01651       *p = toupper(*q++); <span class="keywordflow">if</span> (*p++ == <span class="charliteral">&#39;X&#39;</span>) *p++ = toupper(*q++);
<a name="l01652"></a>01652       <span class="keywordflow">while</span> ((*p++ = *q++));
<a name="l01653"></a>01653       XChangeProperty(fl_display, xp-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, XA_WM_CLASS, XA_STRING, 8, 0,
<a name="l01654"></a>01654                       (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)buffer, p-buffer-1);
<a name="l01655"></a>01655     }
<a name="l01656"></a>01656 
<a name="l01657"></a>01657     <span class="keywordflow">if</span> (win-&gt;<a class="code" href="classFl__Window.html#a663df072d1d68c5733a1c5f2f88fd819">non_modal</a>() &amp;&amp; xp-&gt;<a class="code" href="classFl__X.html#a41f6a721a953ea62021bb1dd9c4f2187">next</a> &amp;&amp; !<a class="code" href="Fl__mac_8cxx.html#a3635433c445a0e91b41396116930abbd">fl_disable_transient_for</a>) {
<a name="l01658"></a>01658       <span class="comment">// find some other window to be &quot;transient for&quot;:</span>
<a name="l01659"></a>01659       <a class="code" href="classFl__Window.html">Fl_Window</a>* wp = xp-&gt;<a class="code" href="classFl__X.html#a41f6a721a953ea62021bb1dd9c4f2187">next</a>-&gt;<a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>;
<a name="l01660"></a>01660       <span class="keywordflow">while</span> (wp-&gt;<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>()) wp = wp-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>();
<a name="l01661"></a>01661       XSetTransientForHint(fl_display, xp-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, <a class="code" href="mac_8H.html#a87152d2ed84f9d97c6bf3150c7688261">fl_xid</a>(wp));
<a name="l01662"></a>01662       <span class="keywordflow">if</span> (!wp-&gt;<a class="code" href="classFl__Widget.html#ac0b2f353f8d142156ffb27b76a2e9628">visible</a>()) showit = 0; <span class="comment">// guess that wm will not show it</span>
<a name="l01663"></a>01663     }
<a name="l01664"></a>01664    
<a name="l01665"></a>01665     <span class="comment">// Make sure that borderless windows do not show in the task bar</span>
<a name="l01666"></a>01666     <span class="keywordflow">if</span> (!win-&gt;<a class="code" href="classFl__Window.html#a72f5733f13cb6d8b646f1e7ffcd92333">border</a>()) {
<a name="l01667"></a>01667       Atom net_wm_state = XInternAtom (fl_display, <span class="stringliteral">&quot;_NET_WM_STATE&quot;</span>, 0);
<a name="l01668"></a>01668       Atom net_wm_state_skip_taskbar = XInternAtom (fl_display, <span class="stringliteral">&quot;_NET_WM_STATE_SKIP_TASKBAR&quot;</span>, 0);
<a name="l01669"></a>01669       XChangeProperty (fl_display, xp-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, net_wm_state, XA_ATOM, 32,
<a name="l01670"></a>01670           PropModeAppend, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*) &amp;net_wm_state_skip_taskbar, 1);
<a name="l01671"></a>01671     }
<a name="l01672"></a>01672 
<a name="l01673"></a>01673     <span class="comment">// Make it receptive to DnD:</span>
<a name="l01674"></a>01674     <span class="keywordtype">long</span> <a class="code" href="jpeglib_8h.html#aad880fc4455c253781e8968f2239d56f">version</a> = 4;
<a name="l01675"></a>01675     XChangeProperty(fl_display, xp-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, fl_XdndAware,
<a name="l01676"></a>01676                     XA_ATOM, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*8, 0, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)&amp;version, 1);
<a name="l01677"></a>01677 
<a name="l01678"></a>01678     XWMHints *hints = XAllocWMHints();
<a name="l01679"></a>01679     hints-&gt;input = True;
<a name="l01680"></a>01680     hints-&gt;flags = InputHint;
<a name="l01681"></a>01681     <span class="keywordflow">if</span> (fl_show_iconic) {
<a name="l01682"></a>01682       hints-&gt;flags |= StateHint;
<a name="l01683"></a>01683       hints-&gt;initial_state = IconicState;
<a name="l01684"></a>01684       fl_show_iconic = 0;
<a name="l01685"></a>01685       showit = 0;
<a name="l01686"></a>01686     }
<a name="l01687"></a>01687     <span class="keywordflow">if</span> (win-&gt;<a class="code" href="classFl__Window.html#a26d72fc2749dce26680d686ae6841a29">icon</a>()) {
<a name="l01688"></a>01688       hints-&gt;icon_pixmap = (Pixmap)win-&gt;<a class="code" href="classFl__Window.html#a26d72fc2749dce26680d686ae6841a29">icon</a>();
<a name="l01689"></a>01689       hints-&gt;flags       |= IconPixmapHint;
<a name="l01690"></a>01690     }
<a name="l01691"></a>01691     XSetWMHints(fl_display, xp-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, hints);
<a name="l01692"></a>01692     XFree(hints);
<a name="l01693"></a>01693   }
<a name="l01694"></a>01694 
<a name="l01695"></a>01695   <span class="comment">// set the window type for menu and tooltip windows to avoid animations (compiz)</span>
<a name="l01696"></a>01696   <span class="keywordflow">if</span> (win-&gt;<a class="code" href="classFl__Window.html#a41889341ef450cbc0ddf99b24f1aa104">menu_window</a>() || win-&gt;<a class="code" href="classFl__Window.html#aa2f8c9d857a58ee5d7968ea28eacc50c">tooltip_window</a>()) {
<a name="l01697"></a>01697     Atom net_wm_type = XInternAtom(fl_display, <span class="stringliteral">&quot;_NET_WM_WINDOW_TYPE&quot;</span>, False);
<a name="l01698"></a>01698     Atom net_wm_type_kind = XInternAtom(fl_display, <span class="stringliteral">&quot;_NET_WM_WINDOW_TYPE_MENU&quot;</span>, False);
<a name="l01699"></a>01699     XChangeProperty(fl_display, xp-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, net_wm_type, XA_ATOM, 32, PropModeReplace, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)&amp;net_wm_type_kind, 1);
<a name="l01700"></a>01700   }
<a name="l01701"></a>01701 
<a name="l01702"></a>01702   <a class="code" href="win32_8H.html#aa036a6169aa9a2c19190c4bff3ffc444">XMapWindow</a>(fl_display, xp-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>);
<a name="l01703"></a>01703   <span class="keywordflow">if</span> (showit) {
<a name="l01704"></a>01704     win-&gt;<a class="code" href="classFl__Widget.html#a85981546c4927bd5e6d43d6e3df3416a">set_visible</a>();
<a name="l01705"></a>01705     <span class="keywordtype">int</span> old_event = <a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a>;
<a name="l01706"></a>01706     win-&gt;<a class="code" href="classFl__Window.html#a9c0eb1c55a1a62ef3d3d87676f936187">handle</a>(<a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a> = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a9edbfd236c9ea348dcaae935a76bd885">FL_SHOW</a>); <span class="comment">// get child windows to appear</span>
<a name="l01707"></a>01707     <a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a> = old_event;
<a name="l01708"></a>01708     win-&gt;<a class="code" href="classFl__Widget.html#aa63ce68cbf4620cf8750b868368ea02b">redraw</a>();
<a name="l01709"></a>01709   }
<a name="l01710"></a>01710 }
<a name="l01711"></a>01711 
<a name="l01713"></a>01713 <span class="comment">// Send X window stuff that can be changed over time:</span>
<a name="l01714"></a>01714 
<a name="l01715"></a><a class="code" href="classFl__X.html#a10afa723a303bf50f7fec33adaf7ef20">01715</a> <span class="keywordtype">void</span> <a class="code" href="classFl__X.html#a10afa723a303bf50f7fec33adaf7ef20">Fl_X::sendxjunk</a>() {
<a name="l01716"></a>01716   <span class="keywordflow">if</span> (<a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>-&gt;<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>() || <a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>-&gt;<a class="code" href="classFl__Window.html#aeed8d628ef854ea63a4e2badd9596eb7">override</a>()) <span class="keywordflow">return</span>; <span class="comment">// it&#39;s not a window manager window!</span>
<a name="l01717"></a>01717 
<a name="l01718"></a>01718   <span class="keywordflow">if</span> (!<a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>-&gt;size_range_set) { <span class="comment">// default size_range based on resizable():</span>
<a name="l01719"></a>01719     <span class="keywordflow">if</span> (<a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>-&gt;<a class="code" href="classFl__Group.html#ab0ed0d1974d7185594687849f386c5f3">resizable</a>()) {
<a name="l01720"></a>01720       <a class="code" href="classFl__Widget.html">Fl_Widget</a> *o = <a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>-&gt;<a class="code" href="classFl__Group.html#ab0ed0d1974d7185594687849f386c5f3">resizable</a>();
<a name="l01721"></a>01721       <span class="keywordtype">int</span> minw = o-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>(); <span class="keywordflow">if</span> (minw &gt; 100) minw = 100;
<a name="l01722"></a>01722       <span class="keywordtype">int</span> minh = o-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>(); <span class="keywordflow">if</span> (minh &gt; 100) minh = 100;
<a name="l01723"></a>01723       <a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>-&gt;<a class="code" href="classFl__Window.html#a9be71df81e121b984f33140720102d59">size_range</a>(<a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>() - o-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>() + minw, <a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>() - o-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>() + minh, 0, 0);
<a name="l01724"></a>01724     } <span class="keywordflow">else</span> {
<a name="l01725"></a>01725       <a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>-&gt;<a class="code" href="classFl__Window.html#a9be71df81e121b984f33140720102d59">size_range</a>(<a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>(), <a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>(), <a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>(), <a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>());
<a name="l01726"></a>01726     }
<a name="l01727"></a>01727     <span class="keywordflow">return</span>; <span class="comment">// because this recursively called here</span>
<a name="l01728"></a>01728   }
<a name="l01729"></a>01729 
<a name="l01730"></a>01730   XSizeHints *hints = XAllocSizeHints();
<a name="l01731"></a>01731   <span class="comment">// memset(&amp;hints, 0, sizeof(hints)); jreiser suggestion to fix purify?</span>
<a name="l01732"></a>01732   hints-&gt;min_width = <a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>-&gt;minw;
<a name="l01733"></a>01733   hints-&gt;min_height = <a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>-&gt;minh;
<a name="l01734"></a>01734   hints-&gt;max_width = <a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>-&gt;maxw;
<a name="l01735"></a>01735   hints-&gt;max_height = <a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>-&gt;maxh;
<a name="l01736"></a>01736   hints-&gt;width_inc = <a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>-&gt;dw;
<a name="l01737"></a>01737   hints-&gt;height_inc = <a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>-&gt;dh;
<a name="l01738"></a>01738   hints-&gt;win_gravity = StaticGravity;
<a name="l01739"></a>01739 
<a name="l01740"></a>01740   <span class="comment">// see the file /usr/include/X11/Xm/MwmUtil.h:</span>
<a name="l01741"></a>01741   <span class="comment">// fill all fields to avoid bugs in kwm and perhaps other window managers:</span>
<a name="l01742"></a>01742   <span class="comment">// 0, MWM_FUNC_ALL, MWM_DECOR_ALL</span>
<a name="l01743"></a>01743   <span class="keywordtype">long</span> prop[5] = {0, 1, 1, 0, 0};
<a name="l01744"></a>01744 
<a name="l01745"></a>01745   <span class="keywordflow">if</span> (hints-&gt;min_width != hints-&gt;max_width ||
<a name="l01746"></a>01746       hints-&gt;min_height != hints-&gt;max_height) { <span class="comment">// resizable</span>
<a name="l01747"></a>01747     hints-&gt;flags = PMinSize|PWinGravity;
<a name="l01748"></a>01748     <span class="keywordflow">if</span> (hints-&gt;max_width &gt;= hints-&gt;min_width ||
<a name="l01749"></a>01749         hints-&gt;max_height &gt;= hints-&gt;min_height) {
<a name="l01750"></a>01750       hints-&gt;flags = PMinSize|PMaxSize|PWinGravity;
<a name="l01751"></a>01751       <span class="comment">// unfortunately we can&#39;t set just one maximum size.  Guess a</span>
<a name="l01752"></a>01752       <span class="comment">// value for the other one.  Some window managers will make the</span>
<a name="l01753"></a>01753       <span class="comment">// window fit on screen when maximized, others will put it off screen:</span>
<a name="l01754"></a>01754       <span class="keywordflow">if</span> (hints-&gt;max_width &lt; hints-&gt;min_width) hints-&gt;max_width = <a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">Fl::w</a>();
<a name="l01755"></a>01755       <span class="keywordflow">if</span> (hints-&gt;max_height &lt; hints-&gt;min_height) hints-&gt;max_height = <a class="code" href="forms_8H-2.html#a7e427ba5b307f9068129699250690066">Fl::h</a>();
<a name="l01756"></a>01756     }
<a name="l01757"></a>01757     <span class="keywordflow">if</span> (hints-&gt;width_inc &amp;&amp; hints-&gt;height_inc) hints-&gt;flags |= PResizeInc;
<a name="l01758"></a>01758     <span class="keywordflow">if</span> (<a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>-&gt;aspect) {
<a name="l01759"></a>01759       <span class="comment">// stupid X!  It could insist that the corner go on the</span>
<a name="l01760"></a>01760       <span class="comment">// straight line between min and max...</span>
<a name="l01761"></a>01761       hints-&gt;min_aspect.x = hints-&gt;max_aspect.x = hints-&gt;min_width;
<a name="l01762"></a>01762       hints-&gt;min_aspect.y = hints-&gt;max_aspect.y = hints-&gt;min_height;
<a name="l01763"></a>01763       hints-&gt;flags |= PAspect;
<a name="l01764"></a>01764     }
<a name="l01765"></a>01765   } <span class="keywordflow">else</span> { <span class="comment">// not resizable:</span>
<a name="l01766"></a>01766     hints-&gt;flags = PMinSize|PMaxSize|PWinGravity;
<a name="l01767"></a>01767     prop[0] = 1; <span class="comment">// MWM_HINTS_FUNCTIONS</span>
<a name="l01768"></a>01768     prop[1] = 1|2|16; <span class="comment">// MWM_FUNC_ALL | MWM_FUNC_RESIZE | MWM_FUNC_MAXIMIZE</span>
<a name="l01769"></a>01769   }
<a name="l01770"></a>01770 
<a name="l01771"></a>01771   <span class="keywordflow">if</span> (<a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>-&gt;<a class="code" href="classFl__Widget.html#a2bd83b947c7f75919afc280043c958db">flags</a>() &amp; <a class="code" href="classFl__Widget.html#acd8a95e8128fe1673479b8d0f4d0aa62a1d2b155a766bc59be7a3f60d306de852" title="don&amp;#39;t let the window manager position the window (Fl_Window)">Fl_Widget::FORCE_POSITION</a>) {
<a name="l01772"></a>01772     hints-&gt;flags |= USPosition;
<a name="l01773"></a>01773     hints-&gt;x = <a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>();
<a name="l01774"></a>01774     hints-&gt;y = <a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>-&gt;<a class="code" href="classFl__Widget.html#aec1aded9efdf5f23dfac8cc725cefc4a">y</a>();
<a name="l01775"></a>01775   }
<a name="l01776"></a>01776 
<a name="l01777"></a>01777   <span class="keywordflow">if</span> (!<a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>-&gt;<a class="code" href="classFl__Window.html#a72f5733f13cb6d8b646f1e7ffcd92333">border</a>()) {
<a name="l01778"></a>01778     prop[0] |= 2; <span class="comment">// MWM_HINTS_DECORATIONS</span>
<a name="l01779"></a>01779     prop[2] = 0; <span class="comment">// no decorations</span>
<a name="l01780"></a>01780   }
<a name="l01781"></a>01781 
<a name="l01782"></a>01782   XSetWMNormalHints(fl_display, <a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, hints);
<a name="l01783"></a>01783   XChangeProperty(fl_display, <a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>,
<a name="l01784"></a>01784                   fl_MOTIF_WM_HINTS, fl_MOTIF_WM_HINTS,
<a name="l01785"></a>01785                   32, 0, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)prop, 5);
<a name="l01786"></a>01786   XFree(hints);
<a name="l01787"></a>01787 }
<a name="l01788"></a>01788 
<a name="l01789"></a>01789 <span class="keywordtype">void</span> Fl_Window::size_range_() {
<a name="l01790"></a>01790   size_range_set = 1;
<a name="l01791"></a>01791   <span class="keywordflow">if</span> (<a class="code" href="classFl__Window.html#aa09300542b2d8b49fc69a037bdd3b742">shown</a>()) i-&gt;sendxjunk();
<a name="l01792"></a>01792 }
<a name="l01793"></a>01793 
<a name="l01795"></a>01795 
<a name="l01796"></a>01796 <span class="comment">// returns pointer to the filename, or null if name ends with &#39;/&#39;</span>
<a name="l01797"></a><a class="code" href="group__filenames.html#ga0ac0f44a1709c6ff94f56a8954dc8fd6">01797</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="group__filenames.html#ga0ac0f44a1709c6ff94f56a8954dc8fd6">fl_filename_name</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="png_8h.html#a90cd716fdb9b68c9661c3ba908a0ceff">name</a>) {
<a name="l01798"></a>01798   <span class="keyword">const</span> <span class="keywordtype">char</span> *p,*q;
<a name="l01799"></a>01799   <span class="keywordflow">if</span> (!name) <span class="keywordflow">return</span> (0);
<a name="l01800"></a>01800   <span class="keywordflow">for</span> (p=q=name; *p;) <span class="keywordflow">if</span> (*p++ == <span class="charliteral">&#39;/&#39;</span>) q = p;
<a name="l01801"></a>01801   <span class="keywordflow">return</span> q;
<a name="l01802"></a>01802 }
<a name="l01803"></a>01803 
<a name="l01804"></a>01804 <span class="keywordtype">void</span> <a class="code" href="classFl__Window.html#a51a6665c988138e426fc12b4bf138f7b">Fl_Window::label</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="png_8h.html#a90cd716fdb9b68c9661c3ba908a0ceff">name</a>,<span class="keyword">const</span> <span class="keywordtype">char</span> *iname) {
<a name="l01805"></a>01805   <a class="code" href="classFl__Window.html#a51a6665c988138e426fc12b4bf138f7b">Fl_Widget::label</a>(name);
<a name="l01806"></a>01806   iconlabel_ = iname;
<a name="l01807"></a>01807   <span class="keywordflow">if</span> (<a class="code" href="classFl__Window.html#aa09300542b2d8b49fc69a037bdd3b742">shown</a>() &amp;&amp; !<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>()) {
<a name="l01808"></a>01808     <span class="keywordflow">if</span> (!name) name = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01809"></a>01809     <span class="keywordtype">int</span> namelen = strlen(name);
<a name="l01810"></a>01810     <span class="keywordflow">if</span> (!iname) iname = <a class="code" href="group__filenames.html#ga0ac0f44a1709c6ff94f56a8954dc8fd6">fl_filename_name</a>(name);
<a name="l01811"></a>01811     <span class="keywordtype">int</span> inamelen = strlen(iname);
<a name="l01812"></a>01812     XChangeProperty(fl_display, i-&gt;xid, fl_NET_WM_NAME,      fl_XaUtf8String, 8, 0, (<a class="code" href="fl__types_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>*)name,  namelen);    <span class="comment">// utf8</span>
<a name="l01813"></a>01813     XChangeProperty(fl_display, i-&gt;xid, XA_WM_NAME,          XA_STRING,       8, 0, (<a class="code" href="fl__types_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>*)name,  namelen);    <span class="comment">// non-utf8</span>
<a name="l01814"></a>01814     XChangeProperty(fl_display, i-&gt;xid, fl_NET_WM_ICON_NAME, fl_XaUtf8String, 8, 0, (<a class="code" href="fl__types_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>*)iname, inamelen);   <span class="comment">// utf8</span>
<a name="l01815"></a>01815     XChangeProperty(fl_display, i-&gt;xid, XA_WM_ICON_NAME,     XA_STRING,       8, 0, (<a class="code" href="fl__types_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>*)iname, inamelen);   <span class="comment">// non-utf8</span>
<a name="l01816"></a>01816   }
<a name="l01817"></a>01817 }
<a name="l01818"></a>01818 
<a name="l01820"></a>01820 <span class="comment">// Implement the virtual functions for the base Fl_Window class:</span>
<a name="l01821"></a>01821 
<a name="l01822"></a>01822 <span class="comment">// If the box is a filled rectangle, we can make the redisplay *look*</span>
<a name="l01823"></a>01823 <span class="comment">// faster by using X&#39;s background pixel erasing.  We can make it</span>
<a name="l01824"></a>01824 <span class="comment">// actually *be* faster by drawing the frame only, this is done by</span>
<a name="l01825"></a>01825 <span class="comment">// setting fl_boxcheat, which is seen by code in fl_drawbox.cxx:</span>
<a name="l01826"></a>01826 <span class="comment">//</span>
<a name="l01827"></a>01827 <span class="comment">// On XFree86 (and prehaps all X&#39;s) this has a problem if the window</span>
<a name="l01828"></a>01828 <span class="comment">// is resized while a save-behind window is atop it.  The previous</span>
<a name="l01829"></a>01829 <span class="comment">// contents are restored to the area, but this assumes the area</span>
<a name="l01830"></a>01830 <span class="comment">// is cleared to background color.  So this is disabled in this version.</span>
<a name="l01831"></a>01831 <span class="comment">// Fl_Window *fl_boxcheat;</span>
<a name="l01832"></a>01832 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> can_boxcheat(<a class="code" href="fl__types_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> b) {<span class="keywordflow">return</span> (b==1 || ((b&amp;2) &amp;&amp; b&lt;=15));}
<a name="l01833"></a>01833 
<a name="l01834"></a>01834 <span class="keywordtype">void</span> <a class="code" href="classFl__Window.html#afc4d3796226dfd4620b4d7cf29c287c9">Fl_Window::show</a>() {
<a name="l01835"></a>01835   <a class="code" href="classFl__Widget.html#a42372b96b98b126a211b88dc935c2ae6">image</a>(<a class="code" href="classFl.html#a653ad1197e2b6e99038c86a2ab6a9b46">Fl::scheme_bg_</a>);
<a name="l01836"></a>01836   <span class="keywordflow">if</span> (<a class="code" href="classFl.html#a653ad1197e2b6e99038c86a2ab6a9b46">Fl::scheme_bg_</a>) {
<a name="l01837"></a>01837     <a class="code" href="classFl__Widget.html#ad85415f61c0a5513bc524c4b6fc2b57e">labeltype</a>(<a class="code" href="Enumerations_8H.html#ad5774781d33328b82990ff9e25dfd61ba81ddb843b9f43f73446ea7d6d7d8cc84" title="draws the text (0)">FL_NORMAL_LABEL</a>);
<a name="l01838"></a>01838     <a class="code" href="classFl__Widget.html#aad980d813b8a47d777bde7cfa6b85eae">align</a>(<a class="code" href="Enumerations_8H.html#a427f1ce53c37478a59f64bec4a2e2241">FL_ALIGN_CENTER</a> | <a class="code" href="Enumerations_8H.html#ade440c90fc9c2495fdf04c9cb34fba34">FL_ALIGN_INSIDE</a> | <a class="code" href="Enumerations_8H.html#a527e2db976be1a8508c226b4ca54eaa7">FL_ALIGN_CLIP</a>);
<a name="l01839"></a>01839   } <span class="keywordflow">else</span> {
<a name="l01840"></a>01840     <a class="code" href="classFl__Widget.html#ad85415f61c0a5513bc524c4b6fc2b57e">labeltype</a>(<a class="code" href="Enumerations_8H.html#ad5774781d33328b82990ff9e25dfd61bac7e2de1d28830fe78743126eebcbe13b" title="does nothing">FL_NO_LABEL</a>);
<a name="l01841"></a>01841   }
<a name="l01842"></a>01842   <a class="code" href="classFl__Tooltip.html#af68420923dbbb7f9381b0852ad885d90">Fl_Tooltip::exit</a>(<span class="keyword">this</span>);
<a name="l01843"></a>01843   <span class="keywordflow">if</span> (!<a class="code" href="classFl__Window.html#aa09300542b2d8b49fc69a037bdd3b742">shown</a>()) {
<a name="l01844"></a>01844     <a class="code" href="mac_8H.html#a94ee21d83137569a6730e3e2e7305cbc">fl_open_display</a>();
<a name="l01845"></a>01845     <span class="comment">// Don&#39;t set background pixel for double-buffered windows...</span>
<a name="l01846"></a>01846     <span class="keywordflow">if</span> (<a class="code" href="classFl__Widget.html#ac3050e16d7ed8dccbbf3468ea8c64ab8">type</a>() == <a class="code" href="Fl__Window_8H.html#ade2152acce2e38a691be590e8ed68a3c" title="window type id all subclasses have type() &amp;gt;= this">FL_WINDOW</a> &amp;&amp; can_boxcheat(<a class="code" href="classFl__Widget.html#a991d448d9a42fb926819defc9de90999">box</a>())) {
<a name="l01847"></a>01847       fl_background_pixel = <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>(<a class="code" href="group__fl__attributes.html#ga5c8dfa051e445cff49726b256b9f1ca0">fl_xpixel</a>(<a class="code" href="classFl__Widget.html#a03c07e0725994cddf9070f9f1cd215c4">color</a>()));
<a name="l01848"></a>01848     }
<a name="l01849"></a>01849     <a class="code" href="classFl__X.html#a83450726de77c27a143900563f16268d">Fl_X::make_xid</a>(<span class="keyword">this</span>);
<a name="l01850"></a>01850   } <span class="keywordflow">else</span> {
<a name="l01851"></a>01851     XMapRaised(fl_display, i-&gt;xid);
<a name="l01852"></a>01852   }
<a name="l01853"></a>01853 <span class="preprocessor">#ifdef USE_PRINT_BUTTON</span>
<a name="l01854"></a>01854 <span class="preprocessor"></span><span class="keywordtype">void</span> preparePrintFront(<span class="keywordtype">void</span>);
<a name="l01855"></a>01855 preparePrintFront();
<a name="l01856"></a>01856 <span class="preprocessor">#endif</span>
<a name="l01857"></a>01857 <span class="preprocessor"></span>}
<a name="l01858"></a>01858 
<a name="l01859"></a><a class="code" href="Fl__x_8cxx.html#aaf27480fd6e20c7d66d5b45f7dc91117">01859</a> <a class="code" href="mac_8H.html#aad9fe48cacd960402308a6a7f9f5e584">Window</a> <a class="code" href="win32_8H.html#afdab6664143864c36ba6b51782b32500">fl_window</a>;
<a name="l01860"></a>01860 <a class="code" href="classFl__Window.html">Fl_Window</a> *<a class="code" href="classFl__Window.html#ab9f4f5ec887ad5f4eac561eb02a97402">Fl_Window::current_</a>;
<a name="l01861"></a><a class="code" href="Fl__x_8cxx.html#a09c6113072b52a19551b684706d41417">01861</a> GC <a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>;
<a name="l01862"></a>01862 
<a name="l01863"></a>01863 <span class="comment">// make X drawing go into this window (called by subclass flush() impl.)</span>
<a name="l01864"></a>01864 <span class="keywordtype">void</span> <a class="code" href="classFl__Window.html#a65a2499309b3fdd1bed463cefa0cd1e2">Fl_Window::make_current</a>() {
<a name="l01865"></a>01865   <span class="keyword">static</span> GC <a class="code" href="test_8c.html#a5da9d24666f1955a9b5ce3d2583b823a">gc</a>; <span class="comment">// the GC used by all X windows</span>
<a name="l01866"></a>01866   <span class="keywordflow">if</span> (!gc) gc = XCreateGC(fl_display, i-&gt;xid, 0, 0);
<a name="l01867"></a>01867   fl_window = i-&gt;xid;
<a name="l01868"></a>01868   fl_gc = <a class="code" href="test_8c.html#a5da9d24666f1955a9b5ce3d2583b823a">gc</a>;
<a name="l01869"></a>01869   <a class="code" href="classFl__Window.html#ab9f4f5ec887ad5f4eac561eb02a97402">current_</a> = <span class="keyword">this</span>;
<a name="l01870"></a>01870   <a class="code" href="group__fl__drawings.html#gaa9cb59129942d660fb7472c653d3589e">fl_clip_region</a>(0);
<a name="l01871"></a>01871 
<a name="l01872"></a>01872 <span class="preprocessor">#ifdef FLTK_USE_CAIRO</span>
<a name="l01873"></a>01873 <span class="preprocessor"></span>  <span class="comment">// update the cairo_t context</span>
<a name="l01874"></a>01874   <span class="keywordflow">if</span> (Fl::cairo_autolink_context()) Fl::cairo_make_current(<span class="keyword">this</span>);
<a name="l01875"></a>01875 <span class="preprocessor">#endif</span>
<a name="l01876"></a>01876 <span class="preprocessor"></span>
<a name="l01877"></a>01877 }
<a name="l01878"></a>01878 
<a name="l01879"></a>01879 <span class="preprocessor">#ifdef USE_PRINT_BUTTON</span>
<a name="l01880"></a>01880 <span class="preprocessor"></span><span class="comment">// to test the Fl_Printer class creating a &quot;Print front window&quot; button in a separate window</span>
<a name="l01881"></a>01881 <span class="comment">// contains also preparePrintFront call above</span>
<a name="l01882"></a>01882 <span class="preprocessor">#include &lt;FL/Fl_Printer.H&gt;</span>
<a name="l01883"></a>01883 <span class="preprocessor">#include &lt;FL/Fl_Button.H&gt;</span>
<a name="l01884"></a>01884 <span class="keywordtype">void</span> printFront(<a class="code" href="classFl__Widget.html">Fl_Widget</a> *o, <span class="keywordtype">void</span> *<a class="code" href="jpeglib_8h.html#ae5784a8f4db42de0ffacd0cbd08dc6ad">data</a>)
<a name="l01885"></a>01885 {
<a name="l01886"></a>01886   <a class="code" href="classFl__Printer.html" title="OS-independent print support.">Fl_Printer</a> printer;
<a name="l01887"></a>01887   o-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>()-&gt;<a class="code" href="classFl__Window.html#acd69a335bdc69f5624301f267ca7f94e">hide</a>();
<a name="l01888"></a>01888   <a class="code" href="classFl__Window.html">Fl_Window</a> *win = <a class="code" href="group__fl__windows.html#ga3130407bc1c11f9b7f2a9c43a87a1599">Fl::first_window</a>();
<a name="l01889"></a>01889   <span class="keywordflow">if</span>(!win) <span class="keywordflow">return</span>;
<a name="l01890"></a>01890   <span class="keywordtype">int</span> <a class="code" href="forms_8H-2.html#aac374e320caaadeca4874add33b62af2">w</a>, <a class="code" href="forms_8H-2.html#a7e427ba5b307f9068129699250690066">h</a>;
<a name="l01891"></a>01891   <span class="keywordflow">if</span>( printer.<a class="code" href="classFl__Printer.html#a8f3603112736f55dd08ef7ad4aaed551" title="Starts a print job.">start_job</a>(1) ) { o-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>()-&gt;<a class="code" href="classFl__Window.html#afc4d3796226dfd4620b4d7cf29c287c9">show</a>(); <span class="keywordflow">return</span>; }
<a name="l01892"></a>01892   <span class="keywordflow">if</span>( printer.<a class="code" href="classFl__Printer.html#aa7c9294391ecebe05a59b868fe16bac1" title="Starts a new printed page.">start_page</a>() ) { o-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>()-&gt;<a class="code" href="classFl__Window.html#afc4d3796226dfd4620b4d7cf29c287c9">show</a>(); <span class="keywordflow">return</span>; }
<a name="l01893"></a>01893   printer.<a class="code" href="classFl__Printer.html#ae7d6d14dd0c0711634f38c599811db9c" title="Computes the width and height of the printable area of the page.">printable_rect</a>(&amp;w,&amp;h);
<a name="l01894"></a>01894   <span class="comment">// scale the printer device so that the window fits on the page</span>
<a name="l01895"></a>01895   <span class="keywordtype">float</span> scale = 1;
<a name="l01896"></a>01896   <span class="keywordflow">if</span> (win-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>() &gt; w || win-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>() &gt; <a class="code" href="forms_8H-2.html#a7e427ba5b307f9068129699250690066">h</a>) {
<a name="l01897"></a>01897     scale = (float)w/win-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>();
<a name="l01898"></a>01898     <span class="keywordflow">if</span> ((<span class="keywordtype">float</span>)h/win-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>() &lt; scale) scale = (<span class="keywordtype">float</span>)h/win-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>();
<a name="l01899"></a>01899     printer.<a class="code" href="classFl__Printer.html#a3016929f51bfa77c9e680f33d8a2227f" title="Changes the scaling of page coordinates.">scale</a>(scale, scale);
<a name="l01900"></a>01900   }
<a name="l01901"></a>01901 
<a name="l01902"></a>01902 <span class="comment">// #define ROTATE 20.0</span>
<a name="l01903"></a>01903 <span class="preprocessor">#ifdef ROTATE</span>
<a name="l01904"></a>01904 <span class="preprocessor"></span>  printer.<a class="code" href="classFl__Printer.html#a3016929f51bfa77c9e680f33d8a2227f" title="Changes the scaling of page coordinates.">scale</a>(scale * 0.8, scale * 0.8);
<a name="l01905"></a>01905   printer.<a class="code" href="classFl__Printer.html#ae7d6d14dd0c0711634f38c599811db9c" title="Computes the width and height of the printable area of the page.">printable_rect</a>(&amp;w, &amp;h);
<a name="l01906"></a>01906   printer.<a class="code" href="classFl__Printer.html#ac373a57ae77016b7c0565361323ceebc" title="Sets the position in page coordinates of the origin of graphics functions.">origin</a>(w/2, h/2 );
<a name="l01907"></a>01907   printer.<a class="code" href="classFl__Printer.html#a2c5e858532b376ee7627369c9c8b1c36" title="Rotates the graphics operations relatively to paper.">rotate</a>(ROTATE);
<a name="l01908"></a>01908   printer.<a class="code" href="classFl__Paged__Device.html#a39e2c0919372ded31a94288fc8b50a89" title="Draws the widget on the printed page.">print_widget</a>( win, - win-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>()/2, - win-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>()/2 );
<a name="l01909"></a>01909   <span class="comment">//printer.print_window_part( win, 0,0, win-&gt;w(), win-&gt;h(), - win-&gt;w()/2, - win-&gt;h()/2 );</span>
<a name="l01910"></a>01910 <span class="preprocessor">#else</span>
<a name="l01911"></a>01911 <span class="preprocessor"></span>  printer.<a class="code" href="classFl__Paged__Device.html#a39e2c0919372ded31a94288fc8b50a89" title="Draws the widget on the printed page.">print_widget</a>( win );
<a name="l01912"></a>01912   <span class="comment">//printer.print_window_part( win, 0,0,win-&gt;w(), win-&gt;h() );</span>
<a name="l01913"></a>01913 <span class="preprocessor">#endif</span>
<a name="l01914"></a>01914 <span class="preprocessor"></span>
<a name="l01915"></a>01915   printer.<a class="code" href="classFl__Printer.html#ac3afd751b80f12a11f02a6e87eeb332a" title="To be called at the end of each page.">end_page</a>();
<a name="l01916"></a>01916   printer.<a class="code" href="classFl__Printer.html#a181c505fbfba8818368f844f7276b06a" title="To be called at the end of a print job.">end_job</a>();
<a name="l01917"></a>01917   o-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>()-&gt;<a class="code" href="classFl__Window.html#afc4d3796226dfd4620b4d7cf29c287c9">show</a>();
<a name="l01918"></a>01918 }
<a name="l01919"></a>01919 
<a name="l01920"></a>01920 <span class="keywordtype">void</span> preparePrintFront(<span class="keywordtype">void</span>)
<a name="l01921"></a>01921 {
<a name="l01922"></a>01922   <span class="keyword">static</span> <span class="keywordtype">int</span> first=1;
<a name="l01923"></a>01923   <span class="keywordflow">if</span>(!first) <span class="keywordflow">return</span>;
<a name="l01924"></a>01924   first=0;
<a name="l01925"></a>01925   <span class="keyword">static</span> <a class="code" href="classFl__Window.html">Fl_Window</a> <a class="code" href="forms_8H-2.html#aac374e320caaadeca4874add33b62af2">w</a>(0,0,150,30);
<a name="l01926"></a>01926   <span class="keyword">static</span> <a class="code" href="classFl__Button.html" title="Buttons generate callbacks when they are clicked by the user.">Fl_Button</a> <a class="code" href="jpegint_8h.html#af320905358fa78701e4cc60b6135601f">b</a>(0,0,w.w(),w.h(), <span class="stringliteral">&quot;Print front window&quot;</span>);
<a name="l01927"></a>01927   b.callback(printFront);
<a name="l01928"></a>01928   w.end();
<a name="l01929"></a>01929   w.show();
<a name="l01930"></a>01930 }
<a name="l01931"></a>01931 <span class="preprocessor">#endif // USE_PRINT_BUTTON</span>
<a name="l01932"></a>01932 <span class="preprocessor"></span>
<a name="l01933"></a>01933 <span class="preprocessor">#endif</span>
<a name="l01934"></a>01934 <span class="preprocessor"></span>
<a name="l01935"></a>01935 <span class="comment">//</span>
<a name="l01936"></a>01936 <span class="comment">// End of &quot;$Id: Fl_x.cxx 8198 2011-01-06 10:24:58Z manolo $&quot;.</span>
<a name="l01937"></a>01937 <span class="comment">//</span>
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="Fl__x_8cxx.html">Fl_x.cxx</a>      </li>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="#" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3</small></address>
</body>

<!-- Mirrored from dox.sfr-fresh.com/fltk-1.3.0rc3-source/Fl__x_8cxx_source.html by HTTrack Website Copier/3.x [XR&CO'2010], Wed, 16 Feb 2011 23:42:43 GMT -->
</html>
