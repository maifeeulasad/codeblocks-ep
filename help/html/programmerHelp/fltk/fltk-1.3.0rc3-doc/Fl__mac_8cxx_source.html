<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<!-- Mirrored from dox.sfr-fresh.com/fltk-1.3.0rc3-source/Fl__mac_8cxx_source.html by HTTrack Website Copier/3.x [XR&CO'2010], Wed, 16 Feb 2011 23:41:40 GMT -->
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>SfR Fresh Dox - fltk: fltk-1.3.0rc3/src/Fl_mac.cxx Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">fltk&#160;<span id="projectnumber">1.3.0rc3</span></div>
   <div id="projectbrief">About: <A HREF= http://www.fltk.org/>FLTK</A> (Fast Light Tool Kit) is a cross-platform C++ GUI toolkit for UNIX/Linux (X11), Microsoft Windows, and MacOS X. Release candidate.<BR><IMG SRC="../warix/forest1.gif" ALT="">&nbsp;&nbsp;<A HREF="http://www.sfr-fresh.com/" TITLE="SfR Fresh Home">SfR Fresh</A> <A HREF="http://www.sfr-fresh.com/warix/features.html#doxygen" TITLE="SfR Fresh Doxygen Support Info">Dox</A>: <A HREF="../fresh/unix/misc/fltk-1.3.0rc3-source.tar.gz/index.html" TITLE="SfR Fresh: fltk-1.3.0rc3-source.tar.gz Contents &amp; Download Page">fltk-1.3.0rc3-source.tar.gz</A> ("inofficial" and yet experimental doxygen-generated source code documentation)&nbsp;&nbsp;<IMG SRC="../warix/forest2.gif" ALT=""><P></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index-2.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('Fl__mac_8cxx.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<h1>Fl_mac.cxx</h1>  </div>
</div>
<div class="contents">
<a href="Fl__mac_8cxx.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//</span>
<a name="l00002"></a>00002 <span class="comment">// &quot;$Id: Fl_mac.cxx 7913 2010-11-29 18:18:27Z greg.ercolano $&quot;</span>
<a name="l00003"></a>00003 <span class="comment">//</span>
<a name="l00004"></a>00004 <span class="comment">// MacOS specific code for the Fast Light Tool Kit (FLTK).</span>
<a name="l00005"></a>00005 <span class="comment">//</span>
<a name="l00006"></a>00006 <span class="comment">// Copyright 1998-2010 by Bill Spitzak and others.</span>
<a name="l00007"></a>00007 <span class="comment">//</span>
<a name="l00008"></a>00008 <span class="comment">// This library is free software; you can redistribute it and/or</span>
<a name="l00009"></a>00009 <span class="comment">// modify it under the terms of the GNU Library General Public</span>
<a name="l00010"></a>00010 <span class="comment">// License as published by the Free Software Foundation; either</span>
<a name="l00011"></a>00011 <span class="comment">// version 2 of the License, or (at your option) any later version.</span>
<a name="l00012"></a>00012 <span class="comment">//</span>
<a name="l00013"></a>00013 <span class="comment">// This library is distributed in the hope that it will be useful,</span>
<a name="l00014"></a>00014 <span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00015"></a>00015 <span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<a name="l00016"></a>00016 <span class="comment">// Library General Public License for more details.</span>
<a name="l00017"></a>00017 <span class="comment">//</span>
<a name="l00018"></a>00018 <span class="comment">// You should have received a copy of the GNU Library General Public</span>
<a name="l00019"></a>00019 <span class="comment">// License along with this library; if not, write to the Free Software</span>
<a name="l00020"></a>00020 <span class="comment">// Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307</span>
<a name="l00021"></a>00021 <span class="comment">// USA.</span>
<a name="l00022"></a>00022 <span class="comment">//</span>
<a name="l00023"></a>00023 <span class="comment">// Please report all bugs and problems on the following page:</span>
<a name="l00024"></a>00024 <span class="comment">//</span>
<a name="l00025"></a>00025 <span class="comment">//     http://www.fltk.org/str.php</span>
<a name="l00026"></a>00026 <span class="comment">//</span>
<a name="l00027"></a>00027 
<a name="l00029"></a>00029 <span class="comment">// (without permission)</span>
<a name="l00030"></a>00030 <span class="comment">//</span>
<a name="l00031"></a>00031 <span class="comment">// &quot;Three Compiles for 68Ks under the sky,</span>
<a name="l00032"></a>00032 <span class="comment">// Seven Compiles for PPCs in their fragments of code,</span>
<a name="l00033"></a>00033 <span class="comment">// Nine Compiles for Mortal Carbon doomed to die,</span>
<a name="l00034"></a>00034 <span class="comment">// One Compile for Mach-O Cocoa on its Mach-O throne,</span>
<a name="l00035"></a>00035 <span class="comment">// in the Land of MacOS X where the Drop-Shadows lie.</span>
<a name="l00036"></a>00036 <span class="comment">// </span>
<a name="l00037"></a>00037 <span class="comment">// One Compile to link them all, One Compile to merge them,</span>
<a name="l00038"></a>00038 <span class="comment">// One Compile to copy them all and in the bundle bind them,</span>
<a name="l00039"></a>00039 <span class="comment">// in the Land of MacOS X where the Drop-Shadows lie.&quot;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="comment">// warning: the Apple Quartz version still uses some Quickdraw calls,</span>
<a name="l00042"></a>00042 <span class="comment">//          mostly to get around the single active context in QD and </span>
<a name="l00043"></a>00043 <span class="comment">//          to implement clipping. This should be changed into pure</span>
<a name="l00044"></a>00044 <span class="comment">//          Quartz calls in the near future.</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="comment">// FIXME moving away from Carbon, I am replacing the Scrap manager calls with Pasteboard</span>
<a name="l00047"></a>00047 <span class="comment">//       calls that support utf8 encoding. As soon as these function haven proven working</span>
<a name="l00048"></a>00048 <span class="comment">//       the Scrap manager calls should be removed</span>
<a name="l00049"></a><a class="code" href="Fl__mac_8cxx.html#a6b111286e84c1f7b475b0c7fad4bedc6">00049</a> <span class="preprocessor">#define USE_PASTEBOARD 1</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span>
<a name="l00051"></a>00051 <span class="comment">// we don&#39;t need the following definition because we deliver only</span>
<a name="l00052"></a>00052 <span class="comment">// true mouse moves.  On very slow systems however, this flag may</span>
<a name="l00053"></a>00053 <span class="comment">// still be useful.</span>
<a name="l00054"></a>00054 <span class="preprocessor">#ifndef FL_DOXYGEN</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span>
<a name="l00056"></a><a class="code" href="Fl__mac_8cxx.html#a19f68d90e21d88dd84cec78155e10057">00056</a> <span class="preprocessor">#define CONSOLIDATE_MOTION 0</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> {
<a name="l00058"></a>00058 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
<a name="l00059"></a>00059 }
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <span class="preprocessor">#include &lt;config.h&gt;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &lt;FL/Fl.H&gt;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &lt;FL/x.H&gt;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &lt;FL/Fl_Window.H&gt;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &lt;FL/Fl_Tooltip.H&gt;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &lt;FL/Fl_Sys_Menu_Bar.H&gt;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="flstring_8h.html">flstring.h</a>&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00071"></a>00071 
<a name="l00072"></a>00072 <span class="comment">// #define DEBUG_SELECT         // UNCOMMENT FOR SELECT()/THREAD DEBUGGING</span>
<a name="l00073"></a>00073 <span class="preprocessor">#ifdef DEBUG_SELECT</span>
<a name="l00074"></a>00074 <span class="preprocessor"></span><span class="preprocessor">#include &lt;stdio.h&gt;</span>              <span class="comment">// testing</span>
<a name="l00075"></a>00075 <span class="preprocessor">#define DEBUGMSG(msg)           if ( msg ) fprintf(stderr, msg);</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span><span class="preprocessor">#define DEBUGPERRORMSG(msg)     if ( msg ) perror(msg)</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span><span class="preprocessor">#define DEBUGTEXT(txt)          txt</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00079"></a><a class="code" href="Fl__mac_8cxx.html#aed6d1186912238eabd7672078a396423">00079</a> <span class="preprocessor"></span><span class="preprocessor">#define DEBUGMSG(msg)</span>
<a name="l00080"></a><a class="code" href="Fl__mac_8cxx.html#a25f5d39fe70418b682112dac0ded04bd">00080</a> <span class="preprocessor"></span><span class="preprocessor">#define DEBUGPERRORMSG(msg)</span>
<a name="l00081"></a><a class="code" href="Fl__mac_8cxx.html#a52ec816ebb31da9a8f9adf9ea690afcd">00081</a> <span class="preprocessor"></span><span class="preprocessor">#define DEBUGTEXT(txt)          NULL</span>
<a name="l00082"></a>00082 <span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/*DEBUG_SELECT*/</span>
<a name="l00083"></a>00083 
<a name="l00084"></a>00084 <span class="comment">// external functions</span>
<a name="l00085"></a>00085 <span class="keyword">extern</span> <a class="code" href="classFl__Window.html">Fl_Window</a>* <a class="code" href="win32_8H.html#a4f60f8f2a47f584ee83dd0118a058cfe">fl_find</a>(<a class="code" href="mac_8H.html#aad9fe48cacd960402308a6a7f9f5e584">Window</a>);
<a name="l00086"></a>00086 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="Fl_8cxx.html#afe3a0306383e206c9b1e04accc9a28e7">fl_fix_focus</a>();
<a name="l00087"></a>00087 
<a name="l00088"></a>00088 <span class="comment">// forward definition of functions in this file</span>
<a name="l00089"></a>00089 <span class="keyword">static</span> <span class="keywordtype">void</span> handleUpdateEvent( WindowPtr xid );
<a name="l00090"></a>00090 <span class="comment">//+ int fl_handle(const EventRecord &amp;event);</span>
<a name="l00091"></a>00091 <span class="keyword">static</span> <span class="keywordtype">int</span> FSSpec2UnixPath( FSSpec *fs, <span class="keywordtype">char</span> *dst );
<a name="l00092"></a>00092 <span class="comment">// converting cr lf converter function</span>
<a name="l00093"></a>00093 <span class="keyword">static</span> <span class="keywordtype">void</span> convert_crlf(<span class="keywordtype">char</span> * <span class="keywordtype">string</span>, <span class="keywordtype">size_t</span> len);
<a name="l00094"></a>00094 
<a name="l00095"></a>00095 <span class="comment">// public variables</span>
<a name="l00096"></a><a class="code" href="Fl__mac_8cxx.html#acedaca348d9ac3c07191b8255ef979b7">00096</a> <span class="keywordtype">int</span> <a class="code" href="x_8H.html#a42a55d8c59138d9f0fa899491c25560c">fl_screen</a>;
<a name="l00097"></a><a class="code" href="Fl__mac_8cxx.html#a34fa7427998af327143f335a71a66733">00097</a> CGContextRef <a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a> = 0;
<a name="l00098"></a><a class="code" href="Fl__mac_8cxx.html#aa47c81d9e111e268551357524ebb5e4e">00098</a> Handle <a class="code" href="Fl__mac_8cxx.html#aa47c81d9e111e268551357524ebb5e4e">fl_system_menu</a>;
<a name="l00099"></a><a class="code" href="Fl__mac_8cxx.html#a6f198d969c23a02551e63d9522472adb">00099</a> <a class="code" href="classFl__Menu__Bar.html">Fl_Sys_Menu_Bar</a> *<a class="code" href="mac_8H.html#a280df7c0e317a4b5eb8bbc426f90d1f2">fl_sys_menu_bar</a> = 0;
<a name="l00100"></a><a class="code" href="Fl__mac_8cxx.html#a5a63629d237363541566794448efb669">00100</a> CursHandle <a class="code" href="win32_8H.html#a5c84f195de614f6aa79fa2f8883b37b6">fl_default_cursor</a>;
<a name="l00101"></a><a class="code" href="Fl__mac_8cxx.html#a6e10f30f9e6dd98ed093691fd605a0c2">00101</a> WindowRef <a class="code" href="Fl__mac_8cxx.html#a6e10f30f9e6dd98ed093691fd605a0c2">fl_capture</a> = 0;            <span class="comment">// we need this to compensate for a missing(?) mouse capture</span>
<a name="l00102"></a><a class="code" href="Fl__mac_8cxx.html#a24b7ca526c7d917ebeaa2202cf1306c3">00102</a> <a class="code" href="fl__types_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a> <a class="code" href="x_8H.html#a5112b03f22e38209736b7d21a6d100ab">fl_event_time</a>;                 <span class="comment">// the last timestamp from an x event</span>
<a name="l00103"></a><a class="code" href="Fl__mac_8cxx.html#a0f446f8a60dc49a63934246501120231">00103</a> <span class="keywordtype">char</span> <a class="code" href="Fl__get__key_8cxx.html#a0f446f8a60dc49a63934246501120231">fl_key_vector</a>[32];              <span class="comment">// used by Fl::get_key()</span>
<a name="l00104"></a><a class="code" href="Fl__Window__iconize_8cxx.html#aeed6a7220f140808e50ef846ef0ad3c2">00104</a> <span class="keywordtype">bool</span> <a class="code" href="Fl__arg_8cxx.html#aeed6a7220f140808e50ef846ef0ad3c2">fl_show_iconic</a>;                 <span class="comment">// true if called from iconize() - shows the next created window in collapsed state</span>
<a name="l00105"></a><a class="code" href="Fl__mac_8cxx.html#a3635433c445a0e91b41396116930abbd">00105</a> <span class="keywordtype">int</span> <a class="code" href="Fl__mac_8cxx.html#a3635433c445a0e91b41396116930abbd">fl_disable_transient_for</a>;        <span class="comment">// secret method of removing TRANSIENT_FOR</span>
<a name="l00106"></a><a class="code" href="Fl__mac_8cxx.html#a2f4d39f161f293852efeb63fa94c39a0">00106</a> <span class="keyword">const</span> <a class="code" href="classFl__Window.html">Fl_Window</a>* <a class="code" href="Fl__mac_8cxx.html#a2f4d39f161f293852efeb63fa94c39a0">fl_modal_for</a>;       <span class="comment">// parent of modal() window</span>
<a name="l00107"></a><a class="code" href="Fl__mac_8cxx.html#afe6a785e40298db77c700ceb9b6f7193">00107</a> <a class="code" href="mac_8H.html#aa3f54ef9dd28ee61ae42bd36291a31f2">Fl_Region</a> <a class="code" href="Fl__mac_8cxx.html#afe6a785e40298db77c700ceb9b6f7193">fl_window_region</a> = 0;
<a name="l00108"></a><a class="code" href="Fl__mac_8cxx.html#aaf27480fd6e20c7d66d5b45f7dc91117">00108</a> <a class="code" href="mac_8H.html#aad9fe48cacd960402308a6a7f9f5e584">Window</a> <a class="code" href="win32_8H.html#afdab6664143864c36ba6b51782b32500">fl_window</a>;
<a name="l00109"></a>00109 <a class="code" href="classFl__Window.html">Fl_Window</a> *<a class="code" href="classFl__Window.html#ab9f4f5ec887ad5f4eac561eb02a97402">Fl_Window::current_</a>;
<a name="l00110"></a><a class="code" href="Fl__mac_8cxx.html#a7c133406e3b2a07466b73cf6cc0aaa50">00110</a> EventRef <a class="code" href="Fl__mac_8cxx.html#a7c133406e3b2a07466b73cf6cc0aaa50">fl_os_event</a>;           <span class="comment">// last (mouse) event</span>
<a name="l00111"></a>00111 
<a name="l00112"></a>00112 <span class="comment">// forward declarations of variables in this file</span>
<a name="l00113"></a>00113 <span class="keyword">static</span> <span class="keywordtype">int</span> got_events = 0;
<a name="l00114"></a>00114 <span class="keyword">static</span> <a class="code" href="classFl__Window.html">Fl_Window</a>* resize_from_system;
<a name="l00115"></a>00115 <span class="keyword">static</span> CursPtr default_cursor_ptr;
<a name="l00116"></a>00116 <span class="keyword">static</span> Cursor default_cursor;
<a name="l00117"></a>00117 <span class="keyword">static</span> WindowRef fl_os_capture = 0; <span class="comment">// the dispatch handler will redirect mose move and drag events to these windows</span>
<a name="l00118"></a>00118 
<a name="l00119"></a>00119 <span class="preprocessor">#if CONSOLIDATE_MOTION</span>
<a name="l00120"></a>00120 <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="classFl__Window.html">Fl_Window</a>* send_motion;
<a name="l00121"></a>00121 <span class="keyword">extern</span> <a class="code" href="classFl__Window.html">Fl_Window</a>* <a class="code" href="Fl_8cxx.html#aa4a35d324647e7c092666054a4e58596">fl_xmousewin</a>;
<a name="l00122"></a>00122 <span class="preprocessor">#endif</span>
<a name="l00123"></a>00123 <span class="preprocessor"></span>
<a name="l00124"></a><a class="code" href="Fl__mac_8cxx.html#a2970898e8a43ce21e1cc510d49f1b89da4d1fadb014d21f05dc6f3821424edb12">00124</a> <span class="keyword">enum</span> { <a class="code" href="Fl__mac_8cxx.html#a2970898e8a43ce21e1cc510d49f1b89da4d1fadb014d21f05dc6f3821424edb12">kEventClassFLTK</a> = <span class="stringliteral">&#39;fltk&#39;</span> };
<a name="l00125"></a><a class="code" href="Fl__mac_8cxx.html#afa231099d07583c3ed0981e0bb665f55ad38bac2c71d5ad1aff0cc34bab67ac08">00125</a> <span class="keyword">enum</span> { <a class="code" href="Fl__mac_8cxx.html#afa231099d07583c3ed0981e0bb665f55a13872f920fa565fdc265324fd95c273b">kEventFLTKBreakLoop</a> = 1, <a class="code" href="Fl__mac_8cxx.html#afa231099d07583c3ed0981e0bb665f55ad38bac2c71d5ad1aff0cc34bab67ac08">kEventFLTKDataReady</a> };
<a name="l00126"></a>00126 
<a name="l00127"></a>00127 <span class="comment">/* fltk-utf8 placekeepers */</span>
<a name="l00128"></a><a class="code" href="group__fl__drawings.html#gaa6c8068dbc30f05765330e31f08350d7">00128</a> <span class="keywordtype">void</span> <a class="code" href="group__fl__drawings.html#gaa6c8068dbc30f05765330e31f08350d7">fl_reset_spot</a>()
<a name="l00129"></a>00129 {
<a name="l00130"></a>00130 }
<a name="l00131"></a>00131 
<a name="l00132"></a><a class="code" href="group__fl__drawings.html#ga748fcead12c8cc67cb517cab02c273a2">00132</a> <span class="keywordtype">void</span> <a class="code" href="group__fl__drawings.html#ga748fcead12c8cc67cb517cab02c273a2">fl_set_spot</a>(<span class="keywordtype">int</span> font, <span class="keywordtype">int</span> <a class="code" href="png_8h.html#a43291b8493b637821dec145c4bb1503d">size</a>, <span class="keywordtype">int</span> X, <span class="keywordtype">int</span> Y, <span class="keywordtype">int</span> W, <span class="keywordtype">int</span> <a class="code" href="Fl__Tooltip_8cxx.html#affa487e8e3cc48473cfc05c0ce0165e9">H</a>, <a class="code" href="classFl__Window.html">Fl_Window</a> *win)
<a name="l00133"></a>00133 {
<a name="l00134"></a>00134 }
<a name="l00135"></a>00135 
<a name="l00136"></a><a class="code" href="group__fl__drawings.html#ga496c7d22ad30fe84717bb765dd6d1fc8">00136</a> <span class="keywordtype">void</span> <a class="code" href="group__fl__drawings.html#ga496c7d22ad30fe84717bb765dd6d1fc8">fl_set_status</a>(<span class="keywordtype">int</span> <a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>, <span class="keywordtype">int</span> <a class="code" href="test_8c.html#a0a2f84ed7838f07779ae24c5a9086d33">y</a>, <span class="keywordtype">int</span> <a class="code" href="forms_8H-2.html#aac374e320caaadeca4874add33b62af2">w</a>, <span class="keywordtype">int</span> <a class="code" href="forms_8H-2.html#a7e427ba5b307f9068129699250690066">h</a>)
<a name="l00137"></a>00137 {
<a name="l00138"></a>00138 }
<a name="l00139"></a>00139 
<a name="l00143"></a>00143 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> macKeyLookUp[128] =
<a name="l00144"></a>00144 {
<a name="l00145"></a>00145     <span class="charliteral">&#39;a&#39;</span>, <span class="charliteral">&#39;s&#39;</span>, <span class="charliteral">&#39;d&#39;</span>, <span class="charliteral">&#39;f&#39;</span>, <span class="charliteral">&#39;h&#39;</span>, <span class="charliteral">&#39;g&#39;</span>, <span class="charliteral">&#39;z&#39;</span>, <span class="charliteral">&#39;x&#39;</span>,
<a name="l00146"></a>00146     <span class="charliteral">&#39;c&#39;</span>, <span class="charliteral">&#39;v&#39;</span>, <span class="charliteral">&#39;^&#39;</span>, <span class="charliteral">&#39;b&#39;</span>, <span class="charliteral">&#39;q&#39;</span>, <span class="charliteral">&#39;w&#39;</span>, <span class="charliteral">&#39;e&#39;</span>, <span class="charliteral">&#39;r&#39;</span>,
<a name="l00147"></a>00147 
<a name="l00148"></a>00148     <span class="charliteral">&#39;y&#39;</span>, <span class="charliteral">&#39;t&#39;</span>, <span class="charliteral">&#39;1&#39;</span>, <span class="charliteral">&#39;2&#39;</span>, <span class="charliteral">&#39;3&#39;</span>, <span class="charliteral">&#39;4&#39;</span>, <span class="charliteral">&#39;6&#39;</span>, <span class="charliteral">&#39;5&#39;</span>,
<a name="l00149"></a>00149     <span class="charliteral">&#39;=&#39;</span>, <span class="charliteral">&#39;9&#39;</span>, <span class="charliteral">&#39;7&#39;</span>, <span class="charliteral">&#39;-&#39;</span>, <span class="charliteral">&#39;8&#39;</span>, <span class="charliteral">&#39;0&#39;</span>, <span class="charliteral">&#39;]&#39;</span>, <span class="charliteral">&#39;o&#39;</span>,
<a name="l00150"></a>00150 
<a name="l00151"></a>00151     <span class="charliteral">&#39;u&#39;</span>, <span class="charliteral">&#39;[&#39;</span>, <span class="charliteral">&#39;i&#39;</span>, <span class="charliteral">&#39;p&#39;</span>, <a class="code" href="Enumerations_8H.html#ab4a527fe4d93303976de2fbfec05e19b" title="The enter key.">FL_Enter</a>, <span class="charliteral">&#39;l&#39;</span>, <span class="charliteral">&#39;j&#39;</span>, <span class="charliteral">&#39;\&#39;&#39;</span>,
<a name="l00152"></a>00152     <span class="charliteral">&#39;k&#39;</span>, <span class="charliteral">&#39;;&#39;</span>, <span class="charliteral">&#39;\\&#39;</span>, <span class="charliteral">&#39;,&#39;</span>, <span class="charliteral">&#39;/&#39;</span>, <span class="charliteral">&#39;n&#39;</span>, <span class="charliteral">&#39;m&#39;</span>, <span class="charliteral">&#39;.&#39;</span>,
<a name="l00153"></a>00153 
<a name="l00154"></a>00154     <a class="code" href="Enumerations_8H.html#aa6e3e7f377cecb30c77f112ce54c3753" title="The tab key.">FL_Tab</a>, <span class="charliteral">&#39; &#39;</span>, <span class="charliteral">&#39;`&#39;</span>, <a class="code" href="Enumerations_8H.html#a20dc86e7758a88b4d1f06323e2de9896" title="The backspace key.">FL_BackSpace</a>, 
<a name="l00155"></a>00155     <a class="code" href="Enumerations_8H.html#af6ac160165f8c2747488175321f45a63" title="The enter key on the keypad, same as Fl_KP+&amp;#39;\r&amp;#39;.">FL_KP_Enter</a>, <a class="code" href="Enumerations_8H.html#a91b983ebe4cd86393e2addb8ab40a326" title="The escape key.">FL_Escape</a>, 0, 0<span class="comment">/*FL_Meta_L*/</span>,
<a name="l00156"></a>00156     0<span class="comment">/*FL_Shift_L*/</span>, 0<span class="comment">/*FL_Caps_Lock*/</span>, 0<span class="comment">/*FL_Alt_L*/</span>, 0<span class="comment">/*FL_Control_L*/</span>, 
<a name="l00157"></a>00157     0<span class="comment">/*FL_Shift_R*/</span>, 0<span class="comment">/*FL_Alt_R*/</span>, 0<span class="comment">/*FL_Control_R*/</span>, 0,
<a name="l00158"></a>00158 
<a name="l00159"></a>00159     0, <a class="code" href="Enumerations_8H.html#a61cc4275772d96a740bef9261cca5760" title="One of the keypad numbers; use FL_KP + n for number n.">FL_KP</a>+<span class="charliteral">&#39;.&#39;</span>, <a class="code" href="Enumerations_8H.html#a45679ed656e6b248319719719e894f13" title="The right arrow key.">FL_Right</a>, FL_KP+<span class="charliteral">&#39;*&#39;</span>, 0, FL_KP+<span class="charliteral">&#39;+&#39;</span>, <a class="code" href="Enumerations_8H.html#afe89caa1c5019809095a6129156f7c5a" title="The left arrow key.">FL_Left</a>, <a class="code" href="Enumerations_8H.html#a323fcf5bab321ec05826a6510a0f1d5a" title="The delete key.">FL_Delete</a>,
<a name="l00160"></a>00160     <a class="code" href="Enumerations_8H.html#a7b70dabd5fc84d90552442584a0e8b91" title="The down arrow key.">FL_Down</a>, 0, 0, FL_KP+<span class="charliteral">&#39;/&#39;</span>, <a class="code" href="Enumerations_8H.html#af6ac160165f8c2747488175321f45a63" title="The enter key on the keypad, same as Fl_KP+&amp;#39;\r&amp;#39;.">FL_KP_Enter</a>, <a class="code" href="Enumerations_8H.html#a050700391ba0940ca16b0e5dbf4644f0" title="The up arrow key.">FL_Up</a>, FL_KP+<span class="charliteral">&#39;-&#39;</span>, 0,
<a name="l00161"></a>00161 
<a name="l00162"></a>00162     0, FL_KP+<span class="charliteral">&#39;=&#39;</span>, FL_KP+<span class="charliteral">&#39;0&#39;</span>, FL_KP+<span class="charliteral">&#39;1&#39;</span>, FL_KP+<span class="charliteral">&#39;2&#39;</span>, FL_KP+<span class="charliteral">&#39;3&#39;</span>, FL_KP+<span class="charliteral">&#39;4&#39;</span>, FL_KP+<span class="charliteral">&#39;5&#39;</span>,
<a name="l00163"></a>00163     FL_KP+<span class="charliteral">&#39;6&#39;</span>, FL_KP+<span class="charliteral">&#39;7&#39;</span>, 0, FL_KP+<span class="charliteral">&#39;8&#39;</span>, FL_KP+<span class="charliteral">&#39;9&#39;</span>, 0, 0, 0,
<a name="l00164"></a>00164 
<a name="l00165"></a>00165     <a class="code" href="Enumerations_8H.html#ae793aa65307884c2ad99893508d844f2" title="One of the function keys; use FL_F + n for function key n.">FL_F</a>+5, FL_F+6, FL_F+7, FL_F+3, FL_F+8, FL_F+9, 0, FL_F+11,
<a name="l00166"></a>00166     0, 0<span class="comment">/*FL_F+13*/</span>, <a class="code" href="Enumerations_8H.html#a4b01dd00e8057590d3778a41920cf80f" title="The print (or print-screen) key.">FL_Print</a>, <a class="code" href="Enumerations_8H.html#a75315b814f32abe29e7b8d0c43be54d9" title="The scroll lock key.">FL_Scroll_Lock</a>, 0, FL_F+10, <a class="code" href="Enumerations_8H.html#a3a59855ebd5a902cda138956b5ac80bb" title="The menu key.">FL_Menu</a>, FL_F+12,
<a name="l00167"></a>00167 
<a name="l00168"></a>00168     0, <a class="code" href="Enumerations_8H.html#a701e11753a0c38777cb49989de8f0195" title="The pause key.">FL_Pause</a>, <a class="code" href="Enumerations_8H.html#aea65b2b57d3d83d1359df6fc538ff0a9" title="The &amp;#39;help&amp;#39; key on Mac keyboards.">FL_Help</a>, <a class="code" href="Enumerations_8H.html#a6fecadc9ecc21f06822c79ced2e45932" title="The home key.">FL_Home</a>, <a class="code" href="Enumerations_8H.html#a35834a5c204afffb06374e25734b5c76" title="The page-up key.">FL_Page_Up</a>, <a class="code" href="Enumerations_8H.html#a323fcf5bab321ec05826a6510a0f1d5a" title="The delete key.">FL_Delete</a>, FL_F+4, <a class="code" href="Enumerations_8H.html#a3278d6209799b821e07369aa5dc140ac" title="The end key.">FL_End</a>,
<a name="l00169"></a>00169     FL_F+2, <a class="code" href="Enumerations_8H.html#ada4d587d21ab710f44043dafba88e110" title="The page-down key.">FL_Page_Down</a>, FL_F+1, <a class="code" href="Enumerations_8H.html#afe89caa1c5019809095a6129156f7c5a" title="The left arrow key.">FL_Left</a>, <a class="code" href="Enumerations_8H.html#a45679ed656e6b248319719719e894f13" title="The right arrow key.">FL_Right</a>, <a class="code" href="Enumerations_8H.html#a7b70dabd5fc84d90552442584a0e8b91" title="The down arrow key.">FL_Down</a>, <a class="code" href="Enumerations_8H.html#a050700391ba0940ca16b0e5dbf4644f0" title="The up arrow key.">FL_Up</a>, 0<span class="comment">/*FL_Power*/</span>,
<a name="l00170"></a>00170 };
<a name="l00171"></a>00171 
<a name="l00175"></a>00175 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> mods_to_e_state( UInt32 mods )
<a name="l00176"></a>00176 {
<a name="l00177"></a>00177   <span class="keywordtype">long</span> <a class="code" href="Fl__Text__Editor_8cxx.html#a89f234133d3efe315836311cbf21c64b">state</a> = 0;
<a name="l00178"></a>00178   <span class="keywordflow">if</span> ( mods &amp; kEventKeyModifierNumLockMask ) state |= <a class="code" href="Enumerations_8H.html#af4708895fdb16d3982408fee68ba502b" title="The num lock is on.">FL_NUM_LOCK</a>;
<a name="l00179"></a>00179   <span class="keywordflow">if</span> ( mods &amp; cmdKey ) state |= <a class="code" href="Enumerations_8H.html#a2c50b1b00111f992d5d49f07c9cee22a" title="One of the meta/Windows keys is down.">FL_META</a>;
<a name="l00180"></a>00180   <span class="keywordflow">if</span> ( mods &amp; (optionKey|rightOptionKey) ) state |= <a class="code" href="Enumerations_8H.html#a58b1ac5446b292c77043f99558eb07cb" title="One of the alt keys is down.">FL_ALT</a>;
<a name="l00181"></a>00181   <span class="keywordflow">if</span> ( mods &amp; (controlKey|rightControlKey) ) state |= <a class="code" href="Enumerations_8H.html#a29324ec5ac8c1d87950127d387dc83e8" title="One of the ctrl keys is down.">FL_CTRL</a>;
<a name="l00182"></a>00182   <span class="keywordflow">if</span> ( mods &amp; (shiftKey|rightShiftKey) ) state |= <a class="code" href="Enumerations_8H.html#aa0d93ca1bc8a0c7f84888cdf458f043d" title="One of the shift keys is down.">FL_SHIFT</a>;
<a name="l00183"></a>00183   <span class="keywordflow">if</span> ( mods &amp; alphaLock ) state |= <a class="code" href="Enumerations_8H.html#add5e55eea768b7bbc0cd25a2455811f0" title="The caps lock is on.">FL_CAPS_LOCK</a>;
<a name="l00184"></a>00184   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ret = ( <a class="code" href="classFl.html#a2d93787aec60cb62a759b36267dd9d06">Fl::e_state</a> &amp; 0xff000000 ) | state;
<a name="l00185"></a>00185   <a class="code" href="classFl.html#a2d93787aec60cb62a759b36267dd9d06">Fl::e_state</a> = ret;
<a name="l00186"></a>00186   <span class="comment">//printf( &quot;State 0x%08x (%04x)\n&quot;, Fl::e_state, mods );</span>
<a name="l00187"></a>00187   <span class="keywordflow">return</span> ret;
<a name="l00188"></a>00188 }
<a name="l00189"></a>00189 
<a name="l00190"></a>00190 
<a name="l00194"></a>00194 <span class="keyword">static</span> <span class="keywordtype">void</span> mods_to_e_keysym( UInt32 mods )
<a name="l00195"></a>00195 {
<a name="l00196"></a>00196   <span class="keywordflow">if</span> ( mods &amp; cmdKey ) <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> = <a class="code" href="Enumerations_8H.html#acbd392478a5e61f341fe44e24890e213" title="The left meta/Windows key.">FL_Meta_L</a>;
<a name="l00197"></a>00197   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( mods &amp; kEventKeyModifierNumLockMask ) <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> = <a class="code" href="Enumerations_8H.html#acf1721eb766274a915bed57acf0e7636" title="The num lock key.">FL_Num_Lock</a>;
<a name="l00198"></a>00198   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( mods &amp; optionKey ) <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> = <a class="code" href="Enumerations_8H.html#a94997ca62280cddce9327c32a256b61a" title="The left alt key.">FL_Alt_L</a>;
<a name="l00199"></a>00199   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( mods &amp; rightOptionKey ) <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> = <a class="code" href="Enumerations_8H.html#aa06e5417c1a4f46e591950c1a2c28301" title="The right alt key.">FL_Alt_R</a>;
<a name="l00200"></a>00200   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( mods &amp; controlKey ) <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> = <a class="code" href="Enumerations_8H.html#adefca9b73c422d3dadf3fa555d1fb913" title="The lefthand control key.">FL_Control_L</a>;
<a name="l00201"></a>00201   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( mods &amp; rightControlKey ) <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> = <a class="code" href="Enumerations_8H.html#aecba53654154e1c0b22351106636ea79" title="The righthand control key.">FL_Control_R</a>;
<a name="l00202"></a>00202   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( mods &amp; shiftKey ) <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> = <a class="code" href="Enumerations_8H.html#ab81acb8d22583da65645c45cb2da1bed" title="The lefthand shift key.">FL_Shift_L</a>;
<a name="l00203"></a>00203   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( mods &amp; rightShiftKey ) <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> = <a class="code" href="Enumerations_8H.html#a223901295f3b3157bd082a772f20da77" title="The righthand shift key.">FL_Shift_R</a>;
<a name="l00204"></a>00204   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( mods &amp; alphaLock ) <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> = <a class="code" href="Enumerations_8H.html#a55c0fc2c4fdd81b243e9036b536484e3" title="The caps lock key.">FL_Caps_Lock</a>;
<a name="l00205"></a>00205   <span class="keywordflow">else</span> <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> = 0;
<a name="l00206"></a>00206   <span class="comment">//printf( &quot;to sym 0x%08x (%04x)\n&quot;, Fl::e_keysym, mods );</span>
<a name="l00207"></a>00207 }
<a name="l00208"></a>00208 <span class="comment">// these pointers are set by the Fl::lock() function:</span>
<a name="l00209"></a>00209 <span class="keyword">static</span> <span class="keywordtype">void</span> nothing() {}
<a name="l00210"></a><a class="code" href="Fl__mac_8cxx.html#a7c231659c1d4f9ad9126b83cfbcbfb53">00210</a> <a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a> (*<a class="code" href="Fl__mac_8cxx.html#a7c231659c1d4f9ad9126b83cfbcbfb53">fl_lock_function</a>)() = nothing;
<a name="l00211"></a><a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">00211</a> <a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a> (*<a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>)() = nothing;
<a name="l00212"></a>00212 
<a name="l00213"></a>00213 <span class="comment">//</span>
<a name="l00214"></a>00214 <span class="comment">// Select interface -- how it&#39;s implemented:</span>
<a name="l00215"></a>00215 <span class="comment">//     When the user app configures one or more file descriptors to monitor</span>
<a name="l00216"></a>00216 <span class="comment">//     with Fl::add_fd(), we start a separate thread to select() the  data,</span>
<a name="l00217"></a>00217 <span class="comment">//     sending a custom OSX &#39;FLTK data ready event&#39; to the parent  thread&#39;s</span>
<a name="l00218"></a>00218 <span class="comment">//     RunApplicationLoop(), so that it triggers the data  ready  callbacks</span>
<a name="l00219"></a>00219 <span class="comment">//     in the parent thread.                               -erco 04/04/04</span>
<a name="l00220"></a>00220 <span class="comment">//     </span>
<a name="l00221"></a><a class="code" href="Fl__mac_8cxx.html#a52ac479a805051f59643588b096024ff">00221</a> <span class="preprocessor">#define POLLIN  1</span>
<a name="l00222"></a><a class="code" href="Fl__mac_8cxx.html#a91b3c67129ac7675062f316b840a0d58">00222</a> <span class="preprocessor"></span><span class="preprocessor">#define POLLOUT 4</span>
<a name="l00223"></a><a class="code" href="Fl__mac_8cxx.html#ab1c532446408c98559d4aaaeeeb99820">00223</a> <span class="preprocessor"></span><span class="preprocessor">#define POLLERR 8</span>
<a name="l00224"></a>00224 <span class="preprocessor"></span>
<a name="l00225"></a>00225 <span class="comment">// Class to handle select() &#39;data ready&#39;</span>
<a name="l00226"></a><a class="code" href="classDataReady.html">00226</a> <span class="keyword">class </span><a class="code" href="classDataReady.html">DataReady</a>
<a name="l00227"></a>00227 {
<a name="l00228"></a>00228     <span class="keyword">struct </span>FD
<a name="l00229"></a>00229     {
<a name="l00230"></a>00230       <span class="keywordtype">int</span> fd;
<a name="l00231"></a>00231       <span class="keywordtype">short</span> events;
<a name="l00232"></a>00232       <a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a> (*cb)(<a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>, <span class="keywordtype">void</span>*);
<a name="l00233"></a>00233       <span class="keywordtype">void</span>* arg;
<a name="l00234"></a>00234     };
<a name="l00235"></a>00235     <span class="keywordtype">int</span> nfds, fd_array_size;
<a name="l00236"></a>00236     FD *fds;
<a name="l00237"></a>00237     pthread_t tid;              <span class="comment">// select()&#39;s thread id</span>
<a name="l00238"></a>00238 
<a name="l00239"></a>00239     <span class="comment">// Data that needs to be locked (all start with &#39;_&#39;)</span>
<a name="l00240"></a>00240     pthread_mutex_t _datalock;  <span class="comment">// data lock</span>
<a name="l00241"></a>00241     fd_set _fdsets[3];          <span class="comment">// r/w/x sets user wants to monitor</span>
<a name="l00242"></a>00242     <span class="keywordtype">int</span> _maxfd;                 <span class="comment">// max fd count to monitor</span>
<a name="l00243"></a>00243     <span class="keywordtype">int</span> _cancelpipe[2];         <span class="comment">// pipe used to help cancel thread</span>
<a name="l00244"></a>00244     <span class="keywordtype">void</span> *_userdata;            <span class="comment">// thread&#39;s userdata</span>
<a name="l00245"></a>00245 
<a name="l00246"></a>00246 <span class="keyword">public</span>:
<a name="l00247"></a><a class="code" href="classDataReady.html#a89b556482cff284eac7005bdabb32be5">00247</a>     <a class="code" href="classDataReady.html#a89b556482cff284eac7005bdabb32be5">DataReady</a>()
<a name="l00248"></a>00248     {
<a name="l00249"></a>00249       nfds = 0;
<a name="l00250"></a>00250       fd_array_size = 0;
<a name="l00251"></a>00251       fds = 0;
<a name="l00252"></a>00252       tid = 0;
<a name="l00253"></a>00253 
<a name="l00254"></a>00254       pthread_mutex_init(&amp;_datalock, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00255"></a>00255       FD_ZERO(&amp;_fdsets[0]); FD_ZERO(&amp;_fdsets[1]); FD_ZERO(&amp;_fdsets[2]);
<a name="l00256"></a>00256       _cancelpipe[0] = _cancelpipe[1] = 0;
<a name="l00257"></a>00257       _userdata = 0;
<a name="l00258"></a>00258       _maxfd = 0;
<a name="l00259"></a>00259     }
<a name="l00260"></a>00260 
<a name="l00261"></a><a class="code" href="classDataReady.html#aec84cf3547adc210a81e08c35e18a284">00261</a>     <a class="code" href="classDataReady.html#aec84cf3547adc210a81e08c35e18a284">~DataReady</a>()
<a name="l00262"></a>00262     {
<a name="l00263"></a>00263         <a class="code" href="classDataReady.html#a09cbc5b242a2075318e5743996ee4a1e">CancelThread</a>(<a class="code" href="Fl__mac_8cxx.html#a52ec816ebb31da9a8f9adf9ea690afcd">DEBUGTEXT</a>(<span class="stringliteral">&quot;DESTRUCTOR\n&quot;</span>));
<a name="l00264"></a>00264         <span class="keywordflow">if</span> (fds) { free(fds); fds = 0; }
<a name="l00265"></a>00265         nfds = 0;
<a name="l00266"></a>00266     }
<a name="l00267"></a>00267 
<a name="l00268"></a>00268     <span class="comment">// Locks</span>
<a name="l00269"></a>00269     <span class="comment">//    The convention for locks: volatile vars start with &#39;_&#39;,</span>
<a name="l00270"></a>00270     <span class="comment">//    and must be locked before use. Locked code is prefixed </span>
<a name="l00271"></a>00271     <span class="comment">//    with /*LOCK*/ to make painfully obvious esp. in debuggers. -erco</span>
<a name="l00272"></a>00272     <span class="comment">//</span>
<a name="l00273"></a><a class="code" href="classDataReady.html#a82aacc293387f4990ce1015ec063d9a7">00273</a>     <span class="keywordtype">void</span> <a class="code" href="classDataReady.html#a82aacc293387f4990ce1015ec063d9a7">DataLock</a>() { pthread_mutex_lock(&amp;_datalock); }
<a name="l00274"></a><a class="code" href="classDataReady.html#aad0aa979174e3433a217de63acbe55b8">00274</a>     <span class="keywordtype">void</span> <a class="code" href="classDataReady.html#aad0aa979174e3433a217de63acbe55b8">DataUnlock</a>() { pthread_mutex_unlock(&amp;_datalock); }
<a name="l00275"></a>00275 
<a name="l00276"></a>00276     <span class="comment">// Accessors</span>
<a name="l00277"></a><a class="code" href="classDataReady.html#a51474ea8ee76b766e6748ec354ea9f29">00277</a>     <span class="keywordtype">int</span> <a class="code" href="classDataReady.html#a51474ea8ee76b766e6748ec354ea9f29">IsThreadRunning</a>() { <span class="keywordflow">return</span>(tid ? 1 : 0); }
<a name="l00278"></a><a class="code" href="classDataReady.html#a42964a0a731eeedcb4dfc4c0b4bacd94">00278</a>     <span class="keywordtype">int</span> <a class="code" href="classDataReady.html#a42964a0a731eeedcb4dfc4c0b4bacd94">GetNfds</a>() { <span class="keywordflow">return</span>(nfds); }
<a name="l00279"></a><a class="code" href="classDataReady.html#a5d8e6615150d555c0f8a79ecf7a40a15">00279</a>     <span class="keywordtype">int</span> <a class="code" href="classDataReady.html#a5d8e6615150d555c0f8a79ecf7a40a15">GetCancelPipe</a>(<span class="keywordtype">int</span> ix) { <span class="keywordflow">return</span>(_cancelpipe[ix]); }
<a name="l00280"></a><a class="code" href="classDataReady.html#a1f735cdbfdaf1876777f46e91d99a594">00280</a>     fd_set <a class="code" href="classDataReady.html#a1f735cdbfdaf1876777f46e91d99a594">GetFdset</a>(<span class="keywordtype">int</span> ix) { <span class="keywordflow">return</span>(_fdsets[ix]); }
<a name="l00281"></a>00281 
<a name="l00282"></a>00282     <span class="comment">// Methods</span>
<a name="l00283"></a>00283     <span class="keywordtype">void</span> <a class="code" href="classDataReady.html#af1e989d67da7cfe6e3743c02600b89a2">AddFD</a>(<span class="keywordtype">int</span> n, <span class="keywordtype">int</span> events, <span class="keywordtype">void</span> (*cb)(<span class="keywordtype">int</span>, <span class="keywordtype">void</span>*), <span class="keywordtype">void</span> *v);
<a name="l00284"></a>00284     <span class="keywordtype">void</span> <a class="code" href="classDataReady.html#ad61c16682116ac3a0ffab43d725d8278">RemoveFD</a>(<span class="keywordtype">int</span> n, <span class="keywordtype">int</span> events);
<a name="l00285"></a>00285     <span class="keywordtype">int</span> <a class="code" href="classDataReady.html#ad2fb69a0073537ccd0ae4c60db6944b2">CheckData</a>(fd_set&amp; r, fd_set&amp; <a class="code" href="forms_8H-2.html#aac374e320caaadeca4874add33b62af2">w</a>, fd_set&amp; <a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>);
<a name="l00286"></a>00286     <span class="keywordtype">void</span> <a class="code" href="classDataReady.html#ac701172bd3b89867f6cb2b1cd206565a">HandleData</a>(fd_set&amp; r, fd_set&amp; <a class="code" href="forms_8H-2.html#aac374e320caaadeca4874add33b62af2">w</a>, fd_set&amp; <a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>);
<a name="l00287"></a>00287     <span class="keyword">static</span> <span class="keywordtype">void</span>* <a class="code" href="classDataReady.html#a563a37e231532644cc059161d1a0262a">DataReadyThread</a>(<span class="keywordtype">void</span> *<span class="keyword">self</span>);
<a name="l00288"></a>00288     <span class="keywordtype">void</span> <a class="code" href="classDataReady.html#aa64b9a59088565f9ed5b31c8635e7b6c">StartThread</a>(<span class="keywordtype">void</span> *userdata);
<a name="l00289"></a>00289     <span class="keywordtype">void</span> <a class="code" href="classDataReady.html#a09cbc5b242a2075318e5743996ee4a1e">CancelThread</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *reason);
<a name="l00290"></a>00290 };
<a name="l00291"></a>00291 
<a name="l00292"></a>00292 <span class="keyword">static</span> <a class="code" href="classDataReady.html">DataReady</a> dataready;
<a name="l00293"></a>00293 
<a name="l00294"></a><a class="code" href="classDataReady.html#af1e989d67da7cfe6e3743c02600b89a2">00294</a> <span class="keywordtype">void</span> <a class="code" href="classDataReady.html#af1e989d67da7cfe6e3743c02600b89a2">DataReady::AddFD</a>(<span class="keywordtype">int</span> n, <span class="keywordtype">int</span> events, <span class="keywordtype">void</span> (*cb)(<span class="keywordtype">int</span>, <span class="keywordtype">void</span>*), <span class="keywordtype">void</span> *v)
<a name="l00295"></a>00295 {
<a name="l00296"></a>00296   <a class="code" href="classDataReady.html#ad61c16682116ac3a0ffab43d725d8278">RemoveFD</a>(n, events);
<a name="l00297"></a>00297   <span class="keywordtype">int</span> <a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a> = nfds++;
<a name="l00298"></a>00298   <span class="keywordflow">if</span> (i &gt;= fd_array_size) 
<a name="l00299"></a>00299   {
<a name="l00300"></a>00300     FD *temp;
<a name="l00301"></a>00301     fd_array_size = 2*fd_array_size+1;
<a name="l00302"></a>00302     <span class="keywordflow">if</span> (!fds) { temp = (FD*)malloc(fd_array_size*<span class="keyword">sizeof</span>(FD)); }
<a name="l00303"></a>00303     <span class="keywordflow">else</span> { temp = (FD*)realloc(fds, fd_array_size*<span class="keyword">sizeof</span>(FD)); }
<a name="l00304"></a>00304     <span class="keywordflow">if</span> (!temp) <span class="keywordflow">return</span>;
<a name="l00305"></a>00305     fds = temp;
<a name="l00306"></a>00306   }
<a name="l00307"></a>00307   fds[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].cb  = cb;
<a name="l00308"></a>00308   fds[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].arg = v;
<a name="l00309"></a>00309   fds[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].fd  = n;
<a name="l00310"></a>00310   fds[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].events = events;
<a name="l00311"></a>00311   <a class="code" href="classDataReady.html#a82aacc293387f4990ce1015ec063d9a7">DataLock</a>();
<a name="l00312"></a>00312   <span class="comment">/*LOCK*/</span>  <span class="keywordflow">if</span> (events &amp; <a class="code" href="Fl__mac_8cxx.html#a52ac479a805051f59643588b096024ff">POLLIN</a>)  FD_SET(n, &amp;_fdsets[0]);
<a name="l00313"></a>00313   <span class="comment">/*LOCK*/</span>  <span class="keywordflow">if</span> (events &amp; <a class="code" href="Fl__mac_8cxx.html#a91b3c67129ac7675062f316b840a0d58">POLLOUT</a>) FD_SET(n, &amp;_fdsets[1]);
<a name="l00314"></a>00314   <span class="comment">/*LOCK*/</span>  <span class="keywordflow">if</span> (events &amp; <a class="code" href="Fl__mac_8cxx.html#ab1c532446408c98559d4aaaeeeb99820">POLLERR</a>) FD_SET(n, &amp;_fdsets[2]);
<a name="l00315"></a>00315   <span class="comment">/*LOCK*/</span>  <span class="keywordflow">if</span> (n &gt; _maxfd) _maxfd = n;
<a name="l00316"></a>00316   <a class="code" href="classDataReady.html#aad0aa979174e3433a217de63acbe55b8">DataUnlock</a>();
<a name="l00317"></a>00317 }
<a name="l00318"></a>00318 
<a name="l00319"></a>00319 <span class="comment">// Remove an FD from the array</span>
<a name="l00320"></a><a class="code" href="classDataReady.html#ad61c16682116ac3a0ffab43d725d8278">00320</a> <span class="keywordtype">void</span> <a class="code" href="classDataReady.html#ad61c16682116ac3a0ffab43d725d8278">DataReady::RemoveFD</a>(<span class="keywordtype">int</span> n, <span class="keywordtype">int</span> events)
<a name="l00321"></a>00321 {
<a name="l00322"></a>00322   <span class="keywordtype">int</span> <a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>,j;
<a name="l00323"></a>00323   <span class="keywordflow">for</span> (i=j=0; i&lt;nfds; i++)
<a name="l00324"></a>00324   {
<a name="l00325"></a>00325     <span class="keywordflow">if</span> (fds[i].fd == n) 
<a name="l00326"></a>00326     {
<a name="l00327"></a>00327       <span class="keywordtype">int</span> e = fds[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].events &amp; ~events;
<a name="l00328"></a>00328       <span class="keywordflow">if</span> (!e) <span class="keywordflow">continue</span>; <span class="comment">// if no events left, delete this fd</span>
<a name="l00329"></a>00329       fds[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].events = e;
<a name="l00330"></a>00330     }
<a name="l00331"></a>00331     <span class="comment">// move it down in the array if necessary:</span>
<a name="l00332"></a>00332     <span class="keywordflow">if</span> (j&lt;i)
<a name="l00333"></a>00333       { fds[j] = fds[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>]; }
<a name="l00334"></a>00334     j++;
<a name="l00335"></a>00335   }
<a name="l00336"></a>00336   nfds = j;
<a name="l00337"></a>00337   <a class="code" href="classDataReady.html#a82aacc293387f4990ce1015ec063d9a7">DataLock</a>();
<a name="l00338"></a>00338   <span class="comment">/*LOCK*/</span>  <span class="keywordflow">if</span> (events &amp; <a class="code" href="Fl__mac_8cxx.html#a52ac479a805051f59643588b096024ff">POLLIN</a>)  FD_CLR(n, &amp;_fdsets[0]);
<a name="l00339"></a>00339   <span class="comment">/*LOCK*/</span>  <span class="keywordflow">if</span> (events &amp; <a class="code" href="Fl__mac_8cxx.html#a91b3c67129ac7675062f316b840a0d58">POLLOUT</a>) FD_CLR(n, &amp;_fdsets[1]);
<a name="l00340"></a>00340   <span class="comment">/*LOCK*/</span>  <span class="keywordflow">if</span> (events &amp; <a class="code" href="Fl__mac_8cxx.html#ab1c532446408c98559d4aaaeeeb99820">POLLERR</a>) FD_CLR(n, &amp;_fdsets[2]);
<a name="l00341"></a>00341   <span class="comment">/*LOCK*/</span>  <span class="keywordflow">if</span> (n == _maxfd) _maxfd--;
<a name="l00342"></a>00342   <a class="code" href="classDataReady.html#aad0aa979174e3433a217de63acbe55b8">DataUnlock</a>();
<a name="l00343"></a>00343 }
<a name="l00344"></a>00344 
<a name="l00345"></a>00345 <span class="comment">// CHECK IF USER DATA READY, RETURNS r/w/x INDICATING WHICH IF ANY</span>
<a name="l00346"></a><a class="code" href="classDataReady.html#ad2fb69a0073537ccd0ae4c60db6944b2">00346</a> <span class="keywordtype">int</span> <a class="code" href="classDataReady.html#ad2fb69a0073537ccd0ae4c60db6944b2">DataReady::CheckData</a>(fd_set&amp; r, fd_set&amp; <a class="code" href="forms_8H-2.html#aac374e320caaadeca4874add33b62af2">w</a>, fd_set&amp; <a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>)
<a name="l00347"></a>00347 {
<a name="l00348"></a>00348   <span class="keywordtype">int</span> ret;
<a name="l00349"></a>00349   <a class="code" href="classDataReady.html#a82aacc293387f4990ce1015ec063d9a7">DataLock</a>();
<a name="l00350"></a>00350   <span class="comment">/*LOCK*/</span>  timeval t = { 0, 1 };               <span class="comment">// quick check</span>
<a name="l00351"></a>00351   <span class="comment">/*LOCK*/</span>  r = _fdsets[0], w = _fdsets[1], x = _fdsets[2];
<a name="l00352"></a>00352   <span class="comment">/*LOCK*/</span>  ret =<a class="code" href="factory_8cxx.html#a55a2870f3bd5e6ef9331bb7040a212c8"> ::select</a>(_maxfd+1, &amp;r, &amp;<a class="code" href="forms_8H-2.html#aac374e320caaadeca4874add33b62af2">w</a>, &amp;<a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>, &amp;t);
<a name="l00353"></a>00353   <a class="code" href="classDataReady.html#aad0aa979174e3433a217de63acbe55b8">DataUnlock</a>();
<a name="l00354"></a>00354   <span class="keywordflow">if</span> ( ret == -1 )
<a name="l00355"></a>00355     { <a class="code" href="Fl__mac_8cxx.html#a25f5d39fe70418b682112dac0ded04bd">DEBUGPERRORMSG</a>(<span class="stringliteral">&quot;CheckData(): select()&quot;</span>); }
<a name="l00356"></a>00356   <span class="keywordflow">return</span>(ret);
<a name="l00357"></a>00357 }
<a name="l00358"></a>00358 
<a name="l00359"></a>00359 <span class="comment">// HANDLE DATA READY CALLBACKS</span>
<a name="l00360"></a><a class="code" href="classDataReady.html#ac701172bd3b89867f6cb2b1cd206565a">00360</a> <span class="keywordtype">void</span> <a class="code" href="classDataReady.html#ac701172bd3b89867f6cb2b1cd206565a">DataReady::HandleData</a>(fd_set&amp; r, fd_set&amp; <a class="code" href="forms_8H-2.html#aac374e320caaadeca4874add33b62af2">w</a>, fd_set&amp; <a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>)
<a name="l00361"></a>00361 {
<a name="l00362"></a>00362   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>=0; <a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>&lt;nfds; <a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>++) 
<a name="l00363"></a>00363   {
<a name="l00364"></a>00364     <span class="keywordtype">int</span> <a class="code" href="fl__boxtype_8cxx.html#ac406db58651c10e8f67ed432c66db0d6">f</a> = fds[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].fd;
<a name="l00365"></a>00365     <span class="keywordtype">short</span> revents = 0;
<a name="l00366"></a>00366     <span class="keywordflow">if</span> (FD_ISSET(f, &amp;r)) revents |= <a class="code" href="Fl__mac_8cxx.html#a52ac479a805051f59643588b096024ff">POLLIN</a>;
<a name="l00367"></a>00367     <span class="keywordflow">if</span> (FD_ISSET(f, &amp;w)) revents |= <a class="code" href="Fl__mac_8cxx.html#a91b3c67129ac7675062f316b840a0d58">POLLOUT</a>;
<a name="l00368"></a>00368     <span class="keywordflow">if</span> (FD_ISSET(f, &amp;x)) revents |= <a class="code" href="Fl__mac_8cxx.html#ab1c532446408c98559d4aaaeeeb99820">POLLERR</a>;
<a name="l00369"></a>00369     <span class="keywordflow">if</span> (fds[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].events &amp; revents) 
<a name="l00370"></a>00370     {
<a name="l00371"></a>00371       <a class="code" href="Fl__mac_8cxx.html#aed6d1186912238eabd7672078a396423">DEBUGMSG</a>(<span class="stringliteral">&quot;DOING CALLBACK: &quot;</span>);
<a name="l00372"></a>00372       fds[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].cb(f, fds[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].arg);
<a name="l00373"></a>00373       <a class="code" href="Fl__mac_8cxx.html#aed6d1186912238eabd7672078a396423">DEBUGMSG</a>(<span class="stringliteral">&quot;DONE\n&quot;</span>);
<a name="l00374"></a>00374     }
<a name="l00375"></a>00375   }
<a name="l00376"></a>00376 }
<a name="l00377"></a>00377 
<a name="l00378"></a>00378 <span class="comment">// DATA READY THREAD</span>
<a name="l00379"></a>00379 <span class="comment">//    This thread watches for changes in user&#39;s file descriptors.</span>
<a name="l00380"></a>00380 <span class="comment">//    Sends a &#39;data ready event&#39; to the main thread if any change.</span>
<a name="l00381"></a>00381 <span class="comment">//</span>
<a name="l00382"></a><a class="code" href="classDataReady.html#a563a37e231532644cc059161d1a0262a">00382</a> <span class="keywordtype">void</span>* <a class="code" href="classDataReady.html#a563a37e231532644cc059161d1a0262a">DataReady::DataReadyThread</a>(<span class="keywordtype">void</span> *o)
<a name="l00383"></a>00383 {
<a name="l00384"></a>00384   <a class="code" href="classDataReady.html">DataReady</a> *<span class="keyword">self</span> = (<a class="code" href="classDataReady.html">DataReady</a>*)o;
<a name="l00385"></a>00385   <span class="keywordflow">while</span> ( 1 )                                   <span class="comment">// loop until thread cancel or error</span>
<a name="l00386"></a>00386   {
<a name="l00387"></a>00387     <span class="comment">// Thread safe local copies of data before each select()</span>
<a name="l00388"></a>00388     <span class="keyword">self</span>-&gt;<a class="code" href="classDataReady.html#a82aacc293387f4990ce1015ec063d9a7">DataLock</a>();
<a name="l00389"></a>00389     <span class="comment">/*LOCK*/</span>  <span class="keywordtype">int</span> maxfd = <span class="keyword">self</span>-&gt;_maxfd;
<a name="l00390"></a>00390     <span class="comment">/*LOCK*/</span>  fd_set r = <span class="keyword">self</span>-&gt;GetFdset(0);
<a name="l00391"></a>00391     <span class="comment">/*LOCK*/</span>  fd_set <a class="code" href="forms_8H-2.html#aac374e320caaadeca4874add33b62af2">w</a> = <span class="keyword">self</span>-&gt;GetFdset(1);
<a name="l00392"></a>00392     <span class="comment">/*LOCK*/</span>  fd_set <a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a> = <span class="keyword">self</span>-&gt;GetFdset(2);
<a name="l00393"></a>00393     <span class="comment">/*LOCK*/</span>  <span class="keywordtype">void</span> *userdata = <span class="keyword">self</span>-&gt;_userdata;
<a name="l00394"></a>00394     <span class="comment">/*LOCK*/</span>  <span class="keywordtype">int</span> cancelpipe = <span class="keyword">self</span>-&gt;GetCancelPipe(0);
<a name="l00395"></a>00395     <span class="comment">/*LOCK*/</span>  <span class="keywordflow">if</span> ( cancelpipe &gt; maxfd ) maxfd = cancelpipe;
<a name="l00396"></a>00396     <span class="comment">/*LOCK*/</span>  FD_SET(cancelpipe, &amp;r);           <span class="comment">// add cancelpipe to fd&#39;s to watch</span>
<a name="l00397"></a>00397     <span class="comment">/*LOCK*/</span>  FD_SET(cancelpipe, &amp;x);
<a name="l00398"></a>00398     <span class="keyword">self</span>-&gt;DataUnlock();
<a name="l00399"></a>00399     <span class="comment">// timeval t = { 1000, 0 }; // 1000 seconds;</span>
<a name="l00400"></a>00400     timeval t = { 2, 0 };       <span class="comment">// HACK: 2 secs prevents &#39;hanging&#39; problem</span>
<a name="l00401"></a>00401     <span class="keywordtype">int</span> ret =<a class="code" href="factory_8cxx.html#a55a2870f3bd5e6ef9331bb7040a212c8"> ::select</a>(maxfd+1, &amp;r, &amp;<a class="code" href="forms_8H-2.html#aac374e320caaadeca4874add33b62af2">w</a>, &amp;<a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>, &amp;t);
<a name="l00402"></a>00402     pthread_testcancel();       <span class="comment">// OSX 10.0.4 and older: needed for parent to cancel</span>
<a name="l00403"></a>00403     <span class="keywordflow">switch</span> ( ret )
<a name="l00404"></a>00404     {
<a name="l00405"></a>00405       <span class="keywordflow">case</span> 0:   <span class="comment">// NO DATA</span>
<a name="l00406"></a>00406         <span class="keywordflow">continue</span>;
<a name="l00407"></a>00407       <span class="keywordflow">case</span> -1:  <span class="comment">// ERROR</span>
<a name="l00408"></a>00408       {
<a name="l00409"></a>00409         <a class="code" href="Fl__mac_8cxx.html#a25f5d39fe70418b682112dac0ded04bd">DEBUGPERRORMSG</a>(<span class="stringliteral">&quot;CHILD THREAD: select() failed&quot;</span>);
<a name="l00410"></a>00410         <span class="keywordflow">return</span>(<a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);           <span class="comment">// error? exit thread</span>
<a name="l00411"></a>00411       }
<a name="l00412"></a>00412       <span class="keywordflow">default</span>:  <span class="comment">// DATA READY</span>
<a name="l00413"></a>00413       {
<a name="l00414"></a>00414         <span class="keywordflow">if</span> (FD_ISSET(cancelpipe, &amp;r) || FD_ISSET(cancelpipe, &amp;x))       <span class="comment">// cancel?</span>
<a name="l00415"></a>00415             { <span class="keywordflow">return</span>(<a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>); }                                           <span class="comment">// just exit</span>
<a name="l00416"></a>00416         <a class="code" href="Fl__mac_8cxx.html#aed6d1186912238eabd7672078a396423">DEBUGMSG</a>(<span class="stringliteral">&quot;CHILD THREAD: DATA IS READY\n&quot;</span>);
<a name="l00417"></a>00417         EventRef drEvent;
<a name="l00418"></a>00418         CreateEvent( 0, <a class="code" href="Fl__mac_8cxx.html#a2970898e8a43ce21e1cc510d49f1b89da4d1fadb014d21f05dc6f3821424edb12">kEventClassFLTK</a>, <a class="code" href="Fl__mac_8cxx.html#afa231099d07583c3ed0981e0bb665f55ad38bac2c71d5ad1aff0cc34bab67ac08">kEventFLTKDataReady</a>,
<a name="l00419"></a>00419                      0, kEventAttributeUserEvent, &amp;drEvent);
<a name="l00420"></a>00420         EventQueueRef eventqueue = (EventQueueRef)userdata;
<a name="l00421"></a>00421         PostEventToQueue(eventqueue, drEvent, kEventPriorityStandard );
<a name="l00422"></a>00422         ReleaseEvent( drEvent );
<a name="l00423"></a>00423         <span class="keywordflow">return</span>(<a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);           <span class="comment">// done with thread</span>
<a name="l00424"></a>00424       }
<a name="l00425"></a>00425     }
<a name="l00426"></a>00426   }
<a name="l00427"></a>00427 }
<a name="l00428"></a>00428 
<a name="l00429"></a>00429 <span class="comment">// START &#39;DATA READY&#39; THREAD RUNNING, CREATE INTER-THREAD PIPE</span>
<a name="l00430"></a><a class="code" href="classDataReady.html#aa64b9a59088565f9ed5b31c8635e7b6c">00430</a> <span class="keywordtype">void</span> <a class="code" href="classDataReady.html#aa64b9a59088565f9ed5b31c8635e7b6c">DataReady::StartThread</a>(<span class="keywordtype">void</span> *new_userdata)
<a name="l00431"></a>00431 {
<a name="l00432"></a>00432   <a class="code" href="classDataReady.html#a09cbc5b242a2075318e5743996ee4a1e">CancelThread</a>(<a class="code" href="Fl__mac_8cxx.html#a52ec816ebb31da9a8f9adf9ea690afcd">DEBUGTEXT</a>(<span class="stringliteral">&quot;STARTING NEW THREAD\n&quot;</span>));
<a name="l00433"></a>00433   <a class="code" href="classDataReady.html#a82aacc293387f4990ce1015ec063d9a7">DataLock</a>();
<a name="l00434"></a>00434   <span class="comment">/*LOCK*/</span>  pipe(_cancelpipe);  <span class="comment">// pipe for sending cancel msg to thread</span>
<a name="l00435"></a>00435   <span class="comment">/*LOCK*/</span>  _userdata = new_userdata;
<a name="l00436"></a>00436   <a class="code" href="classDataReady.html#aad0aa979174e3433a217de63acbe55b8">DataUnlock</a>();
<a name="l00437"></a>00437   <a class="code" href="Fl__mac_8cxx.html#aed6d1186912238eabd7672078a396423">DEBUGMSG</a>(<span class="stringliteral">&quot;*** START THREAD\n&quot;</span>);
<a name="l00438"></a>00438   pthread_create(&amp;tid, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="classDataReady.html#a563a37e231532644cc059161d1a0262a">DataReadyThread</a>, (<span class="keywordtype">void</span>*)<span class="keyword">this</span>);
<a name="l00439"></a>00439 }
<a name="l00440"></a>00440 
<a name="l00441"></a>00441 <span class="comment">// CANCEL &#39;DATA READY&#39; THREAD, CLOSE PIPE</span>
<a name="l00442"></a><a class="code" href="classDataReady.html#a09cbc5b242a2075318e5743996ee4a1e">00442</a> <span class="keywordtype">void</span> <a class="code" href="classDataReady.html#a09cbc5b242a2075318e5743996ee4a1e">DataReady::CancelThread</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *reason)
<a name="l00443"></a>00443 {
<a name="l00444"></a>00444   <span class="keywordflow">if</span> ( tid )
<a name="l00445"></a>00445   {
<a name="l00446"></a>00446     <a class="code" href="Fl__mac_8cxx.html#aed6d1186912238eabd7672078a396423">DEBUGMSG</a>(<span class="stringliteral">&quot;*** CANCEL THREAD: &quot;</span>);
<a name="l00447"></a>00447     <a class="code" href="Fl__mac_8cxx.html#aed6d1186912238eabd7672078a396423">DEBUGMSG</a>(reason);
<a name="l00448"></a>00448     <span class="keywordflow">if</span> ( pthread_cancel(tid) == 0 )             <span class="comment">// cancel first</span>
<a name="l00449"></a>00449     {
<a name="l00450"></a>00450       <a class="code" href="classDataReady.html#a82aacc293387f4990ce1015ec063d9a7">DataLock</a>();
<a name="l00451"></a>00451       <span class="comment">/*LOCK*/</span>  write(_cancelpipe[1], <span class="stringliteral">&quot;x&quot;</span>, 1);  <span class="comment">// wake thread from select</span>
<a name="l00452"></a>00452       <a class="code" href="classDataReady.html#aad0aa979174e3433a217de63acbe55b8">DataUnlock</a>();
<a name="l00453"></a>00453       pthread_join(tid, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);                  <span class="comment">// wait for thread to finish</span>
<a name="l00454"></a>00454     }
<a name="l00455"></a>00455     tid = 0;
<a name="l00456"></a>00456     <a class="code" href="Fl__mac_8cxx.html#aed6d1186912238eabd7672078a396423">DEBUGMSG</a>(<span class="stringliteral">&quot;(JOINED) OK\n&quot;</span>);
<a name="l00457"></a>00457   }
<a name="l00458"></a>00458   <span class="comment">// Close pipe if open</span>
<a name="l00459"></a>00459   <a class="code" href="classDataReady.html#a82aacc293387f4990ce1015ec063d9a7">DataLock</a>();
<a name="l00460"></a>00460   <span class="comment">/*LOCK*/</span>  <span class="keywordflow">if</span> ( _cancelpipe[0] ) { close(_cancelpipe[0]); _cancelpipe[0] = 0; }
<a name="l00461"></a>00461   <span class="comment">/*LOCK*/</span>  <span class="keywordflow">if</span> ( _cancelpipe[1] ) { close(_cancelpipe[1]); _cancelpipe[1] = 0; }
<a name="l00462"></a>00462   <a class="code" href="classDataReady.html#aad0aa979174e3433a217de63acbe55b8">DataUnlock</a>();
<a name="l00463"></a>00463 }
<a name="l00464"></a>00464 
<a name="l00465"></a>00465 <span class="keywordtype">void</span> <a class="code" href="classFl.html#a799b8278326b3c2db15687c43c11aaf6">Fl::add_fd</a>( <span class="keywordtype">int</span> n, <span class="keywordtype">int</span> events, <span class="keywordtype">void</span> (*cb)(<span class="keywordtype">int</span>, <span class="keywordtype">void</span>*), <span class="keywordtype">void</span> *v )
<a name="l00466"></a>00466     { dataready.<a class="code" href="classDataReady.html#af1e989d67da7cfe6e3743c02600b89a2">AddFD</a>(n, events, cb, v); }
<a name="l00467"></a>00467 
<a name="l00468"></a>00468 <span class="keywordtype">void</span> <a class="code" href="classFl.html#a799b8278326b3c2db15687c43c11aaf6">Fl::add_fd</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">void</span> (*cb)(<span class="keywordtype">int</span>, <span class="keywordtype">void</span>*), <span class="keywordtype">void</span>* v)
<a name="l00469"></a>00469     { dataready.<a class="code" href="classDataReady.html#af1e989d67da7cfe6e3743c02600b89a2">AddFD</a>(fd, <a class="code" href="Fl__mac_8cxx.html#a52ac479a805051f59643588b096024ff">POLLIN</a>, cb, v); }
<a name="l00470"></a>00470 
<a name="l00471"></a><a class="code" href="classFl.html#a71e75c1a559e3415c5304c37235af831">00471</a> <span class="keywordtype">void</span> <a class="code" href="classFl.html#a71e75c1a559e3415c5304c37235af831">Fl::remove_fd</a>(<span class="keywordtype">int</span> n, <span class="keywordtype">int</span> events)
<a name="l00472"></a>00472     { dataready.<a class="code" href="classDataReady.html#ad61c16682116ac3a0ffab43d725d8278">RemoveFD</a>(n, events); }
<a name="l00473"></a>00473 
<a name="l00474"></a><a class="code" href="classFl.html#a5f4ece44a4e07f7d95950b665047a807">00474</a> <span class="keywordtype">void</span> <a class="code" href="classFl.html#a71e75c1a559e3415c5304c37235af831">Fl::remove_fd</a>(<span class="keywordtype">int</span> n)
<a name="l00475"></a>00475     { dataready.<a class="code" href="classDataReady.html#ad61c16682116ac3a0ffab43d725d8278">RemoveFD</a>(n, -1); }
<a name="l00476"></a>00476 
<a name="l00480"></a><a class="code" href="Fl__mac_8cxx.html#af0705d69ac0f8c4c43d26d935c12044a">00480</a> <span class="keywordtype">int</span> <a class="code" href="Fl_8cxx.html#af0705d69ac0f8c4c43d26d935c12044a">fl_ready</a>()
<a name="l00481"></a>00481 {
<a name="l00482"></a>00482   EventRef event;
<a name="l00483"></a>00483   <span class="keywordflow">return</span> !ReceiveNextEvent(0, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0.0, <span class="keyword">false</span>, &amp;event);
<a name="l00484"></a>00484 }
<a name="l00485"></a>00485 
<a name="l00490"></a><a class="code" href="Fl__mac_8cxx.html#a4173f3c0b06d69a442e88707e67abcf7">00490</a> OSStatus <a class="code" href="Fl__mac_8cxx.html#a4173f3c0b06d69a442e88707e67abcf7">HandleMenu</a>( HICommand *cmd )
<a name="l00491"></a>00491 {
<a name="l00492"></a>00492   OSStatus ret = eventNotHandledErr;
<a name="l00493"></a>00493   <span class="comment">// attributes, commandIDm menu.menuRef, menu.menuItemIndex</span>
<a name="l00494"></a>00494   UInt32 ref;
<a name="l00495"></a>00495   OSErr rrc = GetMenuItemRefCon( cmd-&gt;menu.menuRef, cmd-&gt;menu.menuItemIndex, &amp;ref );
<a name="l00496"></a>00496   <span class="comment">//printf( &quot;%d, %08x, %08x, %d, %d, %8x\n&quot;, rrc, cmd-&gt;attributes, cmd-&gt;commandID, cmd-&gt;menu.menuRef, cmd-&gt;menu.menuItemIndex, rrc );</span>
<a name="l00497"></a>00497   <span class="keywordflow">if</span> ( rrc==noErr &amp;&amp; ref )
<a name="l00498"></a>00498   {
<a name="l00499"></a>00499     <a class="code" href="structFl__Menu__Item.html">Fl_Menu_Item</a> *<a class="code" href="forms_8H-2.html#af3b42f864d9945cbdea4abf952e2412e">m</a> = (<a class="code" href="structFl__Menu__Item.html">Fl_Menu_Item</a>*)ref;
<a name="l00500"></a>00500     <span class="comment">//printf( &quot;Menu: %s\n&quot;, m-&gt;label() );</span>
<a name="l00501"></a>00501     fl_sys_menu_bar-&gt;<a class="code" href="classFl__Menu__.html#a0a528db63b4eaa0edda217787a0c9d5a">picked</a>( m );
<a name="l00502"></a>00502     <span class="keywordflow">if</span> ( m-&gt;<a class="code" href="structFl__Menu__Item.html#aae6ba303ffaf74a0267c978ae8ec475f" title="menu item flags like FL_MENU_TOGGLE, FL_MENU_RADIO">flags</a> &amp; <a class="code" href="Fl__Menu__Item_8H.html#ab04a0655cd1e3bcac5e8f48c18df1a57a7425ae185af0bdbf04dbadaaa9413574" title="Item is a checkbox toggle (shows checkbox for on/off state)">FL_MENU_TOGGLE</a> ) <span class="comment">// update the menu toggle symbol</span>
<a name="l00503"></a>00503       SetItemMark( cmd-&gt;menu.menuRef, cmd-&gt;menu.menuItemIndex, (m-&gt;<a class="code" href="structFl__Menu__Item.html#aae6ba303ffaf74a0267c978ae8ec475f" title="menu item flags like FL_MENU_TOGGLE, FL_MENU_RADIO">flags</a> &amp; <a class="code" href="Fl__Menu__Item_8H.html#ab04a0655cd1e3bcac5e8f48c18df1a57ab9cdabaf7a4065f0b8ea4e73ccf1b7cf" title="The on/off state for checkbox/radio buttons (if set, state is &amp;#39;on&amp;#39;)">FL_MENU_VALUE</a> ) ? 0x12 : 0 );
<a name="l00504"></a>00504     <span class="keywordflow">if</span> ( m-&gt;<a class="code" href="structFl__Menu__Item.html#aae6ba303ffaf74a0267c978ae8ec475f" title="menu item flags like FL_MENU_TOGGLE, FL_MENU_RADIO">flags</a> &amp; <a class="code" href="Fl__Menu__Item_8H.html#ab04a0655cd1e3bcac5e8f48c18df1a57a11aab33bbffb20feac97c9b9979638bf" title="Item is a radio button (one checkbox of many can be on)">FL_MENU_RADIO</a> ) <span class="comment">// update all radio buttons in this menu</span>
<a name="l00505"></a>00505     {
<a name="l00506"></a>00506       <a class="code" href="structFl__Menu__Item.html">Fl_Menu_Item</a> *j = <a class="code" href="forms_8H-2.html#af3b42f864d9945cbdea4abf952e2412e">m</a>;
<a name="l00507"></a>00507       <span class="keywordtype">int</span> <a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a> = cmd-&gt;menu.menuItemIndex;
<a name="l00508"></a>00508       <span class="keywordflow">for</span> (;;)
<a name="l00509"></a>00509       {
<a name="l00510"></a>00510         <span class="keywordflow">if</span> ( j-&gt;<a class="code" href="structFl__Menu__Item.html#aae6ba303ffaf74a0267c978ae8ec475f" title="menu item flags like FL_MENU_TOGGLE, FL_MENU_RADIO">flags</a> &amp; <a class="code" href="Fl__Menu__Item_8H.html#ab04a0655cd1e3bcac5e8f48c18df1a57a4e221192c48b090c3c3a0a6fb716faae" title="Creates divider line below this item. Also ends a group of radio buttons.">FL_MENU_DIVIDER</a> )
<a name="l00511"></a>00511           <span class="keywordflow">break</span>;
<a name="l00512"></a>00512         j++; i++;
<a name="l00513"></a>00513         <span class="keywordflow">if</span> ( !j-&gt;<a class="code" href="structFl__Menu__Item.html#a0b46c8823d3d47b430b9ed58c5d57b44" title="menu item text, returned by label()">text</a> || !j-&gt;<a class="code" href="structFl__Menu__Item.html#a6ffa1512c4f68dc820e5283ae6c5f91e">radio</a>() )
<a name="l00514"></a>00514           <span class="keywordflow">break</span>;
<a name="l00515"></a>00515         SetItemMark( cmd-&gt;menu.menuRef, i, ( j-&gt;<a class="code" href="structFl__Menu__Item.html#aae6ba303ffaf74a0267c978ae8ec475f" title="menu item flags like FL_MENU_TOGGLE, FL_MENU_RADIO">flags</a> &amp; <a class="code" href="Fl__Menu__Item_8H.html#ab04a0655cd1e3bcac5e8f48c18df1a57ab9cdabaf7a4065f0b8ea4e73ccf1b7cf" title="The on/off state for checkbox/radio buttons (if set, state is &amp;#39;on&amp;#39;)">FL_MENU_VALUE</a> ) ? 0x13 : 0 );
<a name="l00516"></a>00516       }
<a name="l00517"></a>00517       j = m-1; i = cmd-&gt;menu.menuItemIndex-1;
<a name="l00518"></a>00518       <span class="keywordflow">for</span> ( ; i&gt;0; j--, i-- )
<a name="l00519"></a>00519       {
<a name="l00520"></a>00520         <span class="keywordflow">if</span> ( !j-&gt;<a class="code" href="structFl__Menu__Item.html#a0b46c8823d3d47b430b9ed58c5d57b44" title="menu item text, returned by label()">text</a> || j-&gt;<a class="code" href="structFl__Menu__Item.html#aae6ba303ffaf74a0267c978ae8ec475f" title="menu item flags like FL_MENU_TOGGLE, FL_MENU_RADIO">flags</a>&amp;<a class="code" href="Fl__Menu__Item_8H.html#ab04a0655cd1e3bcac5e8f48c18df1a57a4e221192c48b090c3c3a0a6fb716faae" title="Creates divider line below this item. Also ends a group of radio buttons.">FL_MENU_DIVIDER</a> || !j-&gt;<a class="code" href="structFl__Menu__Item.html#a6ffa1512c4f68dc820e5283ae6c5f91e">radio</a>() )
<a name="l00521"></a>00521           <span class="keywordflow">break</span>;
<a name="l00522"></a>00522         SetItemMark( cmd-&gt;menu.menuRef, i, ( j-&gt;<a class="code" href="structFl__Menu__Item.html#aae6ba303ffaf74a0267c978ae8ec475f" title="menu item flags like FL_MENU_TOGGLE, FL_MENU_RADIO">flags</a> &amp; <a class="code" href="Fl__Menu__Item_8H.html#ab04a0655cd1e3bcac5e8f48c18df1a57ab9cdabaf7a4065f0b8ea4e73ccf1b7cf" title="The on/off state for checkbox/radio buttons (if set, state is &amp;#39;on&amp;#39;)">FL_MENU_VALUE</a> ) ? 0x13 : 0 );
<a name="l00523"></a>00523       }
<a name="l00524"></a>00524       SetItemMark( cmd-&gt;menu.menuRef, cmd-&gt;menu.menuItemIndex, ( m-&gt;<a class="code" href="structFl__Menu__Item.html#aae6ba303ffaf74a0267c978ae8ec475f" title="menu item flags like FL_MENU_TOGGLE, FL_MENU_RADIO">flags</a> &amp; <a class="code" href="Fl__Menu__Item_8H.html#ab04a0655cd1e3bcac5e8f48c18df1a57ab9cdabaf7a4065f0b8ea4e73ccf1b7cf" title="The on/off state for checkbox/radio buttons (if set, state is &amp;#39;on&amp;#39;)">FL_MENU_VALUE</a> ) ? 0x13 : 0 );
<a name="l00525"></a>00525     }
<a name="l00526"></a>00526     ret = noErr; <span class="comment">// done handling this event</span>
<a name="l00527"></a>00527   }
<a name="l00528"></a>00528   HiliteMenu(0);
<a name="l00529"></a>00529   <span class="keywordflow">return</span> ret;
<a name="l00530"></a>00530 }
<a name="l00531"></a>00531 
<a name="l00532"></a>00532 
<a name="l00539"></a>00539 <span class="keyword">static</span> pascal OSStatus carbonDispatchHandler( EventHandlerCallRef nextHandler, EventRef event, <span class="keywordtype">void</span> *userData )
<a name="l00540"></a>00540 {
<a name="l00541"></a>00541   OSStatus ret = eventNotHandledErr;
<a name="l00542"></a>00542   HICommand cmd;
<a name="l00543"></a>00543 
<a name="l00544"></a>00544   <a class="code" href="Fl__mac_8cxx.html#a7c231659c1d4f9ad9126b83cfbcbfb53">fl_lock_function</a>();
<a name="l00545"></a>00545 
<a name="l00546"></a>00546   got_events = 1;
<a name="l00547"></a>00547 
<a name="l00548"></a>00548   <span class="keywordflow">switch</span> ( GetEventClass( event ) )
<a name="l00549"></a>00549   {
<a name="l00550"></a>00550   <span class="keywordflow">case</span> kEventClassMouse:
<a name="l00551"></a>00551     <span class="keywordflow">switch</span> ( GetEventKind( event ) )
<a name="l00552"></a>00552     {
<a name="l00553"></a>00553     <span class="keywordflow">case</span> kEventMouseUp:
<a name="l00554"></a>00554     <span class="keywordflow">case</span> kEventMouseMoved:
<a name="l00555"></a>00555     <span class="keywordflow">case</span> kEventMouseDragged:
<a name="l00556"></a>00556       <span class="keywordflow">if</span> ( <a class="code" href="Fl__mac_8cxx.html#a6e10f30f9e6dd98ed093691fd605a0c2">fl_capture</a> )
<a name="l00557"></a>00557         ret = SendEventToEventTarget( event, GetWindowEventTarget( <a class="code" href="Fl__mac_8cxx.html#a6e10f30f9e6dd98ed093691fd605a0c2">fl_capture</a> ) );
<a name="l00558"></a>00558       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( fl_os_capture ){
<a name="l00559"></a>00559         ret = SendEventToEventTarget( event, GetWindowEventTarget( fl_os_capture ) );
<a name="l00560"></a>00560         fl_os_capture = 0;
<a name="l00561"></a>00561       }
<a name="l00562"></a>00562       <span class="keywordflow">break</span>;
<a name="l00563"></a>00563     }
<a name="l00564"></a>00564     <span class="keywordflow">break</span>;
<a name="l00565"></a>00565   <span class="keywordflow">case</span> kEventClassCommand:
<a name="l00566"></a>00566     <span class="keywordflow">switch</span> (GetEventKind( event ) )
<a name="l00567"></a>00567     {
<a name="l00568"></a>00568       <span class="keywordflow">case</span> kEventCommandProcess:
<a name="l00569"></a>00569         ret = GetEventParameter( event, kEventParamDirectObject, typeHICommand, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keyword">sizeof</span>(HICommand), <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;cmd );
<a name="l00570"></a>00570         <span class="keywordflow">if</span> (ret == noErr &amp;&amp; (cmd.attributes &amp; kHICommandFromMenu) != 0) 
<a name="l00571"></a>00571           ret = <a class="code" href="Fl__mac_8cxx.html#a4173f3c0b06d69a442e88707e67abcf7">HandleMenu</a>( &amp;cmd );
<a name="l00572"></a>00572         <span class="keywordflow">else</span> 
<a name="l00573"></a>00573           ret = eventNotHandledErr;
<a name="l00574"></a>00574         <span class="keywordflow">break</span>;
<a name="l00575"></a>00575     }
<a name="l00576"></a>00576     <span class="keywordflow">break</span>;
<a name="l00577"></a>00577   <span class="keywordflow">case</span> <a class="code" href="Fl__mac_8cxx.html#a2970898e8a43ce21e1cc510d49f1b89da4d1fadb014d21f05dc6f3821424edb12">kEventClassFLTK</a>:
<a name="l00578"></a>00578     <span class="keywordflow">switch</span> ( GetEventKind( event ) )
<a name="l00579"></a>00579     {
<a name="l00580"></a>00580     <span class="keywordflow">case</span> <a class="code" href="Fl__mac_8cxx.html#afa231099d07583c3ed0981e0bb665f55a13872f920fa565fdc265324fd95c273b">kEventFLTKBreakLoop</a>:
<a name="l00581"></a>00581       ret = noErr;
<a name="l00582"></a>00582       <span class="keywordflow">break</span>;
<a name="l00583"></a>00583     <span class="keywordflow">case</span> <a class="code" href="Fl__mac_8cxx.html#afa231099d07583c3ed0981e0bb665f55ad38bac2c71d5ad1aff0cc34bab67ac08">kEventFLTKDataReady</a>:
<a name="l00584"></a>00584       {
<a name="l00585"></a>00585         dataready.<a class="code" href="classDataReady.html#a09cbc5b242a2075318e5743996ee4a1e">CancelThread</a>(<a class="code" href="Fl__mac_8cxx.html#a52ec816ebb31da9a8f9adf9ea690afcd">DEBUGTEXT</a>(<span class="stringliteral">&quot;DATA READY EVENT\n&quot;</span>));
<a name="l00586"></a>00586 
<a name="l00587"></a>00587         <span class="comment">// CHILD THREAD TELLS US DATA READY</span>
<a name="l00588"></a>00588         <span class="comment">//     Check to see what&#39;s ready, and invoke user&#39;s cb&#39;s</span>
<a name="l00589"></a>00589         <span class="comment">//</span>
<a name="l00590"></a>00590         fd_set r,<a class="code" href="forms_8H-2.html#aac374e320caaadeca4874add33b62af2">w</a>,<a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>;
<a name="l00591"></a>00591         <span class="keywordflow">switch</span>(dataready.<a class="code" href="classDataReady.html#ad2fb69a0073537ccd0ae4c60db6944b2">CheckData</a>(r,w,x))
<a name="l00592"></a>00592         {
<a name="l00593"></a>00593           <span class="keywordflow">case</span> 0:       <span class="comment">// NO DATA</span>
<a name="l00594"></a>00594             <span class="keywordflow">break</span>;
<a name="l00595"></a>00595           <span class="keywordflow">case</span> -1:      <span class="comment">// ERROR</span>
<a name="l00596"></a>00596             <span class="keywordflow">break</span>;
<a name="l00597"></a>00597           <span class="keywordflow">default</span>:      <span class="comment">// DATA READY</span>
<a name="l00598"></a>00598             dataready.<a class="code" href="classDataReady.html#ac701172bd3b89867f6cb2b1cd206565a">HandleData</a>(r,w,x);
<a name="l00599"></a>00599             <span class="keywordflow">break</span>;
<a name="l00600"></a>00600         }
<a name="l00601"></a>00601       }
<a name="l00602"></a>00602       ret = noErr;
<a name="l00603"></a>00603       <span class="keywordflow">break</span>;
<a name="l00604"></a>00604     }
<a name="l00605"></a>00605   }
<a name="l00606"></a>00606   <span class="keywordflow">if</span> ( ret == eventNotHandledErr )
<a name="l00607"></a>00607     ret = CallNextEventHandler( nextHandler, event ); <span class="comment">// let the OS handle the activation, but continue to get a click-through effect</span>
<a name="l00608"></a>00608 
<a name="l00609"></a>00609   <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l00610"></a>00610 
<a name="l00611"></a>00611   <span class="keywordflow">return</span> ret;
<a name="l00612"></a>00612 }
<a name="l00613"></a>00613 
<a name="l00614"></a>00614 
<a name="l00618"></a>00618 <span class="keyword">static</span> <span class="keywordtype">void</span> breakMacEventLoop()
<a name="l00619"></a>00619 {
<a name="l00620"></a>00620   EventRef breakEvent;
<a name="l00621"></a>00621 
<a name="l00622"></a>00622   <a class="code" href="Fl__mac_8cxx.html#a7c231659c1d4f9ad9126b83cfbcbfb53">fl_lock_function</a>();
<a name="l00623"></a>00623 
<a name="l00624"></a>00624   CreateEvent( 0, <a class="code" href="Fl__mac_8cxx.html#a2970898e8a43ce21e1cc510d49f1b89da4d1fadb014d21f05dc6f3821424edb12">kEventClassFLTK</a>, <a class="code" href="Fl__mac_8cxx.html#afa231099d07583c3ed0981e0bb665f55a13872f920fa565fdc265324fd95c273b">kEventFLTKBreakLoop</a>, 0, kEventAttributeUserEvent, &amp;breakEvent );
<a name="l00625"></a>00625   PostEventToQueue( GetCurrentEventQueue(), breakEvent, kEventPriorityStandard );
<a name="l00626"></a>00626   ReleaseEvent( breakEvent );
<a name="l00627"></a>00627 
<a name="l00628"></a>00628   <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l00629"></a>00629 }
<a name="l00630"></a>00630 
<a name="l00631"></a>00631 <span class="comment">//</span>
<a name="l00632"></a>00632 <span class="comment">// MacOS X timers</span>
<a name="l00633"></a>00633 <span class="comment">//</span>
<a name="l00634"></a>00634 
<a name="l00635"></a><a class="code" href="structMacTimeout.html">00635</a> <span class="keyword">struct </span><a class="code" href="structMacTimeout.html">MacTimeout</a> {
<a name="l00636"></a><a class="code" href="structMacTimeout.html#a13d349713ab4eb38a5e14f975f84cf08">00636</a>     <a class="code" href="group__callback__functions.html#gaf00cf21170aa3231f6e869a30a036390">Fl_Timeout_Handler</a> <a class="code" href="structMacTimeout.html#a13d349713ab4eb38a5e14f975f84cf08">callback</a>;
<a name="l00637"></a><a class="code" href="structMacTimeout.html#ad232eaa73f22599f0d0883a90477ba3d">00637</a>     <span class="keywordtype">void</span>* <a class="code" href="structMacTimeout.html#ad232eaa73f22599f0d0883a90477ba3d">data</a>;
<a name="l00638"></a><a class="code" href="structMacTimeout.html#aac4fe2df22f669ea5ba8ddf0ba7d200d">00638</a>     EventLoopTimerRef <a class="code" href="structMacTimeout.html#aac4fe2df22f669ea5ba8ddf0ba7d200d">timer</a>;
<a name="l00639"></a><a class="code" href="structMacTimeout.html#ae92acad4291822ffe6c1a37a7edc572b">00639</a>     EventLoopTimerUPP <a class="code" href="structMacTimeout.html#ae92acad4291822ffe6c1a37a7edc572b">upp</a>;
<a name="l00640"></a><a class="code" href="structMacTimeout.html#aa734ee03fd9d56dcac5b967efe33e7a1">00640</a>     <span class="keywordtype">char</span> <a class="code" href="structMacTimeout.html#aa734ee03fd9d56dcac5b967efe33e7a1">pending</a>; 
<a name="l00641"></a>00641 };
<a name="l00642"></a>00642 <span class="keyword">static</span> <a class="code" href="structMacTimeout.html">MacTimeout</a>* mac_timers;
<a name="l00643"></a>00643 <span class="keyword">static</span> <span class="keywordtype">int</span> mac_timer_alloc;
<a name="l00644"></a>00644 <span class="keyword">static</span> <span class="keywordtype">int</span> mac_timer_used;
<a name="l00645"></a>00645 
<a name="l00646"></a>00646 
<a name="l00647"></a>00647 <span class="keyword">static</span> <span class="keywordtype">void</span> realloc_timers()
<a name="l00648"></a>00648 {
<a name="l00649"></a>00649     <span class="keywordflow">if</span> (mac_timer_alloc == 0) {
<a name="l00650"></a>00650         mac_timer_alloc = 8;
<a name="l00651"></a>00651     }
<a name="l00652"></a>00652     mac_timer_alloc *= 2;
<a name="l00653"></a>00653     <a class="code" href="structMacTimeout.html">MacTimeout</a>* new_timers = <span class="keyword">new</span> <a class="code" href="structMacTimeout.html">MacTimeout</a>[mac_timer_alloc];
<a name="l00654"></a>00654     memset(new_timers, 0, <span class="keyword">sizeof</span>(<a class="code" href="structMacTimeout.html">MacTimeout</a>)*mac_timer_alloc);
<a name="l00655"></a>00655     memcpy(new_timers, mac_timers, <span class="keyword">sizeof</span>(<a class="code" href="structMacTimeout.html">MacTimeout</a>) * mac_timer_used);
<a name="l00656"></a>00656     <a class="code" href="structMacTimeout.html">MacTimeout</a>* delete_me = mac_timers;
<a name="l00657"></a>00657     mac_timers = new_timers;
<a name="l00658"></a>00658     <span class="keyword">delete</span> [] delete_me;
<a name="l00659"></a>00659 }
<a name="l00660"></a>00660 
<a name="l00661"></a>00661 <span class="keyword">static</span> <span class="keywordtype">void</span> delete_timer(<a class="code" href="structMacTimeout.html">MacTimeout</a>&amp; t)
<a name="l00662"></a>00662 {
<a name="l00663"></a>00663     <span class="keywordflow">if</span> (t.<a class="code" href="structMacTimeout.html#aac4fe2df22f669ea5ba8ddf0ba7d200d">timer</a>) {
<a name="l00664"></a>00664         RemoveEventLoopTimer(t.<a class="code" href="structMacTimeout.html#aac4fe2df22f669ea5ba8ddf0ba7d200d">timer</a>);
<a name="l00665"></a>00665         DisposeEventLoopTimerUPP(t.<a class="code" href="structMacTimeout.html#ae92acad4291822ffe6c1a37a7edc572b">upp</a>);
<a name="l00666"></a>00666         memset(&amp;t, 0, <span class="keyword">sizeof</span>(<a class="code" href="structMacTimeout.html">MacTimeout</a>));
<a name="l00667"></a>00667     }
<a name="l00668"></a>00668 }
<a name="l00669"></a>00669 
<a name="l00670"></a>00670 
<a name="l00671"></a>00671 <span class="keyword">static</span> pascal <span class="keywordtype">void</span> do_timer(EventLoopTimerRef timer, <span class="keywordtype">void</span>* <a class="code" href="jpeglib_8h.html#ae5784a8f4db42de0ffacd0cbd08dc6ad">data</a>)
<a name="l00672"></a>00672 {
<a name="l00673"></a>00673    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a> = 0;  <a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a> &lt; mac_timer_used;  ++<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>) {
<a name="l00674"></a>00674         <a class="code" href="structMacTimeout.html">MacTimeout</a>&amp; t = mac_timers[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>];
<a name="l00675"></a>00675         <span class="keywordflow">if</span> (t.<a class="code" href="structMacTimeout.html#aac4fe2df22f669ea5ba8ddf0ba7d200d">timer</a> == timer  &amp;&amp;  t.<a class="code" href="structMacTimeout.html#ad232eaa73f22599f0d0883a90477ba3d">data</a> == data) {
<a name="l00676"></a>00676             t.<a class="code" href="structMacTimeout.html#aa734ee03fd9d56dcac5b967efe33e7a1">pending</a> = 0;
<a name="l00677"></a>00677             (*t.<a class="code" href="structMacTimeout.html#a13d349713ab4eb38a5e14f975f84cf08">callback</a>)(data);
<a name="l00678"></a>00678             <span class="keywordflow">if</span> (t.<a class="code" href="structMacTimeout.html#aa734ee03fd9d56dcac5b967efe33e7a1">pending</a>==0)
<a name="l00679"></a>00679               delete_timer(t);
<a name="l00680"></a>00680             <span class="keywordflow">break</span>;
<a name="l00681"></a>00681         }
<a name="l00682"></a>00682     }
<a name="l00683"></a>00683     breakMacEventLoop();
<a name="l00684"></a>00684 }
<a name="l00685"></a>00685 
<a name="l00691"></a>00691 <span class="keyword">static</span> <span class="keywordtype">double</span> do_queued_events( <span class="keywordtype">double</span> time = 0.0 ) 
<a name="l00692"></a>00692 {
<a name="l00693"></a>00693   <span class="keyword">static</span> <span class="keywordtype">bool</span> been_here = <span class="keyword">false</span>;
<a name="l00694"></a>00694   <span class="keyword">static</span> RgnHandle rgn;
<a name="l00695"></a>00695   
<a name="l00696"></a>00696   <span class="comment">// initialize events and a region that enables mouse move events</span>
<a name="l00697"></a>00697   <span class="keywordflow">if</span> (!been_here) {
<a name="l00698"></a>00698     rgn = NewRgn();
<a name="l00699"></a>00699     Point mp;
<a name="l00700"></a>00700     GetMouse(&amp;mp);
<a name="l00701"></a>00701     SetRectRgn(rgn, mp.h, mp.v, mp.h, mp.v);
<a name="l00702"></a>00702     SetEventMask(everyEvent);
<a name="l00703"></a>00703     been_here = <span class="keyword">true</span>;
<a name="l00704"></a>00704   }
<a name="l00705"></a>00705   OSStatus ret;
<a name="l00706"></a>00706   <span class="keyword">static</span> EventTargetRef target = 0;
<a name="l00707"></a>00707   <span class="keywordflow">if</span> ( !target ) 
<a name="l00708"></a>00708   {
<a name="l00709"></a>00709     target = GetEventDispatcherTarget();
<a name="l00710"></a>00710 
<a name="l00711"></a>00711     EventHandlerUPP dispatchHandler = NewEventHandlerUPP( carbonDispatchHandler ); <span class="comment">// will not be disposed by Carbon...</span>
<a name="l00712"></a>00712     <span class="keyword">static</span> EventTypeSpec dispatchEvents[] = {
<a name="l00713"></a>00713         { kEventClassWindow, kEventWindowShown },
<a name="l00714"></a>00714         { kEventClassWindow, kEventWindowHidden },
<a name="l00715"></a>00715         { kEventClassWindow, kEventWindowActivated },
<a name="l00716"></a>00716         { kEventClassWindow, kEventWindowDeactivated },
<a name="l00717"></a>00717         { kEventClassWindow, kEventWindowClose },
<a name="l00718"></a>00718         { kEventClassKeyboard, kEventRawKeyDown },
<a name="l00719"></a>00719         { kEventClassKeyboard, kEventRawKeyRepeat },
<a name="l00720"></a>00720         { kEventClassKeyboard, kEventRawKeyUp },
<a name="l00721"></a>00721         { kEventClassKeyboard, kEventRawKeyModifiersChanged },
<a name="l00722"></a>00722         { kEventClassMouse, kEventMouseDown },
<a name="l00723"></a>00723         { kEventClassMouse, kEventMouseUp },
<a name="l00724"></a>00724         { kEventClassMouse, kEventMouseMoved },
<a name="l00725"></a>00725         { kEventClassMouse, 11 }, <span class="comment">// MightyMouse wheels</span>
<a name="l00726"></a>00726         { kEventClassMouse, kEventMouseWheelMoved },
<a name="l00727"></a>00727         { kEventClassMouse, kEventMouseDragged },
<a name="l00728"></a>00728         { <a class="code" href="Fl__mac_8cxx.html#a2970898e8a43ce21e1cc510d49f1b89da4d1fadb014d21f05dc6f3821424edb12">kEventClassFLTK</a>, <a class="code" href="Fl__mac_8cxx.html#afa231099d07583c3ed0981e0bb665f55a13872f920fa565fdc265324fd95c273b">kEventFLTKBreakLoop</a> },
<a name="l00729"></a>00729         { <a class="code" href="Fl__mac_8cxx.html#a2970898e8a43ce21e1cc510d49f1b89da4d1fadb014d21f05dc6f3821424edb12">kEventClassFLTK</a>, <a class="code" href="Fl__mac_8cxx.html#afa231099d07583c3ed0981e0bb665f55ad38bac2c71d5ad1aff0cc34bab67ac08">kEventFLTKDataReady</a> } };
<a name="l00730"></a>00730     ret = InstallEventHandler( target, dispatchHandler, GetEventTypeCount(dispatchEvents), dispatchEvents, 0, 0L );
<a name="l00731"></a>00731     <span class="keyword">static</span> EventTypeSpec appEvents[] = {
<a name="l00732"></a>00732         { kEventClassCommand, kEventCommandProcess } };
<a name="l00733"></a>00733     ret = InstallApplicationEventHandler( dispatchHandler, GetEventTypeCount(appEvents), appEvents, 0, 0L );
<a name="l00734"></a>00734   }
<a name="l00735"></a>00735 
<a name="l00736"></a>00736   got_events = 0;
<a name="l00737"></a>00737 
<a name="l00738"></a>00738   <span class="comment">// Check for re-entrant condition</span>
<a name="l00739"></a>00739   <span class="keywordflow">if</span> ( dataready.<a class="code" href="classDataReady.html#a51474ea8ee76b766e6748ec354ea9f29">IsThreadRunning</a>() )
<a name="l00740"></a>00740     { dataready.<a class="code" href="classDataReady.html#a09cbc5b242a2075318e5743996ee4a1e">CancelThread</a>(<a class="code" href="Fl__mac_8cxx.html#a52ec816ebb31da9a8f9adf9ea690afcd">DEBUGTEXT</a>(<span class="stringliteral">&quot;AVOID REENTRY\n&quot;</span>)); }
<a name="l00741"></a>00741 
<a name="l00742"></a>00742   <span class="comment">// Start thread to watch for data ready</span>
<a name="l00743"></a>00743   <span class="keywordflow">if</span> ( dataready.<a class="code" href="classDataReady.html#a42964a0a731eeedcb4dfc4c0b4bacd94">GetNfds</a>() )
<a name="l00744"></a>00744       { dataready.<a class="code" href="classDataReady.html#aa64b9a59088565f9ed5b31c8635e7b6c">StartThread</a>((<span class="keywordtype">void</span>*)GetCurrentEventQueue()); }
<a name="l00745"></a>00745 
<a name="l00746"></a>00746   <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l00747"></a>00747 
<a name="l00748"></a>00748   EventRef event;
<a name="l00749"></a>00749   EventTimeout timeout = time;
<a name="l00750"></a>00750   <span class="keywordflow">if</span> (!ReceiveNextEvent(0, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, timeout, <span class="keyword">true</span>, &amp;event)) {
<a name="l00751"></a>00751     got_events = 1;
<a name="l00752"></a>00752     OSErr ret = SendEventToEventTarget( event, target );
<a name="l00753"></a>00753     <span class="keywordflow">if</span> (ret!=noErr) {
<a name="l00754"></a>00754       EventRecord clevent;
<a name="l00755"></a>00755       ConvertEventRefToEventRecord(event, &amp;clevent);
<a name="l00756"></a>00756       <span class="keywordflow">if</span> (clevent.what==kHighLevelEvent) {
<a name="l00757"></a>00757         ret = AEProcessAppleEvent(&amp;clevent);
<a name="l00758"></a>00758       }
<a name="l00759"></a>00759     }
<a name="l00760"></a>00760     <span class="keywordflow">if</span> (   ret==eventNotHandledErr
<a name="l00761"></a>00761         &amp;&amp; GetEventClass(event)==kEventClassMouse
<a name="l00762"></a>00762         &amp;&amp; GetEventKind(event)==kEventMouseDown ) {
<a name="l00763"></a>00763       WindowRef win; Point pos;
<a name="l00764"></a>00764       GetEventParameter(event, kEventParamMouseLocation, typeQDPoint,
<a name="l00765"></a>00765         <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keyword">sizeof</span>(pos), <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;pos);
<a name="l00766"></a>00766       <span class="keywordflow">if</span> (MacFindWindow(pos, &amp;win)==inMenuBar) {
<a name="l00767"></a>00767         MenuSelect(pos);
<a name="l00768"></a>00768       }
<a name="l00769"></a>00769     }
<a name="l00770"></a>00770     ReleaseEvent( event );
<a name="l00771"></a>00771   }
<a name="l00772"></a>00772 
<a name="l00773"></a>00773   <a class="code" href="Fl__mac_8cxx.html#a7c231659c1d4f9ad9126b83cfbcbfb53">fl_lock_function</a>();
<a name="l00774"></a>00774 
<a name="l00775"></a>00775 <span class="preprocessor">#if CONSOLIDATE_MOTION</span>
<a name="l00776"></a>00776 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (send_motion &amp;&amp; send_motion == fl_xmousewin) {
<a name="l00777"></a>00777     send_motion = 0;
<a name="l00778"></a>00778     <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>(<a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3acd57cae091eb27c9a52c446bdd0c164d">FL_MOVE</a>, fl_xmousewin);
<a name="l00779"></a>00779   }
<a name="l00780"></a>00780 <span class="preprocessor">#endif</span>
<a name="l00781"></a>00781 <span class="preprocessor"></span>
<a name="l00782"></a>00782   <span class="keywordflow">return</span> time;
<a name="l00783"></a>00783 }
<a name="l00784"></a>00784 
<a name="l00785"></a>00785 
<a name="l00793"></a><a class="code" href="Fl__mac_8cxx.html#a55e2ddfbe9d4603198ae690c8e54e565">00793</a> <span class="keywordtype">int</span> <a class="code" href="Fl_8cxx.html#a55e2ddfbe9d4603198ae690c8e54e565">fl_wait</a>( <span class="keywordtype">double</span> time ) 
<a name="l00794"></a>00794 {
<a name="l00795"></a>00795   do_queued_events( time );
<a name="l00796"></a>00796   <span class="keywordflow">return</span> (got_events);
<a name="l00797"></a>00797 }
<a name="l00798"></a>00798 
<a name="l00799"></a>00799 
<a name="l00804"></a>00804 <span class="keyword">static</span> OSErr QuitAppleEventHandler( <span class="keyword">const</span> AppleEvent *appleEvt, AppleEvent* reply, UInt32 refcon )
<a name="l00805"></a>00805 {
<a name="l00806"></a>00806   <a class="code" href="Fl__mac_8cxx.html#a7c231659c1d4f9ad9126b83cfbcbfb53">fl_lock_function</a>();
<a name="l00807"></a>00807 
<a name="l00808"></a>00808   <span class="keywordflow">while</span> ( <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a> ) {
<a name="l00809"></a>00809     <a class="code" href="classFl__X.html">Fl_X</a> *<a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a> = <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a>;
<a name="l00810"></a>00810     <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>( <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a42828f08af2b2191bbc60e113ec08f01">FL_CLOSE</a>, x-&gt;<a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a> );
<a name="l00811"></a>00811     <span class="keywordflow">if</span> ( <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a> == x ) {
<a name="l00812"></a>00812       <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l00813"></a>00813       <span class="keywordflow">return</span> noErr; <span class="comment">// FLTK has not close all windows, so we return to the main program now</span>
<a name="l00814"></a>00814     }
<a name="l00815"></a>00815   }
<a name="l00816"></a>00816 
<a name="l00817"></a>00817   <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l00818"></a>00818 
<a name="l00819"></a>00819   <span class="keywordflow">return</span> noErr;
<a name="l00820"></a>00820 }
<a name="l00821"></a>00821 
<a name="l00822"></a>00822 
<a name="l00827"></a>00827 <span class="keyword">static</span> pascal OSStatus carbonWindowHandler( EventHandlerCallRef nextHandler, EventRef event, <span class="keywordtype">void</span> *userData )
<a name="l00828"></a>00828 {
<a name="l00829"></a>00829   UInt32 kind = GetEventKind( event );
<a name="l00830"></a>00830   OSStatus ret = eventNotHandledErr;
<a name="l00831"></a>00831   <a class="code" href="classFl__Window.html">Fl_Window</a> *window = (<a class="code" href="classFl__Window.html">Fl_Window</a>*)userData;
<a name="l00832"></a>00832   <a class="code" href="group__fl__windows.html#ga3130407bc1c11f9b7f2a9c43a87a1599">Fl::first_window</a>(window);
<a name="l00833"></a>00833 
<a name="l00834"></a>00834   Rect currentBounds, originalBounds;
<a name="l00835"></a>00835   WindowClass winClass;
<a name="l00836"></a>00836   <span class="keyword">static</span> <a class="code" href="classFl__Window.html">Fl_Window</a> *activeWindow = 0;
<a name="l00837"></a>00837   
<a name="l00838"></a>00838   <a class="code" href="Fl__mac_8cxx.html#a7c231659c1d4f9ad9126b83cfbcbfb53">fl_lock_function</a>();
<a name="l00839"></a>00839   
<a name="l00840"></a>00840   <span class="keywordflow">switch</span> ( kind )
<a name="l00841"></a>00841   {
<a name="l00842"></a>00842   <span class="keywordflow">case</span> kEventWindowBoundsChanging:
<a name="l00843"></a>00843     GetEventParameter( event, kEventParamCurrentBounds, typeQDRectangle, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keyword">sizeof</span>(Rect), <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;currentBounds );
<a name="l00844"></a>00844     GetEventParameter( event, kEventParamOriginalBounds, typeQDRectangle, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keyword">sizeof</span>(Rect), <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;originalBounds );
<a name="l00845"></a>00845     <span class="keywordflow">break</span>;
<a name="l00846"></a>00846   <span class="keywordflow">case</span> kEventWindowDrawContent:
<a name="l00847"></a>00847     handleUpdateEvent( <a class="code" href="mac_8H.html#a87152d2ed84f9d97c6bf3150c7688261">fl_xid</a>( window ) );
<a name="l00848"></a>00848     ret = noErr;
<a name="l00849"></a>00849     <span class="keywordflow">break</span>;
<a name="l00850"></a>00850   <span class="keywordflow">case</span> kEventWindowBoundsChanged: {
<a name="l00851"></a>00851     GetEventParameter( event, kEventParamCurrentBounds, typeQDRectangle, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keyword">sizeof</span>(Rect), <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;currentBounds );
<a name="l00852"></a>00852     GetEventParameter( event, kEventParamOriginalBounds, typeQDRectangle, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keyword">sizeof</span>(Rect), <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;originalBounds );
<a name="l00853"></a>00853     <span class="keywordtype">int</span> X = currentBounds.left, W = currentBounds.right-X;
<a name="l00854"></a>00854     <span class="keywordtype">int</span> Y = currentBounds.top, <a class="code" href="Fl__Tooltip_8cxx.html#affa487e8e3cc48473cfc05c0ce0165e9">H</a> = currentBounds.bottom-Y;
<a name="l00855"></a>00855     resize_from_system = window;
<a name="l00856"></a>00856     window-&gt;<a class="code" href="classFl__Window.html#a7b3f27fe1b0fbc2a06065a7f037a2fbb">resize</a>( X, Y, W, <a class="code" href="Fl__Tooltip_8cxx.html#affa487e8e3cc48473cfc05c0ce0165e9">H</a> );
<a name="l00857"></a>00857     <span class="keywordflow">if</span> ( ( originalBounds.right - originalBounds.left != W ) 
<a name="l00858"></a>00858       || ( originalBounds.bottom - originalBounds.top != <a class="code" href="Fl__Tooltip_8cxx.html#affa487e8e3cc48473cfc05c0ce0165e9">H</a> ) )
<a name="l00859"></a>00859     {
<a name="l00860"></a>00860       <span class="keywordflow">if</span> ( window-&gt;<a class="code" href="classFl__Window.html#aa09300542b2d8b49fc69a037bdd3b742">shown</a>() ) 
<a name="l00861"></a>00861         handleUpdateEvent( <a class="code" href="mac_8H.html#a87152d2ed84f9d97c6bf3150c7688261">fl_xid</a>( window ) );
<a name="l00862"></a>00862     } 
<a name="l00863"></a>00863     <span class="keywordflow">break</span>; }
<a name="l00864"></a>00864   <span class="keywordflow">case</span> kEventWindowShown:
<a name="l00865"></a>00865     <span class="keywordflow">if</span> ( !window-&gt;<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>() )
<a name="l00866"></a>00866     {
<a name="l00867"></a>00867       GetWindowClass( <a class="code" href="mac_8H.html#a87152d2ed84f9d97c6bf3150c7688261">fl_xid</a>( window ), &amp;winClass );
<a name="l00868"></a>00868       <span class="keywordflow">if</span> ( winClass != kHelpWindowClass ) {     <span class="comment">// help windows can&#39;t get the focus!</span>
<a name="l00869"></a>00869         <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>( <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3adaac2a187beb309443d668a20a59986b">FL_FOCUS</a>, window);
<a name="l00870"></a>00870         activeWindow = window;
<a name="l00871"></a>00871       }
<a name="l00872"></a>00872       <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>( <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a9edbfd236c9ea348dcaae935a76bd885">FL_SHOW</a>, window);
<a name="l00873"></a>00873       mods_to_e_state(GetCurrentKeyModifiers());
<a name="l00874"></a>00874     }
<a name="l00875"></a>00875     <span class="keywordflow">break</span>;
<a name="l00876"></a>00876   <span class="keywordflow">case</span> kEventWindowHidden:
<a name="l00877"></a>00877     <span class="keywordflow">if</span> ( !window-&gt;<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>() ) <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>( <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3aed9d7c8fbb9dac1e16f762195f00d5d6">FL_HIDE</a>, window);
<a name="l00878"></a>00878     <span class="keywordflow">break</span>;
<a name="l00879"></a>00879   <span class="keywordflow">case</span> kEventWindowActivated:
<a name="l00880"></a>00880     <span class="keywordflow">if</span> ( window-&gt;<a class="code" href="classFl__Window.html#aa09300542b2d8b49fc69a037bdd3b742">shown</a>() &amp;&amp; window!=activeWindow )
<a name="l00881"></a>00881     {
<a name="l00882"></a>00882       GetWindowClass( <a class="code" href="mac_8H.html#a87152d2ed84f9d97c6bf3150c7688261">fl_xid</a>( window ), &amp;winClass );
<a name="l00883"></a>00883       <span class="keywordflow">if</span> ( winClass != kHelpWindowClass ) {     <span class="comment">// help windows can&#39;t get the focus!</span>
<a name="l00884"></a>00884         <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>( <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3adaac2a187beb309443d668a20a59986b">FL_FOCUS</a>, window);
<a name="l00885"></a>00885         activeWindow = window;
<a name="l00886"></a>00886       }
<a name="l00887"></a>00887     }
<a name="l00888"></a>00888     <span class="keywordflow">break</span>;
<a name="l00889"></a>00889   <span class="keywordflow">case</span> kEventWindowDeactivated:
<a name="l00890"></a>00890     <span class="keywordflow">if</span> ( window==activeWindow ) 
<a name="l00891"></a>00891     {
<a name="l00892"></a>00892       <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>( <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a7d2e5eb9247b1927ba5cc26dc82acaf3">FL_UNFOCUS</a>, window);
<a name="l00893"></a>00893       activeWindow = 0;
<a name="l00894"></a>00894     }
<a name="l00895"></a>00895     <span class="keywordflow">break</span>;
<a name="l00896"></a>00896   <span class="keywordflow">case</span> kEventWindowClose:
<a name="l00897"></a>00897     <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>( <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a42828f08af2b2191bbc60e113ec08f01">FL_CLOSE</a>, window ); <span class="comment">// this might or might not close the window</span>
<a name="l00898"></a>00898     <span class="comment">// if there are no more windows, send a high-level quit event</span>
<a name="l00899"></a>00899     <span class="keywordflow">if</span> (!<a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a>) QuitAppleEventHandler( 0, 0, 0 );
<a name="l00900"></a>00900     ret = noErr; <span class="comment">// returning noErr tells Carbon to stop following up on this event</span>
<a name="l00901"></a>00901     <span class="keywordflow">break</span>;
<a name="l00902"></a>00902   <span class="keywordflow">case</span> kEventWindowCollapsed:
<a name="l00903"></a>00903     window-&gt;<a class="code" href="classFl__Widget.html#a19e89bf3b3d2e418b772739ffa6e24d7">clear_visible</a>();
<a name="l00904"></a>00904     <span class="keywordflow">break</span>;
<a name="l00905"></a>00905   <span class="keywordflow">case</span> kEventWindowExpanded:
<a name="l00906"></a>00906     window-&gt;<a class="code" href="classFl__Widget.html#a85981546c4927bd5e6d43d6e3df3416a">set_visible</a>();
<a name="l00907"></a>00907     <span class="keywordflow">break</span>;
<a name="l00908"></a>00908   }
<a name="l00909"></a>00909 
<a name="l00910"></a>00910   <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l00911"></a>00911 
<a name="l00912"></a>00912   <span class="keywordflow">return</span> ret;
<a name="l00913"></a>00913 }
<a name="l00914"></a>00914 
<a name="l00915"></a>00915 
<a name="l00920"></a>00920 <span class="keyword">static</span> pascal OSStatus carbonMousewheelHandler( EventHandlerCallRef nextHandler, EventRef event, <span class="keywordtype">void</span> *userData )
<a name="l00921"></a>00921 {
<a name="l00922"></a>00922   <span class="comment">// Handle the new &quot;MightyMouse&quot; mouse wheel events. Please, someone explain</span>
<a name="l00923"></a>00923   <span class="comment">// to me why Apple changed the API on this even though the current API</span>
<a name="l00924"></a>00924   <span class="comment">// supports two wheels just fine. Matthias,</span>
<a name="l00925"></a>00925   <a class="code" href="Fl__mac_8cxx.html#a7c231659c1d4f9ad9126b83cfbcbfb53">fl_lock_function</a>();
<a name="l00926"></a>00926 
<a name="l00927"></a>00927   <a class="code" href="Fl__mac_8cxx.html#a7c133406e3b2a07466b73cf6cc0aaa50">fl_os_event</a> = event;
<a name="l00928"></a>00928   <a class="code" href="classFl__Window.html">Fl_Window</a> *window = (<a class="code" href="classFl__Window.html">Fl_Window</a>*)userData;
<a name="l00929"></a>00929   <span class="keywordflow">if</span> ( !window-&gt;<a class="code" href="classFl__Window.html#aa09300542b2d8b49fc69a037bdd3b742">shown</a>() )
<a name="l00930"></a>00930   {
<a name="l00931"></a>00931     <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l00932"></a>00932     <span class="keywordflow">return</span> noErr;
<a name="l00933"></a>00933   }
<a name="l00934"></a>00934   <a class="code" href="group__fl__windows.html#ga3130407bc1c11f9b7f2a9c43a87a1599">Fl::first_window</a>(window);
<a name="l00935"></a>00935 
<a name="l00936"></a>00936   EventMouseWheelAxis axis;
<a name="l00937"></a>00937   GetEventParameter( event, kEventParamMouseWheelAxis, typeMouseWheelAxis, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keyword">sizeof</span>(EventMouseWheelAxis), <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;axis );
<a name="l00938"></a>00938   <span class="keywordtype">long</span> delta;
<a name="l00939"></a>00939   GetEventParameter( event, kEventParamMouseWheelDelta, typeLongInteger, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>), <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;delta );
<a name="l00940"></a>00940 <span class="comment">//  fprintf(stderr, &quot;axis=%d, delta=%d\n&quot;, axis, delta);</span>
<a name="l00941"></a>00941   <span class="keywordflow">if</span> ( axis == kEventMouseWheelAxisX ) {
<a name="l00942"></a>00942     <a class="code" href="classFl.html#a3ef9e966bd64bac1a31bf926e7b640a2">Fl::e_dx</a> = -delta;
<a name="l00943"></a>00943     <a class="code" href="classFl.html#a1ed9dbb954ea9d4d5eaae06ad0778708">Fl::e_dy</a> = 0;
<a name="l00944"></a>00944     <span class="keywordflow">if</span> ( <a class="code" href="classFl.html#a3ef9e966bd64bac1a31bf926e7b640a2">Fl::e_dx</a>) <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>( <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3ad5f7dd40377c51d5795cd53ded3d4bef">FL_MOUSEWHEEL</a>, window );
<a name="l00945"></a>00945   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( axis == kEventMouseWheelAxisY ) {
<a name="l00946"></a>00946     <a class="code" href="classFl.html#a3ef9e966bd64bac1a31bf926e7b640a2">Fl::e_dx</a> = 0;
<a name="l00947"></a>00947     <a class="code" href="classFl.html#a1ed9dbb954ea9d4d5eaae06ad0778708">Fl::e_dy</a> = -delta;
<a name="l00948"></a>00948     <span class="keywordflow">if</span> ( <a class="code" href="classFl.html#a1ed9dbb954ea9d4d5eaae06ad0778708">Fl::e_dy</a>) <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>( <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3ad5f7dd40377c51d5795cd53ded3d4bef">FL_MOUSEWHEEL</a>, window );
<a name="l00949"></a>00949   } <span class="keywordflow">else</span> {
<a name="l00950"></a>00950     <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l00951"></a>00951 
<a name="l00952"></a>00952     <span class="keywordflow">return</span> eventNotHandledErr;
<a name="l00953"></a>00953   }
<a name="l00954"></a>00954 
<a name="l00955"></a>00955   <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l00956"></a>00956   
<a name="l00957"></a>00957   <span class="keywordflow">return</span> noErr;
<a name="l00958"></a>00958 }
<a name="l00959"></a>00959 
<a name="l00960"></a>00960 
<a name="l00964"></a>00964 <span class="keyword">static</span> <span class="keywordtype">void</span> chord_to_e_state( UInt32 chord )
<a name="l00965"></a>00965 {
<a name="l00966"></a>00966   <span class="keyword">static</span> <a class="code" href="fl__types_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a> state[] = 
<a name="l00967"></a>00967   { 
<a name="l00968"></a>00968     0, <a class="code" href="Enumerations_8H.html#afe37a4db5e516754bb8963cd341bf415" title="Mouse button 1 is pushed.">FL_BUTTON1</a>, <a class="code" href="Enumerations_8H.html#a9609bc7247660e05194c4e639f84e24e" title="Mouse button 3 is pushed.">FL_BUTTON3</a>, <a class="code" href="Enumerations_8H.html#afe37a4db5e516754bb8963cd341bf415" title="Mouse button 1 is pushed.">FL_BUTTON1</a>|<a class="code" href="Enumerations_8H.html#a9609bc7247660e05194c4e639f84e24e" title="Mouse button 3 is pushed.">FL_BUTTON3</a>, <a class="code" href="Enumerations_8H.html#a1b597a61f3be6323bce3e8c54283b2b3" title="Mouse button 2 is pushed.">FL_BUTTON2</a>,
<a name="l00969"></a>00969     FL_BUTTON2|<a class="code" href="Enumerations_8H.html#afe37a4db5e516754bb8963cd341bf415" title="Mouse button 1 is pushed.">FL_BUTTON1</a>, FL_BUTTON2|<a class="code" href="Enumerations_8H.html#a9609bc7247660e05194c4e639f84e24e" title="Mouse button 3 is pushed.">FL_BUTTON3</a>, 
<a name="l00970"></a>00970     FL_BUTTON2|<a class="code" href="Enumerations_8H.html#afe37a4db5e516754bb8963cd341bf415" title="Mouse button 1 is pushed.">FL_BUTTON1</a>|FL_BUTTON3
<a name="l00971"></a>00971   };
<a name="l00972"></a>00972   <a class="code" href="classFl.html#a2d93787aec60cb62a759b36267dd9d06">Fl::e_state</a> = ( <a class="code" href="classFl.html#a2d93787aec60cb62a759b36267dd9d06">Fl::e_state</a> &amp; 0xff0000 ) | state[ chord &amp; 0x07 ];
<a name="l00973"></a>00973 }
<a name="l00974"></a>00974 
<a name="l00975"></a>00975 
<a name="l00979"></a>00979 <span class="keyword">static</span> pascal OSStatus carbonMouseHandler( EventHandlerCallRef nextHandler, EventRef event, <span class="keywordtype">void</span> *userData )
<a name="l00980"></a>00980 {
<a name="l00981"></a>00981   <span class="keyword">static</span> <span class="keywordtype">int</span> keysym[] = { 0, <a class="code" href="Enumerations_8H.html#a1df1e46a5113628156ed7b7f995217d0" title="A mouse button; use Fl_Button + n for mouse button n.">FL_Button</a>+1, <a class="code" href="Enumerations_8H.html#a1df1e46a5113628156ed7b7f995217d0" title="A mouse button; use Fl_Button + n for mouse button n.">FL_Button</a>+3, FL_Button+2 };
<a name="l00982"></a>00982   <span class="keyword">static</span> <span class="keywordtype">int</span> px, <a class="code" href="fl__overlay_8cxx.html#aa9511a47fd6271333948489a220e3029">py</a>;
<a name="l00983"></a>00983   <span class="keyword">static</span> <span class="keywordtype">char</span> suppressed = 0;
<a name="l00984"></a>00984 
<a name="l00985"></a>00985   <a class="code" href="Fl__mac_8cxx.html#a7c231659c1d4f9ad9126b83cfbcbfb53">fl_lock_function</a>();
<a name="l00986"></a>00986   
<a name="l00987"></a>00987   <a class="code" href="Fl__mac_8cxx.html#a7c133406e3b2a07466b73cf6cc0aaa50">fl_os_event</a> = event;
<a name="l00988"></a>00988   <a class="code" href="classFl__Window.html">Fl_Window</a> *window = (<a class="code" href="classFl__Window.html">Fl_Window</a>*)userData;
<a name="l00989"></a>00989   <span class="keywordflow">if</span> ( !window-&gt;<a class="code" href="classFl__Window.html#aa09300542b2d8b49fc69a037bdd3b742">shown</a>() )
<a name="l00990"></a>00990   {
<a name="l00991"></a>00991     <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l00992"></a>00992     <span class="keywordflow">return</span> noErr;
<a name="l00993"></a>00993   }
<a name="l00994"></a>00994   <a class="code" href="group__fl__windows.html#ga3130407bc1c11f9b7f2a9c43a87a1599">Fl::first_window</a>(window);
<a name="l00995"></a>00995   Point pos;
<a name="l00996"></a>00996   GetEventParameter( event, kEventParamMouseLocation, typeQDPoint, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keyword">sizeof</span>(Point), <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;pos );
<a name="l00997"></a>00997   EventMouseButton btn;
<a name="l00998"></a>00998   GetEventParameter( event, kEventParamMouseButton, typeMouseButton, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keyword">sizeof</span>(EventMouseButton), <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;btn );
<a name="l00999"></a>00999   UInt32 clickCount;
<a name="l01000"></a>01000   GetEventParameter( event, kEventParamClickCount, typeUInt32, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keyword">sizeof</span>(UInt32), <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;clickCount );
<a name="l01001"></a>01001   UInt32 chord;
<a name="l01002"></a>01002   GetEventParameter( event, kEventParamMouseChord, typeUInt32, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keyword">sizeof</span>(UInt32), <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;chord );
<a name="l01003"></a>01003   WindowRef xid = <a class="code" href="mac_8H.html#a87152d2ed84f9d97c6bf3150c7688261">fl_xid</a>(window), tempXid;
<a name="l01004"></a>01004   <span class="keywordtype">int</span> sendEvent = 0, part = 0;
<a name="l01005"></a>01005   <span class="keywordflow">switch</span> ( GetEventKind( event ) )
<a name="l01006"></a>01006   {
<a name="l01007"></a>01007   <span class="keywordflow">case</span> kEventMouseDown:
<a name="l01008"></a>01008     part = FindWindow( pos, &amp;tempXid );
<a name="l01009"></a>01009     <span class="keywordflow">if</span> (!(<a class="code" href="group__fl__windows.html#ga100705a8107397cfde7318aa34019739">Fl::grab</a>() &amp;&amp; window!=<a class="code" href="group__fl__windows.html#ga100705a8107397cfde7318aa34019739">Fl::grab</a>())) {
<a name="l01010"></a>01010       <span class="keywordflow">if</span> ( part == inGrow ) {
<a name="l01011"></a>01011         <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l01012"></a>01012         suppressed = 1;
<a name="l01013"></a>01013         <a class="code" href="classFl__Tooltip.html#a836c5e9c21a5277f27dd2e8feab75788">Fl_Tooltip::current</a>(0L);
<a name="l01014"></a>01014         <span class="keywordflow">return</span> CallNextEventHandler( nextHandler, event ); <span class="comment">// let the OS handle this for us</span>
<a name="l01015"></a>01015       }
<a name="l01016"></a>01016       <span class="keywordflow">if</span> ( part != inContent ) {
<a name="l01017"></a>01017         <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l01018"></a>01018         suppressed = 1;
<a name="l01019"></a>01019         <a class="code" href="classFl__Tooltip.html#a836c5e9c21a5277f27dd2e8feab75788">Fl_Tooltip::current</a>(0L);
<a name="l01020"></a>01020         <span class="comment">// anything else to here?</span>
<a name="l01021"></a>01021         <span class="keywordflow">return</span> CallNextEventHandler( nextHandler, event ); <span class="comment">// let the OS handle this for us</span>
<a name="l01022"></a>01022       }
<a name="l01023"></a>01023     }
<a name="l01024"></a>01024     suppressed = 0;
<a name="l01025"></a>01025     <span class="keywordflow">if</span> (part==inContent &amp;&amp; !IsWindowActive( xid ) ) {
<a name="l01026"></a>01026       CallNextEventHandler( nextHandler, event ); <span class="comment">// let the OS handle the activation, but continue to get a click-through effect</span>
<a name="l01027"></a>01027     }
<a name="l01028"></a>01028     <span class="comment">// normal handling of mouse-down follows</span>
<a name="l01029"></a>01029     fl_os_capture = xid;
<a name="l01030"></a>01030     sendEvent = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a44972d76423f3e380ae12c36827944e3">FL_PUSH</a>;
<a name="l01031"></a>01031     <a class="code" href="classFl.html#ad08a92882f820adac97a6dd98313e9b9">Fl::e_is_click</a> = 1; px = pos.h; py = pos.v;
<a name="l01032"></a>01032     <span class="keywordflow">if</span> (clickCount&gt;1) 
<a name="l01033"></a>01033       <a class="code" href="classFl.html#a6f6c6f8bf78bb722178aa19e501ae60e">Fl::e_clicks</a>++;
<a name="l01034"></a>01034     <span class="keywordflow">else</span>
<a name="l01035"></a>01035       <a class="code" href="classFl.html#a6f6c6f8bf78bb722178aa19e501ae60e">Fl::e_clicks</a> = 0;
<a name="l01036"></a>01036     <span class="comment">// fall through</span>
<a name="l01037"></a>01037   <span class="keywordflow">case</span> kEventMouseUp:
<a name="l01038"></a>01038     <span class="keywordflow">if</span> (suppressed) {
<a name="l01039"></a>01039       suppressed = 0;
<a name="l01040"></a>01040       <span class="keywordflow">break</span>;
<a name="l01041"></a>01041     }
<a name="l01042"></a>01042     <span class="keywordflow">if</span> ( !window ) <span class="keywordflow">break</span>;
<a name="l01043"></a>01043     <span class="keywordflow">if</span> ( !sendEvent ) {
<a name="l01044"></a>01044       sendEvent = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a5949b5ff170a8236d2745eddb1e9fd9a">FL_RELEASE</a>; 
<a name="l01045"></a>01045     }
<a name="l01046"></a>01046     <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> = keysym[ btn ];
<a name="l01047"></a>01047     <span class="comment">// fall through</span>
<a name="l01048"></a>01048   <span class="keywordflow">case</span> kEventMouseMoved:
<a name="l01049"></a>01049     suppressed = 0;
<a name="l01050"></a>01050     <span class="keywordflow">if</span> ( !sendEvent ) { 
<a name="l01051"></a>01051       sendEvent = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3acd57cae091eb27c9a52c446bdd0c164d">FL_MOVE</a>; chord = 0; 
<a name="l01052"></a>01052     }
<a name="l01053"></a>01053     <span class="comment">// fall through</span>
<a name="l01054"></a>01054   <span class="keywordflow">case</span> kEventMouseDragged:
<a name="l01055"></a>01055     <span class="keywordflow">if</span> (suppressed) <span class="keywordflow">break</span>;
<a name="l01056"></a>01056     <span class="keywordflow">if</span> ( !sendEvent ) {
<a name="l01057"></a>01057       sendEvent = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3acd57cae091eb27c9a52c446bdd0c164d">FL_MOVE</a>; <span class="comment">// Fl::handle will convert into FL_DRAG</span>
<a name="l01058"></a>01058       <span class="keywordflow">if</span> (abs(pos.h-px)&gt;5 || abs(pos.v-py)&gt;5) 
<a name="l01059"></a>01059         <a class="code" href="classFl.html#ad08a92882f820adac97a6dd98313e9b9">Fl::e_is_click</a> = 0;
<a name="l01060"></a>01060     }
<a name="l01061"></a>01061     chord_to_e_state( chord );
<a name="l01062"></a>01062     GrafPtr oldPort;
<a name="l01063"></a>01063     GetPort( &amp;oldPort );
<a name="l01064"></a>01064     SetPort( GetWindowPort(xid) ); <span class="comment">// \todo replace this! There must be some GlobalToLocal call that has a port as an argument</span>
<a name="l01065"></a>01065     SetOrigin(0, 0);
<a name="l01066"></a>01066     <a class="code" href="classFl.html#ac905dc5f6e4b4c919e405932413fce30">Fl::e_x_root</a> = pos.h;
<a name="l01067"></a>01067     <a class="code" href="classFl.html#af14bafd28cbd839ab2e4526eb4a5c73f">Fl::e_y_root</a> = pos.v;
<a name="l01068"></a>01068     GlobalToLocal( &amp;pos );
<a name="l01069"></a>01069     <a class="code" href="classFl.html#a7b57f90db4afa2b1b1e2e163e9bdc1d3">Fl::e_x</a> = pos.h;
<a name="l01070"></a>01070     <a class="code" href="classFl.html#a0c047ee4ea16066dc9e70bc6a4035c20">Fl::e_y</a> = pos.v;
<a name="l01071"></a>01071     SetPort( oldPort );
<a name="l01072"></a>01072     <span class="keywordflow">if</span> (GetEventKind(event)==kEventMouseDown &amp;&amp; part!=inContent) {
<a name="l01073"></a>01073       <span class="keywordtype">int</span> used = <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>( sendEvent, window );
<a name="l01074"></a>01074       CallNextEventHandler( nextHandler, event ); <span class="comment">// let the OS handle this for us</span>
<a name="l01075"></a>01075       <span class="keywordflow">if</span> (!used) 
<a name="l01076"></a>01076         suppressed = 1;
<a name="l01077"></a>01077     } <span class="keywordflow">else</span> {
<a name="l01078"></a>01078       <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>( sendEvent, window );
<a name="l01079"></a>01079     }
<a name="l01080"></a>01080     <span class="keywordflow">break</span>;
<a name="l01081"></a>01081   }
<a name="l01082"></a>01082 
<a name="l01083"></a>01083   <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l01084"></a>01084   
<a name="l01085"></a>01085   <span class="keywordflow">return</span> noErr;
<a name="l01086"></a>01086 }
<a name="l01087"></a>01087 
<a name="l01088"></a>01088 
<a name="l01092"></a>01092 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> keycode_to_sym( UInt32 keyCode, UInt32 mods, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> deflt )
<a name="l01093"></a>01093 {
<a name="l01094"></a>01094   <span class="keyword">static</span> Ptr map = 0;
<a name="l01095"></a>01095   UInt32 state = 0;
<a name="l01096"></a>01096   <span class="keywordflow">if</span> (!map) {
<a name="l01097"></a>01097     map = (Ptr)GetScriptManagerVariable(smKCHRCache);
<a name="l01098"></a>01098     <span class="keywordflow">if</span> (!map) {
<a name="l01099"></a>01099       <span class="keywordtype">long</span> kbID = GetScriptManagerVariable(smKeyScript);
<a name="l01100"></a>01100       map = *GetResource(<span class="stringliteral">&#39;KCHR&#39;</span>, kbID);
<a name="l01101"></a>01101     }
<a name="l01102"></a>01102   }
<a name="l01103"></a>01103   <span class="keywordflow">if</span> (map)
<a name="l01104"></a>01104     <span class="keywordflow">return</span> KeyTranslate(map, keyCode|mods, &amp;state );
<a name="l01105"></a>01105   <span class="keywordflow">return</span> deflt;
<a name="l01106"></a>01106 }
<a name="l01107"></a>01107 
<a name="l01108"></a>01108 <span class="comment">/*</span>
<a name="l01109"></a>01109 <span class="comment"> * keycode_function for post-10.5 systems, allows more sophisticated decoding of keys</span>
<a name="l01110"></a>01110 <span class="comment"> */</span>
<a name="l01111"></a>01111 <span class="keyword">static</span> <span class="keywordtype">int</span> keycodeToUnicode(
<a name="l01112"></a>01112                 <span class="keywordtype">char</span> * uniChars, <span class="keywordtype">int</span> maxChars,
<a name="l01113"></a>01113                 EventKind eKind,
<a name="l01114"></a>01114                 UInt32 keycode, UInt32 modifiers,
<a name="l01115"></a>01115                 UInt32 * deadKeyStatePtr,
<a name="l01116"></a>01116                 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>,  <span class="comment">// not used in this function</span>
<a name="l01117"></a>01117                 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>) <span class="comment">// not used in this function</span>
<a name="l01118"></a>01118 {
<a name="l01119"></a>01119   <span class="comment">// first get the keyboard mapping in a post 10.2 way</span>
<a name="l01120"></a>01120   
<a name="l01121"></a>01121   Ptr resource;
<a name="l01122"></a>01122   TextEncoding encoding;
<a name="l01123"></a>01123   <span class="keyword">static</span> TextEncoding lastEncoding = kTextEncodingMacRoman;
<a name="l01124"></a>01124   <span class="keywordtype">int</span> len = 0;
<a name="l01125"></a>01125   KeyboardLayoutRef currentLayout = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01126"></a>01126   <span class="keyword">static</span> KeyboardLayoutRef lastLayout = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01127"></a>01127   SInt32 currentLayoutId = 0;
<a name="l01128"></a>01128   <span class="keyword">static</span> SInt32 lastLayoutId;
<a name="l01129"></a>01129   <span class="keywordtype">int</span> hasLayoutChanged = <span class="keyword">false</span>;
<a name="l01130"></a>01130   <span class="keyword">static</span> Ptr uchr = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01131"></a>01131   <span class="keyword">static</span> Ptr KCHR = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01132"></a>01132   <span class="comment">// ScriptCode currentKeyScript;</span>
<a name="l01133"></a>01133   
<a name="l01134"></a>01134   KLGetCurrentKeyboardLayout(&amp;currentLayout);
<a name="l01135"></a>01135   <span class="keywordflow">if</span> (currentLayout) {
<a name="l01136"></a>01136     KLGetKeyboardLayoutProperty(currentLayout, kKLIdentifier, (<span class="keyword">const</span> <span class="keywordtype">void</span>**)&amp;currentLayoutId);
<a name="l01137"></a>01137     <span class="keywordflow">if</span> ( (lastLayout != currentLayout) || (lastLayoutId != currentLayoutId) ) {
<a name="l01138"></a>01138       lastLayout = currentLayout;
<a name="l01139"></a>01139       lastLayoutId = currentLayoutId;
<a name="l01140"></a>01140       uchr = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01141"></a>01141       KCHR = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01142"></a>01142       <span class="keywordflow">if</span> ((KLGetKeyboardLayoutProperty(currentLayout, kKLuchrData, (<span class="keyword">const</span> <span class="keywordtype">void</span>**)&amp;uchr) == noErr) &amp;&amp; (uchr != <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l01143"></a>01143         <span class="comment">// done</span>
<a name="l01144"></a>01144       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((KLGetKeyboardLayoutProperty(currentLayout, kKLKCHRData, (<span class="keyword">const</span> <span class="keywordtype">void</span>**)&amp;KCHR) == noErr) &amp;&amp; (KCHR != <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l01145"></a>01145         <span class="comment">// done</span>
<a name="l01146"></a>01146       }
<a name="l01147"></a>01147       <span class="comment">// FIXME No Layout property found. Now we have a problem. </span>
<a name="l01148"></a>01148     }
<a name="l01149"></a>01149   }
<a name="l01150"></a>01150   <span class="keywordflow">if</span> (hasLayoutChanged) {
<a name="l01151"></a>01151     <span class="comment">//deadKeyStateUp = deadKeyStateDown = 0;</span>
<a name="l01152"></a>01152     <span class="keywordflow">if</span> (KCHR != <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01153"></a>01153       <span class="comment">// FIXME this must not happen</span>
<a name="l01154"></a>01154     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (uchr == <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01155"></a>01155       KCHR = (Ptr) GetScriptManagerVariable(smKCHRCache);
<a name="l01156"></a>01156     }
<a name="l01157"></a>01157   }
<a name="l01158"></a>01158   <span class="keywordflow">if</span> (uchr != <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01159"></a>01159     <span class="comment">// this is what I expect</span>
<a name="l01160"></a>01160     resource = uchr;
<a name="l01161"></a>01161   } <span class="keywordflow">else</span> {
<a name="l01162"></a>01162     resource = KCHR;
<a name="l01163"></a>01163     encoding = lastEncoding;
<a name="l01164"></a>01164     <span class="comment">// this is actually not supported by the following code and will likely crash</span>
<a name="l01165"></a>01165   }
<a name="l01166"></a>01166   
<a name="l01167"></a>01167   <span class="comment">// now apply that keyboard mapping to our keycode</span>
<a name="l01168"></a>01168   
<a name="l01169"></a>01169   <span class="keywordtype">int</span> action;
<a name="l01170"></a>01170   <span class="comment">//OptionBits options = 0;</span>
<a name="l01171"></a>01171   <span class="comment">// not used yet: OptionBits options = kUCKeyTranslateNoDeadKeysMask;</span>
<a name="l01172"></a>01172   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> keyboardType;
<a name="l01173"></a>01173   keycode &amp;= 0xFF;
<a name="l01174"></a>01174   modifiers = (modifiers &gt;&gt; 8) &amp; 0xFF;
<a name="l01175"></a>01175   keyboardType = LMGetKbdType();
<a name="l01176"></a>01176   OSStatus status;
<a name="l01177"></a>01177   UniCharCount actuallength;
<a name="l01178"></a>01178   UniChar utext[10];
<a name="l01179"></a>01179   
<a name="l01180"></a>01180   <span class="keywordflow">switch</span>(eKind) {     
<a name="l01181"></a>01181     <span class="keywordflow">case</span> kEventRawKeyDown:    action = kUCKeyActionDown; <span class="keywordflow">break</span>;
<a name="l01182"></a>01182     <span class="keywordflow">case</span> kEventRawKeyUp:      action = kUCKeyActionUp; <span class="keywordflow">break</span>;
<a name="l01183"></a>01183     <span class="keywordflow">case</span> kEventRawKeyRepeat:  action = kUCKeyActionAutoKey; <span class="keywordflow">break</span>;
<a name="l01184"></a>01184     <span class="keywordflow">default</span>: <span class="keywordflow">return</span> 0;
<a name="l01185"></a>01185   }
<a name="l01186"></a>01186 
<a name="l01187"></a>01187   UInt32 deadKeyState = *deadKeyStatePtr;
<a name="l01188"></a>01188   <span class="keywordflow">if</span> ((action==kUCKeyActionUp)&amp;&amp;(*deadKeyStatePtr))
<a name="l01189"></a>01189     deadKeyStatePtr = &amp;deadKeyState;
<a name="l01190"></a>01190 
<a name="l01191"></a>01191   status = UCKeyTranslate(
<a name="l01192"></a>01192                           (<span class="keyword">const</span> UCKeyboardLayout *) uchr,
<a name="l01193"></a>01193                           keycode, action, modifiers, keyboardType,
<a name="l01194"></a>01194                           0, deadKeyStatePtr,
<a name="l01195"></a>01195                           10, &amp;actuallength, utext);
<a name="l01196"></a>01196 
<a name="l01197"></a>01197   <span class="keywordflow">if</span> (noErr != status) {
<a name="l01198"></a>01198     fprintf(stderr,<span class="stringliteral">&quot;UCKeyTranslate failed: %d\n&quot;</span>, (<span class="keywordtype">int</span>) status);
<a name="l01199"></a>01199     actuallength = 0;
<a name="l01200"></a>01200   }
<a name="l01201"></a>01201 
<a name="l01202"></a>01202   <span class="comment">// convert the list of unicode chars into utf8</span>
<a name="l01203"></a>01203   <span class="comment">// FIXME no bounds check (see maxchars)</span>
<a name="l01204"></a>01204   <span class="keywordtype">unsigned</span> <a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>;
<a name="l01205"></a>01205   <span class="keywordflow">for</span> (i=0; i&lt;actuallength; ++<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>) {
<a name="l01206"></a>01206     len += <a class="code" href="group__fl__unicode.html#gae608a28bc43f10014343483ed3d5e99c">fl_utf8encode</a>(utext[i], uniChars+len);
<a name="l01207"></a>01207   }
<a name="l01208"></a>01208   uniChars[len] = 0;
<a name="l01209"></a>01209   <span class="keywordflow">return</span> len;
<a name="l01210"></a>01210 }
<a name="l01211"></a>01211 
<a name="l01212"></a>01212 <span class="comment">/*</span>
<a name="l01213"></a>01213 <span class="comment"> * keycode_function for pre-10.5 systems, this is the &quot;historic&quot; fltk Mac key handling</span>
<a name="l01214"></a>01214 <span class="comment"> */</span>
<a name="l01215"></a>01215 <span class="keyword">static</span> <span class="keywordtype">int</span> keycode_wrap_old(
<a name="l01216"></a>01216                 <span class="keywordtype">char</span> * buffer,
<a name="l01217"></a>01217                 <span class="keywordtype">int</span>, EventKind, UInt32, <span class="comment">// not used in this function</span>
<a name="l01218"></a>01218                 UInt32, UInt32 *,       <span class="comment">// not used in this function</span>
<a name="l01219"></a>01219                 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="Fl__Text__Editor_8cxx.html#a35af0be900467fedbb610bd6ea65ed78">key</a>,
<a name="l01220"></a>01220                 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> sym)
<a name="l01221"></a>01221 {
<a name="l01222"></a>01222   <span class="keywordflow">if</span> ( (sym &gt;= <a class="code" href="Enumerations_8H.html#a61cc4275772d96a740bef9261cca5760" title="One of the keypad numbers; use FL_KP + n for number n.">FL_KP</a> &amp;&amp; sym &lt;= <a class="code" href="Enumerations_8H.html#a14fb705c31fdb8357ae4f3718e20a018" title="The last keypad key; use to range-check keypad.">FL_KP_Last</a>) || !(sym &amp; 0xff00) ||
<a name="l01223"></a>01223         sym == <a class="code" href="Enumerations_8H.html#aa6e3e7f377cecb30c77f112ce54c3753" title="The tab key.">FL_Tab</a> || sym == <a class="code" href="Enumerations_8H.html#ab4a527fe4d93303976de2fbfec05e19b" title="The enter key.">FL_Enter</a>) {
<a name="l01224"></a>01224     buffer[0] = <a class="code" href="Fl__Text__Editor_8cxx.html#a35af0be900467fedbb610bd6ea65ed78">key</a>;
<a name="l01225"></a>01225     <span class="keywordflow">return</span> 1;
<a name="l01226"></a>01226   } <span class="keywordflow">else</span> {
<a name="l01227"></a>01227     buffer[0] = 0;
<a name="l01228"></a>01228     <span class="keywordflow">return</span> 0;
<a name="l01229"></a>01229   }
<a name="l01230"></a>01230 } <span class="comment">/* keycode_wrap_old */</span>
<a name="l01231"></a>01231 <span class="comment">/* </span>
<a name="l01232"></a>01232 <span class="comment"> * Stub pointer to select appropriate keycode_function per operating system version. This function pointer</span>
<a name="l01233"></a>01233 <span class="comment"> * is initialised in fl_open_display, based on the runtime identification of the host OS version. This is</span>
<a name="l01234"></a>01234 <span class="comment"> * intended to allow us to utilise 10.5 services dynamically to improve Unicode handling, whilst still </span>
<a name="l01235"></a>01235 <span class="comment"> * allowing code to run satisfactorily on older systems.</span>
<a name="l01236"></a>01236 <span class="comment"> */</span>
<a name="l01237"></a>01237 <span class="keyword">static</span> <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a> (*keycode_function)(<span class="keywordtype">char</span>*, <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>, EventKind, UInt32, UInt32, UInt32*, <span class="keywordtype">unsigned</span> char, <span class="keywordtype">unsigned</span> short) = keycode_wrap_old;
<a name="l01238"></a>01238 
<a name="l01239"></a>01239 
<a name="l01240"></a>01240 <span class="comment">// EXPERIMENTAL!</span>
<a name="l01241"></a><a class="code" href="Fl__mac_8cxx.html#a3a040ae7ec69dd5e772636eb9faf688d">01241</a> pascal OSStatus <a class="code" href="Fl__mac_8cxx.html#a3a040ae7ec69dd5e772636eb9faf688d">carbonTextHandler</a>( 
<a name="l01242"></a>01242   EventHandlerCallRef nextHandler, EventRef event, <span class="keywordtype">void</span> *userData )
<a name="l01243"></a>01243 {
<a name="l01244"></a>01244   <a class="code" href="classFl__Window.html">Fl_Window</a> *window = (<a class="code" href="classFl__Window.html">Fl_Window</a>*)userData;
<a name="l01245"></a>01245   <a class="code" href="group__fl__windows.html#ga3130407bc1c11f9b7f2a9c43a87a1599">Fl::first_window</a>(window);
<a name="l01246"></a>01246   <a class="code" href="Fl__mac_8cxx.html#a7c231659c1d4f9ad9126b83cfbcbfb53">fl_lock_function</a>();
<a name="l01247"></a>01247   <span class="comment">//int kind = GetEventKind(event);</span>
<a name="l01248"></a>01248   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="png_8h.html#a9843c7a2b7309da8f96021b45fec0d70">buf</a>[200];
<a name="l01249"></a>01249   ByteCount <a class="code" href="png_8h.html#a43291b8493b637821dec145c4bb1503d">size</a>;
<a name="l01250"></a>01250   GetEventParameter( event, kEventParamTextInputSendText, typeUnicodeText, 
<a name="l01251"></a>01251                      <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 100, &amp;size, &amp;buf );
<a name="l01252"></a>01252 <span class="comment">//  printf(&quot;TextEvent: %02x %02x %02x %02x\n&quot;, buf[0], buf[1], buf[2], buf[3]);</span>
<a name="l01253"></a>01253   <span class="comment">// FIXME: oversimplified!</span>
<a name="l01254"></a>01254   <span class="keywordtype">unsigned</span> ucs = buf[0];
<a name="l01255"></a>01255   <span class="keywordtype">char</span> utf8buf[20];
<a name="l01256"></a>01256   <span class="keywordtype">int</span> len = <a class="code" href="group__fl__unicode.html#gae608a28bc43f10014343483ed3d5e99c">fl_utf8encode</a>(ucs, utf8buf);
<a name="l01257"></a>01257   <a class="code" href="classFl.html#a336911cf63dade9bbb9707b942785133">Fl::e_length</a> = len;
<a name="l01258"></a>01258   <a class="code" href="classFl.html#addcd49b68feff0a807f6564f3fdb8016">Fl::e_text</a> = utf8buf;
<a name="l01259"></a>01259   <span class="keywordflow">while</span> (window-&gt;<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>()) window = window-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>();
<a name="l01260"></a>01260   <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>(<a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a1387c0430ec873aa44704954a369143b">FL_KEYBOARD</a>, window);
<a name="l01261"></a>01261   <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l01262"></a>01262   <a class="code" href="Fl__mac_8cxx.html#a7c231659c1d4f9ad9126b83cfbcbfb53">fl_lock_function</a>();
<a name="l01263"></a>01263   <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>(<a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3ab0e1a75a36767b878915e59e5f9e3be8">FL_KEYUP</a>, window);
<a name="l01264"></a>01264   <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l01265"></a>01265   <span class="comment">// for some reason, the window does not redraw until the next mouse move or button push</span>
<a name="l01266"></a>01266   <span class="comment">// sending a &#39;redraw()&#39; or &#39;awake()&#39; does not solve the issue!</span>
<a name="l01267"></a>01267   <a class="code" href="classFl.html#a08d29d807ea3874b8bb16f7457f64bdc">Fl::flush</a>();
<a name="l01268"></a>01268   <span class="keywordflow">return</span> noErr;
<a name="l01269"></a>01269 }  
<a name="l01270"></a>01270 
<a name="l01274"></a><a class="code" href="Fl__mac_8cxx.html#a84efb1f8474d4ae18c33b07980e5ca70">01274</a> pascal OSStatus <a class="code" href="Fl__mac_8cxx.html#a84efb1f8474d4ae18c33b07980e5ca70">carbonKeyboardHandler</a>( 
<a name="l01275"></a>01275   EventHandlerCallRef nextHandler, EventRef event, <span class="keywordtype">void</span> *userData )
<a name="l01276"></a>01276 {
<a name="l01277"></a>01277   <span class="keyword">static</span> <span class="keywordtype">char</span> buffer[32];
<a name="l01278"></a>01278   <span class="keywordtype">int</span> sendEvent = 0;
<a name="l01279"></a>01279   <a class="code" href="classFl__Window.html">Fl_Window</a> *window = (<a class="code" href="classFl__Window.html">Fl_Window</a>*)userData;
<a name="l01280"></a>01280   <a class="code" href="group__fl__windows.html#ga3130407bc1c11f9b7f2a9c43a87a1599">Fl::first_window</a>(window);
<a name="l01281"></a>01281   UInt32 mods;
<a name="l01282"></a>01282   <span class="keyword">static</span> UInt32 prevMods = mods_to_e_state( GetCurrentKeyModifiers() );
<a name="l01283"></a>01283 
<a name="l01284"></a>01284   <a class="code" href="Fl__mac_8cxx.html#a7c231659c1d4f9ad9126b83cfbcbfb53">fl_lock_function</a>();
<a name="l01285"></a>01285   
<a name="l01286"></a>01286   <span class="keywordtype">int</span> kind = GetEventKind(event);
<a name="l01287"></a>01287   
<a name="l01288"></a>01288   <span class="comment">// get the modifiers for any of the events</span>
<a name="l01289"></a>01289   GetEventParameter( event, kEventParamKeyModifiers, typeUInt32, 
<a name="l01290"></a>01290                      <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keyword">sizeof</span>(UInt32), <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;mods );
<a name="l01291"></a>01291   
<a name="l01292"></a>01292   <span class="comment">// get the key code only for key events</span>
<a name="l01293"></a>01293   UInt32 keyCode = 0, maskedKeyCode = 0;
<a name="l01294"></a>01294   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> key = 0;
<a name="l01295"></a>01295   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> sym = 0;
<a name="l01296"></a>01296   <span class="keywordflow">if</span> (kind!=kEventRawKeyModifiersChanged) {
<a name="l01297"></a>01297     GetEventParameter( event, kEventParamKeyCode, typeUInt32, 
<a name="l01298"></a>01298                        <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keyword">sizeof</span>(UInt32), <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;keyCode );
<a name="l01299"></a>01299     GetEventParameter( event, kEventParamKeyMacCharCodes, typeChar, 
<a name="l01300"></a>01300                        <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;key );
<a name="l01301"></a>01301   }
<a name="l01302"></a>01302   <span class="comment">// extended keyboards can also send sequences on key-up to generate Kanji etc. codes.</span>
<a name="l01303"></a>01303   <span class="comment">// Some observed prefixes are 0x81 to 0x83, followed by an 8 bit keycode.</span>
<a name="l01304"></a>01304   <span class="comment">// In this mode, there seem to be no key-down codes</span>
<a name="l01305"></a>01305 <span class="comment">// printf(&quot;%08x %08x %08x\n&quot;, keyCode, mods, key);</span>
<a name="l01306"></a>01306   maskedKeyCode = keyCode &amp; 0x7f;
<a name="l01307"></a>01307   <span class="comment">/* output a human readable event identifier for debugging </span>
<a name="l01308"></a>01308 <span class="comment">  const char *ev = &quot;&quot;;</span>
<a name="l01309"></a>01309 <span class="comment">  switch (kind) {</span>
<a name="l01310"></a>01310 <span class="comment">    case kEventRawKeyDown: ev = &quot;kEventRawKeyDown&quot;; break;</span>
<a name="l01311"></a>01311 <span class="comment">    case kEventRawKeyRepeat: ev = &quot;kEventRawKeyRepeat&quot;; break;</span>
<a name="l01312"></a>01312 <span class="comment">    case kEventRawKeyUp: ev = &quot;kEventRawKeyUp&quot;; break;</span>
<a name="l01313"></a>01313 <span class="comment">    case kEventRawKeyModifiersChanged: ev = &quot;kEventRawKeyModifiersChanged&quot;; break;</span>
<a name="l01314"></a>01314 <span class="comment">    default: ev = &quot;unknown&quot;;</span>
<a name="l01315"></a>01315 <span class="comment">  }</span>
<a name="l01316"></a>01316 <span class="comment">  printf(&quot;%08x %08x %08x &#39;%c&#39; %s \n&quot;, mods, keyCode, key, key, ev);</span>
<a name="l01317"></a>01317 <span class="comment">  */</span>
<a name="l01318"></a>01318   <span class="keywordflow">switch</span> (kind)
<a name="l01319"></a>01319   {
<a name="l01320"></a>01320   <span class="keywordflow">case</span> kEventRawKeyDown:
<a name="l01321"></a>01321   <span class="keywordflow">case</span> kEventRawKeyRepeat:
<a name="l01322"></a>01322 <span class="comment">/*</span>
<a name="l01323"></a>01323 <span class="comment">    // FIXME Matt: For 10.5, the keycode_function will handle all this. This is untested for ealier versions of OS X.</span>
<a name="l01324"></a>01324 <span class="comment">    // When the user presses a &quot;dead key&quot;, no information is send about</span>
<a name="l01325"></a>01325 <span class="comment">    // which dead key symbol was created. So we need to trick Carbon into</span>
<a name="l01326"></a>01326 <span class="comment">    // giving us the code by sending a &quot;space&quot; after the &quot;dead key&quot;.</span>
<a name="l01327"></a>01327 <span class="comment">    if (key==0) {</span>
<a name="l01328"></a>01328 <span class="comment">      UInt32 ktState = 0;</span>
<a name="l01329"></a>01329 <span class="comment">      KeyboardLayoutRef klr;</span>
<a name="l01330"></a>01330 <span class="comment">      KLGetCurrentKeyboardLayout(&amp;klr);</span>
<a name="l01331"></a>01331 <span class="comment">      const void *kchar = 0; KLGetKeyboardLayoutProperty(klr, kKLKCHRData, &amp;kchar);</span>
<a name="l01332"></a>01332 <span class="comment">      KeyTranslate(kchar, (mods&amp;0xff00) | keyCode, &amp;ktState); // send the dead key</span>
<a name="l01333"></a>01333 <span class="comment">      key = KeyTranslate(kchar, 0x31, &amp;ktState); // fake a space key press</span>
<a name="l01334"></a>01334 <span class="comment">      Fl::e_state |= 0x40000000; // mark this as a dead key</span>
<a name="l01335"></a>01335 <span class="comment">    } else {</span>
<a name="l01336"></a>01336 <span class="comment">      Fl::e_state &amp;= 0xbfffffff; // clear the deadkey flag</span>
<a name="l01337"></a>01337 <span class="comment">    }</span>
<a name="l01338"></a>01338 <span class="comment">*/</span>
<a name="l01339"></a>01339     sendEvent = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a1387c0430ec873aa44704954a369143b">FL_KEYBOARD</a>;
<a name="l01340"></a>01340     <span class="comment">// fall through</span>
<a name="l01341"></a>01341   <span class="keywordflow">case</span> kEventRawKeyUp:
<a name="l01342"></a>01342     <span class="keywordflow">if</span> ( !sendEvent ) {
<a name="l01343"></a>01343       sendEvent = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3ab0e1a75a36767b878915e59e5f9e3be8">FL_KEYUP</a>;
<a name="l01344"></a>01344       <a class="code" href="classFl.html#a2d93787aec60cb62a759b36267dd9d06">Fl::e_state</a> &amp;= 0xbfffffff; <span class="comment">// clear the deadkey flag</span>
<a name="l01345"></a>01345     }
<a name="l01346"></a>01346     <span class="comment">// if the user pressed alt/option, event_key should have the keycap, </span>
<a name="l01347"></a>01347     <span class="comment">// but event_text should generate the international symbol</span>
<a name="l01348"></a>01348     sym = macKeyLookUp[maskedKeyCode];
<a name="l01349"></a>01349     <span class="keywordflow">if</span> ( isalpha(key) )
<a name="l01350"></a>01350       sym = tolower(key);
<a name="l01351"></a>01351     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="classFl.html#a2d93787aec60cb62a759b36267dd9d06">Fl::e_state</a>&amp;<a class="code" href="Enumerations_8H.html#a29324ec5ac8c1d87950127d387dc83e8" title="One of the ctrl keys is down.">FL_CTRL</a> &amp;&amp; key&lt;32 &amp;&amp; sym&lt;0xff00)
<a name="l01352"></a>01352       sym = key+96;
<a name="l01353"></a>01353     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="classFl.html#a2d93787aec60cb62a759b36267dd9d06">Fl::e_state</a>&amp;<a class="code" href="Enumerations_8H.html#a58b1ac5446b292c77043f99558eb07cb" title="One of the alt keys is down.">FL_ALT</a> &amp;&amp; sym&lt;0xff00) <span class="comment">// find the keycap of this key</span>
<a name="l01354"></a>01354       sym = keycode_to_sym( maskedKeyCode, 0, macKeyLookUp[ maskedKeyCode ] );
<a name="l01355"></a>01355     <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> = <a class="code" href="classFl.html#a2bf425ec2398cff4531b2b8c879fc14e">Fl::e_original_keysym</a> = sym;
<a name="l01356"></a>01356     <span class="comment">// Handle FL_KP_Enter on regular keyboards and on Powerbooks</span>
<a name="l01357"></a>01357     <span class="keywordflow">if</span> ( maskedKeyCode==0x4c || maskedKeyCode==0x34) key=0x0d;    
<a name="l01358"></a>01358     <span class="comment">// Handle the Delete key on the keypad</span>
<a name="l01359"></a>01359     <span class="comment">// Matt: the Mac has no concept of a NumLock key, or at least not visible</span>
<a name="l01360"></a>01360     <span class="comment">// Matt: to Carbon. The kEventKeyModifierNumLockMask is only set when</span>
<a name="l01361"></a>01361     <span class="comment">// Matt: a numeric keypad key is pressed and does not correspond with</span>
<a name="l01362"></a>01362     <span class="comment">// Matt: the NumLock light in PowerBook keyboards.</span>
<a name="l01363"></a>01363 
<a name="l01364"></a>01364     <span class="comment">// Matt: attempt to get the correct Unicode character(s) from our keycode</span>
<a name="l01365"></a>01365     <span class="comment">// imm:  keycode_function function pointer added to allow us to use different functions</span>
<a name="l01366"></a>01366     <span class="comment">// imm:  depending on which OS version we are running on (tested and set in fl_open_display)</span>
<a name="l01367"></a>01367     <span class="keyword">static</span> UInt32 deadKeyState = 0; <span class="comment">// must be cleared when losing focus</span>
<a name="l01368"></a>01368     <a class="code" href="classFl.html#a336911cf63dade9bbb9707b942785133">Fl::e_length</a> = (*keycode_function)(buffer, 31, kind, keyCode, mods, &amp;deadKeyState, <a class="code" href="Fl__Text__Editor_8cxx.html#a35af0be900467fedbb610bd6ea65ed78">key</a>, sym);
<a name="l01369"></a>01369     <a class="code" href="classFl.html#addcd49b68feff0a807f6564f3fdb8016">Fl::e_text</a> = buffer;
<a name="l01370"></a>01370     buffer[<a class="code" href="classFl.html#a336911cf63dade9bbb9707b942785133">Fl::e_length</a>] = 0; <span class="comment">// just in case...</span>
<a name="l01371"></a>01371     <span class="keywordflow">break</span>;
<a name="l01372"></a>01372   <span class="keywordflow">case</span> kEventRawKeyModifiersChanged: {
<a name="l01373"></a>01373     UInt32 tMods = prevMods ^ mods;
<a name="l01374"></a>01374     <span class="keywordflow">if</span> ( tMods )
<a name="l01375"></a>01375     {
<a name="l01376"></a>01376       mods_to_e_keysym( tMods );
<a name="l01377"></a>01377       <span class="keywordflow">if</span> ( <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> ) 
<a name="l01378"></a>01378         sendEvent = ( prevMods&lt;mods ) ? <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a1387c0430ec873aa44704954a369143b">FL_KEYBOARD</a> : <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3ab0e1a75a36767b878915e59e5f9e3be8">FL_KEYUP</a>;
<a name="l01379"></a>01379       <a class="code" href="classFl.html#a336911cf63dade9bbb9707b942785133">Fl::e_length</a> = 0;
<a name="l01380"></a>01380       buffer[0] = 0;
<a name="l01381"></a>01381       prevMods = mods;
<a name="l01382"></a>01382     }
<a name="l01383"></a>01383     mods_to_e_state( mods );
<a name="l01384"></a>01384     <span class="keywordflow">break</span>; }
<a name="l01385"></a>01385   }
<a name="l01386"></a>01386   <span class="keywordflow">while</span> (window-&gt;<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>()) window = window-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>();
<a name="l01387"></a>01387   <span class="keywordflow">if</span> (sendEvent &amp;&amp; <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>(sendEvent,window)) {
<a name="l01388"></a>01388     <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();  
<a name="l01389"></a>01389     <span class="keywordflow">return</span> noErr; <span class="comment">// return noErr if FLTK handled the event</span>
<a name="l01390"></a>01390   } <span class="keywordflow">else</span> {
<a name="l01391"></a>01391     <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l01392"></a>01392     <span class="comment">//return CallNextEventHandler( nextHandler, event );;</span>
<a name="l01393"></a>01393     <span class="comment">// Matt: I had better results (no duplicate events) always returning</span>
<a name="l01394"></a>01394     <span class="comment">// Matt: &#39;noErr&#39;. System keyboard events still seem to work just fine.</span>
<a name="l01395"></a>01395     <span class="keywordflow">return</span> noErr;
<a name="l01396"></a>01396   }
<a name="l01397"></a>01397 }
<a name="l01398"></a>01398 
<a name="l01399"></a>01399 
<a name="l01400"></a>01400 
<a name="l01405"></a>01405 <span class="keyword">static</span> <a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>     (*<a class="code" href="fluid_8cxx.html#a8fd61bd0e72bddff439d06748df19197">open_cb</a>)(<span class="keyword">const</span> <span class="keywordtype">char</span> *) = 0;
<a name="l01406"></a>01406 
<a name="l01407"></a>01407 
<a name="l01413"></a>01413 <span class="keyword">static</span> OSErr OpenAppleEventHandler(<span class="keyword">const</span> AppleEvent *appleEvt,
<a name="l01414"></a>01414                                    AppleEvent *reply,
<a name="l01415"></a>01415                                    UInt32 refcon) {
<a name="l01416"></a>01416   OSErr err;
<a name="l01417"></a>01417   AEDescList documents;
<a name="l01418"></a>01418   <span class="keywordtype">long</span> <a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>, n;
<a name="l01419"></a>01419   FSSpec fileSpec;
<a name="l01420"></a>01420   AEKeyword keyWd;
<a name="l01421"></a>01421   DescType typeCd;
<a name="l01422"></a>01422   Size actSz;
<a name="l01423"></a>01423   <span class="keywordtype">char</span> filename[1024];
<a name="l01424"></a>01424 
<a name="l01425"></a>01425   <span class="keywordflow">if</span> (!<a class="code" href="fluid_8cxx.html#a8fd61bd0e72bddff439d06748df19197">open_cb</a>) <span class="keywordflow">return</span> noErr;
<a name="l01426"></a>01426 
<a name="l01427"></a>01427   <span class="comment">// Initialize the document list...</span>
<a name="l01428"></a>01428   AECreateDesc(typeNull, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, &amp;documents);
<a name="l01429"></a>01429  
<a name="l01430"></a>01430   <span class="comment">// Get the open parameter(s)...</span>
<a name="l01431"></a>01431   err = AEGetParamDesc(appleEvt, keyDirectObject, typeAEList, &amp;documents);
<a name="l01432"></a>01432   <span class="keywordflow">if</span> (err != noErr) {
<a name="l01433"></a>01433     AEDisposeDesc(&amp;documents);
<a name="l01434"></a>01434     <span class="keywordflow">return</span> err;
<a name="l01435"></a>01435   }
<a name="l01436"></a>01436 
<a name="l01437"></a>01437   <span class="comment">// Lock access to FLTK in this thread...</span>
<a name="l01438"></a>01438   <a class="code" href="Fl__mac_8cxx.html#a7c231659c1d4f9ad9126b83cfbcbfb53">fl_lock_function</a>();
<a name="l01439"></a>01439 
<a name="l01440"></a>01440   <span class="comment">// Open the documents via the callback...</span>
<a name="l01441"></a>01441   <span class="keywordflow">if</span> (AECountItems(&amp;documents, &amp;n) == noErr) {
<a name="l01442"></a>01442     <span class="keywordflow">for</span> (i = 1; i &lt;= n; i ++) {
<a name="l01443"></a>01443       <span class="comment">// Get the next FSSpec record...</span>
<a name="l01444"></a>01444       AEGetNthPtr(&amp;documents, i, typeFSS, &amp;keyWd, &amp;typeCd,
<a name="l01445"></a>01445                   (Ptr)&amp;fileSpec, <span class="keyword">sizeof</span>(fileSpec),
<a name="l01446"></a>01446                   (actSz = <span class="keyword">sizeof</span>(fileSpec), &amp;actSz));
<a name="l01447"></a>01447 
<a name="l01448"></a>01448       <span class="comment">// Convert to a UNIX path...</span>
<a name="l01449"></a>01449       FSSpec2UnixPath(&amp;fileSpec, filename);
<a name="l01450"></a>01450 
<a name="l01451"></a>01451       <span class="comment">// Call the callback with the filename...</span>
<a name="l01452"></a>01452       (*open_cb)(filename);
<a name="l01453"></a>01453     }
<a name="l01454"></a>01454   }
<a name="l01455"></a>01455 
<a name="l01456"></a>01456   <span class="comment">// Unlock access to FLTK for all threads...</span>
<a name="l01457"></a>01457   <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l01458"></a>01458 
<a name="l01459"></a>01459   <span class="comment">// Get rid of the document list...</span>
<a name="l01460"></a>01460   AEDisposeDesc(&amp;documents);
<a name="l01461"></a>01461 
<a name="l01462"></a>01462   <span class="keywordflow">return</span> noErr;
<a name="l01463"></a>01463 }
<a name="l01464"></a>01464 
<a name="l01465"></a>01465 
<a name="l01470"></a><a class="code" href="group__group__macosx.html#ga0702a54934d10f5b72157137cf291296">01470</a> <span class="keywordtype">void</span> <a class="code" href="group__group__macosx.html#ga0702a54934d10f5b72157137cf291296" title="Register a function called for each file dropped onto an application icon.">fl_open_callback</a>(<span class="keywordtype">void</span> (*cb)(<span class="keyword">const</span> <span class="keywordtype">char</span> *)) {
<a name="l01471"></a>01471   <a class="code" href="fluid_8cxx.html#a8fd61bd0e72bddff439d06748df19197">open_cb</a> = cb;
<a name="l01472"></a>01472   <span class="keywordflow">if</span> (cb) {
<a name="l01473"></a>01473     AEInstallEventHandler(kCoreEventClass, kAEOpenDocuments,
<a name="l01474"></a>01474                           NewAEEventHandlerUPP((AEEventHandlerProcPtr)
<a name="l01475"></a>01475                               OpenAppleEventHandler), 0, <span class="keyword">false</span>);
<a name="l01476"></a>01476   } <span class="keywordflow">else</span> {
<a name="l01477"></a>01477     AERemoveEventHandler(kCoreEventClass, kAEOpenDocuments,
<a name="l01478"></a>01478                           NewAEEventHandlerUPP((AEEventHandlerProcPtr)
<a name="l01479"></a>01479                               OpenAppleEventHandler), <span class="keyword">false</span>);
<a name="l01480"></a>01480   }
<a name="l01481"></a>01481 }
<a name="l01482"></a>01482 
<a name="l01483"></a>01483 
<a name="l01488"></a>01488 <span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> {
<a name="l01489"></a>01489   <span class="keyword">extern</span> OSErr <a class="code" href="Fl__mac_8cxx.html#a880cd3b5aeb631803bd99a81dc604004">CPSEnableForegroundOperation</a>(ProcessSerialNumber *psn, UInt32 _arg2,
<a name="l01490"></a>01490     UInt32 _arg3, UInt32 _arg4, UInt32 _arg5);
<a name="l01491"></a>01491 }
<a name="l01492"></a>01492 
<a name="l01493"></a><a class="code" href="Fl__mac_8cxx.html#a94ee21d83137569a6730e3e2e7305cbc">01493</a> <span class="keywordtype">void</span> <a class="code" href="mac_8H.html#a94ee21d83137569a6730e3e2e7305cbc">fl_open_display</a>() {
<a name="l01494"></a>01494   <span class="keyword">static</span> <span class="keywordtype">char</span> beenHereDoneThat = 0;
<a name="l01495"></a>01495   <span class="keywordflow">if</span> ( !beenHereDoneThat )  {
<a name="l01496"></a>01496     beenHereDoneThat = 1;
<a name="l01497"></a>01497     
<a name="l01498"></a>01498     FlushEvents(everyEvent,0);
<a name="l01499"></a>01499     
<a name="l01500"></a>01500     MoreMasters(); <span class="comment">// \todo Carbon suggests MoreMasterPointers()</span>
<a name="l01501"></a>01501     AEInstallEventHandler( kCoreEventClass, kAEQuitApplication, NewAEEventHandlerUPP((AEEventHandlerProcPtr)QuitAppleEventHandler), 0, <span class="keyword">false</span> );
<a name="l01502"></a>01502     
<a name="l01503"></a>01503     <span class="comment">// create the Mac Handle for the default cursor (a pointer to a pointer)</span>
<a name="l01504"></a>01504     GetQDGlobalsArrow(&amp;default_cursor);
<a name="l01505"></a>01505     default_cursor_ptr = &amp;default_cursor;
<a name="l01506"></a>01506     <a class="code" href="win32_8H.html#a5c84f195de614f6aa79fa2f8883b37b6">fl_default_cursor</a>  = &amp;default_cursor_ptr;
<a name="l01507"></a>01507     
<a name="l01508"></a>01508     ClearMenuBar();
<a name="l01509"></a>01509     AppendResMenu( GetMenuHandle( 1 ), <span class="stringliteral">&#39;DRVR&#39;</span> );
<a name="l01510"></a>01510     DrawMenuBar();
<a name="l01511"></a>01511     
<a name="l01512"></a>01512     <span class="comment">// bring the application into foreground without a &#39;CARB&#39; resource</span>
<a name="l01513"></a>01513     Boolean same_psn;
<a name="l01514"></a>01514     ProcessSerialNumber cur_psn, front_psn;
<a name="l01515"></a>01515     <span class="keywordflow">if</span>( !GetCurrentProcess( &amp;cur_psn ) &amp;&amp; !GetFrontProcess( &amp;front_psn ) &amp;&amp;
<a name="l01516"></a>01516        !SameProcess( &amp;front_psn, &amp;cur_psn, &amp;same_psn ) &amp;&amp; !same_psn )
<a name="l01517"></a>01517     {
<a name="l01518"></a>01518       <span class="comment">// only transform the application type for unbundled apps</span>
<a name="l01519"></a>01519       CFBundleRef bundle = CFBundleGetMainBundle();
<a name="l01520"></a>01520       <span class="keywordflow">if</span>( bundle )
<a name="l01521"></a>01521       {
<a name="l01522"></a>01522         FSRef execFs;
<a name="l01523"></a>01523         CFURLRef execUrl = CFBundleCopyExecutableURL( bundle );
<a name="l01524"></a>01524         CFURLGetFSRef( execUrl, &amp;execFs );
<a name="l01525"></a>01525         
<a name="l01526"></a>01526         FSRef bundleFs;
<a name="l01527"></a>01527         GetProcessBundleLocation( &amp;cur_psn, &amp;bundleFs );
<a name="l01528"></a>01528         
<a name="l01529"></a>01529         <span class="keywordflow">if</span>( !FSCompareFSRefs( &amp;execFs, &amp;bundleFs ) )
<a name="l01530"></a>01530           bundle = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01531"></a>01531         
<a name="l01532"></a>01532         CFRelease(execUrl);
<a name="l01533"></a>01533       }
<a name="l01534"></a>01534       
<a name="l01535"></a>01535       <span class="keywordflow">if</span>( !bundle )
<a name="l01536"></a>01536       {
<a name="l01537"></a>01537         <span class="comment">// Earlier versions of this code tried to use weak linking, however it</span>
<a name="l01538"></a>01538         <span class="comment">// appears that this does not work on 10.2.  Since 10.3 and higher provide</span>
<a name="l01539"></a>01539         <span class="comment">// both TransformProcessType and CPSEnableForegroundOperation, the following</span>
<a name="l01540"></a>01540         <span class="comment">// conditional code compiled on 10.2 will still work on newer releases...</span>
<a name="l01541"></a>01541         OSErr err;
<a name="l01542"></a>01542         
<a name="l01543"></a>01543 <span class="preprocessor">#if MAC_OS_X_VERSION_MAX_ALLOWED &gt; MAC_OS_X_VERSION_10_2</span>
<a name="l01544"></a>01544 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (TransformProcessType != <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01545"></a>01545           err = TransformProcessType(&amp;cur_psn, kProcessTransformToForegroundApplication);
<a name="l01546"></a>01546         } <span class="keywordflow">else</span>
<a name="l01547"></a>01547 <span class="preprocessor">#endif // MAC_OS_X_VERSION_MAX_ALLOWED &gt; MAC_OS_X_VERSION_10_2</span>
<a name="l01548"></a>01548 <span class="preprocessor"></span>          err = <a class="code" href="Fl__mac_8cxx.html#a880cd3b5aeb631803bd99a81dc604004">CPSEnableForegroundOperation</a>(&amp;cur_psn, 0x03, 0x3C, 0x2C, 0x1103);
<a name="l01549"></a>01549         
<a name="l01550"></a>01550         <span class="keywordflow">if</span> (err == noErr) {
<a name="l01551"></a>01551           SetFrontProcess( &amp;cur_psn );
<a name="l01552"></a>01552         }
<a name="l01553"></a>01553       }
<a name="l01554"></a>01554     }
<a name="l01555"></a>01555     
<a name="l01556"></a>01556     <span class="comment">// imm: keycode handler stub setting - use Gestalt to determine the running system version,</span>
<a name="l01557"></a>01557     <span class="comment">// then set the keycode_function pointer accordingly</span>
<a name="l01558"></a>01558     keycode_function = keycode_wrap_old; <span class="comment">// default to pre-10.5 mechanism</span>
<a name="l01559"></a>01559     SInt32 MacVersion;
<a name="l01560"></a>01560     <span class="keywordflow">if</span> (Gestalt(gestaltSystemVersion, &amp;MacVersion) == noErr)
<a name="l01561"></a>01561     {
<a name="l01562"></a>01562       <span class="keywordflow">if</span>(MacVersion &gt;= 0x1050) { <span class="comment">// 10.5.0 or later</span>
<a name="l01563"></a>01563         keycode_function = keycodeToUnicode;
<a name="l01564"></a>01564       }
<a name="l01565"></a>01565     }
<a name="l01566"></a>01566   }
<a name="l01567"></a>01567 }
<a name="l01568"></a>01568 
<a name="l01569"></a>01569 
<a name="l01573"></a><a class="code" href="Fl__mac_8cxx.html#ab25e8f232319c7a694588986e6dc1a60">01573</a> <span class="keywordtype">void</span> <a class="code" href="x_8H.html#ade3ae56765e00bc95627ff95c63cd2d7">fl_close_display</a>()  {
<a name="l01574"></a>01574 }
<a name="l01575"></a>01575 
<a name="l01576"></a>01576 
<a name="l01580"></a><a class="code" href="group__fl__screen.html#gaed836eacded3467aa838d02a1c55e3ab">01580</a> <span class="keywordtype">int</span> <a class="code" href="group__fl__screen.html#gaed836eacded3467aa838d02a1c55e3ab">Fl::x</a>() {
<a name="l01581"></a>01581   BitMap r;
<a name="l01582"></a>01582   GetQDGlobalsScreenBits(&amp;r);
<a name="l01583"></a>01583   <span class="keywordflow">return</span> r.bounds.left;
<a name="l01584"></a>01584 }
<a name="l01585"></a>01585 
<a name="l01586"></a>01586 
<a name="l01590"></a><a class="code" href="group__fl__screen.html#gafa36572c1f755f8a9783efc351f19021">01590</a> <span class="keywordtype">int</span> <a class="code" href="group__fl__screen.html#gafa36572c1f755f8a9783efc351f19021">Fl::y</a>() {
<a name="l01591"></a>01591   BitMap r;
<a name="l01592"></a>01592   GetQDGlobalsScreenBits(&amp;r);
<a name="l01593"></a>01593   <span class="keywordflow">return</span> r.bounds.top + 20; <span class="comment">// \todo 20 pixel menu bar?</span>
<a name="l01594"></a>01594 }
<a name="l01595"></a>01595 
<a name="l01596"></a>01596 
<a name="l01600"></a><a class="code" href="group__fl__screen.html#ga7aba4252407f539aa6d821551aaba5ff">01600</a> <span class="keywordtype">int</span> <a class="code" href="group__fl__screen.html#ga7aba4252407f539aa6d821551aaba5ff">Fl::w</a>() {
<a name="l01601"></a>01601   BitMap r;
<a name="l01602"></a>01602   GetQDGlobalsScreenBits(&amp;r);
<a name="l01603"></a>01603   <span class="keywordflow">return</span> r.bounds.right - r.bounds.left;
<a name="l01604"></a>01604 }
<a name="l01605"></a>01605 
<a name="l01606"></a>01606 
<a name="l01610"></a><a class="code" href="group__fl__screen.html#ga7f42d75cf9b3e79bbe39e1041a657cdf">01610</a> <span class="keywordtype">int</span> <a class="code" href="group__fl__screen.html#ga7f42d75cf9b3e79bbe39e1041a657cdf">Fl::h</a>() {
<a name="l01611"></a>01611   BitMap r;
<a name="l01612"></a>01612   GetQDGlobalsScreenBits(&amp;r);
<a name="l01613"></a>01613   <span class="keywordflow">return</span> r.bounds.bottom - r.bounds.top - 20;
<a name="l01614"></a>01614 }
<a name="l01615"></a>01615 
<a name="l01616"></a>01616 
<a name="l01620"></a><a class="code" href="group__fl__events.html#gace49495f2b947065bb140e5023d14954">01620</a> <span class="keywordtype">void</span> <a class="code" href="group__fl__events.html#gace49495f2b947065bb140e5023d14954">Fl::get_mouse</a>(<span class="keywordtype">int</span> &amp;<a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>, <span class="keywordtype">int</span> &amp;<a class="code" href="test_8c.html#a0a2f84ed7838f07779ae24c5a9086d33">y</a>) 
<a name="l01621"></a>01621 {
<a name="l01622"></a>01622   <a class="code" href="mac_8H.html#a94ee21d83137569a6730e3e2e7305cbc">fl_open_display</a>();
<a name="l01623"></a>01623   Point loc; 
<a name="l01624"></a>01624   GetMouse( &amp;loc );
<a name="l01625"></a>01625   LocalToGlobal( &amp;loc );
<a name="l01626"></a>01626   x = loc.h;
<a name="l01627"></a>01627   y = loc.v;
<a name="l01628"></a>01628 }
<a name="l01629"></a>01629 
<a name="l01630"></a>01630 
<a name="l01634"></a><a class="code" href="Fl__mac_8cxx.html#aa1f7987f4e394632d7fef8c967b34a85">01634</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="Fl__mac_8cxx.html#aa1f7987f4e394632d7fef8c967b34a85">mac2fltk</a>(<a class="code" href="fl__types_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a> macKey) 
<a name="l01635"></a>01635 {
<a name="l01636"></a>01636   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> cc = macKeyLookUp[(macKey&gt;&gt;8)&amp;0x7f];
<a name="l01637"></a>01637   <span class="keywordflow">if</span> (cc) <span class="keywordflow">return</span> cc;
<a name="l01638"></a>01638   <span class="keywordflow">return</span> macKey&amp;0xff;
<a name="l01639"></a>01639 }
<a name="l01640"></a>01640 
<a name="l01641"></a>01641 
<a name="l01645"></a>01645 <span class="keywordtype">void</span> <a class="code" href="classFl__X.html#a5c37292ceca45a42bff9722029484bb5">Fl_X::flush</a>()
<a name="l01646"></a>01646 {
<a name="l01647"></a>01647   <a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>-&gt;<a class="code" href="classFl__Window.html#a418cef08cf54f1dd794538501f15f08b">flush</a>();
<a name="l01648"></a>01648   <span class="keywordflow">if</span> (<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>) 
<a name="l01649"></a>01649     <a class="code" href="cgdebug_8h.html#afaf7a6c13b9872c0eb253ee26883ceb7">CGContextFlush</a>(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>);
<a name="l01650"></a>01650   SetOrigin( 0, 0 );
<a name="l01651"></a>01651 }
<a name="l01652"></a>01652 
<a name="l01653"></a>01653 
<a name="l01660"></a>01660 <span class="keywordtype">void</span> handleUpdateEvent( WindowPtr xid ) 
<a name="l01661"></a>01661 {
<a name="l01662"></a>01662   <a class="code" href="classFl__Window.html">Fl_Window</a> *window = <a class="code" href="win32_8H.html#a4f60f8f2a47f584ee83dd0118a058cfe">fl_find</a>( xid );
<a name="l01663"></a>01663   <span class="keywordflow">if</span> ( !window ) <span class="keywordflow">return</span>;
<a name="l01664"></a>01664   GrafPtr oldPort;
<a name="l01665"></a>01665   GetPort( &amp;oldPort );
<a name="l01666"></a>01666   SetPort( GetWindowPort(xid) );
<a name="l01667"></a>01667   <a class="code" href="classFl__X.html">Fl_X</a> *i = <a class="code" href="classFl__X.html#ae4c6997d92cf8ad3a75a962d7ae77c34">Fl_X::i</a>( window );
<a name="l01668"></a>01668   i-&gt;<a class="code" href="classFl__X.html#a5bff94b4bde0ceafbaaaaaa3b7d1426e">wait_for_expose</a> = 0;
<a name="l01669"></a>01669   <span class="keywordflow">if</span> ( window-&gt;<a class="code" href="classFl__Widget.html#a24aaceb4034489133926f53eb57aad23">damage</a>() ) {
<a name="l01670"></a>01670     <span class="keywordflow">if</span> ( i-&gt;<a class="code" href="classFl__X.html#a2d6b59b7362a486d48b6ae5df0bd0b41">region</a> ) {
<a name="l01671"></a>01671       InvalWindowRgn( xid, i-&gt;<a class="code" href="classFl__X.html#a2d6b59b7362a486d48b6ae5df0bd0b41">region</a> );
<a name="l01672"></a>01672     }
<a name="l01673"></a>01673   }
<a name="l01674"></a>01674   <span class="keywordflow">if</span> ( i-&gt;<a class="code" href="classFl__X.html#a2d6b59b7362a486d48b6ae5df0bd0b41">region</a> ) { <span class="comment">// no region, so the sytem will take the update region from the OS</span>
<a name="l01675"></a>01675     DisposeRgn( i-&gt;<a class="code" href="classFl__X.html#a2d6b59b7362a486d48b6ae5df0bd0b41">region</a> );
<a name="l01676"></a>01676     i-&gt;<a class="code" href="classFl__X.html#a2d6b59b7362a486d48b6ae5df0bd0b41">region</a> = 0;
<a name="l01677"></a>01677   }
<a name="l01678"></a>01678   <span class="keywordflow">for</span> ( <a class="code" href="classFl__X.html">Fl_X</a> *cx = i-&gt;xidChildren; cx; cx = cx-&gt;xidNext )
<a name="l01679"></a>01679   {
<a name="l01680"></a>01680     cx-&gt;w-&gt;clear_damage(window-&gt;<a class="code" href="classFl__Widget.html#a24aaceb4034489133926f53eb57aad23">damage</a>()|<a class="code" href="Enumerations_8H.html#a9a20351f841109b3d861e0c1248d146da1d579fbc483892ba72a416d3ff14a942">FL_DAMAGE_EXPOSE</a>);
<a name="l01681"></a>01681     cx-&gt;flush();
<a name="l01682"></a>01682     cx-&gt;w-&gt;clear_damage();
<a name="l01683"></a>01683   }
<a name="l01684"></a>01684   window-&gt;<a class="code" href="classFl__Widget.html#af9942c4d795ec12c7c1ec1ce5e665a01">clear_damage</a>(window-&gt;<a class="code" href="classFl__Widget.html#a24aaceb4034489133926f53eb57aad23">damage</a>()|<a class="code" href="Enumerations_8H.html#a9a20351f841109b3d861e0c1248d146da1d579fbc483892ba72a416d3ff14a942">FL_DAMAGE_EXPOSE</a>);
<a name="l01685"></a>01685   i-&gt;<a class="code" href="classFl__X.html#a5c37292ceca45a42bff9722029484bb5">flush</a>();
<a name="l01686"></a>01686   window-&gt;<a class="code" href="classFl__Widget.html#af9942c4d795ec12c7c1ec1ce5e665a01">clear_damage</a>();
<a name="l01687"></a>01687   SetPort( oldPort );
<a name="l01688"></a>01688 }     
<a name="l01689"></a>01689 
<a name="l01690"></a>01690 <span class="comment">// Gets the border sizes and the titlebar size</span>
<a name="l01691"></a>01691 <span class="keyword">static</span> <span class="keywordtype">void</span> get_window_frame_sizes(<span class="keywordtype">int</span> &amp;bx, <span class="keywordtype">int</span> &amp;by, <span class="keywordtype">int</span> &amp;bt) {
<a name="l01692"></a>01692 <span class="preprocessor">#if MAC_OS_X_VERSION_MAX_ALLOWED &gt; MAC_OS_X_VERSION_10_2</span>
<a name="l01693"></a>01693 <span class="preprocessor"></span>        <span class="keyword">static</span> HIRect contentRect = { {50,50}, {100,100} }; <span class="comment">// a rect to stand in for the content rect of a real window</span>
<a name="l01694"></a>01694         <span class="keyword">static</span> HIThemeWindowDrawInfo metrics= {0, 
<a name="l01695"></a>01695                 kThemeStateActive, kThemeDocumentWindow,
<a name="l01696"></a>01696                 kThemeWindowHasFullZoom + kThemeWindowHasCloseBox + 
<a name="l01697"></a>01697                 kThemeWindowHasCollapseBox + kThemeWindowHasTitleText, 
<a name="l01698"></a>01698                 0, 0};
<a name="l01699"></a>01699         HIShapeRef shape1=0, shape2=0, shape3=0;
<a name="l01700"></a>01700         HIRect rect1, rect2, rect3;
<a name="l01701"></a>01701         OSStatus        status;
<a name="l01702"></a>01702         status  = HIThemeGetWindowShape(&amp;contentRect, &amp;metrics, kWindowStructureRgn, &amp;shape1);
<a name="l01703"></a>01703         status |= HIThemeGetWindowShape(&amp;contentRect, &amp;metrics, kWindowContentRgn, &amp;shape2);
<a name="l01704"></a>01704         status |= HIThemeGetWindowShape(&amp;contentRect, &amp;metrics, kWindowTitleBarRgn, &amp;shape3);
<a name="l01705"></a>01705     
<a name="l01706"></a>01706         <span class="keywordflow">if</span> (!status) 
<a name="l01707"></a>01707         {
<a name="l01708"></a>01708                 HIShapeGetBounds(shape1, &amp;rect1);
<a name="l01709"></a>01709                 HIShapeGetBounds(shape2, &amp;rect2);
<a name="l01710"></a>01710                 HIShapeGetBounds(shape3, &amp;rect3);
<a name="l01711"></a>01711                 bt = rect3.size.height;
<a name="l01712"></a>01712                 bx = rect2.origin.x  - rect1.origin.x;
<a name="l01713"></a>01713                 by = rect2.origin.y  - rect1.origin.y - bt;
<a name="l01714"></a>01714                 <span class="comment">// fprintf(stderr, &quot;HIThemeGetWindowShape succeeded bx=%d by=%d bt=%d\n&quot;, bx, by, bt);</span>
<a name="l01715"></a>01715         }               
<a name="l01716"></a>01716         <span class="keywordflow">else</span> 
<a name="l01717"></a>01717 <span class="preprocessor">#endif // MAC_OS_X_VERSION_MAX_ALLOWED &gt; MAC_OS_X_VERSION_10_2</span>
<a name="l01718"></a>01718 <span class="preprocessor"></span>        {
<a name="l01719"></a>01719                 <span class="comment">// sets default dimensions</span>
<a name="l01720"></a>01720                 bx = by = 6;
<a name="l01721"></a>01721                 bt = 22;
<a name="l01722"></a>01722                 <span class="comment">// fprintf(stderr, &quot;HIThemeGetWindowShape failed, bx=%d by=%d bt=%d\n&quot;, bx, by, bt);</span>
<a name="l01723"></a>01723         }
<a name="l01724"></a>01724 <span class="preprocessor">#if MAC_OS_X_VERSION_MAX_ALLOWED &gt; MAC_OS_X_VERSION_10_2</span>
<a name="l01725"></a>01725 <span class="preprocessor"></span>        CFRelease(shape1); <span class="comment">// we must free HIThemeGetWindowShape() (copied) handles </span>
<a name="l01726"></a>01726         CFRelease(shape2);
<a name="l01727"></a>01727         CFRelease(shape3);
<a name="l01728"></a>01728 <span class="preprocessor">#endif // MAC_OS_X_VERSION_MAX_ALLOWED &gt; MAC_OS_X_VERSION_10_2</span>
<a name="l01729"></a>01729 <span class="preprocessor"></span>}
<a name="l01730"></a>01730 
<a name="l01734"></a><a class="code" href="classFl__X.html#a1bd922580d8cb633ec0cdb8c2b012f94">01734</a> <span class="keywordtype">int</span> <a class="code" href="classFl__X.html#a1bd922580d8cb633ec0cdb8c2b012f94">Fl_X::fake_X_wm</a>(<span class="keyword">const</span> <a class="code" href="classFl__Window.html">Fl_Window</a>* <a class="code" href="forms_8H-2.html#aac374e320caaadeca4874add33b62af2">w</a>,<span class="keywordtype">int</span> &amp;X,<span class="keywordtype">int</span> &amp;Y, <span class="keywordtype">int</span> &amp;bt,<span class="keywordtype">int</span> &amp;bx, <span class="keywordtype">int</span> &amp;by) {
<a name="l01735"></a>01735   <span class="keywordtype">int</span> W, <a class="code" href="Fl__Tooltip_8cxx.html#affa487e8e3cc48473cfc05c0ce0165e9">H</a>, xoff, yoff, <a class="code" href="fl__boxtype_8cxx.html#acafd1211381c8640d68a685ac2eea5d2">dx</a>, <a class="code" href="fl__boxtype_8cxx.html#a4cffdba1345d329bb97e76579d57fa21">dy</a>;
<a name="l01736"></a>01736   <span class="keywordtype">int</span> ret = bx = by = bt = 0;
<a name="l01737"></a>01737   <span class="keywordflow">if</span> (w-&gt;<a class="code" href="classFl__Window.html#a72f5733f13cb6d8b646f1e7ffcd92333">border</a>() &amp;&amp; !w-&gt;<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>()) {
<a name="l01738"></a>01738     <span class="keywordflow">if</span> (w-&gt;maxw != w-&gt;minw || w-&gt;maxh != w-&gt;minh) {
<a name="l01739"></a>01739       ret = 2;
<a name="l01740"></a>01740       get_window_frame_sizes(bx, by, bt);
<a name="l01741"></a>01741       <span class="comment">/*</span>
<a name="l01742"></a>01742 <span class="comment">        bx = 6; // \todo Mac : GetSystemMetrics(SM_CXSIZEFRAME);</span>
<a name="l01743"></a>01743 <span class="comment">        by = 6; // \todo Mac : get Mac window frame size GetSystemMetrics(SM_CYSIZEFRAME);</span>
<a name="l01744"></a>01744 <span class="comment">      */</span>
<a name="l01745"></a>01745     } <span class="keywordflow">else</span> {
<a name="l01746"></a>01746       ret = 1;
<a name="l01747"></a>01747       get_window_frame_sizes(bx, by, bt);
<a name="l01748"></a>01748       <span class="comment">/*</span>
<a name="l01749"></a>01749 <span class="comment">        bx = 6; // \todo Mac : GetSystemMetrics(SM_CXFIXEDFRAME);</span>
<a name="l01750"></a>01750 <span class="comment">        by = 6; // \todo Mac : GetSystemMetrics(SM_CYFIXEDFRAME);</span>
<a name="l01751"></a>01751 <span class="comment">      */</span>
<a name="l01752"></a>01752     }
<a name="l01753"></a>01753   }
<a name="l01754"></a>01754   <span class="comment">//The coordinates of the whole window, including non-client area</span>
<a name="l01755"></a>01755   xoff = bx;
<a name="l01756"></a>01756   yoff = by + bt;
<a name="l01757"></a>01757   dx = 2*bx;
<a name="l01758"></a>01758   dy = 2*by + bt;
<a name="l01759"></a>01759   X = w-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>()-xoff;
<a name="l01760"></a>01760   Y = w-&gt;<a class="code" href="classFl__Widget.html#aec1aded9efdf5f23dfac8cc725cefc4a">y</a>()-yoff;
<a name="l01761"></a>01761   W = w-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>()+<a class="code" href="fl__boxtype_8cxx.html#acafd1211381c8640d68a685ac2eea5d2">dx</a>;
<a name="l01762"></a>01762   H = w-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>()+<a class="code" href="fl__boxtype_8cxx.html#a4cffdba1345d329bb97e76579d57fa21">dy</a>;
<a name="l01763"></a>01763 
<a name="l01764"></a>01764   <span class="comment">//Proceed to positioning the window fully inside the screen, if possible</span>
<a name="l01765"></a>01765 
<a name="l01766"></a>01766   <span class="comment">// let&#39;s get a little elaborate here. Mac OS X puts a lot of stuff on the desk</span>
<a name="l01767"></a>01767   <span class="comment">// that we want to avoid when positioning our window, namely the Dock and the</span>
<a name="l01768"></a>01768   <span class="comment">// top menu bar (and even more stuff in 10.4 Tiger). So we will go through the</span>
<a name="l01769"></a>01769   <span class="comment">// list of all available screens and find the one that this window is most</span>
<a name="l01770"></a>01770   <span class="comment">// likely to go to, and then reposition it to fit withing the &#39;good&#39; area.</span>
<a name="l01771"></a>01771   Rect r;
<a name="l01772"></a>01772   <span class="comment">// find the screen, that the center of this window will fall into</span>
<a name="l01773"></a>01773   <span class="keywordtype">int</span> R = X+W, B = Y+<a class="code" href="Fl__Tooltip_8cxx.html#affa487e8e3cc48473cfc05c0ce0165e9">H</a>; <span class="comment">// right and bottom</span>
<a name="l01774"></a>01774   <span class="keywordtype">int</span> cx = (X+R)/2, cy = (Y+B)/2; <span class="comment">// center of window;</span>
<a name="l01775"></a>01775   GDHandle gd = 0L;
<a name="l01776"></a>01776   <span class="keywordflow">for</span> (gd = GetDeviceList(); gd; gd = GetNextDevice(gd)) {
<a name="l01777"></a>01777   GDPtr gp = *gd;
<a name="l01778"></a>01778   <span class="keywordflow">if</span> (    cx &gt;= gp-&gt;gdRect.left &amp;&amp; cx &lt;= gp-&gt;gdRect.right
<a name="l01779"></a>01779        &amp;&amp; cy &gt;= gp-&gt;gdRect.top  &amp;&amp; cy &lt;= gp-&gt;gdRect.bottom)
<a name="l01780"></a>01780     <span class="keywordflow">break</span>;
<a name="l01781"></a>01781   }
<a name="l01782"></a>01782   <span class="comment">// if the center doesn&#39;t fall on a screen, try the top left</span>
<a name="l01783"></a>01783   <span class="keywordflow">if</span> (!gd) {
<a name="l01784"></a>01784     <span class="keywordflow">for</span> (gd = GetDeviceList(); gd; gd = GetNextDevice(gd)) {
<a name="l01785"></a>01785       GDPtr gp = *gd;
<a name="l01786"></a>01786       <span class="keywordflow">if</span> (    X &gt;= gp-&gt;gdRect.left &amp;&amp; X &lt;= gp-&gt;gdRect.right
<a name="l01787"></a>01787            &amp;&amp; Y &gt;= gp-&gt;gdRect.top  &amp;&amp; Y &lt;= gp-&gt;gdRect.bottom)
<a name="l01788"></a>01788         <span class="keywordflow">break</span>;
<a name="l01789"></a>01789     }
<a name="l01790"></a>01790   }
<a name="l01791"></a>01791   <span class="comment">// if that doesn&#39;t fall on a screen, try the top right</span>
<a name="l01792"></a>01792   <span class="keywordflow">if</span> (!gd) {
<a name="l01793"></a>01793     <span class="keywordflow">for</span> (gd = GetDeviceList(); gd; gd = GetNextDevice(gd)) {
<a name="l01794"></a>01794       GDPtr gp = *gd;
<a name="l01795"></a>01795       <span class="keywordflow">if</span> (    R &gt;= gp-&gt;gdRect.left &amp;&amp; R &lt;= gp-&gt;gdRect.right
<a name="l01796"></a>01796            &amp;&amp; Y &gt;= gp-&gt;gdRect.top  &amp;&amp; Y &lt;= gp-&gt;gdRect.bottom)
<a name="l01797"></a>01797         <span class="keywordflow">break</span>;
<a name="l01798"></a>01798     }
<a name="l01799"></a>01799   }
<a name="l01800"></a>01800   <span class="comment">// if that doesn&#39;t fall on a screen, try the bottom left</span>
<a name="l01801"></a>01801   <span class="keywordflow">if</span> (!gd) {
<a name="l01802"></a>01802     <span class="keywordflow">for</span> (gd = GetDeviceList(); gd; gd = GetNextDevice(gd)) {
<a name="l01803"></a>01803       GDPtr gp = *gd;
<a name="l01804"></a>01804       <span class="keywordflow">if</span> (    X &gt;= gp-&gt;gdRect.left &amp;&amp; X &lt;= gp-&gt;gdRect.right
<a name="l01805"></a>01805            &amp;&amp; B &gt;= gp-&gt;gdRect.top  &amp;&amp; B &lt;= gp-&gt;gdRect.bottom)
<a name="l01806"></a>01806         <span class="keywordflow">break</span>;
<a name="l01807"></a>01807     }
<a name="l01808"></a>01808   }
<a name="l01809"></a>01809   <span class="comment">// last resort, try the bottom right</span>
<a name="l01810"></a>01810   <span class="keywordflow">if</span> (!gd) {
<a name="l01811"></a>01811     <span class="keywordflow">for</span> (gd = GetDeviceList(); gd; gd = GetNextDevice(gd)) {
<a name="l01812"></a>01812       GDPtr gp = *gd;
<a name="l01813"></a>01813       <span class="keywordflow">if</span> (    R &gt;= gp-&gt;gdRect.left &amp;&amp; R &lt;= gp-&gt;gdRect.right
<a name="l01814"></a>01814            &amp;&amp; B &gt;= gp-&gt;gdRect.top  &amp;&amp; B &lt;= gp-&gt;gdRect.bottom)
<a name="l01815"></a>01815         <span class="keywordflow">break</span>;
<a name="l01816"></a>01816     }
<a name="l01817"></a>01817   }
<a name="l01818"></a>01818   <span class="comment">// if we still have not found a screen, we will use the main</span>
<a name="l01819"></a>01819   <span class="comment">// screen, the one that has the application menu bar.</span>
<a name="l01820"></a>01820   <span class="keywordflow">if</span> (!gd) gd = GetMainDevice();
<a name="l01821"></a>01821   <span class="keywordflow">if</span> (gd) {
<a name="l01822"></a>01822     GetAvailableWindowPositioningBounds(gd, &amp;r);
<a name="l01823"></a>01823     <span class="keywordflow">if</span> ( R &gt; r.right )  X -= R - r.right;
<a name="l01824"></a>01824     <span class="keywordflow">if</span> ( B &gt; r.bottom ) Y -= B - r.bottom;
<a name="l01825"></a>01825     <span class="keywordflow">if</span> ( X &lt; r.left )   X = r.left;
<a name="l01826"></a>01826     <span class="keywordflow">if</span> ( Y &lt; r.top )    Y = r.top;
<a name="l01827"></a>01827   }
<a name="l01828"></a>01828 
<a name="l01829"></a>01829   <span class="comment">//Return the client area&#39;s top left corner in (X,Y)</span>
<a name="l01830"></a>01830   X+=xoff;
<a name="l01831"></a>01831   Y+=yoff;
<a name="l01832"></a>01832 
<a name="l01833"></a>01833   <span class="keywordflow">return</span> ret;
<a name="l01834"></a>01834 }
<a name="l01835"></a>01835 
<a name="l01839"></a>01839 <span class="keyword">static</span> <span class="keywordtype">int</span> FSSpec2UnixPath( FSSpec *fs, <span class="keywordtype">char</span> *dst )
<a name="l01840"></a>01840 {
<a name="l01841"></a>01841   FSRef fsRef;
<a name="l01842"></a>01842   FSpMakeFSRef( fs, &amp;fsRef );
<a name="l01843"></a>01843   FSRefMakePath( &amp;fsRef, (UInt8*)dst, 1024 );
<a name="l01844"></a>01844   <span class="keywordflow">return</span> strlen(dst);
<a name="l01845"></a>01845 }
<a name="l01846"></a>01846 <span class="keyword">static</span> <span class="keywordtype">void</span> convert_crlf(<span class="keywordtype">char</span> * s, <span class="keywordtype">size_t</span> len)
<a name="l01847"></a>01847 {
<a name="l01848"></a>01848   <span class="comment">// turn all \r characters into \n:</span>
<a name="l01849"></a>01849   <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a> = 0; <a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a> &lt; len; <a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>++) <span class="keywordflow">if</span> (s[<a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>] == <span class="charliteral">&#39;\r&#39;</span>) s[<a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>] = <span class="charliteral">&#39;\n&#39;</span>;
<a name="l01850"></a>01850 }
<a name="l01851"></a>01851 
<a name="l01852"></a>01852 
<a name="l01853"></a>01853 <span class="keyword">static</span> DragReference currDragRef = 0;
<a name="l01854"></a>01854 <span class="keyword">static</span> <span class="keywordtype">char</span> *currDragData = 0L;
<a name="l01855"></a>01855 <span class="keyword">static</span> <span class="keywordtype">int</span> currDragSize = 0; 
<a name="l01856"></a>01856 <span class="keyword">static</span> OSErr currDragErr = noErr;
<a name="l01857"></a><a class="code" href="Fl__mac_8cxx.html#a866cf619290e4f883ccf200cf1eb95c7">01857</a> <a class="code" href="classFl__Window.html">Fl_Window</a> *<a class="code" href="fl__dnd__win32_8cxx.html#a866cf619290e4f883ccf200cf1eb95c7">fl_dnd_target_window</a> = 0;
<a name="l01858"></a>01858 <span class="preprocessor">#include &lt;FL/fl_draw.H&gt;</span>
<a name="l01859"></a>01859 
<a name="l01863"></a>01863 <span class="keyword">static</span> OSErr fillCurrentDragData(DragReference dragRef)
<a name="l01864"></a>01864 {
<a name="l01865"></a>01865   OSErr ret = noErr;
<a name="l01866"></a>01866   <span class="keywordtype">char</span> *dst = 0L;
<a name="l01867"></a>01867   
<a name="l01868"></a>01868   <span class="comment">// shortcut through this whole procedure if this is still the same drag event</span>
<a name="l01869"></a>01869   <span class="keywordflow">if</span> (dragRef==currDragRef)
<a name="l01870"></a>01870     <span class="keywordflow">return</span> currDragErr;
<a name="l01871"></a>01871   
<a name="l01872"></a>01872   <span class="comment">// clear currDrag* for a new drag event</span>
<a name="l01873"></a>01873   currDragRef = dragRef;
<a name="l01874"></a>01874   <span class="keywordflow">if</span> (currDragData) free(currDragData);
<a name="l01875"></a>01875   currDragData = 0;
<a name="l01876"></a>01876   currDragSize = 0;
<a name="l01877"></a>01877   
<a name="l01878"></a>01878   <span class="comment">// fill currDRag* with ASCII data, if available</span>
<a name="l01879"></a>01879   UInt16 <a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>, nItem;
<a name="l01880"></a>01880   ItemReference itemRef;
<a name="l01881"></a>01881   FlavorFlags <a class="code" href="png_8h.html#a977410f175f1b6ea314bf5b2c0788dfb">flags</a>;
<a name="l01882"></a>01882   Size itemSize, <a class="code" href="png_8h.html#a43291b8493b637821dec145c4bb1503d">size</a> = 0;
<a name="l01883"></a>01883   CountDragItems( dragRef, &amp;nItem );
<a name="l01884"></a>01884 
<a name="l01885"></a>01885   <span class="keywordflow">for</span> ( i = 1; i &lt;= nItem; i++ )
<a name="l01886"></a>01886   {
<a name="l01887"></a>01887     GetDragItemReferenceNumber( dragRef, i, &amp;itemRef );
<a name="l01888"></a>01888     ret = GetFlavorFlags( dragRef, itemRef, <span class="stringliteral">&#39;utf8&#39;</span>, &amp;flags );
<a name="l01889"></a>01889     <span class="keywordflow">if</span> ( ret == noErr )
<a name="l01890"></a>01890     {
<a name="l01891"></a>01891       GetFlavorDataSize( dragRef, itemRef, <span class="stringliteral">&#39;utf8&#39;</span>, &amp;itemSize );
<a name="l01892"></a>01892       size += itemSize;
<a name="l01893"></a>01893       <span class="keywordflow">continue</span>;
<a name="l01894"></a>01894     }
<a name="l01895"></a>01895     ret = GetFlavorFlags( dragRef, itemRef, <span class="stringliteral">&#39;utxt&#39;</span>, &amp;flags );
<a name="l01896"></a>01896     <span class="keywordflow">if</span> ( ret == noErr )
<a name="l01897"></a>01897     {
<a name="l01898"></a>01898       GetFlavorDataSize( dragRef, itemRef, <span class="stringliteral">&#39;utxt&#39;</span>, &amp;itemSize );
<a name="l01899"></a>01899       size += itemSize;
<a name="l01900"></a>01900       <span class="keywordflow">continue</span>;
<a name="l01901"></a>01901     }
<a name="l01902"></a>01902     ret = GetFlavorFlags( dragRef, itemRef, <span class="stringliteral">&#39;TEXT&#39;</span>, &amp;flags );
<a name="l01903"></a>01903     <span class="keywordflow">if</span> ( ret == noErr )
<a name="l01904"></a>01904     {
<a name="l01905"></a>01905       GetFlavorDataSize( dragRef, itemRef, <span class="stringliteral">&#39;TEXT&#39;</span>, &amp;itemSize );
<a name="l01906"></a>01906       size += itemSize;
<a name="l01907"></a>01907       <span class="keywordflow">continue</span>;
<a name="l01908"></a>01908     }
<a name="l01909"></a>01909     ret = GetFlavorFlags( dragRef, itemRef, <span class="stringliteral">&#39;hfs &#39;</span>, &amp;flags );
<a name="l01910"></a>01910     <span class="keywordflow">if</span> ( ret == noErr )
<a name="l01911"></a>01911     {
<a name="l01912"></a>01912       size += 1024; <span class="comment">//++ ouch! We should create the full pathname and figure out its length</span>
<a name="l01913"></a>01913       <span class="keywordflow">continue</span>;
<a name="l01914"></a>01914     }
<a name="l01915"></a>01915   }
<a name="l01916"></a>01916 
<a name="l01917"></a>01917   <span class="keywordflow">if</span> ( !size )
<a name="l01918"></a>01918   {
<a name="l01919"></a>01919     currDragErr = userCanceledErr;
<a name="l01920"></a>01920     <span class="keywordflow">return</span> currDragErr;
<a name="l01921"></a>01921   }
<a name="l01922"></a>01922 
<a name="l01923"></a>01923   currDragSize = size + nItem - 1;
<a name="l01924"></a>01924   currDragData = dst = (<span class="keywordtype">char</span>*)malloc( size+nItem );;
<a name="l01925"></a>01925 
<a name="l01926"></a>01926   <span class="keywordflow">for</span> ( i = 1; i &lt;= nItem; i++ )
<a name="l01927"></a>01927   {
<a name="l01928"></a>01928     GetDragItemReferenceNumber( dragRef, i, &amp;itemRef );
<a name="l01929"></a>01929     ret = GetFlavorFlags( dragRef, itemRef, <span class="stringliteral">&#39;utf8&#39;</span>, &amp;flags );
<a name="l01930"></a>01930     <span class="keywordflow">if</span> ( ret == noErr )
<a name="l01931"></a>01931     {
<a name="l01932"></a>01932       GetFlavorDataSize( dragRef, itemRef, <span class="stringliteral">&#39;utf8&#39;</span>, &amp;itemSize );
<a name="l01933"></a>01933       GetFlavorData( dragRef, itemRef, <span class="stringliteral">&#39;utf8&#39;</span>, dst, &amp;itemSize, 0L );
<a name="l01934"></a>01934       dst += itemSize;
<a name="l01935"></a>01935       *dst++ = <span class="charliteral">&#39;\n&#39;</span>; <span class="comment">// add our element separator</span>
<a name="l01936"></a>01936       <span class="keywordflow">continue</span>;
<a name="l01937"></a>01937     }
<a name="l01938"></a>01938     GetDragItemReferenceNumber( dragRef, i, &amp;itemRef );
<a name="l01939"></a>01939     ret = GetFlavorFlags( dragRef, itemRef, <span class="stringliteral">&#39;utxt&#39;</span>, &amp;flags );
<a name="l01940"></a>01940     <span class="keywordflow">if</span> ( ret == noErr )
<a name="l01941"></a>01941     {
<a name="l01942"></a>01942       GetFlavorDataSize( dragRef, itemRef, <span class="stringliteral">&#39;utxt&#39;</span>, &amp;itemSize );
<a name="l01943"></a>01943       GetFlavorData( dragRef, itemRef, <span class="stringliteral">&#39;utxt&#39;</span>, dst, &amp;itemSize, 0L );
<a name="l01944"></a>01944       dst += itemSize;
<a name="l01945"></a>01945       *dst++ = <span class="charliteral">&#39;\n&#39;</span>; <span class="comment">// add our element separator</span>
<a name="l01946"></a>01946       <span class="keywordflow">continue</span>;
<a name="l01947"></a>01947     }
<a name="l01948"></a>01948     ret = GetFlavorFlags( dragRef, itemRef, <span class="stringliteral">&#39;TEXT&#39;</span>, &amp;flags );
<a name="l01949"></a>01949     <span class="keywordflow">if</span> ( ret == noErr )
<a name="l01950"></a>01950     {
<a name="l01951"></a>01951       GetFlavorDataSize( dragRef, itemRef, <span class="stringliteral">&#39;TEXT&#39;</span>, &amp;itemSize );
<a name="l01952"></a>01952       GetFlavorData( dragRef, itemRef, <span class="stringliteral">&#39;TEXT&#39;</span>, dst, &amp;itemSize, 0L );
<a name="l01953"></a>01953       dst += itemSize;
<a name="l01954"></a>01954       *dst++ = <span class="charliteral">&#39;\n&#39;</span>; <span class="comment">// add our element separator</span>
<a name="l01955"></a>01955       <span class="keywordflow">continue</span>;
<a name="l01956"></a>01956     }
<a name="l01957"></a>01957     ret = GetFlavorFlags( dragRef, itemRef, <span class="stringliteral">&#39;hfs &#39;</span>, &amp;flags );
<a name="l01958"></a>01958     <span class="keywordflow">if</span> ( ret == noErr )
<a name="l01959"></a>01959     {
<a name="l01960"></a>01960       HFSFlavor hfs; itemSize = <span class="keyword">sizeof</span>( hfs );
<a name="l01961"></a>01961       GetFlavorData( dragRef, itemRef, <span class="stringliteral">&#39;hfs &#39;</span>, &amp;hfs, &amp;itemSize, 0L );
<a name="l01962"></a>01962       itemSize = FSSpec2UnixPath( &amp;hfs.fileSpec, dst ); <span class="comment">// return the path name in UTF8</span>
<a name="l01963"></a>01963       dst += itemSize;
<a name="l01964"></a>01964       <span class="keywordflow">if</span> ( itemSize&gt;1 &amp;&amp; ( hfs.fileType==<span class="stringliteral">&#39;fold&#39;</span> || hfs.fileType==<span class="stringliteral">&#39;disk&#39;</span> ) ) 
<a name="l01965"></a>01965         *dst++ = <span class="charliteral">&#39;/&#39;</span>;
<a name="l01966"></a>01966       *dst++ = <span class="charliteral">&#39;\n&#39;</span>; <span class="comment">// add our element separator</span>
<a name="l01967"></a>01967       <span class="keywordflow">continue</span>;
<a name="l01968"></a>01968     }
<a name="l01969"></a>01969   }
<a name="l01970"></a>01970 
<a name="l01971"></a>01971   dst[-1] = 0;
<a name="l01972"></a>01972   currDragSize = dst - currDragData - 1;
<a name="l01973"></a>01973   currDragErr = ret;
<a name="l01974"></a>01974   <span class="keywordflow">return</span> ret;
<a name="l01975"></a>01975 }
<a name="l01976"></a>01976 
<a name="l01980"></a>01980 <span class="keyword">static</span> pascal OSErr dndTrackingHandler( DragTrackingMessage msg, WindowPtr <a class="code" href="forms_8H-2.html#aac374e320caaadeca4874add33b62af2">w</a>, <span class="keywordtype">void</span> *userData, DragReference dragRef )
<a name="l01981"></a>01981 {
<a name="l01982"></a>01982   <a class="code" href="classFl__Window.html">Fl_Window</a> *target = (<a class="code" href="classFl__Window.html">Fl_Window</a>*)userData;
<a name="l01983"></a>01983   <a class="code" href="group__fl__windows.html#ga3130407bc1c11f9b7f2a9c43a87a1599">Fl::first_window</a>(target);
<a name="l01984"></a>01984   Point mp;
<a name="l01985"></a>01985   <span class="keyword">static</span> <span class="keywordtype">int</span> px, <a class="code" href="fl__overlay_8cxx.html#aa9511a47fd6271333948489a220e3029">py</a>;
<a name="l01986"></a>01986   
<a name="l01987"></a>01987   fillCurrentDragData(dragRef);
<a name="l01988"></a>01988   <a class="code" href="classFl.html#a336911cf63dade9bbb9707b942785133">Fl::e_length</a> = currDragSize;
<a name="l01989"></a>01989   <a class="code" href="classFl.html#addcd49b68feff0a807f6564f3fdb8016">Fl::e_text</a> = currDragData;
<a name="l01990"></a>01990   
<a name="l01991"></a>01991   <span class="keywordflow">switch</span> ( msg )
<a name="l01992"></a>01992   {
<a name="l01993"></a>01993   <span class="keywordflow">case</span> kDragTrackingEnterWindow:
<a name="l01994"></a>01994     <span class="comment">// check if &#39;TEXT&#39; is available</span>
<a name="l01995"></a>01995     GetDragMouse( dragRef, &amp;mp, 0 );
<a name="l01996"></a>01996     <a class="code" href="classFl.html#ac905dc5f6e4b4c919e405932413fce30">Fl::e_x_root</a> = px = mp.h;
<a name="l01997"></a>01997     <a class="code" href="classFl.html#af14bafd28cbd839ab2e4526eb4a5c73f">Fl::e_y_root</a> = py = mp.v;
<a name="l01998"></a>01998     <a class="code" href="classFl.html#a7b57f90db4afa2b1b1e2e163e9bdc1d3">Fl::e_x</a> = px - target-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>();
<a name="l01999"></a>01999     <a class="code" href="classFl.html#a0c047ee4ea16066dc9e70bc6a4035c20">Fl::e_y</a> = py - target-&gt;<a class="code" href="classFl__Widget.html#aec1aded9efdf5f23dfac8cc725cefc4a">y</a>();
<a name="l02000"></a>02000     fl_dnd_target_window = target;
<a name="l02001"></a>02001     <span class="keywordflow">if</span> ( <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>( <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3af4f28b5ef9ec051e4a4d9e19a16370b8">FL_DND_ENTER</a>, target ) )
<a name="l02002"></a>02002       <a class="code" href="group__fl__drawings.html#gac3632671b9ae4db7c13f6ce2c9008919">fl_cursor</a>( <a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0a1b25ce2668fb1ca7bd85b0ba4cc20ab7">FL_CURSOR_HAND</a> ); <span class="comment">//ShowDragHilite( ); // modify the mouse cursor?!</span>
<a name="l02003"></a>02003     <span class="keywordflow">else</span>
<a name="l02004"></a>02004       <a class="code" href="group__fl__drawings.html#gac3632671b9ae4db7c13f6ce2c9008919">fl_cursor</a>( <a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0a045f091aae5108f94e912bf5163344dd">FL_CURSOR_DEFAULT</a> ); <span class="comment">//HideDragHilite( dragRef );</span>
<a name="l02005"></a>02005     breakMacEventLoop();
<a name="l02006"></a>02006     <span class="keywordflow">return</span> noErr;
<a name="l02007"></a>02007   <span class="keywordflow">case</span> kDragTrackingInWindow:
<a name="l02008"></a>02008     GetDragMouse( dragRef, &amp;mp, 0 );
<a name="l02009"></a>02009     <span class="keywordflow">if</span> ( mp.h==px &amp;&amp; mp.v==py )
<a name="l02010"></a>02010       <span class="keywordflow">break</span>;    <span class="comment">//+ return previous condition for dnd hiliting</span>
<a name="l02011"></a>02011     <a class="code" href="classFl.html#ac905dc5f6e4b4c919e405932413fce30">Fl::e_x_root</a> = px = mp.h;
<a name="l02012"></a>02012     <a class="code" href="classFl.html#af14bafd28cbd839ab2e4526eb4a5c73f">Fl::e_y_root</a> = py = mp.v;
<a name="l02013"></a>02013     <a class="code" href="classFl.html#a7b57f90db4afa2b1b1e2e163e9bdc1d3">Fl::e_x</a> = px - target-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>();
<a name="l02014"></a>02014     <a class="code" href="classFl.html#a0c047ee4ea16066dc9e70bc6a4035c20">Fl::e_y</a> = py - target-&gt;<a class="code" href="classFl__Widget.html#aec1aded9efdf5f23dfac8cc725cefc4a">y</a>();
<a name="l02015"></a>02015     fl_dnd_target_window = target;
<a name="l02016"></a>02016     <span class="keywordflow">if</span> ( <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>( <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3aadfedcde7415286c752ba427f0e8626f">FL_DND_DRAG</a>, target ) )
<a name="l02017"></a>02017       <a class="code" href="group__fl__drawings.html#gac3632671b9ae4db7c13f6ce2c9008919">fl_cursor</a>( <a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0a1b25ce2668fb1ca7bd85b0ba4cc20ab7">FL_CURSOR_HAND</a> ); <span class="comment">//ShowDragHilite( ); // modify the mouse cursor?!</span>
<a name="l02018"></a>02018     <span class="keywordflow">else</span>
<a name="l02019"></a>02019       <a class="code" href="group__fl__drawings.html#gac3632671b9ae4db7c13f6ce2c9008919">fl_cursor</a>( <a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0a045f091aae5108f94e912bf5163344dd">FL_CURSOR_DEFAULT</a> ); <span class="comment">//HideDragHilite( dragRef );</span>
<a name="l02020"></a>02020     breakMacEventLoop();
<a name="l02021"></a>02021     <span class="keywordflow">return</span> noErr;
<a name="l02022"></a>02022     <span class="keywordflow">break</span>;
<a name="l02023"></a>02023   <span class="keywordflow">case</span> kDragTrackingLeaveWindow:
<a name="l02024"></a>02024     <span class="comment">// HideDragHilite()</span>
<a name="l02025"></a>02025     <a class="code" href="group__fl__drawings.html#gac3632671b9ae4db7c13f6ce2c9008919">fl_cursor</a>( <a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0a045f091aae5108f94e912bf5163344dd">FL_CURSOR_DEFAULT</a> ); <span class="comment">//HideDragHilite( dragRef );</span>
<a name="l02026"></a>02026     <span class="keywordflow">if</span> ( fl_dnd_target_window )
<a name="l02027"></a>02027     {
<a name="l02028"></a>02028       <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>( <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a03bdb8df3578915e1d0829cc048d855e">FL_DND_LEAVE</a>, fl_dnd_target_window );
<a name="l02029"></a>02029       fl_dnd_target_window = 0;
<a name="l02030"></a>02030     }
<a name="l02031"></a>02031     breakMacEventLoop();
<a name="l02032"></a>02032     <span class="keywordflow">return</span> noErr;
<a name="l02033"></a>02033   }
<a name="l02034"></a>02034   <span class="keywordflow">return</span> noErr;
<a name="l02035"></a>02035 }
<a name="l02036"></a>02036 
<a name="l02037"></a>02037 
<a name="l02041"></a>02041 <span class="keyword">static</span> pascal OSErr dndReceiveHandler( WindowPtr w, <span class="keywordtype">void</span> *userData, DragReference dragRef )
<a name="l02042"></a>02042 {
<a name="l02043"></a>02043   Point mp;
<a name="l02044"></a>02044   OSErr ret;
<a name="l02045"></a>02045   
<a name="l02046"></a>02046   <a class="code" href="classFl__Window.html">Fl_Window</a> *target = fl_dnd_target_window = (<a class="code" href="classFl__Window.html">Fl_Window</a>*)userData;
<a name="l02047"></a>02047   <a class="code" href="group__fl__windows.html#ga3130407bc1c11f9b7f2a9c43a87a1599">Fl::first_window</a>(target);
<a name="l02048"></a>02048   GetDragMouse( dragRef, &amp;mp, 0 );
<a name="l02049"></a>02049   <a class="code" href="classFl.html#ac905dc5f6e4b4c919e405932413fce30">Fl::e_x_root</a> = mp.h;
<a name="l02050"></a>02050   <a class="code" href="classFl.html#af14bafd28cbd839ab2e4526eb4a5c73f">Fl::e_y_root</a> = mp.v;
<a name="l02051"></a>02051   <a class="code" href="classFl.html#a7b57f90db4afa2b1b1e2e163e9bdc1d3">Fl::e_x</a> = <a class="code" href="classFl.html#ac905dc5f6e4b4c919e405932413fce30">Fl::e_x_root</a> - target-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>();
<a name="l02052"></a>02052   <a class="code" href="classFl.html#a0c047ee4ea16066dc9e70bc6a4035c20">Fl::e_y</a> = <a class="code" href="classFl.html#af14bafd28cbd839ab2e4526eb4a5c73f">Fl::e_y_root</a> - target-&gt;<a class="code" href="classFl__Widget.html#aec1aded9efdf5f23dfac8cc725cefc4a">y</a>();
<a name="l02053"></a>02053   <span class="keywordflow">if</span> ( !<a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>( <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a80deb55dbc048b83dc154c11c658b7d6">FL_DND_RELEASE</a>, target ) )
<a name="l02054"></a>02054     <span class="keywordflow">return</span> userCanceledErr;
<a name="l02055"></a>02055 
<a name="l02056"></a>02056   ret = fillCurrentDragData(dragRef);
<a name="l02057"></a>02057   <span class="keywordflow">if</span> (ret==userCanceledErr)
<a name="l02058"></a>02058     <span class="keywordflow">return</span> userCanceledErr;
<a name="l02059"></a>02059   
<a name="l02060"></a>02060   <a class="code" href="classFl.html#a336911cf63dade9bbb9707b942785133">Fl::e_length</a> = currDragSize;
<a name="l02061"></a>02061   <a class="code" href="classFl.html#addcd49b68feff0a807f6564f3fdb8016">Fl::e_text</a> = currDragData;
<a name="l02062"></a>02062 <span class="comment">//  printf(&quot;Sending following text to widget %p:\n%s\n&quot;, Fl::belowmouse(), Fl::e_text);</span>
<a name="l02063"></a>02063   <span class="keywordtype">int</span> old_event = <a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a>;
<a name="l02064"></a>02064   <a class="code" href="group__fl__events.html#ga5b55ce634002a2743c24c4c4db7cbdd4">Fl::belowmouse</a>()-&gt;<a class="code" href="classFl__Widget.html#a9cb17cc092697dfd05a3fab55856d218">handle</a>(<a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a> = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a5e811b9d703e6f66cfdca256ecfbb0cf">FL_PASTE</a>);
<a name="l02065"></a>02065   <a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a> = old_event;
<a name="l02066"></a>02066   
<a name="l02067"></a>02067   <span class="keywordflow">if</span> (currDragData) {
<a name="l02068"></a>02068     free(currDragData);
<a name="l02069"></a>02069   }
<a name="l02070"></a>02070   currDragData = 0L;
<a name="l02071"></a>02071   currDragRef = 0;
<a name="l02072"></a>02072   <a class="code" href="classFl.html#addcd49b68feff0a807f6564f3fdb8016">Fl::e_text</a> = 0L;
<a name="l02073"></a>02073   <a class="code" href="classFl.html#a336911cf63dade9bbb9707b942785133">Fl::e_length</a> = 0;
<a name="l02074"></a>02074   fl_dnd_target_window = 0L;
<a name="l02075"></a>02075   
<a name="l02076"></a>02076   breakMacEventLoop();
<a name="l02077"></a>02077   <span class="keywordflow">return</span> noErr;
<a name="l02078"></a>02078 }
<a name="l02079"></a>02079 <span class="comment">// fc:  </span>
<a name="l02080"></a>02080 <span class="keyword">static</span> <span class="keywordtype">void</span>  q_set_window_title(<a class="code" href="mac_8H.html#aad9fe48cacd960402308a6a7f9f5e584">Window</a> xid, <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="png_8h.html#a90cd716fdb9b68c9661c3ba908a0ceff">name</a> ) {
<a name="l02081"></a>02081 <span class="preprocessor">#if 1</span>
<a name="l02082"></a>02082 <span class="preprocessor"></span>    CFStringRef utf8_title = CFStringCreateWithCString(<a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, (name ? name : <span class="stringliteral">&quot;&quot;</span>), kCFStringEncodingUTF8);
<a name="l02083"></a>02083     SetWindowTitleWithCFString(xid, utf8_title);
<a name="l02084"></a>02084     CFRelease(utf8_title);
<a name="l02085"></a>02085 <span class="preprocessor">#else // old non-utf8 code to remove after new utf8 code approval :</span>
<a name="l02086"></a>02086 <span class="preprocessor"></span>    Str255 pTitle;
<a name="l02087"></a>02087     <span class="keywordflow">if</span> (name) {
<a name="l02088"></a>02088       <span class="keywordflow">if</span> (strlen(name) &gt; 255) pTitle[0] = 255;
<a name="l02089"></a>02089       <span class="keywordflow">else</span> pTitle[0] = strlen(name);
<a name="l02090"></a>02090       memcpy(pTitle+1, name, pTitle[0]);
<a name="l02091"></a>02091     } 
<a name="l02092"></a>02092     <span class="keywordflow">else</span> 
<a name="l02093"></a>02093       pTitle[0] = 0;
<a name="l02094"></a>02094     SetWTitle(xid, pTitle);
<a name="l02095"></a>02095 <span class="preprocessor">#endif</span>
<a name="l02096"></a>02096 <span class="preprocessor"></span>}
<a name="l02097"></a>02097 
<a name="l02102"></a><a class="code" href="classFl__X.html#a2d3acae437e4eea48e44c08b2543da73">02102</a> <span class="keywordtype">void</span> <a class="code" href="classFl__X.html#a2d3acae437e4eea48e44c08b2543da73">Fl_X::make</a>(<a class="code" href="classFl__Window.html">Fl_Window</a>* w)
<a name="l02103"></a>02103 {
<a name="l02104"></a>02104   <span class="keyword">static</span> <span class="keywordtype">int</span> xyPos = 100;
<a name="l02105"></a>02105   <span class="keywordflow">if</span> ( w-&gt;<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>() ) <span class="comment">// create a subwindow</span>
<a name="l02106"></a>02106   {
<a name="l02107"></a>02107     <a class="code" href="classFl__Group.html#af48163bbf0a8d18844b5d751946897c0">Fl_Group::current</a>(0);
<a name="l02108"></a>02108     Rect wRect;
<a name="l02109"></a>02109     wRect.top    = w-&gt;<a class="code" href="classFl__Widget.html#aec1aded9efdf5f23dfac8cc725cefc4a">y</a>();
<a name="l02110"></a>02110     wRect.left   = w-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>();
<a name="l02111"></a>02111     wRect.bottom = w-&gt;<a class="code" href="classFl__Widget.html#aec1aded9efdf5f23dfac8cc725cefc4a">y</a>() + w-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>(); <span class="keywordflow">if</span> (wRect.bottom&lt;=wRect.top) wRect.bottom = wRect.top+1;
<a name="l02112"></a>02112     wRect.right  = w-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>() + w-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>(); <span class="keywordflow">if</span> (wRect.right&lt;=wRect.left) wRect.right = wRect.left+1;
<a name="l02113"></a>02113     <span class="comment">// our subwindow needs this structure to know about its clipping. </span>
<a name="l02114"></a>02114     <a class="code" href="classFl__X.html">Fl_X</a>* <a class="code" href="classFl__X.html#ae3e071b57b4577d0c13214be9db17ad5">x</a> = <span class="keyword">new</span> <a class="code" href="classFl__X.html">Fl_X</a>;
<a name="l02115"></a>02115     x-&gt;<a class="code" href="classFl__X.html#a54e86fad0e3c9fc1cdbb72153abacfdf">other_xid</a> = 0;
<a name="l02116"></a>02116     x-&gt;<a class="code" href="classFl__X.html#a2d6b59b7362a486d48b6ae5df0bd0b41">region</a> = 0;
<a name="l02117"></a>02117     x-&gt;subRegion = 0;
<a name="l02118"></a>02118     x-&gt;<a class="code" href="classFl__X.html#acf3febbfadf4ef160511bf7a4bd4572d">cursor</a> = <a class="code" href="win32_8H.html#a5c84f195de614f6aa79fa2f8883b37b6">fl_default_cursor</a>;
<a name="l02119"></a>02119     x-&gt;gc = 0; <span class="comment">// stay 0 for Quickdraw; fill with CGContext for Quartz</span>
<a name="l02120"></a>02120     <a class="code" href="classFl__Window.html">Fl_Window</a> *win = w-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>();
<a name="l02121"></a>02121     <a class="code" href="classFl__X.html">Fl_X</a> *xo = <a class="code" href="classFl__X.html#ae4c6997d92cf8ad3a75a962d7ae77c34">Fl_X::i</a>(win);
<a name="l02122"></a>02122     <span class="keywordflow">if</span> (xo) {
<a name="l02123"></a>02123       x-&gt;xidNext = xo-&gt;xidChildren;
<a name="l02124"></a>02124       x-&gt;xidChildren = 0L;
<a name="l02125"></a>02125       xo-&gt;xidChildren = <a class="code" href="classFl__X.html#ae3e071b57b4577d0c13214be9db17ad5">x</a>;
<a name="l02126"></a>02126       x-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a> = <a class="code" href="mac_8H.html#a87152d2ed84f9d97c6bf3150c7688261">fl_xid</a>(win);
<a name="l02127"></a>02127       x-&gt;<a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a> = <a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>; w-&gt;i = <a class="code" href="classFl__X.html#ae3e071b57b4577d0c13214be9db17ad5">x</a>;
<a name="l02128"></a>02128       x-&gt;<a class="code" href="classFl__X.html#a5bff94b4bde0ceafbaaaaaa3b7d1426e">wait_for_expose</a> = 0;
<a name="l02129"></a>02129       x-&gt;<a class="code" href="classFl__X.html#a41f6a721a953ea62021bb1dd9c4f2187">next</a> = <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a>; <span class="comment">// must be in the list for ::flush()</span>
<a name="l02130"></a>02130       <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a> = <a class="code" href="classFl__X.html#ae3e071b57b4577d0c13214be9db17ad5">x</a>;
<a name="l02131"></a>02131       <span class="keywordtype">int</span> old_event = <a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a>;
<a name="l02132"></a>02132       w-&gt;<a class="code" href="classFl__Window.html#a9c0eb1c55a1a62ef3d3d87676f936187">handle</a>(<a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a> = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a9edbfd236c9ea348dcaae935a76bd885">FL_SHOW</a>);
<a name="l02133"></a>02133       <a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a> = old_event;
<a name="l02134"></a>02134       w-&gt;<a class="code" href="classFl__Widget.html#aa63ce68cbf4620cf8750b868368ea02b">redraw</a>(); <span class="comment">// force draw to happen</span>
<a name="l02135"></a>02135     }
<a name="l02136"></a>02136     <a class="code" href="Fl__arg_8cxx.html#aeed6a7220f140808e50ef846ef0ad3c2">fl_show_iconic</a> = 0;
<a name="l02137"></a>02137   }
<a name="l02138"></a>02138   <span class="keywordflow">else</span> <span class="comment">// create a desktop window</span>
<a name="l02139"></a>02139   {
<a name="l02140"></a>02140     <a class="code" href="classFl__Group.html#af48163bbf0a8d18844b5d751946897c0">Fl_Group::current</a>(0);
<a name="l02141"></a>02141     <a class="code" href="mac_8H.html#a94ee21d83137569a6730e3e2e7305cbc">fl_open_display</a>();
<a name="l02142"></a>02142     <span class="keywordtype">int</span> winclass = kDocumentWindowClass;
<a name="l02143"></a>02143     <span class="keywordtype">int</span> winattr = kWindowStandardHandlerAttribute | kWindowCloseBoxAttribute | kWindowCollapseBoxAttribute;
<a name="l02144"></a>02144     <span class="keywordtype">int</span> xp = w-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>();
<a name="l02145"></a>02145     <span class="keywordtype">int</span> yp = w-&gt;<a class="code" href="classFl__Widget.html#aec1aded9efdf5f23dfac8cc725cefc4a">y</a>();
<a name="l02146"></a>02146     <span class="keywordtype">int</span> wp = w-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>();
<a name="l02147"></a>02147     <span class="keywordtype">int</span> hp = w-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>();
<a name="l02148"></a>02148     <span class="keywordflow">if</span> (w-&gt;size_range_set) {
<a name="l02149"></a>02149       <span class="keywordflow">if</span> ( w-&gt;minh != w-&gt;maxh || w-&gt;minw != w-&gt;maxw)
<a name="l02150"></a>02150         winattr |= kWindowFullZoomAttribute | kWindowResizableAttribute | kWindowLiveResizeAttribute;
<a name="l02151"></a>02151     } <span class="keywordflow">else</span> {
<a name="l02152"></a>02152       <span class="keywordflow">if</span> (w-&gt;<a class="code" href="classFl__Group.html#ab0ed0d1974d7185594687849f386c5f3">resizable</a>()) {
<a name="l02153"></a>02153         <a class="code" href="classFl__Widget.html">Fl_Widget</a> *o = w-&gt;<a class="code" href="classFl__Group.html#ab0ed0d1974d7185594687849f386c5f3">resizable</a>();
<a name="l02154"></a>02154         <span class="keywordtype">int</span> minw = o-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>(); <span class="keywordflow">if</span> (minw &gt; 100) minw = 100;
<a name="l02155"></a>02155         <span class="keywordtype">int</span> minh = o-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>(); <span class="keywordflow">if</span> (minh &gt; 100) minh = 100;
<a name="l02156"></a>02156         w-&gt;<a class="code" href="classFl__Window.html#a9be71df81e121b984f33140720102d59">size_range</a>(w-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>() - o-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>() + minw, w-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>() - o-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>() + minh, 0, 0);
<a name="l02157"></a>02157         winattr |= kWindowFullZoomAttribute | kWindowResizableAttribute | kWindowLiveResizeAttribute;
<a name="l02158"></a>02158       } <span class="keywordflow">else</span> {
<a name="l02159"></a>02159         w-&gt;<a class="code" href="classFl__Window.html#a9be71df81e121b984f33140720102d59">size_range</a>(w-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>(), w-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>(), w-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>(), w-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>());
<a name="l02160"></a>02160       }
<a name="l02161"></a>02161     }
<a name="l02162"></a>02162     <span class="keywordtype">int</span> xwm = xp, ywm = yp, bt, bx, by;
<a name="l02163"></a>02163 
<a name="l02164"></a>02164     <span class="keywordflow">if</span> (!<a class="code" href="classFl__X.html#a1bd922580d8cb633ec0cdb8c2b012f94">fake_X_wm</a>(w, xwm, ywm, bt, bx, by)) {
<a name="l02165"></a>02165       <span class="comment">// menu windows and tooltips</span>
<a name="l02166"></a>02166       <span class="keywordflow">if</span> (w-&gt;<a class="code" href="classFl__Window.html#a6cc843ffcc711300613e44c678ad682f">modal</a>()||w-&gt;<a class="code" href="classFl__Window.html#aeed8d628ef854ea63a4e2badd9596eb7">override</a>()) {
<a name="l02167"></a>02167         winclass = kHelpWindowClass;
<a name="l02168"></a>02168         winattr  = 0;
<a name="l02169"></a>02169       } <span class="keywordflow">else</span> {
<a name="l02170"></a>02170         winattr = 512; <span class="comment">// kWindowNoTitleBarAttribute;</span>
<a name="l02171"></a>02171       }
<a name="l02172"></a>02172     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (w-&gt;<a class="code" href="classFl__Window.html#a6cc843ffcc711300613e44c678ad682f">modal</a>()) {
<a name="l02173"></a>02173       winclass = kMovableModalWindowClass;
<a name="l02174"></a>02174     }
<a name="l02175"></a>02175 
<a name="l02176"></a>02176     <span class="keywordflow">if</span> (by+bt) {
<a name="l02177"></a>02177       wp += 2*bx;
<a name="l02178"></a>02178       hp += 2*by+bt;
<a name="l02179"></a>02179     }
<a name="l02180"></a>02180     <span class="keywordflow">if</span> (!(w-&gt;<a class="code" href="classFl__Widget.html#a2bd83b947c7f75919afc280043c958db">flags</a>() &amp; <a class="code" href="classFl__Widget.html#acd8a95e8128fe1673479b8d0f4d0aa62a1d2b155a766bc59be7a3f60d306de852" title="don&amp;#39;t let the window manager position the window (Fl_Window)">Fl_Widget::FORCE_POSITION</a>)) {
<a name="l02181"></a>02181       <span class="comment">// use the Carbon functions below for default window positioning</span>
<a name="l02182"></a>02182       w-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>(xyPos+<a class="code" href="group__fl__screen.html#gaed836eacded3467aa838d02a1c55e3ab">Fl::x</a>());
<a name="l02183"></a>02183       w-&gt;<a class="code" href="classFl__Widget.html#aec1aded9efdf5f23dfac8cc725cefc4a">y</a>(xyPos+<a class="code" href="group__fl__screen.html#gafa36572c1f755f8a9783efc351f19021">Fl::y</a>());
<a name="l02184"></a>02184       xyPos += 25;
<a name="l02185"></a>02185       <span class="keywordflow">if</span> (xyPos&gt;200) xyPos = 100;
<a name="l02186"></a>02186     } <span class="keywordflow">else</span> {
<a name="l02187"></a>02187       <span class="keywordflow">if</span> (!<a class="code" href="group__fl__windows.html#ga100705a8107397cfde7318aa34019739">Fl::grab</a>()) {
<a name="l02188"></a>02188         xp = xwm; yp = ywm;
<a name="l02189"></a>02189         w-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>(xp);w-&gt;<a class="code" href="classFl__Widget.html#aec1aded9efdf5f23dfac8cc725cefc4a">y</a>(yp);
<a name="l02190"></a>02190       }
<a name="l02191"></a>02191       xp -= bx;
<a name="l02192"></a>02192       yp -= by+bt;
<a name="l02193"></a>02193     }
<a name="l02194"></a>02194 
<a name="l02195"></a>02195     <span class="keywordflow">if</span> (w-&gt;<a class="code" href="classFl__Window.html#a663df072d1d68c5733a1c5f2f88fd819">non_modal</a>() &amp;&amp; <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a> &amp;&amp; !<a class="code" href="Fl__mac_8cxx.html#a3635433c445a0e91b41396116930abbd">fl_disable_transient_for</a>) {
<a name="l02196"></a>02196       <span class="comment">// find some other window to be &quot;transient for&quot;:</span>
<a name="l02197"></a>02197       <a class="code" href="classFl__Window.html">Fl_Window</a>* w = <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a>-&gt;<a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>;
<a name="l02198"></a>02198       <span class="keywordflow">while</span> (w-&gt;<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>()) w = w-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>(); <span class="comment">// todo: this code does not make any sense! (w!=w??)</span>
<a name="l02199"></a>02199     }
<a name="l02200"></a>02200 
<a name="l02201"></a>02201     Rect wRect;
<a name="l02202"></a>02202     wRect.top    = w-&gt;<a class="code" href="classFl__Widget.html#aec1aded9efdf5f23dfac8cc725cefc4a">y</a>();
<a name="l02203"></a>02203     wRect.left   = w-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>();
<a name="l02204"></a>02204     wRect.bottom = w-&gt;<a class="code" href="classFl__Widget.html#aec1aded9efdf5f23dfac8cc725cefc4a">y</a>() + w-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>(); <span class="keywordflow">if</span> (wRect.bottom&lt;=wRect.top) wRect.bottom = wRect.top+1;
<a name="l02205"></a>02205     wRect.right  = w-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>() + w-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>(); <span class="keywordflow">if</span> (wRect.right&lt;=wRect.left) wRect.right = wRect.left+1;
<a name="l02206"></a>02206 
<a name="l02207"></a>02207     <span class="keyword">const</span> <span class="keywordtype">char</span> *name = w-&gt;<a class="code" href="classFl__Window.html#a51a6665c988138e426fc12b4bf138f7b">label</a>();
<a name="l02208"></a>02208 
<a name="l02209"></a>02209     <a class="code" href="classFl__X.html">Fl_X</a>* <a class="code" href="classFl__X.html#ae3e071b57b4577d0c13214be9db17ad5">x</a> = <span class="keyword">new</span> <a class="code" href="classFl__X.html">Fl_X</a>;
<a name="l02210"></a>02210     x-&gt;<a class="code" href="classFl__X.html#a54e86fad0e3c9fc1cdbb72153abacfdf">other_xid</a> = 0; <span class="comment">// room for doublebuffering image map. On OS X this is only used by overlay windows</span>
<a name="l02211"></a>02211     x-&gt;<a class="code" href="classFl__X.html#a2d6b59b7362a486d48b6ae5df0bd0b41">region</a> = 0;
<a name="l02212"></a>02212     x-&gt;subRegion = 0;
<a name="l02213"></a>02213     x-&gt;<a class="code" href="classFl__X.html#acf3febbfadf4ef160511bf7a4bd4572d">cursor</a> = <a class="code" href="win32_8H.html#a5c84f195de614f6aa79fa2f8883b37b6">fl_default_cursor</a>;
<a name="l02214"></a>02214     x-&gt;xidChildren = 0;
<a name="l02215"></a>02215     x-&gt;xidNext = 0;
<a name="l02216"></a>02216     x-&gt;gc = 0;
<a name="l02217"></a>02217 
<a name="l02218"></a>02218     winattr &amp;= GetAvailableWindowAttributes( winclass );        <span class="comment">// make sure that the window will open</span>
<a name="l02219"></a>02219     CreateNewWindow( winclass, winattr, &amp;wRect, &amp;(x-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>) );
<a name="l02220"></a>02220     q_set_window_title(x-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, name);
<a name="l02221"></a>02221     MoveWindow(x-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, wRect.left, wRect.top, 1);       <span class="comment">// avoid Carbon Bug on old OS</span>
<a name="l02222"></a>02222     <span class="keywordflow">if</span> (w-&gt;<a class="code" href="classFl__Window.html#a663df072d1d68c5733a1c5f2f88fd819">non_modal</a>() &amp;&amp; !w-&gt;<a class="code" href="classFl__Window.html#a6cc843ffcc711300613e44c678ad682f">modal</a>()) {
<a name="l02223"></a>02223       <span class="comment">// Major kludge: this is to have the regular look, but stay above the document windows</span>
<a name="l02224"></a>02224       SetWindowClass(x-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, kFloatingWindowClass);
<a name="l02225"></a>02225       SetWindowActivationScope(x-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, kWindowActivationScopeAll);
<a name="l02226"></a>02226     }
<a name="l02227"></a>02227     <span class="keywordflow">if</span> (!(w-&gt;<a class="code" href="classFl__Widget.html#a2bd83b947c7f75919afc280043c958db">flags</a>() &amp; <a class="code" href="classFl__Widget.html#acd8a95e8128fe1673479b8d0f4d0aa62a1d2b155a766bc59be7a3f60d306de852" title="don&amp;#39;t let the window manager position the window (Fl_Window)">Fl_Widget::FORCE_POSITION</a>))
<a name="l02228"></a>02228     {
<a name="l02229"></a>02229       WindowRef <a class="code" href="fl__overlay_8cxx.html#af09ff1950046bd7b7e24206842bdb75f">pw</a> = <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a> ? <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a>-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a> : 0 ;
<a name="l02230"></a>02230       <span class="keywordflow">if</span> (w-&gt;<a class="code" href="classFl__Window.html#a6cc843ffcc711300613e44c678ad682f">modal</a>()) {
<a name="l02231"></a>02231         RepositionWindow(x-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, pw, kWindowAlertPositionOnParentWindowScreen);
<a name="l02232"></a>02232       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (w-&gt;<a class="code" href="classFl__Window.html#a663df072d1d68c5733a1c5f2f88fd819">non_modal</a>()) {
<a name="l02233"></a>02233         RepositionWindow(x-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, pw, kWindowCenterOnParentWindowScreen);
<a name="l02234"></a>02234       } <span class="keywordflow">else</span> {
<a name="l02235"></a>02235         RepositionWindow(x-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, pw, kWindowCascadeOnParentWindowScreen);
<a name="l02236"></a>02236       }
<a name="l02237"></a>02237     }
<a name="l02238"></a>02238     x-&gt;<a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a> = <a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>; w-&gt;i = <a class="code" href="classFl__X.html#ae3e071b57b4577d0c13214be9db17ad5">x</a>;
<a name="l02239"></a>02239     x-&gt;<a class="code" href="classFl__X.html#a5bff94b4bde0ceafbaaaaaa3b7d1426e">wait_for_expose</a> = 1;
<a name="l02240"></a>02240     x-&gt;<a class="code" href="classFl__X.html#a41f6a721a953ea62021bb1dd9c4f2187">next</a> = <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a>;
<a name="l02241"></a>02241     <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a> = <a class="code" href="classFl__X.html#ae3e071b57b4577d0c13214be9db17ad5">x</a>;
<a name="l02242"></a>02242     { <span class="comment">// Install Carbon Event handlers </span>
<a name="l02243"></a>02243       OSStatus ret;
<a name="l02244"></a>02244       EventHandlerUPP mousewheelHandler = NewEventHandlerUPP( carbonMousewheelHandler ); <span class="comment">// will not be disposed by Carbon...</span>
<a name="l02245"></a>02245       <span class="keyword">static</span> EventTypeSpec mousewheelEvents[] = {
<a name="l02246"></a>02246         { kEventClassMouse, kEventMouseWheelMoved } };
<a name="l02247"></a>02247       ret = InstallWindowEventHandler( x-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, mousewheelHandler,
<a name="l02248"></a>02248                 (<span class="keywordtype">int</span>)(<span class="keyword">sizeof</span>(mousewheelEvents)/<span class="keyword">sizeof</span>(mousewheelEvents[0])),
<a name="l02249"></a>02249                 mousewheelEvents, w, 0L );
<a name="l02250"></a>02250       EventHandlerUPP mouseHandler = NewEventHandlerUPP( carbonMouseHandler ); <span class="comment">// will not be disposed by Carbon...</span>
<a name="l02251"></a>02251       <span class="keyword">static</span> EventTypeSpec mouseEvents[] = {
<a name="l02252"></a>02252         { kEventClassMouse, kEventMouseDown },
<a name="l02253"></a>02253         { kEventClassMouse, kEventMouseUp },
<a name="l02254"></a>02254         { kEventClassMouse, kEventMouseMoved },
<a name="l02255"></a>02255         { kEventClassMouse, kEventMouseDragged } };
<a name="l02256"></a>02256       ret = InstallWindowEventHandler( x-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, mouseHandler, 4, mouseEvents, w, 0L );
<a name="l02257"></a>02257 
<a name="l02258"></a>02258       EventHandlerUPP keyboardHandler = NewEventHandlerUPP( <a class="code" href="Fl__mac_8cxx.html#a84efb1f8474d4ae18c33b07980e5ca70">carbonKeyboardHandler</a> ); <span class="comment">// will not be disposed by Carbon...</span>
<a name="l02259"></a>02259       <span class="keyword">static</span> EventTypeSpec keyboardEvents[] = {
<a name="l02260"></a>02260         { kEventClassKeyboard, kEventRawKeyDown },
<a name="l02261"></a>02261         { kEventClassKeyboard, kEventRawKeyRepeat },
<a name="l02262"></a>02262         { kEventClassKeyboard, kEventRawKeyUp },
<a name="l02263"></a>02263         { kEventClassKeyboard, kEventRawKeyModifiersChanged } };
<a name="l02264"></a>02264       ret = InstallWindowEventHandler( x-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, keyboardHandler, 4, keyboardEvents, w, 0L );
<a name="l02265"></a>02265 
<a name="l02266"></a>02266       EventHandlerUPP textHandler = NewEventHandlerUPP( <a class="code" href="Fl__mac_8cxx.html#a3a040ae7ec69dd5e772636eb9faf688d">carbonTextHandler</a> ); <span class="comment">// will not be disposed by Carbon...</span>
<a name="l02267"></a>02267       <span class="keyword">static</span> EventTypeSpec textEvents[] = {
<a name="l02268"></a>02268         { kEventClassTextInput, kEventTextInputUnicodeForKeyEvent } };
<a name="l02269"></a>02269       ret = InstallWindowEventHandler( x-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, textHandler, 1, textEvents, w, 0L );
<a name="l02270"></a>02270 
<a name="l02271"></a>02271       EventHandlerUPP windowHandler = NewEventHandlerUPP( carbonWindowHandler ); <span class="comment">// will not be disposed by Carbon...</span>
<a name="l02272"></a>02272       <span class="keyword">static</span> EventTypeSpec windowEvents[] = {
<a name="l02273"></a>02273         { kEventClassWindow, kEventWindowDrawContent },
<a name="l02274"></a>02274         { kEventClassWindow, kEventWindowShown },
<a name="l02275"></a>02275         { kEventClassWindow, kEventWindowHidden },
<a name="l02276"></a>02276         { kEventClassWindow, kEventWindowActivated },
<a name="l02277"></a>02277         { kEventClassWindow, kEventWindowDeactivated },
<a name="l02278"></a>02278         { kEventClassWindow, kEventWindowClose },
<a name="l02279"></a>02279         { kEventClassWindow, kEventWindowCollapsed },
<a name="l02280"></a>02280         { kEventClassWindow, kEventWindowExpanded },
<a name="l02281"></a>02281         { kEventClassWindow, kEventWindowBoundsChanging },
<a name="l02282"></a>02282         { kEventClassWindow, kEventWindowBoundsChanged } };
<a name="l02283"></a>02283       ret = InstallWindowEventHandler( x-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, windowHandler, 10, windowEvents, w, 0L );
<a name="l02284"></a>02284       ret = InstallTrackingHandler( dndTrackingHandler, x-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, w );
<a name="l02285"></a>02285       ret = InstallReceiveHandler( dndReceiveHandler, x-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, w );
<a name="l02286"></a>02286     }
<a name="l02287"></a>02287 
<a name="l02288"></a>02288     <span class="keywordflow">if</span> ( ! <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a>-&gt;<a class="code" href="classFl__X.html#a41f6a721a953ea62021bb1dd9c4f2187">next</a> ) <span class="comment">// if this is the first window, we need to bring the application to the front</span>
<a name="l02289"></a>02289     { 
<a name="l02290"></a>02290       ProcessSerialNumber psn;
<a name="l02291"></a>02291       OSErr err = GetCurrentProcess( &amp;psn );
<a name="l02292"></a>02292       <span class="keywordflow">if</span> ( err==noErr ) SetFrontProcess( &amp;psn );
<a name="l02293"></a>02293     }
<a name="l02294"></a>02294     
<a name="l02295"></a>02295     <span class="keywordflow">if</span> (w-&gt;size_range_set) w-&gt;size_range_();
<a name="l02296"></a>02296     
<a name="l02297"></a>02297     <span class="keywordflow">if</span> (winclass != kHelpWindowClass) {
<a name="l02298"></a>02298       <a class="code" href="classFl__Tooltip.html#a80ef6ebc30fab1c398ae4dd137c88ddc">Fl_Tooltip::enter</a>(0);
<a name="l02299"></a>02299     }
<a name="l02300"></a>02300     <span class="keywordflow">if</span> (w-&gt;size_range_set) w-&gt;size_range_();
<a name="l02301"></a>02301     ShowWindow(x-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>);
<a name="l02302"></a>02302     <span class="keywordflow">if</span> (<a class="code" href="Fl__arg_8cxx.html#aeed6a7220f140808e50ef846ef0ad3c2">fl_show_iconic</a>) { 
<a name="l02303"></a>02303       <a class="code" href="Fl__arg_8cxx.html#aeed6a7220f140808e50ef846ef0ad3c2">fl_show_iconic</a> = 0;
<a name="l02304"></a>02304       CollapseWindow( x-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, <span class="keyword">true</span> ); <span class="comment">// \todo Mac ; untested</span>
<a name="l02305"></a>02305     } <span class="keywordflow">else</span> {
<a name="l02306"></a>02306       w-&gt;<a class="code" href="classFl__Widget.html#a85981546c4927bd5e6d43d6e3df3416a">set_visible</a>();
<a name="l02307"></a>02307     }
<a name="l02308"></a>02308 
<a name="l02309"></a>02309     Rect <a class="code" href="gl2opengl_8h.html#a856fcb8a7983d83666201749244432e5">rect</a>;
<a name="l02310"></a>02310     GetWindowBounds(x-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, kWindowContentRgn, &amp;rect);
<a name="l02311"></a>02311     w-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>(rect.left); w-&gt;<a class="code" href="classFl__Widget.html#aec1aded9efdf5f23dfac8cc725cefc4a">y</a>(rect.top);
<a name="l02312"></a>02312     w-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>(rect.right-rect.left); w-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>(rect.bottom-rect.top);
<a name="l02313"></a>02313 
<a name="l02314"></a>02314     <span class="keywordtype">int</span> old_event = <a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a>;
<a name="l02315"></a>02315     w-&gt;<a class="code" href="classFl__Window.html#a9c0eb1c55a1a62ef3d3d87676f936187">handle</a>(<a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a> = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a9edbfd236c9ea348dcaae935a76bd885">FL_SHOW</a>);
<a name="l02316"></a>02316     <a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a> = old_event;
<a name="l02317"></a>02317     w-&gt;<a class="code" href="classFl__Widget.html#aa63ce68cbf4620cf8750b868368ea02b">redraw</a>(); <span class="comment">// force draw to happen</span>
<a name="l02318"></a>02318     
<a name="l02319"></a>02319     <span class="keywordflow">if</span> (w-&gt;<a class="code" href="classFl__Window.html#a6cc843ffcc711300613e44c678ad682f">modal</a>()) { <a class="code" href="classFl.html#ab9927ecc1f8f3077079c5fabe8ec516e">Fl::modal_</a> = <a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>; <a class="code" href="Fl_8cxx.html#afe3a0306383e206c9b1e04accc9a28e7">fl_fix_focus</a>(); }
<a name="l02320"></a>02320   }
<a name="l02321"></a>02321 }
<a name="l02322"></a>02322 
<a name="l02323"></a>02323 
<a name="l02327"></a>02327 <span class="keywordtype">void</span> Fl_Window::size_range_() {
<a name="l02328"></a>02328   size_range_set = 1;
<a name="l02329"></a>02329   HISize minSize = { minw, minh };
<a name="l02330"></a>02330   HISize maxSize = { maxw?maxw:32000, maxh?maxh:32000 };
<a name="l02331"></a>02331   <span class="keywordflow">if</span> (i &amp;&amp; i-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>)
<a name="l02332"></a>02332     SetWindowResizeLimits(i-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, &amp;minSize, &amp;maxSize);
<a name="l02333"></a>02333 }
<a name="l02334"></a>02334 
<a name="l02335"></a>02335 
<a name="l02339"></a><a class="code" href="group__filenames.html#ga0ac0f44a1709c6ff94f56a8954dc8fd6">02339</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="group__filenames.html#ga0ac0f44a1709c6ff94f56a8954dc8fd6">fl_filename_name</a>( <span class="keyword">const</span> <span class="keywordtype">char</span> *name ) 
<a name="l02340"></a>02340 {
<a name="l02341"></a>02341   <span class="keyword">const</span> <span class="keywordtype">char</span> *p, *q;
<a name="l02342"></a>02342   <span class="keywordflow">if</span> (!name) <span class="keywordflow">return</span> (0);
<a name="l02343"></a>02343   <span class="keywordflow">for</span> ( p = q = name ; *p ; ) 
<a name="l02344"></a>02344   {
<a name="l02345"></a>02345     <span class="keywordflow">if</span> ( ( p[0] == <span class="charliteral">&#39;:&#39;</span> ) &amp;&amp; ( p[1] == <span class="charliteral">&#39;:&#39;</span> ) ) 
<a name="l02346"></a>02346     {
<a name="l02347"></a>02347       q = p+2;
<a name="l02348"></a>02348       p++;
<a name="l02349"></a>02349     }
<a name="l02350"></a>02350     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p[0] == <span class="charliteral">&#39;/&#39;</span>)
<a name="l02351"></a>02351       q = p + 1;
<a name="l02352"></a>02352     p++;
<a name="l02353"></a>02353   }
<a name="l02354"></a>02354   <span class="keywordflow">return</span> q;
<a name="l02355"></a>02355 }
<a name="l02356"></a>02356 
<a name="l02357"></a>02357 
<a name="l02362"></a><a class="code" href="classFl__Window.html#a7f34a499bd30417479a20bd16963f4fa">02362</a> <span class="keywordtype">void</span> <a class="code" href="classFl__Window.html#a51a6665c988138e426fc12b4bf138f7b">Fl_Window::label</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *name,<span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="comment">/*iname*/</span>) {
<a name="l02363"></a>02363   <a class="code" href="classFl__Window.html#a51a6665c988138e426fc12b4bf138f7b">Fl_Widget::label</a>(name);
<a name="l02364"></a>02364 
<a name="l02365"></a>02365   <span class="keywordflow">if</span> (<a class="code" href="classFl__Window.html#aa09300542b2d8b49fc69a037bdd3b742">shown</a>() || i) {
<a name="l02366"></a>02366     q_set_window_title(<a class="code" href="mac_8H.html#a87152d2ed84f9d97c6bf3150c7688261">fl_xid</a>(<span class="keyword">this</span>), name);
<a name="l02367"></a>02367   }
<a name="l02368"></a>02368 }
<a name="l02369"></a>02369 
<a name="l02370"></a>02370 
<a name="l02374"></a><a class="code" href="classFl__Window.html#afc4d3796226dfd4620b4d7cf29c287c9">02374</a> <span class="keywordtype">void</span> <a class="code" href="classFl__Window.html#afc4d3796226dfd4620b4d7cf29c287c9">Fl_Window::show</a>() {
<a name="l02375"></a>02375   <a class="code" href="classFl__Widget.html#a42372b96b98b126a211b88dc935c2ae6">image</a>(<a class="code" href="classFl.html#a653ad1197e2b6e99038c86a2ab6a9b46">Fl::scheme_bg_</a>);
<a name="l02376"></a>02376   <span class="keywordflow">if</span> (<a class="code" href="classFl.html#a653ad1197e2b6e99038c86a2ab6a9b46">Fl::scheme_bg_</a>) {
<a name="l02377"></a>02377     <a class="code" href="classFl__Widget.html#ad85415f61c0a5513bc524c4b6fc2b57e">labeltype</a>(<a class="code" href="Enumerations_8H.html#ad5774781d33328b82990ff9e25dfd61ba81ddb843b9f43f73446ea7d6d7d8cc84" title="draws the text (0)">FL_NORMAL_LABEL</a>);
<a name="l02378"></a>02378     <a class="code" href="classFl__Widget.html#aad980d813b8a47d777bde7cfa6b85eae">align</a>(<a class="code" href="Enumerations_8H.html#a427f1ce53c37478a59f64bec4a2e2241">FL_ALIGN_CENTER</a> | <a class="code" href="Enumerations_8H.html#ade440c90fc9c2495fdf04c9cb34fba34">FL_ALIGN_INSIDE</a> | <a class="code" href="Enumerations_8H.html#a527e2db976be1a8508c226b4ca54eaa7">FL_ALIGN_CLIP</a>);
<a name="l02379"></a>02379   } <span class="keywordflow">else</span> {
<a name="l02380"></a>02380     <a class="code" href="classFl__Widget.html#ad85415f61c0a5513bc524c4b6fc2b57e">labeltype</a>(<a class="code" href="Enumerations_8H.html#ad5774781d33328b82990ff9e25dfd61bac7e2de1d28830fe78743126eebcbe13b" title="does nothing">FL_NO_LABEL</a>);
<a name="l02381"></a>02381   }
<a name="l02382"></a>02382   <a class="code" href="classFl__Tooltip.html#af68420923dbbb7f9381b0852ad885d90">Fl_Tooltip::exit</a>(<span class="keyword">this</span>);
<a name="l02383"></a>02383   <span class="keywordflow">if</span> (!<a class="code" href="classFl__Window.html#aa09300542b2d8b49fc69a037bdd3b742">shown</a>() || !i) {
<a name="l02384"></a>02384     <a class="code" href="classFl__X.html#a2d3acae437e4eea48e44c08b2543da73">Fl_X::make</a>(<span class="keyword">this</span>);
<a name="l02385"></a>02385   } <span class="keywordflow">else</span> {
<a name="l02386"></a>02386       <span class="keywordflow">if</span> ( !<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>() )
<a name="l02387"></a>02387       {
<a name="l02388"></a>02388         <span class="keywordflow">if</span> ( IsWindowCollapsed( i-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a> ) ) CollapseWindow( i-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, <span class="keyword">false</span> );
<a name="l02389"></a>02389         <span class="keywordflow">if</span> (!<a class="code" href="Fl__mac_8cxx.html#a6e10f30f9e6dd98ed093691fd605a0c2">fl_capture</a>) {
<a name="l02390"></a>02390           BringToFront(i-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>);
<a name="l02391"></a>02391           SelectWindow(i-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>);
<a name="l02392"></a>02392         }
<a name="l02393"></a>02393       }
<a name="l02394"></a>02394   }
<a name="l02395"></a>02395 }
<a name="l02396"></a>02396 
<a name="l02397"></a>02397 
<a name="l02401"></a><a class="code" href="classFl__Window.html#a7b3f27fe1b0fbc2a06065a7f037a2fbb">02401</a> <span class="keywordtype">void</span> <a class="code" href="classFl__Window.html#a7b3f27fe1b0fbc2a06065a7f037a2fbb">Fl_Window::resize</a>(<span class="keywordtype">int</span> X,<span class="keywordtype">int</span> Y,<span class="keywordtype">int</span> W,<span class="keywordtype">int</span> <a class="code" href="Fl__Tooltip_8cxx.html#affa487e8e3cc48473cfc05c0ce0165e9">H</a>) {
<a name="l02402"></a>02402   <span class="keywordflow">if</span> (W&lt;=0) W = 1; <span class="comment">// OS X does not like zero width windows</span>
<a name="l02403"></a>02403   <span class="keywordflow">if</span> (H&lt;=0) H = 1;
<a name="l02404"></a>02404   <span class="keywordtype">int</span> is_a_resize = (W != <a class="code" href="classFl__Widget.html#aec9e0a6f77d93e6f8caffc1b0f6abbda">w</a>() || H != <a class="code" href="classFl__Widget.html#a994f71abd8b39c87cef909713d3347f0">h</a>());
<a name="l02405"></a>02405 <span class="comment">//  printf(&quot;Fl_Winodw::resize(X=%d, Y=%d, W=%d, H=%d), is_a_resize=%d, resize_from_system=%p, this=%p\n&quot;,</span>
<a name="l02406"></a>02406 <span class="comment">//         X, Y, W, H, is_a_resize, resize_from_system, this);</span>
<a name="l02407"></a>02407   <span class="keywordflow">if</span> (X != <a class="code" href="classFl__Widget.html#ad09bc10de43482a671f834a653211e9f">x</a>() || Y != <a class="code" href="classFl__Widget.html#a54fbdc7be9ae81c6b34abc73a93908f1">y</a>()) <a class="code" href="classFl__Widget.html#a7244e112711741978f19ceadd8f196b5">set_flag</a>(<a class="code" href="classFl__Widget.html#acd8a95e8128fe1673479b8d0f4d0aa62a1d2b155a766bc59be7a3f60d306de852" title="don&amp;#39;t let the window manager position the window (Fl_Window)">FORCE_POSITION</a>);
<a name="l02408"></a>02408   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!is_a_resize) <span class="keywordflow">return</span>;
<a name="l02409"></a>02409   <span class="keywordflow">if</span> ( (resize_from_system!=<span class="keyword">this</span>) &amp;&amp; (!<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>()) &amp;&amp; <a class="code" href="classFl__Window.html#aa09300542b2d8b49fc69a037bdd3b742">shown</a>()) {
<a name="l02410"></a>02410     <span class="keywordflow">if</span> (is_a_resize) {
<a name="l02411"></a>02411       <span class="keywordflow">if</span> (<a class="code" href="classFl__Group.html#aef229a2364bd97ac364a0ec29231ce90">resizable</a>()) {
<a name="l02412"></a>02412         <span class="keywordflow">if</span> (W&lt;minw) minw = W; <span class="comment">// user request for resize takes priority</span>
<a name="l02413"></a>02413         <span class="keywordflow">if</span> (W&gt;maxw) maxw = W; <span class="comment">// over a previously set size_range</span>
<a name="l02414"></a>02414         <span class="keywordflow">if</span> (H&lt;minh) minh = <a class="code" href="Fl__Tooltip_8cxx.html#affa487e8e3cc48473cfc05c0ce0165e9">H</a>;
<a name="l02415"></a>02415         <span class="keywordflow">if</span> (H&gt;maxh) maxh = <a class="code" href="Fl__Tooltip_8cxx.html#affa487e8e3cc48473cfc05c0ce0165e9">H</a>;
<a name="l02416"></a>02416         <a class="code" href="classFl__Window.html#a9be71df81e121b984f33140720102d59">size_range</a>(minw, minh, maxw, maxh);
<a name="l02417"></a>02417       } <span class="keywordflow">else</span> {
<a name="l02418"></a>02418         <a class="code" href="classFl__Window.html#a9be71df81e121b984f33140720102d59">size_range</a>(W, H, W, H);
<a name="l02419"></a>02419       }
<a name="l02420"></a>02420       Rect dim; dim.left=X; dim.top=Y; dim.right=X+W; dim.bottom=Y+<a class="code" href="Fl__Tooltip_8cxx.html#affa487e8e3cc48473cfc05c0ce0165e9">H</a>;
<a name="l02421"></a>02421       SetWindowBounds(i-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, kWindowContentRgn, &amp;dim);
<a name="l02422"></a>02422       Rect all; all.top=-32000; all.bottom=32000; all.left=-32000; all.right=32000;
<a name="l02423"></a>02423       InvalWindowRect( i-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, &amp;all );    
<a name="l02424"></a>02424     } <span class="keywordflow">else</span> {
<a name="l02425"></a>02425       MoveWindow(i-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>, X, Y, 0);
<a name="l02426"></a>02426     }
<a name="l02427"></a>02427   }
<a name="l02428"></a>02428   resize_from_system = 0;
<a name="l02429"></a>02429   <span class="keywordflow">if</span> (is_a_resize) {
<a name="l02430"></a>02430     <a class="code" href="classFl__Window.html#a7b3f27fe1b0fbc2a06065a7f037a2fbb">Fl_Group::resize</a>(X,Y,W,H);
<a name="l02431"></a>02431     <span class="keywordflow">if</span> (<a class="code" href="classFl__Window.html#aa09300542b2d8b49fc69a037bdd3b742">shown</a>()) { 
<a name="l02432"></a>02432       <a class="code" href="classFl__Widget.html#aa63ce68cbf4620cf8750b868368ea02b">redraw</a>(); 
<a name="l02433"></a>02433     }
<a name="l02434"></a>02434   } <span class="keywordflow">else</span> {
<a name="l02435"></a>02435     <a class="code" href="classFl__Widget.html#ad09bc10de43482a671f834a653211e9f">x</a>(X); <a class="code" href="classFl__Widget.html#a54fbdc7be9ae81c6b34abc73a93908f1">y</a>(Y); 
<a name="l02436"></a>02436   }
<a name="l02437"></a>02437 }
<a name="l02438"></a>02438 
<a name="l02439"></a>02439 
<a name="l02443"></a><a class="code" href="classFl__Window.html#a65a2499309b3fdd1bed463cefa0cd1e2">02443</a> <span class="keywordtype">void</span> <a class="code" href="classFl__Window.html#a65a2499309b3fdd1bed463cefa0cd1e2">Fl_Window::make_current</a>() 
<a name="l02444"></a>02444 {
<a name="l02445"></a>02445   OSStatus err;
<a name="l02446"></a>02446   Fl_X::q_release_context();
<a name="l02447"></a>02447   <span class="keywordflow">if</span> ( !<a class="code" href="Fl__mac_8cxx.html#afe6a785e40298db77c700ceb9b6f7193">fl_window_region</a> )
<a name="l02448"></a>02448     <a class="code" href="Fl__mac_8cxx.html#afe6a785e40298db77c700ceb9b6f7193">fl_window_region</a> = NewRgn();
<a name="l02449"></a>02449   <a class="code" href="win32_8H.html#afdab6664143864c36ba6b51782b32500">fl_window</a> = i-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>;
<a name="l02450"></a>02450   <a class="code" href="classFl__Window.html#ab9f4f5ec887ad5f4eac561eb02a97402">current_</a> = <span class="keyword">this</span>;
<a name="l02451"></a>02451 
<a name="l02452"></a>02452   SetPort( GetWindowPort(i-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>) ); <span class="comment">// \todo check for the handling of doublebuffered windows</span>
<a name="l02453"></a>02453 
<a name="l02454"></a>02454   <span class="keywordtype">int</span> xp = 0, yp = 0;
<a name="l02455"></a>02455   <a class="code" href="classFl__Window.html">Fl_Window</a> *win = <span class="keyword">this</span>;
<a name="l02456"></a>02456   <span class="keywordflow">while</span> ( win ) 
<a name="l02457"></a>02457   {
<a name="l02458"></a>02458     <span class="keywordflow">if</span> ( !win-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>() )
<a name="l02459"></a>02459       <span class="keywordflow">break</span>;
<a name="l02460"></a>02460     xp += win-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>();
<a name="l02461"></a>02461     yp += win-&gt;<a class="code" href="classFl__Widget.html#aec1aded9efdf5f23dfac8cc725cefc4a">y</a>();
<a name="l02462"></a>02462     win = (<a class="code" href="classFl__Window.html">Fl_Window</a>*)win-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>();
<a name="l02463"></a>02463   }
<a name="l02464"></a>02464   SetOrigin( -xp, -yp );
<a name="l02465"></a>02465   
<a name="l02466"></a>02466   SetRectRgn( <a class="code" href="Fl__mac_8cxx.html#afe6a785e40298db77c700ceb9b6f7193">fl_window_region</a>, 0, 0, <a class="code" href="classFl__Widget.html#aec9e0a6f77d93e6f8caffc1b0f6abbda">w</a>(), <a class="code" href="classFl__Widget.html#a994f71abd8b39c87cef909713d3347f0">h</a>() );
<a name="l02467"></a>02467   
<a name="l02468"></a>02468   <span class="comment">// \todo for performance reasons: we don&#39;t have to create this unless the child windows moved</span>
<a name="l02469"></a>02469   <span class="keywordflow">for</span> ( <a class="code" href="classFl__X.html">Fl_X</a> *cx = i-&gt;xidChildren; cx; cx = cx-&gt;xidNext )
<a name="l02470"></a>02470   {
<a name="l02471"></a>02471     <a class="code" href="classFl__Window.html">Fl_Window</a> *cw = cx-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>;
<a name="l02472"></a>02472     <span class="keywordflow">if</span> (!cw-&gt;<a class="code" href="classFl__Widget.html#a8e786561b8670afd0b4a582de5087905">visible_r</a>()) <span class="keywordflow">continue</span>;
<a name="l02473"></a>02473     <a class="code" href="mac_8H.html#aa3f54ef9dd28ee61ae42bd36291a31f2">Fl_Region</a> r = NewRgn();
<a name="l02474"></a>02474     SetRectRgn( r, cw-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>() - xp, cw-&gt;<a class="code" href="classFl__Widget.html#aec1aded9efdf5f23dfac8cc725cefc4a">y</a>() - yp, 
<a name="l02475"></a>02475                    cw-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>() + cw-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>() - xp, cw-&gt;<a class="code" href="classFl__Widget.html#aec1aded9efdf5f23dfac8cc725cefc4a">y</a>() + cw-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>() - yp );
<a name="l02476"></a>02476     DiffRgn( <a class="code" href="Fl__mac_8cxx.html#afe6a785e40298db77c700ceb9b6f7193">fl_window_region</a>, r, <a class="code" href="Fl__mac_8cxx.html#afe6a785e40298db77c700ceb9b6f7193">fl_window_region</a> );
<a name="l02477"></a>02477     DisposeRgn( r );
<a name="l02478"></a>02478   }
<a name="l02479"></a>02479  
<a name="l02480"></a>02480   err = <a class="code" href="cgdebug_8h.html#a54035b1c1e3758e424e04b8d5fda29c8">QDBeginCGContext</a>(GetWindowPort(i-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>), &amp;i-&gt;gc);
<a name="l02481"></a>02481   <span class="keywordflow">if</span> (err!=noErr) 
<a name="l02482"></a>02482     fprintf(stderr, <span class="stringliteral">&quot;Error %d in QDBeginCGContext\n&quot;</span>, (<span class="keywordtype">int</span>)err);
<a name="l02483"></a>02483   <a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a> = i-&gt;gc;
<a name="l02484"></a>02484   <a class="code" href="cgdebug_8h.html#a4fbec629d6e26e1508c812a84cafbb90">CGContextSaveGState</a>(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>);
<a name="l02485"></a>02485   Fl_X::q_fill_context();
<a name="l02486"></a>02486 <span class="preprocessor">#if defined(USE_CAIRO)</span>
<a name="l02487"></a>02487 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (Fl::cairo_autolink_context()) Fl::cairo_make_current(<span class="keyword">this</span>); <span class="comment">// capture gc changes automatically to update the cairo context adequately</span>
<a name="l02488"></a>02488 <span class="preprocessor">#endif</span>
<a name="l02489"></a>02489 <span class="preprocessor"></span>
<a name="l02490"></a>02490   <a class="code" href="group__fl__drawings.html#gaa9cb59129942d660fb7472c653d3589e">fl_clip_region</a>( 0 );
<a name="l02491"></a>02491   SetPortClipRegion( GetWindowPort(i-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>), <a class="code" href="Fl__mac_8cxx.html#afe6a785e40298db77c700ceb9b6f7193">fl_window_region</a> );
<a name="l02492"></a>02492 
<a name="l02493"></a>02493 <span class="preprocessor">#if defined(USE_CAIRO)</span>
<a name="l02494"></a>02494 <span class="preprocessor"></span>  <span class="comment">// update the cairo_t context</span>
<a name="l02495"></a>02495   <span class="keywordflow">if</span> (Fl::cairo_autolink_context()) Fl::cairo_make_current(<span class="keyword">this</span>);
<a name="l02496"></a>02496 <span class="preprocessor">#endif</span>
<a name="l02497"></a>02497 <span class="preprocessor"></span>}
<a name="l02498"></a>02498 
<a name="l02499"></a>02499 <span class="comment">// helper function to manage the current CGContext fl_gc</span>
<a name="l02500"></a>02500 <span class="keyword">extern</span> <a class="code" href="Enumerations_8H.html#a8b762953646f8abee866061f1af78a6a">Fl_Color</a> <a class="code" href="group__fl__attributes.html#ga98168ab58de419961165f303b7c525a6" title="The current color.">fl_color_</a>;
<a name="l02501"></a>02501 <span class="keyword">extern</span> <span class="keyword">class </span><a class="code" href="classFl__Font__Descriptor.html">Fl_Font_Descriptor</a> *<a class="code" href="Fl__Font_8H.html#ae08261f97c0d2c5962bd28869fd871e7">fl_fontsize</a>;
<a name="l02502"></a>02502 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="group__fl__attributes.html#ga1bdba1e2b321676da6b0b290f485bf27">fl_font</a>(<span class="keyword">class</span> <a class="code" href="classFl__Font__Descriptor.html">Fl_Font_Descriptor</a>*);
<a name="l02503"></a>02503 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="Fl__mac_8cxx.html#a07bd33f242fc60ede971d731dff14a86">fl_quartz_restore_line_style_</a>();
<a name="l02504"></a>02504 
<a name="l02505"></a>02505 <span class="comment">// FLTK has only one global graphics state. This function copies the FLTK state into the</span>
<a name="l02506"></a>02506 <span class="comment">// current Quartz context</span>
<a name="l02507"></a>02507 <span class="keywordtype">void</span> Fl_X::q_fill_context() {
<a name="l02508"></a>02508   <span class="keywordflow">if</span> (!<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>) <span class="keywordflow">return</span>;
<a name="l02509"></a>02509   <span class="keywordtype">int</span> hgt = 0;
<a name="l02510"></a>02510   <span class="keywordflow">if</span> (<a class="code" href="win32_8H.html#afdab6664143864c36ba6b51782b32500">fl_window</a>) {
<a name="l02511"></a>02511     Rect portRect; 
<a name="l02512"></a>02512     GetPortBounds(GetWindowPort( <a class="code" href="win32_8H.html#afdab6664143864c36ba6b51782b32500">fl_window</a> ), &amp;portRect);
<a name="l02513"></a>02513     hgt = portRect.bottom-portRect.top;
<a name="l02514"></a>02514   } <span class="keywordflow">else</span> {
<a name="l02515"></a>02515     hgt = CGBitmapContextGetHeight(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>);
<a name="l02516"></a>02516   }
<a name="l02517"></a>02517   CGContextTranslateCTM(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>, 0.5, hgt-0.5<a class="code" href="fl__boxtype_8cxx.html#ac406db58651c10e8f67ed432c66db0d6">f</a>);
<a name="l02518"></a>02518   CGContextScaleCTM(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>, 1.0<a class="code" href="fl__boxtype_8cxx.html#ac406db58651c10e8f67ed432c66db0d6">f</a>, -1.0<a class="code" href="fl__boxtype_8cxx.html#ac406db58651c10e8f67ed432c66db0d6">f</a>);
<a name="l02519"></a>02519   <a class="code" href="group__fl__attributes.html#ga1bdba1e2b321676da6b0b290f485bf27">fl_font</a>(fl_fontsize);
<a name="l02520"></a>02520   <a class="code" href="group__fl__attributes.html#ga974e9f64959aa83cf6f0a36d3f0105aa">fl_color</a>(fl_color_);
<a name="l02521"></a>02521   <a class="code" href="Fl__mac_8cxx.html#a07bd33f242fc60ede971d731dff14a86">fl_quartz_restore_line_style_</a>();
<a name="l02522"></a>02522 }
<a name="l02523"></a>02523 
<a name="l02524"></a>02524 <span class="comment">// The only way to reset clipping to its original state is to pop the current graphics</span>
<a name="l02525"></a>02525 <span class="comment">// state and restore the global state.</span>
<a name="l02526"></a>02526 <span class="keywordtype">void</span> Fl_X::q_clear_clipping() {
<a name="l02527"></a>02527   <span class="keywordflow">if</span> (!<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>) <span class="keywordflow">return</span>;
<a name="l02528"></a>02528   <a class="code" href="cgdebug_8h.html#afeea8e876e977d350ccb421a7c7e0acb">CGContextRestoreGState</a>(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>);
<a name="l02529"></a>02529   <a class="code" href="cgdebug_8h.html#a4fbec629d6e26e1508c812a84cafbb90">CGContextSaveGState</a>(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>);
<a name="l02530"></a>02530 }
<a name="l02531"></a>02531 
<a name="l02532"></a>02532 <span class="comment">// Give the Quartz context back to the system</span>
<a name="l02533"></a>02533 <span class="keywordtype">void</span> Fl_X::q_release_context(<a class="code" href="classFl__X.html">Fl_X</a> *<a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>) {
<a name="l02534"></a>02534   <span class="keywordflow">if</span> (x &amp;&amp; x-&gt;gc!=<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>) <span class="keywordflow">return</span>;
<a name="l02535"></a>02535   <span class="keywordflow">if</span> (!<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>) <span class="keywordflow">return</span>;
<a name="l02536"></a>02536   <a class="code" href="cgdebug_8h.html#afeea8e876e977d350ccb421a7c7e0acb">CGContextRestoreGState</a>(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>);
<a name="l02537"></a>02537   <span class="keywordflow">if</span> (<a class="code" href="win32_8H.html#afdab6664143864c36ba6b51782b32500">fl_window</a>) {
<a name="l02538"></a>02538     OSStatus err = <a class="code" href="cgdebug_8h.html#ad56bae469aaea603bd53b734d19e41e1">QDEndCGContext</a>(GetWindowPort(<a class="code" href="win32_8H.html#afdab6664143864c36ba6b51782b32500">fl_window</a>), &amp;<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>);
<a name="l02539"></a>02539     <span class="keywordflow">if</span> (err!=noErr)
<a name="l02540"></a>02540       fprintf(stderr, <span class="stringliteral">&quot;Error %d in QDEndCGContext\n&quot;</span>, (<span class="keywordtype">int</span>)err);
<a name="l02541"></a>02541   }
<a name="l02542"></a>02542   <a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a> = 0;
<a name="l02543"></a>02543 <span class="preprocessor">#if defined(USE_CAIRO)</span>
<a name="l02544"></a>02544 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (Fl::cairo_autolink_context()) Fl::cairo_make_current((<a class="code" href="classFl__Window.html">Fl_Window</a>*) 0); <span class="comment">// capture gc changes automatically to update the cairo context adequately</span>
<a name="l02545"></a>02545 <span class="preprocessor">#endif</span>
<a name="l02546"></a>02546 <span class="preprocessor"></span>}
<a name="l02547"></a>02547 
<a name="l02548"></a>02548 <span class="keywordtype">void</span> Fl_X::q_begin_image(CGRect &amp;<a class="code" href="gl2opengl_8h.html#a856fcb8a7983d83666201749244432e5">rect</a>, <span class="keywordtype">int</span> cx, <span class="keywordtype">int</span> cy, <span class="keywordtype">int</span> w, <span class="keywordtype">int</span> <a class="code" href="forms_8H-2.html#a7e427ba5b307f9068129699250690066">h</a>) {
<a name="l02549"></a>02549   <a class="code" href="cgdebug_8h.html#a4fbec629d6e26e1508c812a84cafbb90">CGContextSaveGState</a>(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>);
<a name="l02550"></a>02550   CGAffineTransform mx = CGContextGetCTM(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>);
<a name="l02551"></a>02551   CGRect r2 = <a class="code" href="gl2opengl_8h.html#a856fcb8a7983d83666201749244432e5">rect</a>;
<a name="l02552"></a>02552   r2.origin.x -= 0.5f;
<a name="l02553"></a>02553   r2.origin.y -= 0.5f;
<a name="l02554"></a>02554   <a class="code" href="cgdebug_8h.html#aaa9e0839f29f4c704e38719446d19a7b">CGContextClipToRect</a>(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>, r2);
<a name="l02555"></a>02555   mx.d = -1.0; mx.tx = -mx.tx;
<a name="l02556"></a>02556   CGContextConcatCTM(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>, mx);
<a name="l02557"></a>02557   rect.origin.x = -(mx.tx+0.5f) + rect.origin.x     - cx;
<a name="l02558"></a>02558   rect.origin.y =  (mx.ty+0.5f) - rect.origin.y - h + cy;
<a name="l02559"></a>02559   rect.size.width = <a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>;
<a name="l02560"></a>02560   rect.<a class="code" href="classFl__Widget.html#ae386844a68c27ea0b64313619551e786">size</a>.height = <a class="code" href="forms_8H-2.html#a7e427ba5b307f9068129699250690066">h</a>;
<a name="l02561"></a>02561 }
<a name="l02562"></a>02562 
<a name="l02563"></a>02563 <span class="keywordtype">void</span> Fl_X::q_end_image() {
<a name="l02564"></a>02564   <a class="code" href="cgdebug_8h.html#afeea8e876e977d350ccb421a7c7e0acb">CGContextRestoreGState</a>(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>);
<a name="l02565"></a>02565 }
<a name="l02566"></a>02566 
<a name="l02568"></a>02568 <span class="comment">// Copy &amp; Paste fltk implementation.</span>
<a name="l02570"></a>02570 <span class="comment"></span>
<a name="l02571"></a>02571 <span class="comment">// fltk 1.3 clipboard support constant definitions:</span>
<a name="l02572"></a><a class="code" href="Fl__mac_8cxx.html#a1a6c131b0d648ca83b7835cfbb014aee">02572</a> <span class="keyword">const</span> CFStringRef       <a class="code" href="Fl__mac_8cxx.html#a1a6c131b0d648ca83b7835cfbb014aee">flavorNames</a>[] = {
<a name="l02573"></a>02573   CFSTR(<span class="stringliteral">&quot;public.utf16-plain-text&quot;</span>), 
<a name="l02574"></a>02574   CFSTR(<span class="stringliteral">&quot;public.utf8-plain-text&quot;</span>),
<a name="l02575"></a>02575   CFSTR(<span class="stringliteral">&quot;com.apple.traditional-mac-plain-text&quot;</span>) };
<a name="l02576"></a><a class="code" href="Fl__mac_8cxx.html#a2e6c7dc48613ecc3b3fed3084e6be110">02576</a> <span class="keyword">const</span> CFStringEncoding <a class="code" href="Fl__mac_8cxx.html#a2e6c7dc48613ecc3b3fed3084e6be110">encodings</a>[] = { 
<a name="l02577"></a>02577   kCFStringEncodingUTF16, 
<a name="l02578"></a>02578   kCFStringEncodingUTF8, 
<a name="l02579"></a>02579   kCFStringEncodingMacRoman};
<a name="l02580"></a><a class="code" href="Fl__mac_8cxx.html#ac6954cdae777da2c2201a0d21a7f66f0">02580</a> <span class="keyword">const</span> <span class="keywordtype">size_t</span> <a class="code" href="Fl__mac_8cxx.html#ac6954cdae777da2c2201a0d21a7f66f0">handledFlavorsCount</a> = <span class="keyword">sizeof</span>(<a class="code" href="Fl__mac_8cxx.html#a2e6c7dc48613ecc3b3fed3084e6be110">encodings</a>)/<span class="keyword">sizeof</span>(CFStringEncoding);
<a name="l02581"></a>02581 
<a name="l02582"></a>02582 <span class="comment">// clipboard variables definitions :</span>
<a name="l02583"></a><a class="code" href="Fl__mac_8cxx.html#ab0f3888aed9e28e4a7741a25f96d3b39">02583</a> <a class="code" href="classFl__Widget.html">Fl_Widget</a> *<a class="code" href="Fl_8cxx.html#ab0f3888aed9e28e4a7741a25f96d3b39">fl_selection_requestor</a> = 0;
<a name="l02584"></a><a class="code" href="Fl__mac_8cxx.html#ab850f01f9743ea1b220f00c8bda656be">02584</a> <span class="keywordtype">char</span> *<a class="code" href="fl__dnd__win32_8cxx.html#ab850f01f9743ea1b220f00c8bda656be">fl_selection_buffer</a>[2];
<a name="l02585"></a><a class="code" href="Fl__mac_8cxx.html#ac27fcc9909cfd33bc0bbd5085312a301">02585</a> <span class="keywordtype">int</span> <a class="code" href="fl__dnd__win32_8cxx.html#ac27fcc9909cfd33bc0bbd5085312a301">fl_selection_length</a>[2];
<a name="l02586"></a>02586 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="fl__dnd__win32_8cxx.html#a074479f79d157734e2835b1885ade608">fl_selection_buffer_length</a>[2];
<a name="l02587"></a>02587 
<a name="l02588"></a>02588 <span class="preprocessor">#ifdef USE_PASTEBOARD</span>
<a name="l02589"></a>02589 <span class="preprocessor"></span><span class="keyword">static</span> PasteboardRef myPasteboard = 0;
<a name="l02590"></a>02590 <span class="keyword">static</span> <span class="keywordtype">void</span> allocatePasteboard() {
<a name="l02591"></a>02591   <span class="keywordflow">if</span> (!myPasteboard)
<a name="l02592"></a>02592     PasteboardCreate(kPasteboardClipboard, &amp;myPasteboard);
<a name="l02593"></a>02593 }
<a name="l02594"></a>02594 <span class="preprocessor">#else</span>
<a name="l02595"></a>02595 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l02596"></a>02596 <span class="preprocessor"></span>
<a name="l02597"></a>02597 <span class="preprocessor">#ifndef USE_PASTEBOARD</span>
<a name="l02598"></a>02598 <span class="preprocessor"></span><span class="keyword">static</span> ScrapRef myScrap = 0;
<a name="l02599"></a>02599 <span class="preprocessor">#endif</span>
<a name="l02600"></a>02600 <span class="preprocessor"></span>
<a name="l02607"></a><a class="code" href="group__fl__clipboard.html#gaa219ad0a09d4ff6f7d8feddcc7e96b90">02607</a> <span class="keywordtype">void</span> <a class="code" href="group__fl__clipboard.html#gaa219ad0a09d4ff6f7d8feddcc7e96b90">Fl::copy</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *stuff, <span class="keywordtype">int</span> len, <span class="keywordtype">int</span> clipboard) {
<a name="l02608"></a>02608   <span class="keywordflow">if</span> (!stuff || len&lt;0) <span class="keywordflow">return</span>;
<a name="l02609"></a>02609   <span class="keywordflow">if</span> (len+1 &gt; fl_selection_buffer_length[clipboard]) {
<a name="l02610"></a>02610     <span class="keyword">delete</span>[] fl_selection_buffer[clipboard];
<a name="l02611"></a>02611     fl_selection_buffer[clipboard] = <span class="keyword">new</span> <span class="keywordtype">char</span>[len+100];
<a name="l02612"></a>02612     fl_selection_buffer_length[clipboard] = len+100;
<a name="l02613"></a>02613   }
<a name="l02614"></a>02614   memcpy(fl_selection_buffer[clipboard], stuff, len);
<a name="l02615"></a>02615   fl_selection_buffer[clipboard][len] = 0; <span class="comment">// needed for direct paste</span>
<a name="l02616"></a>02616   fl_selection_length[clipboard] = len;
<a name="l02617"></a>02617   <span class="keywordflow">if</span> (clipboard) {
<a name="l02618"></a>02618 <span class="preprocessor">#ifdef USE_PASTEBOARD</span>
<a name="l02619"></a>02619 <span class="preprocessor"></span>    <span class="comment">// FIXME no error checking done yet!</span>
<a name="l02620"></a>02620     allocatePasteboard();
<a name="l02621"></a>02621     OSStatus err = PasteboardClear(myPasteboard);
<a name="l02622"></a>02622     <span class="keywordflow">if</span> (err!=noErr) <span class="keywordflow">return</span>; <span class="comment">// clear did not work, maybe not owner of clipboard.</span>
<a name="l02623"></a>02623     PasteboardSynchronize(myPasteboard);
<a name="l02624"></a>02624     CFDataRef text = CFDataCreate(kCFAllocatorDefault, (UInt8*)fl_selection_buffer[1], len);
<a name="l02625"></a>02625     <span class="keywordflow">if</span> (text==<a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>; <span class="comment">// there was a pb creating the object, abort.</span>
<a name="l02626"></a>02626     err=PasteboardPutItemFlavor(myPasteboard, (PasteboardItemID)1, CFSTR(<span class="stringliteral">&quot;public.utf8-plain-text&quot;</span>), text, 0);
<a name="l02627"></a>02627     CFRelease(text);
<a name="l02628"></a>02628 <span class="preprocessor">#else</span>
<a name="l02629"></a>02629 <span class="preprocessor"></span>    OSStatus err = ClearCurrentScrap(); <span class="comment">// whatever happens we should clear the current scrap.</span>
<a name="l02630"></a>02630     <span class="keywordflow">if</span>(err!=noErr) {myScrap=0; <span class="keywordflow">return</span>;} <span class="comment">// don&#39;t get current scrap if a prev err occured. </span>
<a name="l02631"></a>02631     err = GetCurrentScrap( &amp;myScrap );
<a name="l02632"></a>02632     <span class="keywordflow">if</span> ( err != noErr ) {
<a name="l02633"></a>02633       myScrap = 0;
<a name="l02634"></a>02634       <span class="keywordflow">return</span>;
<a name="l02635"></a>02635     }
<a name="l02636"></a>02636     <span class="comment">// Previous version changed \n to \r before sending the text, but I would</span>
<a name="l02637"></a>02637     <span class="comment">// prefer to leave the local buffer alone, so a copied buffer may be</span>
<a name="l02638"></a>02638     <span class="comment">// needed. Check to see if this is necessary on OS/X.</span>
<a name="l02639"></a>02639     PutScrapFlavor( myScrap, kScrapFlavorTypeText, 0,
<a name="l02640"></a>02640                     len, fl_selection_buffer[1] );
<a name="l02641"></a>02641 <span class="preprocessor">#endif</span>
<a name="l02642"></a>02642 <span class="preprocessor"></span>  }
<a name="l02643"></a>02643 }
<a name="l02644"></a>02644 
<a name="l02645"></a>02645 <span class="comment">// Call this when a &quot;paste&quot; operation happens:</span>
<a name="l02646"></a><a class="code" href="group__fl__clipboard.html#ga2d0fc8fedc6bfc23f378b3f100660d80">02646</a> <span class="keywordtype">void</span> <a class="code" href="group__fl__clipboard.html#ga2d0fc8fedc6bfc23f378b3f100660d80">Fl::paste</a>(<a class="code" href="classFl__Widget.html">Fl_Widget</a> &amp;receiver, <span class="keywordtype">int</span> clipboard) {
<a name="l02647"></a>02647     <span class="keywordflow">if</span> (clipboard) {
<a name="l02648"></a>02648         <span class="comment">// see if we own the selection, if not go get it:</span>
<a name="l02649"></a>02649         fl_selection_length[1] = 0;
<a name="l02650"></a>02650 <span class="preprocessor">#ifdef USE_PASTEBOARD</span>
<a name="l02651"></a>02651 <span class="preprocessor"></span>        OSStatus err = noErr;
<a name="l02652"></a>02652         Boolean found = <span class="keyword">false</span>;
<a name="l02653"></a>02653         CFDataRef flavorData = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02654"></a>02654         CFStringEncoding encoding = 0;
<a name="l02655"></a>02655 
<a name="l02656"></a>02656         allocatePasteboard();
<a name="l02657"></a>02657         PasteboardSynchronize(myPasteboard);
<a name="l02658"></a>02658         ItemCount nFlavor = 0, <a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>, j;
<a name="l02659"></a>02659         err = PasteboardGetItemCount(myPasteboard, &amp;nFlavor);
<a name="l02660"></a>02660         <span class="keywordflow">if</span> (err==noErr) {
<a name="l02661"></a>02661             <span class="keywordflow">for</span> (i=1; i&lt;=nFlavor; i++) {
<a name="l02662"></a>02662                 PasteboardItemID itemID = 0;
<a name="l02663"></a>02663                 CFArrayRef flavorTypeArray = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02664"></a>02664                 found = <span class="keyword">false</span>;
<a name="l02665"></a>02665                 err = PasteboardGetItemIdentifier(myPasteboard, i, &amp;itemID);
<a name="l02666"></a>02666                 <span class="keywordflow">if</span> (err!=noErr) <span class="keywordflow">continue</span>;
<a name="l02667"></a>02667                 err = PasteboardCopyItemFlavors(myPasteboard, itemID, &amp;flavorTypeArray);
<a name="l02668"></a>02668                 <span class="keywordflow">if</span> (err!=noErr) {
<a name="l02669"></a>02669                   <span class="keywordflow">if</span> (flavorTypeArray) {CFRelease(flavorTypeArray); flavorTypeArray = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;}
<a name="l02670"></a>02670                   <span class="keywordflow">continue</span>;
<a name="l02671"></a>02671                 }
<a name="l02672"></a>02672                 CFIndex flavorCount = CFArrayGetCount(flavorTypeArray);
<a name="l02673"></a>02673                 <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="Fl__mac_8cxx.html#ac6954cdae777da2c2201a0d21a7f66f0">handledFlavorsCount</a>; j++) {
<a name="l02674"></a>02674                     <span class="keywordflow">for</span> (CFIndex flavorIndex=0; flavorIndex&lt;flavorCount; flavorIndex++) {
<a name="l02675"></a>02675                         CFStringRef flavorType = (CFStringRef)CFArrayGetValueAtIndex(flavorTypeArray, flavorIndex);
<a name="l02676"></a>02676                         <span class="keywordflow">if</span> (UTTypeConformsTo(flavorType, flavorNames[j])) {
<a name="l02677"></a>02677                             err = PasteboardCopyItemFlavorData( myPasteboard, itemID, flavorNames[j], &amp;flavorData );
<a name="l02678"></a>02678                             <span class="keywordflow">if</span>(err != noErr) <span class="keywordflow">continue</span>;
<a name="l02679"></a>02679                             encoding = encodings[j];
<a name="l02680"></a>02680                             found = <span class="keyword">true</span>;
<a name="l02681"></a>02681                             <span class="keywordflow">break</span>;
<a name="l02682"></a>02682                         }
<a name="l02683"></a>02683                     }
<a name="l02684"></a>02684                     <span class="keywordflow">if</span>(found) <span class="keywordflow">break</span>;
<a name="l02685"></a>02685                 }
<a name="l02686"></a>02686                 <span class="keywordflow">if</span> (flavorTypeArray) {CFRelease(flavorTypeArray); flavorTypeArray = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;}
<a name="l02687"></a>02687                 <span class="keywordflow">if</span> (found) <span class="keywordflow">break</span>;
<a name="l02688"></a>02688             }
<a name="l02689"></a>02689             <span class="keywordflow">if</span>(found) {
<a name="l02690"></a>02690                 CFIndex len = CFDataGetLength(flavorData);
<a name="l02691"></a>02691                 CFStringRef mycfs = CFStringCreateWithBytes(<a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, CFDataGetBytePtr(flavorData), len, encoding, <span class="keyword">false</span>);
<a name="l02692"></a>02692                 CFRelease(flavorData);
<a name="l02693"></a>02693                 len = CFStringGetMaximumSizeForEncoding(CFStringGetLength(mycfs), kCFStringEncodingUTF8) + 1;
<a name="l02694"></a>02694                 <span class="keywordflow">if</span> ( len &gt;= fl_selection_buffer_length[1] ) {
<a name="l02695"></a>02695                     fl_selection_buffer_length[1] = len;
<a name="l02696"></a>02696                     <span class="keyword">delete</span>[] fl_selection_buffer[1];
<a name="l02697"></a>02697                     fl_selection_buffer[1] = <span class="keyword">new</span> <span class="keywordtype">char</span>[len];
<a name="l02698"></a>02698                 }
<a name="l02699"></a>02699                 CFStringGetCString(mycfs, fl_selection_buffer[1], len, kCFStringEncodingUTF8);
<a name="l02700"></a>02700                 CFRelease(mycfs);
<a name="l02701"></a>02701                 len = strlen(fl_selection_buffer[1]);
<a name="l02702"></a>02702                 fl_selection_length[1] = len;
<a name="l02703"></a>02703                 convert_crlf(fl_selection_buffer[1],len); <span class="comment">// turn all \r characters into \n:</span>
<a name="l02704"></a>02704             }
<a name="l02705"></a>02705         }
<a name="l02706"></a>02706 <span class="preprocessor">#else</span>
<a name="l02707"></a>02707 <span class="preprocessor"></span>        ScrapRef scrap = 0;
<a name="l02708"></a>02708         <span class="keywordflow">if</span> (GetCurrentScrap(&amp;scrap) == noErr &amp;&amp; scrap != myScrap &amp;&amp;
<a name="l02709"></a>02709             GetScrapFlavorSize(scrap, kScrapFlavorTypeText, &amp;len) == noErr) {
<a name="l02710"></a>02710             <span class="keywordflow">if</span> ( len &gt;= fl_selection_buffer_length[1] ) {
<a name="l02711"></a>02711                 fl_selection_buffer_length[1] = len + 32;
<a name="l02712"></a>02712                 <span class="keyword">delete</span>[] fl_selection_buffer[1];
<a name="l02713"></a>02713                 fl_selection_buffer[1] = <span class="keyword">new</span> <span class="keywordtype">char</span>[len + 32];
<a name="l02714"></a>02714             }
<a name="l02715"></a>02715             fl_selection_length[1] = len; len++;
<a name="l02716"></a>02716             GetScrapFlavorData( scrap, kScrapFlavorTypeText, &amp;len,
<a name="l02717"></a>02717                                fl_selection_buffer[1] );
<a name="l02718"></a>02718             fl_selection_buffer[1][fl_selection_length[1]] = 0;
<a name="l02719"></a>02719             convert_crlf(fl_selection_buffer[1],len); 
<a name="l02720"></a>02720         }
<a name="l02721"></a>02721 <span class="preprocessor">#endif</span>
<a name="l02722"></a>02722 <span class="preprocessor"></span>    }
<a name="l02723"></a>02723     <a class="code" href="classFl.html#addcd49b68feff0a807f6564f3fdb8016">Fl::e_text</a> = fl_selection_buffer[clipboard];
<a name="l02724"></a>02724     <a class="code" href="classFl.html#a336911cf63dade9bbb9707b942785133">Fl::e_length</a> = fl_selection_length[clipboard];
<a name="l02725"></a>02725     <span class="keywordflow">if</span> (!<a class="code" href="classFl.html#addcd49b68feff0a807f6564f3fdb8016">Fl::e_text</a>) <a class="code" href="classFl.html#addcd49b68feff0a807f6564f3fdb8016">Fl::e_text</a> = (<span class="keywordtype">char</span> *)<span class="stringliteral">&quot;&quot;</span>;
<a name="l02726"></a>02726     receiver.<a class="code" href="classFl__Widget.html#a9cb17cc092697dfd05a3fab55856d218">handle</a>(<a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a5e811b9d703e6f66cfdca256ecfbb0cf">FL_PASTE</a>);
<a name="l02727"></a>02727 }
<a name="l02728"></a>02728 
<a name="l02729"></a>02729 <span class="keywordtype">void</span> <a class="code" href="classFl.html#a23e63eb7cec3a27fa360e66c6e2b2e52">Fl::add_timeout</a>(<span class="keywordtype">double</span> time, <a class="code" href="group__callback__functions.html#gaf00cf21170aa3231f6e869a30a036390">Fl_Timeout_Handler</a> cb, <span class="keywordtype">void</span>* data)
<a name="l02730"></a>02730 {
<a name="l02731"></a>02731    <span class="comment">// check, if this timer slot exists already</span>
<a name="l02732"></a>02732    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0;  i &lt; mac_timer_used;  ++<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>) {
<a name="l02733"></a>02733         <a class="code" href="structMacTimeout.html">MacTimeout</a>&amp; t = mac_timers[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>];
<a name="l02734"></a>02734         <span class="comment">// if so, simply change the fire interval</span>
<a name="l02735"></a>02735         <span class="keywordflow">if</span> (t.<a class="code" href="structMacTimeout.html#a13d349713ab4eb38a5e14f975f84cf08">callback</a> == cb  &amp;&amp;  t.<a class="code" href="structMacTimeout.html#ad232eaa73f22599f0d0883a90477ba3d">data</a> == data) {
<a name="l02736"></a>02736             SetEventLoopTimerNextFireTime(t.<a class="code" href="structMacTimeout.html#aac4fe2df22f669ea5ba8ddf0ba7d200d">timer</a>, (EventTimerInterval)time);
<a name="l02737"></a>02737             t.<a class="code" href="structMacTimeout.html#aa734ee03fd9d56dcac5b967efe33e7a1">pending</a> = 1;
<a name="l02738"></a>02738             <span class="keywordflow">return</span>;
<a name="l02739"></a>02739         }
<a name="l02740"></a>02740     }
<a name="l02741"></a>02741     <span class="comment">// no existing timer to use. Create a new one:</span>
<a name="l02742"></a>02742     <span class="keywordtype">int</span> timer_id = -1;
<a name="l02743"></a>02743     <span class="comment">// find an empty slot in the timer array</span>
<a name="l02744"></a>02744     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0;  i &lt; mac_timer_used;  ++<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>) {
<a name="l02745"></a>02745         <span class="keywordflow">if</span> ( !mac_timers[i].timer ) {
<a name="l02746"></a>02746             timer_id = <a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>;
<a name="l02747"></a>02747             <span class="keywordflow">break</span>;
<a name="l02748"></a>02748         }
<a name="l02749"></a>02749     }
<a name="l02750"></a>02750     <span class="comment">// if there was no empty slot, append a new timer</span>
<a name="l02751"></a>02751     <span class="keywordflow">if</span> (timer_id == -1) {
<a name="l02752"></a>02752         <span class="comment">// make space if needed</span>
<a name="l02753"></a>02753         <span class="keywordflow">if</span> (mac_timer_used == mac_timer_alloc) {
<a name="l02754"></a>02754             realloc_timers();
<a name="l02755"></a>02755         }
<a name="l02756"></a>02756         timer_id = mac_timer_used++;
<a name="l02757"></a>02757     }
<a name="l02758"></a>02758     <span class="comment">// now install a brand new timer</span>
<a name="l02759"></a>02759     <a class="code" href="structMacTimeout.html">MacTimeout</a>&amp; t = mac_timers[timer_id];
<a name="l02760"></a>02760     EventTimerInterval fireDelay = (EventTimerInterval)time;
<a name="l02761"></a>02761     EventLoopTimerUPP  timerUPP = NewEventLoopTimerUPP(do_timer);
<a name="l02762"></a>02762     EventLoopTimerRef  timerRef = 0;
<a name="l02763"></a>02763     OSStatus err = InstallEventLoopTimer(GetMainEventLoop(), fireDelay, 0, timerUPP, data, &amp;timerRef);
<a name="l02764"></a>02764     <span class="keywordflow">if</span> (err == noErr) {
<a name="l02765"></a>02765         t.<a class="code" href="structMacTimeout.html#a13d349713ab4eb38a5e14f975f84cf08">callback</a> = cb;
<a name="l02766"></a>02766         t.<a class="code" href="structMacTimeout.html#ad232eaa73f22599f0d0883a90477ba3d">data</a>     = <a class="code" href="jpeglib_8h.html#ae5784a8f4db42de0ffacd0cbd08dc6ad">data</a>;
<a name="l02767"></a>02767         t.<a class="code" href="structMacTimeout.html#aac4fe2df22f669ea5ba8ddf0ba7d200d">timer</a>    = timerRef;
<a name="l02768"></a>02768         t.<a class="code" href="structMacTimeout.html#ae92acad4291822ffe6c1a37a7edc572b">upp</a>      = timerUPP;
<a name="l02769"></a>02769         t.<a class="code" href="structMacTimeout.html#aa734ee03fd9d56dcac5b967efe33e7a1">pending</a>  = 1;
<a name="l02770"></a>02770     } <span class="keywordflow">else</span> {
<a name="l02771"></a>02771         <span class="keywordflow">if</span> (timerRef) 
<a name="l02772"></a>02772             RemoveEventLoopTimer(timerRef);
<a name="l02773"></a>02773         <span class="keywordflow">if</span> (timerUPP)
<a name="l02774"></a>02774             DisposeEventLoopTimerUPP(timerUPP);
<a name="l02775"></a>02775     }
<a name="l02776"></a>02776 }
<a name="l02777"></a>02777 
<a name="l02778"></a>02778 <span class="keywordtype">void</span> <a class="code" href="classFl.html#ae5373d1d50c2b0ba38280d78bb6d2628">Fl::repeat_timeout</a>(<span class="keywordtype">double</span> time, <a class="code" href="group__callback__functions.html#gaf00cf21170aa3231f6e869a30a036390">Fl_Timeout_Handler</a> cb, <span class="keywordtype">void</span>* data)
<a name="l02779"></a>02779 {
<a name="l02780"></a>02780     <span class="comment">// currently, repeat_timeout does not subtract the trigger time of the previous timer event as it should.</span>
<a name="l02781"></a>02781     <a class="code" href="classFl.html#a23e63eb7cec3a27fa360e66c6e2b2e52">add_timeout</a>(time, cb, data);
<a name="l02782"></a>02782 }
<a name="l02783"></a>02783 
<a name="l02784"></a>02784 <span class="keywordtype">int</span> <a class="code" href="classFl.html#ae3164768ec950db81396b81ef42f8ba2">Fl::has_timeout</a>(<a class="code" href="group__callback__functions.html#gaf00cf21170aa3231f6e869a30a036390">Fl_Timeout_Handler</a> cb, <span class="keywordtype">void</span>* data)
<a name="l02785"></a>02785 {
<a name="l02786"></a>02786    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0;  i &lt; mac_timer_used;  ++<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>) {
<a name="l02787"></a>02787         <a class="code" href="structMacTimeout.html">MacTimeout</a>&amp; t = mac_timers[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>];
<a name="l02788"></a>02788         <span class="keywordflow">if</span> (t.<a class="code" href="structMacTimeout.html#a13d349713ab4eb38a5e14f975f84cf08">callback</a> == cb  &amp;&amp;  t.<a class="code" href="structMacTimeout.html#ad232eaa73f22599f0d0883a90477ba3d">data</a> == data &amp;&amp; t.<a class="code" href="structMacTimeout.html#aa734ee03fd9d56dcac5b967efe33e7a1">pending</a>) {
<a name="l02789"></a>02789             <span class="keywordflow">return</span> 1;
<a name="l02790"></a>02790         }
<a name="l02791"></a>02791     }
<a name="l02792"></a>02792     <span class="keywordflow">return</span> 0;
<a name="l02793"></a>02793 }
<a name="l02794"></a>02794 
<a name="l02795"></a>02795 <span class="keywordtype">void</span> <a class="code" href="classFl.html#a9a950f0585de6416eb4fee2365a1578f">Fl::remove_timeout</a>(<a class="code" href="group__callback__functions.html#gaf00cf21170aa3231f6e869a30a036390">Fl_Timeout_Handler</a> cb, <span class="keywordtype">void</span>* data)
<a name="l02796"></a>02796 {
<a name="l02797"></a>02797    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0;  i &lt; mac_timer_used;  ++<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>) {
<a name="l02798"></a>02798         <a class="code" href="structMacTimeout.html">MacTimeout</a>&amp; t = mac_timers[<a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>];
<a name="l02799"></a>02799         <span class="keywordflow">if</span> (t.<a class="code" href="structMacTimeout.html#a13d349713ab4eb38a5e14f975f84cf08">callback</a> == cb  &amp;&amp; ( t.<a class="code" href="structMacTimeout.html#ad232eaa73f22599f0d0883a90477ba3d">data</a> == data || data == <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l02800"></a>02800             delete_timer(t);
<a name="l02801"></a>02801         }
<a name="l02802"></a>02802     }
<a name="l02803"></a>02803 }
<a name="l02804"></a>02804 
<a name="l02805"></a><a class="code" href="Fl__mac_8cxx.html#a5893e5080ff0affc6caac28e04989cba">02805</a> <span class="keywordtype">int</span> <a class="code" href="Fl__mac_8cxx.html#a5893e5080ff0affc6caac28e04989cba">MacUnlinkWindow</a>(<a class="code" href="classFl__X.html">Fl_X</a> *ip, <a class="code" href="classFl__X.html">Fl_X</a> *<a class="code" href="png_8h.html#a96c2a358dab02570791a4c9072aecf60">start</a>) {
<a name="l02806"></a>02806   <span class="keywordflow">if</span> (!ip) <span class="keywordflow">return</span> 0;
<a name="l02807"></a>02807   <span class="keywordflow">if</span> (start) {
<a name="l02808"></a>02808     <a class="code" href="classFl__X.html">Fl_X</a> *pc = <a class="code" href="png_8h.html#a96c2a358dab02570791a4c9072aecf60">start</a>;
<a name="l02809"></a>02809     <span class="keywordflow">while</span> (pc) {
<a name="l02810"></a>02810       <span class="keywordflow">if</span> (pc-&gt;xidNext == ip) {
<a name="l02811"></a>02811         pc-&gt;xidNext = ip-&gt;xidNext;
<a name="l02812"></a>02812         <span class="keywordflow">return</span> 1;
<a name="l02813"></a>02813       }
<a name="l02814"></a>02814       <span class="keywordflow">if</span> (pc-&gt;xidChildren) {
<a name="l02815"></a>02815         <span class="keywordflow">if</span> (pc-&gt;xidChildren == ip) {
<a name="l02816"></a>02816           pc-&gt;xidChildren = ip-&gt;xidNext;
<a name="l02817"></a>02817           <span class="keywordflow">return</span> 1;
<a name="l02818"></a>02818         }
<a name="l02819"></a>02819         <span class="keywordflow">if</span> (<a class="code" href="Fl__mac_8cxx.html#a5893e5080ff0affc6caac28e04989cba">MacUnlinkWindow</a>(ip, pc-&gt;xidChildren))
<a name="l02820"></a>02820           <span class="keywordflow">return</span> 1;
<a name="l02821"></a>02821       }
<a name="l02822"></a>02822       pc = pc-&gt;xidNext;
<a name="l02823"></a>02823     }
<a name="l02824"></a>02824   } <span class="keywordflow">else</span> {
<a name="l02825"></a>02825     <span class="keywordflow">for</span> ( <a class="code" href="classFl__X.html">Fl_X</a> *pc = <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a>; pc; pc = pc-&gt;<a class="code" href="classFl__X.html#a41f6a721a953ea62021bb1dd9c4f2187">next</a> ) {
<a name="l02826"></a>02826       <span class="keywordflow">if</span> (<a class="code" href="Fl__mac_8cxx.html#a5893e5080ff0affc6caac28e04989cba">MacUnlinkWindow</a>(ip, pc))
<a name="l02827"></a>02827         <span class="keywordflow">return</span> 1;
<a name="l02828"></a>02828     }
<a name="l02829"></a>02829   }  
<a name="l02830"></a>02830   <span class="keywordflow">return</span> 0;
<a name="l02831"></a>02831 }
<a name="l02832"></a>02832 
<a name="l02833"></a>02833 <span class="keyword">static</span> <span class="keywordtype">void</span> MacRelinkWindow(<a class="code" href="classFl__X.html">Fl_X</a> *x, <a class="code" href="classFl__X.html">Fl_X</a> *p) {
<a name="l02834"></a>02834   <span class="keywordflow">if</span> (!x || !p) <span class="keywordflow">return</span>;
<a name="l02835"></a>02835   <span class="comment">// first, check if &#39;x&#39; is already registered as a child of &#39;p&#39;</span>
<a name="l02836"></a>02836   <span class="keywordflow">for</span> (<a class="code" href="classFl__X.html">Fl_X</a> *i = p-&gt;xidChildren; i; i=i-&gt;xidNext) {
<a name="l02837"></a>02837     <span class="keywordflow">if</span> (i == x) <span class="keywordflow">return</span>;
<a name="l02838"></a>02838   }
<a name="l02839"></a>02839   <span class="comment">// now add &#39;x&#39; as the first child of &#39;p&#39;</span>
<a name="l02840"></a>02840   x-&gt;xidNext = p-&gt;xidChildren;
<a name="l02841"></a>02841   p-&gt;xidChildren = <a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>;
<a name="l02842"></a>02842 }
<a name="l02843"></a>02843 
<a name="l02844"></a><a class="code" href="Fl__mac_8cxx.html#a055780df6708dd77335a55740992d9c9">02844</a> <span class="keywordtype">void</span> <a class="code" href="Fl__mac_8cxx.html#a055780df6708dd77335a55740992d9c9">MacDestroyWindow</a>(<a class="code" href="classFl__Window.html">Fl_Window</a> *w, WindowPtr p) {
<a name="l02845"></a>02845   <a class="code" href="Fl__mac_8cxx.html#a196ea6e907be01db170790c115a770bc">MacUnmapWindow</a>(w, p);
<a name="l02846"></a>02846   <span class="keywordflow">if</span> (w &amp;&amp; !w-&gt;<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>() &amp;&amp; p)
<a name="l02847"></a>02847     DisposeWindow(p);
<a name="l02848"></a>02848 }
<a name="l02849"></a>02849 
<a name="l02850"></a><a class="code" href="Fl__mac_8cxx.html#ad5099ea5f62d0c7cc1a3ab1a576f665f">02850</a> <span class="keywordtype">void</span> <a class="code" href="Fl__mac_8cxx.html#ad5099ea5f62d0c7cc1a3ab1a576f665f">MacMapWindow</a>(<a class="code" href="classFl__Window.html">Fl_Window</a> *w, WindowPtr p) {
<a name="l02851"></a>02851   <span class="keywordflow">if</span> (w &amp;&amp; p)
<a name="l02852"></a>02852     ShowWindow(p);
<a name="l02853"></a>02853   <span class="comment">//+ link to window list</span>
<a name="l02854"></a>02854   <span class="keywordflow">if</span> (w &amp;&amp; w-&gt;<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>()) {
<a name="l02855"></a>02855     MacRelinkWindow(<a class="code" href="classFl__X.html#ae4c6997d92cf8ad3a75a962d7ae77c34">Fl_X::i</a>(w), <a class="code" href="classFl__X.html#ae4c6997d92cf8ad3a75a962d7ae77c34">Fl_X::i</a>(w-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>()));
<a name="l02856"></a>02856     w-&gt;<a class="code" href="classFl__Widget.html#aa63ce68cbf4620cf8750b868368ea02b">redraw</a>();
<a name="l02857"></a>02857   }
<a name="l02858"></a>02858 }
<a name="l02859"></a>02859 
<a name="l02860"></a><a class="code" href="Fl__mac_8cxx.html#a196ea6e907be01db170790c115a770bc">02860</a> <span class="keywordtype">void</span> <a class="code" href="Fl__mac_8cxx.html#a196ea6e907be01db170790c115a770bc">MacUnmapWindow</a>(<a class="code" href="classFl__Window.html">Fl_Window</a> *w, WindowPtr p) {
<a name="l02861"></a>02861   <span class="keywordflow">if</span> (w &amp;&amp; !w-&gt;<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>() &amp;&amp; p) 
<a name="l02862"></a>02862     HideWindow(p);
<a name="l02863"></a>02863   <span class="keywordflow">if</span> (w &amp;&amp; <a class="code" href="classFl__X.html#ae4c6997d92cf8ad3a75a962d7ae77c34">Fl_X::i</a>(w)) 
<a name="l02864"></a>02864     <a class="code" href="Fl__mac_8cxx.html#a5893e5080ff0affc6caac28e04989cba">MacUnlinkWindow</a>(<a class="code" href="classFl__X.html#ae4c6997d92cf8ad3a75a962d7ae77c34">Fl_X::i</a>(w));
<a name="l02865"></a>02865 }
<a name="l02866"></a>02866 <span class="preprocessor">#endif // FL_DOXYGEN</span>
<a name="l02867"></a>02867 <span class="preprocessor"></span>
<a name="l02868"></a>02868 <span class="comment">//</span>
<a name="l02869"></a>02869 <span class="comment">// End of &quot;$Id: Fl_mac.cxx 7913 2010-11-29 18:18:27Z greg.ercolano $&quot;.</span>
<a name="l02870"></a>02870 <span class="comment">//</span>
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="Fl__mac_8cxx.html">Fl_mac.cxx</a>      </li>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="#" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3</small></address>
</body>

<!-- Mirrored from dox.sfr-fresh.com/fltk-1.3.0rc3-source/Fl__mac_8cxx_source.html by HTTrack Website Copier/3.x [XR&CO'2010], Wed, 16 Feb 2011 23:41:41 GMT -->
</html>
