<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<!-- Mirrored from dox.sfr-fresh.com/fltk-1.3.0rc3-source/Fl__cocoa_8mm_source.html by HTTrack Website Copier/3.x [XR&CO'2010], Wed, 16 Feb 2011 23:40:48 GMT -->
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>SfR Fresh Dox - fltk: fltk-1.3.0rc3/src/Fl_cocoa.mm Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">fltk&#160;<span id="projectnumber">1.3.0rc3</span></div>
   <div id="projectbrief">About: <A HREF= http://www.fltk.org/>FLTK</A> (Fast Light Tool Kit) is a cross-platform C++ GUI toolkit for UNIX/Linux (X11), Microsoft Windows, and MacOS X. Release candidate.<BR><IMG SRC="../warix/forest1.gif" ALT="">&nbsp;&nbsp;<A HREF="http://www.sfr-fresh.com/" TITLE="SfR Fresh Home">SfR Fresh</A> <A HREF="http://www.sfr-fresh.com/warix/features.html#doxygen" TITLE="SfR Fresh Doxygen Support Info">Dox</A>: <A HREF="../fresh/unix/misc/fltk-1.3.0rc3-source.tar.gz/index.html" TITLE="SfR Fresh: fltk-1.3.0rc3-source.tar.gz Contents &amp; Download Page">fltk-1.3.0rc3-source.tar.gz</A> ("inofficial" and yet experimental doxygen-generated source code documentation)&nbsp;&nbsp;<IMG SRC="../warix/forest2.gif" ALT=""><P></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index-2.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('Fl__cocoa_8mm.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<h1>Fl_cocoa.mm</h1>  </div>
</div>
<div class="contents">
<a href="Fl__cocoa_8mm.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//</span>
<a name="l00002"></a>00002 <span class="comment">// &quot;$Id: Fl_cocoa.mm 6971 2009-04-13 07:32:01Z matt $&quot;</span>
<a name="l00003"></a>00003 <span class="comment">//</span>
<a name="l00004"></a>00004 <span class="comment">// MacOS-Cocoa specific code for the Fast Light Tool Kit (FLTK).</span>
<a name="l00005"></a>00005 <span class="comment">//</span>
<a name="l00006"></a>00006 <span class="comment">// Copyright 1998-2010 by Bill Spitzak and others.</span>
<a name="l00007"></a>00007 <span class="comment">//</span>
<a name="l00008"></a>00008 <span class="comment">// This library is free software; you can redistribute it and/or</span>
<a name="l00009"></a>00009 <span class="comment">// modify it under the terms of the GNU Library General Public</span>
<a name="l00010"></a>00010 <span class="comment">// License as published by the Free Software Foundation; either</span>
<a name="l00011"></a>00011 <span class="comment">// version 2 of the License, or (at your option) any later version.</span>
<a name="l00012"></a>00012 <span class="comment">//</span>
<a name="l00013"></a>00013 <span class="comment">// This library is distributed in the hope that it will be useful,</span>
<a name="l00014"></a>00014 <span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00015"></a>00015 <span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<a name="l00016"></a>00016 <span class="comment">// Library General Public License for more details.</span>
<a name="l00017"></a>00017 <span class="comment">//</span>
<a name="l00018"></a>00018 <span class="comment">// You should have received a copy of the GNU Library General Public</span>
<a name="l00019"></a>00019 <span class="comment">// License along with this library; if not, write to the Free Software</span>
<a name="l00020"></a>00020 <span class="comment">// Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307</span>
<a name="l00021"></a>00021 <span class="comment">// USA.</span>
<a name="l00022"></a>00022 <span class="comment">//</span>
<a name="l00023"></a>00023 <span class="comment">// Please report all bugs and problems on the following page:</span>
<a name="l00024"></a>00024 <span class="comment">//</span>
<a name="l00025"></a>00025 <span class="comment">//     http://www.fltk.org/str.php</span>
<a name="l00026"></a>00026 <span class="comment">//</span>
<a name="l00027"></a>00027 
<a name="l00029"></a>00029 <span class="comment">// (without permission)</span>
<a name="l00030"></a>00030 <span class="comment">//</span>
<a name="l00031"></a>00031 <span class="comment">// &quot;Three Compiles for 68Ks under the sky,</span>
<a name="l00032"></a>00032 <span class="comment">// Seven Compiles for PPCs in their fragments of code,</span>
<a name="l00033"></a>00033 <span class="comment">// Nine Compiles for Mortal Carbon doomed to die,</span>
<a name="l00034"></a>00034 <span class="comment">// One Compile for Mach-O Cocoa on its Mach-O throne,</span>
<a name="l00035"></a>00035 <span class="comment">// in the Land of MacOS X where the Drop-Shadows lie.</span>
<a name="l00036"></a>00036 <span class="comment">// </span>
<a name="l00037"></a>00037 <span class="comment">// One Compile to link them all, One Compile to merge them,</span>
<a name="l00038"></a>00038 <span class="comment">// One Compile to copy them all and in the bundle bind them,</span>
<a name="l00039"></a>00039 <span class="comment">// in the Land of MacOS X where the Drop-Shadows lie.&quot;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#ifdef __APPLE__</span>
<a name="l00042"></a>00042 <span class="preprocessor"></span>
<a name="l00043"></a>00043 <span class="preprocessor">#define CONSOLIDATE_MOTION 0</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> {
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
<a name="l00046"></a>00046 }
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;FL/Fl.H&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;FL/x.H&gt;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;FL/Fl_Window.H&gt;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &lt;FL/Fl_Tooltip.H&gt;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &lt;FL/Fl_Sys_Menu_Bar.H&gt;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &lt;FL/Fl_Printer.H&gt;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &lt;FL/Fl_Input_.H&gt;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &lt;FL/Fl_Text_Display.H&gt;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="flstring_8h.html">flstring.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &lt;stdarg.h&gt;</span>
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 <span class="preprocessor">#import &lt;Cocoa/Cocoa.h&gt;</span>
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="preprocessor">#ifndef NSINTEGER_DEFINED // appears with 10.5 in NSObjCRuntime.h</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span><span class="preprocessor">#if defined(__LP64__) &amp;&amp; __LP64__</span>
<a name="l00067"></a>00067 <span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keywordtype">long</span> NSInteger;
<a name="l00068"></a>00068 <span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> NSUInteger;
<a name="l00069"></a>00069 <span class="preprocessor">#else</span>
<a name="l00070"></a>00070 <span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keywordtype">long</span> NSInteger;
<a name="l00071"></a>00071 <span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> NSUInteger;
<a name="l00072"></a>00072 <span class="preprocessor">#endif</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00074"></a>00074 <span class="preprocessor"></span>
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="comment">// #define DEBUG_SELECT         // UNCOMMENT FOR SELECT()/THREAD DEBUGGING</span>
<a name="l00077"></a>00077 <span class="preprocessor">#ifdef DEBUG_SELECT</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span><span class="preprocessor">#include &lt;stdio.h&gt;</span>              <span class="comment">// testing</span>
<a name="l00079"></a>00079 <span class="preprocessor">#define DEBUGMSG(msg)           if ( msg ) fprintf(stderr, msg);</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span><span class="preprocessor">#define DEBUGPERRORMSG(msg)     if ( msg ) perror(msg)</span>
<a name="l00081"></a>00081 <span class="preprocessor"></span><span class="preprocessor">#define DEBUGTEXT(txt)          txt</span>
<a name="l00082"></a>00082 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00083"></a>00083 <span class="preprocessor"></span><span class="preprocessor">#define DEBUGMSG(msg)</span>
<a name="l00084"></a>00084 <span class="preprocessor"></span><span class="preprocessor">#define DEBUGPERRORMSG(msg)</span>
<a name="l00085"></a>00085 <span class="preprocessor"></span><span class="preprocessor">#define DEBUGTEXT(txt)          NULL</span>
<a name="l00086"></a>00086 <span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/*DEBUG_SELECT*/</span>
<a name="l00087"></a>00087 
<a name="l00088"></a>00088 <span class="comment">// external functions</span>
<a name="l00089"></a>00089 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="Fl_8cxx.html#afe3a0306383e206c9b1e04accc9a28e7">fl_fix_focus</a>();
<a name="l00090"></a>00090 <span class="keyword">extern</span> <a class="code" href="mac_8H.html#a73ca2fde79c397d91d1147fde9cccc39">Fl_Offscreen</a> fl_create_offscreen_with_alpha(<span class="keywordtype">int</span> <a class="code" href="forms_8H-2.html#aac374e320caaadeca4874add33b62af2">w</a>, <span class="keywordtype">int</span> <a class="code" href="forms_8H-2.html#a7e427ba5b307f9068129699250690066">h</a>);
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 <span class="comment">// forward definition of functions in this file</span>
<a name="l00093"></a>00093 <span class="comment">// converting cr lf converter function</span>
<a name="l00094"></a>00094 <span class="keyword">static</span> <span class="keywordtype">void</span> convert_crlf(<span class="keywordtype">char</span> * <span class="keywordtype">string</span>, <span class="keywordtype">size_t</span> len);
<a name="l00095"></a>00095 <span class="keyword">static</span> <span class="keywordtype">void</span> createAppleMenu(<span class="keywordtype">void</span>);
<a name="l00096"></a>00096 <span class="keyword">static</span> <a class="code" href="mac_8H.html#aa3f54ef9dd28ee61ae42bd36291a31f2">Fl_Region</a> MacRegionMinusRect(<a class="code" href="mac_8H.html#aa3f54ef9dd28ee61ae42bd36291a31f2">Fl_Region</a> r, <span class="keywordtype">int</span> <a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>,<span class="keywordtype">int</span> <a class="code" href="test_8c.html#a0a2f84ed7838f07779ae24c5a9086d33">y</a>,<span class="keywordtype">int</span> <a class="code" href="forms_8H-2.html#aac374e320caaadeca4874add33b62af2">w</a>,<span class="keywordtype">int</span> <a class="code" href="forms_8H-2.html#a7e427ba5b307f9068129699250690066">h</a>);
<a name="l00097"></a>00097 <span class="keyword">static</span> <span class="keywordtype">void</span> cocoaMouseHandler(NSEvent *theEvent);
<a name="l00098"></a>00098 
<a name="l00099"></a>00099 <span class="keyword">static</span> Fl_Quartz_Graphics_Driver fl_quartz_driver;
<a name="l00100"></a>00100 <span class="keyword">static</span> <a class="code" href="classFl__Display__Device.html" title="A display to which the computer can draw.">Fl_Display_Device</a> fl_quartz_display(&amp;fl_quartz_driver);
<a name="l00101"></a>00101 <a class="code" href="Fl__Export_8H.html#aa9ba29a18aee9d738370a06eeb4470fc">FL_EXPORT</a> <a class="code" href="classFl__Display__Device.html" title="A display to which the computer can draw.">Fl_Display_Device</a> *<a class="code" href="Fl__Device_8H.html#a3c86b413353211f1c893a056485440c3" title="Points to the platform&amp;#39;s display.">fl_display_device</a> = (<a class="code" href="classFl__Display__Device.html" title="A display to which the computer can draw.">Fl_Display_Device</a>*)&amp;fl_quartz_display; <span class="comment">// does not change</span>
<a name="l00102"></a>00102 <a class="code" href="Fl__Export_8H.html#aa9ba29a18aee9d738370a06eeb4470fc">FL_EXPORT</a> <a class="code" href="classFl__Graphics__Driver.html" title="A virtual class subclassed for each graphics driver FLTK uses.">Fl_Graphics_Driver</a> *<a class="code" href="Fl__Device_8H.html#a70e4f05429b26bb420c70f64e972f2a5" title="Points to the driver that currently receives all graphics requests.">fl_graphics_driver</a> = (<a class="code" href="classFl__Graphics__Driver.html" title="A virtual class subclassed for each graphics driver FLTK uses.">Fl_Graphics_Driver</a>*)&amp;fl_quartz_driver; <span class="comment">// the current target device of graphics operations</span>
<a name="l00103"></a>00103 <a class="code" href="Fl__Export_8H.html#aa9ba29a18aee9d738370a06eeb4470fc">FL_EXPORT</a> <a class="code" href="classFl__Surface__Device.html" title="A surface that&amp;#39;s susceptible to receive graphical output.">Fl_Surface_Device</a> *<a class="code" href="Fl__Device_8H.html#af47882d62919f7ef0593724741fa5ac9" title="Points to the surface that currently receives all graphics requests.">fl_surface</a> = (<a class="code" href="classFl__Surface__Device.html" title="A surface that&amp;#39;s susceptible to receive graphical output.">Fl_Surface_Device</a>*)<a class="code" href="Fl__Device_8H.html#a3c86b413353211f1c893a056485440c3" title="Points to the platform&amp;#39;s display.">fl_display_device</a>; <span class="comment">// the current target surface of graphics operations</span>
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 <span class="comment">// public variables</span>
<a name="l00106"></a>00106 <span class="keywordtype">int</span> <a class="code" href="x_8H.html#a42a55d8c59138d9f0fa899491c25560c">fl_screen</a>;
<a name="l00107"></a>00107 CGContextRef <a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a> = 0;
<a name="l00108"></a>00108 <span class="keywordtype">void</span> *<a class="code" href="Fl__mac_8cxx.html#aa47c81d9e111e268551357524ebb5e4e">fl_system_menu</a>;                   <span class="comment">// this is really a NSMenu*</span>
<a name="l00109"></a>00109 <a class="code" href="classFl__Menu__Bar.html">Fl_Sys_Menu_Bar</a> *<a class="code" href="mac_8H.html#a280df7c0e317a4b5eb8bbc426f90d1f2">fl_sys_menu_bar</a> = 0;
<a name="l00110"></a>00110 <span class="keywordtype">void</span> *<a class="code" href="win32_8H.html#a5c84f195de614f6aa79fa2f8883b37b6">fl_default_cursor</a>;                <span class="comment">// this is really a NSCursor*</span>
<a name="l00111"></a>00111 <span class="keywordtype">void</span> *<a class="code" href="Fl__mac_8cxx.html#a6e10f30f9e6dd98ed093691fd605a0c2">fl_capture</a> = 0;                   <span class="comment">// (NSWindow*) we need this to compensate for a missing(?) mouse capture</span>
<a name="l00112"></a>00112 <span class="keywordtype">bool</span> <a class="code" href="Fl__arg_8cxx.html#aeed6a7220f140808e50ef846ef0ad3c2">fl_show_iconic</a>;                    <span class="comment">// true if called from iconize() - shows the next created window in collapsed state</span>
<a name="l00113"></a>00113 <span class="comment">//int fl_disable_transient_for;           // secret method of removing TRANSIENT_FOR</span>
<a name="l00114"></a>00114 <a class="code" href="mac_8H.html#aad9fe48cacd960402308a6a7f9f5e584">Window</a> <a class="code" href="win32_8H.html#afdab6664143864c36ba6b51782b32500">fl_window</a>;
<a name="l00115"></a>00115 <a class="code" href="classFl__Window.html">Fl_Window</a> *<a class="code" href="classFl__Window.html#ab9f4f5ec887ad5f4eac561eb02a97402">Fl_Window::current_</a>;
<a name="l00116"></a>00116 <span class="keywordtype">int</span> <a class="code" href="group__group__macosx.html#ga2c7db6b2ea9a6ae37a26bea810d2056c" title="The version number of the running Mac OS X (e.g., 0x1064 for 10.6.4)">fl_mac_os_version</a> = 0;              <span class="comment">// the version number of the running Mac OS X (e.g., 0x1064 for 10.6.4)</span>
<a name="l00117"></a>00117 
<a name="l00118"></a>00118 <span class="comment">// forward declarations of variables in this file</span>
<a name="l00119"></a>00119 <span class="keyword">static</span> <span class="keywordtype">int</span> got_events = 0;
<a name="l00120"></a>00120 <span class="keyword">static</span> <a class="code" href="classFl__Window.html">Fl_Window</a>* resize_from_system;
<a name="l00121"></a>00121 
<a name="l00122"></a>00122 <span class="preprocessor">#if CONSOLIDATE_MOTION</span>
<a name="l00123"></a>00123 <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="classFl__Window.html">Fl_Window</a>* send_motion;
<a name="l00124"></a>00124 <span class="keyword">extern</span> <a class="code" href="classFl__Window.html">Fl_Window</a>* <a class="code" href="Fl_8cxx.html#aa4a35d324647e7c092666054a4e58596">fl_xmousewin</a>;
<a name="l00125"></a>00125 <span class="preprocessor">#endif</span>
<a name="l00126"></a>00126 <span class="preprocessor"></span>
<a name="l00127"></a>00127 <span class="keyword">enum</span> { FLTKTimerEvent = 1, FLTKDataReadyEvent };
<a name="l00128"></a>00128 
<a name="l00129"></a>00129 
<a name="l00130"></a>00130 <span class="comment">/* fltk-utf8 placekeepers */</span>
<a name="l00131"></a>00131 <span class="keywordtype">void</span> <a class="code" href="group__fl__drawings.html#gaa6c8068dbc30f05765330e31f08350d7">fl_reset_spot</a>()
<a name="l00132"></a>00132 {
<a name="l00133"></a>00133 }
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 <span class="keywordtype">void</span> <a class="code" href="group__fl__drawings.html#ga748fcead12c8cc67cb517cab02c273a2">fl_set_spot</a>(<span class="keywordtype">int</span> font, <span class="keywordtype">int</span> <a class="code" href="png_8h.html#a43291b8493b637821dec145c4bb1503d">size</a>, <span class="keywordtype">int</span> X, <span class="keywordtype">int</span> Y, <span class="keywordtype">int</span> W, <span class="keywordtype">int</span> <a class="code" href="Fl__Tooltip_8cxx.html#affa487e8e3cc48473cfc05c0ce0165e9">H</a>, <a class="code" href="classFl__Window.html">Fl_Window</a> *win)
<a name="l00136"></a>00136 {
<a name="l00137"></a>00137 }
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 <span class="keywordtype">void</span> <a class="code" href="group__fl__drawings.html#ga496c7d22ad30fe84717bb765dd6d1fc8">fl_set_status</a>(<span class="keywordtype">int</span> <a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>, <span class="keywordtype">int</span> <a class="code" href="test_8c.html#a0a2f84ed7838f07779ae24c5a9086d33">y</a>, <span class="keywordtype">int</span> <a class="code" href="forms_8H-2.html#aac374e320caaadeca4874add33b62af2">w</a>, <span class="keywordtype">int</span> <a class="code" href="forms_8H-2.html#a7e427ba5b307f9068129699250690066">h</a>)
<a name="l00140"></a>00140 {
<a name="l00141"></a>00141 }
<a name="l00142"></a>00142 
<a name="l00143"></a>00143 <span class="comment">/*</span>
<a name="l00144"></a>00144 <span class="comment"> * Mac keyboard lookup table</span>
<a name="l00145"></a>00145 <span class="comment"> */</span>
<a name="l00146"></a>00146 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> macKeyLookUp[128] =
<a name="l00147"></a>00147 {
<a name="l00148"></a>00148   <span class="charliteral">&#39;a&#39;</span>, <span class="charliteral">&#39;s&#39;</span>, <span class="charliteral">&#39;d&#39;</span>, <span class="charliteral">&#39;f&#39;</span>, <span class="charliteral">&#39;h&#39;</span>, <span class="charliteral">&#39;g&#39;</span>, <span class="charliteral">&#39;z&#39;</span>, <span class="charliteral">&#39;x&#39;</span>,
<a name="l00149"></a>00149   <span class="charliteral">&#39;c&#39;</span>, <span class="charliteral">&#39;v&#39;</span>, <span class="charliteral">&#39;^&#39;</span>, <span class="charliteral">&#39;b&#39;</span>, <span class="charliteral">&#39;q&#39;</span>, <span class="charliteral">&#39;w&#39;</span>, <span class="charliteral">&#39;e&#39;</span>, <span class="charliteral">&#39;r&#39;</span>,
<a name="l00150"></a>00150   
<a name="l00151"></a>00151   <span class="charliteral">&#39;y&#39;</span>, <span class="charliteral">&#39;t&#39;</span>, <span class="charliteral">&#39;1&#39;</span>, <span class="charliteral">&#39;2&#39;</span>, <span class="charliteral">&#39;3&#39;</span>, <span class="charliteral">&#39;4&#39;</span>, <span class="charliteral">&#39;6&#39;</span>, <span class="charliteral">&#39;5&#39;</span>,
<a name="l00152"></a>00152   <span class="charliteral">&#39;=&#39;</span>, <span class="charliteral">&#39;9&#39;</span>, <span class="charliteral">&#39;7&#39;</span>, <span class="charliteral">&#39;-&#39;</span>, <span class="charliteral">&#39;8&#39;</span>, <span class="charliteral">&#39;0&#39;</span>, <span class="charliteral">&#39;]&#39;</span>, <span class="charliteral">&#39;o&#39;</span>,
<a name="l00153"></a>00153   
<a name="l00154"></a>00154   <span class="charliteral">&#39;u&#39;</span>, <span class="charliteral">&#39;[&#39;</span>, <span class="charliteral">&#39;i&#39;</span>, <span class="charliteral">&#39;p&#39;</span>, <a class="code" href="Enumerations_8H.html#ab4a527fe4d93303976de2fbfec05e19b" title="The enter key.">FL_Enter</a>, <span class="charliteral">&#39;l&#39;</span>, <span class="charliteral">&#39;j&#39;</span>, <span class="charliteral">&#39;\&#39;&#39;</span>,
<a name="l00155"></a>00155   <span class="charliteral">&#39;k&#39;</span>, <span class="charliteral">&#39;;&#39;</span>, <span class="charliteral">&#39;\\&#39;</span>, <span class="charliteral">&#39;,&#39;</span>, <span class="charliteral">&#39;/&#39;</span>, <span class="charliteral">&#39;n&#39;</span>, <span class="charliteral">&#39;m&#39;</span>, <span class="charliteral">&#39;.&#39;</span>,
<a name="l00156"></a>00156   
<a name="l00157"></a>00157   <a class="code" href="Enumerations_8H.html#aa6e3e7f377cecb30c77f112ce54c3753" title="The tab key.">FL_Tab</a>, <span class="charliteral">&#39; &#39;</span>, <span class="charliteral">&#39;`&#39;</span>, <a class="code" href="Enumerations_8H.html#a20dc86e7758a88b4d1f06323e2de9896" title="The backspace key.">FL_BackSpace</a>, 
<a name="l00158"></a>00158   <a class="code" href="Enumerations_8H.html#af6ac160165f8c2747488175321f45a63" title="The enter key on the keypad, same as Fl_KP+&amp;#39;\r&amp;#39;.">FL_KP_Enter</a>, <a class="code" href="Enumerations_8H.html#a91b983ebe4cd86393e2addb8ab40a326" title="The escape key.">FL_Escape</a>, 0, 0<span class="comment">/*FL_Meta_L*/</span>,
<a name="l00159"></a>00159   0<span class="comment">/*FL_Shift_L*/</span>, 0<span class="comment">/*FL_Caps_Lock*/</span>, 0<span class="comment">/*FL_Alt_L*/</span>, 0<span class="comment">/*FL_Control_L*/</span>, 
<a name="l00160"></a>00160   0<span class="comment">/*FL_Shift_R*/</span>, 0<span class="comment">/*FL_Alt_R*/</span>, 0<span class="comment">/*FL_Control_R*/</span>, 0,
<a name="l00161"></a>00161   
<a name="l00162"></a>00162   0, <a class="code" href="Enumerations_8H.html#a61cc4275772d96a740bef9261cca5760" title="One of the keypad numbers; use FL_KP + n for number n.">FL_KP</a>+&#39;.&#39;, <a class="code" href="Enumerations_8H.html#a45679ed656e6b248319719719e894f13" title="The right arrow key.">FL_Right</a>, <a class="code" href="Enumerations_8H.html#a61cc4275772d96a740bef9261cca5760" title="One of the keypad numbers; use FL_KP + n for number n.">FL_KP</a>+&#39;*&#39;, 0, <a class="code" href="Enumerations_8H.html#a61cc4275772d96a740bef9261cca5760" title="One of the keypad numbers; use FL_KP + n for number n.">FL_KP</a>+&#39;+&#39;, <a class="code" href="Enumerations_8H.html#afe89caa1c5019809095a6129156f7c5a" title="The left arrow key.">FL_Left</a>, <a class="code" href="Enumerations_8H.html#acf1721eb766274a915bed57acf0e7636" title="The num lock key.">FL_Num_Lock</a>,
<a name="l00163"></a>00163   <a class="code" href="Enumerations_8H.html#a7b70dabd5fc84d90552442584a0e8b91" title="The down arrow key.">FL_Down</a>, 0, 0, <a class="code" href="Enumerations_8H.html#a61cc4275772d96a740bef9261cca5760" title="One of the keypad numbers; use FL_KP + n for number n.">FL_KP</a>+&#39;/&#39;, FL_KP_Enter, <a class="code" href="Enumerations_8H.html#a050700391ba0940ca16b0e5dbf4644f0" title="The up arrow key.">FL_Up</a>, <a class="code" href="Enumerations_8H.html#a61cc4275772d96a740bef9261cca5760" title="One of the keypad numbers; use FL_KP + n for number n.">FL_KP</a>+&#39;-&#39;, 0,
<a name="l00164"></a>00164   
<a name="l00165"></a>00165   0, <a class="code" href="Enumerations_8H.html#a61cc4275772d96a740bef9261cca5760" title="One of the keypad numbers; use FL_KP + n for number n.">FL_KP</a>+&#39;=&#39;, <a class="code" href="Enumerations_8H.html#a61cc4275772d96a740bef9261cca5760" title="One of the keypad numbers; use FL_KP + n for number n.">FL_KP</a>+&#39;0&#39;, <a class="code" href="Enumerations_8H.html#a61cc4275772d96a740bef9261cca5760" title="One of the keypad numbers; use FL_KP + n for number n.">FL_KP</a>+&#39;1&#39;, <a class="code" href="Enumerations_8H.html#a61cc4275772d96a740bef9261cca5760" title="One of the keypad numbers; use FL_KP + n for number n.">FL_KP</a>+&#39;2&#39;, <a class="code" href="Enumerations_8H.html#a61cc4275772d96a740bef9261cca5760" title="One of the keypad numbers; use FL_KP + n for number n.">FL_KP</a>+&#39;3&#39;, <a class="code" href="Enumerations_8H.html#a61cc4275772d96a740bef9261cca5760" title="One of the keypad numbers; use FL_KP + n for number n.">FL_KP</a>+&#39;4&#39;, <a class="code" href="Enumerations_8H.html#a61cc4275772d96a740bef9261cca5760" title="One of the keypad numbers; use FL_KP + n for number n.">FL_KP</a>+&#39;5&#39;,
<a name="l00166"></a>00166   <a class="code" href="Enumerations_8H.html#a61cc4275772d96a740bef9261cca5760" title="One of the keypad numbers; use FL_KP + n for number n.">FL_KP</a>+&#39;6&#39;, <a class="code" href="Enumerations_8H.html#a61cc4275772d96a740bef9261cca5760" title="One of the keypad numbers; use FL_KP + n for number n.">FL_KP</a>+&#39;7&#39;, 0, <a class="code" href="Enumerations_8H.html#a61cc4275772d96a740bef9261cca5760" title="One of the keypad numbers; use FL_KP + n for number n.">FL_KP</a>+&#39;8&#39;, <a class="code" href="Enumerations_8H.html#a61cc4275772d96a740bef9261cca5760" title="One of the keypad numbers; use FL_KP + n for number n.">FL_KP</a>+&#39;9&#39;, 0, 0, 0,
<a name="l00167"></a>00167   
<a name="l00168"></a>00168   <a class="code" href="Enumerations_8H.html#ae793aa65307884c2ad99893508d844f2" title="One of the function keys; use FL_F + n for function key n.">FL_F</a>+5, <a class="code" href="Enumerations_8H.html#ae793aa65307884c2ad99893508d844f2" title="One of the function keys; use FL_F + n for function key n.">FL_F</a>+6, <a class="code" href="Enumerations_8H.html#ae793aa65307884c2ad99893508d844f2" title="One of the function keys; use FL_F + n for function key n.">FL_F</a>+7, <a class="code" href="Enumerations_8H.html#ae793aa65307884c2ad99893508d844f2" title="One of the function keys; use FL_F + n for function key n.">FL_F</a>+3, <a class="code" href="Enumerations_8H.html#ae793aa65307884c2ad99893508d844f2" title="One of the function keys; use FL_F + n for function key n.">FL_F</a>+8, <a class="code" href="Enumerations_8H.html#ae793aa65307884c2ad99893508d844f2" title="One of the function keys; use FL_F + n for function key n.">FL_F</a>+9, 0, <a class="code" href="Enumerations_8H.html#ae793aa65307884c2ad99893508d844f2" title="One of the function keys; use FL_F + n for function key n.">FL_F</a>+11,
<a name="l00169"></a>00169   0, 0<span class="comment">/*FL_F+13*/</span>, <a class="code" href="Enumerations_8H.html#a4b01dd00e8057590d3778a41920cf80f" title="The print (or print-screen) key.">FL_Print</a>, <a class="code" href="Enumerations_8H.html#a75315b814f32abe29e7b8d0c43be54d9" title="The scroll lock key.">FL_Scroll_Lock</a>, 0, <a class="code" href="Enumerations_8H.html#ae793aa65307884c2ad99893508d844f2" title="One of the function keys; use FL_F + n for function key n.">FL_F</a>+10, <a class="code" href="Enumerations_8H.html#a3a59855ebd5a902cda138956b5ac80bb" title="The menu key.">FL_Menu</a>, <a class="code" href="Enumerations_8H.html#ae793aa65307884c2ad99893508d844f2" title="One of the function keys; use FL_F + n for function key n.">FL_F</a>+12,
<a name="l00170"></a>00170   
<a name="l00171"></a>00171   0, <a class="code" href="Enumerations_8H.html#a701e11753a0c38777cb49989de8f0195" title="The pause key.">FL_Pause</a>, <a class="code" href="Enumerations_8H.html#aea65b2b57d3d83d1359df6fc538ff0a9" title="The &amp;#39;help&amp;#39; key on Mac keyboards.">FL_Help</a>, <a class="code" href="Enumerations_8H.html#a6fecadc9ecc21f06822c79ced2e45932" title="The home key.">FL_Home</a>, <a class="code" href="Enumerations_8H.html#a35834a5c204afffb06374e25734b5c76" title="The page-up key.">FL_Page_Up</a>, <a class="code" href="Enumerations_8H.html#a323fcf5bab321ec05826a6510a0f1d5a" title="The delete key.">FL_Delete</a>, <a class="code" href="Enumerations_8H.html#ae793aa65307884c2ad99893508d844f2" title="One of the function keys; use FL_F + n for function key n.">FL_F</a>+4, <a class="code" href="Enumerations_8H.html#a3278d6209799b821e07369aa5dc140ac" title="The end key.">FL_End</a>,
<a name="l00172"></a>00172   <a class="code" href="Enumerations_8H.html#ae793aa65307884c2ad99893508d844f2" title="One of the function keys; use FL_F + n for function key n.">FL_F</a>+2, <a class="code" href="Enumerations_8H.html#ada4d587d21ab710f44043dafba88e110" title="The page-down key.">FL_Page_Down</a>, <a class="code" href="Enumerations_8H.html#ae793aa65307884c2ad99893508d844f2" title="One of the function keys; use FL_F + n for function key n.">FL_F</a>+1, <a class="code" href="Enumerations_8H.html#afe89caa1c5019809095a6129156f7c5a" title="The left arrow key.">FL_Left</a>, <a class="code" href="Enumerations_8H.html#a45679ed656e6b248319719719e894f13" title="The right arrow key.">FL_Right</a>, <a class="code" href="Enumerations_8H.html#a7b70dabd5fc84d90552442584a0e8b91" title="The down arrow key.">FL_Down</a>, <a class="code" href="Enumerations_8H.html#a050700391ba0940ca16b0e5dbf4644f0" title="The up arrow key.">FL_Up</a>, 0<span class="comment">/*FL_Power*/</span>,
<a name="l00173"></a>00173 };
<a name="l00174"></a>00174 
<a name="l00175"></a>00175 <span class="comment">/*</span>
<a name="l00176"></a>00176 <span class="comment"> * convert the current mouse chord into the FLTK modifier state</span>
<a name="l00177"></a>00177 <span class="comment"> */</span>
<a name="l00178"></a>00178 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> mods_to_e_state( NSUInteger mods )
<a name="l00179"></a>00179 {
<a name="l00180"></a>00180   <span class="keywordtype">long</span> <a class="code" href="Fl__Text__Editor_8cxx.html#a89f234133d3efe315836311cbf21c64b">state</a> = 0;
<a name="l00181"></a>00181   <span class="keywordflow">if</span> ( mods &amp; NSNumericPadKeyMask ) state |= <a class="code" href="Enumerations_8H.html#af4708895fdb16d3982408fee68ba502b" title="The num lock is on.">FL_NUM_LOCK</a>;
<a name="l00182"></a>00182   <span class="keywordflow">if</span> ( mods &amp; NSCommandKeyMask ) state |= <a class="code" href="Enumerations_8H.html#a2c50b1b00111f992d5d49f07c9cee22a" title="One of the meta/Windows keys is down.">FL_META</a>;
<a name="l00183"></a>00183   <span class="keywordflow">if</span> ( mods &amp; NSAlternateKeyMask ) state |= <a class="code" href="Enumerations_8H.html#a58b1ac5446b292c77043f99558eb07cb" title="One of the alt keys is down.">FL_ALT</a>;
<a name="l00184"></a>00184   <span class="keywordflow">if</span> ( mods &amp; NSControlKeyMask ) state |= <a class="code" href="Enumerations_8H.html#a29324ec5ac8c1d87950127d387dc83e8" title="One of the ctrl keys is down.">FL_CTRL</a>;
<a name="l00185"></a>00185   <span class="keywordflow">if</span> ( mods &amp; NSShiftKeyMask ) state |= <a class="code" href="Enumerations_8H.html#aa0d93ca1bc8a0c7f84888cdf458f043d" title="One of the shift keys is down.">FL_SHIFT</a>;
<a name="l00186"></a>00186   <span class="keywordflow">if</span> ( mods &amp; NSAlphaShiftKeyMask ) state |= <a class="code" href="Enumerations_8H.html#add5e55eea768b7bbc0cd25a2455811f0" title="The caps lock is on.">FL_CAPS_LOCK</a>;
<a name="l00187"></a>00187   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ret = ( <a class="code" href="classFl.html#a2d93787aec60cb62a759b36267dd9d06">Fl::e_state</a> &amp; 0xff000000 ) | state;
<a name="l00188"></a>00188   <a class="code" href="classFl.html#a2d93787aec60cb62a759b36267dd9d06">Fl::e_state</a> = ret;
<a name="l00189"></a>00189   <span class="comment">//printf( &quot;State 0x%08x (%04x)\n&quot;, Fl::e_state, mods );</span>
<a name="l00190"></a>00190   <span class="keywordflow">return</span> ret;
<a name="l00191"></a>00191 }
<a name="l00192"></a>00192 
<a name="l00193"></a>00193 
<a name="l00194"></a>00194 <span class="comment">/*</span>
<a name="l00195"></a>00195 <span class="comment"> * convert the current key chord into the FLTK keysym</span>
<a name="l00196"></a>00196 <span class="comment"> */</span>
<a name="l00197"></a>00197 
<a name="l00198"></a>00198  <span class="keyword">static</span> <span class="keywordtype">void</span> mods_to_e_keysym( NSUInteger mods )
<a name="l00199"></a>00199  {
<a name="l00200"></a>00200  <span class="keywordflow">if</span> ( mods &amp; NSCommandKeyMask ) <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> = <a class="code" href="Enumerations_8H.html#acbd392478a5e61f341fe44e24890e213" title="The left meta/Windows key.">FL_Meta_L</a>;
<a name="l00201"></a>00201  <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( mods &amp; NSNumericPadKeyMask ) <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> = <a class="code" href="Enumerations_8H.html#acf1721eb766274a915bed57acf0e7636" title="The num lock key.">FL_Num_Lock</a>;
<a name="l00202"></a>00202  <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( mods &amp; NSAlternateKeyMask ) <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> = <a class="code" href="Enumerations_8H.html#a94997ca62280cddce9327c32a256b61a" title="The left alt key.">FL_Alt_L</a>;
<a name="l00203"></a>00203  <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( mods &amp; NSControlKeyMask ) <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> = <a class="code" href="Enumerations_8H.html#adefca9b73c422d3dadf3fa555d1fb913" title="The lefthand control key.">FL_Control_L</a>;
<a name="l00204"></a>00204  <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( mods &amp; NSShiftKeyMask ) <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> = <a class="code" href="Enumerations_8H.html#ab81acb8d22583da65645c45cb2da1bed" title="The lefthand shift key.">FL_Shift_L</a>;
<a name="l00205"></a>00205  <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( mods &amp; NSAlphaShiftKeyMask ) <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> = <a class="code" href="Enumerations_8H.html#a55c0fc2c4fdd81b243e9036b536484e3" title="The caps lock key.">FL_Caps_Lock</a>;
<a name="l00206"></a>00206  <span class="keywordflow">else</span> <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> = 0;
<a name="l00207"></a>00207  <span class="comment">//printf( &quot;to sym 0x%08x (%04x)\n&quot;, Fl::e_keysym, mods );</span>
<a name="l00208"></a>00208  }
<a name="l00209"></a>00209 
<a name="l00210"></a>00210 <span class="comment">// these pointers are set by the Fl::lock() function:</span>
<a name="l00211"></a>00211 <span class="keyword">static</span> <span class="keywordtype">void</span> nothing() {}
<a name="l00212"></a>00212 <a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a> (*<a class="code" href="Fl__mac_8cxx.html#a7c231659c1d4f9ad9126b83cfbcbfb53">fl_lock_function</a>)() = nothing;
<a name="l00213"></a>00213 <a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a> (*<a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>)() = nothing;
<a name="l00214"></a>00214 
<a name="l00215"></a>00215 <span class="comment">//</span>
<a name="l00216"></a>00216 <span class="comment">// Select interface -- how it&#39;s implemented:</span>
<a name="l00217"></a>00217 <span class="comment">//     When the user app configures one or more file descriptors to monitor</span>
<a name="l00218"></a>00218 <span class="comment">//     with Fl::add_fd(), we start a separate thread to select() the  data,</span>
<a name="l00219"></a>00219 <span class="comment">//     sending a custom OSX &#39;FLTK data ready event&#39; to the parent  thread&#39;s</span>
<a name="l00220"></a>00220 <span class="comment">//     RunApplicationLoop(), so that it triggers the data  ready  callbacks</span>
<a name="l00221"></a>00221 <span class="comment">//     in the parent thread.                               -erco 04/04/04</span>
<a name="l00222"></a>00222 <span class="comment">//     </span>
<a name="l00223"></a>00223 <span class="preprocessor">#define POLLIN  1</span>
<a name="l00224"></a>00224 <span class="preprocessor"></span><span class="preprocessor">#define POLLOUT 4</span>
<a name="l00225"></a>00225 <span class="preprocessor"></span><span class="preprocessor">#define POLLERR 8</span>
<a name="l00226"></a>00226 <span class="preprocessor"></span>
<a name="l00227"></a>00227 <span class="comment">// Class to handle select() &#39;data ready&#39;</span>
<a name="l00228"></a>00228 <span class="keyword">class </span><a class="code" href="classDataReady.html">DataReady</a>
<a name="l00229"></a>00229 {
<a name="l00230"></a>00230   <span class="keyword">struct </span>FD
<a name="l00231"></a>00231   {
<a name="l00232"></a>00232     <span class="keywordtype">int</span> fd;
<a name="l00233"></a>00233     <span class="keywordtype">short</span> events;
<a name="l00234"></a>00234     <a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a> (*cb)(<a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>, <span class="keywordtype">void</span>*);
<a name="l00235"></a>00235     <span class="keywordtype">void</span>* arg;
<a name="l00236"></a>00236   };
<a name="l00237"></a>00237   <span class="keywordtype">int</span> nfds, fd_array_size;
<a name="l00238"></a>00238   FD *fds;
<a name="l00239"></a>00239   pthread_t tid;                <span class="comment">// select()&#39;s thread id</span>
<a name="l00240"></a>00240   
<a name="l00241"></a>00241   <span class="comment">// Data that needs to be locked (all start with &#39;_&#39;)</span>
<a name="l00242"></a>00242   pthread_mutex_t _datalock;    <span class="comment">// data lock</span>
<a name="l00243"></a>00243   fd_set _fdsets[3];            <span class="comment">// r/w/x sets user wants to monitor</span>
<a name="l00244"></a>00244   <span class="keywordtype">int</span> _maxfd;                   <span class="comment">// max fd count to monitor</span>
<a name="l00245"></a>00245   <span class="keywordtype">int</span> _cancelpipe[2];           <span class="comment">// pipe used to help cancel thread</span>
<a name="l00246"></a>00246   
<a name="l00247"></a>00247 <span class="keyword">public</span>:
<a name="l00248"></a>00248   <a class="code" href="classDataReady.html">DataReady</a>()
<a name="l00249"></a>00249   {
<a name="l00250"></a>00250     nfds = 0;
<a name="l00251"></a>00251     fd_array_size = 0;
<a name="l00252"></a>00252     fds = 0;
<a name="l00253"></a>00253     tid = 0;
<a name="l00254"></a>00254     
<a name="l00255"></a>00255     pthread_mutex_init(&amp;_datalock, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00256"></a>00256     FD_ZERO(&amp;_fdsets[0]); FD_ZERO(&amp;_fdsets[1]); FD_ZERO(&amp;_fdsets[2]);
<a name="l00257"></a>00257     _cancelpipe[0] = _cancelpipe[1] = 0;
<a name="l00258"></a>00258     _maxfd = 0;
<a name="l00259"></a>00259   }
<a name="l00260"></a>00260   
<a name="l00261"></a>00261   ~<a class="code" href="classDataReady.html">DataReady</a>()
<a name="l00262"></a>00262   {
<a name="l00263"></a>00263     CancelThread(<a class="code" href="Fl__mac_8cxx.html#a52ec816ebb31da9a8f9adf9ea690afcd">DEBUGTEXT</a>(<span class="stringliteral">&quot;DESTRUCTOR\n&quot;</span>));
<a name="l00264"></a>00264     <span class="keywordflow">if</span> (fds) { free(fds); fds = 0; }
<a name="l00265"></a>00265     nfds = 0;
<a name="l00266"></a>00266   }
<a name="l00267"></a>00267   
<a name="l00268"></a>00268   <span class="comment">// Locks</span>
<a name="l00269"></a>00269   <span class="comment">//    The convention for locks: volatile vars start with &#39;_&#39;,</span>
<a name="l00270"></a>00270   <span class="comment">//    and must be locked before use. Locked code is prefixed </span>
<a name="l00271"></a>00271   <span class="comment">//    with /*LOCK*/ to make painfully obvious esp. in debuggers. -erco</span>
<a name="l00272"></a>00272   <span class="comment">//</span>
<a name="l00273"></a>00273   <span class="keywordtype">void</span> DataLock() { pthread_mutex_lock(&amp;_datalock); }
<a name="l00274"></a>00274   <span class="keywordtype">void</span> DataUnlock() { pthread_mutex_unlock(&amp;_datalock); }
<a name="l00275"></a>00275   
<a name="l00276"></a>00276   <span class="comment">// Accessors</span>
<a name="l00277"></a>00277   <span class="keywordtype">int</span> IsThreadRunning() { <span class="keywordflow">return</span>(tid ? 1 : 0); }
<a name="l00278"></a>00278   <span class="keywordtype">int</span> GetNfds() { <span class="keywordflow">return</span>(nfds); }
<a name="l00279"></a>00279   <span class="keywordtype">int</span> GetCancelPipe(<span class="keywordtype">int</span> ix) { <span class="keywordflow">return</span>(_cancelpipe[ix]); }
<a name="l00280"></a>00280   fd_set GetFdset(<span class="keywordtype">int</span> ix) { <span class="keywordflow">return</span>(_fdsets[ix]); }
<a name="l00281"></a>00281   
<a name="l00282"></a>00282   <span class="comment">// Methods</span>
<a name="l00283"></a>00283   <span class="keywordtype">void</span> AddFD(<span class="keywordtype">int</span> n, <span class="keywordtype">int</span> events, <span class="keywordtype">void</span> (*cb)(<span class="keywordtype">int</span>, <span class="keywordtype">void</span>*), <span class="keywordtype">void</span> *v);
<a name="l00284"></a>00284   <span class="keywordtype">void</span> RemoveFD(<span class="keywordtype">int</span> n, <span class="keywordtype">int</span> events);
<a name="l00285"></a>00285   <span class="keywordtype">int</span> CheckData(fd_set&amp; r, fd_set&amp; <a class="code" href="forms_8H-2.html#aac374e320caaadeca4874add33b62af2">w</a>, fd_set&amp; <a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>);
<a name="l00286"></a>00286   <span class="keywordtype">void</span> HandleData(fd_set&amp; r, fd_set&amp; <a class="code" href="forms_8H-2.html#aac374e320caaadeca4874add33b62af2">w</a>, fd_set&amp; <a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>);
<a name="l00287"></a>00287   <span class="keyword">static</span> <span class="keywordtype">void</span>* DataReadyThread(<span class="keywordtype">void</span> *<span class="keyword">self</span>);
<a name="l00288"></a>00288   <span class="keywordtype">void</span> StartThread(<span class="keywordtype">void</span>);
<a name="l00289"></a>00289   <span class="keywordtype">void</span> CancelThread(<span class="keyword">const</span> <span class="keywordtype">char</span> *reason);
<a name="l00290"></a>00290 };
<a name="l00291"></a>00291 
<a name="l00292"></a>00292 <span class="keyword">static</span> <a class="code" href="classDataReady.html">DataReady</a> dataready;
<a name="l00293"></a>00293 
<a name="l00294"></a>00294 <span class="keywordtype">void</span> <a class="code" href="classDataReady.html#af1e989d67da7cfe6e3743c02600b89a2">DataReady::AddFD</a>(<span class="keywordtype">int</span> n, <span class="keywordtype">int</span> events, <span class="keywordtype">void</span> (*cb)(<span class="keywordtype">int</span>, <span class="keywordtype">void</span>*), <span class="keywordtype">void</span> *v)
<a name="l00295"></a>00295 {
<a name="l00296"></a>00296   <a class="code" href="classDataReady.html#ad61c16682116ac3a0ffab43d725d8278">RemoveFD</a>(n, events);
<a name="l00297"></a>00297   <span class="keywordtype">int</span> <a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a> = nfds++;
<a name="l00298"></a>00298   <span class="keywordflow">if</span> (i &gt;= fd_array_size) 
<a name="l00299"></a>00299   {
<a name="l00300"></a>00300     FD *temp;
<a name="l00301"></a>00301     fd_array_size = 2*fd_array_size+1;
<a name="l00302"></a>00302     <span class="keywordflow">if</span> (!fds) { temp = (FD*)malloc(fd_array_size*<span class="keyword">sizeof</span>(FD)); }
<a name="l00303"></a>00303     <span class="keywordflow">else</span> { temp = (FD*)realloc(fds, fd_array_size*<span class="keyword">sizeof</span>(FD)); }
<a name="l00304"></a>00304     <span class="keywordflow">if</span> (!temp) <span class="keywordflow">return</span>;
<a name="l00305"></a>00305     fds = temp;
<a name="l00306"></a>00306   }
<a name="l00307"></a>00307   fds[i].cb  = cb;
<a name="l00308"></a>00308   fds[i].arg = v;
<a name="l00309"></a>00309   fds[i].fd  = n;
<a name="l00310"></a>00310   fds[i].events = events;
<a name="l00311"></a>00311   <a class="code" href="classDataReady.html#a82aacc293387f4990ce1015ec063d9a7">DataLock</a>();
<a name="l00312"></a>00312   <span class="comment">/*LOCK*/</span>  <span class="keywordflow">if</span> (events &amp; <a class="code" href="Fl__mac_8cxx.html#a52ac479a805051f59643588b096024ff">POLLIN</a>)  FD_SET(n, &amp;_fdsets[0]);
<a name="l00313"></a>00313   <span class="comment">/*LOCK*/</span>  <span class="keywordflow">if</span> (events &amp; <a class="code" href="Fl__mac_8cxx.html#a91b3c67129ac7675062f316b840a0d58">POLLOUT</a>) FD_SET(n, &amp;_fdsets[1]);
<a name="l00314"></a>00314   <span class="comment">/*LOCK*/</span>  <span class="keywordflow">if</span> (events &amp; <a class="code" href="Fl__mac_8cxx.html#ab1c532446408c98559d4aaaeeeb99820">POLLERR</a>) FD_SET(n, &amp;_fdsets[2]);
<a name="l00315"></a>00315   <span class="comment">/*LOCK*/</span>  <span class="keywordflow">if</span> (n &gt; _maxfd) _maxfd = n;
<a name="l00316"></a>00316   <a class="code" href="classDataReady.html#aad0aa979174e3433a217de63acbe55b8">DataUnlock</a>();
<a name="l00317"></a>00317 }
<a name="l00318"></a>00318 
<a name="l00319"></a>00319 <span class="comment">// Remove an FD from the array</span>
<a name="l00320"></a>00320 <span class="keywordtype">void</span> <a class="code" href="classDataReady.html#ad61c16682116ac3a0ffab43d725d8278">DataReady::RemoveFD</a>(<span class="keywordtype">int</span> n, <span class="keywordtype">int</span> events)
<a name="l00321"></a>00321 {
<a name="l00322"></a>00322   <span class="keywordtype">int</span> <a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>,j;
<a name="l00323"></a>00323   <span class="keywordflow">for</span> (i=j=0; i&lt;nfds; i++) {
<a name="l00324"></a>00324     <span class="keywordflow">if</span> (fds[i].fd == n) {
<a name="l00325"></a>00325       <span class="keywordtype">int</span> e = fds[i].events &amp; ~events;
<a name="l00326"></a>00326       <span class="keywordflow">if</span> (!e) <span class="keywordflow">continue</span>; <span class="comment">// if no events left, delete this fd</span>
<a name="l00327"></a>00327       fds[i].events = e;
<a name="l00328"></a>00328     }
<a name="l00329"></a>00329     <span class="comment">// move it down in the array if necessary:</span>
<a name="l00330"></a>00330     <span class="keywordflow">if</span> (j&lt;i) {
<a name="l00331"></a>00331       fds[j] = fds[i];
<a name="l00332"></a>00332     }
<a name="l00333"></a>00333     j++;
<a name="l00334"></a>00334   }
<a name="l00335"></a>00335   nfds = j;
<a name="l00336"></a>00336   <a class="code" href="classDataReady.html#a82aacc293387f4990ce1015ec063d9a7">DataLock</a>();
<a name="l00337"></a>00337   <span class="comment">/*LOCK*/</span>  <span class="keywordflow">if</span> (events &amp; POLLIN)  FD_CLR(n, &amp;_fdsets[0]);
<a name="l00338"></a>00338   <span class="comment">/*LOCK*/</span>  <span class="keywordflow">if</span> (events &amp; POLLOUT) FD_CLR(n, &amp;_fdsets[1]);
<a name="l00339"></a>00339   <span class="comment">/*LOCK*/</span>  <span class="keywordflow">if</span> (events &amp; POLLERR) FD_CLR(n, &amp;_fdsets[2]);
<a name="l00340"></a>00340   <span class="comment">/*LOCK*/</span>  <span class="keywordflow">if</span> (n == _maxfd) _maxfd--;
<a name="l00341"></a>00341   <a class="code" href="classDataReady.html#aad0aa979174e3433a217de63acbe55b8">DataUnlock</a>();
<a name="l00342"></a>00342 }
<a name="l00343"></a>00343 
<a name="l00344"></a>00344 <span class="comment">// CHECK IF USER DATA READY, RETURNS r/w/x INDICATING WHICH IF ANY</span>
<a name="l00345"></a>00345 <span class="keywordtype">int</span> <a class="code" href="classDataReady.html#ad2fb69a0073537ccd0ae4c60db6944b2">DataReady::CheckData</a>(fd_set&amp; r, fd_set&amp; <a class="code" href="forms_8H-2.html#aac374e320caaadeca4874add33b62af2">w</a>, fd_set&amp; <a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>)
<a name="l00346"></a>00346 {
<a name="l00347"></a>00347   <span class="keywordtype">int</span> ret;
<a name="l00348"></a>00348   <a class="code" href="classDataReady.html#a82aacc293387f4990ce1015ec063d9a7">DataLock</a>();
<a name="l00349"></a>00349   <span class="comment">/*LOCK*/</span>  timeval t = { 0, 1 };               <span class="comment">// quick check</span>
<a name="l00350"></a>00350   <span class="comment">/*LOCK*/</span>  r = _fdsets[0], w = _fdsets[1], x = _fdsets[2];
<a name="l00351"></a>00351   <span class="comment">/*LOCK*/</span>  ret =<a class="code" href="factory_8cxx.html#a55a2870f3bd5e6ef9331bb7040a212c8"> ::select</a>(_maxfd+1, &amp;r, &amp;w, &amp;x, &amp;t);
<a name="l00352"></a>00352   <a class="code" href="classDataReady.html#aad0aa979174e3433a217de63acbe55b8">DataUnlock</a>();
<a name="l00353"></a>00353   <span class="keywordflow">if</span> ( ret == -1 ) {
<a name="l00354"></a>00354     <a class="code" href="Fl__mac_8cxx.html#a25f5d39fe70418b682112dac0ded04bd">DEBUGPERRORMSG</a>(<span class="stringliteral">&quot;CheckData(): select()&quot;</span>);
<a name="l00355"></a>00355   }
<a name="l00356"></a>00356   <span class="keywordflow">return</span>(ret);
<a name="l00357"></a>00357 }
<a name="l00358"></a>00358 
<a name="l00359"></a>00359 <span class="comment">// HANDLE DATA READY CALLBACKS</span>
<a name="l00360"></a>00360 <span class="keywordtype">void</span> <a class="code" href="classDataReady.html#ac701172bd3b89867f6cb2b1cd206565a">DataReady::HandleData</a>(fd_set&amp; r, fd_set&amp; w, fd_set&amp; x)
<a name="l00361"></a>00361 {
<a name="l00362"></a>00362   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;nfds; i++) {
<a name="l00363"></a>00363     <span class="keywordtype">int</span> <a class="code" href="fl__boxtype_8cxx.html#ac406db58651c10e8f67ed432c66db0d6">f</a> = fds[i].fd;
<a name="l00364"></a>00364     <span class="keywordtype">short</span> revents = 0;
<a name="l00365"></a>00365     <span class="keywordflow">if</span> (FD_ISSET(f, &amp;r)) revents |= POLLIN;
<a name="l00366"></a>00366     <span class="keywordflow">if</span> (FD_ISSET(f, &amp;w)) revents |= POLLOUT;
<a name="l00367"></a>00367     <span class="keywordflow">if</span> (FD_ISSET(f, &amp;x)) revents |= POLLERR;
<a name="l00368"></a>00368     <span class="keywordflow">if</span> (fds[i].events &amp; revents) {
<a name="l00369"></a>00369       <a class="code" href="Fl__mac_8cxx.html#aed6d1186912238eabd7672078a396423">DEBUGMSG</a>(<span class="stringliteral">&quot;DOING CALLBACK: &quot;</span>);
<a name="l00370"></a>00370       fds[i].cb(f, fds[i].arg);
<a name="l00371"></a>00371       <a class="code" href="Fl__mac_8cxx.html#aed6d1186912238eabd7672078a396423">DEBUGMSG</a>(<span class="stringliteral">&quot;DONE\n&quot;</span>);
<a name="l00372"></a>00372     }
<a name="l00373"></a>00373   }
<a name="l00374"></a>00374 }
<a name="l00375"></a>00375 
<a name="l00376"></a>00376 <span class="comment">// DATA READY THREAD</span>
<a name="l00377"></a>00377 <span class="comment">//    This thread watches for changes in user&#39;s file descriptors.</span>
<a name="l00378"></a>00378 <span class="comment">//    Sends a &#39;data ready event&#39; to the main thread if any change.</span>
<a name="l00379"></a>00379 <span class="comment">//</span>
<a name="l00380"></a>00380 <span class="keywordtype">void</span>* <a class="code" href="classDataReady.html#a563a37e231532644cc059161d1a0262a">DataReady::DataReadyThread</a>(<span class="keywordtype">void</span> *o)
<a name="l00381"></a>00381 {
<a name="l00382"></a>00382   <a class="code" href="classDataReady.html">DataReady</a> *<span class="keyword">self</span> = (<a class="code" href="classDataReady.html">DataReady</a>*)o;
<a name="l00383"></a>00383   NSAutoreleasePool *localPool;
<a name="l00384"></a>00384   localPool = [[NSAutoreleasePool alloc] init]; 
<a name="l00385"></a>00385   <span class="keywordflow">while</span> ( 1 ) {                                 <span class="comment">// loop until thread cancel or error</span>
<a name="l00386"></a>00386     <span class="comment">// Thread safe local copies of data before each select()</span>
<a name="l00387"></a>00387     <span class="keyword">self</span>-&gt;<a class="code" href="classDataReady.html#a82aacc293387f4990ce1015ec063d9a7">DataLock</a>();
<a name="l00388"></a>00388     <span class="comment">/*LOCK*/</span>  <span class="keywordtype">int</span> maxfd = <span class="keyword">self</span>-&gt;_maxfd;
<a name="l00389"></a>00389     <span class="comment">/*LOCK*/</span>  fd_set r = <span class="keyword">self</span>-&gt;GetFdset(0);
<a name="l00390"></a>00390     <span class="comment">/*LOCK*/</span>  fd_set w = <span class="keyword">self</span>-&gt;GetFdset(1);
<a name="l00391"></a>00391     <span class="comment">/*LOCK*/</span>  fd_set x = <span class="keyword">self</span>-&gt;GetFdset(2);
<a name="l00392"></a>00392     <span class="comment">/*LOCK*/</span>  <span class="keywordtype">int</span> cancelpipe = <span class="keyword">self</span>-&gt;GetCancelPipe(0);
<a name="l00393"></a>00393     <span class="comment">/*LOCK*/</span>  <span class="keywordflow">if</span> ( cancelpipe &gt; maxfd ) maxfd = cancelpipe;
<a name="l00394"></a>00394     <span class="comment">/*LOCK*/</span>  FD_SET(cancelpipe, &amp;r);           <span class="comment">// add cancelpipe to fd&#39;s to watch</span>
<a name="l00395"></a>00395     <span class="comment">/*LOCK*/</span>  FD_SET(cancelpipe, &amp;x);
<a name="l00396"></a>00396     <span class="keyword">self</span>-&gt;DataUnlock();
<a name="l00397"></a>00397     <span class="comment">// timeval t = { 1000, 0 }; // 1000 seconds;</span>
<a name="l00398"></a>00398     timeval t = { 2, 0 };       <span class="comment">// HACK: 2 secs prevents &#39;hanging&#39; problem</span>
<a name="l00399"></a>00399     <span class="keywordtype">int</span> ret =<a class="code" href="factory_8cxx.html#a55a2870f3bd5e6ef9331bb7040a212c8"> ::select</a>(maxfd+1, &amp;r, &amp;w, &amp;x, &amp;t);
<a name="l00400"></a>00400     pthread_testcancel();       <span class="comment">// OSX 10.0.4 and older: needed for parent to cancel</span>
<a name="l00401"></a>00401     <span class="keywordflow">switch</span> ( ret ) {
<a name="l00402"></a>00402       <span class="keywordflow">case</span> 0:   <span class="comment">// NO DATA</span>
<a name="l00403"></a>00403         <span class="keywordflow">continue</span>;
<a name="l00404"></a>00404       <span class="keywordflow">case</span> -1:  <span class="comment">// ERROR</span>
<a name="l00405"></a>00405       {
<a name="l00406"></a>00406         <a class="code" href="Fl__mac_8cxx.html#a25f5d39fe70418b682112dac0ded04bd">DEBUGPERRORMSG</a>(<span class="stringliteral">&quot;CHILD THREAD: select() failed&quot;</span>);
<a name="l00407"></a>00407         <span class="keywordflow">return</span>(<a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);           <span class="comment">// error? exit thread</span>
<a name="l00408"></a>00408       }
<a name="l00409"></a>00409       <span class="keywordflow">default</span>:  <span class="comment">// DATA READY</span>
<a name="l00410"></a>00410       {
<a name="l00411"></a>00411         <span class="keywordflow">if</span> (FD_ISSET(cancelpipe, &amp;r) || FD_ISSET(cancelpipe, &amp;x))       <span class="comment">// cancel?</span>
<a name="l00412"></a>00412           { <span class="keywordflow">return</span>(<a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>); }                                             <span class="comment">// just exit</span>
<a name="l00413"></a>00413         <a class="code" href="Fl__mac_8cxx.html#aed6d1186912238eabd7672078a396423">DEBUGMSG</a>(<span class="stringliteral">&quot;CHILD THREAD: DATA IS READY\n&quot;</span>);
<a name="l00414"></a>00414         NSPoint pt={0,0};
<a name="l00415"></a>00415         NSEvent *<span class="keyword">event</span> = [NSEvent otherEventWithType:NSApplicationDefined location:pt 
<a name="l00416"></a>00416                                        modifierFlags:0
<a name="l00417"></a>00417                                            timestamp:0
<a name="l00418"></a>00418                                         windowNumber:0 context:NULL 
<a name="l00419"></a>00419                                              subtype:FLTKDataReadyEvent data1:0 data2:0];
<a name="l00420"></a>00420         [NSApp postEvent:event atStart:NO];
<a name="l00421"></a>00421         <span class="keywordflow">return</span>(<a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);           <span class="comment">// done with thread</span>
<a name="l00422"></a>00422       }
<a name="l00423"></a>00423     }
<a name="l00424"></a>00424   }
<a name="l00425"></a>00425 }
<a name="l00426"></a>00426 
<a name="l00427"></a>00427 <span class="comment">// START &#39;DATA READY&#39; THREAD RUNNING, CREATE INTER-THREAD PIPE</span>
<a name="l00428"></a>00428 <span class="keywordtype">void</span> <a class="code" href="classDataReady.html#aa64b9a59088565f9ed5b31c8635e7b6c">DataReady::StartThread</a>(<span class="keywordtype">void</span>)
<a name="l00429"></a>00429 {
<a name="l00430"></a>00430   <a class="code" href="classDataReady.html#a09cbc5b242a2075318e5743996ee4a1e">CancelThread</a>(<a class="code" href="Fl__mac_8cxx.html#a52ec816ebb31da9a8f9adf9ea690afcd">DEBUGTEXT</a>(<span class="stringliteral">&quot;STARTING NEW THREAD\n&quot;</span>));
<a name="l00431"></a>00431   <a class="code" href="classDataReady.html#a82aacc293387f4990ce1015ec063d9a7">DataLock</a>();
<a name="l00432"></a>00432   <span class="comment">/*LOCK*/</span>  pipe(_cancelpipe);  <span class="comment">// pipe for sending cancel msg to thread</span>
<a name="l00433"></a>00433   <a class="code" href="classDataReady.html#aad0aa979174e3433a217de63acbe55b8">DataUnlock</a>();
<a name="l00434"></a>00434   <a class="code" href="Fl__mac_8cxx.html#aed6d1186912238eabd7672078a396423">DEBUGMSG</a>(<span class="stringliteral">&quot;*** START THREAD\n&quot;</span>);
<a name="l00435"></a>00435   pthread_create(&amp;tid, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="classDataReady.html#a563a37e231532644cc059161d1a0262a">DataReadyThread</a>, (<span class="keywordtype">void</span>*)<span class="keyword">this</span>);
<a name="l00436"></a>00436 }
<a name="l00437"></a>00437 
<a name="l00438"></a>00438 <span class="comment">// CANCEL &#39;DATA READY&#39; THREAD, CLOSE PIPE</span>
<a name="l00439"></a>00439 <span class="keywordtype">void</span> <a class="code" href="classDataReady.html#a09cbc5b242a2075318e5743996ee4a1e">DataReady::CancelThread</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *reason)
<a name="l00440"></a>00440 {
<a name="l00441"></a>00441   <span class="keywordflow">if</span> ( tid ) {
<a name="l00442"></a>00442     <a class="code" href="Fl__mac_8cxx.html#aed6d1186912238eabd7672078a396423">DEBUGMSG</a>(<span class="stringliteral">&quot;*** CANCEL THREAD: &quot;</span>);
<a name="l00443"></a>00443     <a class="code" href="Fl__mac_8cxx.html#aed6d1186912238eabd7672078a396423">DEBUGMSG</a>(reason);
<a name="l00444"></a>00444     <span class="keywordflow">if</span> ( pthread_cancel(tid) == 0 ) {           <span class="comment">// cancel first</span>
<a name="l00445"></a>00445       <a class="code" href="classDataReady.html#a82aacc293387f4990ce1015ec063d9a7">DataLock</a>();
<a name="l00446"></a>00446       <span class="comment">/*LOCK*/</span>  write(_cancelpipe[1], <span class="stringliteral">&quot;x&quot;</span>, 1);  <span class="comment">// wake thread from select</span>
<a name="l00447"></a>00447       <a class="code" href="classDataReady.html#aad0aa979174e3433a217de63acbe55b8">DataUnlock</a>();
<a name="l00448"></a>00448       pthread_join(tid, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);                  <span class="comment">// wait for thread to finish</span>
<a name="l00449"></a>00449     }
<a name="l00450"></a>00450     tid = 0;
<a name="l00451"></a>00451     <a class="code" href="Fl__mac_8cxx.html#aed6d1186912238eabd7672078a396423">DEBUGMSG</a>(<span class="stringliteral">&quot;(JOINED) OK\n&quot;</span>);
<a name="l00452"></a>00452   }
<a name="l00453"></a>00453   <span class="comment">// Close pipe if open</span>
<a name="l00454"></a>00454   <a class="code" href="classDataReady.html#a82aacc293387f4990ce1015ec063d9a7">DataLock</a>();
<a name="l00455"></a>00455   <span class="comment">/*LOCK*/</span>  <span class="keywordflow">if</span> ( _cancelpipe[0] ) { close(_cancelpipe[0]); _cancelpipe[0] = 0; }
<a name="l00456"></a>00456   <span class="comment">/*LOCK*/</span>  <span class="keywordflow">if</span> ( _cancelpipe[1] ) { close(_cancelpipe[1]); _cancelpipe[1] = 0; }
<a name="l00457"></a>00457   <a class="code" href="classDataReady.html#aad0aa979174e3433a217de63acbe55b8">DataUnlock</a>();
<a name="l00458"></a>00458 }
<a name="l00459"></a>00459 
<a name="l00460"></a>00460 <span class="keywordtype">void</span> <a class="code" href="classFl.html#a799b8278326b3c2db15687c43c11aaf6">Fl::add_fd</a>( <span class="keywordtype">int</span> n, <span class="keywordtype">int</span> events, <span class="keywordtype">void</span> (*cb)(<span class="keywordtype">int</span>, <span class="keywordtype">void</span>*), <span class="keywordtype">void</span> *v )
<a name="l00461"></a>00461 {
<a name="l00462"></a>00462   dataready.<a class="code" href="classDataReady.html#af1e989d67da7cfe6e3743c02600b89a2">AddFD</a>(n, events, cb, v);
<a name="l00463"></a>00463 }
<a name="l00464"></a>00464 
<a name="l00465"></a>00465 <span class="keywordtype">void</span> <a class="code" href="classFl.html#a799b8278326b3c2db15687c43c11aaf6">Fl::add_fd</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">void</span> (*cb)(<span class="keywordtype">int</span>, <span class="keywordtype">void</span>*), <span class="keywordtype">void</span>* v)
<a name="l00466"></a>00466 {
<a name="l00467"></a>00467   dataready.<a class="code" href="classDataReady.html#af1e989d67da7cfe6e3743c02600b89a2">AddFD</a>(fd, POLLIN, cb, v);
<a name="l00468"></a>00468 }
<a name="l00469"></a>00469 
<a name="l00470"></a>00470 <span class="keywordtype">void</span> <a class="code" href="classFl.html#a71e75c1a559e3415c5304c37235af831">Fl::remove_fd</a>(<span class="keywordtype">int</span> n, <span class="keywordtype">int</span> events)
<a name="l00471"></a>00471 {
<a name="l00472"></a>00472   dataready.<a class="code" href="classDataReady.html#ad61c16682116ac3a0ffab43d725d8278">RemoveFD</a>(n, events);
<a name="l00473"></a>00473 }
<a name="l00474"></a>00474 
<a name="l00475"></a>00475 <span class="keywordtype">void</span> <a class="code" href="classFl.html#a71e75c1a559e3415c5304c37235af831">Fl::remove_fd</a>(<span class="keywordtype">int</span> n)
<a name="l00476"></a>00476 {
<a name="l00477"></a>00477   dataready.<a class="code" href="classDataReady.html#ad61c16682116ac3a0ffab43d725d8278">RemoveFD</a>(n, -1);
<a name="l00478"></a>00478 }
<a name="l00479"></a>00479 
<a name="l00480"></a>00480 <span class="comment">/*</span>
<a name="l00481"></a>00481 <span class="comment"> * Check if there is actually a message pending!</span>
<a name="l00482"></a>00482 <span class="comment"> */</span>
<a name="l00483"></a>00483 <span class="keywordtype">int</span> <a class="code" href="Fl_8cxx.html#af0705d69ac0f8c4c43d26d935c12044a">fl_ready</a>()
<a name="l00484"></a>00484 {
<a name="l00485"></a>00485   NSEvent *retval = [NSApp nextEventMatchingMask:NSAnyEventMask untilDate:[NSDate dateWithTimeIntervalSinceNow:0]
<a name="l00486"></a>00486                                     inMode:NSDefaultRunLoopMode dequeue:NO];
<a name="l00487"></a>00487   <span class="keywordflow">return</span> retval != nil;
<a name="l00488"></a>00488 }
<a name="l00489"></a>00489 
<a name="l00490"></a>00490 
<a name="l00491"></a>00491 <span class="keyword">static</span> <span class="keywordtype">void</span> processFLTKEvent(<span class="keywordtype">void</span>) {
<a name="l00492"></a>00492   dataready.<a class="code" href="classDataReady.html#a09cbc5b242a2075318e5743996ee4a1e">CancelThread</a>(<a class="code" href="Fl__mac_8cxx.html#a52ec816ebb31da9a8f9adf9ea690afcd">DEBUGTEXT</a>(<span class="stringliteral">&quot;DATA READY EVENT\n&quot;</span>));
<a name="l00493"></a>00493   
<a name="l00494"></a>00494   <span class="comment">// CHILD THREAD TELLS US DATA READY</span>
<a name="l00495"></a>00495   <span class="comment">//     Check to see what&#39;s ready, and invoke user&#39;s cb&#39;s</span>
<a name="l00496"></a>00496   <span class="comment">//</span>
<a name="l00497"></a>00497   fd_set r,<a class="code" href="forms_8H-2.html#aac374e320caaadeca4874add33b62af2">w</a>,<a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>;
<a name="l00498"></a>00498   <span class="keywordflow">switch</span>(dataready.<a class="code" href="classDataReady.html#ad2fb69a0073537ccd0ae4c60db6944b2">CheckData</a>(r,w,x)) {
<a name="l00499"></a>00499     <span class="keywordflow">case</span> 0:     <span class="comment">// NO DATA</span>
<a name="l00500"></a>00500       <span class="keywordflow">break</span>;
<a name="l00501"></a>00501     <span class="keywordflow">case</span> -1:    <span class="comment">// ERROR</span>
<a name="l00502"></a>00502       break;
<a name="l00503"></a>00503     <span class="keywordflow">default</span>:    <span class="comment">// DATA READY</span>
<a name="l00504"></a>00504       dataready.<a class="code" href="classDataReady.html#ac701172bd3b89867f6cb2b1cd206565a">HandleData</a>(r,w,x);
<a name="l00505"></a>00505       <span class="keywordflow">break</span>;
<a name="l00506"></a>00506   }
<a name="l00507"></a>00507   <span class="keywordflow">return</span>;
<a name="l00508"></a>00508 }
<a name="l00509"></a>00509 
<a name="l00510"></a>00510 
<a name="l00511"></a>00511 <span class="comment">/*</span>
<a name="l00512"></a>00512 <span class="comment"> * break the current event loop</span>
<a name="l00513"></a>00513 <span class="comment"> */</span>
<a name="l00514"></a>00514 <span class="keyword">static</span> <span class="keywordtype">void</span> breakMacEventLoop()
<a name="l00515"></a>00515 {
<a name="l00516"></a>00516   <a class="code" href="Fl__mac_8cxx.html#a7c231659c1d4f9ad9126b83cfbcbfb53">fl_lock_function</a>();
<a name="l00517"></a>00517   
<a name="l00518"></a>00518   NSPoint pt={0,0};
<a name="l00519"></a>00519   NSEvent *<span class="keyword">event</span> = [NSEvent otherEventWithType:NSApplicationDefined location:pt 
<a name="l00520"></a>00520                                  modifierFlags:0
<a name="l00521"></a>00521                                      timestamp:0
<a name="l00522"></a>00522                                   windowNumber:0 context:NULL 
<a name="l00523"></a>00523                                        subtype:FLTKTimerEvent data1:0 data2:0];
<a name="l00524"></a>00524   [NSApp postEvent:event atStart:NO];
<a name="l00525"></a>00525   <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l00526"></a>00526 }
<a name="l00527"></a>00527 
<a name="l00528"></a>00528 <span class="comment">//</span>
<a name="l00529"></a>00529 <span class="comment">// MacOS X timers</span>
<a name="l00530"></a>00530 <span class="comment">//</span>
<a name="l00531"></a>00531 
<a name="l00532"></a>00532 <span class="keyword">struct </span><a class="code" href="structMacTimeout.html">MacTimeout</a> {
<a name="l00533"></a>00533   <a class="code" href="group__callback__functions.html#gaf00cf21170aa3231f6e869a30a036390">Fl_Timeout_Handler</a> <a class="code" href="structMacTimeout.html#a13d349713ab4eb38a5e14f975f84cf08">callback</a>;
<a name="l00534"></a>00534   <span class="keywordtype">void</span>* <a class="code" href="structMacTimeout.html#ad232eaa73f22599f0d0883a90477ba3d">data</a>;
<a name="l00535"></a>00535   CFRunLoopTimerRef <a class="code" href="structMacTimeout.html#aac4fe2df22f669ea5ba8ddf0ba7d200d">timer</a>;
<a name="l00536"></a>00536   <span class="keywordtype">char</span> <a class="code" href="structMacTimeout.html#aa734ee03fd9d56dcac5b967efe33e7a1">pending</a>; 
<a name="l00537"></a>00537 };
<a name="l00538"></a>00538 <span class="keyword">static</span> <a class="code" href="structMacTimeout.html">MacTimeout</a>* mac_timers;
<a name="l00539"></a>00539 <span class="keyword">static</span> <span class="keywordtype">int</span> mac_timer_alloc;
<a name="l00540"></a>00540 <span class="keyword">static</span> <span class="keywordtype">int</span> mac_timer_used;
<a name="l00541"></a>00541 
<a name="l00542"></a>00542 <span class="keyword">static</span> <span class="keywordtype">void</span> realloc_timers()
<a name="l00543"></a>00543 {
<a name="l00544"></a>00544   <span class="keywordflow">if</span> (mac_timer_alloc == 0) {
<a name="l00545"></a>00545     mac_timer_alloc = 8;
<a name="l00546"></a>00546   }
<a name="l00547"></a>00547   mac_timer_alloc *= 2;
<a name="l00548"></a>00548   <a class="code" href="structMacTimeout.html">MacTimeout</a>* new_timers = <span class="keyword">new</span> <a class="code" href="structMacTimeout.html">MacTimeout</a>[mac_timer_alloc];
<a name="l00549"></a>00549   memset(new_timers, 0, <span class="keyword">sizeof</span>(<a class="code" href="structMacTimeout.html">MacTimeout</a>)*mac_timer_alloc);
<a name="l00550"></a>00550   memcpy(new_timers, mac_timers, <span class="keyword">sizeof</span>(<a class="code" href="structMacTimeout.html">MacTimeout</a>) * mac_timer_used);
<a name="l00551"></a>00551   <a class="code" href="structMacTimeout.html">MacTimeout</a>* delete_me = mac_timers;
<a name="l00552"></a>00552   mac_timers = new_timers;
<a name="l00553"></a>00553   <span class="keyword">delete</span> [] delete_me;
<a name="l00554"></a>00554 }
<a name="l00555"></a>00555 
<a name="l00556"></a>00556 <span class="keyword">static</span> <span class="keywordtype">void</span> delete_timer(<a class="code" href="structMacTimeout.html">MacTimeout</a>&amp; t)
<a name="l00557"></a>00557 {
<a name="l00558"></a>00558   <span class="keywordflow">if</span> (t.<a class="code" href="structMacTimeout.html#aac4fe2df22f669ea5ba8ddf0ba7d200d">timer</a>) {
<a name="l00559"></a>00559     CFRunLoopRemoveTimer(CFRunLoopGetCurrent(),
<a name="l00560"></a>00560                       t.<a class="code" href="structMacTimeout.html#aac4fe2df22f669ea5ba8ddf0ba7d200d">timer</a>,
<a name="l00561"></a>00561                       kCFRunLoopDefaultMode);
<a name="l00562"></a>00562     CFRelease(t.<a class="code" href="structMacTimeout.html#aac4fe2df22f669ea5ba8ddf0ba7d200d">timer</a>);
<a name="l00563"></a>00563     memset(&amp;t, 0, <span class="keyword">sizeof</span>(<a class="code" href="structMacTimeout.html">MacTimeout</a>));
<a name="l00564"></a>00564   }
<a name="l00565"></a>00565 }
<a name="l00566"></a>00566 
<a name="l00567"></a>00567 <span class="keyword">static</span> <span class="keywordtype">void</span> do_timer(CFRunLoopTimerRef timer, <span class="keywordtype">void</span>* <a class="code" href="jpeglib_8h.html#ae5784a8f4db42de0ffacd0cbd08dc6ad">data</a>)
<a name="l00568"></a>00568 {
<a name="l00569"></a>00569   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0;  i &lt; mac_timer_used;  ++i) {
<a name="l00570"></a>00570     <a class="code" href="structMacTimeout.html">MacTimeout</a>&amp; t = mac_timers[i];
<a name="l00571"></a>00571     <span class="keywordflow">if</span> (t.<a class="code" href="structMacTimeout.html#aac4fe2df22f669ea5ba8ddf0ba7d200d">timer</a> == timer  &amp;&amp;  t.<a class="code" href="structMacTimeout.html#ad232eaa73f22599f0d0883a90477ba3d">data</a> == data) {
<a name="l00572"></a>00572       t.<a class="code" href="structMacTimeout.html#aa734ee03fd9d56dcac5b967efe33e7a1">pending</a> = 0;
<a name="l00573"></a>00573       (*t.<a class="code" href="structMacTimeout.html#a13d349713ab4eb38a5e14f975f84cf08">callback</a>)(data);
<a name="l00574"></a>00574       if (t.<a class="code" href="structMacTimeout.html#aa734ee03fd9d56dcac5b967efe33e7a1">pending</a>==0)
<a name="l00575"></a>00575         delete_timer(t);
<a name="l00576"></a>00576       <span class="keywordflow">break</span>;
<a name="l00577"></a>00577     }
<a name="l00578"></a>00578   }
<a name="l00579"></a>00579   breakMacEventLoop();
<a name="l00580"></a>00580 }
<a name="l00581"></a>00581 
<a name="l00582"></a>00582 <span class="keyword">@interface </span>FLWindow : NSWindow {
<a name="l00583"></a>00583   <a class="code" href="classFl__Window.html">Fl_Window</a> *<a class="code" href="forms_8H-2.html#aac374e320caaadeca4874add33b62af2">w</a>;
<a name="l00584"></a>00584   BOOL containsGLsubwindow;
<a name="l00585"></a>00585 }
<a name="l00586"></a>00586 - (FLWindow*)initWithFl_W:(<a class="code" href="classFl__Window.html">Fl_Window</a> *)flw 
<a name="l00587"></a>00587               contentRect:(NSRect)rect 
<a name="l00588"></a>00588                 styleMask:(NSUInteger)windowStyle 
<a name="l00589"></a>00589                   backing:(NSBackingStoreType)bufferingType 
<a name="l00590"></a>00590                     defer:(BOOL)deferCreation;
<a name="l00591"></a>00591 - (<a class="code" href="classFl__Window.html">Fl_Window</a> *)getFl_Window;
<a name="l00592"></a>00592 - (BOOL)windowShouldClose:(FLWindow *)w;
<a name="l00593"></a>00593 - (BOOL)containsGLsubwindow;
<a name="l00594"></a>00594 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)setContainsGLsubwindow:(BOOL)contains;
<a name="l00595"></a>00595 <span class="keyword">@end</span>
<a name="l00596"></a>00596 
<a name="l00597"></a>00597 <span class="keyword">@implementation </span>FLWindow
<a name="l00598"></a>00598 - (FLWindow*)initWithFl_W:(<a class="code" href="classFl__Window.html">Fl_Window</a> *)flw 
<a name="l00599"></a>00599               contentRect:(NSRect)rect 
<a name="l00600"></a>00600                 styleMask:(NSUInteger)windowStyle 
<a name="l00601"></a>00601                   backing:(NSBackingStoreType)bufferingType 
<a name="l00602"></a>00602                     defer:(BOOL)deferCreation
<a name="l00603"></a>00603 {
<a name="l00604"></a>00604   <span class="keyword">self</span> = [<span class="keyword">super</span> initWithContentRect:rect styleMask:windowStyle backing:bufferingType defer:deferCreation];
<a name="l00605"></a>00605   <span class="keywordflow">if</span> (<span class="keyword">self</span>) {
<a name="l00606"></a>00606     w = flw;
<a name="l00607"></a>00607     containsGLsubwindow = NO;
<a name="l00608"></a>00608   }
<a name="l00609"></a>00609   <span class="keywordflow">return</span> <span class="keyword">self</span>;
<a name="l00610"></a>00610 }
<a name="l00611"></a>00611 - (<a class="code" href="classFl__Window.html">Fl_Window</a> *)getFl_Window;
<a name="l00612"></a>00612 {
<a name="l00613"></a>00613   <span class="keywordflow">return</span> <a class="code" href="forms_8H-2.html#aac374e320caaadeca4874add33b62af2">w</a>;
<a name="l00614"></a>00614 }
<a name="l00615"></a>00615 - (BOOL)windowShouldClose:(FLWindow *)fl
<a name="l00616"></a>00616 {
<a name="l00617"></a>00617   <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>( <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a42828f08af2b2191bbc60e113ec08f01">FL_CLOSE</a>, [fl getFl_Window] ); <span class="comment">// this might or might not close the window</span>
<a name="l00618"></a>00618   <span class="keywordflow">if</span> (!<a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a>) <span class="keywordflow">return</span> YES;
<a name="l00619"></a>00619   <a class="code" href="classFl__Window.html">Fl_Window</a> *l = <a class="code" href="group__fl__windows.html#ga3130407bc1c11f9b7f2a9c43a87a1599">Fl::first_window</a>();
<a name="l00620"></a>00620   <span class="keywordflow">while</span>( l != <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; l != [fl getFl_Window]) l = <a class="code" href="group__fl__windows.html#ga46df67455d96ee45e51f59263c6bf0ea">Fl::next_window</a>(l);
<a name="l00621"></a>00621   <span class="keywordflow">return</span> (l == <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ? YES : NO);
<a name="l00622"></a>00622 }
<a name="l00623"></a>00623 - (BOOL)containsGLsubwindow
<a name="l00624"></a>00624 {
<a name="l00625"></a>00625   <span class="keywordflow">return</span> containsGLsubwindow;
<a name="l00626"></a>00626 }
<a name="l00627"></a>00627 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)setContainsGLsubwindow:(BOOL)contains
<a name="l00628"></a>00628 {
<a name="l00629"></a>00629   containsGLsubwindow = contains;
<a name="l00630"></a>00630 }
<a name="l00631"></a>00631 <span class="keyword">@end</span>
<a name="l00632"></a>00632 
<a name="l00633"></a>00633 <span class="comment">/*</span>
<a name="l00634"></a>00634 <span class="comment"> * This function is the central event handler.</span>
<a name="l00635"></a>00635 <span class="comment"> * It reads events from the event queue using the given maximum time</span>
<a name="l00636"></a>00636 <span class="comment"> * Funny enough, it returns the same time that it got as the argument. </span>
<a name="l00637"></a>00637 <span class="comment"> */</span>
<a name="l00638"></a>00638 <span class="keyword">static</span> <span class="keywordtype">double</span> do_queued_events( <span class="keywordtype">double</span> time = 0.0 ) 
<a name="l00639"></a>00639 {
<a name="l00640"></a>00640   got_events = 0;
<a name="l00641"></a>00641   
<a name="l00642"></a>00642   <span class="comment">// Check for re-entrant condition</span>
<a name="l00643"></a>00643   <span class="keywordflow">if</span> ( dataready.<a class="code" href="classDataReady.html#a51474ea8ee76b766e6748ec354ea9f29">IsThreadRunning</a>() ) {
<a name="l00644"></a>00644     dataready.<a class="code" href="classDataReady.html#a09cbc5b242a2075318e5743996ee4a1e">CancelThread</a>(<a class="code" href="Fl__mac_8cxx.html#a52ec816ebb31da9a8f9adf9ea690afcd">DEBUGTEXT</a>(<span class="stringliteral">&quot;AVOID REENTRY\n&quot;</span>));
<a name="l00645"></a>00645   }
<a name="l00646"></a>00646   
<a name="l00647"></a>00647   <span class="comment">// Start thread to watch for data ready</span>
<a name="l00648"></a>00648   <span class="keywordflow">if</span> ( dataready.<a class="code" href="classDataReady.html#a42964a0a731eeedcb4dfc4c0b4bacd94">GetNfds</a>() ) {
<a name="l00649"></a>00649     dataready.<a class="code" href="classDataReady.html#aa64b9a59088565f9ed5b31c8635e7b6c">StartThread</a>();
<a name="l00650"></a>00650   }
<a name="l00651"></a>00651   
<a name="l00652"></a>00652   <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l00653"></a>00653   NSEvent *<span class="keyword">event</span> = [NSApp nextEventMatchingMask:NSAnyEventMask 
<a name="l00654"></a>00654                                       untilDate:[NSDate dateWithTimeIntervalSinceNow:time] 
<a name="l00655"></a>00655                                          inMode:NSDefaultRunLoopMode dequeue:YES];  
<a name="l00656"></a>00656   <span class="keywordflow">if</span> (event != nil) {
<a name="l00657"></a>00657     [NSApp sendEvent:event]; <span class="comment">// reimplemented in [FLApplication sendevent:]</span>
<a name="l00658"></a>00658   }
<a name="l00659"></a>00659   <a class="code" href="Fl__mac_8cxx.html#a7c231659c1d4f9ad9126b83cfbcbfb53">fl_lock_function</a>();
<a name="l00660"></a>00660   
<a name="l00661"></a>00661 <span class="preprocessor">#if CONSOLIDATE_MOTION</span>
<a name="l00662"></a>00662 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (send_motion &amp;&amp; send_motion == fl_xmousewin) {
<a name="l00663"></a>00663     send_motion = 0;
<a name="l00664"></a>00664     <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>(<a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3acd57cae091eb27c9a52c446bdd0c164d">FL_MOVE</a>, fl_xmousewin);
<a name="l00665"></a>00665   }
<a name="l00666"></a>00666 <span class="preprocessor">#endif</span>
<a name="l00667"></a>00667 <span class="preprocessor"></span>  
<a name="l00668"></a>00668   <span class="keywordflow">return</span> time;
<a name="l00669"></a>00669 }
<a name="l00670"></a>00670 
<a name="l00671"></a>00671 <span class="comment">/*</span>
<a name="l00672"></a>00672 <span class="comment"> * This public function handles all events. It wait a maximum of </span>
<a name="l00673"></a>00673 <span class="comment"> * &#39;time&#39; seconds for an event. This version returns 1 if events</span>
<a name="l00674"></a>00674 <span class="comment"> * other than the timeout timer were processed.</span>
<a name="l00675"></a>00675 <span class="comment"> *</span>
<a name="l00676"></a>00676 <span class="comment"> * \todo there is no socket handling in this code whatsoever</span>
<a name="l00677"></a>00677 <span class="comment"> */</span>
<a name="l00678"></a>00678 <span class="keywordtype">int</span> <a class="code" href="Fl_8cxx.html#a55e2ddfbe9d4603198ae690c8e54e565">fl_wait</a>( <span class="keywordtype">double</span> time ) 
<a name="l00679"></a>00679 {
<a name="l00680"></a>00680   do_queued_events( time );
<a name="l00681"></a>00681   <span class="keywordflow">return</span> (got_events);
<a name="l00682"></a>00682 }
<a name="l00683"></a>00683 
<a name="l00684"></a>00684 <span class="keywordtype">double</span> fl_mac_flush_and_wait(<span class="keywordtype">double</span> time_to_wait, <span class="keywordtype">char</span> in_idle) {
<a name="l00685"></a>00685   NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
<a name="l00686"></a>00686   <a class="code" href="classFl.html#a08d29d807ea3874b8bb16f7457f64bdc">Fl::flush</a>();
<a name="l00687"></a>00687   <span class="keywordflow">if</span> (<a class="code" href="classFl.html#a60fb2b446096dd4742511edb459653d3">Fl::idle</a> &amp;&amp; !in_idle) <span class="comment">// &#39;idle&#39; may have been set within flush()</span>
<a name="l00688"></a>00688     time_to_wait = 0.0;
<a name="l00689"></a>00689   <span class="keywordtype">double</span> retval = <a class="code" href="Fl_8cxx.html#a55e2ddfbe9d4603198ae690c8e54e565">fl_wait</a>(time_to_wait);
<a name="l00690"></a>00690   [pool release];
<a name="l00691"></a>00691   <span class="keywordflow">return</span> retval;
<a name="l00692"></a>00692 }
<a name="l00693"></a>00693 
<a name="l00694"></a>00694 <span class="comment">// updates Fl::e_x, Fl::e_y, Fl::e_x_root, and Fl::e_y_root</span>
<a name="l00695"></a>00695 <span class="keyword">static</span> <span class="keywordtype">void</span> update_e_xy_and_e_xy_root(NSWindow *nsw)
<a name="l00696"></a>00696 {
<a name="l00697"></a>00697   NSPoint pt;
<a name="l00698"></a>00698   pt = [nsw mouseLocationOutsideOfEventStream];
<a name="l00699"></a>00699   <a class="code" href="classFl.html#a7b57f90db4afa2b1b1e2e163e9bdc1d3">Fl::e_x</a> = <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>(pt.x);
<a name="l00700"></a>00700   <a class="code" href="classFl.html#a0c047ee4ea16066dc9e70bc6a4035c20">Fl::e_y</a> = <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>([[nsw contentView] frame].<a class="code" href="png_8h.html#a43291b8493b637821dec145c4bb1503d">size</a>.height - pt.y);
<a name="l00701"></a>00701   pt = [NSEvent mouseLocation];
<a name="l00702"></a>00702   <a class="code" href="classFl.html#ac905dc5f6e4b4c919e405932413fce30">Fl::e_x_root</a> = <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>(pt.x);
<a name="l00703"></a>00703   <a class="code" href="classFl.html#af14bafd28cbd839ab2e4526eb4a5c73f">Fl::e_y_root</a> = <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>([[nsw screen] frame].<a class="code" href="png_8h.html#a43291b8493b637821dec145c4bb1503d">size</a>.height - pt.y);
<a name="l00704"></a>00704 }
<a name="l00705"></a>00705 
<a name="l00706"></a>00706 <span class="comment">/*</span>
<a name="l00707"></a>00707 <span class="comment"> * Cocoa Mousewheel handler</span>
<a name="l00708"></a>00708 <span class="comment"> */</span>
<a name="l00709"></a>00709 <span class="keyword">static</span> <span class="keywordtype">void</span> cocoaMouseWheelHandler(NSEvent *theEvent)
<a name="l00710"></a>00710 {
<a name="l00711"></a>00711   <span class="comment">// Handle the new &quot;MightyMouse&quot; mouse wheel events. Please, someone explain</span>
<a name="l00712"></a>00712   <span class="comment">// to me why Apple changed the API on this even though the current API</span>
<a name="l00713"></a>00713   <span class="comment">// supports two wheels just fine. Matthias,</span>
<a name="l00714"></a>00714   <a class="code" href="Fl__mac_8cxx.html#a7c231659c1d4f9ad9126b83cfbcbfb53">fl_lock_function</a>();
<a name="l00715"></a>00715   
<a name="l00716"></a>00716   <a class="code" href="classFl__Window.html">Fl_Window</a> *window = (<a class="code" href="classFl__Window.html">Fl_Window</a>*)[(FLWindow*)[theEvent window] getFl_Window];
<a name="l00717"></a>00717   <span class="keywordflow">if</span> ( !window-&gt;<a class="code" href="classFl__Window.html#aa09300542b2d8b49fc69a037bdd3b742">shown</a>() ) {
<a name="l00718"></a>00718     <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l00719"></a>00719     <span class="keywordflow">return</span>;
<a name="l00720"></a>00720   }
<a name="l00721"></a>00721   <a class="code" href="group__fl__windows.html#ga3130407bc1c11f9b7f2a9c43a87a1599">Fl::first_window</a>(window);
<a name="l00722"></a>00722   
<a name="l00723"></a>00723   <span class="comment">// Under OSX, single mousewheel increments are 0.1,</span>
<a name="l00724"></a>00724   <span class="comment">// so make sure they show up as at least 1..</span>
<a name="l00725"></a>00725   <span class="comment">//</span>
<a name="l00726"></a>00726   <span class="keywordtype">float</span> <a class="code" href="fl__boxtype_8cxx.html#acafd1211381c8640d68a685ac2eea5d2">dx</a> = [theEvent deltaX]; <span class="keywordflow">if</span> ( fabs(dx) &lt; 1.0 ) dx = (dx &gt; 0) ? 1.0 : -1.0;
<a name="l00727"></a>00727   <span class="keywordtype">float</span> <a class="code" href="fl__boxtype_8cxx.html#a4cffdba1345d329bb97e76579d57fa21">dy</a> = [theEvent deltaY]; <span class="keywordflow">if</span> ( fabs(dy) &lt; 1.0 ) dy = (dy &gt; 0) ? 1.0 : -1.0;
<a name="l00728"></a>00728   <span class="keywordflow">if</span> ([theEvent deltaX] != 0) {
<a name="l00729"></a>00729     <a class="code" href="classFl.html#a3ef9e966bd64bac1a31bf926e7b640a2">Fl::e_dx</a> = (<a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>)-dx;
<a name="l00730"></a>00730     <a class="code" href="classFl.html#a1ed9dbb954ea9d4d5eaae06ad0778708">Fl::e_dy</a> = 0;
<a name="l00731"></a>00731     <span class="keywordflow">if</span> ( <a class="code" href="classFl.html#a3ef9e966bd64bac1a31bf926e7b640a2">Fl::e_dx</a>) <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>( <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3ad5f7dd40377c51d5795cd53ded3d4bef">FL_MOUSEWHEEL</a>, window );
<a name="l00732"></a>00732   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ([theEvent deltaY] != 0) {
<a name="l00733"></a>00733     <a class="code" href="classFl.html#a3ef9e966bd64bac1a31bf926e7b640a2">Fl::e_dx</a> = 0;
<a name="l00734"></a>00734     <a class="code" href="classFl.html#a1ed9dbb954ea9d4d5eaae06ad0778708">Fl::e_dy</a> = (<a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>)-dy;
<a name="l00735"></a>00735     <span class="keywordflow">if</span> ( <a class="code" href="classFl.html#a1ed9dbb954ea9d4d5eaae06ad0778708">Fl::e_dy</a>) <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>( <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3ad5f7dd40377c51d5795cd53ded3d4bef">FL_MOUSEWHEEL</a>, window );
<a name="l00736"></a>00736   } <span class="keywordflow">else</span> {
<a name="l00737"></a>00737     <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l00738"></a>00738     <span class="keywordflow">return</span>;
<a name="l00739"></a>00739   }
<a name="l00740"></a>00740   
<a name="l00741"></a>00741   <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l00742"></a>00742   
<a name="l00743"></a>00743   <span class="comment">//  return noErr;</span>
<a name="l00744"></a>00744 }
<a name="l00745"></a>00745 
<a name="l00746"></a>00746 <span class="comment">/*</span>
<a name="l00747"></a>00747 <span class="comment"> * Cocoa Mouse Button Handler</span>
<a name="l00748"></a>00748 <span class="comment"> */</span>
<a name="l00749"></a>00749 <span class="keyword">static</span> <span class="keywordtype">void</span> cocoaMouseHandler(NSEvent *theEvent)
<a name="l00750"></a>00750 {
<a name="l00751"></a>00751   <span class="keyword">static</span> <span class="keywordtype">int</span> keysym[] = { 0, <a class="code" href="Enumerations_8H.html#a1df1e46a5113628156ed7b7f995217d0" title="A mouse button; use Fl_Button + n for mouse button n.">FL_Button</a>+1, <a class="code" href="Enumerations_8H.html#a1df1e46a5113628156ed7b7f995217d0" title="A mouse button; use Fl_Button + n for mouse button n.">FL_Button</a>+3, <a class="code" href="Enumerations_8H.html#a1df1e46a5113628156ed7b7f995217d0" title="A mouse button; use Fl_Button + n for mouse button n.">FL_Button</a>+2 };
<a name="l00752"></a>00752   <span class="keyword">static</span> <span class="keywordtype">int</span> px, <a class="code" href="fl__overlay_8cxx.html#aa9511a47fd6271333948489a220e3029">py</a>;
<a name="l00753"></a>00753   <span class="keyword">static</span> <span class="keywordtype">char</span> suppressed = 0;
<a name="l00754"></a>00754   
<a name="l00755"></a>00755   <a class="code" href="Fl__mac_8cxx.html#a7c231659c1d4f9ad9126b83cfbcbfb53">fl_lock_function</a>();
<a name="l00756"></a>00756   
<a name="l00757"></a>00757   <a class="code" href="classFl__Window.html">Fl_Window</a> *window = (<a class="code" href="classFl__Window.html">Fl_Window</a>*)[(FLWindow*)[theEvent window] getFl_Window];
<a name="l00758"></a>00758   <span class="keywordflow">if</span> ( !window-&gt;<a class="code" href="classFl__Window.html#aa09300542b2d8b49fc69a037bdd3b742">shown</a>() ) {
<a name="l00759"></a>00759     <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l00760"></a>00760     <span class="keywordflow">return</span>;
<a name="l00761"></a>00761   }
<a name="l00762"></a>00762   <a class="code" href="classFl__Window.html">Fl_Window</a> *first = <a class="code" href="group__fl__windows.html#ga3130407bc1c11f9b7f2a9c43a87a1599">Fl::first_window</a>();
<a name="l00763"></a>00763   <span class="keywordflow">if</span> (first != window &amp;&amp; !(first-&gt;<a class="code" href="classFl__Window.html#a6cc843ffcc711300613e44c678ad682f">modal</a>() || first-&gt;<a class="code" href="classFl__Window.html#a663df072d1d68c5733a1c5f2f88fd819">non_modal</a>())) <a class="code" href="group__fl__windows.html#ga3130407bc1c11f9b7f2a9c43a87a1599">Fl::first_window</a>(window);
<a name="l00764"></a>00764   NSPoint pos = [theEvent locationInWindow];
<a name="l00765"></a>00765   pos.y = window-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>() - pos.<a class="code" href="test_8c.html#a0a2f84ed7838f07779ae24c5a9086d33">y</a>;
<a name="l00766"></a>00766   NSInteger btn = [theEvent buttonNumber]  + 1;
<a name="l00767"></a>00767   NSUInteger mods = [theEvent modifierFlags];  
<a name="l00768"></a>00768   <span class="keywordtype">int</span> sendEvent = 0;
<a name="l00769"></a>00769   
<a name="l00770"></a>00770   NSEventType etype = [theEvent type];
<a name="l00771"></a>00771   <span class="keywordflow">if</span> (etype == NSLeftMouseDown || etype == NSRightMouseDown || etype == NSOtherMouseDown) {
<a name="l00772"></a>00772     <span class="keywordflow">if</span> (btn == 1) <a class="code" href="classFl.html#a2d93787aec60cb62a759b36267dd9d06">Fl::e_state</a> |= <a class="code" href="Enumerations_8H.html#afe37a4db5e516754bb8963cd341bf415" title="Mouse button 1 is pushed.">FL_BUTTON1</a>;
<a name="l00773"></a>00773     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (btn == 3) <a class="code" href="classFl.html#a2d93787aec60cb62a759b36267dd9d06">Fl::e_state</a> |= <a class="code" href="Enumerations_8H.html#a1b597a61f3be6323bce3e8c54283b2b3" title="Mouse button 2 is pushed.">FL_BUTTON2</a>;
<a name="l00774"></a>00774     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (btn == 2) <a class="code" href="classFl.html#a2d93787aec60cb62a759b36267dd9d06">Fl::e_state</a> |= <a class="code" href="Enumerations_8H.html#a9609bc7247660e05194c4e639f84e24e" title="Mouse button 3 is pushed.">FL_BUTTON3</a>;
<a name="l00775"></a>00775   }
<a name="l00776"></a>00776   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (etype == NSLeftMouseUp || etype == NSRightMouseUp || etype == NSOtherMouseUp) {
<a name="l00777"></a>00777     <span class="keywordflow">if</span> (btn == 1) <a class="code" href="classFl.html#a2d93787aec60cb62a759b36267dd9d06">Fl::e_state</a> &amp;= ~<a class="code" href="Enumerations_8H.html#afe37a4db5e516754bb8963cd341bf415" title="Mouse button 1 is pushed.">FL_BUTTON1</a>;
<a name="l00778"></a>00778     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (btn == 3) <a class="code" href="classFl.html#a2d93787aec60cb62a759b36267dd9d06">Fl::e_state</a> &amp;= ~<a class="code" href="Enumerations_8H.html#a1b597a61f3be6323bce3e8c54283b2b3" title="Mouse button 2 is pushed.">FL_BUTTON2</a>;
<a name="l00779"></a>00779     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (btn == 2) <a class="code" href="classFl.html#a2d93787aec60cb62a759b36267dd9d06">Fl::e_state</a> &amp;= ~<a class="code" href="Enumerations_8H.html#a9609bc7247660e05194c4e639f84e24e" title="Mouse button 3 is pushed.">FL_BUTTON3</a>;
<a name="l00780"></a>00780     }
<a name="l00781"></a>00781     
<a name="l00782"></a>00782   <span class="keywordflow">switch</span> ( etype ) {
<a name="l00783"></a>00783     <span class="keywordflow">case</span> NSLeftMouseDown:
<a name="l00784"></a>00784     <span class="keywordflow">case</span> NSRightMouseDown:
<a name="l00785"></a>00785     <span class="keywordflow">case</span> NSOtherMouseDown:
<a name="l00786"></a>00786       suppressed = 0;
<a name="l00787"></a>00787       sendEvent = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a44972d76423f3e380ae12c36827944e3">FL_PUSH</a>;
<a name="l00788"></a>00788       <a class="code" href="classFl.html#ad08a92882f820adac97a6dd98313e9b9">Fl::e_is_click</a> = 1; 
<a name="l00789"></a>00789       px = (<a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>)pos.x; py = (<span class="keywordtype">int</span>)pos.y;
<a name="l00790"></a>00790       <span class="keywordflow">if</span> ([theEvent clickCount] &gt; 1) 
<a name="l00791"></a>00791         <a class="code" href="classFl.html#a6f6c6f8bf78bb722178aa19e501ae60e">Fl::e_clicks</a>++;
<a name="l00792"></a>00792       <span class="keywordflow">else</span>
<a name="l00793"></a>00793         <a class="code" href="classFl.html#a6f6c6f8bf78bb722178aa19e501ae60e">Fl::e_clicks</a> = 0;
<a name="l00794"></a>00794       <span class="comment">// fall through</span>
<a name="l00795"></a>00795     <span class="keywordflow">case</span> NSLeftMouseUp:
<a name="l00796"></a>00796     <span class="keywordflow">case</span> NSRightMouseUp:
<a name="l00797"></a>00797     <span class="keywordflow">case</span> NSOtherMouseUp:
<a name="l00798"></a>00798       <span class="keywordflow">if</span> (suppressed) {
<a name="l00799"></a>00799         suppressed = 0;
<a name="l00800"></a>00800         <span class="keywordflow">break</span>;
<a name="l00801"></a>00801       }
<a name="l00802"></a>00802       <span class="keywordflow">if</span> ( !window ) <span class="keywordflow">break</span>;
<a name="l00803"></a>00803       <span class="keywordflow">if</span> ( !sendEvent ) {
<a name="l00804"></a>00804         sendEvent = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a5949b5ff170a8236d2745eddb1e9fd9a">FL_RELEASE</a>; 
<a name="l00805"></a>00805       }
<a name="l00806"></a>00806       <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> = keysym[ btn ];
<a name="l00807"></a>00807       <span class="comment">// fall through</span>
<a name="l00808"></a>00808     <span class="keywordflow">case</span> NSMouseMoved:
<a name="l00809"></a>00809       suppressed = 0;
<a name="l00810"></a>00810       <span class="keywordflow">if</span> ( !sendEvent ) { 
<a name="l00811"></a>00811         sendEvent = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3acd57cae091eb27c9a52c446bdd0c164d">FL_MOVE</a>; 
<a name="l00812"></a>00812       }
<a name="l00813"></a>00813       <span class="comment">// fall through</span>
<a name="l00814"></a>00814     <span class="keywordflow">case</span> NSLeftMouseDragged:
<a name="l00815"></a>00815     <span class="keywordflow">case</span> NSRightMouseDragged:
<a name="l00816"></a>00816     <span class="keywordflow">case</span> NSOtherMouseDragged: {
<a name="l00817"></a>00817       <span class="keywordflow">if</span> (suppressed) <span class="keywordflow">break</span>;
<a name="l00818"></a>00818       <span class="keywordflow">if</span> ( !sendEvent ) {
<a name="l00819"></a>00819         sendEvent = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3acd57cae091eb27c9a52c446bdd0c164d">FL_MOVE</a>; <span class="comment">// Fl::handle will convert into FL_DRAG</span>
<a name="l00820"></a>00820         <span class="keywordflow">if</span> (fabs(pos.x-px)&gt;5 || fabs(pos.y-py)&gt;5) 
<a name="l00821"></a>00821           <a class="code" href="classFl.html#ad08a92882f820adac97a6dd98313e9b9">Fl::e_is_click</a> = 0;
<a name="l00822"></a>00822       }
<a name="l00823"></a>00823       mods_to_e_state( mods );
<a name="l00824"></a>00824       update_e_xy_and_e_xy_root([theEvent window]);
<a name="l00825"></a>00825       <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>( sendEvent, window );
<a name="l00826"></a>00826       }
<a name="l00827"></a>00827       <span class="keywordflow">break</span>;
<a name="l00828"></a>00828     <span class="keywordflow">default</span>:
<a name="l00829"></a>00829       <span class="keywordflow">break</span>;
<a name="l00830"></a>00830   }
<a name="l00831"></a>00831   
<a name="l00832"></a>00832   <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l00833"></a>00833   
<a name="l00834"></a>00834   <span class="keywordflow">return</span>;
<a name="l00835"></a>00835 }
<a name="l00836"></a>00836 
<a name="l00837"></a>00837 
<a name="l00838"></a>00838 <span class="keyword">static</span> <span class="keywordtype">void</span> calc_e_text(CFStringRef s, <span class="keywordtype">char</span> *buffer, <span class="keywordtype">size_t</span> len, <span class="keywordtype">unsigned</span> sym)
<a name="l00839"></a>00839 {
<a name="l00840"></a>00840   <span class="keywordtype">int</span> <a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>, no_text_key = <span class="keyword">false</span>;
<a name="l00841"></a>00841   <span class="keyword">static</span> <span class="keywordtype">unsigned</span> notext[] = { <span class="comment">// keys that don&#39;t emit text</span>
<a name="l00842"></a>00842     <a class="code" href="Enumerations_8H.html#a20dc86e7758a88b4d1f06323e2de9896" title="The backspace key.">FL_BackSpace</a>, <a class="code" href="Enumerations_8H.html#a4b01dd00e8057590d3778a41920cf80f" title="The print (or print-screen) key.">FL_Print</a>, <a class="code" href="Enumerations_8H.html#a75315b814f32abe29e7b8d0c43be54d9" title="The scroll lock key.">FL_Scroll_Lock</a>, <a class="code" href="Enumerations_8H.html#a701e11753a0c38777cb49989de8f0195" title="The pause key.">FL_Pause</a>,
<a name="l00843"></a>00843     <a class="code" href="Enumerations_8H.html#ae18bfb47b2b5d5579d227d522a3ce32c" title="The insert key.">FL_Insert</a>, <a class="code" href="Enumerations_8H.html#a6fecadc9ecc21f06822c79ced2e45932" title="The home key.">FL_Home</a>, <a class="code" href="Enumerations_8H.html#a35834a5c204afffb06374e25734b5c76" title="The page-up key.">FL_Page_Up</a>, <a class="code" href="Enumerations_8H.html#a323fcf5bab321ec05826a6510a0f1d5a" title="The delete key.">FL_Delete</a>, <a class="code" href="Enumerations_8H.html#a3278d6209799b821e07369aa5dc140ac" title="The end key.">FL_End</a>, <a class="code" href="Enumerations_8H.html#ada4d587d21ab710f44043dafba88e110" title="The page-down key.">FL_Page_Down</a>,
<a name="l00844"></a>00844     <a class="code" href="Enumerations_8H.html#afe89caa1c5019809095a6129156f7c5a" title="The left arrow key.">FL_Left</a>, <a class="code" href="Enumerations_8H.html#a050700391ba0940ca16b0e5dbf4644f0" title="The up arrow key.">FL_Up</a>, <a class="code" href="Enumerations_8H.html#a45679ed656e6b248319719719e894f13" title="The right arrow key.">FL_Right</a>, <a class="code" href="Enumerations_8H.html#a7b70dabd5fc84d90552442584a0e8b91" title="The down arrow key.">FL_Down</a>, 
<a name="l00845"></a>00845     <a class="code" href="Enumerations_8H.html#a3a59855ebd5a902cda138956b5ac80bb" title="The menu key.">FL_Menu</a>, <a class="code" href="Enumerations_8H.html#acf1721eb766274a915bed57acf0e7636" title="The num lock key.">FL_Num_Lock</a>, <a class="code" href="Enumerations_8H.html#aea65b2b57d3d83d1359df6fc538ff0a9" title="The &amp;#39;help&amp;#39; key on Mac keyboards.">FL_Help</a> 
<a name="l00846"></a>00846   };
<a name="l00847"></a>00847   <span class="keywordtype">int</span> count = <span class="keyword">sizeof</span>(notext)/<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>);
<a name="l00848"></a>00848    
<a name="l00849"></a>00849   <span class="keywordflow">if</span> (sym &gt; <a class="code" href="Enumerations_8H.html#ae793aa65307884c2ad99893508d844f2" title="One of the function keys; use FL_F + n for function key n.">FL_F</a> &amp;&amp; sym &lt;= <a class="code" href="Enumerations_8H.html#a104d0fea5c26197d28294d319dd93af3" title="The last function key; use to range-check function keys.">FL_F_Last</a>) no_text_key = <span class="keyword">true</span>;
<a name="l00850"></a>00850   <span class="keywordflow">else</span> <span class="keywordflow">for</span> (i=0; i &lt; count; i++) {
<a name="l00851"></a>00851     <span class="keywordflow">if</span> (notext[i] == sym) {
<a name="l00852"></a>00852       no_text_key = <span class="keyword">true</span>;
<a name="l00853"></a>00853       <span class="keywordflow">break</span>;
<a name="l00854"></a>00854       }
<a name="l00855"></a>00855   }
<a name="l00856"></a>00856   
<a name="l00857"></a>00857   <span class="keywordflow">if</span> (no_text_key) {
<a name="l00858"></a>00858     buffer[0] = 0;
<a name="l00859"></a>00859   } <span class="keywordflow">else</span> {
<a name="l00860"></a>00860     CFStringGetCString(s, buffer, len, kCFStringEncodingUTF8);
<a name="l00861"></a>00861   }
<a name="l00862"></a>00862 }
<a name="l00863"></a>00863 
<a name="l00864"></a>00864 <span class="keyword">static</span> <span class="keywordtype">int</span> cocoaKeyboardHandler(NSEvent *theEvent);
<a name="l00865"></a>00865 
<a name="l00866"></a>00866 <span class="keyword">@interface </span>FLTextView : NSTextView 
<a name="l00867"></a>00867 <span class="comment">// this subclass is needed under OS X &lt;= 10.4 but not under &gt;= 10.5 where the base class is enough</span>
<a name="l00868"></a>00868 {
<a name="l00869"></a>00869 }
<a name="l00870"></a>00870 <span class="keyword">@end</span>
<a name="l00871"></a>00871 <span class="keyword">@implementation </span>FLTextView
<a name="l00872"></a>00872 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)insertText:(<span class="keywordtype">id</span>)aString
<a name="l00873"></a>00873 {
<a name="l00874"></a>00874   cocoaKeyboardHandler([NSApp currentEvent]);
<a name="l00875"></a>00875 }
<a name="l00876"></a>00876 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)doCommandBySelector:(<span class="keywordtype">SEL</span>)aSelector
<a name="l00877"></a>00877 {
<a name="l00878"></a>00878   cocoaKeyboardHandler([NSApp currentEvent]);
<a name="l00879"></a>00879 }
<a name="l00880"></a>00880 <span class="keyword">@end</span>
<a name="l00881"></a>00881 
<a name="l00882"></a>00882 <span class="comment">/*</span>
<a name="l00883"></a>00883 <span class="comment">Handle cocoa keyboard events</span>
<a name="l00884"></a>00884 <span class="comment">Events during a character composition sequence:</span>
<a name="l00885"></a>00885 <span class="comment"> - keydown with deadkey -&gt; [[theEvent characters] length] is 0</span>
<a name="l00886"></a>00886 <span class="comment"> - keyup -&gt; [theEvent characters] contains the deadkey: display it temporarily</span>
<a name="l00887"></a>00887 <span class="comment"> - keydown with next key -&gt; [theEvent characters] contains the composed character: </span>
<a name="l00888"></a>00888 <span class="comment">    replace the temporary character by this one</span>
<a name="l00889"></a>00889 <span class="comment"> - keyup -&gt; [theEvent characters] contains the standard character</span>
<a name="l00890"></a>00890 <span class="comment"> */</span>
<a name="l00891"></a>00891 <span class="keyword">static</span> <span class="keywordtype">int</span> cocoaKeyboardHandler(NSEvent *theEvent)
<a name="l00892"></a>00892 {
<a name="l00893"></a>00893   <span class="keyword">static</span> <span class="keywordtype">char</span> buffer[32];
<a name="l00894"></a>00894   <span class="keywordtype">int</span> sendEvent = 0, retval = 0;
<a name="l00895"></a>00895   <a class="code" href="classFl__Window.html">Fl_Window</a> *window = (<a class="code" href="classFl__Window.html">Fl_Window</a>*)[(FLWindow*)[theEvent window] getFl_Window];
<a name="l00896"></a>00896   <a class="code" href="group__fl__windows.html#ga3130407bc1c11f9b7f2a9c43a87a1599">Fl::first_window</a>(window);
<a name="l00897"></a>00897   NSUInteger mods;
<a name="l00898"></a>00898   
<a name="l00899"></a>00899   <a class="code" href="Fl__mac_8cxx.html#a7c231659c1d4f9ad9126b83cfbcbfb53">fl_lock_function</a>();
<a name="l00900"></a>00900   <span class="comment">// get the modifiers</span>
<a name="l00901"></a>00901   mods = [theEvent modifierFlags];
<a name="l00902"></a>00902   <span class="comment">// get the key code</span>
<a name="l00903"></a>00903   UInt32 keyCode = 0, maskedKeyCode = 0;
<a name="l00904"></a>00904   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> sym = 0;
<a name="l00905"></a>00905   keyCode = [theEvent keyCode];
<a name="l00906"></a>00906   NSString *s = [theEvent characters];  
<a name="l00907"></a>00907   <span class="keywordflow">if</span> ( (mods &amp; NSShiftKeyMask) &amp;&amp; (mods &amp; NSCommandKeyMask) ) {
<a name="l00908"></a>00908     s = [s uppercaseString]; <span class="comment">// US keyboards return lowercase letter in s if cmd-shift-key is hit</span>
<a name="l00909"></a>00909   }
<a name="l00910"></a>00910   <span class="comment">// extended keyboards can also send sequences on key-up to generate Kanji etc. codes.</span>
<a name="l00911"></a>00911   <span class="comment">// Some observed prefixes are 0x81 to 0x83, followed by an 8 bit keycode.</span>
<a name="l00912"></a>00912   <span class="comment">// In this mode, there seem to be no key-down codes</span>
<a name="l00913"></a>00913   <span class="comment">// printf(&quot;%08x %08x %08x\n&quot;, keyCode, mods, key);</span>
<a name="l00914"></a>00914   maskedKeyCode = keyCode &amp; 0x7f;
<a name="l00915"></a>00915   <span class="keywordflow">switch</span>([theEvent <a class="code" href="png_8h.html#a31c258c425e1346a1cd21ffd48f58ace">type</a>]) {
<a name="l00916"></a>00916     <span class="keywordflow">case</span> NSKeyDown:
<a name="l00917"></a>00917       sendEvent = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a1387c0430ec873aa44704954a369143b">FL_KEYBOARD</a>;
<a name="l00918"></a>00918       <span class="comment">// fall through</span>
<a name="l00919"></a>00919     <span class="keywordflow">case</span> NSKeyUp:
<a name="l00920"></a>00920       <span class="keywordflow">if</span> ( !sendEvent ) {
<a name="l00921"></a>00921         sendEvent = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3ab0e1a75a36767b878915e59e5f9e3be8">FL_KEYUP</a>;
<a name="l00922"></a>00922         <a class="code" href="classFl.html#a2d93787aec60cb62a759b36267dd9d06">Fl::e_state</a> &amp;= 0xbfffffff; <span class="comment">// clear the deadkey flag</span>
<a name="l00923"></a>00923       }
<a name="l00924"></a>00924       mods_to_e_state( mods ); <span class="comment">// process modifier keys</span>
<a name="l00925"></a>00925       sym = macKeyLookUp[maskedKeyCode];
<a name="l00926"></a>00926       <span class="keywordflow">if</span> (sym &lt; 0xff00) { <span class="comment">// a &quot;simple&quot; key</span>
<a name="l00927"></a>00927         <span class="comment">// find the result of this key without modifier</span>
<a name="l00928"></a>00928         NSString *sim = [theEvent charactersIgnoringModifiers];
<a name="l00929"></a>00929         UniChar one;
<a name="l00930"></a>00930         CFStringGetCharacters((CFStringRef)sim, CFRangeMake(0, 1), &amp;one);
<a name="l00931"></a>00931         <span class="comment">// charactersIgnoringModifiers doesn&#39;t ignore shift, remove it when it&#39;s on</span>
<a name="l00932"></a>00932         <span class="keywordflow">if</span>(one &gt;= <span class="charliteral">&#39;A&#39;</span> &amp;&amp; one &lt;= <span class="charliteral">&#39;Z&#39;</span>) one += 32;
<a name="l00933"></a>00933         <span class="keywordflow">if</span> (one &gt; 0 &amp;&amp; one &lt;= 0x7f &amp;&amp; (sym&lt;&#39;0&#39; || sym&gt;<span class="charliteral">&#39;9&#39;</span>) ) sym = one;
<a name="l00934"></a>00934       }
<a name="l00935"></a>00935       <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> = <a class="code" href="classFl.html#a2bf425ec2398cff4531b2b8c879fc14e">Fl::e_original_keysym</a> = sym;
<a name="l00936"></a>00936       <span class="comment">// Handle FL_KP_Enter on regular keyboards and on Powerbooks</span>
<a name="l00937"></a>00937       <span class="keywordflow">if</span> ( maskedKeyCode==0x4c || maskedKeyCode==0x34) s = <span class="stringliteral">@&quot;\r&quot;</span>;    
<a name="l00938"></a>00938       calc_e_text((CFStringRef)s, buffer, <span class="keyword">sizeof</span>(buffer), sym);
<a name="l00939"></a>00939       <a class="code" href="classFl.html#a336911cf63dade9bbb9707b942785133">Fl::e_length</a> = strlen(buffer);
<a name="l00940"></a>00940       <a class="code" href="classFl.html#addcd49b68feff0a807f6564f3fdb8016">Fl::e_text</a> = buffer;
<a name="l00941"></a>00941     <span class="keywordflow">default</span>:                    <span class="comment">// prevent &#39;not handled in switch&#39; warnings</span>
<a name="l00942"></a>00942       <span class="keywordflow">break</span>;
<a name="l00943"></a>00943   }
<a name="l00944"></a>00944   <span class="keywordflow">if</span> (sendEvent) {
<a name="l00945"></a>00945     retval = <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>(sendEvent,window);
<a name="l00946"></a>00946   }
<a name="l00947"></a>00947   <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();  
<a name="l00948"></a>00948   <span class="keywordflow">return</span> retval;
<a name="l00949"></a>00949 }
<a name="l00950"></a>00950 
<a name="l00951"></a>00951 
<a name="l00952"></a>00952 <span class="comment">/*</span>
<a name="l00953"></a>00953 <span class="comment"> * Open callback function to call...</span>
<a name="l00954"></a>00954 <span class="comment"> */</span>
<a name="l00955"></a>00955 
<a name="l00956"></a>00956 <span class="keyword">static</span> <a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>     (*<a class="code" href="fluid_8cxx.html#a8fd61bd0e72bddff439d06748df19197">open_cb</a>)(<span class="keyword">const</span> <span class="keywordtype">char</span> *) = 0;
<a name="l00957"></a>00957 
<a name="l00958"></a>00958 
<a name="l00959"></a>00959 <span class="comment">/*</span>
<a name="l00960"></a>00960 <span class="comment"> * Install an open documents event handler...</span>
<a name="l00961"></a>00961 <span class="comment"> */</span>
<a name="l00962"></a>00962 <span class="keyword">@interface </span>FLAppleEventHandler : NSObject
<a name="l00963"></a>00963 {
<a name="l00964"></a>00964 }
<a name="l00965"></a>00965 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)handleAppleEvent:(NSAppleEventDescriptor *)event withReplyEvent: (NSAppleEventDescriptor *)replyEvent;
<a name="l00966"></a>00966 <span class="keyword">@end</span>
<a name="l00967"></a>00967 <span class="keyword">@implementation </span>FLAppleEventHandler
<a name="l00968"></a>00968 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)handleAppleEvent:(NSAppleEventDescriptor *)event withReplyEvent: (NSAppleEventDescriptor *)replyEvent
<a name="l00969"></a>00969 {
<a name="l00970"></a>00970   NSAppleEventDescriptor *single = [event descriptorAtIndex:1];
<a name="l00971"></a>00971   <span class="keyword">const</span> AEDesc *document = [single aeDesc];
<a name="l00972"></a>00972   <span class="keywordtype">long</span> <a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>, n;
<a name="l00973"></a>00973   FSRef fileRef;
<a name="l00974"></a>00974   AEKeyword keyWd;
<a name="l00975"></a>00975   DescType typeCd;
<a name="l00976"></a>00976   Size actSz;
<a name="l00977"></a>00977   <span class="keywordtype">char</span> filename[1024];
<a name="l00978"></a>00978   <span class="comment">// Lock access to FLTK in this thread...</span>
<a name="l00979"></a>00979   <a class="code" href="Fl__mac_8cxx.html#a7c231659c1d4f9ad9126b83cfbcbfb53">fl_lock_function</a>();
<a name="l00980"></a>00980   
<a name="l00981"></a>00981   <span class="comment">// Open the documents via the callback...</span>
<a name="l00982"></a>00982   <span class="keywordflow">if</span> (AECountItems(document, &amp;n) == noErr) {
<a name="l00983"></a>00983     <span class="keywordflow">for</span> (i = 1; i &lt;= n; i ++) {
<a name="l00984"></a>00984       AEGetNthPtr(document, i, typeFSRef, &amp;keyWd, &amp;typeCd,
<a name="l00985"></a>00985                   (Ptr)&amp;fileRef, <span class="keyword">sizeof</span>(fileRef),
<a name="l00986"></a>00986                   (actSz = <span class="keyword">sizeof</span>(fileRef), &amp;actSz));
<a name="l00987"></a>00987       FSRefMakePath( &amp;fileRef, (UInt8*)filename, <span class="keyword">sizeof</span>(filename) );
<a name="l00988"></a>00988       
<a name="l00989"></a>00989       (*open_cb)(filename);
<a name="l00990"></a>00990     }
<a name="l00991"></a>00991   }
<a name="l00992"></a>00992   <span class="comment">// Unlock access to FLTK for all threads...</span>
<a name="l00993"></a>00993   <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l00994"></a>00994 }
<a name="l00995"></a>00995 <span class="keyword">@end</span>
<a name="l00996"></a>00996 
<a name="l00997"></a>00997 <span class="keywordtype">void</span> <a class="code" href="group__group__macosx.html#ga0702a54934d10f5b72157137cf291296" title="Register a function called for each file dropped onto an application icon.">fl_open_callback</a>(<span class="keywordtype">void</span> (*cb)(<span class="keyword">const</span> <span class="keywordtype">char</span> *)) {
<a name="l00998"></a>00998   <span class="keyword">static</span> NSAppleEventManager *aeventmgr = nil;
<a name="l00999"></a>00999   <span class="keyword">static</span> FLAppleEventHandler *handler;
<a name="l01000"></a>01000   <a class="code" href="mac_8H.html#a94ee21d83137569a6730e3e2e7305cbc">fl_open_display</a>();
<a name="l01001"></a>01001   <span class="keywordflow">if</span> (!aeventmgr) {
<a name="l01002"></a>01002     aeventmgr = [NSAppleEventManager sharedAppleEventManager];
<a name="l01003"></a>01003     handler = [[FLAppleEventHandler alloc] init];
<a name="l01004"></a>01004   }
<a name="l01005"></a>01005   
<a name="l01006"></a>01006   <a class="code" href="fluid_8cxx.html#a8fd61bd0e72bddff439d06748df19197">open_cb</a> = cb;
<a name="l01007"></a>01007   <span class="keywordflow">if</span> (cb) {
<a name="l01008"></a>01008     [aeventmgr setEventHandler:handler andSelector:@selector(handleAppleEvent:withReplyEvent:) 
<a name="l01009"></a>01009                  forEventClass:kCoreEventClass andEventID:kAEOpenDocuments];
<a name="l01010"></a>01010   } <span class="keywordflow">else</span> {
<a name="l01011"></a>01011     [aeventmgr removeEventHandlerForEventClass:kCoreEventClass andEventID:kAEOpenDocuments];  
<a name="l01012"></a>01012   }
<a name="l01013"></a>01013 }
<a name="l01014"></a>01014 
<a name="l01015"></a>01015 
<a name="l01016"></a>01016 <span class="comment">/*</span>
<a name="l01017"></a>01017 <span class="comment"> * initialize the Mac toolboxes, dock status, and set the default menubar</span>
<a name="l01018"></a>01018 <span class="comment"> */</span>
<a name="l01019"></a>01019 
<a name="l01020"></a>01020 <span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> {
<a name="l01021"></a>01021   <span class="keyword">extern</span> OSErr <a class="code" href="Fl__mac_8cxx.html#a880cd3b5aeb631803bd99a81dc604004">CPSEnableForegroundOperation</a>(ProcessSerialNumber *psn, UInt32 _arg2,
<a name="l01022"></a>01022                                             UInt32 _arg3, UInt32 _arg4, UInt32 _arg5);
<a name="l01023"></a>01023 }
<a name="l01024"></a>01024 
<a name="l01025"></a>01025 
<a name="l01026"></a>01026 <span class="keyword">@interface </span>FLDelegate : NSObject 
<a name="l01027"></a>01027 <span class="preprocessor">#if MAC_OS_X_VERSION_MAX_ALLOWED &gt;= MAC_OS_X_VERSION_10_6</span>
<a name="l01028"></a>01028 <span class="preprocessor"></span>&lt;NSWindowDelegate, NSApplicationDelegate&gt;
<a name="l01029"></a>01029 <span class="preprocessor">#endif</span>
<a name="l01030"></a>01030 <span class="preprocessor"></span>{
<a name="l01031"></a>01031 }
<a name="l01032"></a>01032 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)windowDidMove:(NSNotification *)notif;
<a name="l01033"></a>01033 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)windowDidResize:(NSNotification *)notif;
<a name="l01034"></a>01034 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)windowDidBecomeKey:(NSNotification *)notif;
<a name="l01035"></a>01035 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)windowDidBecomeMain:(NSNotification *)notif;
<a name="l01036"></a>01036 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)windowDidDeminiaturize:(NSNotification *)notif;
<a name="l01037"></a>01037 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)windowDidMiniaturize:(NSNotification *)notif;
<a name="l01038"></a>01038 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)windowWillClose:(NSNotification *)notif;
<a name="l01039"></a>01039 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)anywindowwillclosenotif:(NSNotification *)notif;
<a name="l01040"></a>01040 - (NSApplicationTerminateReply)applicationShouldTerminate:(NSApplication*)sender;
<a name="l01041"></a>01041 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)applicationDidBecomeActive:(NSNotification *)notify;
<a name="l01042"></a>01042 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)applicationWillResignActive:(NSNotification *)notify;
<a name="l01043"></a>01043 - (<a class="code" href="structid.html">id</a>)windowWillReturnFieldEditor:(NSWindow *)sender toObject:(<span class="keywordtype">id</span>)client;
<a name="l01044"></a>01044 <span class="keyword">@end</span>
<a name="l01045"></a>01045 <span class="keyword">@implementation </span>FLDelegate
<a name="l01046"></a>01046 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)windowDidMove:(NSNotification *)notif
<a name="l01047"></a>01047 {
<a name="l01048"></a>01048   FLWindow *nsw = (FLWindow*)[notif <span class="keywordtype">object</span>];
<a name="l01049"></a>01049   <a class="code" href="classFl__Window.html">Fl_Window</a> *window = [nsw getFl_Window];
<a name="l01050"></a>01050   NSPoint pt, pt2; 
<a name="l01051"></a>01051   pt.<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a> = 0;
<a name="l01052"></a>01052   pt.y = [[nsw contentView] frame].size.height;
<a name="l01053"></a>01053   pt2 = [nsw convertBaseToScreen:pt];
<a name="l01054"></a>01054   update_e_xy_and_e_xy_root(nsw);
<a name="l01055"></a>01055   window-&gt;<a class="code" href="classFl__Widget.html#ac45bdb80c3e66c571d0420ebefd4aaa5">position</a>((<span class="keywordtype">int</span>)pt2.x, (<span class="keywordtype">int</span>)([[nsw screen] frame].size.height - pt2.y));
<a name="l01056"></a>01056   <span class="keywordflow">if</span> ([nsw containsGLsubwindow] ) {
<a name="l01057"></a>01057     [nsw display];<span class="comment">// redraw window after moving if it contains OpenGL subwindows</span>
<a name="l01058"></a>01058   }
<a name="l01059"></a>01059 }
<a name="l01060"></a>01060 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)windowDidResize:(NSNotification *)notif
<a name="l01061"></a>01061 {
<a name="l01062"></a>01062   FLWindow *nsw = (FLWindow*)[notif <span class="keywordtype">object</span>];
<a name="l01063"></a>01063   <a class="code" href="classFl__Window.html">Fl_Window</a> *window = [nsw getFl_Window];
<a name="l01064"></a>01064   NSRect r = [[nsw contentView] frame];
<a name="l01065"></a>01065   NSPoint pt, pt2; 
<a name="l01066"></a>01066   pt.<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a> = 0;
<a name="l01067"></a>01067   pt.y = [[nsw contentView] frame].size.height;
<a name="l01068"></a>01068   pt2 = [nsw convertBaseToScreen:pt];
<a name="l01069"></a>01069   resize_from_system = window;
<a name="l01070"></a>01070   update_e_xy_and_e_xy_root(nsw);
<a name="l01071"></a>01071   window-&gt;<a class="code" href="classFl__Window.html#a7b3f27fe1b0fbc2a06065a7f037a2fbb">resize</a>((<span class="keywordtype">int</span>)pt2.x, 
<a name="l01072"></a>01072                  (<span class="keywordtype">int</span>)([[nsw screen] frame].size.height - pt2.y),
<a name="l01073"></a>01073                  (<span class="keywordtype">int</span>)r.size.width,
<a name="l01074"></a>01074                  (<span class="keywordtype">int</span>)r.size.height);
<a name="l01075"></a>01075 }
<a name="l01076"></a>01076 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)windowDidBecomeKey:(NSNotification *)notif
<a name="l01077"></a>01077 {
<a name="l01078"></a>01078   FLWindow *nsw = (FLWindow*)[notif <span class="keywordtype">object</span>];
<a name="l01079"></a>01079   <a class="code" href="classFl__Window.html">Fl_Window</a> *window = [nsw getFl_Window];
<a name="l01080"></a>01080   <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>( <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3adaac2a187beb309443d668a20a59986b">FL_FOCUS</a>, window);
<a name="l01081"></a>01081 }
<a name="l01082"></a>01082 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)windowDidBecomeMain:(NSNotification *)notif
<a name="l01083"></a>01083 {
<a name="l01084"></a>01084   FLWindow *nsw = (FLWindow*)[notif <span class="keywordtype">object</span>];
<a name="l01085"></a>01085   <a class="code" href="classFl__Window.html">Fl_Window</a> *window = [nsw getFl_Window];
<a name="l01086"></a>01086   <a class="code" href="group__fl__windows.html#ga3130407bc1c11f9b7f2a9c43a87a1599">Fl::first_window</a>(window);
<a name="l01087"></a>01087   update_e_xy_and_e_xy_root(nsw);
<a name="l01088"></a>01088 }
<a name="l01089"></a>01089 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)windowDidDeminiaturize:(NSNotification *)notif
<a name="l01090"></a>01090 {
<a name="l01091"></a>01091   FLWindow *nsw = (FLWindow*)[notif <span class="keywordtype">object</span>];
<a name="l01092"></a>01092   <a class="code" href="classFl__Window.html">Fl_Window</a> *window = [nsw getFl_Window];
<a name="l01093"></a>01093   window-&gt;<a class="code" href="classFl__Widget.html#a85981546c4927bd5e6d43d6e3df3416a">set_visible</a>();
<a name="l01094"></a>01094   update_e_xy_and_e_xy_root(nsw);
<a name="l01095"></a>01095 }
<a name="l01096"></a>01096 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)windowDidMiniaturize:(NSNotification *)notif
<a name="l01097"></a>01097 {
<a name="l01098"></a>01098   FLWindow *nsw = (FLWindow*)[notif <span class="keywordtype">object</span>];
<a name="l01099"></a>01099   <a class="code" href="classFl__Window.html">Fl_Window</a> *window = [nsw getFl_Window];
<a name="l01100"></a>01100   window-&gt;<a class="code" href="classFl__Widget.html#a19e89bf3b3d2e418b772739ffa6e24d7">clear_visible</a>();
<a name="l01101"></a>01101 }
<a name="l01102"></a>01102 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)windowWillClose:(NSNotification *)notif
<a name="l01103"></a>01103 {
<a name="l01104"></a>01104   <a class="code" href="classFl__Window.html">Fl_Window</a> *w = <a class="code" href="group__fl__windows.html#ga3130407bc1c11f9b7f2a9c43a87a1599">Fl::first_window</a>();
<a name="l01105"></a>01105   <span class="keywordflow">if</span> (!w) <span class="keywordflow">return</span>;
<a name="l01106"></a>01106   NSWindow *cw = (NSWindow*)<a class="code" href="classFl__X.html#ae4c6997d92cf8ad3a75a962d7ae77c34">Fl_X::i</a>(w)-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>;
<a name="l01107"></a>01107   <span class="keywordflow">if</span> ( ![cw isMiniaturized] &amp;&amp; ([cw styleMask] &amp; NSTitledWindowMask) ) {
<a name="l01108"></a>01108     <span class="keywordflow">if</span> (![cw isKeyWindow]) {    <span class="comment">// always make Fl::first_window() the key widow</span>
<a name="l01109"></a>01109       [cw makeKeyAndOrderFront:nil];
<a name="l01110"></a>01110     }
<a name="l01111"></a>01111     <span class="keywordflow">if</span> (![cw isMainWindow]) {   <span class="comment">// always make Fl::first_window() the main widow</span>
<a name="l01112"></a>01112       [cw makeMainWindow];
<a name="l01113"></a>01113     }
<a name="l01114"></a>01114   }
<a name="l01115"></a>01115 }
<a name="l01116"></a>01116 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)anywindowwillclosenotif:(NSNotification *)notif
<a name="l01117"></a>01117 {
<a name="l01118"></a>01118   <span class="comment">// necessary so that after closing a non-FLTK window (e.g., Fl_Native_File_Chooser)</span>
<a name="l01119"></a>01119   <span class="comment">// the front window turns key again</span>
<a name="l01120"></a>01120   NSWindow *closing = (NSWindow*)[notif <span class="keywordtype">object</span>];
<a name="l01121"></a>01121   <span class="keywordflow">if</span> ([closing isMemberOfClass:[FLWindow <span class="keyword">class</span>]]) <span class="keywordflow">return</span>;
<a name="l01122"></a>01122   NSWindow *nsk = [NSApp keyWindow];
<a name="l01123"></a>01123   NSWindow *nsm = [NSApp mainWindow];
<a name="l01124"></a>01124   <span class="keywordflow">if</span> ([nsm isMemberOfClass:[FLWindow <span class="keyword">class</span>]] &amp;&amp; nsk == nil) {
<a name="l01125"></a>01125     [nsm makeKeyAndOrderFront:nil];
<a name="l01126"></a>01126   }
<a name="l01127"></a>01127 }
<a name="l01128"></a>01128 - (NSApplicationTerminateReply)applicationShouldTerminate:(NSApplication*)sender
<a name="l01129"></a>01129 {
<a name="l01130"></a>01130   <a class="code" href="Fl__mac_8cxx.html#a7c231659c1d4f9ad9126b83cfbcbfb53">fl_lock_function</a>();
<a name="l01131"></a>01131   NSApplicationTerminateReply reply = NSTerminateNow;
<a name="l01132"></a>01132   <span class="keywordflow">while</span> ( <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a> ) {
<a name="l01133"></a>01133     <a class="code" href="classFl__X.html">Fl_X</a> *x = <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a>;
<a name="l01134"></a>01134     <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>( <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a42828f08af2b2191bbc60e113ec08f01">FL_CLOSE</a>, x-&gt;<a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a> );
<a name="l01135"></a>01135     <span class="keywordflow">if</span> ( <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a> == x ) {
<a name="l01136"></a>01136       reply = NSTerminateCancel; <span class="comment">// FLTK has not closed all windows, so we return to the main program now</span>
<a name="l01137"></a>01137       <span class="keywordflow">break</span>;
<a name="l01138"></a>01138     }
<a name="l01139"></a>01139   }
<a name="l01140"></a>01140   <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l01141"></a>01141   <span class="keywordflow">return</span> reply;
<a name="l01142"></a>01142 }
<a name="l01148"></a>01148 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)applicationDidBecomeActive:(NSNotification *)notify
<a name="l01149"></a>01149 {
<a name="l01150"></a>01150   <a class="code" href="classFl__X.html">Fl_X</a> *<a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>;
<a name="l01151"></a>01151   FLWindow *top = 0, *topModal = 0, *topNonModal = 0;
<a name="l01152"></a>01152   <span class="keywordflow">for</span> (x = <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a>;<a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>;x = x-&gt;<a class="code" href="classFl__X.html#a41f6a721a953ea62021bb1dd9c4f2187">next</a>) {
<a name="l01153"></a>01153     FLWindow *cw = (FLWindow*)x-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>;
<a name="l01154"></a>01154     <a class="code" href="classFl__Window.html">Fl_Window</a> *win = x-&gt;<a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>;
<a name="l01155"></a>01155     if (win &amp;&amp; cw) {
<a name="l01156"></a>01156       <span class="keywordflow">if</span> (win-&gt;modal()) {
<a name="l01157"></a>01157         [cw setLevel:NSModalPanelWindowLevel];
<a name="l01158"></a>01158         <span class="keywordflow">if</span> (topModal) 
<a name="l01159"></a>01159           [cw orderWindow:NSWindowBelow relativeTo:[topModal windowNumber]];
<a name="l01160"></a>01160         <span class="keywordflow">else</span>
<a name="l01161"></a>01161           topModal = cw;
<a name="l01162"></a>01162       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (win-&gt;non_modal()) {
<a name="l01163"></a>01163         [cw setLevel:NSFloatingWindowLevel];
<a name="l01164"></a>01164         <span class="keywordflow">if</span> (topNonModal) 
<a name="l01165"></a>01165           [cw orderWindow:NSWindowBelow relativeTo:[topNonModal windowNumber]];
<a name="l01166"></a>01166         <span class="keywordflow">else</span>
<a name="l01167"></a>01167           topNonModal = cw;
<a name="l01168"></a>01168       } <span class="keywordflow">else</span> {
<a name="l01169"></a>01169         <span class="keywordflow">if</span> (top) 
<a name="l01170"></a>01170           ;
<a name="l01171"></a>01171         <span class="keywordflow">else</span>
<a name="l01172"></a>01172           top = cw;
<a name="l01173"></a>01173       }
<a name="l01174"></a>01174     }
<a name="l01175"></a>01175   }
<a name="l01176"></a>01176 }
<a name="l01177"></a>01177 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)applicationWillResignActive:(NSNotification *)notify
<a name="l01178"></a>01178 {
<a name="l01179"></a>01179   <a class="code" href="classFl__X.html">Fl_X</a> *<a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>;
<a name="l01180"></a>01180   FLWindow *top = 0;
<a name="l01181"></a>01181   <span class="comment">// sort in all regular windows</span>
<a name="l01182"></a>01182   <span class="keywordflow">for</span> (x = <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a>;<a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>;x = x-&gt;<a class="code" href="classFl__X.html#a41f6a721a953ea62021bb1dd9c4f2187">next</a>) {
<a name="l01183"></a>01183     FLWindow *cw = (FLWindow*)x-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>;
<a name="l01184"></a>01184     <a class="code" href="classFl__Window.html">Fl_Window</a> *win = x-&gt;<a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>;
<a name="l01185"></a>01185     if (win &amp;&amp; cw) {
<a name="l01186"></a>01186       <span class="keywordflow">if</span> (win-&gt;modal()) {
<a name="l01187"></a>01187       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (win-&gt;non_modal()) {
<a name="l01188"></a>01188       } <span class="keywordflow">else</span> {
<a name="l01189"></a>01189         <span class="keywordflow">if</span> (!top) top = cw;
<a name="l01190"></a>01190       }
<a name="l01191"></a>01191     }
<a name="l01192"></a>01192   }
<a name="l01193"></a>01193   <span class="comment">// now sort in all modals</span>
<a name="l01194"></a>01194   <span class="keywordflow">for</span> (x = <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a>;<a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>;x = x-&gt;<a class="code" href="classFl__X.html#a41f6a721a953ea62021bb1dd9c4f2187">next</a>) {
<a name="l01195"></a>01195     FLWindow *cw = (FLWindow*)x-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>;
<a name="l01196"></a>01196     <a class="code" href="classFl__Window.html">Fl_Window</a> *win = x-&gt;<a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>;
<a name="l01197"></a>01197     if (win &amp;&amp; cw) {
<a name="l01198"></a>01198       <span class="keywordflow">if</span> (win-&gt;modal()) {
<a name="l01199"></a>01199         [cw setLevel:NSNormalWindowLevel];
<a name="l01200"></a>01200         <span class="keywordflow">if</span> (top) [cw orderWindow:NSWindowAbove relativeTo:[top windowNumber]];
<a name="l01201"></a>01201       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (win-&gt;non_modal()) {
<a name="l01202"></a>01202       } <span class="keywordflow">else</span> {
<a name="l01203"></a>01203       }
<a name="l01204"></a>01204     }
<a name="l01205"></a>01205   }
<a name="l01206"></a>01206   <span class="comment">// finally all non-modals</span>
<a name="l01207"></a>01207   <span class="keywordflow">for</span> (x = <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a>;<a class="code" href="test_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>;x = x-&gt;<a class="code" href="classFl__X.html#a41f6a721a953ea62021bb1dd9c4f2187">next</a>) {
<a name="l01208"></a>01208     FLWindow *cw = (FLWindow*)x-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>;
<a name="l01209"></a>01209     <a class="code" href="classFl__Window.html">Fl_Window</a> *win = x-&gt;<a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>;
<a name="l01210"></a>01210     if (win &amp;&amp; cw) {
<a name="l01211"></a>01211       <span class="keywordflow">if</span> (win-&gt;modal()) {
<a name="l01212"></a>01212       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (win-&gt;non_modal()) {
<a name="l01213"></a>01213         [cw setLevel:NSNormalWindowLevel];
<a name="l01214"></a>01214         <span class="keywordflow">if</span> (top) [cw orderWindow:NSWindowAbove relativeTo:[top windowNumber]];
<a name="l01215"></a>01215       } <span class="keywordflow">else</span> {
<a name="l01216"></a>01216       }
<a name="l01217"></a>01217     }
<a name="l01218"></a>01218   }
<a name="l01219"></a>01219 }
<a name="l01220"></a>01220 - (<a class="code" href="structid.html">id</a>)windowWillReturnFieldEditor:(NSWindow *)sender toObject:(<span class="keywordtype">id</span>)client
<a name="l01221"></a>01221 {
<a name="l01222"></a>01222   NSRect rect={{0,0},{20,20}};
<a name="l01223"></a>01223   <span class="keyword">static</span> FLTextView *view = nil;
<a name="l01224"></a>01224   <span class="keywordflow">if</span> (!view) {
<a name="l01225"></a>01225     view = [[FLTextView alloc] initWithFrame:rect];
<a name="l01226"></a>01226   }
<a name="l01227"></a>01227   <span class="keywordflow">return</span> view;
<a name="l01228"></a>01228 }
<a name="l01229"></a>01229 <span class="keyword">@end</span>
<a name="l01230"></a>01230 
<a name="l01231"></a>01231 <span class="keyword">@interface </span>FLApplication : NSApplication
<a name="l01232"></a>01232 {
<a name="l01233"></a>01233 }
<a name="l01234"></a>01234 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)sendEvent:(NSEvent *)theEvent;
<a name="l01235"></a>01235 <span class="keyword">@end</span>
<a name="l01236"></a>01236 <span class="keyword">@implementation </span>FLApplication
<a name="l01237"></a>01237 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)sendEvent:(NSEvent *)theEvent
<a name="l01238"></a>01238 {
<a name="l01239"></a>01239   NSEventType type = [theEvent type];  
<a name="l01240"></a>01240   <span class="keywordflow">if</span> (type == NSLeftMouseDown) {
<a name="l01241"></a>01241     <a class="code" href="classFl__Window.html">Fl_Window</a> *grab = <a class="code" href="group__fl__windows.html#ga100705a8107397cfde7318aa34019739">Fl::grab</a>();
<a name="l01242"></a>01242     <span class="keywordflow">if</span> (grab &amp;&amp; grab != [(FLWindow *)[theEvent window] getFl_Window]) {
<a name="l01243"></a>01243       <span class="comment">// a click event out of a menu window, so we should close this menu</span>
<a name="l01244"></a>01244       <span class="comment">// done here to catch also clicks on window title bar/resize box </span>
<a name="l01245"></a>01245       cocoaMouseHandler(theEvent);
<a name="l01246"></a>01246     }
<a name="l01247"></a>01247   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == NSApplicationDefined) {
<a name="l01248"></a>01248     <span class="keywordflow">if</span> ([theEvent subtype] == FLTKDataReadyEvent) {
<a name="l01249"></a>01249       processFLTKEvent();
<a name="l01250"></a>01250     }
<a name="l01251"></a>01251     <span class="keywordflow">return</span>;
<a name="l01252"></a>01252   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == NSKeyUp) {
<a name="l01253"></a>01253     <span class="comment">// The default sendEvent turns key downs into performKeyEquivalent when</span>
<a name="l01254"></a>01254     <span class="comment">// modifiers are down, but swallows the key up if the modifiers include</span>
<a name="l01255"></a>01255     <span class="comment">// command.  This one makes all modifiers consistent by always sending key ups.</span>
<a name="l01256"></a>01256     <span class="comment">// FLView treats performKeyEquivalent to keyDown, but performKeyEquivalent is</span>
<a name="l01257"></a>01257     <span class="comment">// still needed for the system menu.</span>
<a name="l01258"></a>01258     [[<span class="keyword">self</span> keyWindow] sendEvent:theEvent];
<a name="l01259"></a>01259     <span class="keywordflow">return</span>;
<a name="l01260"></a>01260     }
<a name="l01261"></a>01261   [<span class="keyword">super</span> sendEvent:theEvent]; 
<a name="l01262"></a>01262 }
<a name="l01263"></a>01263 <span class="keyword">@end</span>
<a name="l01264"></a>01264 
<a name="l01265"></a>01265 <span class="keyword">static</span> FLDelegate *mydelegate;
<a name="l01266"></a>01266 
<a name="l01267"></a>01267 <span class="keywordtype">void</span> <a class="code" href="mac_8H.html#a94ee21d83137569a6730e3e2e7305cbc">fl_open_display</a>() {
<a name="l01268"></a>01268   <span class="keyword">static</span> <span class="keywordtype">char</span> beenHereDoneThat = 0;
<a name="l01269"></a>01269   <span class="keywordflow">if</span> ( !beenHereDoneThat ) {
<a name="l01270"></a>01270     beenHereDoneThat = 1;
<a name="l01271"></a>01271           
<a name="l01272"></a>01272     [FLApplication sharedApplication];
<a name="l01273"></a>01273     NSAutoreleasePool *localPool;
<a name="l01274"></a>01274     localPool = [[NSAutoreleasePool alloc] init]; <span class="comment">// never released</span>
<a name="l01275"></a>01275     mydelegate = [[FLDelegate alloc] init];
<a name="l01276"></a>01276     [NSApp setDelegate:mydelegate];
<a name="l01277"></a>01277     [NSApp finishLaunching];
<a name="l01278"></a>01278                 
<a name="l01279"></a>01279     <span class="comment">// empty the event queue but keep system events for drag&amp;drop of files at launch</span>
<a name="l01280"></a>01280     NSEvent *ign_event;
<a name="l01281"></a>01281     <span class="keywordflow">do</span> ign_event = [NSApp nextEventMatchingMask:(NSAnyEventMask &amp; ~NSSystemDefinedMask)
<a name="l01282"></a>01282                                         untilDate:[NSDate dateWithTimeIntervalSinceNow:0] 
<a name="l01283"></a>01283                                            inMode:NSDefaultRunLoopMode 
<a name="l01284"></a>01284                                           dequeue:YES];
<a name="l01285"></a>01285     <span class="keywordflow">while</span> (ign_event);
<a name="l01286"></a>01286     
<a name="l01287"></a>01287     <a class="code" href="win32_8H.html#a5c84f195de614f6aa79fa2f8883b37b6">fl_default_cursor</a> = [NSCursor arrowCursor];
<a name="l01288"></a>01288     SInt32 <a class="code" href="jpeglib_8h.html#aad880fc4455c253781e8968f2239d56f">version</a>;
<a name="l01289"></a>01289     Gestalt(gestaltSystemVersion, &amp;version);
<a name="l01290"></a>01290     <a class="code" href="group__group__macosx.html#ga2c7db6b2ea9a6ae37a26bea810d2056c" title="The version number of the running Mac OS X (e.g., 0x1064 for 10.6.4)">fl_mac_os_version</a> = (<a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>)version;
<a name="l01291"></a>01291 
<a name="l01292"></a>01292     <span class="comment">// bring the application into foreground without a &#39;CARB&#39; resource</span>
<a name="l01293"></a>01293     Boolean same_psn;
<a name="l01294"></a>01294     ProcessSerialNumber cur_psn, front_psn;
<a name="l01295"></a>01295     <span class="keywordflow">if</span> ( !GetCurrentProcess( &amp;cur_psn ) &amp;&amp; !GetFrontProcess( &amp;front_psn ) &amp;&amp;
<a name="l01296"></a>01296          !SameProcess( &amp;front_psn, &amp;cur_psn, &amp;same_psn ) &amp;&amp; !same_psn ) {
<a name="l01297"></a>01297       <span class="comment">// only transform the application type for unbundled apps</span>
<a name="l01298"></a>01298       CFBundleRef bundle = CFBundleGetMainBundle();
<a name="l01299"></a>01299       <span class="keywordflow">if</span> ( bundle ) {
<a name="l01300"></a>01300         FSRef execFs;
<a name="l01301"></a>01301         CFURLRef execUrl = CFBundleCopyExecutableURL( bundle );
<a name="l01302"></a>01302         CFURLGetFSRef( execUrl, &amp;execFs );
<a name="l01303"></a>01303         
<a name="l01304"></a>01304         FSRef bundleFs;
<a name="l01305"></a>01305         GetProcessBundleLocation( &amp;cur_psn, &amp;bundleFs );
<a name="l01306"></a>01306         
<a name="l01307"></a>01307         <span class="keywordflow">if</span> ( !FSCompareFSRefs( &amp;execFs, &amp;bundleFs ) )
<a name="l01308"></a>01308           bundle = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01309"></a>01309         
<a name="l01310"></a>01310         CFRelease(execUrl);
<a name="l01311"></a>01311       }
<a name="l01312"></a>01312             
<a name="l01313"></a>01313       <span class="keywordflow">if</span> ( !bundle )
<a name="l01314"></a>01314       {
<a name="l01315"></a>01315         <span class="comment">// Earlier versions of this code tried to use weak linking, however it</span>
<a name="l01316"></a>01316         <span class="comment">// appears that this does not work on 10.2.  Since 10.3 and higher provide</span>
<a name="l01317"></a>01317         <span class="comment">// both TransformProcessType and CPSEnableForegroundOperation, the following</span>
<a name="l01318"></a>01318         <span class="comment">// conditional code compiled on 10.2 will still work on newer releases...</span>
<a name="l01319"></a>01319         OSErr err;
<a name="l01320"></a>01320 <span class="preprocessor">#if __LP64__</span>
<a name="l01321"></a>01321 <span class="preprocessor"></span>        err = TransformProcessType(&amp;cur_psn, kProcessTransformToForegroundApplication);
<a name="l01322"></a>01322 <span class="preprocessor">#else</span>
<a name="l01323"></a>01323 <span class="preprocessor"></span>        
<a name="l01324"></a>01324 <span class="preprocessor">#if MAC_OS_X_VERSION_MAX_ALLOWED &gt; MAC_OS_X_VERSION_10_2</span>
<a name="l01325"></a>01325 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (TransformProcessType != <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01326"></a>01326           err = TransformProcessType(&amp;cur_psn, kProcessTransformToForegroundApplication);
<a name="l01327"></a>01327         } <span class="keywordflow">else</span>
<a name="l01328"></a>01328 <span class="preprocessor">#endif // MAC_OS_X_VERSION_MAX_ALLOWED &gt; MAC_OS_X_VERSION_10_2</span>
<a name="l01329"></a>01329 <span class="preprocessor"></span>          err = <a class="code" href="Fl__mac_8cxx.html#a880cd3b5aeb631803bd99a81dc604004">CPSEnableForegroundOperation</a>(&amp;cur_psn, 0x03, 0x3C, 0x2C, 0x1103);
<a name="l01330"></a>01330 <span class="preprocessor">#endif // __LP64__</span>
<a name="l01331"></a>01331 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (err == noErr) {
<a name="l01332"></a>01332           SetFrontProcess( &amp;cur_psn );
<a name="l01333"></a>01333         }
<a name="l01334"></a>01334       }
<a name="l01335"></a>01335     }
<a name="l01336"></a>01336     createAppleMenu();
<a name="l01337"></a>01337     
<a name="l01338"></a>01338     [[NSNotificationCenter defaultCenter] addObserver:mydelegate 
<a name="l01339"></a>01339                selector:@selector(anywindowwillclosenotif:) 
<a name="l01340"></a>01340                    name:NSWindowWillCloseNotification 
<a name="l01341"></a>01341                  object:nil];
<a name="l01342"></a>01342   }
<a name="l01343"></a>01343 }
<a name="l01344"></a>01344 
<a name="l01345"></a>01345 
<a name="l01346"></a>01346 <span class="comment">/*</span>
<a name="l01347"></a>01347 <span class="comment"> * get rid of allocated resources</span>
<a name="l01348"></a>01348 <span class="comment"> */</span>
<a name="l01349"></a>01349 <span class="keywordtype">void</span> <a class="code" href="x_8H.html#ade3ae56765e00bc95627ff95c63cd2d7">fl_close_display</a>() {
<a name="l01350"></a>01350 }
<a name="l01351"></a>01351 
<a name="l01352"></a>01352 
<a name="l01353"></a>01353 <span class="comment">// Gets the border sizes and the titlebar size</span>
<a name="l01354"></a>01354 <span class="keyword">static</span> <span class="keywordtype">void</span> get_window_frame_sizes(<span class="keywordtype">int</span> &amp;bx, <span class="keywordtype">int</span> &amp;by, <span class="keywordtype">int</span> &amp;bt) {
<a name="l01355"></a>01355   NSAutoreleasePool *localPool;
<a name="l01356"></a>01356   localPool = [[NSAutoreleasePool alloc] init]; 
<a name="l01357"></a>01357   NSRect inside = { {20,20}, {100,100} };
<a name="l01358"></a>01358   NSRect outside = [NSWindow  frameRectForContentRect:inside styleMask:NSTitledWindowMask];
<a name="l01359"></a>01359   bx = <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>(outside.origin.x - inside.origin.x);
<a name="l01360"></a>01360   by = <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>(outside.origin.y - inside.origin.y);
<a name="l01361"></a>01361   bt = <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>(outside.size.height - inside.size.height - by);
<a name="l01362"></a>01362   [localPool release];
<a name="l01363"></a>01363 }
<a name="l01364"></a>01364 
<a name="l01365"></a>01365 <span class="comment">/*</span>
<a name="l01366"></a>01366 <span class="comment"> * smallest x ccordinate in screen space</span>
<a name="l01367"></a>01367 <span class="comment"> */</span>
<a name="l01368"></a>01368 <span class="keywordtype">int</span> <a class="code" href="group__fl__screen.html#gaed836eacded3467aa838d02a1c55e3ab">Fl::x</a>() {
<a name="l01369"></a>01369   <span class="keywordflow">return</span> <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>([[NSScreen mainScreen] visibleFrame].origin.x);
<a name="l01370"></a>01370 }
<a name="l01371"></a>01371 
<a name="l01372"></a>01372 
<a name="l01373"></a>01373 <span class="comment">/*</span>
<a name="l01374"></a>01374 <span class="comment"> * smallest y coordinate in screen space</span>
<a name="l01375"></a>01375 <span class="comment"> */</span>
<a name="l01376"></a>01376 <span class="keywordtype">int</span> <a class="code" href="group__fl__screen.html#gafa36572c1f755f8a9783efc351f19021">Fl::y</a>() {
<a name="l01377"></a>01377   NSRect all = [[NSScreen mainScreen] frame];
<a name="l01378"></a>01378   NSRect visible = [[NSScreen mainScreen] visibleFrame];
<a name="l01379"></a>01379   <span class="keywordflow">return</span> <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>(all.size.height - (visible.origin.y + visible.size.height));
<a name="l01380"></a>01380 }
<a name="l01381"></a>01381 
<a name="l01382"></a>01382 
<a name="l01383"></a>01383 <span class="comment">/*</span>
<a name="l01384"></a>01384 <span class="comment"> * screen width</span>
<a name="l01385"></a>01385 <span class="comment"> */</span>
<a name="l01386"></a>01386 <span class="keywordtype">int</span> <a class="code" href="group__fl__screen.html#ga7aba4252407f539aa6d821551aaba5ff">Fl::w</a>() {
<a name="l01387"></a>01387   <span class="keywordflow">return</span> <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>([[NSScreen mainScreen] visibleFrame].<a class="code" href="png_8h.html#a43291b8493b637821dec145c4bb1503d">size</a>.width);
<a name="l01388"></a>01388 }
<a name="l01389"></a>01389 
<a name="l01390"></a>01390 
<a name="l01391"></a>01391 <span class="comment">/*</span>
<a name="l01392"></a>01392 <span class="comment"> * screen height</span>
<a name="l01393"></a>01393 <span class="comment"> */</span>
<a name="l01394"></a>01394 <span class="keywordtype">int</span> <a class="code" href="group__fl__screen.html#ga7f42d75cf9b3e79bbe39e1041a657cdf">Fl::h</a>() {
<a name="l01395"></a>01395   <span class="keywordflow">return</span> <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>([[NSScreen mainScreen] visibleFrame].<a class="code" href="png_8h.html#a43291b8493b637821dec145c4bb1503d">size</a>.height);
<a name="l01396"></a>01396 }
<a name="l01397"></a>01397 
<a name="l01398"></a>01398 
<a name="l01399"></a>01399 <span class="comment">/*</span>
<a name="l01400"></a>01400 <span class="comment"> * get the current mouse pointer world coordinates</span>
<a name="l01401"></a>01401 <span class="comment"> */</span>
<a name="l01402"></a>01402 <span class="keywordtype">void</span> <a class="code" href="group__fl__events.html#gace49495f2b947065bb140e5023d14954">Fl::get_mouse</a>(<span class="keywordtype">int</span> &amp;x, <span class="keywordtype">int</span> &amp;<a class="code" href="test_8c.html#a0a2f84ed7838f07779ae24c5a9086d33">y</a>) 
<a name="l01403"></a>01403 {
<a name="l01404"></a>01404   <a class="code" href="mac_8H.html#a94ee21d83137569a6730e3e2e7305cbc">fl_open_display</a>();
<a name="l01405"></a>01405   NSPoint pt = [NSEvent mouseLocation];
<a name="l01406"></a>01406   x = <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>(pt.x);
<a name="l01407"></a>01407   y = <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>([[NSScreen mainScreen] frame].<a class="code" href="png_8h.html#a43291b8493b637821dec145c4bb1503d">size</a>.height - pt.y);
<a name="l01408"></a>01408 }
<a name="l01409"></a>01409 
<a name="l01410"></a>01410 
<a name="l01411"></a>01411 <span class="comment">/*</span>
<a name="l01412"></a>01412 <span class="comment"> * Initialize the given port for redraw and call the window&#39;s flush() to actually draw the content</span>
<a name="l01413"></a>01413 <span class="comment"> */</span> 
<a name="l01414"></a>01414 <span class="keywordtype">void</span> <a class="code" href="classFl__X.html#a5c37292ceca45a42bff9722029484bb5">Fl_X::flush</a>()
<a name="l01415"></a>01415 {
<a name="l01416"></a>01416   w-&gt;<a class="code" href="classFl__Window.html#a418cef08cf54f1dd794538501f15f08b">flush</a>();
<a name="l01417"></a>01417   <span class="keywordflow">if</span> (<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>) <a class="code" href="cgdebug_8h.html#afaf7a6c13b9872c0eb253ee26883ceb7">CGContextFlush</a>(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>);
<a name="l01418"></a>01418 }
<a name="l01419"></a>01419 
<a name="l01420"></a>01420 <span class="comment">/*</span>
<a name="l01421"></a>01421 <span class="comment"> * Gets called when a window is created, resized, or deminiaturized</span>
<a name="l01422"></a>01422 <span class="comment"> */</span>    
<a name="l01423"></a>01423 <span class="keyword">static</span> <span class="keywordtype">void</span> handleUpdateEvent( <a class="code" href="classFl__Window.html">Fl_Window</a> *window ) 
<a name="l01424"></a>01424 {
<a name="l01425"></a>01425   <span class="keywordflow">if</span> ( !window ) <span class="keywordflow">return</span>;
<a name="l01426"></a>01426   <a class="code" href="classFl__X.html">Fl_X</a> *i = <a class="code" href="classFl__X.html#ae4c6997d92cf8ad3a75a962d7ae77c34">Fl_X::i</a>( window );
<a name="l01427"></a>01427   i-&gt;<a class="code" href="classFl__X.html#a5bff94b4bde0ceafbaaaaaa3b7d1426e">wait_for_expose</a> = 0;
<a name="l01428"></a>01428 
<a name="l01429"></a>01429   <span class="keywordflow">if</span> ( i-&gt;<a class="code" href="classFl__X.html#a2d6b59b7362a486d48b6ae5df0bd0b41">region</a> ) {
<a name="l01430"></a>01430     <a class="code" href="win32_8H.html#aa9ab8e4893ef97f9bf92e66e2c51778b">XDestroyRegion</a>(i-&gt;<a class="code" href="classFl__X.html#a2d6b59b7362a486d48b6ae5df0bd0b41">region</a>);
<a name="l01431"></a>01431     i-&gt;<a class="code" href="classFl__X.html#a2d6b59b7362a486d48b6ae5df0bd0b41">region</a> = 0;
<a name="l01432"></a>01432   }
<a name="l01433"></a>01433   
<a name="l01434"></a>01434   <span class="keywordflow">for</span> ( <a class="code" href="classFl__X.html">Fl_X</a> *cx = i-&gt;xidChildren; cx; cx = cx-&gt;xidNext ) {
<a name="l01435"></a>01435     <span class="keywordflow">if</span> ( cx-&gt;region ) {
<a name="l01436"></a>01436       <a class="code" href="win32_8H.html#aa9ab8e4893ef97f9bf92e66e2c51778b">XDestroyRegion</a>(cx-&gt;region);
<a name="l01437"></a>01437       cx-&gt;region = 0;
<a name="l01438"></a>01438     }
<a name="l01439"></a>01439     cx-&gt;w-&gt;clear_damage(<a class="code" href="Enumerations_8H.html#a9a20351f841109b3d861e0c1248d146dae2ea13879a0e90540108be65c5bc8e4b">FL_DAMAGE_ALL</a>);
<a name="l01440"></a>01440     cx-&gt;flush();
<a name="l01441"></a>01441     cx-&gt;w-&gt;clear_damage();
<a name="l01442"></a>01442   }
<a name="l01443"></a>01443   window-&gt;<a class="code" href="classFl__Widget.html#af9942c4d795ec12c7c1ec1ce5e665a01">clear_damage</a>(<a class="code" href="Enumerations_8H.html#a9a20351f841109b3d861e0c1248d146dae2ea13879a0e90540108be65c5bc8e4b">FL_DAMAGE_ALL</a>);
<a name="l01444"></a>01444   i-&gt;<a class="code" href="classFl__X.html#a5c37292ceca45a42bff9722029484bb5">flush</a>();
<a name="l01445"></a>01445   window-&gt;<a class="code" href="classFl__Widget.html#af9942c4d795ec12c7c1ec1ce5e665a01">clear_damage</a>();
<a name="l01446"></a>01446 }     
<a name="l01447"></a>01447 
<a name="l01448"></a>01448 
<a name="l01449"></a>01449 <span class="keywordtype">int</span> <a class="code" href="classFl__X.html#a1bd922580d8cb633ec0cdb8c2b012f94">Fl_X::fake_X_wm</a>(<span class="keyword">const</span> <a class="code" href="classFl__Window.html">Fl_Window</a>* w,<span class="keywordtype">int</span> &amp;X,<span class="keywordtype">int</span> &amp;Y, <span class="keywordtype">int</span> &amp;bt,<span class="keywordtype">int</span> &amp;bx, <span class="keywordtype">int</span> &amp;by) {
<a name="l01450"></a>01450   <span class="keywordtype">int</span> W, <a class="code" href="Fl__Tooltip_8cxx.html#affa487e8e3cc48473cfc05c0ce0165e9">H</a>, xoff, yoff, <a class="code" href="fl__boxtype_8cxx.html#acafd1211381c8640d68a685ac2eea5d2">dx</a>, <a class="code" href="fl__boxtype_8cxx.html#a4cffdba1345d329bb97e76579d57fa21">dy</a>;
<a name="l01451"></a>01451   <span class="keywordtype">int</span> ret = bx = by = bt = 0;
<a name="l01452"></a>01452   <span class="keywordflow">if</span> (w-&gt;<a class="code" href="classFl__Window.html#a72f5733f13cb6d8b646f1e7ffcd92333">border</a>() &amp;&amp; !w-&gt;<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>()) {
<a name="l01453"></a>01453     <span class="keywordflow">if</span> (w-&gt;maxw != w-&gt;minw || w-&gt;maxh != w-&gt;minh) {
<a name="l01454"></a>01454       ret = 2;
<a name="l01455"></a>01455       get_window_frame_sizes(bx, by, bt);
<a name="l01456"></a>01456     } <span class="keywordflow">else</span> {
<a name="l01457"></a>01457       ret = 1;
<a name="l01458"></a>01458       get_window_frame_sizes(bx, by, bt);
<a name="l01459"></a>01459     }
<a name="l01460"></a>01460   }
<a name="l01461"></a>01461   <span class="comment">// The coordinates of the whole window, including non-client area</span>
<a name="l01462"></a>01462   xoff = bx;
<a name="l01463"></a>01463   yoff = by + bt;
<a name="l01464"></a>01464   dx = 2*bx;
<a name="l01465"></a>01465   dy = 2*by + bt;
<a name="l01466"></a>01466   X = w-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>()-xoff;
<a name="l01467"></a>01467   Y = w-&gt;<a class="code" href="classFl__Widget.html#aec1aded9efdf5f23dfac8cc725cefc4a">y</a>()-yoff;
<a name="l01468"></a>01468   W = w-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>()+dx;
<a name="l01469"></a>01469   H = w-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>()+dy;
<a name="l01470"></a>01470   
<a name="l01471"></a>01471   <span class="comment">// Proceed to positioning the window fully inside the screen, if possible</span>
<a name="l01472"></a>01472   
<a name="l01473"></a>01473   <span class="comment">// let&#39;s get a little elaborate here. Mac OS X puts a lot of stuff on the desk</span>
<a name="l01474"></a>01474   <span class="comment">// that we want to avoid when positioning our window, namely the Dock and the</span>
<a name="l01475"></a>01475   <span class="comment">// top menu bar (and even more stuff in 10.4 Tiger). So we will go through the</span>
<a name="l01476"></a>01476   <span class="comment">// list of all available screens and find the one that this window is most</span>
<a name="l01477"></a>01477   <span class="comment">// likely to go to, and then reposition it to fit withing the &#39;good&#39; area.</span>
<a name="l01478"></a>01478   <span class="comment">//  Rect r;</span>
<a name="l01479"></a>01479   <span class="comment">// find the screen, that the center of this window will fall into</span>
<a name="l01480"></a>01480   <span class="keywordtype">int</span> R = X+W, B = Y+H; <span class="comment">// right and bottom</span>
<a name="l01481"></a>01481   <span class="keywordtype">int</span> cx = (X+R)/2, cy = (Y+B)/2; <span class="comment">// center of window;</span>
<a name="l01482"></a>01482   NSScreen *gd = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01483"></a>01483   NSArray *a = [NSScreen screens]; <span class="keywordtype">int</span> count = (<a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>)[a count]; NSRect r; <span class="keywordtype">int</span> <a class="code" href="classFl__X.html#ae4c6997d92cf8ad3a75a962d7ae77c34">i</a>;
<a name="l01484"></a>01484   <span class="keywordflow">for</span>( i = 0; i &lt; count; i++) {
<a name="l01485"></a>01485     r = [[a objectAtIndex:i] frame];
<a name="l01486"></a>01486     cy = <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>(r.size.height - cy);
<a name="l01487"></a>01487     <span class="keywordflow">if</span> (   cx &gt;= r.origin.x &amp;&amp; cx &lt;= r.origin.x + r.size.width
<a name="l01488"></a>01488         &amp;&amp; cy &gt;= r.origin.y &amp;&amp; cy &lt;= r.origin.y + r.size.height)
<a name="l01489"></a>01489       <span class="keywordflow">break</span>;
<a name="l01490"></a>01490   }
<a name="l01491"></a>01491   <span class="keywordflow">if</span> (i &lt; count) gd = [a objectAtIndex:i];
<a name="l01492"></a>01492   
<a name="l01493"></a>01493   <span class="comment">// if the center doesn&#39;t fall on a screen, try the top left</span>
<a name="l01494"></a>01494   <span class="keywordflow">if</span> (!gd) {
<a name="l01495"></a>01495     <span class="keywordflow">for</span>( i = 0; i &lt; count; i++) {
<a name="l01496"></a>01496       r = [[a objectAtIndex:i] frame];
<a name="l01497"></a>01497       <span class="keywordflow">if</span> (    X &gt;= r.origin.x &amp;&amp; X &lt;= r.origin.x + r.size.width
<a name="l01498"></a>01498           &amp;&amp; r.size.height - Y &gt;= r.origin.y  &amp;&amp; r.size.height - Y &lt;= r.origin.y + r.size.height)
<a name="l01499"></a>01499         <span class="keywordflow">break</span>;
<a name="l01500"></a>01500     }
<a name="l01501"></a>01501     <span class="keywordflow">if</span> (i &lt; count) gd = [a objectAtIndex:i];
<a name="l01502"></a>01502   }
<a name="l01503"></a>01503   <span class="comment">// if that doesn&#39;t fall on a screen, try the top right</span>
<a name="l01504"></a>01504   <span class="keywordflow">if</span> (!gd) {
<a name="l01505"></a>01505     <span class="keywordflow">for</span>( i = 0; i &lt; count; i++) {
<a name="l01506"></a>01506       r = [[a objectAtIndex:i] frame];
<a name="l01507"></a>01507       <span class="keywordflow">if</span> (    R &gt;= r.origin.x &amp;&amp; R &lt;= r.origin.x + r.size.width
<a name="l01508"></a>01508           &amp;&amp; r.size.height - Y &gt;= r.origin.y  &amp;&amp; r.size.height - Y &lt;= r.origin.y + r.size.height)
<a name="l01509"></a>01509         <span class="keywordflow">break</span>;
<a name="l01510"></a>01510     }
<a name="l01511"></a>01511     <span class="keywordflow">if</span> (i &lt; count) gd = [a objectAtIndex:i];
<a name="l01512"></a>01512   }
<a name="l01513"></a>01513   <span class="comment">// if that doesn&#39;t fall on a screen, try the bottom left</span>
<a name="l01514"></a>01514   <span class="keywordflow">if</span> (!gd) {
<a name="l01515"></a>01515     <span class="keywordflow">for</span>( i = 0; i &lt; count; i++) {
<a name="l01516"></a>01516       r = [[a objectAtIndex:i] frame];
<a name="l01517"></a>01517       <span class="keywordflow">if</span> (    X &gt;= r.origin.x &amp;&amp; X &lt;= r.origin.x + r.size.width
<a name="l01518"></a>01518           &amp;&amp; Y-H &gt;= r.origin.y  &amp;&amp; Y-H &lt;= r.origin.y + r.size.height)
<a name="l01519"></a>01519         <span class="keywordflow">break</span>;
<a name="l01520"></a>01520     }
<a name="l01521"></a>01521     <span class="keywordflow">if</span> (i &lt; count) gd = [a objectAtIndex:i];
<a name="l01522"></a>01522   }
<a name="l01523"></a>01523   <span class="comment">// last resort, try the bottom right</span>
<a name="l01524"></a>01524   <span class="keywordflow">if</span> (!gd) {
<a name="l01525"></a>01525     <span class="keywordflow">for</span>( i = 0; i &lt; count; i++) {
<a name="l01526"></a>01526       r = [[a objectAtIndex:i] frame];
<a name="l01527"></a>01527       <span class="keywordflow">if</span> (    R &gt;= r.origin.x &amp;&amp; R &lt;= r.origin.x + r.size.width
<a name="l01528"></a>01528           &amp;&amp; Y-H &gt;= r.origin.y  &amp;&amp; Y-H &lt;= r.origin.y + r.size.height)
<a name="l01529"></a>01529         <span class="keywordflow">break</span>;
<a name="l01530"></a>01530     }
<a name="l01531"></a>01531     <span class="keywordflow">if</span> (i &lt; count) gd = [a objectAtIndex:i];
<a name="l01532"></a>01532   }
<a name="l01533"></a>01533   <span class="comment">// if we still have not found a screen, we will use the main</span>
<a name="l01534"></a>01534   <span class="comment">// screen, the one that has the application menu bar.</span>
<a name="l01535"></a>01535   <span class="keywordflow">if</span> (!gd) gd = [a objectAtIndex:0];
<a name="l01536"></a>01536   <span class="keywordflow">if</span> (gd) {
<a name="l01537"></a>01537     r = [gd visibleFrame];
<a name="l01538"></a>01538     <span class="keywordtype">int</span> sh = <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>([gd frame].<a class="code" href="png_8h.html#a43291b8493b637821dec145c4bb1503d">size</a>.height);
<a name="l01539"></a>01539     <span class="keywordflow">if</span> ( R &gt; r.origin.x + r.size.width ) X -= <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>(R - (r.origin.x + r.<a class="code" href="png_8h.html#a43291b8493b637821dec145c4bb1503d">size</a>.<a class="code" href="png_8h.html#a435a10efbc8005bae2e58e63cf9b55ce">width</a>));
<a name="l01540"></a>01540     <span class="keywordflow">if</span> ( B &gt; sh - r.origin.y ) Y -= <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>(B - (sh - r.origin.<a class="code" href="classFl__X.html#a23eeadf6bb296aebcc304d2703f7dfff">y</a>));
<a name="l01541"></a>01541     <span class="keywordflow">if</span> ( X &lt; r.origin.x ) X = <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>(r.origin.x);
<a name="l01542"></a>01542     <span class="keywordflow">if</span> ( Y &lt; sh - (r.origin.y + r.size.height) ) Y = <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>(sh - (r.origin.y + r.size.height));
<a name="l01543"></a>01543   }
<a name="l01544"></a>01544   
<a name="l01545"></a>01545   <span class="comment">// Return the client area&#39;s top left corner in (X,Y)</span>
<a name="l01546"></a>01546   X+=xoff;
<a name="l01547"></a>01547   Y+=yoff;
<a name="l01548"></a>01548   
<a name="l01549"></a>01549   <span class="keywordflow">return</span> ret;
<a name="l01550"></a>01550 }
<a name="l01551"></a>01551 
<a name="l01552"></a>01552 
<a name="l01553"></a>01553 <a class="code" href="classFl__Window.html">Fl_Window</a> *<a class="code" href="fl__dnd__win32_8cxx.html#a866cf619290e4f883ccf200cf1eb95c7">fl_dnd_target_window</a> = 0;
<a name="l01554"></a>01554 
<a name="l01555"></a>01555 <span class="keyword">static</span> <span class="keywordtype">void</span>  q_set_window_title(NSWindow *nsw, <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="png_8h.html#a90cd716fdb9b68c9661c3ba908a0ceff">name</a> ) {
<a name="l01556"></a>01556   CFStringRef utf8_title = CFStringCreateWithCString(<a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, (name ? name : <span class="stringliteral">&quot;&quot;</span>), kCFStringEncodingUTF8);
<a name="l01557"></a>01557         [nsw setTitle:(NSString*)utf8_title ];
<a name="l01558"></a>01558   CFRelease(utf8_title);
<a name="l01559"></a>01559 }
<a name="l01560"></a>01560 
<a name="l01561"></a>01561 
<a name="l01562"></a>01562 <span class="keyword">@interface </span>FLView : NSView &lt;NSTextInput&gt; {
<a name="l01563"></a>01563 }
<a name="l01564"></a>01564 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)drawRect:(NSRect)rect;
<a name="l01565"></a>01565 - (BOOL)acceptsFirstResponder;
<a name="l01566"></a>01566 - (BOOL)acceptsFirstMouse:(NSEvent*)theEvent;
<a name="l01567"></a>01567 - (BOOL)performKeyEquivalent:(NSEvent*)theEvent;
<a name="l01568"></a>01568 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)mouseUp:(NSEvent *)theEvent;
<a name="l01569"></a>01569 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)rightMouseUp:(NSEvent *)theEvent;
<a name="l01570"></a>01570 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)otherMouseUp:(NSEvent *)theEvent;
<a name="l01571"></a>01571 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)mouseDown:(NSEvent *)theEvent;
<a name="l01572"></a>01572 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)rightMouseDown:(NSEvent *)theEvent;
<a name="l01573"></a>01573 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)otherMouseDown:(NSEvent *)theEvent;
<a name="l01574"></a>01574 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)mouseMoved:(NSEvent *)theEvent;
<a name="l01575"></a>01575 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)mouseDragged:(NSEvent *)theEvent;
<a name="l01576"></a>01576 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)rightMouseDragged:(NSEvent *)theEvent;
<a name="l01577"></a>01577 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)otherMouseDragged:(NSEvent *)theEvent;
<a name="l01578"></a>01578 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)scrollWheel:(NSEvent *)theEvent;
<a name="l01579"></a>01579 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)keyDown:(NSEvent *)theEvent;
<a name="l01580"></a>01580 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)keyUp:(NSEvent *)theEvent;
<a name="l01581"></a>01581 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)flagsChanged:(NSEvent *)theEvent;
<a name="l01582"></a>01582 - (NSDragOperation)draggingEntered:(<span class="keywordtype">id</span> &lt; NSDraggingInfo &gt;)sender;
<a name="l01583"></a>01583 - (NSDragOperation)draggingUpdated:(<span class="keywordtype">id</span> &lt; NSDraggingInfo &gt;)sender;
<a name="l01584"></a>01584 - (BOOL)performDragOperation:(<span class="keywordtype">id</span> &lt;NSDraggingInfo&gt;)sender;
<a name="l01585"></a>01585 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)draggingExited:(<span class="keywordtype">id</span> &lt; NSDraggingInfo &gt;)sender;
<a name="l01586"></a>01586 - (NSDragOperation)draggingSourceOperationMaskForLocal:(BOOL)isLocal;
<a name="l01587"></a>01587 <span class="keyword">@end</span>
<a name="l01588"></a>01588 
<a name="l01589"></a>01589 <span class="keyword">@implementation </span>FLView
<a name="l01590"></a>01590 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)drawRect:(NSRect)rect
<a name="l01591"></a>01591 {
<a name="l01592"></a>01592   FLWindow *cw = (FLWindow*)[<span class="keyword">self</span> window];
<a name="l01593"></a>01593   <a class="code" href="classFl__Window.html">Fl_Window</a> *w = [cw getFl_Window];
<a name="l01594"></a>01594   handleUpdateEvent(w);
<a name="l01595"></a>01595 }
<a name="l01596"></a>01596 
<a name="l01597"></a>01597 - (BOOL)acceptsFirstResponder
<a name="l01598"></a>01598 {   
<a name="l01599"></a>01599   <span class="keywordflow">return</span> YES;
<a name="l01600"></a>01600 }
<a name="l01601"></a>01601 - (BOOL)performKeyEquivalent:(NSEvent*)theEvent
<a name="l01602"></a>01602 {   
<a name="l01603"></a>01603   <span class="keywordtype">int</span> err = cocoaKeyboardHandler(theEvent);
<a name="l01604"></a>01604   <span class="keywordflow">return</span> (err ? YES : NO);
<a name="l01605"></a>01605 }
<a name="l01606"></a>01606 - (BOOL)acceptsFirstMouse:(NSEvent*)theEvent
<a name="l01607"></a>01607 {   
<a name="l01608"></a>01608   <a class="code" href="classFl__Window.html">Fl_Window</a> *w = [(FLWindow*)[theEvent window] getFl_Window];
<a name="l01609"></a>01609   <a class="code" href="classFl__Window.html">Fl_Window</a> *first = <a class="code" href="group__fl__windows.html#ga3130407bc1c11f9b7f2a9c43a87a1599">Fl::first_window</a>();
<a name="l01610"></a>01610   <span class="keywordflow">return</span> (first == w || !first-&gt;<a class="code" href="classFl__Window.html#a6cc843ffcc711300613e44c678ad682f">modal</a>());
<a name="l01611"></a>01611 }
<a name="l01612"></a>01612 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)mouseUp:(NSEvent *)theEvent {
<a name="l01613"></a>01613   cocoaMouseHandler(theEvent);
<a name="l01614"></a>01614 }
<a name="l01615"></a>01615 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)rightMouseUp:(NSEvent *)theEvent {
<a name="l01616"></a>01616   cocoaMouseHandler(theEvent);
<a name="l01617"></a>01617 }
<a name="l01618"></a>01618 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)otherMouseUp:(NSEvent *)theEvent {
<a name="l01619"></a>01619   cocoaMouseHandler(theEvent);
<a name="l01620"></a>01620 }
<a name="l01621"></a>01621 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)mouseDown:(NSEvent *)theEvent {
<a name="l01622"></a>01622   cocoaMouseHandler(theEvent);
<a name="l01623"></a>01623 }
<a name="l01624"></a>01624 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)rightMouseDown:(NSEvent *)theEvent {
<a name="l01625"></a>01625   cocoaMouseHandler(theEvent);
<a name="l01626"></a>01626 }
<a name="l01627"></a>01627 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)otherMouseDown:(NSEvent *)theEvent {
<a name="l01628"></a>01628   cocoaMouseHandler(theEvent);
<a name="l01629"></a>01629 }
<a name="l01630"></a>01630 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)mouseMoved:(NSEvent *)theEvent {
<a name="l01631"></a>01631   cocoaMouseHandler(theEvent);
<a name="l01632"></a>01632 }
<a name="l01633"></a>01633 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)mouseDragged:(NSEvent *)theEvent {
<a name="l01634"></a>01634   cocoaMouseHandler(theEvent);
<a name="l01635"></a>01635 }
<a name="l01636"></a>01636 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)rightMouseDragged:(NSEvent *)theEvent {
<a name="l01637"></a>01637   cocoaMouseHandler(theEvent);
<a name="l01638"></a>01638 }
<a name="l01639"></a>01639 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)otherMouseDragged:(NSEvent *)theEvent {
<a name="l01640"></a>01640   cocoaMouseHandler(theEvent);
<a name="l01641"></a>01641 }
<a name="l01642"></a>01642 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)scrollWheel:(NSEvent *)theEvent {
<a name="l01643"></a>01643   cocoaMouseWheelHandler(theEvent);
<a name="l01644"></a>01644 }
<a name="l01645"></a>01645 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)keyDown:(NSEvent *)theEvent {
<a name="l01646"></a>01646   FLTextView *edit = (FLTextView*)[[theEvent window]  fieldEditor:YES forObject:nil];
<a name="l01647"></a>01647   [edit interpretKeyEvents:[NSArray arrayWithObject:theEvent]];
<a name="l01648"></a>01648 }
<a name="l01649"></a>01649 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)keyUp:(NSEvent *)theEvent {
<a name="l01650"></a>01650   cocoaKeyboardHandler(theEvent);
<a name="l01651"></a>01651 }
<a name="l01652"></a>01652 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)flagsChanged:(NSEvent *)theEvent {
<a name="l01653"></a>01653   <a class="code" href="Fl__mac_8cxx.html#a7c231659c1d4f9ad9126b83cfbcbfb53">fl_lock_function</a>();
<a name="l01654"></a>01654   <span class="keyword">static</span> UInt32 prevMods = 0;
<a name="l01655"></a>01655   NSUInteger mods = [theEvent modifierFlags];
<a name="l01656"></a>01656   <a class="code" href="classFl__Window.html">Fl_Window</a> *window = (<a class="code" href="classFl__Window.html">Fl_Window</a>*)[(FLWindow*)[theEvent window] getFl_Window];
<a name="l01657"></a>01657   UInt32 tMods = prevMods ^ mods;
<a name="l01658"></a>01658   <span class="keywordtype">int</span> sendEvent = 0;
<a name="l01659"></a>01659   <span class="keywordflow">if</span> ( tMods )
<a name="l01660"></a>01660   {
<a name="l01661"></a>01661     mods_to_e_keysym( tMods );
<a name="l01662"></a>01662     <span class="keywordflow">if</span> ( <a class="code" href="classFl.html#ad7e56c414916c270ba98e38e2cf41e57">Fl::e_keysym</a> ) 
<a name="l01663"></a>01663       sendEvent = ( prevMods&lt;mods ) ? <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a1387c0430ec873aa44704954a369143b">FL_KEYBOARD</a> : <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3ab0e1a75a36767b878915e59e5f9e3be8">FL_KEYUP</a>;
<a name="l01664"></a>01664     <a class="code" href="classFl.html#a336911cf63dade9bbb9707b942785133">Fl::e_length</a> = 0;
<a name="l01665"></a>01665     <a class="code" href="classFl.html#addcd49b68feff0a807f6564f3fdb8016">Fl::e_text</a> = (<span class="keywordtype">char</span>*)<span class="stringliteral">&quot;&quot;</span>;
<a name="l01666"></a>01666     prevMods = mods;
<a name="l01667"></a>01667   }
<a name="l01668"></a>01668   mods_to_e_state( mods );
<a name="l01669"></a>01669   <span class="keywordflow">while</span> (window-&gt;<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>()) window = window-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>();
<a name="l01670"></a>01670   <span class="keywordflow">if</span> (sendEvent) <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>(sendEvent,window);
<a name="l01671"></a>01671   <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l01672"></a>01672 }
<a name="l01673"></a>01673 - (NSDragOperation)draggingEntered:(<span class="keywordtype">id</span> &lt; NSDraggingInfo &gt;)sender
<a name="l01674"></a>01674 {
<a name="l01675"></a>01675   <a class="code" href="classFl__Window.html">Fl_Window</a> *target = [(FLWindow*)[<span class="keyword">self</span> window] getFl_Window];
<a name="l01676"></a>01676   update_e_xy_and_e_xy_root([<span class="keyword">self</span> window]);
<a name="l01677"></a>01677   <a class="code" href="fl__dnd__win32_8cxx.html#a866cf619290e4f883ccf200cf1eb95c7">fl_dnd_target_window</a> = target;
<a name="l01678"></a>01678   <span class="keywordtype">int</span> ret = <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>( <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3af4f28b5ef9ec051e4a4d9e19a16370b8">FL_DND_ENTER</a>, target );
<a name="l01679"></a>01679   breakMacEventLoop();
<a name="l01680"></a>01680   <span class="keywordflow">return</span> ret ? NSDragOperationCopy : NSDragOperationNone;
<a name="l01681"></a>01681 }
<a name="l01682"></a>01682 - (NSDragOperation)draggingUpdated:(<span class="keywordtype">id</span> &lt; NSDraggingInfo &gt;)sender
<a name="l01683"></a>01683 {
<a name="l01684"></a>01684   <a class="code" href="classFl__Window.html">Fl_Window</a> *target = [(FLWindow*)[<span class="keyword">self</span> window] getFl_Window];
<a name="l01685"></a>01685   update_e_xy_and_e_xy_root([<span class="keyword">self</span> window]);
<a name="l01686"></a>01686   <a class="code" href="fl__dnd__win32_8cxx.html#a866cf619290e4f883ccf200cf1eb95c7">fl_dnd_target_window</a> = target;
<a name="l01687"></a>01687   <span class="keywordtype">int</span> ret = <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>( <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3aadfedcde7415286c752ba427f0e8626f">FL_DND_DRAG</a>, target );
<a name="l01688"></a>01688   breakMacEventLoop();
<a name="l01689"></a>01689   <span class="keywordflow">return</span> ret ? NSDragOperationCopy : NSDragOperationNone;
<a name="l01690"></a>01690 }
<a name="l01691"></a>01691 - (BOOL)performDragOperation:(<span class="keywordtype">id</span> &lt;NSDraggingInfo&gt;)sender 
<a name="l01692"></a>01692 {
<a name="l01693"></a>01693   <span class="keyword">static</span> <span class="keywordtype">char</span> *DragData = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01694"></a>01694   <a class="code" href="classFl__Window.html">Fl_Window</a> *target = [(FLWindow*)[<span class="keyword">self</span> window] getFl_Window];
<a name="l01695"></a>01695   <span class="keywordflow">if</span> ( !<a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>( <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a80deb55dbc048b83dc154c11c658b7d6">FL_DND_RELEASE</a>, target ) ) { 
<a name="l01696"></a>01696     breakMacEventLoop();
<a name="l01697"></a>01697     <span class="keywordflow">return</span> NO;
<a name="l01698"></a>01698   }
<a name="l01699"></a>01699   NSPasteboard *pboard;
<a name="l01700"></a>01700   <span class="comment">// NSDragOperation sourceDragMask;</span>
<a name="l01701"></a>01701   <span class="comment">// sourceDragMask = [sender draggingSourceOperationMask];</span>
<a name="l01702"></a>01702   pboard = [sender draggingPasteboard];
<a name="l01703"></a>01703   update_e_xy_and_e_xy_root([<span class="keyword">self</span> window]);
<a name="l01704"></a>01704   <span class="keywordflow">if</span> (DragData) { free(DragData); DragData = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>; }
<a name="l01705"></a>01705   <span class="keywordflow">if</span> ( [[pboard types] containsObject:NSFilenamesPboardType] ) {
<a name="l01706"></a>01706     CFArrayRef files = (CFArrayRef)[pboard propertyListForType:NSFilenamesPboardType];
<a name="l01707"></a>01707     CFStringRef all = CFStringCreateByCombiningStrings(<a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, files, CFSTR(<span class="stringliteral">&quot;\n&quot;</span>));
<a name="l01708"></a>01708     <span class="keywordtype">int</span> l = CFStringGetMaximumSizeForEncoding(CFStringGetLength(all), kCFStringEncodingUTF8);
<a name="l01709"></a>01709     DragData = (<span class="keywordtype">char</span> *)malloc(l + 1);
<a name="l01710"></a>01710     CFStringGetCString(all, DragData, l + 1, kCFStringEncodingUTF8);
<a name="l01711"></a>01711     CFRelease(all);
<a name="l01712"></a>01712   }
<a name="l01713"></a>01713   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( [[pboard types] containsObject:NSStringPboardType] ) {
<a name="l01714"></a>01714     NSData *data = [pboard dataForType:NSStringPboardType];
<a name="l01715"></a>01715     DragData = (<span class="keywordtype">char</span> *)malloc([data <a class="code" href="png_8h.html#ae403475fe6a2c471cf8dd689e3049953">length</a>] + 1);
<a name="l01716"></a>01716     [data getBytes:DragData];
<a name="l01717"></a>01717     DragData[[data length]] = 0;
<a name="l01718"></a>01718     convert_crlf(DragData, strlen(DragData));
<a name="l01719"></a>01719   }
<a name="l01720"></a>01720   <span class="keywordflow">else</span> {
<a name="l01721"></a>01721     breakMacEventLoop();
<a name="l01722"></a>01722     <span class="keywordflow">return</span> NO;
<a name="l01723"></a>01723   }
<a name="l01724"></a>01724   <a class="code" href="classFl.html#addcd49b68feff0a807f6564f3fdb8016">Fl::e_text</a> = DragData;
<a name="l01725"></a>01725   <a class="code" href="classFl.html#a336911cf63dade9bbb9707b942785133">Fl::e_length</a> = strlen(DragData);
<a name="l01726"></a>01726   <span class="keywordtype">int</span> old_event = <a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a>;
<a name="l01727"></a>01727   <a class="code" href="group__fl__events.html#ga5b55ce634002a2743c24c4c4db7cbdd4">Fl::belowmouse</a>()-&gt;<a class="code" href="classFl__Widget.html#a9cb17cc092697dfd05a3fab55856d218">handle</a>(<a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a> = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a5e811b9d703e6f66cfdca256ecfbb0cf">FL_PASTE</a>);
<a name="l01728"></a>01728   <a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a> = old_event;
<a name="l01729"></a>01729   <span class="keywordflow">if</span> (DragData) { free(DragData); DragData = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>; }
<a name="l01730"></a>01730   <a class="code" href="classFl.html#addcd49b68feff0a807f6564f3fdb8016">Fl::e_text</a> = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01731"></a>01731   <a class="code" href="classFl.html#a336911cf63dade9bbb9707b942785133">Fl::e_length</a> = 0;
<a name="l01732"></a>01732   <a class="code" href="fl__dnd__win32_8cxx.html#a866cf619290e4f883ccf200cf1eb95c7">fl_dnd_target_window</a> = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01733"></a>01733   breakMacEventLoop();
<a name="l01734"></a>01734   <span class="keywordflow">return</span> YES;
<a name="l01735"></a>01735 }
<a name="l01736"></a>01736 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)draggingExited:(<span class="keywordtype">id</span> &lt; NSDraggingInfo &gt;)sender
<a name="l01737"></a>01737 {
<a name="l01738"></a>01738   <span class="keywordflow">if</span> ( <a class="code" href="fl__dnd__win32_8cxx.html#a866cf619290e4f883ccf200cf1eb95c7">fl_dnd_target_window</a> ) {
<a name="l01739"></a>01739     <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>( <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a03bdb8df3578915e1d0829cc048d855e">FL_DND_LEAVE</a>, <a class="code" href="fl__dnd__win32_8cxx.html#a866cf619290e4f883ccf200cf1eb95c7">fl_dnd_target_window</a> );
<a name="l01740"></a>01740     <a class="code" href="fl__dnd__win32_8cxx.html#a866cf619290e4f883ccf200cf1eb95c7">fl_dnd_target_window</a> = 0;
<a name="l01741"></a>01741   }
<a name="l01742"></a>01742 }
<a name="l01743"></a>01743 - (NSDragOperation)draggingSourceOperationMaskForLocal:(BOOL)isLocal
<a name="l01744"></a>01744 {
<a name="l01745"></a>01745   <span class="keywordflow">return</span> NSDragOperationGeneric;
<a name="l01746"></a>01746 }
<a name="l01747"></a>01747 
<a name="l01748"></a>01748 <span class="comment">// These functions implement text input.</span>
<a name="l01749"></a>01749 <span class="comment">// Only two-stroke character composition works at this point.</span>
<a name="l01750"></a>01750 <span class="comment">// Needs much elaboration to fully support CJK text input,</span>
<a name="l01751"></a>01751 <span class="comment">// but this is the way to go.</span>
<a name="l01752"></a>01752 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)doCommandBySelector:(<span class="keywordtype">SEL</span>)aSelector {
<a name="l01753"></a>01753 }
<a name="l01754"></a>01754 
<a name="l01755"></a>01755 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)insertText:(<span class="keywordtype">id</span>)aString {
<a name="l01756"></a>01756   NSEvent *<span class="keyword">event</span> = [NSApp currentEvent];
<a name="l01757"></a>01757   NSEventType type = [event type];
<a name="l01758"></a>01758   NSString *str = <span class="stringliteral">@&quot;&quot;</span>;
<a name="l01759"></a>01759   NSString *received;
<a name="l01760"></a>01760   <span class="keywordflow">if</span> ([aString isKindOfClass:[NSAttributedString <span class="keyword">class</span>]]) {
<a name="l01761"></a>01761     received = [(NSAttributedString*)aString string];
<a name="l01762"></a>01762   } <span class="keywordflow">else</span> {
<a name="l01763"></a>01763     received = (NSString*)aString;
<a name="l01764"></a>01764   }
<a name="l01765"></a>01765 <span class="comment">//NSLog(@&quot;insertText: received=%@ event type=%d&quot;,received, type);</span>
<a name="l01766"></a>01766   <span class="keywordflow">if</span> (type == NSKeyDown ) {
<a name="l01767"></a>01767     str = [event characters];
<a name="l01768"></a>01768     }
<a name="l01769"></a>01769   <span class="keywordflow">if</span> ([received isEqualToString:<span class="stringliteral">@&quot;\b&quot;</span>] || [str isEqualToString:received]) {
<a name="l01770"></a>01770     <span class="keywordflow">if</span> (type == NSKeyDown ) cocoaKeyboardHandler(event);
<a name="l01771"></a>01771   } <span class="keywordflow">else</span> {
<a name="l01772"></a>01772     <a class="code" href="Fl__mac_8cxx.html#a7c231659c1d4f9ad9126b83cfbcbfb53">fl_lock_function</a>();
<a name="l01773"></a>01773     <a class="code" href="classFl__Window.html">Fl_Window</a> *window = [(FLWindow*)[NSApp keyWindow] getFl_Window];
<a name="l01774"></a>01774     <a class="code" href="classFl.html#addcd49b68feff0a807f6564f3fdb8016">Fl::e_text</a> = (<span class="keywordtype">char</span>*)[received UTF8String];
<a name="l01775"></a>01775     <a class="code" href="classFl.html#a336911cf63dade9bbb9707b942785133">Fl::e_length</a> = strlen(<a class="code" href="classFl.html#addcd49b68feff0a807f6564f3fdb8016">Fl::e_text</a>);
<a name="l01776"></a>01776     <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>(<a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a1387c0430ec873aa44704954a369143b">FL_KEYBOARD</a>, window);
<a name="l01777"></a>01777     <a class="code" href="group__fl__events.html#ga064a4028b27d7da1238a6e5280582abf">Fl::handle</a>(<a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3ab0e1a75a36767b878915e59e5f9e3be8">FL_KEYUP</a>, window);
<a name="l01778"></a>01778     <a class="code" href="Fl__mac_8cxx.html#a2240294e6452e3241580f8fa634ae8ab">fl_unlock_function</a>();
<a name="l01779"></a>01779     <span class="comment">// for some reason, the window does not redraw until the next mouse move or button push</span>
<a name="l01780"></a>01780     <span class="comment">// sending a &#39;redraw()&#39; or &#39;awake()&#39; does not solve the issue!</span>
<a name="l01781"></a>01781     <a class="code" href="classFl.html#a08d29d807ea3874b8bb16f7457f64bdc">Fl::flush</a>();
<a name="l01782"></a>01782   }
<a name="l01783"></a>01783 }
<a name="l01784"></a>01784 
<a name="l01785"></a>01785 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)setMarkedText:(<span class="keywordtype">id</span>)aString selectedRange:(NSRange)newSelection  {
<a name="l01786"></a>01786   <span class="comment">// NSLog(@&quot;setMarkedText: %@ %d %d Fl::compose_state=%d&quot;,</span>
<a name="l01787"></a>01787   <span class="comment">//  aString,newSelection.location,newSelection.length,newSelection.location);</span>
<a name="l01788"></a>01788   [<span class="keyword">self</span> insertText:aString];
<a name="l01789"></a>01789   <a class="code" href="classFl.html#aff0cbb8d7e80cdb8f91d7586e4dce71d">Fl::compose_state</a> = newSelection.location;
<a name="l01790"></a>01790 }
<a name="l01791"></a>01791 
<a name="l01792"></a>01792 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)unmarkText {
<a name="l01793"></a>01793   <a class="code" href="classFl.html#aff0cbb8d7e80cdb8f91d7586e4dce71d">Fl::compose_state</a> = 0;
<a name="l01794"></a>01794   <span class="comment">//NSLog(@&quot;unmarkText&quot;);</span>
<a name="l01795"></a>01795 }
<a name="l01796"></a>01796 
<a name="l01797"></a>01797 - (NSRange)selectedRange {
<a name="l01798"></a>01798   <span class="keywordflow">return</span> NSMakeRange(NSNotFound, 0);
<a name="l01799"></a>01799 }
<a name="l01800"></a>01800 
<a name="l01801"></a>01801 - (NSRange)markedRange {
<a name="l01802"></a>01802   <span class="comment">//NSLog(@&quot;markedRange ?&quot;);</span>
<a name="l01803"></a>01803   <span class="keywordflow">return</span> NSMakeRange(NSNotFound, <a class="code" href="classFl.html#aff0cbb8d7e80cdb8f91d7586e4dce71d">Fl::compose_state</a>);
<a name="l01804"></a>01804 }
<a name="l01805"></a>01805 
<a name="l01806"></a>01806 - (BOOL)hasMarkedText {
<a name="l01807"></a>01807   <span class="comment">//NSLog(@&quot;hasMarkedText %s&quot;, Fl::compose_state &gt; 0?&quot;YES&quot;:&quot;NO&quot;);</span>
<a name="l01808"></a>01808   <span class="keywordflow">return</span> (<a class="code" href="classFl.html#aff0cbb8d7e80cdb8f91d7586e4dce71d">Fl::compose_state</a> &gt; 0);
<a name="l01809"></a>01809 }
<a name="l01810"></a>01810 
<a name="l01811"></a>01811 - (NSAttributedString *)attributedSubstringFromRange:(NSRange)aRange {
<a name="l01812"></a>01812   <span class="comment">//NSLog(@&quot;attributedSubstringFromRange: %d %d&quot;,aRange.location,aRange.length);</span>
<a name="l01813"></a>01813   <span class="keywordflow">return</span> nil;
<a name="l01814"></a>01814 }
<a name="l01815"></a>01815 
<a name="l01816"></a>01816 - (NSArray *)validAttributesForMarkedText {
<a name="l01817"></a>01817   <span class="keywordflow">return</span> nil;
<a name="l01818"></a>01818 }
<a name="l01819"></a>01819 
<a name="l01820"></a>01820 - (NSRect)firstRectForCharacterRange:(NSRange)aRange {
<a name="l01821"></a>01821   NSRect glyphRect, frame;
<a name="l01822"></a>01822   
<a name="l01823"></a>01823   frame = [<span class="keyword">self</span> frame];
<a name="l01824"></a>01824   glyphRect.origin.x = frame.size.width;
<a name="l01825"></a>01825   glyphRect.origin.y = 0;
<a name="l01826"></a>01826   glyphRect.size.width = glyphRect.size.height = 0;
<a name="l01827"></a>01827   <span class="comment">// Convert the rect to screen coordinates</span>
<a name="l01828"></a>01828   glyphRect.origin = [[<span class="keyword">self</span> window] convertBaseToScreen:glyphRect.origin];
<a name="l01829"></a>01829   <span class="keywordflow">return</span> glyphRect;
<a name="l01830"></a>01830 }
<a name="l01831"></a>01831 
<a name="l01832"></a>01832 - (NSUInteger)characterIndexForPoint:(NSPoint)aPoint {
<a name="l01833"></a>01833   <span class="keywordflow">return</span> 0;
<a name="l01834"></a>01834 }
<a name="l01835"></a>01835 
<a name="l01836"></a>01836 - (NSInteger)conversationIdentifier {
<a name="l01837"></a>01837   <span class="keywordflow">return</span> (NSInteger)<span class="keyword">self</span>;
<a name="l01838"></a>01838 }
<a name="l01839"></a>01839 
<a name="l01840"></a>01840 <span class="keyword">@end</span>
<a name="l01841"></a>01841 
<a name="l01842"></a>01842 
<a name="l01843"></a>01843 <span class="comment">/*</span>
<a name="l01844"></a>01844 <span class="comment"> * go ahead, create that (sub)window</span>
<a name="l01845"></a>01845 <span class="comment"> */</span>
<a name="l01846"></a>01846 <span class="keywordtype">void</span> <a class="code" href="classFl__X.html#a2d3acae437e4eea48e44c08b2543da73">Fl_X::make</a>(<a class="code" href="classFl__Window.html">Fl_Window</a>* w)
<a name="l01847"></a>01847 {
<a name="l01848"></a>01848   <span class="keyword">static</span> <span class="keywordtype">int</span> xyPos = 100;
<a name="l01849"></a>01849   <span class="keywordflow">if</span> ( w-&gt;<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>() ) {          <span class="comment">// create a subwindow</span>
<a name="l01850"></a>01850     <a class="code" href="classFl__Group.html#af48163bbf0a8d18844b5d751946897c0">Fl_Group::current</a>(0);
<a name="l01851"></a>01851     <span class="comment">// our subwindow needs this structure to know about its clipping. </span>
<a name="l01852"></a>01852     <a class="code" href="classFl__X.html">Fl_X</a>* x = <span class="keyword">new</span> <a class="code" href="classFl__X.html">Fl_X</a>;
<a name="l01853"></a>01853     x-&gt;<a class="code" href="classFl__X.html#a54e86fad0e3c9fc1cdbb72153abacfdf">other_xid</a> = 0;
<a name="l01854"></a>01854     x-&gt;<a class="code" href="classFl__X.html#a2d6b59b7362a486d48b6ae5df0bd0b41">region</a> = 0;
<a name="l01855"></a>01855     x-&gt;subRegion = 0;
<a name="l01856"></a>01856     x-&gt;<a class="code" href="classFl__X.html#acf3febbfadf4ef160511bf7a4bd4572d">cursor</a> = <a class="code" href="win32_8H.html#a5c84f195de614f6aa79fa2f8883b37b6">fl_default_cursor</a>;
<a name="l01857"></a>01857     x-&gt;gc = 0;                  <span class="comment">// stay 0 for Quickdraw; fill with CGContext for Quartz</span>
<a name="l01858"></a>01858     <a class="code" href="classFl__Window.html">Fl_Window</a> *win = w-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>();
<a name="l01859"></a>01859     <a class="code" href="classFl__X.html">Fl_X</a> *xo = <a class="code" href="classFl__X.html#ae4c6997d92cf8ad3a75a962d7ae77c34">Fl_X::i</a>(win);
<a name="l01860"></a>01860     <span class="keywordflow">if</span> (xo) {
<a name="l01861"></a>01861       x-&gt;xidNext = xo-&gt;xidChildren;
<a name="l01862"></a>01862       x-&gt;xidChildren = 0L;
<a name="l01863"></a>01863       xo-&gt;xidChildren = <a class="code" href="classFl__X.html#ae3e071b57b4577d0c13214be9db17ad5">x</a>;
<a name="l01864"></a>01864       x-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a> = win-&gt;i-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>;
<a name="l01865"></a>01865       x-&gt;<a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a> = <a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>; w-&gt;i = <a class="code" href="classFl__X.html#ae3e071b57b4577d0c13214be9db17ad5">x</a>;
<a name="l01866"></a>01866       x-&gt;<a class="code" href="classFl__X.html#a5bff94b4bde0ceafbaaaaaa3b7d1426e">wait_for_expose</a> = 0;
<a name="l01867"></a>01867       {
<a name="l01868"></a>01868         <a class="code" href="classFl__X.html">Fl_X</a> *z = xo-&gt;<a class="code" href="classFl__X.html#a41f6a721a953ea62021bb1dd9c4f2187">next</a>;     <span class="comment">// we don&#39;t want a subwindow in Fl_X::first</span>
<a name="l01869"></a>01869         xo-&gt;<a class="code" href="classFl__X.html#a41f6a721a953ea62021bb1dd9c4f2187">next</a> = <a class="code" href="classFl__X.html#ae3e071b57b4577d0c13214be9db17ad5">x</a>;
<a name="l01870"></a>01870         x-&gt;<a class="code" href="classFl__X.html#a41f6a721a953ea62021bb1dd9c4f2187">next</a> = z;
<a name="l01871"></a>01871       }
<a name="l01872"></a>01872       <span class="keywordtype">int</span> old_event = <a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a>;
<a name="l01873"></a>01873       w-&gt;<a class="code" href="classFl__Window.html#a9c0eb1c55a1a62ef3d3d87676f936187">handle</a>(<a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a> = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a9edbfd236c9ea348dcaae935a76bd885">FL_SHOW</a>);
<a name="l01874"></a>01874       <a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a> = old_event;
<a name="l01875"></a>01875       w-&gt;<a class="code" href="classFl__Widget.html#aa63ce68cbf4620cf8750b868368ea02b">redraw</a>();              <span class="comment">// force draw to happen</span>
<a name="l01876"></a>01876     }
<a name="l01877"></a>01877     <a class="code" href="Fl__arg_8cxx.html#aeed6a7220f140808e50ef846ef0ad3c2">fl_show_iconic</a> = 0;
<a name="l01878"></a>01878   }
<a name="l01879"></a>01879   <span class="keywordflow">else</span> {                        <span class="comment">// create a desktop window</span>
<a name="l01880"></a>01880     NSAutoreleasePool *localPool;
<a name="l01881"></a>01881     localPool = [[NSAutoreleasePool alloc] init]; 
<a name="l01882"></a>01882     <a class="code" href="classFl__Group.html#af48163bbf0a8d18844b5d751946897c0">Fl_Group::current</a>(0);
<a name="l01883"></a>01883     <a class="code" href="mac_8H.html#a94ee21d83137569a6730e3e2e7305cbc">fl_open_display</a>();
<a name="l01884"></a>01884     NSInteger winlevel = NSNormalWindowLevel;
<a name="l01885"></a>01885     NSUInteger winstyle;
<a name="l01886"></a>01886     <span class="keywordflow">if</span> (w-&gt;<a class="code" href="classFl__Window.html#a72f5733f13cb6d8b646f1e7ffcd92333">border</a>()) winstyle = NSTitledWindowMask | NSClosableWindowMask | NSMiniaturizableWindowMask;
<a name="l01887"></a>01887     <span class="keywordflow">else</span> winstyle = NSBorderlessWindowMask;
<a name="l01888"></a>01888     <span class="keywordtype">int</span> xp = w-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>();
<a name="l01889"></a>01889     <span class="keywordtype">int</span> yp = w-&gt;<a class="code" href="classFl__Widget.html#aec1aded9efdf5f23dfac8cc725cefc4a">y</a>();
<a name="l01890"></a>01890     <span class="keywordtype">int</span> wp = w-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>();
<a name="l01891"></a>01891     <span class="keywordtype">int</span> hp = w-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>();
<a name="l01892"></a>01892     <span class="keywordflow">if</span> (w-&gt;size_range_set) {
<a name="l01893"></a>01893       <span class="keywordflow">if</span> ( w-&gt;minh != w-&gt;maxh || w-&gt;minw != w-&gt;maxw) {
<a name="l01894"></a>01894         winstyle |= NSResizableWindowMask;
<a name="l01895"></a>01895       }
<a name="l01896"></a>01896     } <span class="keywordflow">else</span> {
<a name="l01897"></a>01897       <span class="keywordflow">if</span> (w-&gt;<a class="code" href="classFl__Group.html#ab0ed0d1974d7185594687849f386c5f3">resizable</a>()) {
<a name="l01898"></a>01898         <a class="code" href="classFl__Widget.html">Fl_Widget</a> *o = w-&gt;<a class="code" href="classFl__Group.html#ab0ed0d1974d7185594687849f386c5f3">resizable</a>();
<a name="l01899"></a>01899         <span class="keywordtype">int</span> minw = o-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>(); <span class="keywordflow">if</span> (minw &gt; 100) minw = 100;
<a name="l01900"></a>01900         <span class="keywordtype">int</span> minh = o-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>(); <span class="keywordflow">if</span> (minh &gt; 100) minh = 100;
<a name="l01901"></a>01901         w-&gt;<a class="code" href="classFl__Window.html#a9be71df81e121b984f33140720102d59">size_range</a>(w-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>() - o-&gt;w() + minw, w-&gt;<a class="code" href="forms_8H-2.html#a7e427ba5b307f9068129699250690066">h</a>() - o-&gt;<a class="code" href="forms_8H-2.html#a7e427ba5b307f9068129699250690066">h</a>() + minh, 0, 0);
<a name="l01902"></a>01902         winstyle |= NSResizableWindowMask;
<a name="l01903"></a>01903       } <span class="keywordflow">else</span> {
<a name="l01904"></a>01904         w-&gt;<a class="code" href="classFl__Window.html#a9be71df81e121b984f33140720102d59">size_range</a>(w-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>(), w-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>(), w-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>(), w-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>());
<a name="l01905"></a>01905       }
<a name="l01906"></a>01906     }
<a name="l01907"></a>01907     <span class="keywordtype">int</span> xwm = xp, ywm = yp, bt, bx, by;
<a name="l01908"></a>01908     
<a name="l01909"></a>01909     <span class="keywordflow">if</span> (!<a class="code" href="classFl__X.html#a1bd922580d8cb633ec0cdb8c2b012f94">fake_X_wm</a>(w, xwm, ywm, bt, bx, by)) {
<a name="l01910"></a>01910       <span class="comment">// menu windows and tooltips</span>
<a name="l01911"></a>01911       <span class="keywordflow">if</span> (w-&gt;<a class="code" href="classFl__Window.html#a6cc843ffcc711300613e44c678ad682f">modal</a>()||w-&gt;<a class="code" href="classFl__Window.html#aeed8d628ef854ea63a4e2badd9596eb7">override</a>()) {
<a name="l01912"></a>01912         winstyle = NSBorderlessWindowMask;
<a name="l01913"></a>01913         winlevel = NSMainMenuWindowLevel;
<a name="l01914"></a>01914       } <span class="keywordflow">else</span> {
<a name="l01915"></a>01915         winstyle = NSBorderlessWindowMask;
<a name="l01916"></a>01916       }
<a name="l01917"></a>01917     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (w-&gt;<a class="code" href="classFl__Window.html#a6cc843ffcc711300613e44c678ad682f">modal</a>()) {
<a name="l01918"></a>01918       winstyle &amp;= ~NSMiniaturizableWindowMask;
<a name="l01919"></a>01919       <span class="comment">// winstyle &amp;= ~(NSResizableWindowMask | NSMiniaturizableWindowMask);</span>
<a name="l01920"></a>01920       <span class="comment">// winlevel = NSModalPanelWindowLevel;</span>
<a name="l01921"></a>01921     }
<a name="l01922"></a>01922     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (w-&gt;<a class="code" href="classFl__Window.html#a663df072d1d68c5733a1c5f2f88fd819">non_modal</a>()) {
<a name="l01923"></a>01923       winlevel = NSFloatingWindowLevel;
<a name="l01924"></a>01924     }
<a name="l01925"></a>01925     
<a name="l01926"></a>01926     <span class="keywordflow">if</span> (by+bt) {
<a name="l01927"></a>01927       wp += 2*bx;
<a name="l01928"></a>01928       hp += 2*by+bt;
<a name="l01929"></a>01929     }
<a name="l01930"></a>01930     <span class="keywordflow">if</span> (!(w-&gt;<a class="code" href="classFl__Widget.html#a2bd83b947c7f75919afc280043c958db">flags</a>() &amp; <a class="code" href="classFl__Widget.html#acd8a95e8128fe1673479b8d0f4d0aa62a1d2b155a766bc59be7a3f60d306de852" title="don&amp;#39;t let the window manager position the window (Fl_Window)">Fl_Window::FORCE_POSITION</a>)) {
<a name="l01931"></a>01931       <span class="comment">// use the Carbon functions below for default window positioning</span>
<a name="l01932"></a>01932       w-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>(xyPos+<a class="code" href="group__fl__screen.html#gaed836eacded3467aa838d02a1c55e3ab">Fl::x</a>());
<a name="l01933"></a>01933       w-&gt;<a class="code" href="classFl__Widget.html#aec1aded9efdf5f23dfac8cc725cefc4a">y</a>(xyPos+<a class="code" href="group__fl__screen.html#gafa36572c1f755f8a9783efc351f19021">Fl::y</a>());
<a name="l01934"></a>01934       xyPos += 25;
<a name="l01935"></a>01935       <span class="keywordflow">if</span> (xyPos&gt;200) xyPos = 100;
<a name="l01936"></a>01936     } <span class="keywordflow">else</span> {
<a name="l01937"></a>01937       <span class="keywordflow">if</span> (!<a class="code" href="group__fl__windows.html#ga100705a8107397cfde7318aa34019739">Fl::grab</a>()) {
<a name="l01938"></a>01938         xp = xwm; yp = ywm;
<a name="l01939"></a>01939         w-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>(xp);w-&gt;<a class="code" href="classFl__Widget.html#aec1aded9efdf5f23dfac8cc725cefc4a">y</a>(yp);
<a name="l01940"></a>01940       }
<a name="l01941"></a>01941       xp -= bx;
<a name="l01942"></a>01942       yp -= by+bt;
<a name="l01943"></a>01943     }
<a name="l01944"></a>01944     
<a name="l01945"></a>01945     <span class="keywordflow">if</span> (w-&gt;<a class="code" href="classFl__Window.html#a663df072d1d68c5733a1c5f2f88fd819">non_modal</a>() &amp;&amp; <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a> <span class="comment">/*&amp;&amp; !fl_disable_transient_for*/</span>) {
<a name="l01946"></a>01946       <span class="comment">// find some other window to be &quot;transient for&quot;:</span>
<a name="l01947"></a>01947       <a class="code" href="classFl__Window.html">Fl_Window</a>* w = <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a>-&gt;<a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>;
<a name="l01948"></a>01948       <span class="keywordflow">while</span> (w-&gt;<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>()) w = w-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>(); <span class="comment">// todo: this code does not make any sense! (w!=w??)</span>
<a name="l01949"></a>01949     }
<a name="l01950"></a>01950     
<a name="l01951"></a>01951     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="png_8h.html#a90cd716fdb9b68c9661c3ba908a0ceff">name</a> = w-&gt;<a class="code" href="classFl__Window.html#a51a6665c988138e426fc12b4bf138f7b">label</a>();
<a name="l01952"></a>01952     
<a name="l01953"></a>01953     <a class="code" href="classFl__X.html">Fl_X</a>* x = <span class="keyword">new</span> <a class="code" href="classFl__X.html">Fl_X</a>;
<a name="l01954"></a>01954     x-&gt;<a class="code" href="classFl__X.html#a54e86fad0e3c9fc1cdbb72153abacfdf">other_xid</a> = 0; <span class="comment">// room for doublebuffering image map. On OS X this is only used by overlay windows</span>
<a name="l01955"></a>01955     x-&gt;<a class="code" href="classFl__X.html#a2d6b59b7362a486d48b6ae5df0bd0b41">region</a> = 0;
<a name="l01956"></a>01956     x-&gt;subRegion = 0;
<a name="l01957"></a>01957     x-&gt;<a class="code" href="classFl__X.html#acf3febbfadf4ef160511bf7a4bd4572d">cursor</a> = <a class="code" href="win32_8H.html#a5c84f195de614f6aa79fa2f8883b37b6">fl_default_cursor</a>;
<a name="l01958"></a>01958     x-&gt;xidChildren = 0;
<a name="l01959"></a>01959     x-&gt;xidNext = 0;
<a name="l01960"></a>01960     x-&gt;gc = 0;
<a name="l01961"></a>01961           
<a name="l01962"></a>01962     NSRect srect = [[NSScreen mainScreen] frame];
<a name="l01963"></a>01963     NSRect crect;
<a name="l01964"></a>01964     crect.origin.<a class="code" href="classFl__X.html#ae3e071b57b4577d0c13214be9db17ad5">x</a> = w-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>(); 
<a name="l01965"></a>01965     crect.origin.y = srect.size.height - (w-&gt;<a class="code" href="classFl__X.html#a23eeadf6bb296aebcc304d2703f7dfff">y</a>() + w-&gt;<a class="code" href="forms_8H-2.html#a7e427ba5b307f9068129699250690066">h</a>());
<a name="l01966"></a>01966     crect.size.width=w-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>(); 
<a name="l01967"></a>01967     crect.size.height=w-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>();
<a name="l01968"></a>01968     FLWindow *cw = [[FLWindow alloc] initWithFl_W:w 
<a name="l01969"></a>01969                                       contentRect:crect  
<a name="l01970"></a>01970                                         styleMask:winstyle  
<a name="l01971"></a>01971                                           backing:NSBackingStoreBuffered 
<a name="l01972"></a>01972                                             defer:NO];
<a name="l01973"></a>01973     [cw setHasShadow:YES];
<a name="l01974"></a>01974     [cw setAcceptsMouseMovedEvents:YES];
<a name="l01975"></a>01975     x-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a> = cw;
<a name="l01976"></a>01976     FLView *myview = [[FLView alloc] init];
<a name="l01977"></a>01977     [cw setContentView:myview];
<a name="l01978"></a>01978     [cw setLevel:winlevel];
<a name="l01979"></a>01979     
<a name="l01980"></a>01980     q_set_window_title(cw, name);
<a name="l01981"></a>01981     <span class="keywordflow">if</span> (!(w-&gt;<a class="code" href="classFl__Widget.html#a2bd83b947c7f75919afc280043c958db">flags</a>() &amp; <a class="code" href="classFl__Widget.html#acd8a95e8128fe1673479b8d0f4d0aa62a1d2b155a766bc59be7a3f60d306de852" title="don&amp;#39;t let the window manager position the window (Fl_Window)">Fl_Window::FORCE_POSITION</a>)) {
<a name="l01982"></a>01982       <span class="keywordflow">if</span> (w-&gt;<a class="code" href="classFl__Window.html#a6cc843ffcc711300613e44c678ad682f">modal</a>()) {
<a name="l01983"></a>01983         [cw center];
<a name="l01984"></a>01984       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (w-&gt;<a class="code" href="classFl__Window.html#a663df072d1d68c5733a1c5f2f88fd819">non_modal</a>()) {
<a name="l01985"></a>01985         [cw center];
<a name="l01986"></a>01986       } <span class="keywordflow">else</span> {
<a name="l01987"></a>01987         <span class="keyword">static</span> NSPoint delta = NSZeroPoint;
<a name="l01988"></a>01988         delta = [cw cascadeTopLeftFromPoint:delta];
<a name="l01989"></a>01989       }
<a name="l01990"></a>01990     }
<a name="l01991"></a>01991     <span class="keywordflow">if</span>(w-&gt;<a class="code" href="classFl__Window.html#a41889341ef450cbc0ddf99b24f1aa104">menu_window</a>()) { <span class="comment">// make menu windows slightly transparent</span>
<a name="l01992"></a>01992       [cw setAlphaValue:0.97];
<a name="l01993"></a>01993     }
<a name="l01994"></a>01994     x-&gt;<a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a> = <a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>; w-&gt;i = <a class="code" href="classFl__X.html#ae3e071b57b4577d0c13214be9db17ad5">x</a>;
<a name="l01995"></a>01995     x-&gt;<a class="code" href="classFl__X.html#a5bff94b4bde0ceafbaaaaaa3b7d1426e">wait_for_expose</a> = 1;
<a name="l01996"></a>01996     x-&gt;<a class="code" href="classFl__X.html#a41f6a721a953ea62021bb1dd9c4f2187">next</a> = <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a>;
<a name="l01997"></a>01997     <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a> = <a class="code" href="classFl__X.html#ae3e071b57b4577d0c13214be9db17ad5">x</a>;
<a name="l01998"></a>01998     <span class="comment">// Install DnD handlers </span>
<a name="l01999"></a>01999     [myview registerForDraggedTypes:[NSArray arrayWithObjects:
<a name="l02000"></a>02000                                      NSStringPboardType,  NSFilenamesPboardType, nil]];
<a name="l02001"></a>02001     <span class="keywordflow">if</span> ( ! <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a>-&gt;<a class="code" href="classFl__X.html#a41f6a721a953ea62021bb1dd9c4f2187">next</a> ) {        <span class="comment">// if this is the first window, we need to bring the application to the front</span>
<a name="l02002"></a>02002       ProcessSerialNumber psn;
<a name="l02003"></a>02003       OSErr err = GetCurrentProcess( &amp;psn );
<a name="l02004"></a>02004       <span class="keywordflow">if</span> ( err==noErr ) SetFrontProcess( &amp;psn );
<a name="l02005"></a>02005     }
<a name="l02006"></a>02006     
<a name="l02007"></a>02007     <span class="keywordflow">if</span> (w-&gt;size_range_set) w-&gt;size_range_();
<a name="l02008"></a>02008     
<a name="l02009"></a>02009     <span class="keywordflow">if</span> (winlevel != NSMainMenuWindowLevel) {
<a name="l02010"></a>02010       <a class="code" href="classFl__Tooltip.html#a80ef6ebc30fab1c398ae4dd137c88ddc">Fl_Tooltip::enter</a>(0);
<a name="l02011"></a>02011     }
<a name="l02012"></a>02012     [cw makeKeyAndOrderFront:nil];
<a name="l02013"></a>02013     <a class="code" href="group__fl__windows.html#ga3130407bc1c11f9b7f2a9c43a87a1599">Fl::first_window</a>(w);
<a name="l02014"></a>02014     [cw setDelegate:mydelegate];
<a name="l02015"></a>02015     <span class="keywordflow">if</span> (<a class="code" href="Fl__arg_8cxx.html#aeed6a7220f140808e50ef846ef0ad3c2">fl_show_iconic</a>) { 
<a name="l02016"></a>02016       <a class="code" href="Fl__arg_8cxx.html#aeed6a7220f140808e50ef846ef0ad3c2">fl_show_iconic</a> = 0;
<a name="l02017"></a>02017       [cw miniaturize:nil];
<a name="l02018"></a>02018     } <span class="keywordflow">else</span> {
<a name="l02019"></a>02019       w-&gt;<a class="code" href="classFl__Widget.html#a85981546c4927bd5e6d43d6e3df3416a">set_visible</a>();
<a name="l02020"></a>02020     }
<a name="l02021"></a>02021     
<a name="l02022"></a>02022     crect = [[cw contentView] frame];
<a name="l02023"></a>02023     w-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>(<span class="keywordtype">int</span>(crect.size.width));
<a name="l02024"></a>02024     w-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>(<span class="keywordtype">int</span>(crect.size.height));
<a name="l02025"></a>02025     crect = [cw frame];
<a name="l02026"></a>02026     w-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>(<span class="keywordtype">int</span>(crect.origin.x));
<a name="l02027"></a>02027     srect = [[cw screen] frame];
<a name="l02028"></a>02028     w-&gt;<a class="code" href="classFl__Widget.html#aec1aded9efdf5f23dfac8cc725cefc4a">y</a>(<span class="keywordtype">int</span>(srect.size.height - (crect.origin.y + w-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>())));
<a name="l02029"></a>02029     
<a name="l02030"></a>02030     <span class="keywordtype">int</span> old_event = <a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a>;
<a name="l02031"></a>02031     w-&gt;<a class="code" href="classFl__Window.html#a9c0eb1c55a1a62ef3d3d87676f936187">handle</a>(<a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a> = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a9edbfd236c9ea348dcaae935a76bd885">FL_SHOW</a>);
<a name="l02032"></a>02032     <a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a> = old_event;
<a name="l02033"></a>02033     
<a name="l02034"></a>02034     <span class="keywordflow">if</span> (w-&gt;<a class="code" href="classFl__Window.html#a6cc843ffcc711300613e44c678ad682f">modal</a>()) { <a class="code" href="classFl.html#ab9927ecc1f8f3077079c5fabe8ec516e">Fl::modal_</a> = <a class="code" href="classFl__X.html#ac5bc885e2984f98900553c538debabae">w</a>; <a class="code" href="Fl_8cxx.html#afe3a0306383e206c9b1e04accc9a28e7">fl_fix_focus</a>(); }
<a name="l02035"></a>02035     [localPool release];
<a name="l02036"></a>02036   }
<a name="l02037"></a>02037 }
<a name="l02038"></a>02038 
<a name="l02039"></a>02039 
<a name="l02040"></a>02040 <span class="comment">/*</span>
<a name="l02041"></a>02041 <span class="comment"> * Tell the OS what window sizes we want to allow</span>
<a name="l02042"></a>02042 <span class="comment"> */</span>
<a name="l02043"></a>02043 <span class="keywordtype">void</span> Fl_Window::size_range_() {
<a name="l02044"></a>02044   <span class="keywordtype">int</span> bx, by, bt;
<a name="l02045"></a>02045   get_window_frame_sizes(bx, by, bt);
<a name="l02046"></a>02046   size_range_set = 1;
<a name="l02047"></a>02047   NSSize minSize = { minw, minh + bt };
<a name="l02048"></a>02048   NSSize maxSize = { maxw?maxw:32000, maxh?maxh + bt:32000 };
<a name="l02049"></a>02049   <span class="keywordflow">if</span> (i &amp;&amp; i-&gt;xid) {
<a name="l02050"></a>02050     [(NSWindow*)i-&gt;xid setMinSize:minSize];
<a name="l02051"></a>02051     [(NSWindow*)i-&gt;xid setMaxSize:maxSize];
<a name="l02052"></a>02052   }
<a name="l02053"></a>02053 }
<a name="l02054"></a>02054 
<a name="l02055"></a>02055 
<a name="l02056"></a>02056 <span class="comment">/*</span>
<a name="l02057"></a>02057 <span class="comment"> * returns pointer to the filename, or null if name ends with &#39;:&#39;</span>
<a name="l02058"></a>02058 <span class="comment"> */</span>
<a name="l02059"></a>02059 <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="group__filenames.html#ga0ac0f44a1709c6ff94f56a8954dc8fd6">fl_filename_name</a>( <span class="keyword">const</span> <span class="keywordtype">char</span> *name ) 
<a name="l02060"></a>02060 {
<a name="l02061"></a>02061   <span class="keyword">const</span> <span class="keywordtype">char</span> *p, *q;
<a name="l02062"></a>02062   <span class="keywordflow">if</span> (!name) <span class="keywordflow">return</span> (0);
<a name="l02063"></a>02063   <span class="keywordflow">for</span> ( p = q = name ; *p ; ) {
<a name="l02064"></a>02064     <span class="keywordflow">if</span> ( ( p[0] == <span class="charliteral">&#39;:&#39;</span> ) &amp;&amp; ( p[1] == <span class="charliteral">&#39;:&#39;</span> ) ) {
<a name="l02065"></a>02065       q = p+2;
<a name="l02066"></a>02066       p++;
<a name="l02067"></a>02067     }
<a name="l02068"></a>02068     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p[0] == <span class="charliteral">&#39;/&#39;</span>) {
<a name="l02069"></a>02069       q = p + 1;
<a name="l02070"></a>02070     }
<a name="l02071"></a>02071     p++;
<a name="l02072"></a>02072   }
<a name="l02073"></a>02073   <span class="keywordflow">return</span> q;
<a name="l02074"></a>02074 }
<a name="l02075"></a>02075 
<a name="l02076"></a>02076 
<a name="l02077"></a>02077 <span class="comment">/*</span>
<a name="l02078"></a>02078 <span class="comment"> * set the window title bar</span>
<a name="l02079"></a>02079 <span class="comment"> * \todo make the titlebar icon work!</span>
<a name="l02080"></a>02080 <span class="comment"> */</span>
<a name="l02081"></a>02081 <span class="keywordtype">void</span> <a class="code" href="classFl__Window.html#a51a6665c988138e426fc12b4bf138f7b">Fl_Window::label</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *name,<span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="comment">/*iname*/</span>) {
<a name="l02082"></a>02082   <a class="code" href="classFl__Window.html#a51a6665c988138e426fc12b4bf138f7b">Fl_Widget::label</a>(name);
<a name="l02083"></a>02083   <span class="keywordflow">if</span> (<a class="code" href="classFl__Window.html#aa09300542b2d8b49fc69a037bdd3b742">shown</a>() || i) {
<a name="l02084"></a>02084     q_set_window_title((NSWindow*)i-&gt;xid, name);
<a name="l02085"></a>02085   }
<a name="l02086"></a>02086 }
<a name="l02087"></a>02087 
<a name="l02088"></a>02088 
<a name="l02089"></a>02089 <span class="comment">/*</span>
<a name="l02090"></a>02090 <span class="comment"> * make a window visible</span>
<a name="l02091"></a>02091 <span class="comment"> */</span>
<a name="l02092"></a>02092 <span class="keywordtype">void</span> <a class="code" href="classFl__Window.html#afc4d3796226dfd4620b4d7cf29c287c9">Fl_Window::show</a>() {
<a name="l02093"></a>02093   <a class="code" href="classFl__Widget.html#a42372b96b98b126a211b88dc935c2ae6">image</a>(<a class="code" href="classFl.html#a653ad1197e2b6e99038c86a2ab6a9b46">Fl::scheme_bg_</a>);
<a name="l02094"></a>02094   <span class="keywordflow">if</span> (<a class="code" href="classFl.html#a653ad1197e2b6e99038c86a2ab6a9b46">Fl::scheme_bg_</a>) {
<a name="l02095"></a>02095     <a class="code" href="classFl__Widget.html#ad85415f61c0a5513bc524c4b6fc2b57e">labeltype</a>(<a class="code" href="Enumerations_8H.html#ad5774781d33328b82990ff9e25dfd61ba81ddb843b9f43f73446ea7d6d7d8cc84" title="draws the text (0)">FL_NORMAL_LABEL</a>);
<a name="l02096"></a>02096     <a class="code" href="classFl__Widget.html#aad980d813b8a47d777bde7cfa6b85eae">align</a>(<a class="code" href="Enumerations_8H.html#a427f1ce53c37478a59f64bec4a2e2241">FL_ALIGN_CENTER</a> | <a class="code" href="Enumerations_8H.html#ade440c90fc9c2495fdf04c9cb34fba34">FL_ALIGN_INSIDE</a> | <a class="code" href="Enumerations_8H.html#a527e2db976be1a8508c226b4ca54eaa7">FL_ALIGN_CLIP</a>);
<a name="l02097"></a>02097   } <span class="keywordflow">else</span> {
<a name="l02098"></a>02098     <a class="code" href="classFl__Widget.html#ad85415f61c0a5513bc524c4b6fc2b57e">labeltype</a>(<a class="code" href="Enumerations_8H.html#ad5774781d33328b82990ff9e25dfd61bac7e2de1d28830fe78743126eebcbe13b" title="does nothing">FL_NO_LABEL</a>);
<a name="l02099"></a>02099   }
<a name="l02100"></a>02100   <a class="code" href="classFl__Tooltip.html#af68420923dbbb7f9381b0852ad885d90">Fl_Tooltip::exit</a>(<span class="keyword">this</span>);
<a name="l02101"></a>02101   <span class="keywordflow">if</span> (!<a class="code" href="classFl__Window.html#aa09300542b2d8b49fc69a037bdd3b742">shown</a>() || !i) {
<a name="l02102"></a>02102     <a class="code" href="classFl__X.html#a2d3acae437e4eea48e44c08b2543da73">Fl_X::make</a>(<span class="keyword">this</span>);
<a name="l02103"></a>02103   } <span class="keywordflow">else</span> {
<a name="l02104"></a>02104     <span class="keywordflow">if</span> ( !<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>() ) {
<a name="l02105"></a>02105       <span class="keywordflow">if</span> ([(NSWindow*)i-&gt;xid isMiniaturized]) {
<a name="l02106"></a>02106         i-&gt;w-&gt;redraw();
<a name="l02107"></a>02107         [(NSWindow*)i-&gt;xid deminiaturize:nil];
<a name="l02108"></a>02108       }
<a name="l02109"></a>02109       <span class="keywordflow">if</span> (!<a class="code" href="Fl__mac_8cxx.html#a6e10f30f9e6dd98ed093691fd605a0c2">fl_capture</a>) {
<a name="l02110"></a>02110         [(NSWindow*)i-&gt;xid makeKeyAndOrderFront:nil];
<a name="l02111"></a>02111       }
<a name="l02112"></a>02112     }
<a name="l02113"></a>02113   }
<a name="l02114"></a>02114 }
<a name="l02115"></a>02115 
<a name="l02116"></a>02116 
<a name="l02117"></a>02117 <span class="comment">/*</span>
<a name="l02118"></a>02118 <span class="comment"> * resize a window</span>
<a name="l02119"></a>02119 <span class="comment"> */</span>
<a name="l02120"></a>02120 <span class="keywordtype">void</span> <a class="code" href="classFl__Window.html#a7b3f27fe1b0fbc2a06065a7f037a2fbb">Fl_Window::resize</a>(<span class="keywordtype">int</span> X,<span class="keywordtype">int</span> Y,<span class="keywordtype">int</span> W,<span class="keywordtype">int</span> H) {
<a name="l02121"></a>02121   <span class="keywordtype">int</span> bx, by, bt;
<a name="l02122"></a>02122   <span class="keywordflow">if</span> ( ! this-&gt;<a class="code" href="classFl__Window.html#a39a0c5da9d2c16940b8d681a977ec17c">border</a>() ) bt = 0;
<a name="l02123"></a>02123   <span class="keywordflow">else</span> get_window_frame_sizes(bx, by, bt);
<a name="l02124"></a>02124   <span class="keywordflow">if</span> (W&lt;=0) W = 1; <span class="comment">// OS X does not like zero width windows</span>
<a name="l02125"></a>02125   <span class="keywordflow">if</span> (H&lt;=0) H = 1;
<a name="l02126"></a>02126   <span class="keywordtype">int</span> is_a_resize = (W != <a class="code" href="classFl__Widget.html#aec9e0a6f77d93e6f8caffc1b0f6abbda">w</a>() || H != <a class="code" href="classFl__Widget.html#a994f71abd8b39c87cef909713d3347f0">h</a>());
<a name="l02127"></a>02127   <span class="comment">//  printf(&quot;Fl_Window::resize(X=%d, Y=%d, W=%d, H=%d), is_a_resize=%d, resize_from_system=%p, this=%p\n&quot;,</span>
<a name="l02128"></a>02128   <span class="comment">//         X, Y, W, H, is_a_resize, resize_from_system, this);</span>
<a name="l02129"></a>02129   <span class="keywordflow">if</span> (X != <a class="code" href="classFl__Widget.html#ad09bc10de43482a671f834a653211e9f">x</a>() || Y != <a class="code" href="classFl__Widget.html#a54fbdc7be9ae81c6b34abc73a93908f1">y</a>()) <a class="code" href="classFl__Widget.html#a7244e112711741978f19ceadd8f196b5">set_flag</a>(<a class="code" href="classFl__Widget.html#acd8a95e8128fe1673479b8d0f4d0aa62a1d2b155a766bc59be7a3f60d306de852" title="don&amp;#39;t let the window manager position the window (Fl_Window)">FORCE_POSITION</a>);
<a name="l02130"></a>02130   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!is_a_resize) <span class="keywordflow">return</span>;
<a name="l02131"></a>02131   <span class="keywordflow">if</span> ( (resize_from_system!=<span class="keyword">this</span>) &amp;&amp; (!<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>()) &amp;&amp; <a class="code" href="classFl__Window.html#aa09300542b2d8b49fc69a037bdd3b742">shown</a>()) {
<a name="l02132"></a>02132     <span class="keywordflow">if</span> (is_a_resize) {
<a name="l02133"></a>02133       <span class="keywordflow">if</span> (<a class="code" href="classFl__Group.html#aef229a2364bd97ac364a0ec29231ce90">resizable</a>()) {
<a name="l02134"></a>02134         <span class="keywordflow">if</span> (W&lt;minw) minw = W; <span class="comment">// user request for resize takes priority</span>
<a name="l02135"></a>02135         <span class="keywordflow">if</span> (W&gt;maxw) maxw = W; <span class="comment">// over a previously set size_range</span>
<a name="l02136"></a>02136         <span class="keywordflow">if</span> (H&lt;minh) minh = <a class="code" href="Fl__Tooltip_8cxx.html#affa487e8e3cc48473cfc05c0ce0165e9">H</a>;
<a name="l02137"></a>02137         <span class="keywordflow">if</span> (H&gt;maxh) maxh = <a class="code" href="Fl__Tooltip_8cxx.html#affa487e8e3cc48473cfc05c0ce0165e9">H</a>;
<a name="l02138"></a>02138         <a class="code" href="classFl__Window.html#a9be71df81e121b984f33140720102d59">size_range</a>(minw, minh, maxw, maxh);
<a name="l02139"></a>02139       } <span class="keywordflow">else</span> {
<a name="l02140"></a>02140         <a class="code" href="classFl__Window.html#a9be71df81e121b984f33140720102d59">size_range</a>(W, H, W, H);
<a name="l02141"></a>02141       }
<a name="l02142"></a>02142       NSRect dim;
<a name="l02143"></a>02143       dim.origin.x = X;
<a name="l02144"></a>02144       dim.origin.y = [[(NSWindow*)i-&gt;xid screen] frame].size.height - (Y + H);
<a name="l02145"></a>02145       dim.size.width = W;
<a name="l02146"></a>02146       dim.size.height = H + bt;
<a name="l02147"></a>02147       [(NSWindow*)i-&gt;xid setFrame:dim display:YES];
<a name="l02148"></a>02148     } <span class="keywordflow">else</span> {
<a name="l02149"></a>02149       NSPoint pt; 
<a name="l02150"></a>02150       pt.x = X; 
<a name="l02151"></a>02151       pt.y = [[(NSWindow*)i-&gt;xid screen] frame].size.height - (Y + <a class="code" href="classFl__Widget.html#a994f71abd8b39c87cef909713d3347f0">h</a>());
<a name="l02152"></a>02152       [(NSWindow*)i-&gt;xid setFrameOrigin:pt];
<a name="l02153"></a>02153     }
<a name="l02154"></a>02154   }
<a name="l02155"></a>02155   resize_from_system = 0;
<a name="l02156"></a>02156   <span class="keywordflow">if</span> (is_a_resize) {
<a name="l02157"></a>02157     <a class="code" href="classFl__Window.html#a7b3f27fe1b0fbc2a06065a7f037a2fbb">Fl_Group::resize</a>(X,Y,W,H);
<a name="l02158"></a>02158     <span class="keywordflow">if</span> (<a class="code" href="classFl__Window.html#aa09300542b2d8b49fc69a037bdd3b742">shown</a>()) { 
<a name="l02159"></a>02159       <a class="code" href="classFl__Widget.html#aa63ce68cbf4620cf8750b868368ea02b">redraw</a>(); 
<a name="l02160"></a>02160     }
<a name="l02161"></a>02161   } <span class="keywordflow">else</span> {
<a name="l02162"></a>02162     <a class="code" href="classFl__Widget.html#ad09bc10de43482a671f834a653211e9f">x</a>(X); <a class="code" href="classFl__Widget.html#a54fbdc7be9ae81c6b34abc73a93908f1">y</a>(Y); 
<a name="l02163"></a>02163   }
<a name="l02164"></a>02164 }
<a name="l02165"></a>02165 
<a name="l02166"></a>02166 
<a name="l02167"></a>02167 <span class="comment">/*</span>
<a name="l02168"></a>02168 <span class="comment"> * make all drawing go into this window (called by subclass flush() impl.)</span>
<a name="l02169"></a>02169 <span class="comment"> */</span>
<a name="l02170"></a>02170 <span class="keywordtype">void</span> <a class="code" href="classFl__Window.html#a65a2499309b3fdd1bed463cefa0cd1e2">Fl_Window::make_current</a>() 
<a name="l02171"></a>02171 {
<a name="l02172"></a>02172   Fl_X::q_release_context();
<a name="l02173"></a>02173   <a class="code" href="win32_8H.html#afdab6664143864c36ba6b51782b32500">fl_window</a> = i-&gt;xid;
<a name="l02174"></a>02174   <a class="code" href="classFl__Window.html#ab9f4f5ec887ad5f4eac561eb02a97402">current_</a> = <span class="keyword">this</span>;
<a name="l02175"></a>02175   
<a name="l02176"></a>02176   <span class="keywordtype">int</span> xp = 0, yp = 0;
<a name="l02177"></a>02177   <a class="code" href="classFl__Window.html">Fl_Window</a> *win = <span class="keyword">this</span>;
<a name="l02178"></a>02178   <span class="keywordflow">while</span> ( win ) {
<a name="l02179"></a>02179     <span class="keywordflow">if</span> ( !win-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>() )
<a name="l02180"></a>02180       <span class="keywordflow">break</span>;
<a name="l02181"></a>02181     xp += win-&gt;x();
<a name="l02182"></a>02182     yp += win-&gt;<a class="code" href="classFl__Widget.html#a54fbdc7be9ae81c6b34abc73a93908f1">y</a>();
<a name="l02183"></a>02183     win = (<a class="code" href="classFl__Window.html">Fl_Window</a>*)win-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>();
<a name="l02184"></a>02184   }
<a name="l02185"></a>02185   
<a name="l02186"></a>02186   NSView *current_focus = [NSView focusView]; 
<a name="l02187"></a>02187   <span class="comment">// sometimes current_focus is set to a non-FLTK view: don&#39;t touch that</span>
<a name="l02188"></a>02188   <span class="keywordflow">if</span> ( [current_focus isKindOfClass:[FLView <span class="keyword">class</span>]] ) [current_focus unlockFocus];
<a name="l02189"></a>02189   [[(NSWindow*)i-&gt;xid contentView]  lockFocus];
<a name="l02190"></a>02190   i-&gt;gc = (CGContextRef)[[NSGraphicsContext currentContext] graphicsPort];
<a name="l02191"></a>02191   <a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a> = i-&gt;gc;
<a name="l02192"></a>02192   <a class="code" href="mac_8H.html#aa3f54ef9dd28ee61ae42bd36291a31f2">Fl_Region</a> <a class="code" href="Fl__mac_8cxx.html#afe6a785e40298db77c700ceb9b6f7193">fl_window_region</a> = <a class="code" href="win32_8H.html#a2381eb7ab4ad62c68c478d6d70f85b09">XRectangleRegion</a>(0,0,<a class="code" href="classFl__Widget.html#aec9e0a6f77d93e6f8caffc1b0f6abbda">w</a>(),<a class="code" href="classFl__Widget.html#a994f71abd8b39c87cef909713d3347f0">h</a>());
<a name="l02193"></a>02193   <span class="keywordflow">if</span> ( ! this-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>() ) {
<a name="l02194"></a>02194     <span class="keywordflow">for</span> ( <a class="code" href="classFl__X.html">Fl_X</a> *cx = i-&gt;xidChildren; cx; cx = cx-&gt;xidNext ) {   <span class="comment">// clip-out all sub-windows</span>
<a name="l02195"></a>02195       <a class="code" href="classFl__Window.html">Fl_Window</a> *cw = cx-&gt;w;
<a name="l02196"></a>02196       <a class="code" href="mac_8H.html#aa3f54ef9dd28ee61ae42bd36291a31f2">Fl_Region</a> from = <a class="code" href="Fl__mac_8cxx.html#afe6a785e40298db77c700ceb9b6f7193">fl_window_region</a>;
<a name="l02197"></a>02197       fl_window_region = MacRegionMinusRect(from, cw-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>(), cw-&gt;<a class="code" href="classFl__Widget.html#aec1aded9efdf5f23dfac8cc725cefc4a">y</a>(), cw-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>(), cw-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>() );
<a name="l02198"></a>02198       <a class="code" href="win32_8H.html#aa9ab8e4893ef97f9bf92e66e2c51778b">XDestroyRegion</a>(from);
<a name="l02199"></a>02199     }
<a name="l02200"></a>02200   }
<a name="l02201"></a>02201   
<a name="l02202"></a>02202   <span class="comment">// antialiasing must be deactivated because it applies to rectangles too</span>
<a name="l02203"></a>02203   <span class="comment">// and escapes even clipping!!!</span>
<a name="l02204"></a>02204   <span class="comment">// it gets activated when needed (e.g., draw text)</span>
<a name="l02205"></a>02205   CGContextSetShouldAntialias(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>, <span class="keyword">false</span>);  
<a name="l02206"></a>02206   CGFloat hgt = [[(NSWindow*)fl_window contentView] frame].size.height;
<a name="l02207"></a>02207   CGContextTranslateCTM(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>, 0.5, hgt-0.5f);
<a name="l02208"></a>02208   CGContextScaleCTM(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>, 1.0f, -1.0f); <span class="comment">// now 0,0 is top-left point of the window</span>
<a name="l02209"></a>02209   win = <span class="keyword">this</span>;
<a name="l02210"></a>02210   <span class="keywordflow">while</span>(win &amp;&amp; win-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>()) { <span class="comment">// translate to subwindow origin if this is a subwindow context</span>
<a name="l02211"></a>02211     CGContextTranslateCTM(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>, win-&gt;<a class="code" href="classFl__Widget.html#abea0b9ad493d58bf7fda8d3c81d477b7">x</a>(), win-&gt;<a class="code" href="classFl__Widget.html#aec1aded9efdf5f23dfac8cc725cefc4a">y</a>());
<a name="l02212"></a>02212     win = win-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>();
<a name="l02213"></a>02213   }
<a name="l02214"></a>02214   <span class="comment">//apply window&#39;s clip</span>
<a name="l02215"></a>02215   CGContextClipToRects(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>, fl_window_region-&gt;rects, fl_window_region-&gt;count );
<a name="l02216"></a>02216   <a class="code" href="win32_8H.html#aa9ab8e4893ef97f9bf92e66e2c51778b">XDestroyRegion</a>(fl_window_region);
<a name="l02217"></a>02217 <span class="comment">// this is the context with origin at top left of (sub)window clipped out of its subwindows if any</span>
<a name="l02218"></a>02218   <a class="code" href="cgdebug_8h.html#a4fbec629d6e26e1508c812a84cafbb90">CGContextSaveGState</a>(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>); 
<a name="l02219"></a>02219 <span class="preprocessor">#if defined(FLTK_USE_CAIRO)</span>
<a name="l02220"></a>02220 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (Fl::cairo_autolink_context()) Fl::cairo_make_current(<span class="keyword">this</span>); <span class="comment">// capture gc changes automatically to update the cairo context adequately</span>
<a name="l02221"></a>02221 <span class="preprocessor">#endif</span>
<a name="l02222"></a>02222 <span class="preprocessor"></span>  <a class="code" href="group__fl__drawings.html#gaa9cb59129942d660fb7472c653d3589e">fl_clip_region</a>( 0 );
<a name="l02223"></a>02223   
<a name="l02224"></a>02224 <span class="preprocessor">#if defined(FLTK_USE_CAIRO)</span>
<a name="l02225"></a>02225 <span class="preprocessor"></span>  <span class="comment">// update the cairo_t context</span>
<a name="l02226"></a>02226   <span class="keywordflow">if</span> (Fl::cairo_autolink_context()) Fl::cairo_make_current(<span class="keyword">this</span>);
<a name="l02227"></a>02227 <span class="preprocessor">#endif</span>
<a name="l02228"></a>02228 <span class="preprocessor"></span>}
<a name="l02229"></a>02229 
<a name="l02230"></a>02230 <span class="comment">// helper function to manage the current CGContext fl_gc</span>
<a name="l02231"></a>02231 <span class="keyword">extern</span> <a class="code" href="Enumerations_8H.html#a8b762953646f8abee866061f1af78a6a">Fl_Color</a> <a class="code" href="group__fl__attributes.html#ga98168ab58de419961165f303b7c525a6" title="The current color.">fl_color_</a>;
<a name="l02232"></a>02232 <span class="keyword">extern</span> <span class="keyword">class </span><a class="code" href="classFl__Font__Descriptor.html">Fl_Font_Descriptor</a> *<a class="code" href="Fl__Font_8H.html#ae08261f97c0d2c5962bd28869fd871e7">fl_fontsize</a>;
<a name="l02233"></a>02233 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="group__fl__attributes.html#ga1bdba1e2b321676da6b0b290f485bf27">fl_font</a>(<span class="keyword">class</span> <a class="code" href="classFl__Font__Descriptor.html">Fl_Font_Descriptor</a>*);
<a name="l02234"></a>02234 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="Fl__mac_8cxx.html#a07bd33f242fc60ede971d731dff14a86">fl_quartz_restore_line_style_</a>();
<a name="l02235"></a>02235 
<a name="l02236"></a>02236 <span class="comment">// FLTK has only one global graphics state. This function copies the FLTK state into the</span>
<a name="l02237"></a>02237 <span class="comment">// current Quartz context</span>
<a name="l02238"></a>02238 <span class="keywordtype">void</span> Fl_X::q_fill_context() {
<a name="l02239"></a>02239   <span class="keywordflow">if</span> (!<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>) <span class="keywordflow">return</span>;
<a name="l02240"></a>02240   <span class="keywordflow">if</span> ( ! <a class="code" href="win32_8H.html#afdab6664143864c36ba6b51782b32500">fl_window</a>) { <span class="comment">// a bitmap context</span>
<a name="l02241"></a>02241     <span class="keywordtype">size_t</span> hgt = CGBitmapContextGetHeight(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>);
<a name="l02242"></a>02242     CGContextTranslateCTM(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>, 0.5, hgt-0.5f);
<a name="l02243"></a>02243     CGContextScaleCTM(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>, 1.0f, -1.0f); <span class="comment">// now 0,0 is top-left point of the context</span>
<a name="l02244"></a>02244     }
<a name="l02245"></a>02245   <a class="code" href="group__fl__attributes.html#ga1bdba1e2b321676da6b0b290f485bf27">fl_font</a>(fl_fontsize);
<a name="l02246"></a>02246   <a class="code" href="group__fl__attributes.html#ga974e9f64959aa83cf6f0a36d3f0105aa">fl_color</a>(fl_color_);
<a name="l02247"></a>02247   <a class="code" href="Fl__mac_8cxx.html#a07bd33f242fc60ede971d731dff14a86">fl_quartz_restore_line_style_</a>();
<a name="l02248"></a>02248 }
<a name="l02249"></a>02249 
<a name="l02250"></a>02250 <span class="comment">// The only way to reset clipping to its original state is to pop the current graphics</span>
<a name="l02251"></a>02251 <span class="comment">// state and restore the global state.</span>
<a name="l02252"></a>02252 <span class="keywordtype">void</span> Fl_X::q_clear_clipping() {
<a name="l02253"></a>02253   <span class="keywordflow">if</span> (!<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>) <span class="keywordflow">return</span>;
<a name="l02254"></a>02254   <a class="code" href="cgdebug_8h.html#afeea8e876e977d350ccb421a7c7e0acb">CGContextRestoreGState</a>(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>);
<a name="l02255"></a>02255   <a class="code" href="cgdebug_8h.html#a4fbec629d6e26e1508c812a84cafbb90">CGContextSaveGState</a>(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>);
<a name="l02256"></a>02256 }
<a name="l02257"></a>02257 
<a name="l02258"></a>02258 <span class="comment">// Give the Quartz context back to the system</span>
<a name="l02259"></a>02259 <span class="keywordtype">void</span> Fl_X::q_release_context(<a class="code" href="classFl__X.html">Fl_X</a> *x) {
<a name="l02260"></a>02260   <span class="keywordflow">if</span> (x &amp;&amp; x-&gt;gc!=<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>) <span class="keywordflow">return</span>;
<a name="l02261"></a>02261   <span class="keywordflow">if</span> (!<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>) <span class="keywordflow">return</span>;
<a name="l02262"></a>02262   <a class="code" href="cgdebug_8h.html#afeea8e876e977d350ccb421a7c7e0acb">CGContextRestoreGState</a>(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>); <span class="comment">// matches the CGContextSaveGState of make_current</span>
<a name="l02263"></a>02263   <a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a> = 0;
<a name="l02264"></a>02264 <span class="preprocessor">#if defined(FLTK_USE_CAIRO)</span>
<a name="l02265"></a>02265 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (Fl::cairo_autolink_context()) Fl::cairo_make_current((<a class="code" href="classFl__Window.html">Fl_Window</a>*) 0); <span class="comment">// capture gc changes automatically to update the cairo context adequately</span>
<a name="l02266"></a>02266 <span class="preprocessor">#endif</span>
<a name="l02267"></a>02267 <span class="preprocessor"></span>}
<a name="l02268"></a>02268 
<a name="l02269"></a>02269 <span class="keywordtype">void</span> Fl_X::q_begin_image(CGRect &amp;rect, <span class="keywordtype">int</span> cx, <span class="keywordtype">int</span> cy, <span class="keywordtype">int</span> w, <span class="keywordtype">int</span> <a class="code" href="classFl__Widget.html#a994f71abd8b39c87cef909713d3347f0">h</a>) {
<a name="l02270"></a>02270   <a class="code" href="cgdebug_8h.html#a4fbec629d6e26e1508c812a84cafbb90">CGContextSaveGState</a>(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>);
<a name="l02271"></a>02271   CGRect r2 = <a class="code" href="gl2opengl_8h.html#a856fcb8a7983d83666201749244432e5">rect</a>;
<a name="l02272"></a>02272   r2.origin.x -= 0.5f;
<a name="l02273"></a>02273   r2.origin.y -= 0.5f;
<a name="l02274"></a>02274   <a class="code" href="cgdebug_8h.html#aaa9e0839f29f4c704e38719446d19a7b">CGContextClipToRect</a>(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>, r2);
<a name="l02275"></a>02275   <span class="comment">// move graphics context to origin of vertically reversed image </span>
<a name="l02276"></a>02276   CGContextTranslateCTM(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>, rect.origin.x - cx - 0.5, rect.origin.y - cy + h - 0.5);
<a name="l02277"></a>02277   CGContextScaleCTM(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>, 1, -1);
<a name="l02278"></a>02278   rect.origin.x = rect.origin.y = 0;
<a name="l02279"></a>02279   rect.size.width = <a class="code" href="classFl__Widget.html#aec9e0a6f77d93e6f8caffc1b0f6abbda">w</a>;
<a name="l02280"></a>02280   rect.size.height = <a class="code" href="classFl__Widget.html#a994f71abd8b39c87cef909713d3347f0">h</a>;
<a name="l02281"></a>02281 }
<a name="l02282"></a>02282 
<a name="l02283"></a>02283 <span class="keywordtype">void</span> Fl_X::q_end_image() {
<a name="l02284"></a>02284   <a class="code" href="cgdebug_8h.html#afeea8e876e977d350ccb421a7c7e0acb">CGContextRestoreGState</a>(<a class="code" href="mac_8H.html#a9b2af459c0a223b6274f508339c783a6">fl_gc</a>);
<a name="l02285"></a>02285 }
<a name="l02286"></a>02286 
<a name="l02287"></a>02287 
<a name="l02289"></a>02289 <span class="comment">// Copy &amp; Paste fltk implementation.</span>
<a name="l02291"></a>02291 <span class="comment"></span>
<a name="l02292"></a>02292 <span class="keyword">static</span> <span class="keywordtype">void</span> convert_crlf(<span class="keywordtype">char</span> * s, <span class="keywordtype">size_t</span> len)
<a name="l02293"></a>02293 {
<a name="l02294"></a>02294   <span class="comment">// turn all \r characters into \n:</span>
<a name="l02295"></a>02295   <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> x = 0; x &lt; len; x++) if (s[x] == &#39;\r&#39;) s[x] = &#39;\n&#39;;
<a name="l02296"></a>02296 }
<a name="l02297"></a>02297 
<a name="l02298"></a>02298 <span class="comment">// fltk 1.3 clipboard support constant definitions:</span>
<a name="l02299"></a>02299 <span class="keyword">const</span> CFStringRef       <a class="code" href="Fl__mac_8cxx.html#a1a6c131b0d648ca83b7835cfbb014aee">flavorNames</a>[] = {
<a name="l02300"></a>02300   CFSTR(<span class="stringliteral">&quot;public.utf16-plain-text&quot;</span>), 
<a name="l02301"></a>02301   CFSTR(<span class="stringliteral">&quot;public.utf8-plain-text&quot;</span>),
<a name="l02302"></a>02302   CFSTR(<span class="stringliteral">&quot;com.apple.traditional-mac-plain-text&quot;</span>) };
<a name="l02303"></a>02303 <span class="keyword">const</span> CFStringEncoding <a class="code" href="Fl__mac_8cxx.html#a2e6c7dc48613ecc3b3fed3084e6be110">encodings</a>[] = { 
<a name="l02304"></a>02304   kCFStringEncodingUnicode, 
<a name="l02305"></a>02305   kCFStringEncodingUTF8, 
<a name="l02306"></a>02306   kCFStringEncodingMacRoman};
<a name="l02307"></a>02307 <span class="keyword">const</span> <span class="keywordtype">size_t</span> <a class="code" href="Fl__mac_8cxx.html#ac6954cdae777da2c2201a0d21a7f66f0">handledFlavorsCount</a> = <span class="keyword">sizeof</span>(<a class="code" href="Fl__mac_8cxx.html#a2e6c7dc48613ecc3b3fed3084e6be110">encodings</a>)/<span class="keyword">sizeof</span>(CFStringEncoding);
<a name="l02308"></a>02308 
<a name="l02309"></a>02309 <span class="comment">// clipboard variables definitions :</span>
<a name="l02310"></a>02310 <span class="keywordtype">char</span> *<a class="code" href="fl__dnd__win32_8cxx.html#ab850f01f9743ea1b220f00c8bda656be">fl_selection_buffer</a>[2];
<a name="l02311"></a>02311 <span class="keywordtype">int</span> <a class="code" href="fl__dnd__win32_8cxx.html#ac27fcc9909cfd33bc0bbd5085312a301">fl_selection_length</a>[2];
<a name="l02312"></a>02312 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="fl__dnd__win32_8cxx.html#a074479f79d157734e2835b1885ade608">fl_selection_buffer_length</a>[2];
<a name="l02313"></a>02313 
<a name="l02314"></a>02314 <span class="keyword">static</span> PasteboardRef myPasteboard = 0;
<a name="l02315"></a>02315 <span class="keyword">static</span> <span class="keywordtype">void</span> allocatePasteboard() {
<a name="l02316"></a>02316   <span class="keywordflow">if</span> (!myPasteboard)
<a name="l02317"></a>02317     PasteboardCreate(kPasteboardClipboard, &amp;myPasteboard);
<a name="l02318"></a>02318 }
<a name="l02319"></a>02319 
<a name="l02320"></a>02320 
<a name="l02321"></a>02321 <span class="comment">/*</span>
<a name="l02322"></a>02322 <span class="comment"> * create a selection</span>
<a name="l02323"></a>02323 <span class="comment"> * owner: widget that created the selection</span>
<a name="l02324"></a>02324 <span class="comment"> * stuff: pointer to selected data</span>
<a name="l02325"></a>02325 <span class="comment"> * size of selected data</span>
<a name="l02326"></a>02326 <span class="comment"> */</span>
<a name="l02327"></a>02327 <span class="keywordtype">void</span> <a class="code" href="group__fl__clipboard.html#gaa219ad0a09d4ff6f7d8feddcc7e96b90">Fl::copy</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *stuff, <span class="keywordtype">int</span> len, <span class="keywordtype">int</span> clipboard) {
<a name="l02328"></a>02328   <span class="keywordflow">if</span> (!stuff || len&lt;0) <span class="keywordflow">return</span>;
<a name="l02329"></a>02329   <span class="keywordflow">if</span> (len+1 &gt; fl_selection_buffer_length[clipboard]) {
<a name="l02330"></a>02330     <span class="keyword">delete</span>[] fl_selection_buffer[clipboard];
<a name="l02331"></a>02331     fl_selection_buffer[clipboard] = <span class="keyword">new</span> <span class="keywordtype">char</span>[len+100];
<a name="l02332"></a>02332     fl_selection_buffer_length[clipboard] = len+100;
<a name="l02333"></a>02333   }
<a name="l02334"></a>02334   memcpy(fl_selection_buffer[clipboard], stuff, len);
<a name="l02335"></a>02335   fl_selection_buffer[clipboard][len] = 0; <span class="comment">// needed for direct paste</span>
<a name="l02336"></a>02336   fl_selection_length[clipboard] = len;
<a name="l02337"></a>02337   <span class="keywordflow">if</span> (clipboard) {
<a name="l02338"></a>02338     allocatePasteboard();
<a name="l02339"></a>02339     OSStatus err = PasteboardClear(myPasteboard);
<a name="l02340"></a>02340     <span class="keywordflow">if</span> (err!=noErr) <span class="keywordflow">return</span>; <span class="comment">// clear did not work, maybe not owner of clipboard.</span>
<a name="l02341"></a>02341     PasteboardSynchronize(myPasteboard);
<a name="l02342"></a>02342     CFDataRef text = CFDataCreate(kCFAllocatorDefault, (UInt8*)fl_selection_buffer[1], len);
<a name="l02343"></a>02343     <span class="keywordflow">if</span> (text==<a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>; <span class="comment">// there was a pb creating the object, abort.</span>
<a name="l02344"></a>02344     err=PasteboardPutItemFlavor(myPasteboard, (PasteboardItemID)1, CFSTR(<span class="stringliteral">&quot;public.utf8-plain-text&quot;</span>), text, 0);
<a name="l02345"></a>02345     CFRelease(text);
<a name="l02346"></a>02346   }
<a name="l02347"></a>02347 }
<a name="l02348"></a>02348 
<a name="l02349"></a>02349 <span class="comment">// Call this when a &quot;paste&quot; operation happens:</span>
<a name="l02350"></a>02350 <span class="keywordtype">void</span> <a class="code" href="group__fl__clipboard.html#ga2d0fc8fedc6bfc23f378b3f100660d80">Fl::paste</a>(<a class="code" href="classFl__Widget.html">Fl_Widget</a> &amp;receiver, <span class="keywordtype">int</span> clipboard) {
<a name="l02351"></a>02351   <span class="keywordflow">if</span> (clipboard) {
<a name="l02352"></a>02352     <span class="comment">// see if we own the selection, if not go get it:</span>
<a name="l02353"></a>02353     fl_selection_length[1] = 0;
<a name="l02354"></a>02354     OSStatus err = noErr;
<a name="l02355"></a>02355     Boolean found = <span class="keyword">false</span>;
<a name="l02356"></a>02356     CFDataRef flavorData = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02357"></a>02357     CFStringEncoding encoding = 0;
<a name="l02358"></a>02358     
<a name="l02359"></a>02359     allocatePasteboard();
<a name="l02360"></a>02360     PasteboardSynchronize(myPasteboard);
<a name="l02361"></a>02361     ItemCount nFlavor = 0, <a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>, j;
<a name="l02362"></a>02362     err = PasteboardGetItemCount(myPasteboard, &amp;nFlavor);
<a name="l02363"></a>02363     <span class="keywordflow">if</span> (err==noErr) {
<a name="l02364"></a>02364       <span class="keywordflow">for</span> (i=1; i&lt;=nFlavor; i++) {
<a name="l02365"></a>02365         PasteboardItemID itemID = 0;
<a name="l02366"></a>02366         CFArrayRef flavorTypeArray = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02367"></a>02367         found = <span class="keyword">false</span>;
<a name="l02368"></a>02368         err = PasteboardGetItemIdentifier(myPasteboard, i, &amp;itemID);
<a name="l02369"></a>02369         <span class="keywordflow">if</span> (err!=noErr) <span class="keywordflow">continue</span>;
<a name="l02370"></a>02370         err = PasteboardCopyItemFlavors(myPasteboard, itemID, &amp;flavorTypeArray);
<a name="l02371"></a>02371         <span class="keywordflow">if</span> (err!=noErr) {
<a name="l02372"></a>02372           <span class="keywordflow">if</span> (flavorTypeArray) {CFRelease(flavorTypeArray); flavorTypeArray = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;}
<a name="l02373"></a>02373           <span class="keywordflow">continue</span>;
<a name="l02374"></a>02374         }
<a name="l02375"></a>02375         CFIndex flavorCount = CFArrayGetCount(flavorTypeArray);
<a name="l02376"></a>02376         <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="Fl__mac_8cxx.html#ac6954cdae777da2c2201a0d21a7f66f0">handledFlavorsCount</a>; j++) {
<a name="l02377"></a>02377           <span class="keywordflow">for</span> (CFIndex flavorIndex=0; flavorIndex&lt;flavorCount; flavorIndex++) {
<a name="l02378"></a>02378             CFStringRef flavorType = (CFStringRef)CFArrayGetValueAtIndex(flavorTypeArray, flavorIndex);
<a name="l02379"></a>02379             <span class="keywordflow">if</span> (UTTypeConformsTo(flavorType, flavorNames[j])) {
<a name="l02380"></a>02380               err = PasteboardCopyItemFlavorData( myPasteboard, itemID, flavorNames[j], &amp;flavorData );
<a name="l02381"></a>02381               <span class="keywordflow">if</span> (err != noErr) <span class="keywordflow">continue</span>;
<a name="l02382"></a>02382               encoding = encodings[j];
<a name="l02383"></a>02383               found = <span class="keyword">true</span>;
<a name="l02384"></a>02384               <span class="keywordflow">break</span>;
<a name="l02385"></a>02385             }
<a name="l02386"></a>02386           }
<a name="l02387"></a>02387           <span class="keywordflow">if</span> (found) <span class="keywordflow">break</span>;
<a name="l02388"></a>02388         }
<a name="l02389"></a>02389         <span class="keywordflow">if</span> (flavorTypeArray) {CFRelease(flavorTypeArray); flavorTypeArray = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;}
<a name="l02390"></a>02390         <span class="keywordflow">if</span> (found) <span class="keywordflow">break</span>;
<a name="l02391"></a>02391       }
<a name="l02392"></a>02392       <span class="keywordflow">if</span> (found) {
<a name="l02393"></a>02393         CFIndex len = CFDataGetLength(flavorData);
<a name="l02394"></a>02394         CFStringRef mycfs = CFStringCreateWithBytes(<a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, CFDataGetBytePtr(flavorData), len, encoding, <span class="keyword">false</span>);
<a name="l02395"></a>02395         CFRelease(flavorData);
<a name="l02396"></a>02396         len = CFStringGetMaximumSizeForEncoding(CFStringGetLength(mycfs), kCFStringEncodingUTF8) + 1;
<a name="l02397"></a>02397         <span class="keywordflow">if</span> ( len &gt;= fl_selection_buffer_length[1] ) {
<a name="l02398"></a>02398           fl_selection_buffer_length[1] = len;
<a name="l02399"></a>02399           <span class="keyword">delete</span>[] fl_selection_buffer[1];
<a name="l02400"></a>02400           fl_selection_buffer[1] = <span class="keyword">new</span> <span class="keywordtype">char</span>[len];
<a name="l02401"></a>02401         }
<a name="l02402"></a>02402         CFStringGetCString(mycfs, fl_selection_buffer[1], len, kCFStringEncodingUTF8);
<a name="l02403"></a>02403         CFRelease(mycfs);
<a name="l02404"></a>02404         len = strlen(fl_selection_buffer[1]);
<a name="l02405"></a>02405         fl_selection_length[1] = len;
<a name="l02406"></a>02406         convert_crlf(fl_selection_buffer[1],len); <span class="comment">// turn all \r characters into \n:</span>
<a name="l02407"></a>02407       }
<a name="l02408"></a>02408     }
<a name="l02409"></a>02409   }
<a name="l02410"></a>02410   <a class="code" href="classFl.html#addcd49b68feff0a807f6564f3fdb8016">Fl::e_text</a> = fl_selection_buffer[clipboard];
<a name="l02411"></a>02411   <a class="code" href="classFl.html#a336911cf63dade9bbb9707b942785133">Fl::e_length</a> = fl_selection_length[clipboard];
<a name="l02412"></a>02412   <span class="keywordflow">if</span> (!<a class="code" href="classFl.html#addcd49b68feff0a807f6564f3fdb8016">Fl::e_text</a>) <a class="code" href="classFl.html#addcd49b68feff0a807f6564f3fdb8016">Fl::e_text</a> = (<span class="keywordtype">char</span> *)<span class="stringliteral">&quot;&quot;</span>;
<a name="l02413"></a>02413   receiver.<a class="code" href="classFl__Widget.html#a9cb17cc092697dfd05a3fab55856d218">handle</a>(<a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a5e811b9d703e6f66cfdca256ecfbb0cf">FL_PASTE</a>);
<a name="l02414"></a>02414 }
<a name="l02415"></a>02415 
<a name="l02416"></a>02416 <span class="keywordtype">void</span> <a class="code" href="classFl.html#a23e63eb7cec3a27fa360e66c6e2b2e52">Fl::add_timeout</a>(<span class="keywordtype">double</span> time, <a class="code" href="group__callback__functions.html#gaf00cf21170aa3231f6e869a30a036390">Fl_Timeout_Handler</a> cb, <span class="keywordtype">void</span>* data)
<a name="l02417"></a>02417 {
<a name="l02418"></a>02418   <span class="comment">// check, if this timer slot exists already</span>
<a name="l02419"></a>02419   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; mac_timer_used; ++i) {
<a name="l02420"></a>02420     <a class="code" href="structMacTimeout.html">MacTimeout</a>&amp; t = mac_timers[i];
<a name="l02421"></a>02421     <span class="comment">// if so, simply change the fire interval</span>
<a name="l02422"></a>02422     <span class="keywordflow">if</span> (t.<a class="code" href="structMacTimeout.html#a13d349713ab4eb38a5e14f975f84cf08">callback</a> == cb  &amp;&amp;  t.<a class="code" href="structMacTimeout.html#ad232eaa73f22599f0d0883a90477ba3d">data</a> == data) {
<a name="l02423"></a>02423       CFRunLoopTimerSetNextFireDate(t.<a class="code" href="structMacTimeout.html#aac4fe2df22f669ea5ba8ddf0ba7d200d">timer</a>, CFAbsoluteTimeGetCurrent() + time );
<a name="l02424"></a>02424       t.<a class="code" href="structMacTimeout.html#aa734ee03fd9d56dcac5b967efe33e7a1">pending</a> = 1;
<a name="l02425"></a>02425       <span class="keywordflow">return</span>;
<a name="l02426"></a>02426     }
<a name="l02427"></a>02427   }
<a name="l02428"></a>02428   <span class="comment">// no existing timer to use. Create a new one:</span>
<a name="l02429"></a>02429   <span class="keywordtype">int</span> timer_id = -1;
<a name="l02430"></a>02430   <span class="comment">// find an empty slot in the timer array</span>
<a name="l02431"></a>02431   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; mac_timer_used; ++i) {
<a name="l02432"></a>02432     <span class="keywordflow">if</span> ( !mac_timers[i].timer ) {
<a name="l02433"></a>02433       timer_id = <a class="code" href="png_8h.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>;
<a name="l02434"></a>02434       <span class="keywordflow">break</span>;
<a name="l02435"></a>02435     }
<a name="l02436"></a>02436   }
<a name="l02437"></a>02437   <span class="comment">// if there was no empty slot, append a new timer</span>
<a name="l02438"></a>02438   <span class="keywordflow">if</span> (timer_id == -1) {
<a name="l02439"></a>02439     <span class="comment">// make space if needed</span>
<a name="l02440"></a>02440     <span class="keywordflow">if</span> (mac_timer_used == mac_timer_alloc) {
<a name="l02441"></a>02441       realloc_timers();
<a name="l02442"></a>02442     }
<a name="l02443"></a>02443     timer_id = mac_timer_used++;
<a name="l02444"></a>02444   }
<a name="l02445"></a>02445   <span class="comment">// now install a brand new timer</span>
<a name="l02446"></a>02446   <a class="code" href="structMacTimeout.html">MacTimeout</a>&amp; t = mac_timers[timer_id];
<a name="l02447"></a>02447   CFRunLoopTimerContext context = {0, <a class="code" href="jpeglib_8h.html#ae5784a8f4db42de0ffacd0cbd08dc6ad">data</a>, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,<a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,NULL};
<a name="l02448"></a>02448   CFRunLoopTimerRef timerRef = CFRunLoopTimerCreate(kCFAllocatorDefault, 
<a name="l02449"></a>02449                                                     CFAbsoluteTimeGetCurrent() + time,
<a name="l02450"></a>02450                                                     1E30,  
<a name="l02451"></a>02451                                                     0,
<a name="l02452"></a>02452                                                     0,
<a name="l02453"></a>02453                                                     do_timer,
<a name="l02454"></a>02454                                                     &amp;context
<a name="l02455"></a>02455                                                     );
<a name="l02456"></a>02456   <span class="keywordflow">if</span> (timerRef) {
<a name="l02457"></a>02457     CFRunLoopAddTimer(CFRunLoopGetCurrent(),
<a name="l02458"></a>02458                       timerRef,
<a name="l02459"></a>02459                       kCFRunLoopDefaultMode);
<a name="l02460"></a>02460     t.<a class="code" href="structMacTimeout.html#a13d349713ab4eb38a5e14f975f84cf08">callback</a> = cb;
<a name="l02461"></a>02461     t.<a class="code" href="structMacTimeout.html#ad232eaa73f22599f0d0883a90477ba3d">data</a>     = <a class="code" href="jpeglib_8h.html#ae5784a8f4db42de0ffacd0cbd08dc6ad">data</a>;
<a name="l02462"></a>02462     t.<a class="code" href="structMacTimeout.html#aac4fe2df22f669ea5ba8ddf0ba7d200d">timer</a>    = timerRef;
<a name="l02463"></a>02463     t.<a class="code" href="structMacTimeout.html#aa734ee03fd9d56dcac5b967efe33e7a1">pending</a>  = 1;
<a name="l02464"></a>02464   }
<a name="l02465"></a>02465 }
<a name="l02466"></a>02466 
<a name="l02467"></a>02467 <span class="keywordtype">void</span> <a class="code" href="classFl.html#ae5373d1d50c2b0ba38280d78bb6d2628">Fl::repeat_timeout</a>(<span class="keywordtype">double</span> time, <a class="code" href="group__callback__functions.html#gaf00cf21170aa3231f6e869a30a036390">Fl_Timeout_Handler</a> cb, <span class="keywordtype">void</span>* data)
<a name="l02468"></a>02468 {
<a name="l02469"></a>02469   <span class="comment">// currently, repeat_timeout does not subtract the trigger time of the previous timer event as it should.</span>
<a name="l02470"></a>02470   add_timeout(time, cb, data);
<a name="l02471"></a>02471 }
<a name="l02472"></a>02472 
<a name="l02473"></a>02473 <span class="keywordtype">int</span> <a class="code" href="classFl.html#ae3164768ec950db81396b81ef42f8ba2">Fl::has_timeout</a>(<a class="code" href="group__callback__functions.html#gaf00cf21170aa3231f6e869a30a036390">Fl_Timeout_Handler</a> cb, <span class="keywordtype">void</span>* data)
<a name="l02474"></a>02474 {
<a name="l02475"></a>02475   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; mac_timer_used; ++i) {
<a name="l02476"></a>02476     <a class="code" href="structMacTimeout.html">MacTimeout</a>&amp; t = mac_timers[i];
<a name="l02477"></a>02477     <span class="keywordflow">if</span> (t.<a class="code" href="structMacTimeout.html#a13d349713ab4eb38a5e14f975f84cf08">callback</a> == cb  &amp;&amp;  t.<a class="code" href="structMacTimeout.html#ad232eaa73f22599f0d0883a90477ba3d">data</a> == data &amp;&amp; t.<a class="code" href="structMacTimeout.html#aa734ee03fd9d56dcac5b967efe33e7a1">pending</a>) {
<a name="l02478"></a>02478       <span class="keywordflow">return</span> 1;
<a name="l02479"></a>02479     }
<a name="l02480"></a>02480   }
<a name="l02481"></a>02481   <span class="keywordflow">return</span> 0;
<a name="l02482"></a>02482 }
<a name="l02483"></a>02483 
<a name="l02484"></a>02484 <span class="keywordtype">void</span> <a class="code" href="classFl.html#a9a950f0585de6416eb4fee2365a1578f">Fl::remove_timeout</a>(<a class="code" href="group__callback__functions.html#gaf00cf21170aa3231f6e869a30a036390">Fl_Timeout_Handler</a> cb, <span class="keywordtype">void</span>* data)
<a name="l02485"></a>02485 {
<a name="l02486"></a>02486   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; mac_timer_used; ++i) {
<a name="l02487"></a>02487     <a class="code" href="structMacTimeout.html">MacTimeout</a>&amp; t = mac_timers[i];
<a name="l02488"></a>02488     <span class="keywordflow">if</span> (t.<a class="code" href="structMacTimeout.html#a13d349713ab4eb38a5e14f975f84cf08">callback</a> == cb  &amp;&amp; ( t.<a class="code" href="structMacTimeout.html#ad232eaa73f22599f0d0883a90477ba3d">data</a> == data || data == <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l02489"></a>02489       delete_timer(t);
<a name="l02490"></a>02490     }
<a name="l02491"></a>02491   }
<a name="l02492"></a>02492 }
<a name="l02493"></a>02493 
<a name="l02494"></a>02494 <span class="keywordtype">int</span> Fl_X::unlink(<a class="code" href="classFl__X.html">Fl_X</a> *<a class="code" href="png_8h.html#a96c2a358dab02570791a4c9072aecf60">start</a>) {
<a name="l02495"></a>02495   <span class="keywordflow">if</span> (start) {
<a name="l02496"></a>02496     <a class="code" href="classFl__X.html">Fl_X</a> *pc = <a class="code" href="png_8h.html#a96c2a358dab02570791a4c9072aecf60">start</a>;
<a name="l02497"></a>02497     <span class="keywordflow">while</span> (pc) {
<a name="l02498"></a>02498       <span class="keywordflow">if</span> (pc-&gt;xidNext == <span class="keyword">this</span>) {
<a name="l02499"></a>02499         pc-&gt;xidNext = xidNext;
<a name="l02500"></a>02500         <span class="keywordflow">return</span> 1;
<a name="l02501"></a>02501       }
<a name="l02502"></a>02502       <span class="keywordflow">if</span> (pc-&gt;xidChildren) {
<a name="l02503"></a>02503         <span class="keywordflow">if</span> (pc-&gt;xidChildren == <span class="keyword">this</span>) {
<a name="l02504"></a>02504           pc-&gt;xidChildren = xidNext;
<a name="l02505"></a>02505           <span class="keywordflow">return</span> 1;
<a name="l02506"></a>02506         }
<a name="l02507"></a>02507         <span class="keywordflow">if</span> (unlink(pc-&gt;xidChildren))
<a name="l02508"></a>02508           <span class="keywordflow">return</span> 1;
<a name="l02509"></a>02509       }
<a name="l02510"></a>02510       pc = pc-&gt;xidNext;
<a name="l02511"></a>02511     }
<a name="l02512"></a>02512   } <span class="keywordflow">else</span> {
<a name="l02513"></a>02513     <span class="keywordflow">for</span> ( <a class="code" href="classFl__X.html">Fl_X</a> *pc = <a class="code" href="classFl__X.html#a87bf8b5c35a402db76a2267f97db0b18">Fl_X::first</a>; pc; pc = pc-&gt;<a class="code" href="classFl__X.html#a41f6a721a953ea62021bb1dd9c4f2187">next</a> ) {
<a name="l02514"></a>02514       <span class="keywordflow">if</span> (unlink(pc))
<a name="l02515"></a>02515         <span class="keywordflow">return</span> 1;
<a name="l02516"></a>02516     }
<a name="l02517"></a>02517   }  
<a name="l02518"></a>02518   <span class="keywordflow">return</span> 0;
<a name="l02519"></a>02519 }
<a name="l02520"></a>02520 
<a name="l02521"></a>02521 <span class="keywordtype">void</span> Fl_X::relink(<a class="code" href="classFl__Window.html">Fl_Window</a> *w, <a class="code" href="classFl__Window.html">Fl_Window</a> *wp) {
<a name="l02522"></a>02522   <a class="code" href="classFl__X.html">Fl_X</a> *x = <a class="code" href="classFl__X.html#ae4c6997d92cf8ad3a75a962d7ae77c34">Fl_X::i</a>(w);
<a name="l02523"></a>02523   <a class="code" href="classFl__X.html">Fl_X</a> *p = <a class="code" href="classFl__X.html#ae4c6997d92cf8ad3a75a962d7ae77c34">Fl_X::i</a>(wp);
<a name="l02524"></a>02524   <span class="keywordflow">if</span> (!x || !p) <span class="keywordflow">return</span>;
<a name="l02525"></a>02525   <span class="comment">// first, check if &#39;x&#39; is already registered as a child of &#39;p&#39;</span>
<a name="l02526"></a>02526   <span class="keywordflow">for</span> (<a class="code" href="classFl__X.html">Fl_X</a> *i = p-&gt;xidChildren; i; i=i-&gt;xidNext) {
<a name="l02527"></a>02527     <span class="keywordflow">if</span> (i == x) <span class="keywordflow">return</span>;
<a name="l02528"></a>02528   }
<a name="l02529"></a>02529   <span class="comment">// now add &#39;x&#39; as the first child of &#39;p&#39;</span>
<a name="l02530"></a>02530   x-&gt;xidNext = p-&gt;xidChildren;
<a name="l02531"></a>02531   p-&gt;xidChildren = <a class="code" href="classFl__X.html#ae3e071b57b4577d0c13214be9db17ad5">x</a>;
<a name="l02532"></a>02532 }
<a name="l02533"></a>02533 
<a name="l02534"></a>02534 <span class="keywordtype">void</span> <a class="code" href="gzio_8c.html#a47b8b068b10f0aa50eba5c2ec86cff0b">Fl_X::destroy</a>() {
<a name="l02535"></a>02535   <span class="keywordflow">if</span> (w &amp;&amp; !w-&gt;<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>() &amp;&amp; <a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>) {
<a name="l02536"></a>02536     [[(NSWindow *)xid contentView] release];
<a name="l02537"></a>02537     [(NSWindow *)xid close];
<a name="l02538"></a>02538   }
<a name="l02539"></a>02539 }
<a name="l02540"></a>02540 
<a name="l02541"></a>02541 <span class="keywordtype">void</span> Fl_X::map() {
<a name="l02542"></a>02542   <span class="keywordflow">if</span> (w &amp;&amp; <a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>) {
<a name="l02543"></a>02543     [(NSWindow *)xid orderFront:nil];
<a name="l02544"></a>02544   }
<a name="l02545"></a>02545   <span class="comment">//+ link to window list</span>
<a name="l02546"></a>02546   <span class="keywordflow">if</span> (w &amp;&amp; w-&gt;<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>()) {
<a name="l02547"></a>02547     Fl_X::relink(w, w-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>() );
<a name="l02548"></a>02548     w-&gt;<a class="code" href="classFl__Widget.html#aa63ce68cbf4620cf8750b868368ea02b">redraw</a>();
<a name="l02549"></a>02549   }
<a name="l02550"></a>02550 }
<a name="l02551"></a>02551 
<a name="l02552"></a>02552 <span class="keywordtype">void</span> Fl_X::unmap() {
<a name="l02553"></a>02553   <span class="keywordflow">if</span> (w &amp;&amp; !w-&gt;<a class="code" href="classFl__Widget.html#a77af13bd8284ed43dc8c402a7224bd99">parent</a>() &amp;&amp; <a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>) {
<a name="l02554"></a>02554     [(NSWindow *)xid orderOut:nil];
<a name="l02555"></a>02555   }
<a name="l02556"></a>02556   <span class="keywordflow">if</span> (w &amp;&amp; <a class="code" href="classFl__X.html#ae4c6997d92cf8ad3a75a962d7ae77c34">Fl_X::i</a>(w)) 
<a name="l02557"></a>02557     <a class="code" href="classFl__X.html#ae4c6997d92cf8ad3a75a962d7ae77c34">Fl_X::i</a>(w)-&gt;unlink();
<a name="l02558"></a>02558 }
<a name="l02559"></a>02559 
<a name="l02560"></a>02560 
<a name="l02561"></a>02561 <span class="comment">// removes x,y,w,h rectangle from region r and returns result as a new Fl_Region</span>
<a name="l02562"></a>02562 <span class="keyword">static</span> <a class="code" href="mac_8H.html#aa3f54ef9dd28ee61ae42bd36291a31f2">Fl_Region</a> MacRegionMinusRect(<a class="code" href="mac_8H.html#aa3f54ef9dd28ee61ae42bd36291a31f2">Fl_Region</a> r, <span class="keywordtype">int</span> x,<span class="keywordtype">int</span> <a class="code" href="test_8c.html#a0a2f84ed7838f07779ae24c5a9086d33">y</a>,<span class="keywordtype">int</span> w,<span class="keywordtype">int</span> <a class="code" href="forms_8H-2.html#a7e427ba5b307f9068129699250690066">h</a>)
<a name="l02563"></a>02563 {
<a name="l02564"></a>02564   <a class="code" href="mac_8H.html#aa3f54ef9dd28ee61ae42bd36291a31f2">Fl_Region</a> outr = (<a class="code" href="mac_8H.html#aa3f54ef9dd28ee61ae42bd36291a31f2">Fl_Region</a>)malloc(<span class="keyword">sizeof</span>(*outr));
<a name="l02565"></a>02565   outr-&gt;rects = (CGRect*)malloc(4 * r-&gt;count * <span class="keyword">sizeof</span>(CGRect));
<a name="l02566"></a>02566   outr-&gt;count = 0;
<a name="l02567"></a>02567   CGRect rect = fl_cgrectmake_cocoa(x, y, w, h);
<a name="l02568"></a>02568   <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 0; i &lt; r-&gt;count; i++) {
<a name="l02569"></a>02569     CGRect A = r-&gt;rects[i];
<a name="l02570"></a>02570     CGRect test = CGRectIntersection(A, rect);
<a name="l02571"></a>02571     <span class="keywordflow">if</span> (CGRectIsEmpty(test)) {
<a name="l02572"></a>02572       outr-&gt;rects[(outr-&gt;count)++] = A;
<a name="l02573"></a>02573     }
<a name="l02574"></a>02574     <span class="keywordflow">else</span> {
<a name="l02575"></a>02575       <span class="keyword">const</span> CGFloat verylarge = 100000.;
<a name="l02576"></a>02576       CGRect side = CGRectMake(0,0,rect.origin.x,verylarge);<span class="comment">// W side</span>
<a name="l02577"></a>02577       test = CGRectIntersection(A, side);
<a name="l02578"></a>02578       <span class="keywordflow">if</span> ( ! CGRectIsEmpty(test)) {
<a name="l02579"></a>02579         outr-&gt;rects[(outr-&gt;count)++] = test;
<a name="l02580"></a>02580       }
<a name="l02581"></a>02581       side = CGRectMake(0,rect.origin.y + rect.size.height,verylarge,verylarge);<span class="comment">// N side</span>
<a name="l02582"></a>02582       test = CGRectIntersection(A, side);
<a name="l02583"></a>02583       <span class="keywordflow">if</span> ( ! CGRectIsEmpty(test)) {
<a name="l02584"></a>02584         outr-&gt;rects[(outr-&gt;count)++] = test;
<a name="l02585"></a>02585       }
<a name="l02586"></a>02586       side = CGRectMake(rect.origin.x + rect.size.width, 0, verylarge, verylarge);<span class="comment">// E side</span>
<a name="l02587"></a>02587       test = CGRectIntersection(A, side);
<a name="l02588"></a>02588       <span class="keywordflow">if</span> ( ! CGRectIsEmpty(test)) {
<a name="l02589"></a>02589         outr-&gt;rects[(outr-&gt;count)++] = test;
<a name="l02590"></a>02590       }
<a name="l02591"></a>02591       side = CGRectMake(0, 0, verylarge, rect.origin.y);<span class="comment">// S side</span>
<a name="l02592"></a>02592       test = CGRectIntersection(A, side);
<a name="l02593"></a>02593       <span class="keywordflow">if</span> ( ! CGRectIsEmpty(test)) {
<a name="l02594"></a>02594         outr-&gt;rects[(outr-&gt;count)++] = test;
<a name="l02595"></a>02595       }
<a name="l02596"></a>02596     }
<a name="l02597"></a>02597   }
<a name="l02598"></a>02598   <span class="keywordflow">if</span> (outr-&gt;count == 0) {
<a name="l02599"></a>02599     free(outr-&gt;rects);
<a name="l02600"></a>02600     free(outr);
<a name="l02601"></a>02601     outr = <a class="code" href="win32_8H.html#a2381eb7ab4ad62c68c478d6d70f85b09">XRectangleRegion</a>(0,0,0,0);
<a name="l02602"></a>02602   }
<a name="l02603"></a>02603   <span class="keywordflow">else</span> outr-&gt;rects = (CGRect*)realloc(outr-&gt;rects, outr-&gt;count * <span class="keyword">sizeof</span>(CGRect));
<a name="l02604"></a>02604   <span class="keywordflow">return</span> outr;
<a name="l02605"></a>02605 }
<a name="l02606"></a>02606 
<a name="l02607"></a>02607 <span class="comment">// intersects current and x,y,w,h rectangle and returns result as a new Fl_Region</span>
<a name="l02608"></a>02608 <a class="code" href="mac_8H.html#aa3f54ef9dd28ee61ae42bd36291a31f2">Fl_Region</a> Fl_X::intersect_region_and_rect(<a class="code" href="mac_8H.html#aa3f54ef9dd28ee61ae42bd36291a31f2">Fl_Region</a> current, <span class="keywordtype">int</span> x,<span class="keywordtype">int</span> y,<span class="keywordtype">int</span> w, <span class="keywordtype">int</span> h)
<a name="l02609"></a>02609 {
<a name="l02610"></a>02610   <span class="keywordflow">if</span> (current == <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> <a class="code" href="win32_8H.html#a2381eb7ab4ad62c68c478d6d70f85b09">XRectangleRegion</a>(x,y,w,h);
<a name="l02611"></a>02611   CGRect r = fl_cgrectmake_cocoa(x, y, w, h);
<a name="l02612"></a>02612   <a class="code" href="mac_8H.html#aa3f54ef9dd28ee61ae42bd36291a31f2">Fl_Region</a> outr = (<a class="code" href="mac_8H.html#aa3f54ef9dd28ee61ae42bd36291a31f2">Fl_Region</a>)malloc(<span class="keyword">sizeof</span>(*outr));
<a name="l02613"></a>02613   outr-&gt;count = current-&gt;count;
<a name="l02614"></a>02614   outr-&gt;rects =(CGRect*)malloc(outr-&gt;count * <span class="keyword">sizeof</span>(CGRect));
<a name="l02615"></a>02615   <span class="keywordtype">int</span> j = 0;
<a name="l02616"></a>02616   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; current-&gt;count; i++) {
<a name="l02617"></a>02617     CGRect test = CGRectIntersection(current-&gt;rects[i], r);
<a name="l02618"></a>02618     <span class="keywordflow">if</span> (!CGRectIsEmpty(test)) outr-&gt;rects[j++] = test;
<a name="l02619"></a>02619   }
<a name="l02620"></a>02620   <span class="keywordflow">if</span> (j) {
<a name="l02621"></a>02621     outr-&gt;count = j;
<a name="l02622"></a>02622     outr-&gt;rects = (CGRect*)realloc(outr-&gt;rects, outr-&gt;count * <span class="keyword">sizeof</span>(CGRect));
<a name="l02623"></a>02623   }
<a name="l02624"></a>02624   <span class="keywordflow">else</span> {
<a name="l02625"></a>02625     <a class="code" href="win32_8H.html#aa9ab8e4893ef97f9bf92e66e2c51778b">XDestroyRegion</a>(outr);
<a name="l02626"></a>02626     outr = <a class="code" href="win32_8H.html#a2381eb7ab4ad62c68c478d6d70f85b09">XRectangleRegion</a>(0,0,0,0);
<a name="l02627"></a>02627   }
<a name="l02628"></a>02628   <span class="keywordflow">return</span> outr;
<a name="l02629"></a>02629 }
<a name="l02630"></a>02630 
<a name="l02631"></a>02631 <span class="keywordtype">void</span> Fl_X::collapse() {
<a name="l02632"></a>02632   [(NSWindow *)xid miniaturize:nil];
<a name="l02633"></a>02633 }
<a name="l02634"></a>02634 
<a name="l02635"></a>02635 <span class="keyword">static</span> NSImage *CGBitmapContextToNSImage(CGContextRef c)
<a name="l02636"></a>02636 <span class="comment">// the returned NSImage is autoreleased</span>
<a name="l02637"></a>02637 {
<a name="l02638"></a>02638   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *pdata = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)CGBitmapContextGetData(c);
<a name="l02639"></a>02639   NSBitmapImageRep *imagerep = [[NSBitmapImageRep alloc] initWithBitmapDataPlanes:&amp;pdata
<a name="l02640"></a>02640                                                                        pixelsWide:CGBitmapContextGetWidth(c)
<a name="l02641"></a>02641                                                                        pixelsHigh:CGBitmapContextGetHeight(c)
<a name="l02642"></a>02642                                                                     bitsPerSample:8
<a name="l02643"></a>02643                                                                   samplesPerPixel:4
<a name="l02644"></a>02644                                                                          hasAlpha:YES
<a name="l02645"></a>02645                                                                          isPlanar:NO
<a name="l02646"></a>02646                                                                    colorSpaceName:NSDeviceRGBColorSpace
<a name="l02647"></a>02647                                                                       bytesPerRow:CGBitmapContextGetBytesPerRow(c)
<a name="l02648"></a>02648                                                                      bitsPerPixel:CGBitmapContextGetBitsPerPixel(c)];
<a name="l02649"></a>02649   NSImage* <a class="code" href="png_8h.html#a4a84becf999bb6d9e55899b71ed75bcf">image</a> = [[NSImage alloc] initWithData: [imagerep TIFFRepresentation]];
<a name="l02650"></a>02650   [imagerep release];
<a name="l02651"></a>02651   <span class="keywordflow">return</span> [image autorelease];
<a name="l02652"></a>02652 }
<a name="l02653"></a>02653 
<a name="l02654"></a>02654 <span class="keyword">static</span> NSCursor *PrepareCursor(NSCursor *cursor, CGContextRef (*f)() )
<a name="l02655"></a>02655 {
<a name="l02656"></a>02656   <span class="keywordflow">if</span> (cursor == nil) {
<a name="l02657"></a>02657     CGContextRef c = <a class="code" href="fl__boxtype_8cxx.html#ac406db58651c10e8f67ed432c66db0d6">f</a>();
<a name="l02658"></a>02658     NSImage *<a class="code" href="png_8h.html#a4a84becf999bb6d9e55899b71ed75bcf">image</a> = CGBitmapContextToNSImage(c);
<a name="l02659"></a>02659     <a class="code" href="mac_8H.html#a12c4aafe6b26b130c04f5ea972d33480">fl_delete_offscreen</a>( (<a class="code" href="mac_8H.html#a73ca2fde79c397d91d1147fde9cccc39">Fl_Offscreen</a>)c ); 
<a name="l02660"></a>02660     NSPoint pt = {[image size].width/2, [image size].height/2};
<a name="l02661"></a>02661     cursor = [[NSCursor alloc] initWithImage:image hotSpot:pt];
<a name="l02662"></a>02662   }
<a name="l02663"></a>02663   <span class="keywordflow">return</span> cursor;
<a name="l02664"></a>02664 }
<a name="l02665"></a>02665 
<a name="l02666"></a>02666 <span class="keywordtype">void</span> Fl_X::set_cursor(<a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0">Fl_Cursor</a> c)
<a name="l02667"></a>02667 {
<a name="l02668"></a>02668   NSCursor *icrsr;
<a name="l02669"></a>02669   <span class="keywordflow">switch</span> (c) {
<a name="l02670"></a>02670     <span class="keywordflow">case</span> <a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0a69ff20b8685ba12b6faef9f7f2565c91">FL_CURSOR_CROSS</a>:  icrsr = [NSCursor crosshairCursor]; <span class="keywordflow">break</span>;
<a name="l02671"></a>02671     <span class="keywordflow">case</span> <a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0a8275eef61a9b77c448f3c53502bee6e0">FL_CURSOR_WAIT</a>:
<a name="l02672"></a>02672       <span class="keyword">static</span> NSCursor *watch = nil;
<a name="l02673"></a>02673       watch = PrepareCursor(watch,  &amp;Fl_X::watch_cursor_image);
<a name="l02674"></a>02674       icrsr = watch;
<a name="l02675"></a>02675       <span class="keywordflow">break</span>;
<a name="l02676"></a>02676     <span class="keywordflow">case</span> <a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0ab6031998169de52eadfda65d464cbefb">FL_CURSOR_INSERT</a>: icrsr = [NSCursor IBeamCursor]; <span class="keywordflow">break</span>;
<a name="l02677"></a>02677     <span class="keywordflow">case</span> <a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0afc216f1424895e8a3ff70ee4d396a359">FL_CURSOR_N</a>:      icrsr = [NSCursor resizeUpCursor]; <span class="keywordflow">break</span>;
<a name="l02678"></a>02678     <span class="keywordflow">case</span> <a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0ae346bec5544ac09f2ac846f37fc802dd">FL_CURSOR_S</a>:      icrsr = [NSCursor resizeDownCursor]; <span class="keywordflow">break</span>;
<a name="l02679"></a>02679     <span class="keywordflow">case</span> <a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0ab47413e34d7d268488a279b9f93d694b">FL_CURSOR_NS</a>:     icrsr = [NSCursor resizeUpDownCursor]; <span class="keywordflow">break</span>;
<a name="l02680"></a>02680     <span class="keywordflow">case</span> <a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0a9fa6d5e3554972e4996535a5bff6260c">FL_CURSOR_HELP</a>:   
<a name="l02681"></a>02681       <span class="keyword">static</span> NSCursor *help = nil;
<a name="l02682"></a>02682       help = PrepareCursor(help,  &amp;Fl_X::help_cursor_image);
<a name="l02683"></a>02683       icrsr = help;
<a name="l02684"></a>02684       <span class="keywordflow">break</span>;
<a name="l02685"></a>02685     <span class="keywordflow">case</span> <a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0a1b25ce2668fb1ca7bd85b0ba4cc20ab7">FL_CURSOR_HAND</a>:   icrsr = [NSCursor pointingHandCursor]; <span class="keywordflow">break</span>;
<a name="l02686"></a>02686     <span class="keywordflow">case</span> <a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0a0429eefdb7ef6bbfacbbd389b5bd891e">FL_CURSOR_MOVE</a>:   icrsr = [NSCursor openHandCursor]; <span class="keywordflow">break</span>;
<a name="l02687"></a>02687     <span class="keywordflow">case</span> <a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0ac6b21e75adf3bd782e3c4affe992ba33">FL_CURSOR_NE</a>:
<a name="l02688"></a>02688     <span class="keywordflow">case</span> <a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0ac556babff2b1387a1139f07c7361a8f5">FL_CURSOR_SW</a>:
<a name="l02689"></a>02689     <span class="keywordflow">case</span> <a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0abf1958a458f8e6c99cc4eae28856ecbe">FL_CURSOR_NESW</a>:   
<a name="l02690"></a>02690       <span class="keyword">static</span> NSCursor *nesw = nil;
<a name="l02691"></a>02691       nesw = PrepareCursor(nesw,  &amp;Fl_X::nesw_cursor_image);
<a name="l02692"></a>02692       icrsr = nesw;
<a name="l02693"></a>02693       <span class="keywordflow">break</span>;
<a name="l02694"></a>02694     <span class="keywordflow">case</span> <a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0a655675f4a5c1009798c4688811f7aef8">FL_CURSOR_E</a>:      icrsr = [NSCursor resizeRightCursor]; <span class="keywordflow">break</span>;
<a name="l02695"></a>02695     <span class="keywordflow">case</span> <a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0a3e71103dc03ff53a2a53be5e7e4b19eb">FL_CURSOR_W</a>:      icrsr = [NSCursor resizeLeftCursor]; <span class="keywordflow">break</span>;
<a name="l02696"></a>02696     <span class="keywordflow">case</span> <a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0a1f084eec70809a1edc89031d97d754f6">FL_CURSOR_WE</a>:     icrsr = [NSCursor resizeLeftRightCursor]; <span class="keywordflow">break</span>;
<a name="l02697"></a>02697     <span class="keywordflow">case</span> <a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0a20e02baa5891403ea99e770525dcb906">FL_CURSOR_SE</a>:
<a name="l02698"></a>02698     <span class="keywordflow">case</span> <a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0a414ffb070f3fbcd0a97dafdaa6b718f7">FL_CURSOR_NW</a>:
<a name="l02699"></a>02699     <span class="keywordflow">case</span> <a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0a886c85d5b062a34fa1cfac16e7896526">FL_CURSOR_NWSE</a>:   
<a name="l02700"></a>02700       <span class="keyword">static</span> NSCursor *nwse = nil;
<a name="l02701"></a>02701       nwse = PrepareCursor(nwse,  &amp;Fl_X::nwse_cursor_image);
<a name="l02702"></a>02702       icrsr = nwse;
<a name="l02703"></a>02703       <span class="keywordflow">break</span>;
<a name="l02704"></a>02704     <span class="keywordflow">case</span> <a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0a4bc466fe5135272bccedd6b8f97156c7">FL_CURSOR_NONE</a>:   
<a name="l02705"></a>02705       <span class="keyword">static</span> NSCursor *none = nil;
<a name="l02706"></a>02706       none = PrepareCursor(none,  &amp;Fl_X::none_cursor_image);
<a name="l02707"></a>02707       icrsr = none; 
<a name="l02708"></a>02708       <span class="keywordflow">break</span>;
<a name="l02709"></a>02709     <span class="keywordflow">case</span> <a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0af3b7847dd6a361709b45e61c3b2134f7">FL_CURSOR_ARROW</a>:
<a name="l02710"></a>02710     <span class="keywordflow">case</span> <a class="code" href="Enumerations_8H.html#a72bde974edc7926b1217dd51b8c7e8e0a045f091aae5108f94e912bf5163344dd">FL_CURSOR_DEFAULT</a>:
<a name="l02711"></a>02711     <span class="keywordflow">default</span>:                       icrsr = [NSCursor arrowCursor];
<a name="l02712"></a>02712       <span class="keywordflow">break</span>;
<a name="l02713"></a>02713   }
<a name="l02714"></a>02714   [icrsr set];
<a name="l02715"></a>02715   cursor = icrsr;
<a name="l02716"></a>02716 }
<a name="l02717"></a>02717 
<a name="l02718"></a>02718 <span class="keywordtype">int</span> Fl_X::screen_init(<a class="code" href="structXRectangle.html">XRectangle</a> screens[], <span class="keywordtype">float</span> dpi[])
<a name="l02719"></a>02719 {
<a name="l02720"></a>02720   NSAutoreleasePool *localPool = [[NSAutoreleasePool alloc] init]; 
<a name="l02721"></a>02721   NSArray *a = [NSScreen screens]; 
<a name="l02722"></a>02722   NSScreen *<a class="code" href="jmemsys_8h.html#a77e1d3f325098324c3925e8faf6ae5cf">object</a>;
<a name="l02723"></a>02723   <span class="keywordtype">int</span> count = (<a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>)[a count]; 
<a name="l02724"></a>02724   NSRect r; 
<a name="l02725"></a>02725   <span class="keywordtype">int</span> <a class="code" href="classFl__X.html#ae4c6997d92cf8ad3a75a962d7ae77c34">i</a>, num_screens = 0;
<a name="l02726"></a>02726   <span class="keywordflow">for</span>( i = 0; i &lt; count; i++) {
<a name="l02727"></a>02727     <span class="keywordtype">object</span> = (NSScreen*)[a objectAtIndex:i];
<a name="l02728"></a>02728     r = [object frame];
<a name="l02729"></a>02729     screens[num_screens].<a class="code" href="structXRectangle.html#ad8e3fc4eef045bff66cfa7414bf9d961">x</a>      = <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>(r.origin.x);
<a name="l02730"></a>02730     screens[num_screens].<a class="code" href="structXRectangle.html#a868d20ae8a5b46cc03e1128b0467b1f3">y</a>      = <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>(r.size.height - (r.origin.y + r.size.height));
<a name="l02731"></a>02731     screens[num_screens].<a class="code" href="structXRectangle.html#a9221b0fe551ac4d4a3324b62f3f5e2e1">width</a>  = <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>(r.size.width);
<a name="l02732"></a>02732     screens[num_screens].<a class="code" href="structXRectangle.html#a3ad204f8adec7b624292499ca5cdadb5">height</a> = <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>(r.size.height);
<a name="l02733"></a>02733 <span class="preprocessor">#if MAC_OS_X_VERSION_MAX_ALLOWED &gt;= MAC_OS_X_VERSION_10_4</span>
<a name="l02734"></a>02734 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ([<span class="keywordtype">object</span> respondsToSelector:<span class="keyword">@selector</span>(userSpaceScaleFactor)]) {
<a name="l02735"></a>02735       dpi[num_screens] = float([<span class="keywordtype">object</span> userSpaceScaleFactor])*72.0f;
<a name="l02736"></a>02736     } <span class="keywordflow">else</span> 
<a name="l02737"></a>02737 <span class="preprocessor">#endif</span>
<a name="l02738"></a>02738 <span class="preprocessor"></span>    {
<a name="l02739"></a>02739       dpi[num_screens] = 72.0f;
<a name="l02740"></a>02740     }
<a name="l02741"></a>02741         
<a name="l02742"></a>02742     num_screens ++;
<a name="l02743"></a>02743     <span class="keywordflow">if</span> (num_screens &gt;= 16) <span class="keywordflow">break</span>;
<a name="l02744"></a>02744   }
<a name="l02745"></a>02745   [localPool release];
<a name="l02746"></a>02746   <span class="keywordflow">return</span> num_screens;
<a name="l02747"></a>02747 }
<a name="l02748"></a>02748 
<a name="l02749"></a>02749 <span class="keyword">@interface </span>FLaboutItemTarget : NSObject 
<a name="l02750"></a>02750 {
<a name="l02751"></a>02751 }
<a name="l02752"></a>02752 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)showPanel;
<a name="l02753"></a>02753 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)printPanel;
<a name="l02754"></a>02754 <span class="keyword">@end</span>
<a name="l02755"></a>02755 <span class="keyword">@implementation </span>FLaboutItemTarget
<a name="l02756"></a>02756 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)showPanel
<a name="l02757"></a>02757 {
<a name="l02758"></a>02758     NSDictionary *options;
<a name="l02759"></a>02759     options = [NSDictionary dictionaryWithObjectsAndKeys:
<a name="l02760"></a>02760                              [NSString stringWithFormat:@&quot; GUI with FLTK %d.%d&quot;, FL_MAJOR_VERSION,
<a name="l02761"></a>02761                               FL_MINOR_VERSION ], @&quot;Copyright&quot;,
<a name="l02762"></a>02762                              nil];
<a name="l02763"></a>02763     [NSApp  orderFrontStandardAboutPanelWithOptions:options];
<a name="l02764"></a>02764   }
<a name="l02765"></a>02765 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>)printPanel
<a name="l02766"></a>02766 {
<a name="l02767"></a>02767   <a class="code" href="classFl__Printer.html" title="OS-independent print support.">Fl_Printer</a> printer;
<a name="l02768"></a>02768   <span class="comment">//Fl_PostScript_File_Device printer;</span>
<a name="l02769"></a>02769   <span class="keywordtype">int</span> <a class="code" href="forms_8H-2.html#aac374e320caaadeca4874add33b62af2">w</a>, <a class="code" href="forms_8H-2.html#a7e427ba5b307f9068129699250690066">h</a>;
<a name="l02770"></a>02770   <a class="code" href="classFl__Window.html">Fl_Window</a> *win = <a class="code" href="group__fl__windows.html#ga3130407bc1c11f9b7f2a9c43a87a1599">Fl::first_window</a>();
<a name="l02771"></a>02771   <span class="keywordflow">if</span>(!win) <span class="keywordflow">return</span>;
<a name="l02772"></a>02772   <span class="keywordflow">if</span>( printer.<a class="code" href="classFl__Printer.html#a8f3603112736f55dd08ef7ad4aaed551" title="Starts a print job.">start_job</a>(1) ) <span class="keywordflow">return</span>;
<a name="l02773"></a>02773   <span class="keywordflow">if</span>( printer.<a class="code" href="classFl__Printer.html#aa7c9294391ecebe05a59b868fe16bac1" title="Starts a new printed page.">start_page</a>() ) <span class="keywordflow">return</span>;
<a name="l02774"></a>02774   <span class="comment">// scale the printer device so that the window fits on the page</span>
<a name="l02775"></a>02775   <span class="keywordtype">float</span> scale = 1;
<a name="l02776"></a>02776   printer.<a class="code" href="classFl__Printer.html#ae7d6d14dd0c0711634f38c599811db9c" title="Computes the width and height of the printable area of the page.">printable_rect</a>(&amp;w, &amp;h);
<a name="l02777"></a>02777   <span class="keywordflow">if</span> (win-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>()&gt;w || win-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>()&gt;<a class="code" href="forms_8H-2.html#a7e427ba5b307f9068129699250690066">h</a>) {
<a name="l02778"></a>02778     scale = (float)w/win-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>();
<a name="l02779"></a>02779     <span class="keywordflow">if</span> ((<span class="keywordtype">float</span>)h/win-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>() &lt; scale) scale = (<span class="keywordtype">float</span>)h/win-&gt;<a class="code" href="classFl__Widget.html#aeeabd61e2d10c76cd6600dbbfe951f71">h</a>();
<a name="l02780"></a>02780     printer.<a class="code" href="classFl__Printer.html#a3016929f51bfa77c9e680f33d8a2227f" title="Changes the scaling of page coordinates.">scale</a>(scale, scale);
<a name="l02781"></a>02781   }
<a name="l02782"></a>02782 <span class="preprocessor">#ifdef ROTATE</span>
<a name="l02783"></a>02783 <span class="preprocessor"></span>  printer.<a class="code" href="classFl__Printer.html#a3016929f51bfa77c9e680f33d8a2227f" title="Changes the scaling of page coordinates.">scale</a>(scale * 0.8, scale * 0.8);
<a name="l02784"></a>02784   printer.<a class="code" href="classFl__Printer.html#ae7d6d14dd0c0711634f38c599811db9c" title="Computes the width and height of the printable area of the page.">printable_rect</a>(&amp;w, &amp;h);
<a name="l02785"></a>02785   printer.<a class="code" href="classFl__Printer.html#ac373a57ae77016b7c0565361323ceebc" title="Sets the position in page coordinates of the origin of graphics functions.">origin</a>(w/2, h/2 );
<a name="l02786"></a>02786   printer.<a class="code" href="classFl__Printer.html#a2c5e858532b376ee7627369c9c8b1c36" title="Rotates the graphics operations relatively to paper.">rotate</a>(20.);
<a name="l02787"></a>02787   printer.<a class="code" href="classFl__Paged__Device.html#a39e2c0919372ded31a94288fc8b50a89" title="Draws the widget on the printed page.">print_widget</a>( win, - win-&gt;<a class="code" href="classFl__Widget.html#ad59ece778aaf15acc4dd01a8bf5f8012">w</a>()/2, - win-&gt;h()/2 );
<a name="l02788"></a>02788 <span class="preprocessor">#else</span>
<a name="l02789"></a>02789 <span class="preprocessor"></span>  printer.<a class="code" href="classFl__Paged__Device.html#a39e2c0919372ded31a94288fc8b50a89" title="Draws the widget on the printed page.">print_widget</a>( win);
<a name="l02790"></a>02790   <span class="comment">//printer.print_window_part( win, 0,0, win-&gt;w(), win-&gt;h() );</span>
<a name="l02791"></a>02791 <span class="preprocessor">#endif</span>
<a name="l02792"></a>02792 <span class="preprocessor"></span>  printer.<a class="code" href="classFl__Printer.html#ac3afd751b80f12a11f02a6e87eeb332a" title="To be called at the end of each page.">end_page</a>();
<a name="l02793"></a>02793   printer.<a class="code" href="classFl__Printer.html#a181c505fbfba8818368f844f7276b06a" title="To be called at the end of a print job.">end_job</a>();
<a name="l02794"></a>02794 }
<a name="l02795"></a>02795 <span class="keyword">@end</span>
<a name="l02796"></a>02796 
<a name="l02797"></a>02797 <span class="keyword">static</span> NSMenu *appleMenu;
<a name="l02798"></a>02798 <span class="keyword">static</span> <span class="keywordtype">void</span> createAppleMenu(<span class="keywordtype">void</span>)
<a name="l02799"></a>02799 {
<a name="l02800"></a>02800   <span class="keyword">static</span> BOOL donethat = NO;
<a name="l02801"></a>02801   <span class="keywordflow">if</span> (donethat) <span class="keywordflow">return</span>;
<a name="l02802"></a>02802   donethat = YES;
<a name="l02803"></a>02803   NSMenu *mainmenu, *services;
<a name="l02804"></a>02804   NSMenuItem *menuItem;
<a name="l02805"></a>02805   NSString *title;
<a name="l02806"></a>02806   CFStringRef nsappname;
<a name="l02807"></a>02807   
<a name="l02808"></a>02808   ProcessSerialNumber psn;
<a name="l02809"></a>02809   GetCurrentProcess(&amp;psn);
<a name="l02810"></a>02810   CopyProcessName(&amp;psn, &amp;nsappname);
<a name="l02811"></a>02811   appleMenu = [[NSMenu alloc] initWithTitle:@&quot;&quot;];
<a name="l02812"></a>02812   <span class="comment">/* Add menu items */</span>
<a name="l02813"></a>02813   title = [@&quot;About &quot; stringByAppendingString:(NSString*)nsappname];
<a name="l02814"></a>02814   menuItem = [appleMenu addItemWithTitle:title action:@selector(showPanel) keyEquivalent:@&quot;&quot;];
<a name="l02815"></a>02815   FLaboutItemTarget *about = [[FLaboutItemTarget alloc] init];
<a name="l02816"></a>02816   [menuItem setTarget:about];
<a name="l02817"></a>02817   [appleMenu addItem:[NSMenuItem separatorItem]];
<a name="l02818"></a>02818   <span class="comment">// Print front window</span>
<a name="l02819"></a>02819   menuItem = [appleMenu addItemWithTitle:@&quot;Print front window&quot; action:@selector(printPanel) keyEquivalent:@&quot;&quot;];
<a name="l02820"></a>02820   [menuItem setTarget:about];
<a name="l02821"></a>02821   [appleMenu setAutoenablesItems:NO];
<a name="l02822"></a>02822   [menuItem setEnabled:YES];
<a name="l02823"></a>02823   [appleMenu addItem:[NSMenuItem separatorItem]];
<a name="l02824"></a>02824   <span class="comment">// Services Menu</span>
<a name="l02825"></a>02825   services = [[NSMenu alloc] init];
<a name="l02826"></a>02826   [appleMenu addItemWithTitle:@&quot;Services&quot; action:nil keyEquivalent:@&quot;&quot;];
<a name="l02827"></a>02827   [appleMenu setSubmenu: services forItem: [appleMenu itemWithTitle: @&quot;Services&quot;]];
<a name="l02828"></a>02828   <span class="comment">// Hide AppName</span>
<a name="l02829"></a>02829   title = [@&quot;Hide &quot; stringByAppendingString:(NSString*)nsappname];
<a name="l02830"></a>02830   [appleMenu addItemWithTitle:title action:@selector(hide:) keyEquivalent:@&quot;h&quot;];
<a name="l02831"></a>02831   <span class="comment">// Hide Others</span>
<a name="l02832"></a>02832   menuItem = (NSMenuItem *)[appleMenu addItemWithTitle:<span class="stringliteral">@&quot;Hide Others&quot;</span> action:<span class="keyword">@selector</span>(hideOtherApplications:) 
<a name="l02833"></a>02833                                          keyEquivalent:<span class="stringliteral">@&quot;h&quot;</span>];
<a name="l02834"></a>02834   [menuItem setKeyEquivalentModifierMask:(NSAlternateKeyMask|NSCommandKeyMask)];
<a name="l02835"></a>02835   <span class="comment">// Show All</span>
<a name="l02836"></a>02836   [appleMenu addItemWithTitle:@&quot;Show All&quot; action:@selector(unhideAllApplications:) keyEquivalent:@&quot;&quot;];
<a name="l02837"></a>02837   [appleMenu addItem:[NSMenuItem separatorItem]];
<a name="l02838"></a>02838   <span class="comment">// Quit AppName</span>
<a name="l02839"></a>02839   title = [@&quot;Quit &quot; stringByAppendingString:(NSString*)nsappname];
<a name="l02840"></a>02840   [appleMenu addItemWithTitle:title action:@selector(terminate:) keyEquivalent:@&quot;q&quot;];
<a name="l02841"></a>02841   <span class="comment">/* Put menu into the menubar */</span>
<a name="l02842"></a>02842   menuItem = [[NSMenuItem alloc] initWithTitle:@&quot;&quot; action:nil keyEquivalent:@&quot;&quot;];
<a name="l02843"></a>02843   [menuItem setSubmenu:appleMenu];
<a name="l02844"></a>02844   mainmenu = [[NSMenu alloc] initWithTitle:@&quot;&quot;];
<a name="l02845"></a>02845   [mainmenu addItem:menuItem];
<a name="l02846"></a>02846   <span class="keywordflow">if</span> (<a class="code" href="group__group__macosx.html#ga2c7db6b2ea9a6ae37a26bea810d2056c" title="The version number of the running Mac OS X (e.g., 0x1064 for 10.6.4)">fl_mac_os_version</a> &lt; 0x1060) {
<a name="l02847"></a>02847     <span class="comment">//  [NSApp setAppleMenu:appleMenu];</span>
<a name="l02848"></a>02848     <span class="comment">//  to avoid compiler warning raised by use of undocumented setAppleMenu    :</span>
<a name="l02849"></a>02849     [NSApp performSelector:@selector(setAppleMenu:) withObject:appleMenu];
<a name="l02850"></a>02850   }
<a name="l02851"></a>02851   [NSApp setServicesMenu:services];
<a name="l02852"></a>02852   [NSApp setMainMenu:mainmenu];
<a name="l02853"></a>02853   CFRelease(nsappname);
<a name="l02854"></a>02854   [services release];
<a name="l02855"></a>02855   [mainmenu release];
<a name="l02856"></a>02856   [appleMenu release];
<a name="l02857"></a>02857   [menuItem release];
<a name="l02858"></a>02858   <a class="code" href="Fl__mac_8cxx.html#aa47c81d9e111e268551357524ebb5e4e">fl_system_menu</a> = [NSApp mainMenu];
<a name="l02859"></a>02859 }
<a name="l02860"></a>02860 
<a name="l02861"></a>02861 <span class="keyword">@interface </span>FLMenuItem : NSMenuItem {
<a name="l02862"></a>02862 }
<a name="l02863"></a>02863 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>) doCallback:(<span class="keywordtype">id</span>)unused;
<a name="l02864"></a>02864 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>) directCallback:(<span class="keywordtype">id</span>)unused;
<a name="l02865"></a>02865 <span class="keyword">@end</span>
<a name="l02866"></a>02866 <span class="keyword">@implementation </span>FLMenuItem
<a name="l02867"></a>02867 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>) doCallback:(<span class="keywordtype">id</span>)unused
<a name="l02868"></a>02868 {
<a name="l02869"></a>02869   <span class="keywordtype">int</span> flRank = [<span class="keyword">self</span> tag];
<a name="l02870"></a>02870   <span class="keyword">const</span> <a class="code" href="structFl__Menu__Item.html">Fl_Menu_Item</a> *items = fl_sys_menu_bar-&gt;Fl_Menu_::menu();
<a name="l02871"></a>02871   <span class="keyword">const</span> <a class="code" href="structFl__Menu__Item.html">Fl_Menu_Item</a> *item = items + flRank;
<a name="l02872"></a>02872   <span class="keywordflow">if</span> (item) {
<a name="l02873"></a>02873     fl_sys_menu_bar-&gt;<a class="code" href="classFl__Menu__.html#a0a528db63b4eaa0edda217787a0c9d5a">picked</a>(item);
<a name="l02874"></a>02874     <span class="keywordflow">if</span> ( item-&gt;<a class="code" href="structFl__Menu__Item.html#aae6ba303ffaf74a0267c978ae8ec475f" title="menu item flags like FL_MENU_TOGGLE, FL_MENU_RADIO">flags</a> &amp; <a class="code" href="Fl__Menu__Item_8H.html#ab04a0655cd1e3bcac5e8f48c18df1a57a7425ae185af0bdbf04dbadaaa9413574" title="Item is a checkbox toggle (shows checkbox for on/off state)">FL_MENU_TOGGLE</a> ) {       <span class="comment">// update the menu toggle symbol</span>
<a name="l02875"></a>02875       [<span class="keyword">self</span> setState:(item-&gt;value() ? NSOnState : NSOffState)];
<a name="l02876"></a>02876     }
<a name="l02877"></a>02877     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( item-&gt;<a class="code" href="structFl__Menu__Item.html#aae6ba303ffaf74a0267c978ae8ec475f" title="menu item flags like FL_MENU_TOGGLE, FL_MENU_RADIO">flags</a> &amp; <a class="code" href="Fl__Menu__Item_8H.html#ab04a0655cd1e3bcac5e8f48c18df1a57a11aab33bbffb20feac97c9b9979638bf" title="Item is a radio button (one checkbox of many can be on)">FL_MENU_RADIO</a> ) {   <span class="comment">// update the menu radio symbols</span>
<a name="l02878"></a>02878       <span class="keywordtype">int</span> from = flRank;
<a name="l02879"></a>02879       <span class="keywordflow">while</span>( from &gt; 0 &amp;&amp; items[from - 1].label() &amp;&amp; (items[from - 1].<a class="code" href="png_8h.html#a977410f175f1b6ea314bf5b2c0788dfb">flags</a> &amp; <a class="code" href="Fl__Menu__Item_8H.html#ab04a0655cd1e3bcac5e8f48c18df1a57a11aab33bbffb20feac97c9b9979638bf" title="Item is a radio button (one checkbox of many can be on)">FL_MENU_RADIO</a>) &amp;&amp;
<a name="l02880"></a>02880             !(items[from - 1].<a class="code" href="png_8h.html#a977410f175f1b6ea314bf5b2c0788dfb">flags</a> &amp; <a class="code" href="Fl__Menu__Item_8H.html#ab04a0655cd1e3bcac5e8f48c18df1a57a4e221192c48b090c3c3a0a6fb716faae" title="Creates divider line below this item. Also ends a group of radio buttons.">FL_MENU_DIVIDER</a>) ) {
<a name="l02881"></a>02881         from--;
<a name="l02882"></a>02882       }
<a name="l02883"></a>02883       <span class="keywordtype">int</span> to = flRank;
<a name="l02884"></a>02884       <span class="keywordflow">while</span>( !(items[to].<a class="code" href="png_8h.html#a977410f175f1b6ea314bf5b2c0788dfb">flags</a> &amp; FL_MENU_DIVIDER) &amp;&amp; items[to + 1].label() &amp;&amp; 
<a name="l02885"></a>02885             (items[to + 1].<a class="code" href="png_8h.html#a977410f175f1b6ea314bf5b2c0788dfb">flags</a> &amp; FL_MENU_RADIO) ) {
<a name="l02886"></a>02886         to++;
<a name="l02887"></a>02887       }
<a name="l02888"></a>02888       NSMenu *nsmenu = [<span class="keyword">self</span> menu];
<a name="l02889"></a>02889       <span class="keywordtype">int</span> nsrank = (<a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>)[nsmenu indexOfItem:<span class="keyword">self</span>];
<a name="l02890"></a>02890       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i =  from - flRank + nsrank ; i &lt;= to - flRank + nsrank; i++) {
<a name="l02891"></a>02891         NSMenuItem *nsitem = [nsmenu itemAtIndex:i];
<a name="l02892"></a>02892         <span class="keywordflow">if</span> (nsitem != <span class="keyword">self</span>) [nsitem setState:NSOffState];
<a name="l02893"></a>02893         <span class="keywordflow">else</span> [nsitem setState:(item-&gt;value() ? NSOnState : NSOffState) ];
<a name="l02894"></a>02894       }
<a name="l02895"></a>02895     }
<a name="l02896"></a>02896   }
<a name="l02897"></a>02897 }
<a name="l02898"></a>02898 - (<a class="code" href="png_8h.html#a04364e387081209df3bd1a16e8abe3b9">void</a>) directCallback:(<span class="keywordtype">id</span>)unused
<a name="l02899"></a>02899 {
<a name="l02900"></a>02900   <a class="code" href="structFl__Menu__Item.html">Fl_Menu_Item</a> *item = (<a class="code" href="structFl__Menu__Item.html">Fl_Menu_Item</a> *)[(NSData*)[<span class="keyword">self</span> representedObject] bytes];
<a name="l02901"></a>02901   <span class="keywordflow">if</span> ( item &amp;&amp; item-&gt;<a class="code" href="structFl__Menu__Item.html#aa32c8922da3abe43b12db932f9cc9e12">callback</a>() ) item-&gt;<a class="code" href="structFl__Menu__Item.html#ac9b370ff79835ca1b18727adc8b5de7d">do_callback</a>(<a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02902"></a>02902 }
<a name="l02903"></a>02903 <span class="keyword">@end</span>
<a name="l02904"></a>02904 
<a name="l02905"></a>02905 <span class="keywordtype">void</span> <a class="code" href="group__group__macosx.html#gac2ba4bfc66f7bc9792dffa2aeb53064e" title="Attaches a callback to the &amp;quot;About myprog&amp;quot; item of the system application menu...">fl_mac_set_about</a>( <a class="code" href="Fl__Widget_8H.html#ab6406a5102af4ed276b6e050ad16ea05">Fl_Callback</a> *cb, <span class="keywordtype">void</span> *user_data, <span class="keywordtype">int</span> shortcut) 
<a name="l02906"></a>02906 {
<a name="l02907"></a>02907   NSAutoreleasePool *localPool;
<a name="l02908"></a>02908   localPool = [[NSAutoreleasePool alloc] init]; 
<a name="l02909"></a>02909   <a class="code" href="mac_8H.html#a94ee21d83137569a6730e3e2e7305cbc">fl_open_display</a>();
<a name="l02910"></a>02910   <a class="code" href="structFl__Menu__Item.html">Fl_Menu_Item</a> aboutItem;
<a name="l02911"></a>02911   memset(&amp;aboutItem, 0, <span class="keyword">sizeof</span>(<a class="code" href="structFl__Menu__Item.html">Fl_Menu_Item</a>));
<a name="l02912"></a>02912   aboutItem.<a class="code" href="structFl__Menu__Item.html#aa32c8922da3abe43b12db932f9cc9e12">callback</a>(cb);
<a name="l02913"></a>02913   aboutItem.<a class="code" href="structFl__Menu__Item.html#ae8192e7a8277c85c1a8e431a9e4bd6a8">user_data</a>(user_data);
<a name="l02914"></a>02914   aboutItem.<a class="code" href="structFl__Menu__Item.html#aadd404c32e06b1b358185781612fd38b">shortcut</a>(shortcut);
<a name="l02915"></a>02915   CFStringRef cfname = CFStringCreateCopy(<a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, (CFStringRef)[[appleMenu itemAtIndex:0] title]);
<a name="l02916"></a>02916   [appleMenu removeItemAtIndex:0];
<a name="l02917"></a>02917   FLMenuItem *item = [[[FLMenuItem alloc] initWithTitle:(NSString*)cfname 
<a name="l02918"></a>02918                                                  action:@selector(directCallback:) 
<a name="l02919"></a>02919                                           keyEquivalent:@&quot;&quot;] autorelease];
<a name="l02920"></a>02920   <span class="keywordflow">if</span> (aboutItem.<a class="code" href="structFl__Menu__Item.html#aadd404c32e06b1b358185781612fd38b">shortcut</a>()) {
<a name="l02921"></a>02921     Fl_Sys_Menu_Bar::doMenuOrItemOperation(Fl_Sys_Menu_Bar::setKeyEquivalent, item, aboutItem.<a class="code" href="structFl__Menu__Item.html#aadd404c32e06b1b358185781612fd38b">shortcut</a>() &amp; 0xff);
<a name="l02922"></a>02922     Fl_Sys_Menu_Bar::doMenuOrItemOperation(Fl_Sys_Menu_Bar::setKeyEquivalentModifierMask, item, aboutItem.<a class="code" href="structFl__Menu__Item.html#aadd404c32e06b1b358185781612fd38b">shortcut</a>() );
<a name="l02923"></a>02923   }
<a name="l02924"></a>02924   NSData *pointer = [NSData dataWithBytes:&amp;aboutItem length:sizeof(Fl_Menu_Item)];
<a name="l02925"></a>02925   [item setRepresentedObject:pointer];
<a name="l02926"></a>02926   [appleMenu insertItem:item atIndex:0];
<a name="l02927"></a>02927   CFRelease(cfname);
<a name="l02928"></a>02928   [item setTarget:item];
<a name="l02929"></a>02929   [localPool release];
<a name="l02930"></a>02930 }
<a name="l02931"></a>02931 
<a name="l02932"></a>02932 <span class="keyword">static</span> <span class="keywordtype">char</span> *remove_ampersand(<span class="keyword">const</span> <span class="keywordtype">char</span> *s)
<a name="l02933"></a>02933 {
<a name="l02934"></a>02934   <span class="keywordtype">char</span> *ret = strdup(s);
<a name="l02935"></a>02935   <span class="keyword">const</span> <span class="keywordtype">char</span> *p = s;
<a name="l02936"></a>02936   <span class="keywordtype">char</span> *q = ret;
<a name="l02937"></a>02937   <span class="keywordflow">while</span>(*p != 0) {
<a name="l02938"></a>02938     <span class="keywordflow">if</span> (p[0]==<span class="charliteral">&#39;&amp;&#39;</span>) {
<a name="l02939"></a>02939       <span class="keywordflow">if</span> (p[1]==<span class="charliteral">&#39;&amp;&#39;</span>) {
<a name="l02940"></a>02940         *q++ = &#39;&amp;&#39;; p+=2;
<a name="l02941"></a>02941       } <span class="keywordflow">else</span> {
<a name="l02942"></a>02942         p++;
<a name="l02943"></a>02943       }
<a name="l02944"></a>02944     } <span class="keywordflow">else</span> {
<a name="l02945"></a>02945       *q++ = *p++;
<a name="l02946"></a>02946     }
<a name="l02947"></a>02947   }
<a name="l02948"></a>02948   *q = 0;
<a name="l02949"></a>02949   <span class="keywordflow">return</span> ret;
<a name="l02950"></a>02950 }
<a name="l02951"></a>02951 
<a name="l02952"></a>02952 <span class="keywordtype">void</span> *Fl_Sys_Menu_Bar::doMenuOrItemOperation(Fl_Sys_Menu_Bar::menuOrItemOperation operation, ...)
<a name="l02953"></a>02953 <span class="comment">/* these operations apply to menus, submenus, or menu items</span>
<a name="l02954"></a>02954 <span class="comment"> */</span>
<a name="l02955"></a>02955 {
<a name="l02956"></a>02956   NSAutoreleasePool *localPool;
<a name="l02957"></a>02957   localPool = [[NSAutoreleasePool alloc] init]; 
<a name="l02958"></a>02958   NSMenu *<a class="code" href="classFl__Menu__.html#a44b0dd7371022c6df07fda0e9aa0e293">menu</a>;
<a name="l02959"></a>02959   NSMenuItem *item;
<a name="l02960"></a>02960   <span class="keywordtype">int</span> <a class="code" href="classFl__Menu__.html#a40abf9e10bb55f479effbf3a15a778bf">value</a>;
<a name="l02961"></a>02961   <span class="keywordtype">void</span> *pter;
<a name="l02962"></a>02962   <span class="keywordtype">void</span> *retval = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02963"></a>02963   va_list ap;
<a name="l02964"></a>02964   va_start(ap, operation);
<a name="l02965"></a>02965   
<a name="l02966"></a>02966   <span class="keywordflow">if</span> (operation == Fl_Sys_Menu_Bar::itemAtIndex) {      <span class="comment">// arguments: NSMenu*, int. Returns the item</span>
<a name="l02967"></a>02967     menu = va_arg(ap, NSMenu*);
<a name="l02968"></a>02968     value = va_arg(ap, <span class="keywordtype">int</span>);
<a name="l02969"></a>02969     retval = (<span class="keywordtype">void</span> *)[menu itemAtIndex:value];
<a name="l02970"></a>02970   }
<a name="l02971"></a>02971   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (operation == Fl_Sys_Menu_Bar::setKeyEquivalent) {    <span class="comment">// arguments: NSMenuItem*, int</span>
<a name="l02972"></a>02972     item = va_arg(ap, NSMenuItem*);
<a name="l02973"></a>02973     value = va_arg(ap, <span class="keywordtype">int</span>);
<a name="l02974"></a>02974     <span class="keywordtype">char</span> <a class="code" href="Fl__Text__Editor_8cxx.html#a35af0be900467fedbb610bd6ea65ed78">key</a> = <a class="code" href="classFl__Menu__.html#a40abf9e10bb55f479effbf3a15a778bf">value</a>;
<a name="l02975"></a>02975     NSString *equiv = [[NSString alloc] initWithBytes:&amp;key length:1 encoding:NSASCIIStringEncoding];
<a name="l02976"></a>02976     [item setKeyEquivalent:equiv];
<a name="l02977"></a>02977     [equiv release];
<a name="l02978"></a>02978   }
<a name="l02979"></a>02979   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (operation == Fl_Sys_Menu_Bar::setKeyEquivalentModifierMask) {                <span class="comment">// arguments: NSMenuItem*, int</span>
<a name="l02980"></a>02980     item = va_arg(ap, NSMenuItem*);
<a name="l02981"></a>02981     value = va_arg(ap, <span class="keywordtype">int</span>);
<a name="l02982"></a>02982     NSUInteger macMod = 0;
<a name="l02983"></a>02983     <span class="keywordflow">if</span> ( value &amp; <a class="code" href="Enumerations_8H.html#a2c50b1b00111f992d5d49f07c9cee22a" title="One of the meta/Windows keys is down.">FL_META</a> ) macMod = NSCommandKeyMask;
<a name="l02984"></a>02984     <span class="keywordflow">if</span> ( value &amp; <a class="code" href="Enumerations_8H.html#aa0d93ca1bc8a0c7f84888cdf458f043d" title="One of the shift keys is down.">FL_SHIFT</a> || isupper(value) ) macMod |= NSShiftKeyMask;
<a name="l02985"></a>02985     <span class="keywordflow">if</span> ( value &amp; <a class="code" href="Enumerations_8H.html#a58b1ac5446b292c77043f99558eb07cb" title="One of the alt keys is down.">FL_ALT</a> ) macMod |= NSAlternateKeyMask;
<a name="l02986"></a>02986     <span class="keywordflow">if</span> ( value &amp; <a class="code" href="Enumerations_8H.html#a29324ec5ac8c1d87950127d387dc83e8" title="One of the ctrl keys is down.">FL_CTRL</a> ) macMod |= NSControlKeyMask;
<a name="l02987"></a>02987     [item setKeyEquivalentModifierMask:macMod];
<a name="l02988"></a>02988   }
<a name="l02989"></a>02989   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (operation == Fl_Sys_Menu_Bar::setState) {    <span class="comment">// arguments: NSMenuItem*, int</span>
<a name="l02990"></a>02990     item = va_arg(ap, NSMenuItem*);
<a name="l02991"></a>02991     value = va_arg(ap, <span class="keywordtype">int</span>);
<a name="l02992"></a>02992     [item setState:(value ? NSOnState : NSOffState)];
<a name="l02993"></a>02993   }
<a name="l02994"></a>02994   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (operation == Fl_Sys_Menu_Bar::initWithTitle) {       <span class="comment">// arguments: const char*title. Returns the newly created menu</span>
<a name="l02995"></a>02995                                                                 <span class="comment">// creates a new (sub)menu</span>
<a name="l02996"></a>02996     <span class="keywordtype">char</span> *ts = remove_ampersand(va_arg(ap, <span class="keywordtype">char</span> *));
<a name="l02997"></a>02997     CFStringRef title = CFStringCreateWithCString(<a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ts, kCFStringEncodingUTF8);
<a name="l02998"></a>02998     free(ts);
<a name="l02999"></a>02999     NSMenu *menu = [[NSMenu alloc] initWithTitle:(NSString*)title];
<a name="l03000"></a>03000     CFRelease(title);
<a name="l03001"></a>03001     [menu setAutoenablesItems:NO];
<a name="l03002"></a>03002     retval = (<span class="keywordtype">void</span> *)menu;
<a name="l03003"></a>03003   }
<a name="l03004"></a>03004   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (operation == Fl_Sys_Menu_Bar::numberOfItems) {       <span class="comment">// arguments: NSMenu *menu, int *pcount</span>
<a name="l03005"></a>03005                                                                 <span class="comment">// upon return, *pcount is set to menu&#39;s item count</span>
<a name="l03006"></a>03006     menu = va_arg(ap, NSMenu*);
<a name="l03007"></a>03007     pter = va_arg(ap, <span class="keywordtype">void</span> *);
<a name="l03008"></a>03008     *(<span class="keywordtype">int</span>*)pter = [menu numberOfItems];
<a name="l03009"></a>03009   }
<a name="l03010"></a>03010   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (operation == Fl_Sys_Menu_Bar::setSubmenu) {          <span class="comment">// arguments: NSMenuItem *item, NSMenu *menu</span>
<a name="l03011"></a>03011                                                                 <span class="comment">// sets &#39;menu&#39; as submenu attached to &#39;item&#39;</span>
<a name="l03012"></a>03012     item = va_arg(ap, NSMenuItem*);
<a name="l03013"></a>03013     menu = va_arg(ap, NSMenu*);
<a name="l03014"></a>03014     [item setSubmenu:menu];
<a name="l03015"></a>03015     [menu release];
<a name="l03016"></a>03016   }
<a name="l03017"></a>03017   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (operation == Fl_Sys_Menu_Bar::setEnabled) {          <span class="comment">// arguments: NSMenuItem*, int</span>
<a name="l03018"></a>03018     item = va_arg(ap, NSMenuItem*);
<a name="l03019"></a>03019     value = va_arg(ap, <span class="keywordtype">int</span>);
<a name="l03020"></a>03020     [item setEnabled:(value ? YES : NO)];
<a name="l03021"></a>03021   }
<a name="l03022"></a>03022   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (operation == Fl_Sys_Menu_Bar::addSeparatorItem) {    <span class="comment">// arguments: NSMenu*</span>
<a name="l03023"></a>03023     menu = va_arg(ap, NSMenu*);
<a name="l03024"></a>03024     [menu addItem:[NSMenuItem separatorItem]];
<a name="l03025"></a>03025   }
<a name="l03026"></a>03026   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (operation == Fl_Sys_Menu_Bar::setTitle) {            <span class="comment">// arguments: NSMenuItem*, const char *</span>
<a name="l03027"></a>03027     item = va_arg(ap, NSMenuItem*);
<a name="l03028"></a>03028     <span class="keywordtype">char</span> *ts = remove_ampersand(va_arg(ap, <span class="keywordtype">char</span> *));
<a name="l03029"></a>03029     CFStringRef title = CFStringCreateWithCString(<a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ts, kCFStringEncodingUTF8);
<a name="l03030"></a>03030     free(ts);
<a name="l03031"></a>03031     [item setTitle:(NSString*)title];
<a name="l03032"></a>03032     CFRelease(title);
<a name="l03033"></a>03033   }
<a name="l03034"></a>03034   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (operation == Fl_Sys_Menu_Bar::removeItem) {          <span class="comment">// arguments: NSMenu*, int</span>
<a name="l03035"></a>03035     menu = va_arg(ap, NSMenu*);
<a name="l03036"></a>03036     value = va_arg(ap, <span class="keywordtype">int</span>);
<a name="l03037"></a>03037     [menu removeItem:[menu itemAtIndex:value]];
<a name="l03038"></a>03038   }
<a name="l03039"></a>03039   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (operation == Fl_Sys_Menu_Bar::addNewItem) {          <span class="comment">// arguments: NSMenu *menu, int flrank, int *prank</span>
<a name="l03040"></a>03040     <span class="comment">// creates a new menu item at the end of &#39;menu&#39;</span>
<a name="l03041"></a>03041     <span class="comment">// attaches the item of rank flrank (counted in Fl_Menu_) of fl_sys_menu_bar to it</span>
<a name="l03042"></a>03042     <span class="comment">// upon return, puts the rank (counted in NSMenu) of the new item in *prank unless prank is NULL</span>
<a name="l03043"></a>03043     menu = va_arg(ap, NSMenu*);
<a name="l03044"></a>03044     <span class="keywordtype">int</span> flRank = va_arg(ap, <span class="keywordtype">int</span>);
<a name="l03045"></a>03045     <span class="keywordtype">char</span> *name = remove_ampersand( (fl_sys_menu_bar-&gt;Fl_Menu_::menu() + flRank)-&gt;<a class="code" href="classFl__Widget.html#abb0e926996f83bc1c60972afa8284045">label</a>());
<a name="l03046"></a>03046     <span class="keywordtype">int</span> *prank = va_arg(ap, <span class="keywordtype">int</span>*);
<a name="l03047"></a>03047     CFStringRef cfname = CFStringCreateWithCString(<a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, name, kCFStringEncodingUTF8);
<a name="l03048"></a>03048     free(name);
<a name="l03049"></a>03049     FLMenuItem *item = [[FLMenuItem alloc] initWithTitle:(NSString*)cfname 
<a name="l03050"></a>03050                                                   action:@selector(doCallback:) 
<a name="l03051"></a>03051                                            keyEquivalent:@&quot;&quot;];
<a name="l03052"></a>03052     [item setTag:flRank];
<a name="l03053"></a>03053     [menu addItem:item];
<a name="l03054"></a>03054     CFRelease(cfname);
<a name="l03055"></a>03055     [item setTarget:item];
<a name="l03056"></a>03056     <span class="keywordflow">if</span> (prank != <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) *prank = [menu indexOfItem:item];
<a name="l03057"></a>03057     [item release];
<a name="l03058"></a>03058   }
<a name="l03059"></a>03059   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (operation == Fl_Sys_Menu_Bar::renameItem) {          <span class="comment">// arguments: int rank, const char *newname</span>
<a name="l03060"></a>03060     <span class="comment">// renames the system menu item numbered rank in fl_sys_menu_bar-&gt;menu()</span>
<a name="l03061"></a>03061     <span class="keywordtype">int</span> rank = va_arg(ap, <span class="keywordtype">int</span>);
<a name="l03062"></a>03062     <span class="keywordtype">char</span> *newname = remove_ampersand( va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *) );
<a name="l03063"></a>03063     <span class="keywordtype">int</span> countmenus = [(NSMenu*)fl_system_menu numberOfItems];
<a name="l03064"></a>03064     <span class="keywordtype">bool</span> found = NO;
<a name="l03065"></a>03065     NSMenuItem *macitem = 0;
<a name="l03066"></a>03066     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 1; (!found) &amp;&amp; i &lt; countmenus; i++) {
<a name="l03067"></a>03067       NSMenuItem *item = [(NSMenu*)fl_system_menu itemAtIndex:i];
<a name="l03068"></a>03068       NSMenu *submenu = [item submenu];
<a name="l03069"></a>03069       <span class="keywordflow">if</span> (submenu == nil) <span class="keywordflow">continue</span>;
<a name="l03070"></a>03070       <span class="keywordtype">int</span> countitems = [submenu numberOfItems];
<a name="l03071"></a>03071       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j = 0; j &lt; countitems; j++) {
<a name="l03072"></a>03072         macitem = [submenu itemAtIndex:j];
<a name="l03073"></a>03073         <span class="keywordflow">if</span> ([macitem tag] == rank) { found = YES; <span class="keywordflow">break</span>; }
<a name="l03074"></a>03074       }
<a name="l03075"></a>03075     }
<a name="l03076"></a>03076     <span class="keywordflow">if</span> (found) {
<a name="l03077"></a>03077       [macitem setTitle:[[[NSString alloc] initWithUTF8String:newname] autorelease]];
<a name="l03078"></a>03078     }
<a name="l03079"></a>03079     free(newname);
<a name="l03080"></a>03080   }
<a name="l03081"></a>03081   va_end(ap);
<a name="l03082"></a>03082   [localPool release];
<a name="l03083"></a>03083   <span class="keywordflow">return</span> retval;
<a name="l03084"></a>03084 }
<a name="l03085"></a>03085 
<a name="l03086"></a>03086 <span class="keywordtype">void</span> Fl_X::set_key_window()
<a name="l03087"></a>03087 {
<a name="l03088"></a>03088   [(NSWindow*)xid makeKeyAndOrderFront:nil];
<a name="l03089"></a>03089 }
<a name="l03090"></a>03090 
<a name="l03091"></a>03091 <span class="keyword">static</span> NSImage *imageFromText(<span class="keyword">const</span> <span class="keywordtype">char</span> *text, <span class="keywordtype">int</span> *pwidth, <span class="keywordtype">int</span> *pheight)
<a name="l03092"></a>03092 {
<a name="l03093"></a>03093   <span class="keyword">const</span> <span class="keywordtype">char</span> *p, *q;
<a name="l03094"></a>03094   <span class="keywordtype">int</span> <a class="code" href="png_8h.html#a435a10efbc8005bae2e58e63cf9b55ce">width</a> = 0, <a class="code" href="png_8h.html#aabca0b2ed5d849f535861a33f2b3cf61">height</a>, w2, ltext = strlen(text);
<a name="l03095"></a>03095   <a class="code" href="group__fl__attributes.html#ga1bdba1e2b321676da6b0b290f485bf27">fl_font</a>(<a class="code" href="Enumerations_8H.html#a74d2c443f7ab53a6ce5d4ca0c7461bc9" title="Helvetica (or Arial) normal (0)">FL_HELVETICA</a>, 10);
<a name="l03096"></a>03096   p = text;
<a name="l03097"></a>03097   <span class="keywordtype">int</span> nl = 0;
<a name="l03098"></a>03098   <span class="keywordflow">while</span>((q=strchr(p, <span class="charliteral">&#39;\n&#39;</span>)) != <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) { 
<a name="l03099"></a>03099     nl++; 
<a name="l03100"></a>03100     w2 = <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>(<a class="code" href="group__fl__attributes.html#ga92c762ce2fc7fa891bac6b7590f967bd">fl_width</a>(p, q - p));
<a name="l03101"></a>03101     <span class="keywordflow">if</span> (w2 &gt; width) width = w2;
<a name="l03102"></a>03102     p = q + 1; 
<a name="l03103"></a>03103   }
<a name="l03104"></a>03104   <span class="keywordflow">if</span> (text[ ltext - 1] != <span class="charliteral">&#39;\n&#39;</span>) {
<a name="l03105"></a>03105     nl++;
<a name="l03106"></a>03106     w2 = <a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>(<a class="code" href="group__fl__attributes.html#ga92c762ce2fc7fa891bac6b7590f967bd">fl_width</a>(p));
<a name="l03107"></a>03107     <span class="keywordflow">if</span> (w2 &gt; width) width = w2;
<a name="l03108"></a>03108   }
<a name="l03109"></a>03109   <a class="code" href="png_8h.html#aabca0b2ed5d849f535861a33f2b3cf61">height</a> = nl * <a class="code" href="group__fl__attributes.html#ga1c7f56648cfc21431f30b1fa0f2d22ff">fl_height</a>() + 3;
<a name="l03110"></a>03110   width += 6;
<a name="l03111"></a>03111   <a class="code" href="mac_8H.html#a73ca2fde79c397d91d1147fde9cccc39">Fl_Offscreen</a> off = fl_create_offscreen_with_alpha(width, <a class="code" href="png_8h.html#aabca0b2ed5d849f535861a33f2b3cf61">height</a>);
<a name="l03112"></a>03112   <a class="code" href="mac_8H.html#aac0378733483d10e73c694adf93f462c">fl_begin_offscreen</a>(off);
<a name="l03113"></a>03113   CGContextSetRGBFillColor( (CGContextRef)off, 0,0,0,0);
<a name="l03114"></a>03114   <a class="code" href="group__fl__drawings.html#ga2986a868e9cc8d9141acde94c0fe8ab0">fl_rectf</a>(0,0,width,<a class="code" href="png_8h.html#aabca0b2ed5d849f535861a33f2b3cf61">height</a>);
<a name="l03115"></a>03115   <a class="code" href="group__fl__attributes.html#ga974e9f64959aa83cf6f0a36d3f0105aa">fl_color</a>(<a class="code" href="Enumerations_8H.html#a705ea07a3ad2b7e3b7745c9c3c651bba">FL_BLACK</a>);
<a name="l03116"></a>03116   p = text;
<a name="l03117"></a>03117   <span class="keywordtype">int</span> y = <a class="code" href="group__fl__attributes.html#ga1c7f56648cfc21431f30b1fa0f2d22ff">fl_height</a>();
<a name="l03118"></a>03118   <span class="keywordflow">while</span>(<a class="code" href="forms_8H-2.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>) {
<a name="l03119"></a>03119     q = strchr(p, <span class="charliteral">&#39;\n&#39;</span>);
<a name="l03120"></a>03120     <span class="keywordflow">if</span> (q) {
<a name="l03121"></a>03121       <a class="code" href="group__fl__drawings.html#gacf054f0c5c5d3ab6caa1e8be3d58ec7e">fl_draw</a>(p, q - p, 3, y);
<a name="l03122"></a>03122     } <span class="keywordflow">else</span> {
<a name="l03123"></a>03123       <a class="code" href="group__fl__drawings.html#gacf054f0c5c5d3ab6caa1e8be3d58ec7e">fl_draw</a>(p, 3, y);
<a name="l03124"></a>03124       <span class="keywordflow">break</span>;
<a name="l03125"></a>03125     }
<a name="l03126"></a>03126     y += <a class="code" href="group__fl__attributes.html#ga1c7f56648cfc21431f30b1fa0f2d22ff">fl_height</a>();
<a name="l03127"></a>03127     p = q + 1;
<a name="l03128"></a>03128   }
<a name="l03129"></a>03129   <a class="code" href="mac_8H.html#ac2195ac3bd679bac0b2810c8ac90faa6">fl_end_offscreen</a>();
<a name="l03130"></a>03130   NSImage* <a class="code" href="png_8h.html#a4a84becf999bb6d9e55899b71ed75bcf">image</a> = CGBitmapContextToNSImage( (CGContextRef)off );
<a name="l03131"></a>03131   <a class="code" href="mac_8H.html#a12c4aafe6b26b130c04f5ea972d33480">fl_delete_offscreen</a>( off );
<a name="l03132"></a>03132   *pwidth = <a class="code" href="png_8h.html#a435a10efbc8005bae2e58e63cf9b55ce">width</a>;
<a name="l03133"></a>03133   *pheight = <a class="code" href="png_8h.html#aabca0b2ed5d849f535861a33f2b3cf61">height</a>;
<a name="l03134"></a>03134   <span class="keywordflow">return</span> <a class="code" href="png_8h.html#a4a84becf999bb6d9e55899b71ed75bcf">image</a>;
<a name="l03135"></a>03135 }
<a name="l03136"></a>03136 
<a name="l03137"></a>03137 <span class="keyword">static</span> NSImage *defaultDragImage(<span class="keywordtype">int</span> *pwidth, <span class="keywordtype">int</span> *pheight)
<a name="l03138"></a>03138 {
<a name="l03139"></a>03139   <span class="keyword">const</span> <span class="keywordtype">int</span> width = 16, <a class="code" href="png_8h.html#aabca0b2ed5d849f535861a33f2b3cf61">height</a> = 16;
<a name="l03140"></a>03140   <a class="code" href="mac_8H.html#a73ca2fde79c397d91d1147fde9cccc39">Fl_Offscreen</a> off = fl_create_offscreen_with_alpha(width, <a class="code" href="png_8h.html#aabca0b2ed5d849f535861a33f2b3cf61">height</a>);
<a name="l03141"></a>03141   <a class="code" href="mac_8H.html#aac0378733483d10e73c694adf93f462c">fl_begin_offscreen</a>(off);
<a name="l03142"></a>03142   CGContextSetRGBFillColor( (CGContextRef)off, 0,0,0,0);
<a name="l03143"></a>03143   <a class="code" href="group__fl__drawings.html#ga2986a868e9cc8d9141acde94c0fe8ab0">fl_rectf</a>(0,0,width,<a class="code" href="png_8h.html#aabca0b2ed5d849f535861a33f2b3cf61">height</a>);
<a name="l03144"></a>03144   CGContextSetRGBStrokeColor( (CGContextRef)off, 0,0,0,0.6);
<a name="l03145"></a>03145   <a class="code" href="group__fl__drawings.html#ga690c83e11f49fa837b563f4c0bc4fd1b">fl_rect</a>(0,0,width,<a class="code" href="png_8h.html#aabca0b2ed5d849f535861a33f2b3cf61">height</a>);
<a name="l03146"></a>03146   <a class="code" href="group__fl__drawings.html#ga690c83e11f49fa837b563f4c0bc4fd1b">fl_rect</a>(2,2,width-4,<a class="code" href="png_8h.html#aabca0b2ed5d849f535861a33f2b3cf61">height</a>-4);
<a name="l03147"></a>03147   <a class="code" href="mac_8H.html#ac2195ac3bd679bac0b2810c8ac90faa6">fl_end_offscreen</a>();
<a name="l03148"></a>03148   NSImage* image = CGBitmapContextToNSImage( (CGContextRef)off );
<a name="l03149"></a>03149   <a class="code" href="mac_8H.html#a12c4aafe6b26b130c04f5ea972d33480">fl_delete_offscreen</a>( off );
<a name="l03150"></a>03150   *pwidth = <a class="code" href="png_8h.html#a435a10efbc8005bae2e58e63cf9b55ce">width</a>;
<a name="l03151"></a>03151   *pheight = <a class="code" href="png_8h.html#aabca0b2ed5d849f535861a33f2b3cf61">height</a>;
<a name="l03152"></a>03152   <span class="keywordflow">return</span> <a class="code" href="png_8h.html#a4a84becf999bb6d9e55899b71ed75bcf">image</a>;
<a name="l03153"></a>03153 }
<a name="l03154"></a>03154 
<a name="l03155"></a>03155 <span class="keywordtype">int</span> <a class="code" href="group__fl__clipboard.html#ga42026e276b8e83312ce58b264d1d4dcc">Fl::dnd</a>(<span class="keywordtype">void</span>)
<a name="l03156"></a>03156 {
<a name="l03157"></a>03157   CFDataRef text = CFDataCreate(kCFAllocatorDefault, (UInt8*)fl_selection_buffer[0], fl_selection_length[0]);
<a name="l03158"></a>03158   <span class="keywordflow">if</span> (text==<a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03159"></a>03159   NSAutoreleasePool *localPool;
<a name="l03160"></a>03160   localPool = [[NSAutoreleasePool alloc] init]; 
<a name="l03161"></a>03161   NSPasteboard *mypasteboard = [NSPasteboard pasteboardWithName:NSDragPboard];
<a name="l03162"></a>03162   [mypasteboard declareTypes:[NSArray arrayWithObjects:@&quot;public.utf8-plain-text&quot;, nil] owner:nil];
<a name="l03163"></a>03163   [mypasteboard setData:(NSData*)text forType:@&quot;public.utf8-plain-text&quot;];
<a name="l03164"></a>03164   CFRelease(text);
<a name="l03165"></a>03165   <a class="code" href="classFl__Widget.html">Fl_Widget</a> *w = <a class="code" href="group__fl__events.html#gadcd24382935bf08b56b1532dfe80da25">Fl::pushed</a>();
<a name="l03166"></a>03166   <a class="code" href="classFl__Window.html">Fl_Window</a> *win = w-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>();
<a name="l03167"></a>03167   <span class="keywordflow">if</span> (win == <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l03168"></a>03168     win = (<a class="code" href="classFl__Window.html">Fl_Window</a>*)w;
<a name="l03169"></a>03169   } <span class="keywordflow">else</span> { 
<a name="l03170"></a>03170     <span class="keywordflow">while</span>(win-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>()) win = win-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>();
<a name="l03171"></a>03171   }
<a name="l03172"></a>03172   NSView *myview = [(<a class="code" href="classFl__X.html">NSWindow</a>*)<a class="code" href="classFl__X.html">Fl_X</a>::i(win)-&gt;xid contentView];
<a name="l03173"></a>03173   NSEvent *theEvent = [NSApp currentEvent];
<a name="l03174"></a>03174   
<a name="l03175"></a>03175   <span class="keywordtype">int</span> <a class="code" href="png_8h.html#a435a10efbc8005bae2e58e63cf9b55ce">width</a>, <a class="code" href="png_8h.html#aabca0b2ed5d849f535861a33f2b3cf61">height</a>;
<a name="l03176"></a>03176   NSImage *<a class="code" href="png_8h.html#a4a84becf999bb6d9e55899b71ed75bcf">image</a>;
<a name="l03177"></a>03177   <span class="keywordflow">if</span> ( dynamic_cast&lt;Fl_Input_*&gt;(w) != <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ||  dynamic_cast&lt;Fl_Text_Display*&gt;(w) != <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l03178"></a>03178     fl_selection_buffer[0][ fl_selection_length[0] ] = 0;
<a name="l03179"></a>03179     image = imageFromText(fl_selection_buffer[0], &amp;width, &amp;height);
<a name="l03180"></a>03180   } <span class="keywordflow">else</span> {
<a name="l03181"></a>03181     image = defaultDragImage(&amp;width, &amp;height);
<a name="l03182"></a>03182   }
<a name="l03183"></a>03183   
<a name="l03184"></a>03184   <span class="keyword">static</span> NSSize offset={0,0};
<a name="l03185"></a>03185   NSPoint pt = [theEvent locationInWindow];
<a name="l03186"></a>03186   pt.x -= width/2;
<a name="l03187"></a>03187   pt.y -= height/2;
<a name="l03188"></a>03188   [myview dragImage:image  at:pt  offset:offset 
<a name="l03189"></a>03189               event:theEvent  pasteboard:mypasteboard  
<a name="l03190"></a>03190              source:myview  slideBack:YES];
<a name="l03191"></a>03191   <span class="keywordflow">if</span> ( w ) {
<a name="l03192"></a>03192     <span class="keywordtype">int</span> old_event = <a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a>;
<a name="l03193"></a>03193     w-&gt;<a class="code" href="classFl__Widget.html#a9cb17cc092697dfd05a3fab55856d218">handle</a>(<a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a> = <a class="code" href="Enumerations_8H.html#ad16daf120d9a0501cccaee563af0b9a3a5949b5ff170a8236d2745eddb1e9fd9a">FL_RELEASE</a>);
<a name="l03194"></a>03194     <a class="code" href="classFl.html#a8e526e1b9e8824587ff9a641f191667a">Fl::e_number</a> = old_event;
<a name="l03195"></a>03195     <a class="code" href="group__fl__events.html#gadcd24382935bf08b56b1532dfe80da25">Fl::pushed</a>( 0 );
<a name="l03196"></a>03196   }
<a name="l03197"></a>03197   [localPool release];
<a name="l03198"></a>03198   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03199"></a>03199 }
<a name="l03200"></a>03200 
<a name="l03201"></a>03201 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *Fl_X::bitmap_from_window_rect(<a class="code" href="classFl__Window.html">Fl_Window</a> *win, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> w, <span class="keywordtype">int</span> h, <span class="keywordtype">int</span> *bytesPerPixel)
<a name="l03202"></a>03202 <span class="comment">// delete the returned pointer after use</span>
<a name="l03203"></a>03203 {
<a name="l03204"></a>03204   <span class="keywordflow">while</span>(win-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>()) {
<a name="l03205"></a>03205     x += win-&gt;x();
<a name="l03206"></a>03206     y += win-&gt;y();
<a name="l03207"></a>03207     win = win-&gt;<a class="code" href="classFl__Widget.html#af8834d376878616c66a094cad6fec9d2">window</a>();
<a name="l03208"></a>03208   }
<a name="l03209"></a>03209   CGFloat <a class="code" href="Fl__Valuator_8cxx.html#ac29df3dcbefa1ce189e5990bde994025">epsilon</a> = 0;
<a name="l03210"></a>03210   <span class="keywordflow">if</span> (<a class="code" href="group__group__macosx.html#ga2c7db6b2ea9a6ae37a26bea810d2056c" title="The version number of the running Mac OS X (e.g., 0x1064 for 10.6.4)">fl_mac_os_version</a> &gt;= 0x1060) epsilon = 0.001;
<a name="l03211"></a>03211   <span class="comment">// The epsilon offset is absolutely necessary under 10.6. Without it, the top pixel row and</span>
<a name="l03212"></a>03212   <span class="comment">// left pixel column are not read, and bitmap is read shifted by one pixel in both directions. </span>
<a name="l03213"></a>03213   <span class="comment">// Under 10.5, we want no offset.</span>
<a name="l03214"></a>03214   NSRect rect = NSMakeRect(x - epsilon, y - epsilon, w, h);
<a name="l03215"></a>03215   NSBitmapImageRep *bitmap = [[NSBitmapImageRep alloc] initWithFocusedViewRect:rect];
<a name="l03216"></a>03216   *bytesPerPixel = [bitmap bitsPerPixel]/8;
<a name="l03217"></a>03217   <span class="keywordtype">int</span> bpp = (<a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>)[bitmap bytesPerPlane];
<a name="l03218"></a>03218   <span class="keywordtype">int</span> bpr = (<a class="code" href="png_8h.html#ab832c174e145540d491b0830fc05dbb1">int</a>)[bitmap bytesPerRow];
<a name="l03219"></a>03219   <span class="keywordtype">int</span> hh = bpp/bpr; <span class="comment">// sometimes hh = h-1 for unclear reason</span>
<a name="l03220"></a>03220   <span class="keywordtype">int</span> ww = bpr/(*bytesPerPixel); <span class="comment">// sometimes ww = w-1</span>
<a name="l03221"></a>03221   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *data = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[w * h *  *bytesPerPixel];
<a name="l03222"></a>03222   <span class="keywordflow">if</span> (w == ww) {
<a name="l03223"></a>03223     memcpy(data, [bitmap bitmapData], w * hh *  *bytesPerPixel);
<a name="l03224"></a>03224   } <span class="keywordflow">else</span> {
<a name="l03225"></a>03225     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *p = [bitmap bitmapData];
<a name="l03226"></a>03226     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *q = <a class="code" href="jpeglib_8h.html#ae5784a8f4db42de0ffacd0cbd08dc6ad">data</a>;
<a name="l03227"></a>03227     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0;i &lt; hh; i++) {
<a name="l03228"></a>03228       memcpy(q, p, *bytesPerPixel * ww);
<a name="l03229"></a>03229       p += bpr;
<a name="l03230"></a>03230       q += w * *bytesPerPixel;
<a name="l03231"></a>03231       }
<a name="l03232"></a>03232   }
<a name="l03233"></a>03233   [bitmap release];
<a name="l03234"></a>03234   <span class="keywordflow">return</span> <a class="code" href="jpeglib_8h.html#ae5784a8f4db42de0ffacd0cbd08dc6ad">data</a>;
<a name="l03235"></a>03235 }
<a name="l03236"></a>03236 
<a name="l03237"></a>03237 <span class="keywordtype">void</span> imgProviderReleaseData (<span class="keywordtype">void</span> *<a class="code" href="jmemsys_8h.html#aae47c0f1d689d6cba5eb7077ca1299fa">info</a>, <span class="keyword">const</span> <span class="keywordtype">void</span> *data, <span class="keywordtype">size_t</span> <a class="code" href="png_8h.html#a43291b8493b637821dec145c4bb1503d">size</a>)
<a name="l03238"></a>03238 {
<a name="l03239"></a>03239   <span class="keyword">delete</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)data;
<a name="l03240"></a>03240 }
<a name="l03241"></a>03241 
<a name="l03242"></a>03242 CGImageRef Fl_X::CGImage_from_window_rect(<a class="code" href="classFl__Window.html">Fl_Window</a> *win, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> w, <span class="keywordtype">int</span> h)
<a name="l03243"></a>03243 <span class="comment">// CFRelease the returned CGImageRef after use</span>
<a name="l03244"></a>03244 {
<a name="l03245"></a>03245   <span class="keywordtype">int</span> bpp;
<a name="l03246"></a>03246   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *bitmap = bitmap_from_window_rect(win, x, y, w, h, &amp;bpp);
<a name="l03247"></a>03247   CGImageRef img;
<a name="l03248"></a>03248   CGColorSpaceRef lut = CGColorSpaceCreateDeviceRGB();
<a name="l03249"></a>03249   CGDataProviderRef provider = CGDataProviderCreateWithData(<a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, bitmap, w*h*bpp, imgProviderReleaseData);
<a name="l03250"></a>03250   img = CGImageCreate(w, h, 8, 8*bpp, w*bpp, lut,
<a name="l03251"></a>03251                       bpp == 3 ? kCGImageAlphaNone : kCGImageAlphaLast,
<a name="l03252"></a>03252                       provider, <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keyword">false</span>, kCGRenderingIntentDefault);
<a name="l03253"></a>03253   CGColorSpaceRelease(lut);
<a name="l03254"></a>03254   CGDataProviderRelease(provider);
<a name="l03255"></a>03255   <span class="keywordflow">return</span> img;
<a name="l03256"></a>03256 }
<a name="l03257"></a>03257 
<a name="l03258"></a>03258 <span class="keywordtype">void</span> Fl_X::contains_GL_subwindow() 
<a name="l03259"></a>03259 {
<a name="l03260"></a>03260   [(FLWindow*)xid setContainsGLsubwindow:YES];
<a name="l03261"></a>03261 }
<a name="l03262"></a>03262 
<a name="l03263"></a>03263 WindowRef Fl_X::window_ref()
<a name="l03264"></a>03264 {
<a name="l03265"></a>03265   <span class="keywordflow">return</span> (WindowRef)[(FLWindow*)xid windowRef];
<a name="l03266"></a>03266 }
<a name="l03267"></a>03267 
<a name="l03268"></a>03268 <span class="comment">// so a CGRect matches exactly what is denoted x,y,w,h for clipping purposes</span>
<a name="l03269"></a>03269 CGRect fl_cgrectmake_cocoa(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> w, <span class="keywordtype">int</span> h) {
<a name="l03270"></a>03270   <span class="keywordflow">if</span> ( <a class="code" href="classFl__Surface__Device.html#a6a2643e352fdcb9e78faa167d1cd0a14" title="the surface that currently receives graphics output">Fl_Surface_Device::surface</a>()-&gt;class_name() == <a class="code" href="classFl__Printer.html#aa837fde56021246c7a7137786e7ca5dc" title="A string that identifies each subclass of Fl_Device.">Fl_Printer::class_id</a> ) <span class="keywordflow">return</span> CGRectMake(x, y, w-1.5 , h-1.5 ); 
<a name="l03271"></a>03271   <span class="keywordflow">return</span> CGRectMake(x, y, w &gt; 0 ? w - 0.9 : 0, h &gt; 0 ? h - 0.9 : 0);
<a name="l03272"></a>03272 }
<a name="l03273"></a>03273 
<a name="l03274"></a>03274 <a class="code" href="mac_8H.html#aad9fe48cacd960402308a6a7f9f5e584">Window</a> <a class="code" href="mac_8H.html#a87152d2ed84f9d97c6bf3150c7688261">fl_xid</a>(<span class="keyword">const</span> <a class="code" href="classFl__Window.html">Fl_Window</a>* w)
<a name="l03275"></a>03275 {
<a name="l03276"></a>03276   <span class="keywordflow">return</span> <a class="code" href="classFl__X.html#ae4c6997d92cf8ad3a75a962d7ae77c34">Fl_X::i</a>(w)-&gt;<a class="code" href="classFl__X.html#a8885c9eeb5a7a9684ad147177bf9931a">xid</a>;
<a name="l03277"></a>03277 }
<a name="l03278"></a>03278 
<a name="l03279"></a>03279 <span class="preprocessor">#include &lt;dlfcn.h&gt;</span>
<a name="l03280"></a>03280 
<a name="l03281"></a>03281 <span class="comment">/* Returns the address of a Carbon function after dynamically loading the Carbon library if needed.</span>
<a name="l03282"></a>03282 <span class="comment"> Supports old Mac OS X versions that may use a couple of Carbon calls:</span>
<a name="l03283"></a>03283 <span class="comment"> GetKeys used by OS X 10.3 or before (in Fl::get_key())</span>
<a name="l03284"></a>03284 <span class="comment"> PMSessionPageSetupDialog and PMSessionPrintDialog used by 10.4 or before (in Fl_Printer::start_job())</span>
<a name="l03285"></a>03285 <span class="comment"> GetWindowPort used by 10.4 or before (in Fl_Gl_Choice.cxx)</span>
<a name="l03286"></a>03286 <span class="comment"> */</span>
<a name="l03287"></a>03287 <span class="keywordtype">void</span> *Fl_X::get_carbon_function(<span class="keyword">const</span> <span class="keywordtype">char</span> *function_name) {
<a name="l03288"></a>03288   <span class="keyword">static</span> <span class="keywordtype">void</span> *carbon = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03289"></a>03289   <span class="keywordtype">void</span> *f = <a class="code" href="forms_8H-2.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03290"></a>03290   <span class="keywordflow">if</span> (!carbon) {
<a name="l03291"></a>03291     carbon = dlopen(<span class="stringliteral">&quot;/System/Library/Frameworks/Carbon.framework/Carbon&quot;</span>, RTLD_LAZY);
<a name="l03292"></a>03292   }
<a name="l03293"></a>03293   <span class="keywordflow">if</span> (carbon) {
<a name="l03294"></a>03294     f = dlsym(carbon, function_name);
<a name="l03295"></a>03295   }
<a name="l03296"></a>03296   <span class="keywordflow">return</span> <a class="code" href="fl__boxtype_8cxx.html#ac406db58651c10e8f67ed432c66db0d6">f</a>;
<a name="l03297"></a>03297 }
<a name="l03298"></a>03298   
<a name="l03299"></a>03299 <span class="preprocessor">#endif // __APPLE__</span>
<a name="l03300"></a>03300 <span class="preprocessor"></span>
<a name="l03301"></a>03301 <span class="comment">//</span>
<a name="l03302"></a>03302 <span class="comment">// End of &quot;$Id: Fl_cocoa.mm 6971 2009-04-13 07:32:01Z matt $&quot;.</span>
<a name="l03303"></a>03303 <span class="comment">//</span>
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="Fl__cocoa_8mm.html">Fl_cocoa.mm</a>      </li>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="#" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3</small></address>
</body>

<!-- Mirrored from dox.sfr-fresh.com/fltk-1.3.0rc3-source/Fl__cocoa_8mm_source.html by HTTrack Website Copier/3.x [XR&CO'2010], Wed, 16 Feb 2011 23:40:48 GMT -->
</html>
